This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
development/
  collections.md
  eager-loading.md
  element-queries.md
  forms.md
  graphql.md
  image-transforms.md
  README.md
  templates.md
  twig.md
extend/
  asset-bundles.md
  behaviors.md
  changelogs-and-updates.md
  coding-guidelines.md
  commands.md
  conditions.md
  controllers.md
  cp-edit-pages.md
  cp-section.md
  cp-templates.md
  element-actions.md
  element-exporter-types.md
  element-types.md
  environmental-settings.md
  events.md
  extending-twig.md
  field-layout-element-types.md
  field-types.md
  filesystem-types.md
  generator.md
  graphql.md
  migrations.md
  module-guide.md
  plugin-editions.md
  plugin-guide.md
  plugin-settings.md
  plugin-store.md
  project-config.md
  queue-jobs.md
  README.md
  services.md
  soft-deletes.md
  template-hooks.md
  template-roots.md
  topics.md
  translation-categories.md
  updating-plugins.md
  user-permissions.md
  utilities.md
  widget-types.md
reference/
  config/
    bootstrap.md
    db.md
    general.md
    README.md
  element-types/
    addresses.md
    assets.md
    categories.md
    entries.md
    globals.md
    README.md
    tags.md
    users.md
  field-types/
    addresses.md
    assets.md
    button-group.md
    categories.md
    checkboxes.md
    color.md
    country.md
    date-time.md
    dropdown.md
    email.md
    entries.md
    icon.md
    json.md
    lightswitch.md
    link.md
    matrix.md
    money.md
    multi-select.md
    number.md
    plain-text.md
    radio-buttons.md
    range.md
    README.md
    table.md
    tags.md
    time.md
    users.md
  twig/
    filters.md
    functions.md
    global-variables.md
    README.md
    tags.md
    tests.md
  cli.md
  controller-actions.md
  README.md
system/
  cli.md
  control-panel.md
  directory-structure.md
  drafts-revisions.md
  elements.md
  fields.md
  gc.md
  logging.md
  mail.md
  object-templates.md
  plugins.md
  project-config.md
  queue.md
  README.md
  reference-tags.md
  relations.md
  routing.md
  searching.md
  sites.md
  user-management.md
coc.md
configure.md
deploy.md
editions.md
install.md
README.md
requirements.md
update.md
upgrade.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="development/collections.md">
# Collections

[Collections](https://laravel.com/docs/10.x/collections) come from the [Laravel](https://laravel.com/) ecosystem, and provide a fluid way of working with array-like data.

<!-- more -->

You can create a `Collection` anywhere:

::: code
``` Twig
{% set list = collect(['Green', 'Teal', 'Blue']) %}
```
``` PHP
use Illuminate\Support\Collection;

$colors = Collection::make(['Green', 'Teal', 'Blue']);
```
:::

Collections can be used in most situations that an array would be:

```twig
<ul>
  {% for color in colors %}
    {# `color` is one of our original three strings: #}
    <li>{{ color }}</li>
  {% endfor %}
</ul>
```

If a collection is created from an array that contains only [elements](../system/elements.md), an [`ElementCollection`](#element-collections) is returned, instead.

## Methods

[Dozens of convenience methods](https://laravel.com/docs/10.x/collections#available-methods) are available on every collection to simplify cumbersome or error-prone operations.

These methods can be chained together to process data in an elegant way. Take this average review score logic:

```twig
{% set recentReviews = craft.entries()
  .section('reviews')
  .relatedTo({
    targetElement: product,
  })
  .postDate(">= #{now|date_modify('-1 month')}")
  .collect() %}

{{ recentReviews.pluck('rating').average() }}
```

Not all collection methods return another collection! In this example, [`.pluck()`](https://laravel.com/docs/10.x/collections#method-pluck) _does_ (containing just the `rating` field values), but [`.average()`](https://laravel.com/docs/10.x/collections#method-average) _doesn’t_ (instead returning a [float](https://www.php.net/manual/en/language.types.float.php)). As Collections are intended for working with lists, methods that return scalar values can only be used at the “end” of a chain.

If at any point you need a plain array from a collection, call its `.all()` method.

::: tip
Some common array-manipulation features are already implemented in Craft as Twig [filters](../reference/twig/filters.md) or [functions](../reference/twig/functions.md), but equivalent methods are usually available via Collections. Their supported arguments and signatures may differ slightly, so consult the documentation if you are combining or switching between features.

Until Craft [5.6.0](github:craftcms/cms/releases/5.6.0), Twig’s default configuration did not parse anonymous functions or “closures” in every expression context. The [`nystudio107/craft-closure` package](repo:nystudio107/craft-closure/) provides a shim to work around this limitation in earlier versions.
:::

## Element Collections

Use the [`.collect()` query execution method](element-queries.md#query-execution) (in place of `.all()`) to return elements as a special <craft5:craft\elements\ElementCollection>. You can also wrap an existing list of elements with `collect()`, and Craft will automatically return an `ElementCollection`:

```twig
{# These produce the same results: #}
{% set posts = craft.entries().section('news').collect() %}
{% set posts = collect(craft.entries().section('news').all()) %}
```

[Eager-loaded elements](eager-loading.md) are also wrapped in an `ElementCollection` that allows them to behave a bit like an element query—you can safely call `.all()` on any relational field without worrying about whether it was eager-loaded or not—or use `.with()` to eager-load another set of nested elements!

Element collections have a few extra methods that make them more interoperable with element queries (like the `.ids()` and `.with()` methods), or behave more predictably when doing arithmetic (like `.merge()`, `.unique()`, or `.intersect()`):

`find(target, default)`
:   Reduce the collection to a single element by passing an element or one or more element IDs.

`with(eagerLoadingMap)`
:   [Eager-loads](../development/eager-loading.md) one or more nested/related sets of elements using the provided map.

`contains(key, operator, value)`
:   Behaves identically to the native method, except when used with a single argument. If an element is passed, it is tested against the ID and site ID of each element in the collection; if an integer is passed, it is compared to the ID of each element in the collection.

`ids()`
:   Returns a new collection containing only the elements’ IDs. Equivalent to `.pluck('id')`.

`merge(items)`
:   Combines this set of elements with another one. Any elements in the current collection that share an ID _and_ site ID with an incoming element are replaced. _Keys are not preserved._

`fresh()`
:   Re-fetches all elements in the collection from the database. Elements that no longer exist in the database are dropped from list.

`diff(items)`
:   Returns elements that are present only in the current collection, as though the incoming elements are “subtracted” from it.

`intersect(items)`
:   Returns elements present in both the current _and_ incoming lists.

`unique(key)`
:   Reduces the collection to elements with unique IDs, via `keyBy('id')`. For a list of elements with unique IDs _and_ site IDs, use `unique('siteSettingsId')`.

`only(keys)`
:   Reduce the collection to elements with the provided ID(s).

`except(keys)`
:   Remove elements with the provided ID(s) from the collection.

`render()`
:   Render [element partials](../system/elements.md#rendering-elements) for each element in the collection.
</file>

<file path="development/eager-loading.md">
---
description: Optimize your templates with smart eager-loading.
related:
  - uri: ../system/elements.md
    label: Introduction to Elements
  - uri: element-queries.md
    label: Querying Elements
---

# Eager-Loading Elements

When you are working with a list of elements and need to access their nested or related elements, _eager-loading_ can help optimize your [element queries](element-queries.md).

<!-- more -->

<Block label="The N+1 Problem">

Let’s look at a [template](templates.md) that loops through a list of news posts (entries), and displays an image (asset) attached to each one.

```twig
{% set posts = craft.entries()
  .section('news')
  .all() %}

{% for post in posts %}
  <article>
    {% set image = post.featureImage.one() %}

    {% if image %}
      {{ image.getImg() }}
    {% endif %}

    {# ... #}
  </article>
{% endfor %}
```

In addition to the main query for the entry elements, an additional query is executed for _each_ article to find the attached asset. The number of queries will be _N_ (the number of entries) _+ 1_ (the initial entries query). If there are 50 entries, this innocent-looking template will cost the page 51 queries!

If we were to then display the name of the user who uploaded each image (i.e. `image.uploader.fullName`) or a list of categories for each entry (i.e. `post.topics.all()`), we would introduce a _2N+1_ query, whereby each entry in the initial query would trigger _two_ additional queries, for a minimum of 101. Supposing each query takes a couple of milliseconds, this can quickly add up to 250–500ms _just waiting for data_.

</Block>

Eager-loading allows Craft to proactively load related or nested elements _in bulk_, while keeping track of where they all belong.

::: tip
Not every relationship needs to be eager-loaded! We have a list of recommendations for how to identify [opportunities for optimization](#identifying-candidates).
:::

## Identifying Candidates

Auditing your templates for performance problems solvable with eager-loading can be tricky, but you may be able to narrow down what you’re looking for with these common bottlenecks:

- [Nested](#eager-loading-nested-sets-of-elements) `{% for %}` loops;
- Accessing or outputting data from nested blocks in a Matrix field;
- Getting information about an entry’s author, within a loop;
- Using multiple [asset transforms](#eager-loading-image-transforms);
- Using relational fields within a loop;

The exact patterns here may differ template-to-template, and don’t always involve an explicit call to a [query execution method](./element-queries.md#query-execution) (like `.one()` in the example above)! Implicit queries may be masked by filters like `|first` or `|slice`, or when iterating over a relational field’s value in a `for` loop.

::: tip
Not all of these situations will require (or benefit from) eager-loading—the goal is only to consider which of your projects’ features _may_ be candidates.
:::

## Lazy Eager-Loading <Badge text="New!" />

Element queries in Craft 5 have a new `.eagerly()` query param that simplifies eager-loading of relational fields. Most projects can replace custom eager-loading maps (via the [`.with()` method](#the-with-query-param)) with a call to `.eagerly()` on down-stream element queries.

::: code
```twig{3-6} Using .with()
{% set posts = craft.entries()
  .section('news')
  .with([
    ['featureImage', { withTransforms: ['large'] }],
    ['topics'],
  ])
  .all() %}

{% for post in posts %}
  {% set image = post.featureImage.one() %}

  <article>
    <h2>{{ post.title }}</h2>

    {% if image %}
      {{ image.getImg('large') }}
    {% endif %}

    {{ post.summary|md }}

    <ul>
      {% for topic in post.topics %}
        <li>{{ topic.getLink() }}</li>
      {% endfor %}
    </ul>
  </article>
{% endfor %}
```
```twig{6,18} Using .eagerly()
{% set posts = craft.entries()
  .section('news')
  .all() %}

{% for post in posts %}
  {% set image = post.featureImage.eagerly().one() %}

  <article>
    <h2>{{ post.title }}</h2>

    {% if image %}
      {{ image.getImg('large') }}
    {% endif %}

    {{ post.summary|md }}

    <ul>
      {% for topic in post.topics.eagerly().all() %}
        <li>{{ topic.getLink() }}</li>
      {% endfor %}
    </ul>
  </article>
{% endfor %}
```
:::

In this example, our primary query (for entries in the _News_ section) no longer needs to be concerned about what nested or related queries _might_ be used—instead, each query that stems from an entry returned by the primary query should use `.eagerly()` to let Craft know that there is an opportunity to fetch a set of elements _as though they had been eager-loaded_, up-front. The main difference between this strategy and `.with()` is that—as the name “lazy” suggests—nested and related elements aren’t loaded until Craft actually evaluates logic that needs them; templates (like [element partials](../system/elements.md#rendering-elements)) can request additional relational data without impacting the upstream query, while avoiding optimistic-but-unnecessary up-front queries.

After calling `.eagerly()`, lazily eager-loaded relations are used just like normal relational field values. This means your templates can continue chaining `.one()`, `.all()`, or applying filters like `|first` to get results.

::: warning
[Native attributes](#eligible-fields-and-attributes) currently do not support lazy eager-loading due to the way many of their values are accessed, but they can be eager loaded using `.with()`.
:::

## The `.with()` Query Param

The purpose of the `.with()` param is to tell Craft which related or nested elements you are apt to need, in advance. With that information, Craft is able to fetch them all up front, in as few queries as possible.

Here’s how to apply the `with` param to our example:

```twig
{% set entries = craft.entries()
  .section('news')
  .with(['assetsField'])
  .all() %}

{% for entry in entries %}
  {% set image = entry.assetsField.one() %}

  {# Make sure we actually have an asset element: #}
  {% if image %}
    <img src="{{ image.url }}" alt="{{ image.title }}">
  {% endif %}
{% endfor %}
```

This template code will only cost three queries (one to fetch the entries, one to determine which assets should be eager-loaded, and one to fetch the assets), and the number of queries will not grow proportional to the number of elements being displayed. The entries are then are automatically populated with their respective related asset(s).

## Accessing Eager-Loaded Elements

Eager-loaded elements are returned as a [collections](collections.md)—or more specifically, an <craft5:craft\elements\ElementCollection>. This means that (in most cases) eager-loaded and non-eager-loaded elements can be treated in the same way.

## Eager-Loading Multiple Sets of Elements

If you have multiple sets of elements you wish to eager-load via the primary query, add those field handles to your `.with()` parameter:

```twig{4-5}
{% set posts = craft.entries
  .section('news')
  .with([
    'topics',
    'featureImage',
  ])
  .all() %}

{% for post in posts %}
  <article>
    {# Use the eager-loaded elements normally: #}
    {% for topic in post.topics %}
      {{ topic.getLink() }}
    {% endfor %}
  </article>
{% endfor %}
```

[Lazy eager-loading](#lazy-eager-loading) works the same for any number of eager-loaded fields. Each query that stems from an element in the primary query should use `.eagerly()` to signal that it will be used similarly in later iterations of a loop.

If you need to conditionally add eager-loading criteria, use the `.andWith()` method:

```twig
{% set postsQuery = craft.entries()
  .section('news')
  .with(['topics']) %}

{% if unfurlPosts %}
  {% do postsQuery.andWith(['featureImage']) %}
{% endif %}

{% set posts = postsQuery.all() %}

{# ... #}
```

Craft will merge your criteria into a single plan before executing the query.

## Eager-Loading Nested Sets of Elements

It’s also possible to optimize loading of elements nested two or more levels deep, using a special syntax. Suppose the topics in our news feed from previous examples each had a thumbnail or icon:

```twig{4,17-18}
{% set posts = craft.entries()
  .section('news')
  .with([
    'topics.thumbnail',
  ])
  .all() %}

{# Main loop: #}
{% for post in posts %}
  <article>
    <h2>{{ post.title }}</h2>

    {# ... #}

    {# Nested topics loop: #}
    <ul>
      {% for topic in post.topics %}
        {% set icon = topic.thumbnail.one() %}

        <li>
          <a href="{{ topic.url }}">
            {% if icon %}
              {{ icon.getImg() }}
            {% endif %}
            <span>{{ topic.title }}</span>
          </a>
        </li>
      {% endfor %}
    </ul>
  </article>
{% endfor %}
```

A dot (`.`) in the eager-loading map indicates that another set of elements on the eager-loaded results _also_ needs to be loaded. Craft expands this notation into a multi-stage eager-loading “plan” and fetches each layer of elements in a batch. Each segment of an eager-loading path will be a field handle.

The same optimization is possible with [lazy eager-loading](#lazy-eager-loading)—the `.with()` param can be omitted from the main query, and `.eagerly()` can be added to all the nested queries:

```twig{10-11}
{% set posts = craft.entries()
  .section('news')
  .all() %}

{% for post in posts %}
  <article>
    {# ... #}

    <ul>
      {% for topic in post.topics.eagerly().all() %}
        {% set icon = topic.thumbnail.eagerly().one() %}

        {# ... #}
      {% endfor %}
    </ul>
  </article>
```

::: tip
Elements that are the target of multiple relations (as you might expect with a set of categories or tags) are only loaded once per batch. For example, if we were displaying a list of 100 news articles that were each assigned one of 10 categories, eager-loading the categories would never fetch more than 10 elements—Craft assigns the returned categories to _all_ the articles they were related to.
:::

## Defining Custom Parameters on Eager-Loaded Elements

You can define custom parameters that will get applied as elements are being eager-loaded, by replacing its handle with an array that has two values: the handle, and a [hash](twig.md#hashes) that defines the parameters that should be applied.

```twig
{% set entries = craft.entries()
  .section('news')
  .with([
    ['assetsField', { kind: 'image' }],
  ])
  .all() %}
```

When eager-loading nested sets of elements, you can apply parameters at any level of the eager-loading path.

```twig
{% set entries = craft.entries()
  .section('news')
  .with([
    ['featureImage', { dateUploaded: ">= #{now|date_modify('-1 month')}" }],
    ['authors', { group: 'staff' }],
    ['topic.thumbnail', { kind: 'image' }],
  ])
  .all() %}
```

The accepted parameters correspond to the kind of element that each relationship uses—this example uses the [asset query](../reference/element-types/assets.md#querying-assets)’s `dateUploaded` and `kind` params, and the [user query](../reference/element-types/users.md#querying-users)’s `group` param.

::: tip
You can also provide nested `with` directives via these hashes. Here’s an example where we’re loading each topic’s `thumbnail` and `sectionEditor`, as well as all their `descendants` (presuming that our topic category group is a multi-level structure):

```twig
{% set entries = craft.entries()
  .section('news')
  .with([
    ['topic', {
      with: [
        ['thumbnail', { kind: image }],
        ['descendants'],
        ['sectionEditor'],
      ]
    }]
  ])
  .all() %}
```

The equivalent “flat” eager-loading map would look like this—note the repetition:

```twig
[
  ['topic.thumbnail', { kind: 'image' }],
  ['topic.descendants'],
  ['topic.sectionEditor'],
]
```

Ultimately, Craft normalizes both maps to something more like the first example, then loads each “layer” in sequence—the topics have to be loaded before anything attached to them!
:::

## Eager-Loading Image Transforms

Another _N+1_ problem occurs when looping through a set of assets, and applying image transforms to each of them. For each transform, Craft needs to execute a query to see if the transform already exists.

This problem can be solved with the `withTransforms` asset criteria parameter:

```twig
{% set assets = entry.assetsField
  .withTransforms([
    'heroImage',
    { width: 100, height: 100 }
  ])
  .all() %}
```

Note that each transform definition you want to eager-load can either be a string (the handle of a transform defined in Settings → Assets → Image Transforms) or a [hash](twig.md#hashes) that defines the transform properties.

Using the `withTransforms` param has no effect on how you’d access image transforms further down in the template.

Image transform indexes can be eager-loaded on assets that are also eager-loaded:

```twig
{% set entries = craft.entries()
  .with([
    ['assetsField', {
      withTransforms: ['heroImage']
    }]
  ])
  .all() %}
```

## Eligible Fields and Attributes

[Relational fields](../system/relations.md) are the most common candidate for eager-loading. Fields are always eager-loaded using their handle. In this example, `manufacturer` is an entries field attached to each “car” entry:

```twig
{% set carsWithManufacturers = craft.entries()
  .section('cars')
  .with([
    ['manufacturer'],
  ])
  .all() %}
```

[Element types](../system/elements.md) support a variety of unique eager-loadable attributes, as well:

All Element Types
:   - Immediate children: `children`
    - All descendants: `descendants`
    - Immediate parent: `parent`
    - All ancestors: `ancestors`
    - Same element in other sites: `localized`
    - Drafts: `drafts`
    - Draft creators: `draftCreator`
    - Revisions: `revisions`
    - Revision creators: `revisionCreator`

Assets
:   - Uploader: `uploader`

Entries
:   - First selected author: `author`
    - All authors: `authors`

Users
:   - Addresses: `addresses`
    - Profile photo: `photo`

Fields and attributes that don’t use element queries (or don’t ultimately resolve to one or more elements) are generally not eager-loadable—and trying to eager-load them may result in an error.

::: tip
Some elements may also expose query methods that optimize the loading of associated _non-element_ records (like [asset transforms](#eager-loading-image-transforms)), but their interfaces are not part of the core element-only eager-loading system.
:::

### Reverse Relationships

While related elements can be queried in either direction using [`sourceElement` and `targetElement` options](../system/relations.md#sources-and-targets), it is only possible to declaratively eager-load elements that are the [target](../system/relations.md#sources-and-targets) of a relationship. If you need to query for other elements that point _to_ an element in the main query, the queries must be written separately:

```twig
{# We can’t load these poets *and* their poems in one query: #}
{% set poets = craft.users()
  .group('poets')
  .all() %}

{# This second query takes the list of poets and loads all their poems: #}
{% set poems = craft.entries()
  .section('poems')
  .authorId(poets|column('id'))
  .all() %}

{# Then, we can group those poems by their author’s ID: #}
{% set poemsByAuthorId = poems|group('authorId') %}

{% for poet in poets %}
  <article>
    <h2>Poems by: {{ poet.fullName }}</h2>
    <ul>
      {% for poem in poemsByAuthorId[poet.id] ?? [] %}
        <li>{{ poem.title }}</li>
      {% endfor %}
    </ul>
  </article>
{% endfor %}
```

Of course, if each _poet_ user element had a custom field in which administrators selected “Featured Poems,” that _would_ be eager-loadable:

```twig
{% set poets = craft.users()
  .group('poets')
  .with([
    ['featuredPoems'],
  ])
  .all() %}
```
</file>

<file path="development/element-queries.md">
# Element Queries

You can fetch [elements](../system/elements.md) (like entries, categories, assets, etc.) in your [templates](templates.md) or [extension](../extend/README.md) using **element queries**.

<!-- more -->

Suppose you’ve already created a [section](../reference/element-types/entries.md#sections) for news posts and configured a URL scheme. Craft automatically loads the corresponding entry element when its URL is requested, and exposes it to the template under an `entry` variable. This is convenient—but it’s rare that a page only refers to a _single_ piece of content! What if we want to show a list of other recent posts, in a sidebar? Element queries are Craft’s way of loading elements anywhere you need them.

Element queries can be hyper-specific (like loading a single [global set](../reference/element-types/globals.md) by its handle) or relaxed (like a list of recently-updated [entries](../reference/element-types/entries.md)).

Working with element queries consists of three steps:

1. **Create the element query.** Calling the “factory function” corresponding to the [element type](#element-types) you want to fetch. For entries, this is `craft.entries()`; for categories, `craft.categories()`.
2. **Set some parameters.** By default, element queries will be configured to return _all_ elements of a given type. You can narrow that down to just the elements you care about by setting [parameters](#types-parameters) on the query.
3. **Execute the query.** Use a [query execution method](#executing-element-queries) to run the query and return results.

::: tip
[Relational fields](../system/relations.md) also return element queries (except when [eager-loaded](./eager-loading.md)), which you can treat the same as the result of step #1, above.
:::

Here’s what this process looks like, in practice:

::: code
```twig
{# Create an entry query and set some parameters on it #}
{% set postsQuery = craft.entries()
  .section('news')
  .orderBy('postDate DESC')
  .limit(10) %}

{# Execute the query and get the results #}
{% set posts = postsQuery.all() %}
```
```php
use craft\elements\Entry;

// Create an entry query and set some parameters on it
$postsQuery = Entry::find()
    ->section('news')
    ->orderBy('postDate DESC')
    ->limit(10);

// Execute the query and get the results
$posts = $postsQuery->all();
```
:::

You can eliminate the intermediate variable and flatten this into a single statement by chaining the [execution method](#executing-element-queries) on the end:

::: code
```twig
{% set posts = craft.entries()
  .section('news')
  .orderBy('postDate DESC')
  .limit(10)
  .all() %}
```
```php
use craft\elements\Entry;

$posts = Entry::find()
    ->section('news')
    ->orderBy('postDate DESC')
    ->limit(10)
    ->all();
```
:::

## Types + Parameters

Each type of element has its own function for creating element queries, and they each have their own parameters you can set. All element types expose parameters for their [custom fields](#querying-with-custom-fields).

### Element Types

See the query reference section of each [element type](../system/elements.md) for more details on working with them:

[Address Queries](../reference/element-types/addresses.md#querying-addresses) &rarr;
:     {% set addressQuery = craft.addresses() %}

[Asset Queries](../reference/element-types/assets.md#querying-assets) &rarr;
:     {% set assetQuery = craft.assets() %}

[Category Queries](../reference/element-types/categories.md#querying-categories) &rarr;
:     {% set categoryQuery = craft.categories() %}

[Entry Queries](../reference/element-types/entries.md#querying-entries) &rarr;
:     {% set entryQuery = craft.entries() %}

[Global Set Queries](../reference/element-types/globals.md#querying-globals) &rarr;
:     {% set globalQuery = craft.globals() %}

[Tag Queries](../reference/element-types/tags.md#querying-tags) &rarr;
:     {% set tagQuery = craft.tags() %}

[User Queries](../reference/element-types/users.md#querying-users) &rarr;
:     {% set userQuery = craft.users() %}

### Parameters

Parameters are set using methods after creating an element query, or by passing in key-value pairs to the factory function:

```twig
{% set images = craft.assets()
  .kind('image')
  .all() %}

{# ...or... #}

{% set images = craft.assets({
    kind: 'image',
  })
  .all() %}

{# ...or if you’re fancy, set some parameters conditionally: #}

{% set assetsQuery = craft.assets() %}

{% if craft.app.request.getParam('onlyImages') %}
  {# Effectively the same as chaining query methods: #}
  {% do assetsQuery.kind('image') %}
{% endif %}

{% set images = assetsQuery.all() %}
```

::: tip
Query methods (except for those that [execute](#executing-element-queries) a query) modify some internal properties and return the query itself, allowing you to chain methods together—just like Craft’s [fluent config](../configure.md#style) syntax!
:::

All element queries support a standard set of methods (like `.id()`, `.title()`, and [`.search()`](../system/searching.md)). These are documented alongside the [element type-specific](#element-types) parameters (like `.kind()` in the example above).

Typically, parameters make a query more specific—but setting a single parameter more than once will replace the previous constraint. Similarly, setting a parameter to `null` can _broaden_ a query by removing an existing constraint.

#### Querying with Custom Fields

In addition to native query parameters, Craft automatically injects methods for each of your [custom fields](../system/fields.md).

For example, if we wanted to find entries in a _Cars_ section with a specific paint color stored in a [dropdown](../reference/field-types/dropdown.md) field, we could perform this query:

```twig
{% set silverCars = craft.entries()
  .section('cars')
  .paintColor('silver')
  .all() %}
```

Custom field parameters can be combined for advanced filtering—in this example, we’re also applying a pair of constraints to a [date](../reference/field-types/date-time.md) field:

```twig
{% set silverCars = craft.entries()
  .section('cars')
  .paintColor(['silver', 'gold'])
  .modelYear('>= 1990', '<= 2000')
  .all() %}
```

See each [field type](../system/fields.md#field-types)’s documentation for what kinds of values you can use.

#### Case-Sensitivity

Queries against textual fields ([Color](../reference/field-types/color.md), [Country](../reference/field-types/country.md), [Email](../reference/field-types/email.md), [Icon](../reference/field-types/icon.md), [Link](../reference/field-types/link.md), [Plain Text](../reference/field-types/plain-text.md), and [Table](../reference/field-types/table.md)) are case-sensitive, by default.

To make a query case-_insensitive_, pass an object with the special `caseInsensitive` key:

```twig{4-5}
{% set cars = craft.entries()
  .section('cars')
  .brand({
    value: 'bmw',
    caseInsensitive: true,
  })
  .all() %}
```

[Dropdown](../reference/field-types/dropdown.md), [Radio](../reference/field-types/radio.md), [Checkboxes](../reference/field-types/checkboxes.md), and other fields whose only allowable values are determined by the field’s configuration are _always_ handled in a case-sensitive way.

### Reusing Queries

Sometimes, you might want to run a number of similar queries. Take this case, where we want to show some information about upcoming events at a library:

```twig
{# Assuming we're on a page for a specific branch: #}
{% set upcomingEvents = craft.entries()
  .section('events')
  .dateStart(">= #{now|atom}")
  .branch(entry) %}

{% set weekEvents = clone(upcomingEvents)
  .dateEnd("< #{now|modify('+1 week')|atom}") %}
Events in the next week: {{ weekEvents.count() }}

{% set monthEvents = clone(upcomingEvents)
  .dateEnd("< #{now|modify('+1 month')|atom}") %}
Events in the next month: {{ monthEvents.count() }}
```

The [`clone()` function](../reference/twig/functions.md#clone) is used to copy a base query, before setting additional parameters. Parameters set on the base query (like `dateStart()`, above) will affect all subsequent queries, unless explicitly unset.

::: tip
Note that we are only executing the `weekEvents` and `monthEvents` queries! Cloning an executed query will just copy the results.
:::

### Relational Fields

Any time you access a [relational field](../system/relations.md#fields) (specifically, one that hasn’t been [eager-loaded](eager-loading.md)), Craft automatically clones it:

```twig
{% set relatedDocuments = entry.attachments.type('document').all() %}
{% set relatedArticles = entry.attachments.type('article').all() %}
{% set recentAttachments = entry.attachments
  .dateCreated(">= #{now|date_modify('-1 week')}")
  .orderBy('dateCreated DESC')
  .limit(5)
  .all() %}
```

In this example, each time `entry.attachments` is accessed, it returns a fresh element query prepared to fetch the explicitly related elements, in the order they were defined in the control panel. Calling `.type('...')` on the first two queries will _not_ affect the third query. If instead you captured the query in an intermediate variable, each param would be applied in sequence on a single query:

```twig
{% set attachmentsQuery = entry.attachments %}
{% set relatedDocuments = attachmentsQuery.type('document').all() %}
{% set relatedArticles = attachmentsQuery.type('article').all() %}
{% set recentAttachments = attachmentsQuery
  .dateCreated(">= #{now|date_modify('-1 week')}")
  .orderBy('dateCreated DESC')
  .limit(5)
  .all() %}
```

The first two sets of results here will contain the expected elements—`relatedDocuments` modifies the base query, and then `relatedArticles` overwrites the `type` param—but the third will retain the last-set `type` value and apply additional `dateCreated` and `orderBy` params. Instead of containing the latest five attachments of any type, it will only include the latest five _articles_.

### Ordering

Each type of element query has a default sort order—[entries](../reference/element-types/entries.md), for example, use the `postDate`; [tags](../reference/element-types/tags.md) are sorted by `title`; and [users](../reference/element-types/users.md) by `username`.

You can sort by most attributes or custom fields with the `.orderBy()` query method:

```twig{4}
{% set latestTastes = craft.entries()
  .section('tasteTests')
  .orderBy('reviewDate DESC')
  .limit(5)
  .all() %}
```

If a field would produce the same value for many entries, multiple criteria can be combined:

```twig{3}
{% set bigFlavors = craft.entries()
  .section('tasteTests')
  .orderBy('primaryFlavorGroup ASC, flavorIntensity DESC')
  .all() %}
```

Ascending (`ASC`) and descending (`DESC`) sorting depend on how the attribute’s data is stored.

Value Type | Ascending | Descending
--- | --- | ---
String | Alphabetic | Reverse alphabetic
Number | Increasing | Decreasing
Date | Oldest first | Most recent first

In the last example, if `primaryFlavorGroup` was a [dropdown](../reference/field-types/dropdown.md) field, entries would be sorted by the “value” of the selected options not the “label,” which can sometimes be unpredictable: one might expect “Dark Chocolate” to follow “Clove,” when its value is actually `chocolateDark` (and would therefore come _before_ `clove`, alphabetically).

::: tip
Not _all_ fields can be used for ordering a query. Relational fields, Matrix fields, and authors, for example, are all stored in external tables, and don’t have accessible or neatly comparable values to sort by. 
:::

#### Nested Sorting <Since ver="5.6.0" feature="Ordering by non-default nested field values" />

Some fields (like the built-in [link](../reference/field-types/link.md) and [date](../reference/field-types/date-time.md) fields) store multiple values. Craft allows you to sort on specific sub-keys—say, to gather similar types of contact info together:

```twig
{% set reps = craft.entries()
  .section('reps')
  .orderBy('primaryContact.type ASC, dateHired DESC')
  .all() %}
```

## Executing Element Queries

Once you’ve defined your parameters on the query, there are multiple functions available to [execute it](#query-execution), depending on what you need back.

::: tip
Craft also makes it easy to display the results of an element query across multiple pages with [pagination](#pagination).
:::

### `all()`

The most common way to fetch a list of results is with the `all()` method, which executes the query and returns an array of populated [element](../system/elements.md) models. The resulting elements will _always_ be of the type that the query started with—assets come back from asset queries, categories from category queries, and so on.

::: code
```twig
{% set entries = craft.entries()
  .section('news')
  .limit(10)
  .all() %}
```
```php
use craft\elements\Entry;

$entries = Entry::find()
    ->section('news')
    ->limit(10)
    ->all();
```
:::

::: tip
Declaring a `limit()` _and_ executing a query with `all()` may seem like a contradiction, but this is a totally valid query! `all()` doesn’t override the `limit()`; rather, it returns _all_ results that meet the current criteria—one of which just happens to be a cap on the number of allowed results. Regardless of the number of results, `.all()` always returns an array—even if it’s empty.
:::

### `collect()`

Calling `.collect()` to execute a query will perform the same database call as `.all()`, but the results are wrapped in a [Collection](collections.md).

Collections can simplify some common array manipulation and filtering tasks that are otherwise awkward in the template or query builder:

::: code
```twig
{% set entries = craft.entries()
  .section('news')
  .with(['category'])
  .limit(10)
  .collect() %}

{% set categoriesDescription = entries
  .pluck('category')
  .collapse()
  .pluck('title')
  .join(', ', ' and ') %}
Posted in: {{ categoriesDescription }}
```
```php
use craft\elements\Entry;

$entries = Entry::find()
    ->section('news')
    ->with(['category'])
    ->limit(10)
    ->collect();

$categoriesDescription = $entries
    // Collate all the attached categories:
    ->pluck('category')
    // Flatten those into a single array:
    ->collapse()
    // Grab just the titles:
    ->pluck('title')
    // Turn them into a comma-separated list:
    ->join(', ', ' and ');
```
:::

You can also call `.all()` and wrap the results in a collection yourself, with the [`collect()` Twig function](../reference/twig/functions.md#collect).

::: tip
Review some of the [optimization tips](#performance-and-optimization) to see if built-in query methods can accomplish what you need.

For example, loading and populating hundreds of element models into a collection solely to calculate an average field value may not be necessary; the database is highly optimized for tasks like this!
:::

### `one()`

If you only need a single element, call `one()` instead of [`all()`](#all). It will return either a populated element model or `null` if no matching element exists.

::: code
```twig
{% set entry = craft.entries()
  .section('news')
  .slug('hello-world')
  .one() %}
```
```php
use craft\elements\Entry;

$entry = Entry::find()
    ->section('news')
    ->slug('hello-world')
    ->one();
```
:::

### `exists()`

If you just need to check if any elements exist that match the element query, you can call `exists()`, which will return either `true` or `false`.

::: code
```twig
{% set exists = craft.entries()
  .section('news')
  .slug('hello-world')
  .exists() %}
```
```php
use craft\elements\Entry;

$exists = Entry::find()
    ->section('news')
    ->slug('hello-world')
    ->exists();
```
:::

### `count()`

If you want to know how many elements match an element query, call `count()`.

::: code
```twig
{% set count = craft.entries()
  .section('news')
  .count() %}
```
```php
use craft\elements\Entry;

$count = Entry::find()
    ->section('news')
    ->count();
```
:::

::: tip
The `limit` and `offset` parameters will be ignored when you call `count()`.
:::

### `ids()`

If you just want a list of matching element IDs, you can call `ids()`. This returns an array of integers.

::: code
```twig
{% set entryIds = craft.entries()
  .section('news')
  .ids() %}
```
```php
use craft\elements\Entry;

$entryIds = Entry::find()
    ->section('news')
    ->ids();
```
:::

### `column()`

Combined with a single-column [selection](#selections), the `column()` execution method will return a scalar value for each row instead of an object:

::: code
```twig
{% set entries = craft.entries()
  .section('news')
  .select(['title'])
  .column() %}

{# -> ['Post A', 'Post B', 'Post C'] #}
```
```php
use craft\elements\Entry;

$entries = Entry::find()
    ->section('news')
    ->select(['title'])
    ->column();

// -> ['Post A', 'Post B', 'Post C']
```
:::

An array of scalar values is returned, the type of which depends on the column. Elements are _not_ populated when using `column()`, so methods and properties you may be accustomed to using after other queries will not be available.

## Pagination

Craft provides the [`{% paginate %}` tag](../reference/twig/tags.md#paginate) to simplify the process of splitting results into pages with a stable URL scheme based on the <config5:pageTrigger> setting.

The `paginate` tag accepts an element query, sets its `offset` param based on the current page, and executes it. The number of results per page is determined by the query’s `limit` param, or defaults to 100.

```twig
{# Prepare your query, but don’t execute it: #}
{% set newsQuery = craft.entries()
  .section('news')
  .orderBy('postDate DESC') %}

{# Paginate the query into a `posts` variable: #}
{% paginate newsQuery as pageInfo, posts %}

{# Use the `posts` variable just like you would any other result set: #}
{% for post in posts %}
  <article>
    <h2>{{ post.title }}</h2>
    {# ... #}
  </article>
{% endfor %}
```

::: warning
Paginating a query will only work if the results come back in a stable order and the page size is kept consistent. Using randomized values in query params or in an `orderBy` clause will be disorienting for users.

Results from a [search](#search) query are perfectly fine to paginate.
:::

### Navigating Pages

In our example, the `pageInfo` variable (a [Paginate](craft5:craft\web\twig\variables\Paginate) instance) has a number of properties and methods to help you work with paginated results. The variable can be named anything you like, so long as references to it are updated.

`first`
: Number of the first element on the _current_ page. For example, on the second page of 10 results, `first` would be `11`.

`last`
: Number of the last element on the _current_ page. For example, on the first page of 10 results, `last` would be `10`.

`total`
: Total number of results, across all pages.

`currentPage`
: The current page. Equivalent to `craft.app.request.getPageNum()`.

`totalPages`
: The total number of pages the results are spread across. The last page of results may not be complete.

`getPageUrl(page)`
: Builds a URL for the specified `page` of results.

`getFirstUrl()`
: Builds a URL for the first page of results. Equivalent to `pageInfo.getPageUrl(1)`.

`getLastUrl()`
: Builds a URL for the last page of results. Equivalent to `pageInfo.getPageUrl(pageInfo.totalPages)`.

`getNextUrl()`
: Get a URL for the next page of results. Returns `null` on the last page of results.

`getPrevUrl()`
: Get a URL for the previous page of results. Returns `null` on the first page of results.

`getNextUrls(num)`
: Gets up to `num` next page URLs, indexed by their page numbers.

`getPrevUrls(num)`
: Gets up to `num` previous page URLs, indexed by their page numbers.

`getRangeUrls(start, end)`
: Returns a list of URLs indexed by their page number. The list will only include valid pages, ignoring out-of-range `start` and `end` values.

`getDynamicRangeUrls(max)`
: Returns up to `max` page URLs around the current page, indexed by their page numbers.

::: tip
The values above use a one-based index, so they are human-readable without any additional work.
:::

#### Examples

You can display a summary of the current page using `pageInfo.total`, `pageInfo.first`, and `pageInfo.last`:

```twig
Showing {{ pageInfo.first }}–{{ pageInfo.last }} of {{ pageInfo.total }} results.
```

Next and previous links are simple:

```twig
<nav role="navigation" aria-label="Search result pagination">
  {% if pageInfo.getPrevUrl() %}
    <a href="{{ pageInfo.getPrevUrl() }}">Previous Page</a>
  {% endif %}
  {% if pageInfo.getNextUrl() %}
    <a href="{{ pageInfo.getNextUrl() }}">Next Page</a>
  {% endif %}
</nav>
```

We could improve this for screen readers by including specific page numbers in the labels:

```twig
{% set prevLinkSummary = "#{pageInfo.currentPage - 1} of #{pageInfo.totalPages}" %}

{{ tag('a', {
  text: 'Previous Page',
  href: pageInfo.getPrevUrl(),
  aria: {
    label: "Previous page (#{prevLinkSummary})"
  }
}) }}
```

::: tip
We’re using the [`tag()` Twig function](../reference/twig/functions.md#tag) to make this a little more readable, but its output is equivalent to a normal anchor element.
:::

More advanced pagination links are also possible with `getDynamicRangeUrls()`:

```twig{3}
<nav role="navigation" aria-label="Search result pagination">
  <ul>
    {% for p, url in pageInfo.getDynamicRangeUrls(5) %}
      <li>
        {{ tag('a', {
          text: p,
          href: url,
          aria: {
            label: "Go to page #{p} of #{pageInfo.totalPages}",
          },
        }) }}
      </li>
    {% endfor %}
  </ul>
</nav>
```

Notice how our loop uses the keys (`p`) _and_ values (`url`) from the returned array—Craft assigns each URL to a key matching its page number!

## Search

Craft gives you access to its [search](../system/searching.md) index from any element query. Use the `search` param to narrow results by keywords:

::: code
```twig{5}
{% set q = craft.app.request.getQueryParam('search') %}

{% set results = craft.entries
  .section('news')
  .search(q)
  .all() %}
```
```php{5}
$q = Craft::$app->getRequest()->getQueryParam('search');

$results = Entry::find()
    ->section('news')
    ->search($q)
    ->all();
```
:::

<See path="../system/search.md" description="Learn about the supported syntaxes for plain-text search." />

The value passed to `.search()` can come from anywhere—user input via an HTML form (via `craft.app.request`), hard-coded terms, or from another field (like `entry.relatedSearchFilter`). While search is a great tool, it’s generally not appropriate for finding up elements with specific qualities—for example, you _can_ search for JPEG assets by calling `.search('extension:jpg')`, but using the dedicated [`.extension('jpg')` query method](../reference/element-types/assets.md#extension) will produce faster and more consistent results.

::: warning
Be aware that exposing records to search _can_ lead to [unintended disclosure or enumeration](../system/searching.md#development) of content that is not otherwise visible. For example, a query like `craft.entries.section('locations').search(q)` (where `q` is a term provided by a user with some understanding of your content model) could attempt to figure out which stores are managed by people with the last name “Smith” by sending a query like `managedBy:*smith*`.
:::

## Performance and Optimization

When you start working with lots of data, it’s important to consider how queries affect your pages’ load time. While the [`{% cache %}` tag](../reference/twig/tags.md#cache) can be used strategically to avoid major slowdowns, it’s only one of many tools at your disposal.

::: tip
Turn on the **Debug Toolbar** in your user’s preferences to profile your memory usage and database query counts.
:::

### Eager Loading

Displaying a list of elements and one or more elements related to each of them (say, blog posts and any tags or categories attached to them) can lead to an “N+1” problem, wherein each result from the main query triggers an additional query. Craft addresses this with [eager-loading](eager-loading.md).

<See path="eager-loading.md" description="Eager-loading is a means of fetching nested or related elements in bulk." />

### Caching Element Queries

Results can be cached with the `cache()` method:

::: code
```twig
{% set entries = craft.entries()
  .section('news')
  .limit(10)
  .cache()
  .all() %}
```
```php
use craft\elements\Entry;

$entries = Entry::find()
    ->section('news')
    ->limit(10)
    ->cache()
    ->all();
```
:::

This cache is separate from fragments cached via [{% cache %} template tags](../reference/twig/tags.md#cache), and will only match subsequent queries that have all the same parameters. Caching a query does not guarantee better [performance](#performance-and-optimization), but it can be used strategically—say, to memoize a scalar query result inside a loop (like the total number of entries in a list of categories).

The `cache()` method accepts a `duration` argument, and defaults to your <config5:cacheDuration>.

::: tip
Craft registers an [ElementQueryTagDependency](craft5:craft\cache\ElementQueryTagDependency) for you by default, so cache dependencies and invalidation are handled automatically.
:::

### Large Result Sets

Sometimes, a query will simply depend on a large number of elements (and [pagination](#pagination) is not possible), or it needs to use the most current data available (so [caching](#caching-element-queries) is off the table).

Populating element models can be resource-intensive, and loading many thousands of records can exhaust PHP’s memory limit. Let’s look at some common places where queries can be optimized to avoid this bottleneck.

#### Counting

In this example, we just need the number of active users:

::: code
```twig Slow
{# Loads and populates all users, then gets the length of the array: #}
{% set totalUsers = craft.users().status('active').all()|length %}
```
```twig Optimized
{# Uses the SQL COUNT(*) function and returns only an integer: #}
{% set totalUsers = craft.users().status('active').count() %}
```
:::

In addition to the memory footprint of the optimized query being many orders of magnitude smaller, we’re also avoiding a huge amount of data transfer between the PHP process and database server!

::: tip
Using the [`length`](../reference/twig/filters.md#length) filter on a query (before it’s been run) will automatically call its [`count()`](#count) execution method to prevent inadvertent performance issues. Other situations in which queries are treated as arrays may not be optimized in the same way.
:::

#### Arithmetic Operations

Counting isn’t the only operation that the database can do for you! What if we wanted to find the minimum and maximum values for a given field?

::: code
```twig Slow
{# Loads field data for every race, then throws out all but one property: #}
{% set races = craft.entries()
  .section('races')
  .all() %}
{% set fastestTime = min(races|column('winningTime')) %}
{% set slowestTime = max(races|column('winningTime')) %}
```
```twig Optimized
{# Set up a base query to select only the times: #}
{% set raceQuery = craft.entries()
  .section('races')
  .select('winningTime') %}

{# Execute it twice with different ordering criteria: #}
{% set fastestTime = clone(raceQuery)
  .orderBy('winningTime ASC')
  .scalar() %}
{% set slowestTime = clone(raceQuery)
  .orderBy('winningTime DESC')
  .scalar() %}
```
:::

`scalar()` is just an [execution method](#executing-element-queries) that returns the first column from the first result—it will always produce a simple, “[scalar](https://www.php.net/manual/en/function.is-scalar.php)” value.

::: warning
While `select()` and `orderBy()` accept field handles and ambiguous columns, some SQL functions and expressions (like `MIN()` or `SUM()`) may not. In these cases, you will need to [build a valid expression](#content-and-custom-fields) for extracting the key(s) from the content JSON blob.
:::

#### Lean Selections

Combining a narrower [selection](#selections) with an execution method that returns results as an array (or explicitly calling `toArray()` while preparing a query) can significantly reduce the amount of memory a query requires.

::: code
```twig Slow
{# Load all donor entries with complete native + custom field data: #}
{% set donors = craft.entries()
  .section('donors')
  .all() %}

<ul>
  {% for donor in donors %}
    <li>{{ donor.title }} — {{ donor.lifetimeGiftAmount|money }}</li>
  {% endfor %}
</ul>
```
```twig Optimized
{# Load only donor names and gift amounts: #}
{% set donors = craft.entries()
  .section('donors')
  .select([
    'title',
    'lifetimeGiftAmount'
  ])
  .pairs() %}

<ul>
  {% for name, amount in donors %}
    <li>{{ name }} — {{ amount|money }}</li>
  {% endfor %}
</ul>
```
:::

The `pairs()` [execution method](#executing-element-queries) is a shorthand for creating a key-value hash from the first two columns of each row. Collisions can occur, so it’s safest to use a column you know will be unique for your first selection!

::: warning
Not all attributes can be fetched this way—element URLs, for instance, are built on-the-fly from their URIs and site’s base URL. Relational data may also be more difficult to work with, as it often has to be eager-loaded alongside fully-populated element models.
:::

## Advanced Element Queries

Element queries are specialized [query builders](guide:db-query-builder) under the hood, so they support most of the same methods provided by <craft5:craft\db\Query>. The most common methods appear below—argument lists are non-exhaustive, and are only provided to differentiate them.

::: tip
You may call <craft5:craft\db\Query::asArray()> to skip populating element models with results and return matching rows’ data as an associative array. Altering [selections](#selections) in particular can make elements behave erratically, as they may be missing critical pieces of information.
:::

### Content and Custom Fields

We typically recommend using the [methods corresponding to your fields’ global handles](#querying-with-custom-fields) to narrow element queries—but sometimes, criteria can only be expressed with direct use of ActiveRecord’s `where()` and `andWhere()`.

Most custom field values are stored in a single JSON column, keyed by their unique field instance UUID. Craft handles this automatically when using a field or field instance’s built-in query methods (i.e. `.myCustomDateField('<= 2025-11-05')`) by building the appropriate “JSON extraction” expression.

Craft also attempts to detect use of field instance handles in `.where()` and `.orderBy()`, and map them to the corresponding extraction expression. <Since ver="5.6.0" feature="Field instance handle mappings for query constraints and ordering" />

```twig
{% set safeStews = craft.entries()
  .section('dishes')
  .andWhere([
    ['>', 'scovilleRating', '1000'],
    ['<', 'scovilleRating', '9000'],
  ])
  .andWhere([
    'not',
    ['like', 'primaryProtein, '%shellfish%'],
    ['like', 'primaryProtein, '%shrimp%'],
    ['like', 'primaryProtein, '%scallop%'],
  ])
  .orderBy('scovilleRating')
  .all() %}
```

::: warning
Note that our `scovilleRating` constraints (`'1000'` and `'9000'`) are passed as _strings_, not _integers_. This is necessary, as JSON values are not “cast” during comparison when using `where()`, directly.
:::

Craft can’t _always_ infer what should be a plain column name or a field or field instance handle, when working with advanced [condition](#conditions) and [execution](#query-execution) methods. This means you are responsible for building equivalent field value expressions. Typically, this involves a field instance handle and a _field layout provider_ (like an entry type, asset volume, category group, or other component that manages a field layout):

::: code
```twig{1,7} Twig
{% set valueSql = fieldValueSql(entryType('post'), 'sourceMedia') %}

{% set entriesFromPhysicalMedia = craft.entries()
  .section('news')
  .andWhere([
    'or like',
    valueSql,
    ['print', 'paper', 'press']
  ])
  .all() %}
```
```php PHP
$entryType = Craft::$app->getEntries()->getEntryTypeByHandle('post');
$fieldLayout = $entryType->getFieldLayout();
$fieldInstance = $fieldLayout->getFieldByHandle('sourceMedia');

$entriesFromPhysicalMedia = Entry::find()
    ->section('news')
    ->andWhere([
      'or like',
      $fieldInstance->getValueSql(),
      ['print', 'paper', 'press'],
    ])
    ->all();
```
:::

Each element type has a unique means of accessing the relevant field layout provider:

Assets
:   Asset field layouts are provided by their volumes:

    ```twig
    {% set provider = craft.app
      .volumes
      .getVolumeByHandle('myAssetVolume') %}
    ```

Entries
:   You can get an entry type via the `entries` service…
    ```twig
    {% set provider = craft.app
      .entries
      .getEntryTypeByHandle('myEntryType') %}
    ```
    …or use the [Twig helper](../reference/twig/functions.md#entrytype):
    ```twig
    {% set provider = entryType('myEntryType') %}
    ```

Categories
:   Categories’ field layouts are defined by their _group_:
    ```twig
    {% set provider = craft.app
      .categories
      .getGroupByHandle('myCategoryGroup') %}
    ```

Global Sets
:   Global sets are unique, in that they provide their own field layouts:
    ```twig
    {% set provider = craft.app
      .globals
      .getSetByHandle('myGlobalSet') %}
    ```

Tags
:   Like categories, tags’ field layouts come from their _group_:
    ```twig
    {% set provider = craft.app
      .tags
      .getTagGroupByHandle('myTagGroup') %}
    ```

Pass any of these `provider` variables to `fieldValueSql()` along with the desired field instance handle to build the required expression:

```twig
{% set valueSql = fieldValueSql(provider, 'sourceMedia') %}
```

Addresses and users do not have field layout providers. Instead, you can construct the correct expression via their field layouts, directly:

Address
:   Use the `addresses` service to load the single address field layout:
    ```twig
    {% set valueSql = craft.app
      .addresses
      .getFieldLayout()
      .getFieldByHandle('myFieldHandle')
      .getValueSql() %}
    ```

User
:   There is no analogous API for the user field layout, but you can get it directly by its class name—it is guaranteed to be unique:
    ```twig
    {% set valueSql = craft.app
      .fields
      .getLayoutByType('craft\\elements\\User')
      .getFieldByHandle('myFieldHandle')
      .getValueSql() %}
    ```

If you have an address or user element in a variable, you can always call `element.getFieldLayout()`, then get the field layout element and value SQL. This can produce unexpected results for element types that support more than one field layout.

### Fixed Ordering

When using `.id()` to query for elements with a specific set of IDs, you can call `.fixedOrder()` to retain their positions. This alleviates some problems when [limiting](#selections) or [paginating](#pagination) sets of results that are in a prescribed order.

```twig
{% set someExternalApiResult = ['SKU-C', 'SKU-R', 'SKU-A', 'SKU-F', 'SKU-T', '...'] %}

{# Pre-flight a query to get a SKU-to-ID map: #}
{% set internalIdMatches = craft.entries()
  .select(['id', 'sku'])
  .indexBy('sku')
  .asArray()
  .all() %}

{# Translate SKUs to internal IDs, and load the entries in that order: #}
{% set orderedMatches = craft.entries()
  .id(someExternalApiResult | map(sku => internalIdMatches[sku].id))
  .fixedOrder()
  .all() %}
```

### Selections

Selections modify what columns and rows are returned.

[select()](yii2:yii\db\Query::select()) and [addSelect()](yii2:yii\db\Query::addSelect())
: Define a list of columns to `SELECT`, or add columns to an existing selection. Craft automatically resolves custom field handles based on the possible field layouts. <Since ver="5.5.0" feature="Automatic resolution of custom field handles in query selections" />

[distinct()](yii2:yii\db\Query::distinct())
: Return only rows that have a unique combination of values in the provided column(s).

[groupBy($columns)](yii2:yii\db\Query::groupBy())
: Combine or flatten database rows based on the value of one or more columns. Often used in combination with aggregate selections or [execution methods](#query-execution) like `.sum(columnName)`. Note that this is _not_ equivalent to or compatible with the [`group` Twig filter](../reference/twig/filters.md#group) or the [collection](collections.md) method of the same name, which operate on arrays, in-memory.

[limit($n)](yii2:yii\db\Query::limit())
: Set a maximum number of results that can be returned.

[offset($n)](yii2:yii\db\Query::offset())
: Skip the specified number of matching rows.

### Joins

In most cases, Craft automatically `JOIN`s the appropriate tables so that your elements are populated with the correct data. However, additional `JOIN`s can be useful in [plugin development](../extend/README.md) or for doing deeper analysis of your content.

[innerJoin($table, $condition)](yii2:yii\db\Query::innerJoin())
: Adds an `INNER JOIN` clause for the target table, using the provided condition.

[leftJoin($table, $condition)](yii2:yii\db\Query::leftJoin())
: Adds a `LEFT JOIN` clause for the target table, using the provided condition.

[rightJoin($table, $condition)](yii2:yii\db\Query::rightJoin())
: Adds a `RIGHT JOIN` clause for the target table, using the provided condition.

`JOIN` conditions are generally expected to be in this format:

```php{7}
$popularAuthors = craft\elements\Entry::find()
  ->select([
    'users.fullName as name',
    'COUNT(*) as postCount',
  ])
  ->groupBy('entries.authorId')
  ->leftJoin('{{%users}}', '[[entries.authorId]] = [[users.id]]')
  ->asArray()
  ->all();
```

Craft prepares two queries when fetching elements (a main query and a “subquery”) and applies `JOIN`s to both, so that you can use the tables for filtering _and_ for selections. Read more about the architecture of element queries in the [extension documentation](../extend/element-types.md#element-query-class).

::: warning
Adding columns to your selection from other tables may cause errors when populating elements, as they will not have a corresponding class property. Call `asArray()` to return your results as a plain associative array, or consider [attaching a `Behavior`](../extend/behaviors.md).
:::

### Conditions

::: warning
Exercise caution when using these methods directly—some will completely overwrite the existing query conditions and cause unpredictable results like allowing drafts, revisions, pending and disabled entries, or elements from other sites to leak into the result set.

Specific [element type queries](#element-types) and [custom field methods](#querying-with-custom-fields) often provide a more approachable and reliable API for working with the database, and will modify the query in non-destructive ways.
:::

The following methods will work on any “real” database columns, but may require building an [appropriate expression for custom field values](#content-and-custom-fields).

[where()](yii2:yii\db\QueryTrait::where())
: Directly set the query’s `WHERE` clause. See the warning, above.

[andWhere()](yii2:yii\db\QueryTrait::andWhere())
: Add expressions to the `WHERE` clause. Useful if the provided [element type-specific query methods](#element-types) can’t achieve an advanced condition required by your site or application.

[orWhere()](yii2:yii\db\QueryTrait::orWhere())
: Starts a new `WHERE` clause.

[filterWhere()](yii2:yii\db\QueryTrait::filterWhere())
: Same as `where()`, but ignores `null` values in the passed conditions.

[andFilterWhere()](yii2:yii\db\QueryTrait::andFilterWhere())
: Same as `andWhere()`, but ignores `null` values in the passed conditions.

[orFilterWhere()](yii2:yii\db\QueryTrait::orFilterWhere())
: Same as `orWhere()`, but ignores `null` values in the passed conditions.


### Query Execution

Some of these methods are discussed in the [Executing Element Queries](#executing-element-queries) section.

[all()](yii2:yii\db\Query::all()) — `craft\base\Element[]`
: Array of populated element models.

[collect()](craft5:craft\db\Query::collect()) — `Illuminate\Support\Collection`
: Same as `all()`, but wrapped in a [Collection](./collections.md).

[one()](yii2:yii\db\Query::one()) — `craft\base\Element|null`
: Element model or `null` if none match the criteria.

[nth($n)](craft5:craft\db\Query::nth()) — `craft\base\Element|null`
: Element model or `null` if one doesn’t exist at the specified offset.

[exists()](yii2:yii\db\Query::exists()) — `boolean`
: Whether or not there are matching results.

[count()](yii2:yii\db\Query::count()) — `int`
: The number of results that would be returned.

[column()](yii2:yii\db\Query::column()) — `array`
: Array of scalar values from the first selected column.

[scalar()](yii2:yii\db\Query::scalar()) — `int|float|string|boolean`
: A single, scalar value, from the first selected column of the matching row.

[sum($column)](yii2:yii\db\Query::sum()) — `int|float`
: Total of values in `$column` across all matching results

[average($column)](yii2:yii\db\Query::average()) — `int|float`
: Average of all `$column` values matching results

[min($column)](yii2:yii\db\Query::min()) — `int|float`
: Minimum value in `$column` among matching results

[max($column)](yii2:yii\db\Query::max()) — `int|float`
: Maximum value in `$column` among matching results

[pairs()](craft5:craft\db\Query::pairs()) — `array`
: The first selected column becomes the returned array’s keys, and the second, its values. Duplicate keys are overwritten, so the array may not have the same number of elements as matched the query.

::: tip
When customizing an element query, you can call [getRawSql()](craft5:craft\db\Query::getRawSql()) to get the full SQL that is going to be executed by the query, so you have a better idea of what to modify.

```twig
{{ dump(query.getRawSql()) }}
```
:::

## Headless Applications

Craft can act as a headless content back-end for your static or client-rendered website. There are two main ways of making content available to applications that exist outside Craft’s built-in Twig templating layer:

### Element API

The first-party [Element API](plugin:element-api) allows you to map _endpoints_ to element queries with a combination of static and dynamic criteria and serve JSON-serialized results.

### GraphQL

Craft includes a [GraphQL API](graphql.md) with configurable schemas. Many of the same element query basics apply when accessing elements via GraphQL.

::: warning
For security reasons, not all query builder features are available via GraphQL. Some advanced queries may need to be executed separately and combined by the client.
:::
</file>

<file path="development/forms.md">
---
description: Exchange data with Craft over HTTP.
related:
  - uri: ../reference/controller-actions.md
    label: Controller Action Reference
  - uri: graphql.md
    label: Using Craft’s GraphQL API
---

# Forms

If you’ve gotten familiar with Craft’s [control panel](../system/control-panel.md), you might be wondering what kinds of things you can do from your site’s front-end. The answer is actually _quite a bit_!

<!-- more -->

Any time you want to get information from (or send information _to_) Craft, it’s part of the [request](#making-requests)-[response](#responses) lifecycle. This page covers the process of setting up HTML forms (and other types of requests like [Ajax](#ajax)!) to send and receive data in a way that Craft understands.

<See path="../reference/controller-actions.md" label="Controller Actions Reference" description="See a list of controller actions you can interact with via forms." />

## Making Requests

Most of your interactions with Craft so far have likely been over HTTP. Let’s take a look at how Craft determines what to do when it receives a request.

### Params

This page will make frequent references to _query_ and _body_ params. These are named values sent with a request, either encoded after a `?` in the URL, or within the “body” of a request. Query params are used in [GET](#get) and [POST](#post) requests, but body params are only used in POST requests.

Craft uses a handful of params to properly route a request, but may expect others based on what it thinks the user is requesting. For example, most requests use an [action](#actions) param, but a [login request](../reference/controller-actions.md#post-userslogin) also requires a `username` and `password` param.

### Actions

An “action request” is one that explicitly declares the [controller and action](../reference/controller-actions.md) to use, via an `action` query or body param.

::: tip
This `action` parameter is different from the `<form action="...">` attribute:

- The `action` _param_ should be used within a URL query string (`?action=...`) for `GET` requests, or in the body of a `POST` request.
- The _form attribute_ should only be used when you want to control where a user is sent in [failure scenarios](#failure). When an `action` param is _not_ present in the request, you can use an “action path” like `action="/actions/users/login"`. This attribute has no effect if a redirect is issued in response to the request!
:::

Craft also supports routing to specific actions using a path (beginning with the <config5:actionTrigger> setting), or by creating an [rule in `routes.php`](../system/routing.md#advanced-routing-with-url-rules).

### HTTP Verbs

Each action usually responds to one [HTTP method](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods). Using an unsupported method will throw a <yii2:yii\web\BadRequestHttpException>, and show your [error template](../system/routing.md#error-templates) with a 400 `statusCode`—or send a JSON response with an `error` key.

#### `POST`

All `POST` requests are made through forms or [Ajax](#ajax), and require an `action` parameter and CSRF token.

```twig{3-4}
{# Let your users request a password reset: #}
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('users/send-password-reset-email') }}

  <label for="loginName">Username or email</label>
  {{ input('text', 'loginName', null, {
    id: 'loginName',
  }) }}

  <button>Reset Password</button>
</form>
```

Some `POST` requests will write [flashes](#flashes) into the session to communicate successes and failures.

::: tip
Flashes are _not_ set when using [Ajax](#ajax). Look for confirmation and errors in the response!
:::

#### `GET`

`GET` requests are made by accessing an action URL by way of a regular anchor tag, a form submission, or Ajax. In the [examples](#available-actions) that follow, `GET` action requests are much less common than `POST`, as the bulk of read-only request routing is handled for you, out of the box.

::: code
```twig Anchor/Link
{# Output a “log out” link: #}
<a href="{{ actionUrl('users/logout') }}">Log Out</a>

{# Craft actually provides a shortcut for this: #}
<a href="{{ logoutUrl }}">Log Out</a>
```
```twig Form
{# Pass any element to this (say, as a Twig partial) to get a control panel edit button: #}
<form>
  {{ actionInput('elements/redirect') }}
  {{ hiddenInput('elementId', object.id) }}

  <button>Edit</button>
</form>
```
```js Ajax
// Get info about the current session (guests) and user (if logged in):
fetch('/actions/users/session-info', {
  headers: {
    'Accept': 'application/json',
  },
})
.then(response => response.json())
.then(result => console.log(result));
// -> { isGuest: true, timeout: 0, csrfTokenValue: '...' }
```
:::

::: tip
You may notice that the `actionUrl()` function generates URLs with `index.php` visible, despite your <config5:omitScriptNameInUrls> setting. This is intended, as it guarantees compatibility with all environments, regardless of configuration.

If you need a cleaner URL, consider setting up a custom [route](../system/routing.md#advanced-routing-with-url-rules).
:::

### CSRF

Craft has built-in [Cross-Site Request Forgery](https://owasp.org/www-community/attacks/csrf) mitigation, and therefore requires a valid session and token any time data is POSTed to a controller action.

For requests initiated by an HTML `<form>`, use the `csrfInput()` [Twig helper](#form-helpers):

```twig{2}
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('entries/save-entry') }}

  {# ... #}
</form>
```

The process is slightly more complicated for [Ajax](#ajax) requests, but can be abstracted in a manner appropriate for your project.

Any time a CSRF token is generated during a request, Craft sends no-cache headers to prevent tokens from leaking across sessions or becoming stale. <Since ver="5.3.0" description="We began sending automatic no-cache headers in {product} {ver}." />

::: warning
Tokens can still be captured within [`{% cache %}` tags](tags.md#cache), so be mindful of context when rendering forms—or pass the [`async` option](../reference/twig/functions.md#csrfinput) to `csrfInput()`!
:::

### Form Helpers

Craft has a number of built-in Twig functions to make dealing with forms and input easier.

Function | Notes
-------- | -----
[actionInput()](../reference/twig/functions.md#actioninput) | Generate a hidden HTML `<input>` element for controlling which action a `<form>` should route to.
[actionUrl()](../reference/twig/functions.md#actionurl) | Generate an absolute URL to the specified action, with any extra params. <badge vertical="baseline" type="verb">GET</badge> only.
[csrfInput()](../reference/twig/functions.md#csrfinput) | Generate a hidden HTML `<input>` required for CSRF protection.
[failMessageInput()](../reference/twig/functions.md#failmessageinput) | Override error-condition flash messages. <badge vertical="baseline" type="verb">POST</badge> only, ignored for Ajax requests.
[hiddenInput()](../reference/twig/functions.md#hiddeninput) | Lower-level helper for generating hidden HTML inputs.
[input()](../reference/twig/functions.md#input) | Even finer-grained control over HTML `<input>` element creation.
[redirectInput()](../reference/twig/functions.md#redirectinput) | Generates a hidden HTML `<input>` element to control redirection after successful requests. <badge vertical="baseline" type="verb">POST</badge> only, ignored for Ajax requests.
[successMessageInput()](../reference/twig/functions.md#successmessageinput) | Override success-condition flash messages. <badge vertical="baseline" type="verb">POST</badge> only, ignored for Ajax requests.

### Ajax

In order to respond appropriately, Craft requires that Ajax requests are identified as such. Some tools (like jQuery) need no configuration; others (like the native [`fetch()` API](https://developer.mozilla.org/en-US/docs/Web/API/fetch)) will need to be configured explicitly:

Header | Notes
------ | -----
`Accept` | Set to `application/json` to receive a JSON response (when available).
`X-Requested-With` | Set to `XMLHttpRequest` if your templates rely on `craft.app.request.isAjax`.
`X-CSRF-Token` | Send a valid CSRF token (for POST requests) if none is provided in the request body under the key determined by <config5:csrfTokenName>.
`Content-Type` | Set to `application/json` if the request’s body is a serialized [JSON payload](#sending-json) (as opposed to `FormData`).
`X-Craft-Site` | Set to a valid [site](../system/sites.md) handle to treat the request as though it were part of a specific site.

A CSRF token is still required for Ajax requests using the `POST` method. You can ensure a session is started (for guests) by preflighting a request to the [`users/session-info` action](#get-userssession-info):

```js
// Helper for fetching a CSRF token:
const getSessionInfo = function() {
  return fetch('/actions/users/session-info', {
    headers: {
      'Accept': 'application/json',
    },
  })
  .then(response => response.json());
};

// Session info is passed to the chained handler:
getSessionInfo()
  .then(session => {
    const params = new FormData();

    // Read the User’s ID from the session data (assuming they’re logged in):
    params.append('userId', session.id);
    params.append('fullName', 'Tony Tiger');

    return fetch('/actions/users/save-user', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': session.csrfTokenValue,
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: params,
    })
    .then(response => response.json())
    .then(result => console.log(result));
  });
```

This example assumes you have no preexisting HTML from the server, as though it were part of a [headless](config5:headlessMode) application. If you are working on a hybrid front-end (and sprinkling interactivity into primarily server-rendered pages), you could eliminate the first request by stashing the user ID and CSRF token in the document’s `<head>` (or on another relevant element) and reading it with JavaScript:

```twig{5,8,14}
<button
  id="update-name"
  data-user-id="{{ currentUser.id }}"
  data-csrf-token-value="{{ craft.app.request.getCsrfToken() }}"
  data-csrf-token-name="{{ craft.app.config.general.csrfTokenName }}">Edit Name</button>

<script>
  const $button = document.getElementById('update-name');

  $button.addEventListener('click', function(e) {
    const params = new FormData();

    params.append('userId', $button.dataset.userId);
    params.append($button.dataset.csrfTokenName, $button.dataset.csrfTokenValue);
    params.append('fullName', prompt('New name:'));

    fetch('/actions/users/save-user', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: params,
    })
    .then(response => response.json())
    .then(result => console.log(result));
  });
</script>
```

::: warning
Note that by generating and outputting a CSRF token into HTML, the page can no longer be safely cached.
:::

When using the `fetch()` API, the body of a request can be set to a `FormData` object populated from an HTML form, as well:

```twig{11,22}
<form method="post" id="user-profile">
  {{ csrfInput() }}
  {{ actionInput('users/save-user') }}

  <input type="text" name="fullName" value="{{ currentUser.fullName }}" required>

  <button>Save</button>
</form>

<script>
  const $form = document.getElementById('user-profile');

  $form.addEventListener('submit', function(event) {
    event.preventDefault();

    fetch('/actions/users/save-user', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: new FormData($form),
    })
    .then(response => response.json())
    .then(result => console.log(result));
  })
</script>
```

#### CORS

Requests sent from a domain other than the one Craft is running on (including different subdomains, unless you’ve set <config5:defaultCookieDomain>) may need to use the [`credentials`](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#including_credentials) request option, and configure appropriate `Access-Control-Allow-Credentials` and `Access-Control-Allow-Origin` [headers](../reference/config/app.md#cors) in Craft.

#### Sending JSON

If you prefer to work with a JSON payload for the body, you must include [the appropriate `Content-Type` header](yii2:yii\web\Request::parsers). The equivalent `users/save-user` request would look like this:

```js{11,15}
// ...
const params = {
  userId: $button.dataset.userId,
  fullName: prompt('New name:'),
};

fetch('/actions/users/save-user', {
  method: 'POST',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
    'X-CSRF-Token': $button.dataset.csrfTokenValue,
    'X-Requested-With': 'XMLHttpRequest',
  },
  body: JSON.stringify(params),
})
.then(response => response.json())
.then(result => console.log(result));
```

Files cannot be uploaded when using `Content-Type: application/json`.

::: warning
When sending a JSON payload in the body of a request, you _must_ use an action path (`/actions/users/save-user`, as in the example above), or provide the action in a query parameter (`/index.php?action=users/save-user`)—the action will _not_ be properly picked up as a property of the decoded payload.
:::

#### Sites

In [headless](config5:headlessMode) mode, and when using [actions](#actions) or otherwise site-agnostic routes (i.e. configured via the [Element API](plugin:element-api) plugin), Craft uses the [primary site](../system/sites.md#primary-site), by default. This means that element queries, static message translations, emails, and other language-dependent features may be handled in unexpected ways.

Send a valid site ID or handle under the `X-Craft-Site` header <Since ver="5.6.0" feature="The X-Craft-Site header" /> to tell Craft that it should handle the request in the context of a specific site:

```js{8}
// Assuming there is a matching Element API route configured...
fetch('/my/api/news/5361', {
  method: 'POST',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
    'X-Requested-With': 'XMLHttpRequest',
    'X-Craft-Site': 'corporateFr',
  },
})
.then(response => response.json())
.then(result => console.log(result));
```

### Models and Validation

Most of the data creation and manipulation actions we’ll cover revolve around <yii2:yii\base\Model>s. Craft uses models to store and validate all kinds of things—including every type of [element](../system/elements.md) you’re already familiar with!

If you encounter [errors](#failure) when creating or saving something, it will usually be passed back to your template as a special variable like `entry` or `user`, and a [flash](#flashes) will be set. Every model has a `.getErrors()` method that returns a list of messages for any attribute (or custom field) that did not validate.

While abbreviated, this “user profile” form contains all the patterns required to display contextual validation errors:

::: code
```twig account.twig
{% extends '_layouts/default' %}

{# Require an active user session: #}
{% requireLogin %}

{% block content %}
  {# Display the user’s saved name: #}
  <h1>Hello, {{ currentUser.fullName }}</h1>

  {# Normalize the `user` variable, so we can use it in the form regardless of whether or not it was rendered following a submission attempt: #}
  {% set user = user ?? currentUser %}

  <form method="post">
    {{ csrfInput() }}
    {{ actionInput('users/save-user') }}
    {{ hiddenInput('userId', user.id) }}

    <label for="fullName">Full Name</label>

    {{ input('text', 'fullName', user.fullName, {
      id: 'fullName',
      aria: {
        invalid: user.hasErrors('fullName'),
        errormessage: user.hasErrors('fullName') ? 'fullName-errors' : null,
      },
    }) }}

    {% if user.hasErrors('fullName') %}
      <ul id="fullName-errors">
        {% for error in user.getErrors('fullName') %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    {# ...other fields and attributes... #}

    <button>Save</button>
  </form>
{% endblock %}
```
```twig _layouts/default.twig
<!DOCTYPE html>
<html lang="{{ currentSite.language }}">
  <head>
      <meta charset="UTF-8">
      <title>{{ siteName }}</title>
  </head>
  <body>
    {# Output flashes in a global space: #}
    {% set flashes = craft.app.session.getAllFlashes(true) %}

    {% if flashes | length %}
      {% for level, flash in flashes %}
        <p class="{{ level }}" role="alert">{{ flash }}</p>
      {% endfor %}
    {% endif %}

    {% block content null %}
  </body>
</html>
```
:::

::: tip
Note that we’re outputting errors from the `user` object (in `account.twig`) as well as any success or failure [flashes](#flashes) (in `_layouts/default.twig`).
:::

The same principles apply to anything else you want to make editable in the front-end, so long as the user has the correct permissions. Take a look at the [public registration forms](kb:front-end-user-accounts) for some examples of validation on forms available to guests—and to learn about some nice abstractions that will help reduce repetition in your form markup!

#### Flashes

Flashes are temporary messages Craft stores in your session, typically under keys corresponding to their severity, like `notice` or `error`. You can output flashes in your templates:

```twig
{# Retrieve + clear all flashes: #}
{% set flashes = craft.app.session.getAllFlashes(true) %}

{% if flashes | length %}
  {% for level, flash in flashes %}
    {# Use the level (most often `notice` or `error`) to customize styles: #}
    <p class="{{ level }}">{{ flash }}</p>
  {% endfor %}
{% endif %}
```

Most endpoints support customizing success and fail flashes:

```twig{4,5}
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('entries/save-entry') }}
  {{ successMessageInput('Your feedback has been logged!') }}
  {{ failMessageInput('Something went wrong when submitting your message.') }}

  {# ... #}

  <textarea name="fields[reviewBody]"></textarea>

  <button>Send</button>
</form>
```

## Responses

Action requests are largely consistent in their behavior—exceptions will be noted in each of the [available actions](../reference/controller-actions.md#available-actions)’ **Response** sections.

Let’s look at some typical success and failure states and how they differ.

### Success

Successful responses are mostly handled via the <craft5:craft\web\Controller::asModelSuccess()> or [asSuccess()](craft5:craft\web\Controller::asSuccess()) methods.

#### After a GET Request

Craft’s response to a GET request varies based on whether it included an `Accept: application/json` header—and the substance of the response will differ greatly from action to action.

#### After a POST Request

Successful POST requests will often culminate in a [flash](#flashes) being set (under the `notice` key) and a 300-level redirection.

Some routes make this redirection configurable (<config5:passwordSuccessPath> or <config5:activateAccountSuccessPath>, for instance)—but sending a hashed `redirect` param with your request will always take precedence.

::: tip
The [`redirectInput()`](../reference/twig/functions.md#redirectinput) function takes the guesswork out of rendering this input.
:::

```twig{5-6}
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('users/send-password-reset-email') }}

  {# Redirect to a page with further instructions: #}
  {{ redirectInput('help/account-recovery') }}

  {# The above is equivalent to: #}
  <input
    type="hidden"
    name="redirect"
    value="{{ 'help/account-recovery' | hash }}">

  {{ input('email', 'loginName', null, {
    required: true,
  }) }}

  <button>Reset Password</button>
</form>
```

The `redirect` param accepts an [object template](../system/object-templates.md), which is evaluated just before it’s issued, and can reference properties of the element or record you were working with:

```twig
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('entries/save-entry') }}

  {# Redirect the user to the public page: #}
  {{ redirectInput('community-posts/{uid}') }}

  {# ...entry options... #}

  {{ input('text', 'title') }}

  <button>Post + View</button>
</form>
```

::: tip
Inspecting the HTML output, you’ll see your template exactly as provided. Why wasn’t it rendered? The “template” will be securely submitted along with your POST request and be rendered _after_ the entry is saved—that’s why we’re able to use properties (like `{uid}`, in the example) whose values aren’t yet known.
:::

For JSON responses, redirection does’t make as much sense—so Craft will include the resolved `redirect` value for your client to navigate programmatically (say, via `window.location = resp.redirect`).

In addition to the `redirect` property, the response object will include a `message` key with the same text that would have been flashed (for a `text/html` response)—either a specific message from Craft, or one provided in the request via the [globally-supported `successMessage` param](../reference/controller-actions.md#globally-supported-params). Additional action-specific properties are also returned at the top level of the response object.

### Failure

Failed responses are mostly handled via the <craft5:craft\web\Controller::asModelFailure()> or [asFailure()](craft5:craft\web\Controller::asFailure()) methods.

<Todo notes="Simplify action documentation, below" />

#### During a GET Request

A GET request will typically only fail if an exception is thrown in the process of generating a response. The criteria for that failure depends on the action, but can also be circumstantial—like a lost database connection.

If the request included an `Accept: application/json` header, Craft will send a `message` key in the JSON response, or a complete stack trace when <config5:devMode> is on. Otherwise, Craft displays a standard [error view](../system/routing.md#error-templates).

#### During a POST Request

POST requests can fail for the same reasons a GET request might—but because they are often responsible for mutating data, you’ll also be contending with [validation](#models-and-validation) errors.

::: tip
We’ll use the term “model” here for technical reasons—but [elements](../system/elements.md) are models, too!
:::

In all but rare, unrecoverable cases, Craft sets an `error` [flash](#flashes) describing the issue, and carries on serving the page at the original path (either the page the request came from, or whatever was in the originating `<form action="...">` attribute). By virtue of being part of the same request that populated and validated a model, Craft is able to pass it all the way through to the rendered template—making it possible to repopulate inputs and display errors, contextually. See a complete example of how to handle this in the [models and validation](#models-and-validation) section.

For requests that include an `Accept: application/json` header, Craft will instead build a JSON object with an `errors` key set to a list of the model’s errors (indexed by attribute or field), a `message` key, an array representation of the model, and a `modelName` key with the location of the model data in the payload. The exact message will be specific to the failure mode, and can be overridden using the [globally-supported `failMessage` param](../reference/controller-actions.md#global-params).

```json{6}
{
  "errors": {
    "email": "...",
    /* ... */
  },
  "modelName": "user",
  "user": {
    "email": "@craftcms",
    /* ... */
  }
}
```

::: tip
The value of `modelName` in a JSON response is the same as the variable name Craft uses for the model when rendering a template response. We’ll call this out in each action, below!
:::

## Custom Fields

Actions that create or update elements (like [`entries/save-entry`](../reference/controller-actions.md#post-entriessave-entry) and [`users/save-address`](#post-userssave-address)) support setting [custom field](../system/fields.md) values. Only fields that are included in a request will be updated.

Fields should be submitted under a `fields` key, using their handle:

```twig{5}
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('entries/save-entry') }}

  {{ input('text', 'fields[myCustomFieldHandle]') }}

  <button>Save Entry</button>
</form>
```

In the event you need to re-key the custom field data in the request, you can send a `fieldsLocation` param:

```twig{4,7}
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('entries/save-entry') }}
  {{ hiddenInput('fieldsLocation', 'f')}}

  {# Don’t forget to update all your input names! #}
  {{ input('text', 'f[myCustomFieldHandle]') }}

  <button>Save Entry</button>
</form>
```

### Field + Data Types

Fields (and attributes) that use [scalar](https://www.php.net/manual/en/function.is-scalar.php) values like numbers, text, or booleans will work as expected with a single input.

Other types may require multiple inputs or specific naming conventions.

#### Date + Time

Entries’ native `postDate` and `expiryDate` properties can be handled in the same way [date/time fields](../reference/field-types/date-time.md#saving-date-fields) are; but instead of passing their values under a `fields` key, you’ll send them as top-level keys in a POST request:

::: code
```twig Unified
{{ input('datetime-local', 'postDate', entry.postDate|atom) }}
```
```twig Discrete Inputs
{{ input('date', 'postDate[date]', entry.postDate.format('Y-m-d')) }}
{{ input('time', 'postDate[time]', entry.postDate.format('G:i')) }}
```
:::

Both of these options will POST valid data that Craft can reconstruct into a PHP DateTime object.

::: tip
Some date properties (like `dateUpdated` and `dateCreated`) may be determined by Craft, and are not editable.
:::

#### Relations

Assets, categories, entries, and tags can be associated to a [relational](../system/relations.md) field by passing an array of IDs. For more information and examples, see the relevant field type documentation:

- [Assets fields](../reference/field-types/assets.md#saving-assets-fields)
- [Entries fields](../reference/field-types/entries.md#saving-entries-fields)
- [Categories fields](../reference/field-types/categories.md#saving-categories-fields)
- [Tags fields](../reference/field-types/tags.md#saving-tags-fields)
</file>

<file path="development/graphql.md">
---
keywords: headless
containsGeneratedContent: yes
---

# GraphQL API

Craft provides a [GraphQL](https://graphql.org) API you can use to work with your content in separate applications like single-page apps (SPAs) and static site generators.

<!-- more -->

## Getting Started

GraphQL’s API is self-documenting, so you can immediately start building and executing queries interactively via Craft’s included [GraphiQL IDE](#using-the-graphiql-ide). Querying from the control panel give you unfettered access to your content, whereas queries from the outside require [an endpoint and appropriate permissions](#setting-up-your-api-endpoint).

::: tip
You can also execute GraphQL queries from [Twig templates](templates.md) with the [`gql()` function](../reference/twig/functions.md#gql).
:::

### Setting Up Your API Endpoint

By default, none of your content is publicly accessible via GraphQL—you must explicitly authorize resources by defining a route and configuring one or more public or private [schemas](#define-your-schemas).

#### Create a GraphQL Route

The GraphQL endpoint is always available via its [action path](../system/routing.md), at `/index.php?action=graphql/api`. If you would prefer to access the API via a more concise path, create a [URL rule](../system/routing.md#advanced-routing-with-url-rules) in `config/routes.php` that maps to this `graphql/api` controller action—the following rule would make the GraphQL API available at `/api`:

```php
return [
    'api' => 'graphql/api',
    // ...
];
```

::: tip
Craft sets an `access-control-allow-origin: *` header by default on GraphQL responses; consider limiting that for security using the <config5:allowedGraphqlOrigins> setting.
:::

#### Define Your Schemas

With a GraphQL API endpoint defined, Craft determines what content should be available from it via **Schemas**. Access to schemas is in turn granted by [tokens](#generate-tokens).

Craft has two types of schemas:

1. A single _public_ schema that defines which content should be available to unauthenticated clients. _The public schema is disabled by default._
2. Any number of _private_ schemas that permit querying and mutating specific types of elements.

Administrators have access to a third “full” schema, for testing with the [GraphiQL IDE](#using-the-graphiql-ide). Manage your schemas in the control panel by navigating to <Journey path="GraphQL, Schemas" />.

::: warning
Schema customization is only possible with an admin account and <config5:allowAdminChanges> _on_.
:::

#### Generate Tokens

A _token_ is required to use any non-public schema. Tokens use the standard “bearer” `Authorization` HTTP header:

```http
Authorization: Bearer {token}
```

Invalid tokens will produce a 400-level HTTP exception; requests _without_ a token default to the public schema, if it is enabled. More [examples](#examples) of token usage appear below!

To create a token, visit <Journey path="GraphQL, Tokens" /> and click **New token**. Every token’s **Name** must be unique, but multiple tokens may be created for each schema. Craft automatically generates a random 32-character access token, which can be copied from the **Authorization Header** section. Regenerate and save a token to revoke access to existing clients.

Because tokens are similar to [user groups](../system/user-management.md#user-groups) in the way they grant access to system resources, only admins are allowed to create and modify them. Tokens can also be created via the CLI, with the [`graphql/create-token` command](../reference/cli.md#graphql-create-token). To find a schema’s UUID (required by this command), run `graphql/list-schemas`.

While [schemas](#define-your-schemas) are tracked in [project config](../system/project-config.md), tokens are only stored in the database and must be created in each environment.

::: danger
Carefully protect tokens for schemas that allow [mutations](#mutations)! These are effectively as dangerous as a user with the equivalent permissions.
:::

## Sending API Requests

### CURL

Assuming your project lives at `https://my-project.ddev.site` and your [route](#create-a-graphql-route) was configured like the example above, you can confirm the [public schema](#define-your-schemas) is working by sending a `{ping}` query to it via the command line:

```bash
curl -H "Content-Type: application/graphql" -d '{ping}' https://my-project.ddev.site/api
```

If you get a `pong` in your response, your GraphQL API is up and running!

```json
{"data":{"ping":"pong"}}
```

If you get an error, make sure your [public schema](#define-your-schemas) is enabled, and try again.

::: tip
The `ping` test is implicitly allowed by all _enabled_ schemas. It is not a guarantee that any particular content is actually available, but authorization is performed when a token is sent.
:::

### Using the GraphiQL IDE

The easiest way to start exploring your GraphQL API is with the built-in [GraphiQL](https://github.com/graphql/graphiql) IDE, which is available in the control panel from <Journey path="GraphQL, GraphiQL" />.

![The built-in GraphiQL IDE](../images/graphiql.png)

::: tip
The included GraphiQL IDE preselects a special “Full Schema” option for exploration. This schema is only available to logged-in administrators. Change the active schema from the dropdown menu in the upper-right corner.
:::

### Using Another IDE

Additional GraphQL IDEs are available as well:

- [Insomnia](https://insomnia.rest/)
- [GraphQL Playground](https://github.com/prisma/graphql-playground)
- [GraphQL Playground online](https://www.graphqlbin.com/v2/new)

::: tip
When you’re initially exploring the API, make sure <config5:devMode> is enabled so the IDE can be informed about the entire schema available to it.
:::

### Sending Requests Manually

The GraphQL API can be queried in three ways:

1. **A `GET` request** with the GraphQL query defined by a `query` parameter:
  ```bash
  curl \
    --data-urlencode "query={ping}" \
    http://my-project.ddev.site/api
  # or
  curl https://my-project.ddev.site/api?query=%7Bping%7D
  ```
2. **A `POST` request with an `application/json` content type** and the GraphQL query defined by a `query` key:
  ```bash
  curl \
    -H "Content-Type: application/json" \
    -d '{"query":"{ping}"}' \
    https://my-project.ddev.site/api
  ```
3. **A `POST` request with an `application/graphql` content type** and the GraphQL query defined by the raw request body:
  ```bash
  curl \
    -H "Content-Type: application/graphql" \
    -d '{ping}' \
    https://my-project.ddev.site/api
  ```

#### Specifying Variables

If you need to specify any [variables](https://graphql.org/learn/queries/#variables) along with your query, then you must send request as a `POST` request with an `application/json` content type, and include a `variables` key in the JSON body alongside your `query`.

```bash
curl \
  -H "Content-Type: application/json" \
  -d '{
        "query": "query($id:[Int]) { entries(id: $id) { id, title } }",
        "variables": { "id": [1, 2, 3] }
      }' \
  https://my-project.ddev.site/api
```

#### Querying a Private Schema

The **Public Schema** is used by default. To query against a different [schema](#define-your-schemas), pass a valid [token](#generate-tokens) under the `Authorization` header.

```bash
curl \
  -H "Authorization: Bearer xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/graphql" \
  -d '{entries{id}}' \
  https://my-project.ddev.site/api
```

::: warning
If you’re unable to query a private schema because of a “missing authorization header,” make sure Craft received it from the web server with a quick post to a test template:

```twig
{{ craft.app.getRequest().getHeaders().has('authorization')
  ? 'auth header present ✓'
  : 'auth header missing!' }}
```

Apache strips `Authorization` headers by default, which can be fixed by enabling [CGIPassAuth](https://httpd.apache.org/docs/2.4/en/mod/core.html#cgipassauth) or adding the following to your `.htaccess` file:

```
RewriteCond %{HTTP:Authorization} ^(.*)
RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]
```
:::

## Examples

### Basic Query

Here’s what a [query](#query-reference) for two news entries might look like, complete with a formatted `dateCreated` and custom-transformed `featureImage`:

::: code
```graphql GraphQL
{
  entries (section: "news", limit: 2, orderBy: "dateCreated DESC") {
    dateCreated @formatDateTime (format: "Y-m-d")
    title
    children {
      title
    }
    ... on article_Entry {
      shortDescription
      featuredImage {
        url @transform (width: 300)
      }
    }
  }
}
```
```json JSON Response
{
  "data": {
    "entries": [
      {
        "dateCreated": "2019-08-21",
        "title": "An important news item",
        "children": [],
        "shortDescription": "<p>This is how we roll these days.</p>",
        "featuredImage": [
          {
            "url": "/assets/site/_300xAUTO_crop_center-center_none/glasses.jpg"
          }
        ]
      },
      {
        "dateCreated": "2019-07-02",
        "title": "Dolorem ea eveniet alias",
        "children": [
          {
            "title": "Child entry"
          },
          {
            "title": "This is also a child entry"
          }
        ],
        "shortDescription": "Et omnis explicabo iusto eum nobis. Consequatur debitis architecto est exercitationem vitae velit repellendus. Aut consequatur maiores error ducimus ea et. Rem ipsa asperiores eius quas et omnis. Veniam quasi qui repellendus dignissimos et necessitatibus. Aut a illo tempora.",
        "featuredImage": []
      }
    ]
  }
}
```
:::

### Custom Fields

In addition to nave element properties, content stored in [custom fields](../system/fields.md) is accessible via the GraphQL API.

The keys you use to access that data often depends on how the fields are connected to each type of element via [field layouts](../system/fields.md#field-layouts). Craft defines interfaces for each of your element types’ variations (like entry types or category groups) and exposes fields using either their global or locally-overridden handle. Altogether, this means that you will often add custom fields within an inline fragment:

```graphql{5,10,13}
query StationsQuery {
  entries(section: "weatherBeacons") {
    title
    id
    ... on terrestrialStation_Entry {
      location {
        administrativeArea
      }
    }
    ... on atmosphericStation_Entry {
      altitude
    }
    ... on maritimeStation_Entry {
      douglasSeaScale
    }
  }
}
```

In this example, `title` and `id` are fields available on _all_ entries, whereas `location`, `altitude`, and `douglasSeaScale` are fields available only on specific entry type interfaces (`terrestrialStation_Entry`, `atmosphericStation_Entry`, and `maritimeStation_Entry`, respectively).

While specific interfaces are required for _selecting_ fields, they aren’t required when using custom fields as query arguments. Here, we’re using a `sentiment` field to narrow a query for “Review” entries:

```graphql
query PositiveReviews {
  entries(section: "reviews", sentiment: "awesome") {
    postDate@formatDateTime(format: "F j, Y")
    title
    body
  }
}
```

::: tip
Mouseover any token in the GraphiQL editor to view introspections, or open the **Documentation Explorer** to learn about the acceptable argument types for each [field type](../reference/field-types/README.md).
:::

#### Relationships

The GraphQL API exposes Craft’s powerful, field-driven [relations](../system/relations.md) system in a familiar way.

::: tip
The following examples include server-rendered Twig “equivalents,” which are necessarily bound to HTML output.
:::

- Select fields from related elements:

  ::: code
  ```graphql GraphQL
  query Posts {
    entries(section: "blog") {
      title
      url

      ... on post_Entry {
        # Assets:
        featureImage {
          url
          width
          height
        }


        # Categories:
        primaryCategory {
          title
          url
        }

        topics {
          title
          url
        }
      }
    }
  }
  ```
  ```twig Twig
  {% set posts = craft.entries()
    .section('blog')
    .all() %}

  {% for post in posts %}
    {{ post.primaryCategory.eagerly().one().title }}

    {% set image = post.featureImage.eagerly().one() %}

    {% if image %}
      {{ image.getImg() }}
    {% endif %}

    {{ post.title }}

    <ul>
      {% for category in post.topics.eagerly().all() %}
        <li>{{ category.getLink() }}</li>
      {% endfor %}
    </ul>
  {% endfor %}
  ```
  :::

  Selections can be arbitrarily deep, but they must be explicit—GraphQL does not provide a means of recursively querying data.

- Narrow results using a specific field:

  ::: code
  ```graphql GraphQL
  query TopicPosts {
    entries(section: "blog", primaryCategory: [1234]) {
      title
      url

      # ...
    }
  }
  ```
  ```twig Twig
  {% set topicPosts = craft.entries()
    .section('blog')
    .primaryCategory(category)
    .all() %}

  {% for post in topicPosts %}
    {# ... #}
  {% endfor %}
  ```
  :::

  You may need to pre-flight a query to translate an identifier (like a slug) into a valid category ID:

  ```graphql
  query CategoryLookup($slug: String) {
    category(slug: [$slug]) {
      id
    }
  }
  ```

- Scope selection of related elements:

  ::: code
  ```graphql{6} GraphQL
  query PostsWithBroadTopics {
    entries(section: "blog") {
      title
      url

      ... on post_Entry {
        topics(level: 1) {
          title
        }
      }
    }
  }
  ```
  ```twig{8} Twig
  {% set posts = craft.entries()
    .section('blog')
    .all() %}

  {% for post in posts %}
    {{ post.title }}

    Filed in {{ post.topics.level(1).eagerly().collect().join(', ') }}
  {% endfor %}
  ```
  :::


- Find elements using abstract relational criteria:

  ::: code
  ```graphql GraphQL
  query TopicPosts {
    entries(
      section: "blog"
      relatedToCategories: [
        {
          slug: ["travel", "winter-sports"]
          group: "topics"
          relatedViaField: "topics"
        }
      ]
    ) {
      title
      url

      # ...
    }
  }
  ```
  ```twig{1-4,8-11} Twig
  {% set categoryIds = craft.categories()
    .group('topics')
    .slug(['travel', 'winter-sports'])
    .ids() %}

  {% set relatedPosts = craft.entries()
    .section('blog')
    .relatedTo({
      targetElement: categoryIds,
      field: 'topics',
    })
    .all() %}
  ```
  :::

  The criteria for `relatedToCategories` (or any of the `relatedTo*` arguments) are the same as the corresponding element query types (like `category()` and `categories()`).

::: tip
By default, relational criteria are logically joined with “or.” To query for elements that match _all_ the relational criteria, prepend `"and"` to the list of IDs passed to the `relatedTo` query argument.
:::

Advanced relational conditions are possible using the `relatedViaField` (seen above) and `relatedViaSite` params. <Since ver="5.4.0" feature="Site- and field-specific relational criteria" />

### Search

Craft’s search index is also exposed via GraphQL via the `search` query argument:

```graphql
query SearchResults($terms: String) {
  entries(search: $terms, orderBy: "score") {
    title
    url
    searchScore
  }
}
```

### Mutation

Here’s a [mutation](#mutations), where we’re using the GraphQL API to save a new entry:

::: code
```graphql GraphQL
mutation saveEntry($title: String, $slug: String) {
  save_news_article_Entry(title: $title, slug: $slug) {
    title
    slug
    dateCreated @formatDateTime (format: "Y-m-d")
  }
}

# query variables:
{
  "title": "Craft 3.5 Supports GraphQL Mutations",
  "slug": "craft-graphql-mutations"
}
```
```json JSON Response
{
  "data": {
    "save_news_article_Entry": {
      "title": "Craft 3.5 Supports GraphQL Mutations",
      "slug": "craft-graphql-mutations",
      "dateCreated": "2020-04-18"
    }
  }
}
```
:::

## Caching

Query results are cached by default to speed up subsequent queries, but you can disable that caching with the <config5:enableGraphQlCaching> setting.

The entire GraphQL cache is purged for any schema changes. Like template caches, Craft selectively purges GraphQL query results when the underlying elements’ content changes. Keep in mind that multiple GraphQL queries can be sent and executed in the same request, but responses will be cached and invalidated as a whole.

While combining queries may reduce the number of round-trips to your server, it may significantly impact the number of requests that Craft can serve from the cache. Consider splitting queries into chunks

## Types

Use the **Explorer** pane in the [GraphiQL IDE](#using-the-graphiql-ide) to browse queries and mutations, and the **Documentation** pane to get information about specific types. The specific types available for introspection and querying are determined by the current [schema](#define-your-schemas).

### Arguments

[Arguments](https://graphql.org/learn/queries/#arguments) typically correlate to element query params and are used to narrow the results of a query.

```graphql{2}
query BlogPosts {
  newsEntries(orderBy: "postDate DESC") {
    title
    summary
    postDate@formatDateTime(format: "F j, Y")
  }
}
```

### Inputs

[Input types](https://graphql.org/graphql-js/mutations-and-input-types/) help determine the allowed (and required) params for queries. Most inputs consist of scalar types (i.e. `String` or `Int`), but some arguments accept compound “criteria” represented by special Craft-specific types:

- **Query Argument** — A generic input type that describes a variety of common element query parameters. Frequently, this is used in conjunction with values that pass through <craft5:craft\helpers\Db::parseParam()>, which might accept a single scalar value, an array of scalar values (for an `OR`-style query), or an array with `not` in the first position.
- **Relational Criteria** — See the [relations](#relations) section for a complete list of accepted parameters.

Some input types are only used for mutations:

- **Addresses** — Defines fields for nested [address](../reference/element-types/addresses.md) elements, which have a very particular schema.
- **Matrix** — Defines fields for [nested entries](../reference/element-types/entries.md#nested-entries) within [Matrix](../reference/field-types/matrix.md) fields.
- **File** — See the [uploading files](#saving-files-via-mutations) for more information about the `FileInput` input type. This is only used when creating new assets directly (via the `_file` argument), or when creating new assets via an [assets field](../reference/field-types/assets.md).

### Elements

Each element type provides dedicated query and mutation interfaces that expose unique properties based on the system’s configuration. An additional generic query type is provided for each element type that allows you to build queries from scratch, similar to the `craft.entries()` or `craft.assets()` APIs available in Twig:

::: code
```graphql{2} Entries
query FeaturedResources {
  entries(section: "documents", type: ["report", "dataset"], featured: true) {
    title
    url
  }
}
```
```graphql{2} Assets
query Images {
  assets(volume: "uploads", kind: "image") {
    filename
    size
  }
}
```
:::

Specific query types are available for some subsets of elements, like [sections](../reference/element-types/entries.md#sections). The _News_ section above would get a dedicated `newsEntries` query.

[Mutations](#mutations) follow a similar pattern—to create or update an entry in our _News_ section, you would use the dedicated `save_news_post_Entry` mutation:

```graphql{2}
mutation CreateContact {
  save_contacts_person_Entry(
    title: "Oli",
    position: "Support Engineer",
    timezone: "GMT"
  ) {
    id
  }
}
```

## Query Reference

::: tip
The actual API features will depend on what your schema allows.
:::

<!-- BEGIN QUERIES -->

### The `addresses` query
This query is used to query for addresses.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `drafts`| `Boolean` | Whether draft elements should be returned.
| `draftOf`| `QueryArgument` | Narrows the query results to only drafts of a given element.  Set to `false` to fetch unpublished drafts.
| `draftId`| `Int` | The ID of the draft to return (from the `drafts` table)
| `draftCreator`| `Int` | The drafts’ creator ID
| `provisionalDrafts`| `Boolean` | Whether provisional drafts should be returned.
| `withProvisionalDrafts`| `Boolean` | Whether canonical elements should be replaced with provisional drafts if those exist.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `ownerId`| `[QueryArgument]` | Narrows the query results based on the addresses’ owners.
| `countryCode`| `[String]` | Narrows the query results based on the addresses’ country codes.
| `administrativeArea`| `[String]` | Narrows the query results based on the addresses’ administrative areas.

### The `addressCount` query
This query is used to return the number of addresses.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `drafts`| `Boolean` | Whether draft elements should be returned.
| `draftOf`| `QueryArgument` | Narrows the query results to only drafts of a given element.  Set to `false` to fetch unpublished drafts.
| `draftId`| `Int` | The ID of the draft to return (from the `drafts` table)
| `draftCreator`| `Int` | The drafts’ creator ID
| `provisionalDrafts`| `Boolean` | Whether provisional drafts should be returned.
| `withProvisionalDrafts`| `Boolean` | Whether canonical elements should be replaced with provisional drafts if those exist.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `ownerId`| `[QueryArgument]` | Narrows the query results based on the addresses’ owners.
| `countryCode`| `[String]` | Narrows the query results based on the addresses’ country codes.
| `administrativeArea`| `[String]` | Narrows the query results based on the addresses’ administrative areas.

### The `address` query
This query is used to query for a single address.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `drafts`| `Boolean` | Whether draft elements should be returned.
| `draftOf`| `QueryArgument` | Narrows the query results to only drafts of a given element.  Set to `false` to fetch unpublished drafts.
| `draftId`| `Int` | The ID of the draft to return (from the `drafts` table)
| `draftCreator`| `Int` | The drafts’ creator ID
| `provisionalDrafts`| `Boolean` | Whether provisional drafts should be returned.
| `withProvisionalDrafts`| `Boolean` | Whether canonical elements should be replaced with provisional drafts if those exist.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `ownerId`| `[QueryArgument]` | Narrows the query results based on the addresses’ owners.
| `countryCode`| `[String]` | Narrows the query results based on the addresses’ country codes.
| `administrativeArea`| `[String]` | Narrows the query results based on the addresses’ administrative areas.

### The `assets` query
This query is used to query for assets.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `volumeId`| `[QueryArgument]` | Narrows the query results based on the volumes the assets belong to, per the volumes’ IDs.
| `volume`| `[String]` | Narrows the query results based on the volumes the assets belong to, per the volumes’ handles.
| `folderId`| `[QueryArgument]` | Narrows the query results based on the folders the assets belong to, per the folders’ IDs.
| `filename`| `[String]` | Narrows the query results based on the assets’ filenames.
| `kind`| `[String]` | Narrows the query results based on the assets’ file kinds.
| `height`| `[String]` | Narrows the query results based on the assets’ image heights.
| `width`| `[String]` | Narrows the query results based on the assets’ image widths.
| `size`| `[String]` | Narrows the query results based on the assets’ file sizes (in bytes).
| `dateModified`| `String` | Narrows the query results based on the assets’ files’ last-modified dates.
| `hasAlt`| `Boolean` | Narrows the query results based on whether the assets have alternative text.
| `includeSubfolders`| `Boolean` | Broadens the query results to include assets from any of the subfolders of the folder specified by `folderId`.
| `withTransforms`| `[String]` | A list of transform handles to preload.
| `uploader`| `QueryArgument` | Narrows the query results based on the user the assets were uploaded by, per the user’s ID.

### The `assetCount` query
This query is used to return the number of assets.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `volumeId`| `[QueryArgument]` | Narrows the query results based on the volumes the assets belong to, per the volumes’ IDs.
| `volume`| `[String]` | Narrows the query results based on the volumes the assets belong to, per the volumes’ handles.
| `folderId`| `[QueryArgument]` | Narrows the query results based on the folders the assets belong to, per the folders’ IDs.
| `filename`| `[String]` | Narrows the query results based on the assets’ filenames.
| `kind`| `[String]` | Narrows the query results based on the assets’ file kinds.
| `height`| `[String]` | Narrows the query results based on the assets’ image heights.
| `width`| `[String]` | Narrows the query results based on the assets’ image widths.
| `size`| `[String]` | Narrows the query results based on the assets’ file sizes (in bytes).
| `dateModified`| `String` | Narrows the query results based on the assets’ files’ last-modified dates.
| `hasAlt`| `Boolean` | Narrows the query results based on whether the assets have alternative text.
| `includeSubfolders`| `Boolean` | Broadens the query results to include assets from any of the subfolders of the folder specified by `folderId`.
| `withTransforms`| `[String]` | A list of transform handles to preload.
| `uploader`| `QueryArgument` | Narrows the query results based on the user the assets were uploaded by, per the user’s ID.

### The `asset` query
This query is used to query for a single asset.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `volumeId`| `[QueryArgument]` | Narrows the query results based on the volumes the assets belong to, per the volumes’ IDs.
| `volume`| `[String]` | Narrows the query results based on the volumes the assets belong to, per the volumes’ handles.
| `folderId`| `[QueryArgument]` | Narrows the query results based on the folders the assets belong to, per the folders’ IDs.
| `filename`| `[String]` | Narrows the query results based on the assets’ filenames.
| `kind`| `[String]` | Narrows the query results based on the assets’ file kinds.
| `height`| `[String]` | Narrows the query results based on the assets’ image heights.
| `width`| `[String]` | Narrows the query results based on the assets’ image widths.
| `size`| `[String]` | Narrows the query results based on the assets’ file sizes (in bytes).
| `dateModified`| `String` | Narrows the query results based on the assets’ files’ last-modified dates.
| `hasAlt`| `Boolean` | Narrows the query results based on whether the assets have alternative text.
| `includeSubfolders`| `Boolean` | Broadens the query results to include assets from any of the subfolders of the folder specified by `folderId`.
| `withTransforms`| `[String]` | A list of transform handles to preload.
| `uploader`| `QueryArgument` | Narrows the query results based on the user the assets were uploaded by, per the user’s ID.

### The `entries` query
This query is used to query for entries.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `drafts`| `Boolean` | Whether draft elements should be returned.
| `draftOf`| `QueryArgument` | Narrows the query results to only drafts of a given element.  Set to `false` to fetch unpublished drafts.
| `draftId`| `Int` | The ID of the draft to return (from the `drafts` table)
| `draftCreator`| `Int` | The drafts’ creator ID
| `provisionalDrafts`| `Boolean` | Whether provisional drafts should be returned.
| `withProvisionalDrafts`| `Boolean` | Whether canonical elements should be replaced with provisional drafts if those exist.
| `revisions`| `Boolean` | Whether revision elements should be returned.
| `revisionOf`| `QueryArgument` | The source element ID that revisions should be returned for
| `revisionId`| `Int` | The ID of the revision to return (from the `revisions` table)
| `revisionCreator`| `Int` | The revisions’ creator ID
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `withStructure`| `Boolean` | Explicitly determines whether the query should join in the structure data.
| `structureId`| `Int` | Determines which structure data should be joined into the query.
| `level`| `Int` | Narrows the query results based on the elements’ level within the structure.
| `hasDescendants`| `Boolean` | Narrows the query results based on whether the elements have any descendants in their structure.
| `ancestorOf`| `Int` | Narrows the query results to only elements that are ancestors of another element in its structure, provided by its ID.
| `ancestorDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `ancestorOf`.
| `descendantOf`| `Int` | Narrows the query results to only elements that are descendants of another element in its structure provided by its ID.
| `descendantDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `descendantOf`.
| `leaves`| `Boolean` | Narrows the query results based on whether the elements are “leaves” in their structure (element with no descendants).
| `nextSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately after another element in its structure, provided by its ID.
| `prevSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately before another element in its structure, provided by its ID.
| `positionedAfter`| `Int` | Narrows the query results to only entries that are positioned after another element in its structure, provided by its ID.
| `positionedBefore`| `Int` | Narrows the query results to only entries that are positioned before another element in its structure, provided by its ID.
| `editable`| `Boolean` | Whether to only return entries that the user has permission to edit.
| `section`| `[String]` | Narrows the query results based on the section handles the entries belong to.
| `sectionId`| `[QueryArgument]` | Narrows the query results based on the sections the entries belong to, per the sections’ IDs.
| `field`| `[String]` | Narrows the query results based on the field the entries are contained by.
| `fieldId`| `[QueryArgument]` | Narrows the query results based on the field the entries are contained by, per the fields’ IDs.
| `primaryOwnerId`| `[QueryArgument]` | Narrows the query results based on the primary owner element of the entries, per the owners’ IDs.
| `ownerId`| `[QueryArgument]` | Narrows the query results based on the owner element of the entries, per the owners’ IDs.
| `type`| `[String]` | Narrows the query results based on the entries’ entry type handles.
| `typeId`| `[QueryArgument]` | Narrows the query results based on the entries’ entry types, per the types’ IDs.
| `authorId`| `[QueryArgument]` | Narrows the query results based on the entries’ authors.
| `authorGroup`| `[String]` | Narrows the query results based on the user group the entries’ authors belong to.
| `authorGroupId`| `[QueryArgument]` | Narrows the query results based on the user group the entries’ authors belong to, per the groups’ IDs.
| `postDate`| `[String]` | Narrows the query results based on the entries’ post dates.
| `before`| `String` | Narrows the query results to only entries that were posted before a certain date.
| `after`| `String` | Narrows the query results to only entries that were posted on or after a certain date.
| `expiryDate`| `[String]` | Narrows the query results based on the entries’ expiry dates.

### The `entryCount` query
This query is used to return the number of entries.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `drafts`| `Boolean` | Whether draft elements should be returned.
| `draftOf`| `QueryArgument` | Narrows the query results to only drafts of a given element.  Set to `false` to fetch unpublished drafts.
| `draftId`| `Int` | The ID of the draft to return (from the `drafts` table)
| `draftCreator`| `Int` | The drafts’ creator ID
| `provisionalDrafts`| `Boolean` | Whether provisional drafts should be returned.
| `withProvisionalDrafts`| `Boolean` | Whether canonical elements should be replaced with provisional drafts if those exist.
| `revisions`| `Boolean` | Whether revision elements should be returned.
| `revisionOf`| `QueryArgument` | The source element ID that revisions should be returned for
| `revisionId`| `Int` | The ID of the revision to return (from the `revisions` table)
| `revisionCreator`| `Int` | The revisions’ creator ID
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `withStructure`| `Boolean` | Explicitly determines whether the query should join in the structure data.
| `structureId`| `Int` | Determines which structure data should be joined into the query.
| `level`| `Int` | Narrows the query results based on the elements’ level within the structure.
| `hasDescendants`| `Boolean` | Narrows the query results based on whether the elements have any descendants in their structure.
| `ancestorOf`| `Int` | Narrows the query results to only elements that are ancestors of another element in its structure, provided by its ID.
| `ancestorDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `ancestorOf`.
| `descendantOf`| `Int` | Narrows the query results to only elements that are descendants of another element in its structure provided by its ID.
| `descendantDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `descendantOf`.
| `leaves`| `Boolean` | Narrows the query results based on whether the elements are “leaves” in their structure (element with no descendants).
| `nextSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately after another element in its structure, provided by its ID.
| `prevSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately before another element in its structure, provided by its ID.
| `positionedAfter`| `Int` | Narrows the query results to only entries that are positioned after another element in its structure, provided by its ID.
| `positionedBefore`| `Int` | Narrows the query results to only entries that are positioned before another element in its structure, provided by its ID.
| `editable`| `Boolean` | Whether to only return entries that the user has permission to edit.
| `section`| `[String]` | Narrows the query results based on the section handles the entries belong to.
| `sectionId`| `[QueryArgument]` | Narrows the query results based on the sections the entries belong to, per the sections’ IDs.
| `field`| `[String]` | Narrows the query results based on the field the entries are contained by.
| `fieldId`| `[QueryArgument]` | Narrows the query results based on the field the entries are contained by, per the fields’ IDs.
| `primaryOwnerId`| `[QueryArgument]` | Narrows the query results based on the primary owner element of the entries, per the owners’ IDs.
| `ownerId`| `[QueryArgument]` | Narrows the query results based on the owner element of the entries, per the owners’ IDs.
| `type`| `[String]` | Narrows the query results based on the entries’ entry type handles.
| `typeId`| `[QueryArgument]` | Narrows the query results based on the entries’ entry types, per the types’ IDs.
| `authorId`| `[QueryArgument]` | Narrows the query results based on the entries’ authors.
| `authorGroup`| `[String]` | Narrows the query results based on the user group the entries’ authors belong to.
| `authorGroupId`| `[QueryArgument]` | Narrows the query results based on the user group the entries’ authors belong to, per the groups’ IDs.
| `postDate`| `[String]` | Narrows the query results based on the entries’ post dates.
| `before`| `String` | Narrows the query results to only entries that were posted before a certain date.
| `after`| `String` | Narrows the query results to only entries that were posted on or after a certain date.
| `expiryDate`| `[String]` | Narrows the query results based on the entries’ expiry dates.

### The `entry` query
This query is used to query for a single entry.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `drafts`| `Boolean` | Whether draft elements should be returned.
| `draftOf`| `QueryArgument` | Narrows the query results to only drafts of a given element.  Set to `false` to fetch unpublished drafts.
| `draftId`| `Int` | The ID of the draft to return (from the `drafts` table)
| `draftCreator`| `Int` | The drafts’ creator ID
| `provisionalDrafts`| `Boolean` | Whether provisional drafts should be returned.
| `withProvisionalDrafts`| `Boolean` | Whether canonical elements should be replaced with provisional drafts if those exist.
| `revisions`| `Boolean` | Whether revision elements should be returned.
| `revisionOf`| `QueryArgument` | The source element ID that revisions should be returned for
| `revisionId`| `Int` | The ID of the revision to return (from the `revisions` table)
| `revisionCreator`| `Int` | The revisions’ creator ID
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `withStructure`| `Boolean` | Explicitly determines whether the query should join in the structure data.
| `structureId`| `Int` | Determines which structure data should be joined into the query.
| `level`| `Int` | Narrows the query results based on the elements’ level within the structure.
| `hasDescendants`| `Boolean` | Narrows the query results based on whether the elements have any descendants in their structure.
| `ancestorOf`| `Int` | Narrows the query results to only elements that are ancestors of another element in its structure, provided by its ID.
| `ancestorDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `ancestorOf`.
| `descendantOf`| `Int` | Narrows the query results to only elements that are descendants of another element in its structure provided by its ID.
| `descendantDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `descendantOf`.
| `leaves`| `Boolean` | Narrows the query results based on whether the elements are “leaves” in their structure (element with no descendants).
| `nextSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately after another element in its structure, provided by its ID.
| `prevSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately before another element in its structure, provided by its ID.
| `positionedAfter`| `Int` | Narrows the query results to only entries that are positioned after another element in its structure, provided by its ID.
| `positionedBefore`| `Int` | Narrows the query results to only entries that are positioned before another element in its structure, provided by its ID.
| `editable`| `Boolean` | Whether to only return entries that the user has permission to edit.
| `section`| `[String]` | Narrows the query results based on the section handles the entries belong to.
| `sectionId`| `[QueryArgument]` | Narrows the query results based on the sections the entries belong to, per the sections’ IDs.
| `field`| `[String]` | Narrows the query results based on the field the entries are contained by.
| `fieldId`| `[QueryArgument]` | Narrows the query results based on the field the entries are contained by, per the fields’ IDs.
| `primaryOwnerId`| `[QueryArgument]` | Narrows the query results based on the primary owner element of the entries, per the owners’ IDs.
| `ownerId`| `[QueryArgument]` | Narrows the query results based on the owner element of the entries, per the owners’ IDs.
| `type`| `[String]` | Narrows the query results based on the entries’ entry type handles.
| `typeId`| `[QueryArgument]` | Narrows the query results based on the entries’ entry types, per the types’ IDs.
| `authorId`| `[QueryArgument]` | Narrows the query results based on the entries’ authors.
| `authorGroup`| `[String]` | Narrows the query results based on the user group the entries’ authors belong to.
| `authorGroupId`| `[QueryArgument]` | Narrows the query results based on the user group the entries’ authors belong to, per the groups’ IDs.
| `postDate`| `[String]` | Narrows the query results based on the entries’ post dates.
| `before`| `String` | Narrows the query results to only entries that were posted before a certain date.
| `after`| `String` | Narrows the query results to only entries that were posted on or after a certain date.
| `expiryDate`| `[String]` | Narrows the query results based on the entries’ expiry dates.

### The `globalSets` query
This query is used to query for global sets.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `handle`| `[String]` | Narrows the query results based on the global sets’ handles.

### The `globalSet` query
This query is used to query for a single global set.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `handle`| `[String]` | Narrows the query results based on the global sets’ handles.

### The `users` query
This query is used to query for users.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `email`| `[String]` | Narrows the query results based on the users’ email addresses.
| `username`| `[String]` | Narrows the query results based on the users’ usernames.
| `fullName`| `[String]` | Narrows the query results based on the users’ full names.
| `firstName`| `[String]` | Narrows the query results based on the users’ first names.
| `lastName`| `[String]` | Narrows the query results based on the users’ last names.
| `hasPhoto`| `Boolean` | Narrows the query results to only users that have (or don’t have) a user photo.
| `assetUploaders`| `Boolean` | Narrows the query results based on whether the users have uploaded any assets.
| `authors`| `Boolean` | Narrows the query results based on whether the users are listed as the author of any entries.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the user group the users belong to, per the groups’ IDs.
| `group`| `[QueryArgument]` | Narrows the query results based on the user group the users belong to.
| `affiliatedSite`| `[String]` | Determines which site(s) the users should be affiliated with.
| `affiliatedSiteId`| `[QueryArgument]` | Determines which site(s) the users should be affiliated with.

### The `userCount` query
This query is used to return the number of users.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `email`| `[String]` | Narrows the query results based on the users’ email addresses.
| `username`| `[String]` | Narrows the query results based on the users’ usernames.
| `fullName`| `[String]` | Narrows the query results based on the users’ full names.
| `firstName`| `[String]` | Narrows the query results based on the users’ first names.
| `lastName`| `[String]` | Narrows the query results based on the users’ last names.
| `hasPhoto`| `Boolean` | Narrows the query results to only users that have (or don’t have) a user photo.
| `assetUploaders`| `Boolean` | Narrows the query results based on whether the users have uploaded any assets.
| `authors`| `Boolean` | Narrows the query results based on whether the users are listed as the author of any entries.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the user group the users belong to, per the groups’ IDs.
| `group`| `[QueryArgument]` | Narrows the query results based on the user group the users belong to.
| `affiliatedSite`| `[String]` | Determines which site(s) the users should be affiliated with.
| `affiliatedSiteId`| `[QueryArgument]` | Determines which site(s) the users should be affiliated with.

### The `user` query
This query is used to query for a single user.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `email`| `[String]` | Narrows the query results based on the users’ email addresses.
| `username`| `[String]` | Narrows the query results based on the users’ usernames.
| `fullName`| `[String]` | Narrows the query results based on the users’ full names.
| `firstName`| `[String]` | Narrows the query results based on the users’ first names.
| `lastName`| `[String]` | Narrows the query results based on the users’ last names.
| `hasPhoto`| `Boolean` | Narrows the query results to only users that have (or don’t have) a user photo.
| `assetUploaders`| `Boolean` | Narrows the query results based on whether the users have uploaded any assets.
| `authors`| `Boolean` | Narrows the query results based on whether the users are listed as the author of any entries.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the user group the users belong to, per the groups’ IDs.
| `group`| `[QueryArgument]` | Narrows the query results based on the user group the users belong to.
| `affiliatedSite`| `[String]` | Determines which site(s) the users should be affiliated with.
| `affiliatedSiteId`| `[QueryArgument]` | Determines which site(s) the users should be affiliated with.

### The `tags` query
This query is used to query for tags.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `group`| `[String]` | Narrows the query results based on the tag groups the tags belong to per the group’s handles.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the tag groups the tags belong to, per the groups’ IDs.

### The `tagCount` query
This query is used to return the number of tags.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `group`| `[String]` | Narrows the query results based on the tag groups the tags belong to per the group’s handles.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the tag groups the tags belong to, per the groups’ IDs.

### The `tag` query
This query is used to query for a single tag.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `group`| `[String]` | Narrows the query results based on the tag groups the tags belong to per the group’s handles.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the tag groups the tags belong to, per the groups’ IDs.

### The `categories` query
This query is used to query for categories.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `withStructure`| `Boolean` | Explicitly determines whether the query should join in the structure data.
| `structureId`| `Int` | Determines which structure data should be joined into the query.
| `level`| `Int` | Narrows the query results based on the elements’ level within the structure.
| `hasDescendants`| `Boolean` | Narrows the query results based on whether the elements have any descendants in their structure.
| `ancestorOf`| `Int` | Narrows the query results to only elements that are ancestors of another element in its structure, provided by its ID.
| `ancestorDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `ancestorOf`.
| `descendantOf`| `Int` | Narrows the query results to only elements that are descendants of another element in its structure provided by its ID.
| `descendantDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `descendantOf`.
| `leaves`| `Boolean` | Narrows the query results based on whether the elements are “leaves” in their structure (element with no descendants).
| `nextSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately after another element in its structure, provided by its ID.
| `prevSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately before another element in its structure, provided by its ID.
| `positionedAfter`| `Int` | Narrows the query results to only entries that are positioned after another element in its structure, provided by its ID.
| `positionedBefore`| `Int` | Narrows the query results to only entries that are positioned before another element in its structure, provided by its ID.
| `editable`| `Boolean` | Whether to only return categories that the user has permission to edit.
| `group`| `[String]` | Narrows the query results based on the category groups the categories belong to per the group’s handles.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the category groups the categories belong to, per the groups’ IDs.

### The `categoryCount` query
This query is used to return the number of categories.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `withStructure`| `Boolean` | Explicitly determines whether the query should join in the structure data.
| `structureId`| `Int` | Determines which structure data should be joined into the query.
| `level`| `Int` | Narrows the query results based on the elements’ level within the structure.
| `hasDescendants`| `Boolean` | Narrows the query results based on whether the elements have any descendants in their structure.
| `ancestorOf`| `Int` | Narrows the query results to only elements that are ancestors of another element in its structure, provided by its ID.
| `ancestorDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `ancestorOf`.
| `descendantOf`| `Int` | Narrows the query results to only elements that are descendants of another element in its structure provided by its ID.
| `descendantDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `descendantOf`.
| `leaves`| `Boolean` | Narrows the query results based on whether the elements are “leaves” in their structure (element with no descendants).
| `nextSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately after another element in its structure, provided by its ID.
| `prevSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately before another element in its structure, provided by its ID.
| `positionedAfter`| `Int` | Narrows the query results to only entries that are positioned after another element in its structure, provided by its ID.
| `positionedBefore`| `Int` | Narrows the query results to only entries that are positioned before another element in its structure, provided by its ID.
| `editable`| `Boolean` | Whether to only return categories that the user has permission to edit.
| `group`| `[String]` | Narrows the query results based on the category groups the categories belong to per the group’s handles.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the category groups the categories belong to, per the groups’ IDs.

### The `category` query
This query is used to query for a single category.
| Argument | Type | Description
| - | - | -
| `id`| `[QueryArgument]` | Narrows the query results based on the elements’ IDs.
| `uid`| `[String]` | Narrows the query results based on the elements’ UIDs.
| `status`| `[String]` | Narrows the query results based on the elements’ statuses.
| `archived`| `Boolean` | Narrows the query results to only elements that have been archived.
| `trashed`| `Boolean` | Narrows the query results to only elements that have been soft-deleted.
| `site`| `[String]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `siteId`| `[QueryArgument]` | Determines which site(s) the elements should be queried in. Defaults to the current (requested) site.
| `unique`| `Boolean` | Determines whether only elements with unique IDs should be returned by the query.
| `preferSites`| `[QueryArgument]` | Determines which site should be selected when querying multi-site elements.
| `title`| `[String]` | Narrows the query results based on the elements’ titles.
| `slug`| `[String]` | Narrows the query results based on the elements’ slugs.
| `uri`| `[String]` | Narrows the query results based on the elements’ URIs.
| `search`| `String` | Narrows the query results to only elements that match a search query.
| `searchTermOptions`| `SearchTermOptions` | Defines the default options that should be applied terms within the `search` argument.
| `relatedTo`| `[QueryArgument]` | Narrows the query results to elements that relate to the provided element IDs. This argument is ignored, if `relatedToAll` is also used.
| `notRelatedTo`| `[QueryArgument]` | Narrows the query results to elements that do not relate to the provided element IDs.
| `relatedToAssets`| `[AssetRelationCriteriaInput]` | Narrows the query results to elements that relate to an asset list defined with this argument.
| `relatedToEntries`| `[EntryRelationCriteriaInput]` | Narrows the query results to elements that relate to an entry list defined with this argument.
| `relatedToUsers`| `[UserRelationCriteriaInput]` | Narrows the query results to elements that relate to a use list defined with this argument.
| `relatedToCategories`| `[CategoryRelationCriteriaInput]` | Narrows the query results to elements that relate to a category list defined with this argument.
| `relatedToTags`| `[TagRelationCriteriaInput]` | Narrows the query results to elements that relate to a tag list defined with this argument.
| `relatedToAll`| `[QueryArgument]` | Narrows the query results to elements that relate to *all* of the provided element IDs. Using this argument will cause `relatedTo` argument to be ignored. **This argument is deprecated.** `relatedTo: ["and", ...ids]` should be used instead.
| `ref`| `[String]` | Narrows the query results based on a reference string.
| `fixedOrder`| `Boolean` | Causes the query results to be returned in the order specified by the `id` argument.
| `inReverse`| `Boolean` | Causes the query results to be returned in reverse order.
| `dateCreated`| `[String]` | Narrows the query results based on the elements’ creation dates.
| `dateUpdated`| `[String]` | Narrows the query results based on the elements’ last-updated dates.
| `offset`| `Int` | Sets the offset for paginated results.
| `language`| `[String]` | Determines which site(s) the elements should be queried in, based on their language.
| `limit`| `Int` | Sets the limit for paginated results.
| `orderBy`| `String` | Sets the field the returned elements should be ordered by.
| `siteSettingsId`| `[QueryArgument]` | Narrows the query results based on the unique identifier for an element-site relation.
| `withStructure`| `Boolean` | Explicitly determines whether the query should join in the structure data.
| `structureId`| `Int` | Determines which structure data should be joined into the query.
| `level`| `Int` | Narrows the query results based on the elements’ level within the structure.
| `hasDescendants`| `Boolean` | Narrows the query results based on whether the elements have any descendants in their structure.
| `ancestorOf`| `Int` | Narrows the query results to only elements that are ancestors of another element in its structure, provided by its ID.
| `ancestorDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `ancestorOf`.
| `descendantOf`| `Int` | Narrows the query results to only elements that are descendants of another element in its structure provided by its ID.
| `descendantDist`| `Int` | Narrows the query results to only elements that are up to a certain distance away from the element in its structure specified by `descendantOf`.
| `leaves`| `Boolean` | Narrows the query results based on whether the elements are “leaves” in their structure (element with no descendants).
| `nextSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately after another element in its structure, provided by its ID.
| `prevSiblingOf`| `Int` | Narrows the query results to only the entry that comes immediately before another element in its structure, provided by its ID.
| `positionedAfter`| `Int` | Narrows the query results to only entries that are positioned after another element in its structure, provided by its ID.
| `positionedBefore`| `Int` | Narrows the query results to only entries that are positioned before another element in its structure, provided by its ID.
| `editable`| `Boolean` | Whether to only return categories that the user has permission to edit.
| `group`| `[String]` | Narrows the query results based on the category groups the categories belong to per the group’s handles.
| `groupId`| `[QueryArgument]` | Narrows the query results based on the category groups the categories belong to, per the groups’ IDs.

<!-- END QUERIES -->

## List of available directives
Directives are not regulated by permissions and they affect how the returned data is displayed.

<!-- BEGIN DIRECTIVES -->

### The `formatDateTime` directive
Formats a date in the desired format. Can be applied to all fields, only changes output of DateTime fields.
| Argument | Type | Description
| - | - | -
| `format`| `String` | The format to use. Can be `short`, `medium`, `long`, `full`, an [ICU date format](http://userguide.icu-project.org/formatparse/datetime), or a [PHP date format](https://www.php.net/manual/en/function.date.php). Defaults to the [Atom date time format](https://www.php.net/manual/en/class.datetimeinterface.php#datetime.constants.atom]).
| `timezone`| `String` | The full name of the timezone (e.g., America/New_York). Defaults to UTC if no timezone set on the field.
| `locale`| `String` | The locale to use when formatting the date. (E.g., en-US)


### The `markdown` directive
Parses the passed field value as Markdown.
| Argument | Type | Description
| - | - | -
| `flavor`| `String` | The “flavor” of Markdown the input should be interpreted with. Accepts the same arguments as yii\helpers\Markdown::process().
| `inlineOnly`| `Boolean` | Whether to only parse inline elements, omitting any `<p>` tags.


### The `money` directive
Formats a money object to the desired format. It can be applied to any fields, but only changes a Money field.
| Argument | Type | Description
| - | - | -
| `format`| `String` | This specifies the format to output. This can be `amount`, `decimal`, `number`, or `string`. It defaults to the `string`.
| `locale`| `String` | The locale to use when formatting the money value. (e.g. `en_US`). This argument is only valid with `number` and `string` formats.


### The `transform` directive
Returns a URL for an [asset transform](https://craftcms.com/docs/5.x/development/image-transforms.html). Accepts the same arguments you would use for a transform in Craft.
| Argument | Type | Description
| - | - | -
| `handle`| `String` | The handle of the named transform to use.
| `transform`| `String` | The handle of the named transform to use.
| `width`| `Int` | Width for the generated transform
| `height`| `Int` | Height for the generated transform
| `mode`| `String` | The mode to use for the generated transform.
| `position`| `String` | The position to use when cropping, if no focal point specified.
| `interlace`| `String` | The interlace mode to use for the transform
| `quality`| `Int` | The quality of the transform
| `format`| `String` | The format to use for the transform
| `immediately`| `Boolean` | [_Deprecated_] This argument is deprecated and has no effect.


### The `stripTags` directive
Strips HTML tags from the field value.
| Argument | Type | Description
| - | - | -
| `allowed`| `[String]` | List of allowed tag names.


### The `parseRefs` directive
Parses the element references on the field.

### The `trim` directive
Trims leading and trailing whitespace from the field value.

<!-- END DIRECTIVES -->

## Predefined interfaces
Craft defines several interfaces to be implemented by the different GraphQL types.

<!-- BEGIN INTERFACES -->

### The `AddressInterface` interface
This is the interface implemented by all addresses.
| Field | Type | Description
| - | - | -
| `id`| `ID` | The ID of the entity
| `uid`| `String` | The UID of the entity
| `_count`| `Int` | Return a number of related elements for a field.
| `title`| `String` | The element’s title.
| `slug`| `String` | The element’s slug.
| `uri`| `String` | The element’s URI.
| `enabled`| `Boolean` | Whether the element is enabled.
| `archived`| `Boolean` | Whether the element is archived.
| `siteHandle`| `String` | The handle of the site the element is associated with.
| `siteId`| `Int` | The ID of the site the element is associated with.
| `siteSettingsId`| `ID` | The unique identifier for an element-site relation.
| `language`| `String` | The language of the site element is associated with.
| `searchScore`| `Int` | The element’s search score, if the `search` parameter was used when querying for the element.
| `trashed`| `Boolean` | Whether the element has been soft-deleted.
| `status`| `String` | The element’s status.
| `dateCreated`| `DateTime` | The date the element was created.
| `dateUpdated`| `DateTime` | The date the element was last updated.
| `fullName`| `String` | The full name on the address.
| `firstName`| `String` | The first name on the address.
| `lastName`| `String` | The last name on the address.
| `countryCode`| `String!` | Two-letter country code
| `administrativeArea`| `String` | Administrative area.
| `locality`| `String` | Locality
| `dependentLocality`| `String` | Dependent locality
| `postalCode`| `String` | Postal code
| `sortingCode`| `String` | Sorting code
| `addressLine1`| `String` | First line of the address
| `addressLine2`| `String` | Second line of the address
| `addressLine3`| `String` | Third line of the address
| `organization`| `String` | Organization name
| `organizationTaxId`| `String` | Organization tax ID
| `latitude`| `String` | Latitude
| `longitude`| `String` | Longitude


### The `AssetInterface` interface
This is the interface implemented by all assets.
| Field | Type | Description
| - | - | -
| `id`| `ID` | The ID of the entity
| `uid`| `String` | The UID of the entity
| `_count`| `Int` | Return a number of related elements for a field.
| `title`| `String` | The element’s title.
| `slug`| `String` | The element’s slug.
| `uri`| `String` | The element’s URI.
| `enabled`| `Boolean` | Whether the element is enabled.
| `archived`| `Boolean` | Whether the element is archived.
| `siteHandle`| `String` | The handle of the site the element is associated with.
| `siteId`| `Int` | The ID of the site the element is associated with.
| `siteSettingsId`| `ID` | The unique identifier for an element-site relation.
| `language`| `String` | The language of the site element is associated with.
| `searchScore`| `Int` | The element’s search score, if the `search` parameter was used when querying for the element.
| `trashed`| `Boolean` | Whether the element has been soft-deleted.
| `status`| `String` | The element’s status.
| `dateCreated`| `DateTime` | The date the element was created.
| `dateUpdated`| `DateTime` | The date the element was last updated.
| `uploaderId`| `Int` | The ID of the user who first added this asset (if known).
| `uploader`| `UserInterface` | The user who first added this asset (if known).
| `alt`| `String` | Alternative text for the asset.
| `volumeId`| `Int` | The ID of the volume that the asset belongs to.
| `folderId`| `Int!` | The ID of the folder that the asset belongs to.
| `filename`| `String!` | The filename of the asset file.
| `extension`| `String!` | The file extension for the asset file.
| `hasFocalPoint`| `Boolean!` | Whether a user-defined focal point is set on the asset.
| `focalPoint`| `[Float]` | The focal point represented as an array with `x` and `y` keys, or null if it’s not an image.
| `kind`| `String!` | The file kind.
| `size`| `String` | The file size in bytes.
| `height`| `Int` | The height in pixels or null if it’s not an image.
| `width`| `Int` | The width in pixels or null if it’s not an image.
| `img`| `String` | An `<img>` tag based on this asset.
| `srcset`| `String` | Returns a `srcset` attribute value based on the given widths or x-descriptors.
| `url`| `String` | The full URL of the asset. This field accepts the same fields as the `transform` directive.
| `mimeType`| `String` | The file’s MIME type, if it can be determined.
| `format`| `String` | Returns the file’s format.
| `path`| `String!` | The asset’s path in the volume.
| `dateModified`| `DateTime` | The date the asset file was last modified.
| `prev`| `AssetInterface` | Returns the previous element relative to this one, from a given set of criteria.
| `next`| `AssetInterface` | Returns the next element relative to this one, from a given set of criteria.


### The `EntryInterface` interface
This is the interface implemented by all entries.
| Field | Type | Description
| - | - | -
| `id`| `ID` | The ID of the entity
| `uid`| `String` | The UID of the entity
| `_count`| `Int` | Return a number of related elements for a field.
| `title`| `String` | The element’s title.
| `slug`| `String` | The element’s slug.
| `uri`| `String` | The element’s URI.
| `enabled`| `Boolean` | Whether the element is enabled.
| `archived`| `Boolean` | Whether the element is archived.
| `siteHandle`| `String` | The handle of the site the element is associated with.
| `siteId`| `Int` | The ID of the site the element is associated with.
| `siteSettingsId`| `ID` | The unique identifier for an element-site relation.
| `language`| `String` | The language of the site element is associated with.
| `searchScore`| `Int` | The element’s search score, if the `search` parameter was used when querying for the element.
| `trashed`| `Boolean` | Whether the element has been soft-deleted.
| `status`| `String` | The element’s status.
| `dateCreated`| `DateTime` | The date the element was created.
| `dateUpdated`| `DateTime` | The date the element was last updated.
| `lft`| `Int` | The element’s left position within its structure.
| `rgt`| `Int` | The element’s right position within its structure.
| `level`| `Int` | The element’s level within its structure
| `root`| `Int` | The element’s structure’s root ID
| `structureId`| `Int` | The element’s structure ID.
| `isDraft`| `Boolean` | Returns whether this is a draft.
| `isRevision`| `Boolean` | Returns whether this is a revision.
| `revisionId`| `Int` | The revision ID (from the `revisions` table).
| `revisionNotes`| `String` | The revision notes (from the `revisions` table).
| `draftId`| `Int` | The draft ID (from the `drafts` table).
| `isUnpublishedDraft`| `Boolean` | Returns whether this is an unpublished draft.
| `draftName`| `String` | The name of the draft.
| `draftNotes`| `String` | The notes for the draft.
| `authorId`| `Int` | The primary entry author’s ID.
| `author`| `[UserInterface]` | The primary entry author.
| `authorIds`| `[Int]` | The entry authors’ IDs.
| `authors`| `[UserInterface]` | The entry authors.
| `draftCreator`| `UserInterface` | The creator of a given draft.
| `drafts`| `[EntryInterface]` | The drafts for the entry.
| `revisionCreator`| `UserInterface` | The creator of a given revision.
| `currentRevision`| `EntryInterface` | The current revision for the entry.
| `revisions`| `[EntryInterface]` | The revisions for the entry.
| `canonicalId`| `Int` | Returns the entry’s canonical ID.
| `canonicalUid`| `String` | Returns the entry’s canonical UUID.
| `sourceId`| `Int` | Returns the entry’s canonical ID.
| `sourceUid`| `String` | Returns the entry’s canonical UUID.
| `sectionId`| `Int` | The ID of the section that contains the entry.
| `sectionHandle`| `String` | The handle of the section that contains the entry.
| `fieldId`| `Int` | The ID of the field that contains the entry.
| `fieldHandle`| `String` | The handle of the field that contains the entry.
| `ownerId`| `Int` | The ID of the entry’s owner element.
| `sortOrder`| `Int` | The entry’s position within the field that contains it.
| `typeId`| `Int!` | The ID of the entry type that contains the entry.
| `typeHandle`| `String!` | The handle of the entry type that contains the entry.
| `postDate`| `DateTime` | The entry’s post date.
| `expiryDate`| `DateTime` | The expiry date of the entry.
| `children`| `[EntryInterface!]!` | The entry’s children, if the section is a structure. Accepts the same arguments as the `entries` query.
| `descendants`| `[EntryInterface!]!` | The entry’s descendants, if the section is a structure. Accepts the same arguments as the `entries` query.
| `parent`| `EntryInterface` | The entry’s parent, if the section is a structure.
| `ancestors`| `[EntryInterface!]!` | The entry’s ancestors, if the section is a structure. Accepts the same arguments as the `entries` query.
| `url`| `String` | The element’s full URL
| `localized`| `[EntryInterface!]!` | The same element in other locales.
| `prev`| `EntryInterface` | Returns the previous element relative to this one, from a given set of criteria.
| `next`| `EntryInterface` | Returns the next element relative to this one, from a given set of criteria.
| `enabledForSite`| `Boolean` | Whether the element is enabled for the site.


### The `GlobalSetInterface` interface
This is the interface implemented by all global sets.
| Field | Type | Description
| - | - | -
| `id`| `ID` | The ID of the entity
| `uid`| `String` | The UID of the entity
| `_count`| `Int` | Return a number of related elements for a field.
| `title`| `String` | The element’s title.
| `slug`| `String` | The element’s slug.
| `uri`| `String` | The element’s URI.
| `enabled`| `Boolean` | Whether the element is enabled.
| `archived`| `Boolean` | Whether the element is archived.
| `siteHandle`| `String` | The handle of the site the element is associated with.
| `siteId`| `Int` | The ID of the site the element is associated with.
| `siteSettingsId`| `ID` | The unique identifier for an element-site relation.
| `language`| `String` | The language of the site element is associated with.
| `searchScore`| `Int` | The element’s search score, if the `search` parameter was used when querying for the element.
| `trashed`| `Boolean` | Whether the element has been soft-deleted.
| `status`| `String` | The element’s status.
| `dateCreated`| `DateTime` | The date the element was created.
| `dateUpdated`| `DateTime` | The date the element was last updated.
| `name`| `String!` | The name of the global set.
| `handle`| `String!` | The handle of the global set.


### The `UserInterface` interface
This is the interface implemented by all users.
| Field | Type | Description
| - | - | -
| `id`| `ID` | The ID of the entity
| `uid`| `String` | The UID of the entity
| `_count`| `Int` | Return a number of related elements for a field.
| `title`| `String` | The element’s title.
| `slug`| `String` | The element’s slug.
| `uri`| `String` | The element’s URI.
| `enabled`| `Boolean` | Whether the element is enabled.
| `archived`| `Boolean` | Whether the element is archived.
| `siteHandle`| `String` | The handle of the site the element is associated with.
| `siteId`| `Int` | The ID of the site the element is associated with.
| `siteSettingsId`| `ID` | The unique identifier for an element-site relation.
| `language`| `String` | The language of the site element is associated with.
| `searchScore`| `Int` | The element’s search score, if the `search` parameter was used when querying for the element.
| `trashed`| `Boolean` | Whether the element has been soft-deleted.
| `status`| `String` | The element’s status.
| `dateCreated`| `DateTime` | The date the element was created.
| `dateUpdated`| `DateTime` | The date the element was last updated.
| `photo`| `AssetInterface` | The user’s photo.
| `friendlyName`| `String` | The user’s first name or username.
| `fullName`| `String` | The user’s full name.
| `name`| `String!` | The user’s full name or username.
| `preferences`| `String!` | The user’s preferences.
| `preferredLanguage`| `String` | The user’s preferred language.
| `username`| `String` | The username.
| `firstName`| `String` | The user’s first name.
| `lastName`| `String` | The user’s last name.
| `email`| `String` | The user’s email.
| `affiliatedSiteHandle`| `String` | The handle of the site the user is affiliated with.
| `affiliatedSiteId`| `Int` | The ID of the site the user is affiliated with.
| `addresses`| `[AddressInterface]` | The user’s addresses.


### The `CategoryInterface` interface
This is the interface implemented by all categories.
| Field | Type | Description
| - | - | -
| `id`| `ID` | The ID of the entity
| `uid`| `String` | The UID of the entity
| `_count`| `Int` | Return a number of related elements for a field.
| `title`| `String` | The element’s title.
| `slug`| `String` | The element’s slug.
| `uri`| `String` | The element’s URI.
| `enabled`| `Boolean` | Whether the element is enabled.
| `archived`| `Boolean` | Whether the element is archived.
| `siteHandle`| `String` | The handle of the site the element is associated with.
| `siteId`| `Int` | The ID of the site the element is associated with.
| `siteSettingsId`| `ID` | The unique identifier for an element-site relation.
| `language`| `String` | The language of the site element is associated with.
| `searchScore`| `Int` | The element’s search score, if the `search` parameter was used when querying for the element.
| `trashed`| `Boolean` | Whether the element has been soft-deleted.
| `status`| `String` | The element’s status.
| `dateCreated`| `DateTime` | The date the element was created.
| `dateUpdated`| `DateTime` | The date the element was last updated.
| `lft`| `Int` | The element’s left position within its structure.
| `rgt`| `Int` | The element’s right position within its structure.
| `level`| `Int` | The element’s level within its structure
| `root`| `Int` | The element’s structure’s root ID
| `structureId`| `Int` | The element’s structure ID.
| `groupId`| `Int!` | The ID of the group that contains the category.
| `groupHandle`| `String!` | The handle of the group that contains the category.
| `children`| `[CategoryInterface!]!` | The category’s children.
| `descendants`| `[CategoryInterface!]!` | The category’s descendants, if the section is a structure. Accepts the same arguments as the `entries` query.
| `ancestors`| `[CategoryInterface!]!` | The category’s ancestors, if the section is a structure. Accepts the same arguments as the `entries` query.
| `parent`| `CategoryInterface` | The category’s parent.
| `url`| `String` | The element’s full URL
| `localized`| `[CategoryInterface!]!` | The same element in other locales.
| `prev`| `CategoryInterface` | Returns the previous element relative to this one, from a given set of criteria.
| `next`| `CategoryInterface` | Returns the next element relative to this one, from a given set of criteria.


### The `TagInterface` interface
This is the interface implemented by all tags.
| Field | Type | Description
| - | - | -
| `id`| `ID` | The ID of the entity
| `uid`| `String` | The UID of the entity
| `_count`| `Int` | Return a number of related elements for a field.
| `title`| `String` | The element’s title.
| `slug`| `String` | The element’s slug.
| `uri`| `String` | The element’s URI.
| `enabled`| `Boolean` | Whether the element is enabled.
| `archived`| `Boolean` | Whether the element is archived.
| `siteHandle`| `String` | The handle of the site the element is associated with.
| `siteId`| `Int` | The ID of the site the element is associated with.
| `siteSettingsId`| `ID` | The unique identifier for an element-site relation.
| `language`| `String` | The language of the site element is associated with.
| `searchScore`| `Int` | The element’s search score, if the `search` parameter was used when querying for the element.
| `trashed`| `Boolean` | Whether the element has been soft-deleted.
| `status`| `String` | The element’s status.
| `dateCreated`| `DateTime` | The date the element was created.
| `dateUpdated`| `DateTime` | The date the element was last updated.
| `groupId`| `Int!` | The ID of the group that contains the tag.
| `groupHandle`| `String!` | The handle of the group that contains the tag.

<!-- END INTERFACES -->

## Mutations

GraphQL mutations provide a way to modify data. The actual mutations will vary depending on the [schema](#define-your-schemas) and what it allows. There are common mutations per GraphQL object type and additional type-specific mutations.

Mutations take the data as arguments. In this example, we’re using the type-specific `save_news_article_Entry` to save a new entry. We’re providing a title and slug and formatting the `dateCreated` that’s populated automatically when the entry is saved:

::: code
```graphql GraphQL
mutation saveEntry($title: String, $slug: String) {
  save_news_article_Entry(title: $title, slug: $slug) {
    title
    slug
    dateCreated @formatDateTime (format: "Y-m-d")
  }
}

# query variables:
{
  "title": "Craft 3.5 Supports GraphQL Mutations",
  "slug": "craft-graphql-mutations"
}
```
```json JSON Response
{
  "data": {
    "save_news_article_Entry": {
      "title": "Craft 3.5 Supports GraphQL Mutations",
      "slug": "craft-graphql-mutations",
      "dateCreated": "2020-04-18"
    }
  }
}
```
:::

While mutations are mostly straightforward, there are a few important cases to consider.

::: warning
For security reasons, [users](../reference/element-types/users.md) cannot be created, updated, or deleted via GraphQL.
:::

### Matrix Fields in Mutations

Connecting GraphQL’s input types to complex [Matrix fields](../reference/field-types/matrix.md) can be challenging.

::: tip
We recommend studying how to [save Matrix field data in entry forms](../reference/field-types/matrix.md#saving-matrix-fields) before diving in to the equivalent GraphQL.
:::

Matrix input types have the following structure, and are always named `{fieldHandle}_MatrixInput`:

| Field | Description
| --- | ---
| `sortOrder` | A list of all the nested entry IDs, including any new entries, in the order you’d like to persist after the mutation.
| `entries` | A list of all the actual entries. You can omit any entries that aren’t modified, but they must be represented on the `sortOrder` field or they’ll be deleted.

As an example, let’s pretend we have a Matrix field with a handle `ingredients`. The field has three entry types: `spirit`, `mixer`, and `garnish`. Each entry type has one or two fields:

```
ingredients (Matrix field)
├── spirit (Entry type)
│   ├── spiritName (Plain Text)
│   └── ounces (Number)
├── mixer (Entry type)
│   ├── mixerName (Plain Text)
│   └── ounces (Number)
└── garnish (Entry type)
    └── garnishName (Plain Text)
```

These are all the GraphQL “input types” Craft generates for this Matrix field:

| Type Name | Type Description |
| --- | --- |
| `ingredients_MatrixInput` | Input type for the Matrix field, containing `sortOrder` and `entries`.
| `ingredients_MatrixEntryContainerInput` | Input type that represents the block, in this case containing `spirit`, `mixer`, and `garnish`.
| `ingredients_spirit_MatrixEntryInput` | Input type for `spirit` entries, containing `spiritName` and `ounces` fields.
| `ingredients_mixer_MatrixEntryInput` | Input type for `mixer` entries, containing `mixerName` and `ounces` fields.
| `ingredients_garnish_MatrixEntryInput` | Input type for `garnish` entries, containing the `garnishName` field.

Those input types would look like this in [GraphQL Schema Definition Language (SDL)](https://www.prisma.io/blog/graphql-sdl-schema-definition-language-6755bcb9ce51):

```graphql
input ingredients_MatrixInput {
  sortOrder: [QueryArgument]!
  entries: [ingredients_MatrixEntryContainerInput]
}

input ingredients_MatrixEntryContainerInput {
  spirit: ingredients_spirit_MatrixEntryInput
  mixer: ingredients_mixer_MatrixEntryInput
  garnish: ingredients_garnish_MatrixEntryInput
}

input ingredients_spirit_MatrixEntryInput {
  # ... common entry fields ...
  spiritName: String
  ounces: Number
}

input ingredients_mixer_MatrixEntryInput {
  # ... common entry fields ...
  mixerName: String
  ounces: Number
}

input ingredients_garnish_MatrixEntryInput {
  # ... common entry fields ...
  garnishName: String
}
```

A mutation saving a new entry with multiple nested entries might look like this:

::: code
```graphql GraphQL
mutation saveEntry(
  $title: String,
  $slug: String,
  $authorId: ID,
  $ingredients: [ingredients_MatrixEntryContainerInput],
  $sortOrder: [QueryArgument]
) {
  save_cocktails_cocktail_Entry(
    title: $title,
    slug: $slug,
    authorId: $authorId,
    ingredients: { entries: $ingredients, sortOrder: $sortOrder }
  ) {
    title
    slug
    authorId
    dateCreated @formatDateTime (format: "Y-m-d")
    ingredients {
      __typename

      ...on EntryInterface {
        id
      }

      ... on spirit_entry {
        spiritName
        ounces
      }

      ... on mixer_Entry {
        mixerName
        ounces
      }

      ... on garnish_Entry {
        garnishName
      }
    }
  }
}

# query variables:
{
  "title": "Gin and Tonic",
  "slug": "gin-tonic",
  "authorId": 1,
  "sortOrder": ["new1", "new2", "new3", "new4"],
  "ingredients": [
    {
      "spirit": {
        "id": "new1",
        "spiritName": "Gin",
        "ounces": 2
      }
    },
    {
      "mixer": {
        "id": "new2",
        "mixerName": "Tonic",
        "ounces": 4
      }
    },
    {
      "mixer": {
        "id": "new3",
        "mixerName": "Fresh Lime Juice",
        "ounces": 0.25
      }
    },
    {
      "garnish": {
        "id": "new4",
        "garnishName": "Lime Wedge or Twist"
      }
    }
  ]
}
```
```json JSON Response
{
  "data": {
    "save_cocktails_cocktail_Entry": {
      "title": "Gin and Tonic",
      "slug": "gin-tonic",
      "authorId": 1,
      "dateCreated": "2021-03-04",
      "ingredients": [
        {
          "__typename": "spirit_Entry",
          "id": "9",
          "spiritName": "Gin",
          "ounces": 2
        },
        {
          "__typename": "mixer_Entry",
          "id": "10",
          "mixerName": "Tonic",
          "ounces": 4
        },
        {
          "__typename": "mixer_Entry",
          "id": "11",
          "mixerName": "Fresh Lime Juice",
          "ounces": 0.25
        },
        {
          "__typename": "garnish_Entry",
          "id": "12",
          "garnishName": "Lime Wedge or Twist"
        }
      ]
    }
  }
}
```
:::

### Saving Files via Mutations

You can provide files for assets as either `base64`-encoded data, or a URL that Craft will download.

Either way, you’ll use the `FileInput` GraphQL input type, which has the following fields:

| Field      | Description
| ---------- | -----------
| `url`      | URL of a file to be downloaded.
| `fileData` | File contents in base64 format. If provided, takes precedence over `url`.
| `filename` | Filename to use for the saved asset. If omitted, Craft will create a filename.

### Mutating Entries

#### Saving an Entry

[Entries](../reference/element-types/entries.md) are created and updated with mutations named after the combination of the target section and entry type, like `save_{sectionHandle}_{typeHandle}_Entry`:

::: tip
See the section on [Matrix mutations](#matrix-fields-in-mutations) for more information about saving nested entries.
:::

<!-- BEGIN ENTRY MUTATION ARGS -->

| Argument | Type | Description
| - | - | -
| `id`| `ID` | Set the element’s ID.
| `uid`| `String` | Set the element’s UID.
| `title`| `String` | The title of the element.
| `enabled`| `Boolean` | Whether the element should be enabled.
| `authorId`| `ID` | The ID of the user that created this entry.
| `postDate`| `DateTime` | When should the entry be posted.
| `expiryDate`| `DateTime` | When should the entry expire.
| `slug`| `String` | Narrows the query results based on the elements’ slugs.
| `siteId`| `Int` | Determines which site(s) the elements should be saved to. Defaults to the primary site.
| `...`|  | More arguments depending on the field layout for the type

<!-- END ENTRY MUTATION ARGS -->

The `id`, `uid` and `authorId` arguments do not exist for single entries. This is because single entries have no authors and are identified already by the exact mutation. In a similar fashion, there are additional arguments available for structured entries. For more information, refer to [mutating structure data](#mutating-structure-data).

::: tip
After saving an entry, Craft runs queue jobs for updating revisions and search indexes. If you’re using Craft headlessly or infrequently accessing the control panel, consider disabling <config5:runQueueAutomatically> and [establishing an always-running daemon](../system/queue.md#daemon) to keep revisions and search indexes up to date.
:::

#### Editing Existing Entries

You can modify existing entries by passing the populated `id` argument to your mutation.

#### Saving a Draft

Entry _drafts_ are created and updated with mutations named after the combination of the target section and entry type, like `save_{sectionHandle}_{typeHandle}_Draft`:

<!-- BEGIN DRAFT MUTATION ARGS -->

| Argument | Type | Description
| - | - | -
| `title`| `String` | The title of the element.
| `enabled`| `Boolean` | Whether the element should be enabled.
| `authorId`| `ID` | The ID of the user that created this entry.
| `postDate`| `DateTime` | When should the entry be posted.
| `expiryDate`| `DateTime` | When should the entry expire.
| `slug`| `String` | Narrows the query results based on the elements’ slugs.
| `siteId`| `Int` | Determines which site(s) the elements should be saved to. Defaults to the primary site.
| `draftId`| `ID!` | The ID of the draft.
| `draftName`| `String` | The name of the draft.
| `draftNotes`| `String` | Notes for the draft.
| `...`|  | More arguments depending on the field layout for the type

<!-- END DRAFT MUTATION ARGS -->

#### Creating or Publishing a Draft

You can use the generic `createDraft` mutation to create a new draft. It requires the `id` of the draft’s canonical entry and returns the ID of the newly-saved draft:

::: code
```graphql Query
mutation MyNewDraft {
  createDraft(id: 1234)
}
```
```json Response
{
  "data": {
    "createDraft": "5678"
  }
}
```
:::

Additional (optional) arguments include a `name` for the draft, `notes`, a `creatorId` (if the draft should be created on behalf of a specific user), and a `provisional` flag. Provisional drafts (referred to in the control panel as auto-saved changes)

_Applying_ a draft is handled in the same way, but with the `publishDraft` mutation. It requires the `id` of the draft to be published and returns the ID of the updated canonical entry:

::: code
```graphql Query
mutation PublishMyDraft {
  publishDraft(id: 5678)
}
```
```json Response
{
  "data": {
    "publishDraft": "1234"
  }
}
```
:::

Neither mutation accepts properties or custom field values—use the appropriate [entry mutation](#saving-an-entry) to update a draft after it has been created. To work with drafts, the [schema](#define-your-schemas) must allow creating and saving entries in the canonical entry’s section; unlike user permissions, schemas do not have discrete permissions for draft creation and canonical entry mutations.

#### Deleting an Entry

You can delete an entry using the `deleteEntry` mutation, which requires the `id` of the entry to be deleted. It returns a boolean value indicating whether the operation was successful.

### Mutating Assets

#### Saving an Asset

To create or update an [asset](../reference/element-types/assets.md), use the volume-specific mutation which will have a name in the form of `save_<volumeHandle>_Asset`:

<!-- BEGIN ASSET MUTATION ARGS -->

| Argument | Type | Description
| - | - | -
| `id`| `ID` | Set the element’s ID.
| `uid`| `String` | Set the element’s UID.
| `title`| `String` | The title of the element.
| `enabled`| `Boolean` | Whether the element should be enabled.
| `_file`| `FileInput` | The file to use for this asset
| `newFolderId`| `ID` | ID of the new folder for this asset
| `...`|  | More arguments depending on the field layout for the type

<!-- END ASSET MUTATION ARGS -->

#### Deleting an Asset

You can delete an asset using the `deleteAsset` mutation, which requires the `id` of the asset to be deleted. It returns a boolean value indicating whether the operation was successful.

### Mutating Tags

#### Saving a Tag

To create or update a [tag](../reference/element-types/tags.md), use the tag group-specific mutation which will have a name in the form of `save_<tagGroupHandle>_Tag`:

<!-- BEGIN TAG MUTATION ARGS -->

| Argument | Type | Description
| - | - | -
| `id`| `ID` | Set the element’s ID.
| `uid`| `String` | Set the element’s UID.
| `title`| `String` | The title of the element.
| `enabled`| `Boolean` | Whether the element should be enabled.
| `...`|  | More arguments depending on the field layout for the type

<!-- END TAG MUTATION ARGS -->

#### Deleting a Tag

To delete a tag, use the `deleteTag` mutation which requires the `id` of the tag to be deleted. It returns a boolean value indicating whether the operation was successful.

### Mutating Categories

#### Saving a Category

To create or update a [category](../reference/element-types/categories.md), use the category group-specific mutation which will have a name in the form of `save_<categoryGroupHandle>_Category`.

<!-- BEGIN CATEGORY MUTATION ARGS -->

| Argument | Type | Description
| - | - | -
| `id`| `ID` | Set the element’s ID.
| `uid`| `String` | Set the element’s UID.
| `title`| `String` | The title of the element.
| `enabled`| `Boolean` | Whether the element should be enabled.
| `...`|  | More arguments depending on the field layout for the type

<!-- END CATEGORY MUTATION ARGS -->

#### Deleting a Category

To delete a category, use the `deleteCategory` mutation which requires the `id` of the category to be deleted. It returns a boolean value indicating whether the operation was successful.

### Mutating Structure Data

Structure section entries and categories exist with explicit order and nesting relationships. To manipulate their place in the structure, save the elements using the appropriate mutations and use the following arguments:

<!-- BEGIN STRUCTURE MUTATION ARGS -->

| Argument | Type | Description
| - | - | -
| `prependTo`| `ID` | The ID of the element to prepend to.
| `appendTo`| `ID` | The ID of the element to append to.
| `prependToRoot`| `Boolean` | Whether to prepend this element to the root.
| `appendToRoot`| `Boolean` | Whether to append this element to the root.
| `insertBefore`| `ID` | The ID of the element this element should be inserted before.
| `insertAfter`| `ID` | The ID of the element this element should be inserted after.

<!-- END STRUCTURE MUTATION ARGS -->

### Mutating Global Sets

To update a global set use the appropriate mutations which will have the name in the form of `save_<globalSetHandle>_GlobalSet`.

The only available arguments are custom fields on the global set.

### Mutating Users

It’s currently not possible to mutate users with Craft’s GraphQL API.

## Further Reading

If you’re looking to add GraphQL support in your own plugin or module, see [Extending GraphQL](../extend/graphql.md).
</file>

<file path="development/image-transforms.md">
# Image Transforms

Instead of requiring content editors to upload images at a specific sizes, Craft lets you define “image transforms” for automatically manipulating images in predefined ways, or on-demand. Transforms are _non-destructive_, meaning they have no effect on the original uploaded image.

<!-- more -->

Transforms can be defined in the control panel or directly from your templates and GraphQL queries.

## Named Transforms

Named transforms are created from the [control panel](../system/control-panel.md) by navigating to **Settings** → **Assets** → **Image Transforms** and press **New Transform**.

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/settings/assets/transforms/new"
    :link="false"
    caption="Creating a new predefined asset transform in the control panel."
    id="settings"
    :maxHeight="600">
<img src="../images/assets-transforms.png" alt="Asset transform edit screen">
</BrowserShot>

<Todo notes="Add POI/waypoints to this screen" />

Every transform has the following settings:

Name
:   A user-facing name or label for the transform. This is mostly for your reference, but it _may_ be exposed to content authors when using [Redactor](plugin:redactor).

Handle
:   A template-facing handle, used when accessing transforms in Twig or via GraphQL. _Changing this may require updates to your templates!_

Mode
:   Specifies how the transform is handled:

    - [**Crop**](#crop) (Default) — Crops the image to the specified width and height.
    - [**Fit**](#fit) — Scales the image so that it is as big as possible with all dimensions fitting within the specified width and height.
    - [**Letterbox**](#letterbox) — Stretches the image to the specified width and height.
    - [**Stretch**](#stretch) — Stretches the image to the specified width and height.

All [modes](#transform-modes) support some general controls over image size and quality:

Width
:   Final transformed image width, or blank to calculate automatically from the original image’s aspect ratio.

Height
:   Final transformed image height, or blank to calculate automatically from the original image’s aspect ratio.

Allow Upscaling
:   Whether or not Craft is allowed to scale an image beyond its original dimensions. Affects the maximum **Width** and **Height** for **Fit**, **Crop**, and **Stretch** output, and the matting strategy for **Letterbox** transforms.

Quality
:   Sets a quality or compression ratio for the transformed image, depending on the format of the target image. When left blank, the quality will be determined by the <config5:defaultImageQuality> config setting.

Interlacing
:   Specify an [interlacing](https://en.wikipedia.org/wiki/Interlacing_(bitmaps)) strategy for the pixels in raster images.

Image Format
:   Format for the transformed image.

    - Auto (same as source image, if [web-safe](craft5:craft\helpers\Image::webSafeFormats()), otherwise `jpg`)
    - `jpg`
    - `png`
    - `gif`
    - `webp` (when supported by ImageMagick)
    - `avif` (when supported by ImageMagick)

    ::: tip
    The <config5:transformGifs> setting allows you to completely disable transformation of GIF images. Animated GIFs often consume significant resources to resize, and rarely produce well-optimized output.

    You do not need to update templates for this setting to work—Craft will just ignore the transform and return a URL to the original image.
    :::

::: warning
Some modes may behave the same when using only one of the **Width** and **Height** settings. Typically, an unset dimension means the image’s aspect ratio is maintained.

Suppose we have a source image that is 600 pixels wide and 400 pixels tall. Applying a **Stretch** transform that only declares a **Width** of 60 pixels would produce an image 40 pixels tall.
:::

## Transform Modes

Additional settings are available for some transform modes.

### Crop

When using the **Crop** mode, a **Default Focal Point** setting is revealed, allowing customization of which image area Craft should center the crop on when a [focal point](../reference/element-types/assets.md#focal-points) isn’t specified. Its options include:

Label | Handle
--- | ---
Top-Left | `top-left`
Top-Center | `top-center`
Top-Right | `top-right`
Center-Left | `center-left`
Center-Center | `center-center`
Center-Right | `center-right`
Bottom-Left | `bottom-left`
Bottom-Center | `bottom-center`
Bottom-Right | `bottom-right`

When a focal point _is_ known for an image, Craft will attempt to keep that point as close to the center of the crop as possible.

### Fit

The **Fit** mode always respects the original image’s aspect ratio. The image is scaled to fit within the specified **Width** and/or **Height**, but may not cover the entire allowed area. Focal points have no effect when using this mode, as images are never cropped.

### Letterbox

Two new options are revealed when using the **Letterbox** mode:

- **Fill Color** — A hexadecimal color value used for the matte. When supported, the default matte is transparent; otherwise, white.
- **Image Position** — Where the image will be anchored, when it does not fill the entire target frame. The same anchoring options are available here as for the **Default Focal Point** option in the **Crop** and **Fit** modes.

Letterbox mode preserves images’ aspect ratios, fitting them within the provided width and height and filling the remaining space with the **Fill Color**. If the target frame is larger than the original image’s dimensions and the **Allow Upscaling** option is _Off_, Craft may matte the image on more than two sides.

### Stretch

Like **Crop** and **Fit**, **Stretch** is only differentiated from other transforms when used with a **Height** _and_ a **Width** setting.

With both set, the image is scaled horizontally _and_ vertically to the target size.

::: warning
As the name of this mode suggests, using a target height and width that are a different aspect ratio than the original image will cause the image to be stretched disproportionately.
:::

## Applying Named Transforms to Images

To output an image with your named transform applied, pass its handle into your asset’s [getImg()](craft5:craft\elements\Asset::getImg()), [getUrl()](craft5:craft\elements\Asset::getUrl()), [getWidth()](craft5:craft\elements\Asset::getWidth()), and [getHeight()](craft5:craft\elements\Asset::getHeight()) functions:

```twig
<img src="{{ asset.getUrl('thumb') }}"
  width="{{ asset.getWidth('thumb') }}"
  height="{{ asset.getHeight('thumb') }}">
```

You can also apply the transform on the asset so any relevant properties are automatically manipulated by default. This example would output the same result as the example above:

```twig
{% do asset.setTransform('thumb') %}
<img src="{{ asset.url }}"
  width="{{ asset.width }}"
  height="{{ asset.height }}">
```

## Defining Transforms in your Templates

You can also define transforms directly in your templates by creating a hash with the desired parameters:

```twig
{% set thumb = {
  mode: 'crop',
  width: 100,
  height: 100,
  quality: 75,
  position: 'top-center'
} %}
```

::: tip
See a list of all the [possible keys and values](#possible-values) for this object.
:::

Then pass that hash into your asset’s `getUrl()`, `getWidth()`, and `getHeight()` functions:

```twig
<img
  src="{{ asset.getUrl(thumb) }}"
  width="{{ asset.getWidth(thumb) }}"
  height="{{ asset.getHeight(thumb) }}">
```

Notice in this example there are no quotes around “`thumb`” like there were in our earlier examples. That’s because before we were passing a [string](twig.md#strings) set to reference a control-panel-defined transform by its handle, whereas this example passes a [variable](twig.md#variables) containing the `thumb` options hash we created in the template.

It would look similar using `setTransform()` like we did in the previous section:

```twig
{% do asset.setTransform(thumb) %}
<img
  src="{{ asset.url }}"
  width="{{ asset.width }}"
  height="{{ asset.height }}">
```

### Possible Values

All the same settings available to [named transforms](#named-transforms) are available to template-defined transforms and transforms requested via [GraphQL](#graphql).

- The `mode` property can be set to either `'crop'`, `'fit'`, `'letterbox'`, or `'stretch'`.
- `width` and `height` can each be set to an integer, or omitted.
- `quality` can be set to a number between 0 and 100, or omitted to use the <config5:defaultImageQuality> setting.
- `format` can be set to `'jpg'`, `'gif'`, `'png'`, `'webp'`, `'avif'`, or omitted.
- A `position` property (set to one of the [valid values](#crop) listed above) is supported when `mode` is set to `'crop'` or `'letterbox'`. The behavior is different for each [type of transform](#transform-modes).

### Overriding Named Transforms

Should you need to break from a named transform in a few places, you can specify overrides alongside a `transform` key:

```twig{2-3}
{% do asset.setTransform({
  transform: 'thumb',
  quality: 100,
}) %}

<img
  src="{{ asset.url }}"
  width="{{ asset.width }}"
  height="{{ asset.height }}">
```

This would accomplish the same thing as the example before it, except `quality` would be maxed out at 100 rather than whatever was set on the named `'thumb'` transform.

You can override settings like this with the `getUrl()` method, too:

```twig
<source type="image/webp" srcset="{{ asset.getUrl({
  transform: 'thumb',
  format: 'webp',
}) }}">
```

This would use the named `'thumb'` transform’s settings, but always generate a `.webp` file.

### Generating `srcset` Sizes

Transforms are a great way to avoid serving unnecessarily-large images to your users—but there’s still room for optimization! Most browsers support the [`srcset`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#attr-srcset) attribute, which allows you to define a collection of images that are appropriate for a given device or viewport.

Rather than creating an exhaustive list of named transforms or building up multiple config hashes in your templates, you can offload this work to Craft with the [`getSrcSet()`](craft5:craft\elements\Asset::getSrcSet()) method. Here’s an example that uses the [`tag` template function](../reference/twig/functions.md#tag) to render an image with a `srcset` attribute containing three variations based on a single transform:

```twig
{% do asset.setTransform({ width: 300, height: 300 }) %}
{{ tag('img', {
  src: asset.url,
  width: asset.width,
  height: asset.height,
  srcset: asset.getSrcset(['1.5x', '2x', '3x']),
  alt: asset.title,
}) }}
```

This can be done even more succinctly by passing a second `sizes` argument to the [`getImg()`](craft5:craft\elements\Asset::getImg()) method:

```twig
{{ asset.getImg({ width: 300, height: 300 }, ['1.5x', '2x', '3x']) }}
```

Don’t forget to configure the corresponding `sizes` attribute, as well—Craft can manage the transforms and build a valid `srcset`, but it doesn’t know how the images are actually used in your front-end!

::: tip
You can also provide relative image sizes when eager-loading asset transforms. See [`AssetQuery::withTransforms()`](craft5:craft\elements\db\AssetQuery::withTransforms()) in the class reference for an example.
:::

## GraphQL

When requesting asset data via the [GraphQL](graphql.md) API, you can get named and ad-hoc transforms with the `@transform` directive.

Like we’ve seen in the template-defined transforms, the GraphQL API allows you to retrieve individual properties as though they were tied to a transform…

::: code
```graphql Query
query Thumbnails {
  assets(volume: "images") {
    title
    alt
    url @transform(width: 640, mode: "fit")
    width
    height
  }
}
```
```json Data
{
  "data": {
    "assets": [
      {
        "title": "Warm Springs",
        "alt": "Snow-dusted plateau.",
        "url": "https://my-project.ddev.site/uploads/images/_640xAUTO_fit_center-center_none/8/warm-springs.jpg",
        "width": 6000,
        "height": 4000
      },
      {
        "title": "Highway 26",
        "alt": "Winter scene near Warm Springs, Oregon",
        "url": "https://my-project.ddev.site/uploads/images/_640xAUTO_fit_center-center_none/3/highway-26.jpg",
        "width": 6000,
        "height": 4000
      }
    ]
  }
}
```
:::

…or set a transform on the entire asset object:

::: code
```graphql Query
query Gallery {
  assets(volume: "images") @transform("fullscreen") {
    title
    alt
    url
    width
    height
  }
}
```
```json Data
{
  "data": {
    "asset": {
      "title": "Warm Springs",
      "alt": "Highway 26, south of Warm Springs, Oregon",
      "url": "https://my-project.ddev.site/uploads/images/_fullScreen/8/warm-springs.jpg",
      "width": 2560,
      "height": 1707
    }
  }
}
```
:::

Note that in the first example, the `height` and `width` values are for the _original_ image, whereas in the second example, they reflect the _transformed_ dimensions.
</file>

<file path="development/README.md">
# Front-End Development

This section covers front-end development concepts, including…

- Common development patterns for rendering [templates](templates.md) on the server with [Twig](twig.md);
- Loading your content with [element queries](element-queries.md);
- Technologies that power decoupled or [headless](graphql.md) front-ends;
- Sending and receiving data with [forms](forms.md);
- Optimizing performance with [image transforms](image-transforms.md) and [eager-loading](eager-loading.md);
</file>

<file path="development/templates.md">
# Templates

In Craft, you define your site’s HTML output with templates.

<!-- more -->

Templates are files that live within your `templates/` folder. The structure of this directory is completely up to you—but keeping it organized and in agreement with [project config](../system/project-config.md) settings is essential.

Craft uses [Twig](https://twig.symfony.com/) to parse your templates. Twig is elegant, secure, powerful, and blazing fast. If you’re new to Twig, be sure to read the [Twig Fundamentals](twig.md) page to familiarize yourself with its syntax and capabilities.

::: tip
PHP code isn’t allowed in your templates, but Craft provides various ways to [extend Twig](../extend/extending-twig.md) to suit your needs.
:::


## Template Paths

There are several times when you’ll need to enter a path to one of your templates:

- When choosing which template [entry](../reference/element-types/entries.md) and [category](../reference/element-types/categories.md) URLs should load;
- When assigning a template to a [route](../system/routing.md#dynamic-routes);
- Within [include](https://twig.symfony.com/doc/tags/include.html), [extends](https://twig.symfony.com/doc/tags/extends.html), and [embed](https://twig.symfony.com/doc/tags/embed.html) template tags;

Craft has a standard template path format that applies to each of these cases: a Unix-style filesystem path to the template file, relative to your `templates/` folder. For example, the following paths are valid for a template located at `templates/recipes/entry.twig`:

- `recipes/entry`
- `recipes/entry.twig`

### Index Templates

If you name a template `index.twig`, you don’t need to specify it in the template path.

For example, if you have a template located at `templates/recipes/ingredients/index.twig`, the following template paths would point to it:

- `recipes/ingredients`
- `recipes/ingredients/index`
- `recipes/ingredients/index.twig`

If you have templates located at both `templates/recipes/ingredients.twig` *and* `templates/recipes/ingredients/index.twig`, the template path `recipes/ingredients` will match `ingredients.twig`.

### Hidden Templates

Suppose entries in a _Recipe_ section are configured to use a template located at `templates/recipes/entry.twig`. You might view a recipe at a URL like `http://my-project.tld/recipes/gin-tonic`, causing Craft to render that template—but someone could _also_ access the template directly at `http://my-project.tld/recipes/entry`. This would likely result in an error, oftentimes a result of the template assuming an `entry` variable is automatically injected. While there is value in exposing _some_ templates to Craft’s [routing](../system/routing.md) behavior (like a recipes index template at `templates/recipes/index.twig`), this one is better off hidden from public view.

Craft treats templates (and directories) prefixed with an underscore (`_`) as “hidden,” and will not render them unless specifically configured to do so via an element type’s settings or a custom [route](../system/routing.md#advanced-routing-with-url-rules). Changing the template’s filename to `_entry.twig` (and updating the _Recipe_ section’s configuration to use `recipes/_entry`) will ensure it is only rendered in the context of an entry.

Then, accessing `http://my-project.tld/recipes/entry` returns a 404, instead of trying (and failing) to render the template, out of context.

::: tip
You can customize the prefix for “private” templates using the <config5:privateTemplateTrigger> config setting.
:::

## Template Localization

If you’re running [multiple sites](../system/sites.md) with Craft, you can create site-specific subfolders in your `templates/` directory, with templates that will only be available to a specific site.

For example, if you want to create a special template welcoming your German customers (but there’s no need for it on your English site) then you could save it in `templates/de/welcome.twig`. That template would be available from `https://example.de/welcome`, assuming the German site’s base URL is `https://example.de` and its handle is `de`.

Craft will look for localized templates _before_ it looks for templates in the normal location, so you can use them to override non-localized templates. See our [Localization Guide](../system/sites.md) for more details.
</file>

<file path="development/twig.md">
---
keywords: twig, template, view, front end
description: Learn about Twig, Craft’s template engine.
---

# Twig Fundamentals

<Todo notes="This page is aggressively agnostic about Twig's usage—let's make it more Craft-specific. That may mean folding in or duplicating some content from the Routing page?" />

[Twig](https://twig.symfony.com/) is a fast and powerful templating system, commonly used to power front-end views in content management systems like Craft, Drupal, and WordPress (via the [Timber](https://www.upstatement.com/timber/) plugin).

<!-- more -->

Let’s take a look at how it works.

## Types of Twig code

Twig templates are HTML files that are sprinkled with bits of logic. When Twig loads a template, the first thing it does is identify which parts of the file represent Twig code.

All Twig code follows a basic pattern that separates it from the surrounding HTML. At its outer edges you will find left and right curly braces (`{` and `}`), coupled with another character that signifies what type of Twig expression it expects to be inside. These pairs of characters are called _delimiters_.

There are three types of delimiters that Twig parses:

- `{# ... #}` – [Comments](#comments)
- `{% ... %}` – [Tags](#tags)
- `{{ ... }}` – [Print statements](#print-statements)

### Comments

Twig comments are wrapped in `{#` and `#}` delimiters. You can use them to leave little notes for yourself in the code.

They are similar to HTML comments in that they won’t show up as rendered text in the browser—but _Twig_ comments are stripped from the HTML output:

::: code
```twig Template
<!-- This will be visible in the HTML source! -->
{# This won’t! #}
```
```html Output
<!-- This will be visible in the HTML source! -->
```
:::

### Tags

Twig tags are wrapped in `{%` and `%}` delimiters, and are used to define the _logic_ of your template, such as conditionals, loops, variable definitions, template includes, and other instructions.

The syntax within the `{%` and `%}` delimiters varies from tag to tag, but they will always start with the same thing: the name of the tag.

In their simplest form, the tag name might be all that’s required. Take Craft’s [requireLogin](../reference/twig/tags.md#requirelogin) tag, for example:

```twig
{# A user must be logged in to visit this page #}
{% requireLogin %}
```

Other tags can accept parameters. In the case of Craft’s [exit](../reference/twig/tags.md#exit) tag, you can optionally set the HTTP status code that should be sent to the browser in the response:

```twig
{# This is not the page you are looking for #}
{% exit 404 %}
```

Some tags are meant to be used in pairs, such as the [js](../reference/twig/tags.md#js) tag, which registers JavaScript code onto the page.

```twig
{% js %}
  console.log('Hello world');
{% endjs %}
```

Some tags can have nested tags _between_ the opening and closing tags:

```twig
{% if currentUser %}
  <a href="{{ logoutUrl }}">Logout</a>
{% else %}
  <a href="{{ loginUrl }}">Login</a>
{% endif %}
```

Refer to the [Tags](../reference/twig/tags.md) page for a full list of tags available to your Craft templates.

### Print Statements

To output dynamic values, use a print statement. Print statements are opened and closed with `{{` and `}}` delimiters, respectively, and can contain any valid Twig expression—so long as it produces something that can be treated as a [string](#strings).

```twig
<p>Hi, {{ currentUser.name }}</p>
```

::: tip
Don’t place a print statement (or other Twig tags) within another print statement. See [Combining Strings](#combining-strings) to learn how to combine strings with other expressions.
:::

#### Auto-escaping

Most of the time, print statements will automatically HTML-encode the content before actually outputting it (called **auto-escaping**), which helps defend against cross-site scripting (XSS) vulnerabilities.

For example, let’s say you have a search results page, where the search query is defined by a `q` query string parameter, and in the event that there are no results, you want to output a message to the user that includes the query:

```twig{16}
{% set query = craft.app.request.getQueryParam('q') %}

{% set entries = craft.entries()
  .section('blog')
  .search(query)
  .all() %}

{% if entries %}
  <h3>Search Results</h3>
  <ul>
    {% for entry in entries %}
      <li>{{ entry.getLink() }}</li>
    {% endfor %}
  </ul>
{% else %}
  <p>Sorry, no results for <strong>{{ query }}</strong> were found.</p>
{% endif %}
```

If it weren’t for auto-escaping, a search for `<script>alert('Uh-oh')</script>` would result in this HTML:

```html
<p>Sorry, no results for <strong><script>alert('Uh-oh')</script></strong>.</p>
```

Which would cause JavaScript to execute on the page, even though it wasn’t part of the original Twig template. But thanks to auto-escaping, you’d actually end up with this HTML:

```html
<p>Sorry, no results for <strong>&lt;script&gt;alert('Uh-oh')&lt;/script&gt;</strong>.</p>
```

There are two cases where print statements will output content directly, without auto-escaping it first:

- When the content is deemed safe by the last tag or function that was called within the print statement (such as the [markdown](../reference/twig/filters.md#markdown-or-md) filter).
- When you explicitly mark the content as safe using a [raw](https://twig.symfony.com/doc/3.x/filters/raw.html) filter.

#### Manual escaping

There are times where you may need to work with both trusted and untrusted content together. For example, let’s say you want to output user-supplied content as Markdown, but you want to ensure they haven’t put anything nefarious in there first.

To do that, you could explicitly encode _all_ HTML within the user-supplied content using the [escape](https://twig.symfony.com/doc/3.x/filters/escape.html) filter, before passing it to the [markdown](../reference/twig/filters.md#markdown-or-md) filter:

```twig
{# Escape any HTML in the Body field, then format as Markdown #}
{{ entry.body|escape|markdown }}
```

Alternatively if you want to allow _some_ HTML, so long as it’s tame, you can use the [purify](#purify) filter, which sanatizes the content using [HTML Purifier](http://htmlpurifier.org/).

```twig
{# Purify the content in the Body field, then format as Markdown #}
{{ entry.body|purify|markdown }}
```

## Variables

Twig supports setting custom **variables** in your templates, which let you save a [value](#types-of-values) to be referenced later on in your template.

You can define variables using the [set](https://twig.symfony.com/doc/3.x/tags/set.html) tag.

```twig
{% set title = "About Us" %}
{% set docTitle = title ~ " | ACME, Inc." %}

<html>
  <head>
    <title>{{ docTitle }}</title>
  </head>
  <body>
    <h1>{{ title }}</h1>
    <!-- ... -->
  </body>
</html>
```

Craft provides a few predefined variables that will be available in addition to the variables you define yourself. Refer to the [Global Variables](../reference/twig/global-variables.md) page for a full list of global variables available to your Craft templates.

## Functions

There are several functions available to your Twig templates, which can do a wide variety of things. For example, Craft provides a [hiddenInput](../reference/twig/functions.md#hiddeninput) function that can be used to generate the HTML for a hidden input:

```twig
{{ hiddenInput('entryId', 100) }}
{# Output: <input type="hidden" name="entryId" value="100"> #}
```

Refer to the [Functions](../reference/twig/functions.md) page for a full list of functions available to your Craft templates.

## Filters

Filters are like functions, but they use a pipe syntax (`|`), and they are always meant to manipulate a value of some sort. For example, Craft provides an [markdown](../reference/twig/filters.md#markdown-or-md) filter, which converts [Markdown](https://daringfireball.net/projects/markdown/)-formatted text into HTML:

```twig
{% set text = "I **really** love Tom Petty." %}
{{ text|markdown }}
{# Output: <p>I <strong>really</strong> love Tom Petty.</p> #}
```

You can chain filters together. Each subsequent filters will use the result of the previous filter as its starting point.

```twig
{% set text = "I **really** love Tom Petty." %}
{{ text|markdown|striptags|upper }}
{# Output: I REALLY LOVE TOM PETTY. #}
```

Note that filters will only apply to the value that immediately precedes it. If you want to apply the filter to the result of an expression, you must wrap the expression in parentheses first.

```twig
{{ 100.3 + 50.3|round }}
{# Output: 150.3 #}

{{ (100.3 + 50.3)|round }}
{# Output: 151 #}
```

Refer to the [filters](../reference/twig/filters.md) page for a full list of filters available to your Craft templates.

## Tests

Tests are like functions that only return `true` or `false`, and are meant to reveal something about the nature of a value. For example, the [defined](https://twig.symfony.com/doc/3.x/tests/defined.html) test will return `true` or `false` depending on whether a variable or hash/object property is defined:

```twig
{% if specs.weight is defined %}
  <dt>Weight</dt>
  <dd>{{ specs.weight }}</dd>
{% endif %}
```

If you are looking for whether a test returns `false`, use the `is not` syntax:

```twig
{% if entry is not defined %}
  {% exit 404 %}
{% endif %}
```

Refer to the [Tests](../reference/twig/tests.md) page for a full list of filters available to your Craft templates.

## Types of values

There are six types of [literal](https://twig.symfony.com/doc/3.x/templates.html#literals) values that have specific syntaxes or features in Twig, as well as the special `null` type.

- [Strings](#strings)
- [Numbers](#numbers)
- [Booleans](#booleans)
- [Arrays](#arrays)
- [Hashes](#hashes)
- [Arrow functions](#arrow-functions)

Let’s take a look at each of them in detail.

::: tip
Craft exposes many other types of data to templates that don’t fit squarely into these groups—if you encounter an error and aren’t sure how to work with a value, try passing it to the `dump()` function to print some debugging information about it:

```twig
{{ now }} {# -> Error! #}
{{ dump(now) }} {# ->  object(DateTime) ...  #}
```

In this case, the [`now` variable](../reference/twig/global-variables.md#now) was a [`DateTime` object](https://www.php.net/manual/en/class.datetime.php). Each object or “class” will have different properties and methods you can use—but it may take some independent research to figure out what they are:

```twig
{{ now.format('Y') }} {# -> 2022 #}
```
:::

### Strings

Textual values are called **strings**. To identify a string, wrap some text in either double or single quotation marks (but _not_ curly/smart quotes).

```twig
{% set greeting = "Hello there" %}
```

Once you’ve started a string, Twig will keep parsing it until it comes across another matching quotation mark. Which means that you can safely add other quotation marks inside the string—as long as it’s not the same type of quotation mark.

```twig
{% set heading = 'Try the new 7" folding tablet' %}
{% set subheading = "The original Microsoft Surface was 3.5' long." %}
```

If you need to use both types of quotation marks in the same string, you can place a backslash (`\`) right before the one that matches the string’s opening delimiter to “escape” it from being parsed as the closing delimiter.

```twig
{% set subheading = "The original Microsoft Surface was 3' 6\" long." %}
```

#### Combining strings

Twig provides two ways to combine strings together: You can concatenate them using the **tilde** (`~`) operator, or you can inject a string into the middle of another string using **interpolation**.

```twig
{# Concatenation #}
{% set greeting = "Hello, " ~ currentUser.friendlyName %}

{# Interpolation #}
{% set greeting = "Hello, #{currentUser.friendlyName}" %}
```

::: tip
Interpolation only works in double-quoted strings. Any valid Twig _expression_ can be interpolated!
:::

### Numbers

Numbers can be written verbatim without any special delimiters.

```twig
{% set answer = 42 %}
```

Numbers can be output in a print statement, or combined with a string.

```twig
<p>The answer is {{ answer }}</p>
```

### Booleans

Boolean values are either `true` or `false`. Those are reserved words in Twig, so if you want to create a boolean value, you just type it out.

```twig
{% set havingABud = true %}
```

Booleans are most often used within [conditionals](#conditionals), which switch a part of the template on or off depending on an expression.

If you were to output a boolean value in a print statement, or combine it with another string, the value will be converted to either `'1'` or `'0'`.

### Arrays

Arrays are ordered lists of nested values. They are delimited with left and right square brackets (`[` and `]`), and their values are separated by commas.

```twig
{% set todoList = [
  'Finish design',
  'Build HTML & CSS',
  'Manage content with Craft'
] %}
```

You can loop over an array using a [for](https://twig.symfony.com/doc/3.x/tags/for.html) tag:

```twig
<ol class="todo">
  {% for item in todoList %}
    <li>{{ item }}</li>
  {% endfor %}
</ol>
```

Note that you can’t output an array directly in a print statement, or combine it with another string. If you want to quickly output a comma-separated list of an array’s values, you could use the [join](https://twig.symfony.com/doc/3.x/filters/join.html) filter:

```twig
{{ todoList|join(', ') }}
```

### Hashes

Hashes are similar to [arrays](#arrays), except that the values are indexed by custom **keys**.

To define a hash, use left and right curly braces as the delimiters (`{` and `}`). Separate your hash’s key-value pairs with commas, like arrays, and separate the individual keys from the values with a colon.

```twig
{% set specs = {
  length: '108cm',
  width: '68.6cm',
  height: '53.3cm',
  weight: '90kg'
} %}
```

If you need to create a hash with a dynamic key, wrap the key in parentheses:

```twig{5}
{% set myKey = 'weight' %}
{% set myValue = '90kg' %}

{% set specs = {
  (myKey): myValue
} %}
```

Like arrays, you can loop over all the values in a hash using a [for](https://twig.symfony.com/doc/3.x/tags/for.html) tag:

```twig
<dl class="specs">
  {% for key, value in specs %}
    <dt>{{ key }}</dt>
    <dd>{{ value }}</dd>
  {% endfor %}
</dl>
```

You can also access hash values directly by their keys, using either dot or array syntax:

```twig
<dl class="specs">
  <dt>Dimensions</dt>
  <dd>{{ specs.length }} × {{ specs.width }} × {{ specs.height }}</dd>

  <dt>Weight</dt>
  <dd>{{ specs['weight'] }}</dd>
</dl>
```

### Arrow functions <Since ver="5.6.0" feature="Twig arrow functions allowed in any context" />

Arrow functions are compact, single-statement functions that you define in-line.

For example, Craft’s [group](../reference/twig/filters.md#group) filter accepts an arrow function, which is executed once for each item in an array to determine the key it will be grouped by.

```twig{9}
{% set groceryList = [
  {name: 'Eggs', category: 'Dairy'},
  {name: 'Pancake Mix', category: 'Breakfast'},
  {name: 'Milk', category: 'Dairy'},
  {name: 'Onions', category: 'Produce'}
] %}

{# output the list by category #}
{% set itemsByCategory = groceryList|group(item => item.category) %}
{% for category, items in itemsByCategory %}
  <h3>{{ category }}</h3>
  <ul>
    {% for item in items %}
      <li>{{ item.name }}</li>
    {% endfor %}
  </ul>
{% endfor %}
```

::: tip
Prior to Craft 5.6.0 (which uses Twig 3.15), arrow functions were allowed in more limited contexts, like some [functions](#functions) and [filters](#filters).
:::

Arrow functions are particularly useful when working with [Collections](collections.md):

```twig{5}
{% set vendorsByRating = craft.entries()
  .section('vendors')
  .with('reviews')
  .collect()
  .sortBy((v) => v.reviews.pluck('score').avg()) %}

{# -> Vendor entries sorted by highest average rating score #}
```

## Operators

You have a wide variety of operators at your disposal for simple and complex arithmetic, string manipulation, and logical comparisons

## Loops

You’ll frequently need to loop over multiple items in an [array](#arrays) or [hash](#hashes). To do that, you’ll use a [for](https://twig.symfony.com/doc/3.x/tags/for.html) tag.

```twig{8-10}
{% set todoList = [
  'Finish design',
  'Build HTML & CSS',
  'Manage content with Craft'
] %}

<ol class="todo">
  {% for item in todoList %}
    <li>{{ item }}</li>
  {% endfor %}
</ol>
```

Hashes give you access to both the key _and_ value, within the loop:

```twig
{% set colors = {
  red: '#F00',
  green: '#0F0',
  blue: '#00F',
} %}

{% for name, hex in colors %}
  <span style="color: {{ hex }}">{{ name|title }}</span>
{% endfor %}
```

The same syntax works for arrays, but exposes the numeric index. In both cases, you get access to a [`loop` variable](https://twig.symfony.com/doc/3.x/tags/for.html#the-loop-variable), with a number of useful properties.

## Conditionals

Your templates can contain **conditionals**, which are initiated by an [if](https://twig.symfony.com/doc/3.x/tags/if.html) tag, which contains an expression that will be evaluated as either `true` or `false`, and will show part of a template depending on the result of that expression.

```twig
{% if currentUser %}
  <p>Hello, {{ currentUser.friendlyName }}</p>
{% endif %}
```

You can include an `{% else %}` tag to show a different part of your template when the condition is `false`:

```twig
{% if currentUser %}
  <a href="/logout">Logout</a>
{% else %}
  <a href="/login">Login</a>
{% endif %}
```

You can also include intervening `{% elseif %}` tags (before the `{% else %}` tag, if there is one), to create additional fallback conditions in the event that the original condition is `false`:

```twig
{% set hour = now|date('G') %}

{% if hour < 12 %}
  <p>Good morning, {{ currentUser.friendlyName }}</p>
{% elseif hour < 17 %}
  <p>Good afternoon, {{ currentUser.friendlyName }}</p>
{% else %}
  <p>Good evening, {{ currentUser.friendlyName }}</p>
{% endif %}
```

::: tip
If you want to switch between different parts of your template depending on the value of something, Craft’s [switch](../reference/twig/tags.md#switch) tags provide a simpler syntax than multiple `{% if %}` and `{% elseif %}` tags each comparing the same value over and over again.
:::

### Existence and Truthiness

A common pattern for conditional rendering is testing whether a value is empty or exists at all. Some values may behave differently than you might expect!

#### Dealing with Undefined Values

Twig has a few features that help you write more resilient templates. When you suspect a value may not exist (say, in an [`include`](#includes)), use the [`defined`](https://twig.symfony.com/doc/3.x/tests/defined.html) test:

```twig
{% if style is defined %}
  {% set classNames = "tip tip--#{style}" %}
{% else %}
  {% set classNames = "tip tip--plain" %}
{% endif %}
```

This ensures that the `style` variable exists before we try and use it. Accessing an undefined variable or property when Craft’s Twig environment has [`strict_variables`](https://twig.symfony.com/doc/3.x/api.html#environment-options) enabled (set when [`devMode`](config5:devMode) is _on_) will result in an [error](#handling-errors). When `devMode` is _off_, Twig will suppress those errors and treat undefined values as `null`.

Given this template…

```twig
{% set duration = 500 %}
{% set config = {
  delay: 100,
} %}
```

…you can expect these results:

Expression | Result
--- | ---
`duration` | Value (Integer)
`animation` | Error
`duration is defined` | `true`
`animation is defined` | `false`
`config` | Value (Object)
`config is defined` | `true`
`config.delay` | Value (Integer)
`config.timingFunction` | Error
`config.delay is defined` | `true`
`config.timingFunction is defined` | `false`

::: warning
When `devMode` is on, any row indicating “Error” will instead produce a `null` value.
:::

#### Emptiness

What about values that we’re confident are _defined_, but may not contain usable data? Let’s look at some features that give us better information about the contents of a variable.

With the exception of `'0'` (a string containing only a zero), the “emptiness” of values in Twig is fairly straightforward:

Value | `is empty` | Truthy?
--- | --- | ---
`null` | <check-mark label="Yes" /> | <x-mark label="No" />
`true` | <x-mark label="No" /> | <check-mark label="Yes" />
`false` | <x-mark label="No" /> | <x-mark label="No" />
`1` | <x-mark label="No" /> | <check-mark label="Yes" />
`0` | <x-mark label="No" /> | <x-mark label="No" />
`''` | <check-mark label="Yes" /> | <x-mark label="No" />
`'A'` | <x-mark label="No" /> | <check-mark label="Yes" />
`[]` | <check-mark label="Yes" /> | <x-mark label="No" />
`{}` | <check-mark label="Yes" /> | <x-mark label="No" />
`'1'` | <x-mark label="No" /> | <check-mark label="Yes" />
`'0'` | <x-mark label="No" /> | <x-mark label="No" />

All of the values above are still considered _defined_—whether they’re used verbatim or assigned to a variable. Note the distinctions between what is considered “empty” and “truthy,” though!

To help streamline these checks, the `default` filter and [null coalesce operator](https://twig.symfony.com/doc/3.x/templates.html#other-operators) protect against undefined _and_ empty (or specifically `null`) values. Our example from earlier could be simplified with either of these:

::: code
```twig Default
{% set classNames = "tip tip--#{style|default('plain')}" %}
```
```twig Null Coalesce
{% set classNames = "tip tip--#{style ?? 'plain'}" %}
```
:::

The first example will use `'plain'` when `style` is undefined or empty (according to the table above), but the second will only use `'plain'` when `style` is undefined or exactly `null`—so the null coalesce operator may produce undesirable output when provided an empty string.

::: tip
Keep in mind that the order Twig templates are rendered in can affect when and where variables are available. The content of a [layout](#template-inheritance), for example, is only processed _after_ the template that extends it, so variables defined in the layout are not available in the template.
:::

#### Complex Objects

::: warning
This section treads into some heavier programming concepts, and makes reference to a number of PHP classes belonging to Craft and Yii.

These objects are authoritatively documented in the [class reference](https://docs.craftcms.com/api/v5/). You will find references to methods and properties of common objects here in the main documentation, but to make the best use of them, some independent research may be required.
:::

So far, we’ve mostly looked at plain values—but Craft exposes a number of _objects_ to your templates, like elements (an <craft5:craft\elements\Entry> or <craft5:craft\elements\Asset> for instance) or services (accessible via [`craft.app`](../reference/twig/global-variables.md#craft-app)).

When in doubt about the type of value you’re dealing with (or you encounter a [Twig error](#handling-errors) when attempting to use them), use the [`{% dump %}` tag](../reference/twig/tags.md#dump) to output them to the debug toolbar.

::: tip
Using an undefined variable in the dump tag will still trigger an error. If this happens, dump the entire context by passing nothing to the tag.
:::

#### Negation

The `not` operator takes the boolean equivalent of any value and flips it. It can also invert the result of a test, or combined with `defined`:

```twig
{# If we know the variable exists: #}
{% if var is not empty %}
  {# There’s a value! #}
{% endif %}

{# If we aren’t sure (and the above might blow up): #}
{% if var is defined and var is not empty %}
  {# The value is definitely useful! #}
{% endif %}
```

#### Identity

Instead of a strict-equality operator (`===` in PHP and other languages), Twig has a `same as(...)` [test](../reference/twig/tests.md) for comparing values and objects. Plain values with the same type (like numbers and strings) will work as expected, but objects (like elements) may _not_.

In an entry’s template, for example, comparing the automatically-injected `entry` with results from a second query is unreliable:

```twig
{% set category = entry.topic.one() %}
{% set relatedPosts = craft.entries
  .section('blog')
  .relatedTo(category)
  .all() %}

{% for post in relatedPosts %}
  {% if post is not same as(entry) %}
    {# Whoops! Our original post is still output in the related items! #}
  {% endif %}
{% endfor %}
```

This is a result of the `relatedPosts` query loading and populating a _second_ copy of the original `entry` element. Strict comparison considers these different _objects_, despite them containing data that refers to the same _post_.

Instead of comparing entire objects, consider using unique, identifying properties thereof:

```twig
{% if entry.id == relatedEntry.id %}
  {# Same entry! #}
{% endif %}
```

::: tip
In this case, it might make more sense to exclude the original entry using [element query params](element-queries.md).
:::

### Elements and Queries

[Element queries](element-queries.md) will always evaluate as “truthy” before they’re executed. In order to reliably test against the _results_, you must call a query execution method that agrees with your anticipated usage:

- If you only care about whether one or more elements match the query, use `.exists()`;
- If you only care about the _number_ of elements that would match the query, use `.count()`;
- If you will use the result(s) later, use `.one()` or `.all()`;

The last option here can be combined with the `is empty` test or `length` filter to produce the same logical result as the first two.

## Handling Errors

Errors can come from a number of places throughout the system, but the most common ones will be:

- **Syntax Error** (`Twig\Error\SyntaxError`): Something went wrong when compiling a template. You may have mismatched brackets, an invalid function or filter, or a variety of other problems with the template itself that prevent it from working as expected. The error will point to the line in your template where Twig believes the error originates.
- **Runtime Error** (`Twig\Error\RuntimeError`): Oftentimes indicative of a missing variable or property, or another issue as the compiled template is being executed.
- **Loader Error** (<craft5:craft\web\twig\TemplateLoaderException> or `Twig\Error\LoaderError`): A reference to template (say, when using the `include` tag) could not be resolved.

You may see other errors throughout development—but they are typically the result of a lower-level issue like improper use of methods, database connectivity, or templates getting out of sync with [project config](../system/project-config.md).

With [devMode](config5:devMode) on, Craft will output a stack trace for any errors it encounters when rendering a template.

<BrowserShot
  url="https://my-project.ddev.site/example"
  :link="false"
  caption="Example Twig error reporting view.">
<img src="../images/twig-errors.png" />
</BrowserShot>

::: tip
You can always enable **Show full exception views when Dev Mode is disabled** in your user’s preference screen to force the full exceptions to be shown. This does _not_ change the behavior of the Twig environment, though, so you will not see errors for missing or [undefined variables](#dealing-with-undefined-values) and properties.
:::

The first error in a template will throw an exception and halt rendering, so you must fix that issue before getting information about any subsequent errors.

## DRY Templating

Whenever you’re coding anything, it’s always a good practice to keep your code “DRY” (Don’t Repeat Yourself), to avoid writing and maintaining the same general logic or HTML in multiple places. This applies to Twig as well: each page on your website is likely to have the same header and footer, and the vast majority of your pages should be made up of shared, reusable components.

Twig provides four ways to keep your templates DRY:

- [Template inheritance](#template-inheritance)
- [Includes](#includes)
- [Embeds](#embeds)
- [Macros](#macros)

### Template inheritance

Twig templates can **extend** other templates, filling in more details than their parent. This concept is called **template inheritance** because sub-templates _inherit_ a base set of HTML from their parent.

For example, you can create an `_html5.twig` template in your `templates/` folder, which defines the base HTML boilerplate that _all_ pages on your website should have:

```twig
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="{{ currentSite.language }}">
<head>
  {% block head %}
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>{{ docTitle ?? siteName }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  {% endblock %}
</head>
<body {{ attr(bodyAttributes ?? {}) }}>
  {% block body %}
  {% endblock %}
</body>
</html>
```

This template is pretty worthless on its own, but it provides a framework for nested templates to take advantage of:

- It defines `head` and `body` **blocks**, which give nested templates a way to override the contents of the `<head>` and `<body>` elements.
- It allows nested templates to define a `docTitle` variable, which will become the `<title>` value, and defaults to the site name if that’s not defined.
- It gives nested templates the ability to set custom attributes on the `<body>` element, by defining a `bodyAttributes` hash. (We’re using the [attr](../reference/twig/functions.md#attr) function to convert that hash into a list of HTML attributes.)

With that template in place, you can now create a `hello-world.twig` template in your `templates/` folder, which **extends** your `_html5.twig` template:

```twig
{% extends "_html5.twig" %}

{% set docTitle = 'Hello World' %}

{% set bodyAttributes = {
  class: 'hello-world'
} %}

{% block head %}
  {{ parent() }}
  <link rel="stylesheet" type="text/css" href="/styles.css">
{% endblock %}

{% block body %}
  <h1>Hello world!</h1>
{% endblock %}
```

This template is doing a few things:

- It’s declaring that it is meant to **extend** our `_html5.twig` template.
- It’s setting `docTitle` and `bodyAttributes` variables, which will be passed up to the parent template.
- It’s overriding the parent template’s `head` and `body` blocks.
- It’s pulling the parent template’s `head` block contents into the overridden block, via that `{{ parent() }}` print statement.

Note that when a template extends another template, it must define _all_ of its HTML within `block`s.

::: tip
A layout can `extend` another layout, too! Suppose your site has two distinct areas, and they have markedly different navigation needs: content pages could directly extend `html5.twig`, while all the account/portal pages could extend an intermediate `dashboard.twig` that shows a toolbar with secondary navigation items.

Craft’s [control panel](../system/control-panel.md) uses this exact strategy to provide a consistent experience throughout deeply-nested content and configuration pages.
:::

### Includes

You can create “partial” templates, which only output the HTML for an individual component, and then include them within other templates using an [include](https://twig.symfony.com/doc/3.x/tags/include.html) tag.

For example, create a template called `_tip.twig` in your `templates/` folder, with this:

```twig
<div class="tip">
  <h6>Tip</h6>
  <p>{{ tipText }}</p>
</div>
```

Now you can include that from another template, passing in the `tipText` value:

```twig
{% include '_tip.twig' with {
  tipText: 'I’m a helpful tip!'
} %}
```

### Embeds

Embeds are similar to [includes](#includes), with a superpower: they can override template blocks _within_ the included template. Going with our tip example, let’s say you want to make the content more customizable. you could do that by wrapping the `<p>` tag in a block:

```twig
<div class="tip">
  <h6>Tip</h6>
  {% block content %}
    <p>{{ tipText }}</p>
  {% endblock %}
</div>
```

The template will continue to work with [include](https://twig.symfony.com/doc/3.x/tags/include.html) tags like before, but now other templates have the option of using an [embed](https://twig.symfony.com/doc/3.x/tags/embed.html) tag instead, and overwriting the entire `content` block:

```twig
{% embed '_tip.twig' %}
  {% block content %}
    <p>I’m a helpful tip!</p>
  {% endblock %}
{% endembed %}
```

### Macros

Your templates can define **macros**, which are reusable functions that output HTML. These are especially useful when a template needs to output similar HTML multiple times, but it’s not worth using an [include](#includes) because no other templates are going to need it.

For example, let’s say you find yourself repeating the same HTML and Twig code for each the global nav items in your site layout template:

```twig
<nav class="global-nav">
  <ul>
    <li class="nav-item"><a href="{{ url('about') }}">About</a></li>
    <li class="nav-item"><a href="{{ url('blog') }}">Blog</a></li>
    <li class="nav-item"><a href="{{ url('contact') }}">Contact</a></li>
  </ul>
</nav>
```

You could pull that `<li>` HTML into a [macro](https://twig.symfony.com/doc/3.x/tags/macro.html) tag, and then call it for each of your nav items instead:

```twig
{% macro navItem(label, path) %}
  <li class="nav-item"><a href="{{ url(path) }}">{{ label }}</a></li>
{% endmacro %}

<nav class="global-nav">
  <ul>
    {{ _self.navItem('About', 'about') }}
    {{ _self.navItem('Blog', 'blog') }}
    {{ _self.navItem('Contact', 'contact') }}
  </ul>
</nav>
```

::: tip
You can import macros from other templates using an [import](https://twig.symfony.com/doc/3.x/tags/import.html) tag.
:::

## Additional resources

To learn more about Twig, check out these resources:

- [Twig for Template Designers](https://twig.symfony.com/doc/3.x/templates.html) – Twig’s official templating documentation
- [Twig Templates in Craft](https://craftquest.io/courses/twig-templates-in-craft) – CraftQuest’s 12-part video course introducing Twig templating in Craft
</file>

<file path="extend/asset-bundles.md">
# Asset Bundles

Plugins, like Craft, are supposed to be installed above the web root, which ensures that their files can’t be accessed directly via HTTP requests. Generally that’s a Very Good Thing, because it protects Craft sites from a whole host of security vulnerabilities.

There’s one case where it would be nice if HTTP requests _could_ access Craft/plugin files directly though: front-end resources, such as images, CSS, and JavaScript files. Thankfully, Yii has a concept called [Asset Bundles](https://www.yiiframework.com/doc/guide/2.0/en/structure-assets) to help with this.

Asset Bundles do two things:

- They publish an inaccessible directory into a directory below the web root, making it available for front-end pages to consume via HTTP requests.
- They can register specific CSS and JS files within the directory as `<link>` and `<script>` tags in the currently-rendered page.

### Setting it Up

First establish where you want your web-publishable files to live within your plugin. Give them a directory that’s just for them. This will be the asset bundle’s **source directory**. For this example, we’ll go with `resources/`.

Then, create a file that will hold your asset bundle class. This can be located and named whatever you want. We’ll go with `FooBundle` here.

Here’s what your plugin’s structure should look like:

```treeview
base_dir/
└── src/
    ├── FooBundle.php
    └── resources/
        ├── script.js
        ├── styles.css
        └── ...
```

Use this template as a starting point for your asset bundle class:

```php
<?php
namespace mynamespace;

use craft\web\AssetBundle;
use craft\web\assets\cp\CpAsset;

class FooBundle extends AssetBundle
{
    public function init()
    {
        // define the path that your publishable resources live
        $this->sourcePath = '@mynamespace/resources';

        // define the dependencies
        $this->depends = [
            CpAsset::class,
        ];

        // define the relative path to CSS/JS files that should be registered with the page
        // when this asset bundle is registered
        $this->js = [
            'script.js',
        ];

        $this->css = [
            'styles.css',
        ];

        parent::init();
    }
}
```

::: tip
`@mynamespace` is a placeholder for your plugin’s auto-generated [Yii alias], which will be based on your plugin’s root namespace. It represents the path to your plugin’s `src/` directory.
:::

Asset bundles can share a `sourcePath`. If you anticipate registering many bundles, it may be worthwhile to put them in an `assetbundles/` subdirectory within your plugin’s `src/` folder—just don’t forget to update your namespaces!

### Registering the Asset Bundle

With that in place, all that is left is to register the asset bundle wherever its JS/CSS files are needed.

You can register it from a template using this code:

```twig
{% do view.registerAssetBundle("mynamespace\\FooBundle") %}
```

Or if the request is getting routed to a custom controller action, you could register it from there, before your template gets rendered:

```php
use mynamespace\FooBundle;

public function actionFoo()
{
    $this->view->registerAssetBundle(FooBundle::class);

    return $this->renderTemplate('plugin-handle/foo');
}
```

### Getting Published File URLs

If you have a one-off file that you need to get the published URL for, but it doesn’t need to be registered as a CSS or JS file on the current page, you can use <craft5:craft\web\AssetManager::getPublishedUrl()>:

```php
$url = \Craft::$app->assetManager->getPublishedUrl(
    '@mynamespace/path/to/file.svg',
    true
);
```

Craft will automatically publish the file for you (if it’s not published already), and return its URL.

If you want the file to be published alongside other files in the same directory, but you only want a single file’s URL, then split its path into two parts: 1) the path to the parent directory that contains all the files you want to publish; and 2) the path to the individual file you want the URL for, relative to that parent directory.

For example, if you had a bunch of icon SVG files in an `icons/` folder within your plugin, and you wanted to publish the `icons/` folder as a whole, but only needed the URL to `shaker.svg`, you would do this:

```php
$url = \Craft::$app->assetManager->getPublishedUrl(
    '@mynamespace/icons',
    true,
    'shaker.svg'
);
```

::: tip
`@mynamespace` is a placeholder for your plugin’s auto-generated [Yii alias], which will be based on your plugin’s root namespace. It represents the path to your plugin’s `src/` directory.
:::

[yii alias]: https://www.yiiframework.com/doc/guide/2.0/en/concept-aliases
</file>

<file path="extend/behaviors.md">
---
description: Behaviors enable plugins to decorate built-in classes with native-feeling attributes and methods.
---

# Behaviors

[Behaviors](guide:concept-behaviors) are a feature of Yii [Components](guide:concept-components), and functionally similar to “mixins” in other frameworks or programming paradigms. A behavior can provide additional properties and methods to its owner, without needing to subclass or replace built-in components.

::: tip
A behavior’s methods and properties are not actually defined on the owner, but accessed as part of Yii’s magic <yii2:yii\base\Component::__get()> and <yii2:yii\base\Component::__call()> implementations. We’ll follow this logic in the [usage](#usage) section, below.
:::

Every class that extends <craft5:craft\base\Model> (in effect, virtually all core system components and data objects) automatically emits [events](events.md) that make it easy to attach custom behaviors at runtime. Some classes that _don’t_ inherit from `craft\base\Model` follow a similar pattern (like <craft5:craft\web\Controller>) and emit an `EVENT_DEFINE_BEHAVIORS` event.

In this example, we’re going to give a subset of entries (within a “Posts” section) a special `getAuthorUrl()` method to standardize how we link to author indexes in our site’s front-end.

## Behavior Class

A behavior is a special type of class that extends <yii2:yii\base\Behavior>, and defines methods or properties that you wish to make available on any object it is eventually attached to.

```php
namespace mynamespace\myplugin\behaviors;

use craft\helpers\UrlHelper;
use yii\base\Behavior;

class Post extends Behavior
{
    public function getAuthorUrl(): ?string
    {
        $author = $this->owner->getAuthor();

        if (!$author) {
            return null;
        }

        return UrlHelper::siteUrl("authors/{$author->id}");
    }
}
```

Your [IDE](README.md#ide) may complain about the `$owner` property not having a `getAuthor()` method. You can “type-hint” this with a class-level docblock:

```php
/**
 * @property craft\elements\Entry $owner
 */
class Post extends Behavior
{
    // ...
}
```

## Attachment

In your plugin’s `init()` method, register an event handler on <craft5:craft\elements\Entry::EVENT_DEFINE_BEHAVIORS>:

```php
use yii\base\Event;
use craft\elements\Entry;
use craft\events\DefineBehaviorsEvent;
use mynamespace\myplugin\behaviors\Post;

Event::on(
    Entry::class,
    Entry::EVENT_DEFINE_BEHAVIORS,
    function(DefineBehaviorsEvent $e) {
        $section = $e->sender->getSection();

        // Is it relevant to this entry?
        if ($section->handle !== 'blog') {
            return;
        }

        $e->behaviors['post'] = Post::class;
    }
);
```

Here, we’re only bothering to attach the behavior to entry elements that belong to the `blog` section.

::: tip
This event registration signature is consistent across any class that emits the `EVENT_DEFINE_BEHAVIORS` event:

- Subclasses of <craft5:craft\base\Model>, <craft5:craft\db\ActiveRecord>, <craft5:craft\db\Query>, and <craft5:craft\web\Controller>
- <craft5:craft\web\twig\variables\CraftVariable>
:::

### Configuration

Behaviors can also be attached to system components as they’re initialized, with [application configuration](../reference/config/app.md):

```php app.web.php
use craft\web\ErrorHandler;
use mynamespace\myplugin\behaviors\RedirectBehavior;

return [
    // ...
    'components' => [
        'errorHandler' => [
            'as customRedirectHandler' => RedirectBehavior::class,
        ],
    ],
];
```

This behavior can then add event handlers, provide additional methods, and so on.

::: warning
If your goal is to expose functionality to developers (say, via Craft’s Twig-accessible `craft.app` APIs), consider implementing that logic in a helper class, a [Twig extension](extending-twig.md), or a behavior attached to `<craft5:craft\web\twig\variables\CraftVariable>`.
:::

### Late Attachment

Some classes will be instantiated prior to your plugin [initializing](plugin-guide.md#initialization), and registering its `EVENT_DEFINE_BEHAVIORS` handler. In these cases, you may need to retroactively attach a behavior to specific objects:

```php
// Load all the known/memoized instances of a model:
$sites = Craft::$app->getSites()->getAllSites(true);

// Attach the behavior to each one, manually:
foreach ($sites as $site) {
    $site->attachBehavior('myplugin:geolocation', Geolocation::class);
}

// Attach to any other models that are instantiated later:
Event::on(
    Site::class,
    Site::EVENT_DEFINE_BEHAVIORS,
    function(DefineBehaviorsEvent $event) {
        $event->behaviors['myplugin:geolocation'] = Geolocation::class;
    }
);
```

Models that are _not_ memoized like the <craft5:craft\models\Site>s above (and inaccessible via Craft’s public APIs) may be more difficult (or impossible) to retroactively attach behaviors to. In these situations, you can try a [configuration](../reference/config/app.md)-based approach, or look for an [event](events.md) that exposes it. This can also be an indication that the object has limited extensibility.

### Naming

A name is not _required_ when attaching a behavior, but can become important if its methods or properties collide with those defined by the owner or another behavior. In the example above, we’re attaching the `Post` behavior as `post`, which will allow us to access it explicitly, in the future:

```php
$url = $entry->getBehavior('post')->getAuthorUrl();
```

This also makes it possible to detach a behavior, should you no longer need it:

```php
$entry->detachBehavior('post');
```

### Events

Behaviors can automatically bind [events](events.md) to their owners by defining an `events()` method and returning a map of event names (as keys) to methods (as values). This is a great way to collocate event handlers and functionality when they are already tightly coupled:

```php
public function events()
{
    return [
        Entry::EVENT_SET_ROUTE => [$this, 'defineRoute'],
    ];
}

public function defineRoute(SetElementRouteEvent $event)
{
    $event->route = '...';
}
```

Handlers registered in this way will only receive events emitted by the owner. If you need to respond to events on _all_ instances of a class, you will need to attach your behavior to every instance, or use a [class-level event listener](events.md#class-level-events).

Read more about behaviors in the [Yii guide](guide:concept-behaviors#handling-component-events).

## Usage

With the behavior attached to a class, its properties and methods will be available everywhere that instance is used:

```php
$url = $entry->getAuthorUrl();
```

That means you (or your plugin’s users) can take advantage of convenience features in their Twig templates, too:

```twig
{{ entry.getAuthorUrl() }}
```

### How it Works

We alluded to “magic” methods, earlier—these are special PHP features that allow classes to intercept attempts to access properties or call methods that don’t exist on it (or any of its parent classes) and handle them on a case-by-case basis (rather than immediately throwing an exception).

<yii2:yii\base\Component> implements a few of these:

`__get()`
: This is called when accessing an undefined property. It receives the desired property name as an argument, and checks if any of the component’s behaviors define it, and returns that value.

`__call()`
: This performs an equivalent function to `__get()`, but for methods. It receives the called method as an argument, and checks if it is defined by any attached behaviors.

::: warning
Yii also uses `__get()` (and another magic method, `__set()`) to create “virtual” public properties. For example, a class may have a private `$_data` property, then implement `getData()` and `setData()` methods; it’s possible, then, to access `$model->data` or set `$model->data = 'value'` without there being a property

However: Yii will always attempt to resolve native `getMyCustomProperty()` and `setMyCustomProperty()` methods before looking for a `myCustomProperty` property on any attached behaviors. Special care should be taken when naming behavior properties so as to avoid conflicts or ambiguity when attached to a parent class. Should this be unavoidable, you can directly access a behavior via `$class->getBehavior('behaviorName')`.

Consider accessing properties and calling methods of behaviors you own via their registered [names](#naming), rather than magic methods.
:::

<Todo notes="This would be a perfect place to include some information about adding custom columns to elements." />
</file>

<file path="extend/changelogs-and-updates.md">
# Changelogs and Updates

When you [publish](plugin-store.md) your plugin in the Plugin Store, its changelog is automatically scraped and displayed in a dedicated tab, as well as in Craft’s <Journey path="Utilities, Updates" /> screen wherever it is installed.

::: tip
Refer to [Craft’s own changelog](https://github.com/craftcms/cms/blob/5.x/CHANGELOG.md) as an example of syntax and best practices.
:::

## Setting Up a Changelog

Create a `CHANGELOG.md` file at the root of your plugin’s repo, where you can start documenting release notes for your plugin. Use something like this as a starting point:

```markdown
# Release Notes for <Plugin Name>
```

Within the changelog, releases must be listed in **descending order** (newest-to-oldest). When displaying available plugin updates, the Plugin Store will stop parsing a plugin’s changelog as soon as it finds a version that is older than or equal to the user’s installed version.

## Version Headings

Version headings in your changelog must follow this format:

```markdown
## X.Y.Z - YYYY-MM-DD
```

There’s a little wiggle room on that:

- Other text can come before the version number, like the plugin’s name.
- A 4th version number is allowed (e.g. `1.2.3.4`).
- Prerelease versions are allowed (e.g. `1.0.0-alpha.1`).
- The version can start with `v` (e.g. `v1.2.3`).
- The version can be hyperlinked (e.g. `[2.0.0](https://domain.com/blog/whats-new-in-v2)`).
- Dates can use dots as separators, rather than hyphens (e.g. `2024.04.18`).

Any level-two headers (`##`) that _don’t_ follow this format will be ignored, as will any content that follows them (until the next valid level-two heading).

## Release Notes

All content that follows a version heading (up to the next version heading) will be treated as the release notes for the update.

When writing release notes, we recommend that you follow the guidelines at [keepachangelog.com](https://keepachangelog.com/), but all forms of [GitHub Flavored Markdown](https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax#GitHub-flavored-markdown) are allowed. The only thing that is *not* allowed is actual HTML—raw markup will be escaped.

### Alerts

You can include notes and warnings in your release notes using [GitHub’s alert syntax](https://github.com/orgs/community/discussions/16925):

```markdown
> [!NOTE]  
> Highlights information that users should take into account, even when skimming.

> [!IMPORTANT]  
> Crucial information necessary for users to succeed.

> [!WARNING]  
> Critical content demanding immediate user attention due to potential risks.
```

These alerts will each be styled appropriately within the plugin’s changelog in the Plugin Store and within the Updates utility. Updates which contain alerts will automatically be expanded in the Updates utility.

### Links

If you have any reference-style links in your release notes, you will need to define the URLs *before* the following version heading:

```markdown
## 2.0.1 - 2017-02-01
### Fixed issue [#123]

[#123]: https://github.com/pixelandtonic/foo/issues/123

## 2.0.0 - 2017-01-31
### Added
- New [superFoo] config setting

[superFoo]: https://docs.my-plugin.tld/config#superFoo
```

::: tip
Relative URLs will not work. Your changelog may appear in multiple contexts—so even if a link resolves when viewing the changelog on GitHub, it may not work from a Craft installation or the Plugin Store!
:::

## Critical Updates

If an update contains a fix for a critical security vulnerability or other dangerous bug, you can alert your users about it by adding `[CRITICAL]` to the end of the version heading:

```markdown
## 2.0.1 - 2017-01-21 [CRITICAL]
### Fixed
- Reverted change to `$potus` due to security vulnerabilities
```

When Craft finds out that a critical update is available, it will post a message about it to the top of all control panel pages, and give the update special attention on the <Journey path="Utilities, Updates" /> page.
</file>

<file path="extend/coding-guidelines.md">
# Coding Guidelines

Do your best to follow these guidelines when writing code for Craft and Craft plugins.

## Tooling

We maintain a few configurations to ensure Craft and all first-party extensions conform to the recommendations laid out in this document.

- [`craftcms/ecs`](repo:craftcms/ecs): “Easy Coding Standards,” with automatic patching.
- [`craftcms/phpstan`](repo:craftcms/phpstan): Prevent bugs with static analysis.
- [`craftcms/rector`](repo:craftcms/rector): Rector rule sets for upgrading plugins between major Craft versions.
- [`craftcms/phpstorm-settings`](repo:craftcms/phpstorm-settings): Style and inspection profiles for PhpStorm.

Use of these tools is not a requirement for inclusion in the Plugin Store, but understanding their value may help you manage a growing extension! [Contributions](repo:craftcms/cms/pulls) to Craft itself _will_ be checked against these standards.

## Code Style

Unless otherwise noted, we target PHP-FIG’s [PSR-12](https://www.php-fig.org/psr/psr-12/) “Extended Coding Style Guide” standards.

Our [ECS config](repo:craftcms/ecs) also enforces these rules:

- A trailing comma _must_ be present after the last element in an array and the last argument of a method definition, when split onto multiple lines.
- The opening parenthesis in an anonymous function declaration _must not_ be surrounded by spaces.
- Constants _must_ have a visibility declaration (PSR-12 chapter [4.3](https://www.php-fig.org/psr/psr-12/#43-properties-and-constants) makes them a condition of support, and all Craft 4-compatible code requires PHP 8.0.1 or greater).

We tend to follow these “soft” rules, as well:

- Chained method calls should each be placed on their own line, with the `->` operator at the beginning of each line.
- Strings that are concatenated across multiple lines should have the `.` operator at the ends of lines.
- Don’t put a space after type typecasts (`(int)$foo`) (See PSR-12 chapter [6.1](https://www.php-fig.org/psr/psr-12/#61-unary-operators))

::: tip
The Craft Autocomplete package provides Twig template autocompletion in PhpStorm for Craft and plugin/module variables and element types: <https://github.com/nystudio107/craft-autocomplete>
:::

## Best Practices

In addition to code style, we have some preferred ways of using language features and built-ins.

- Declare method argument and return types whenever possible.

    ```php
    public function synchronize(Entry $entry, array $data): bool
    ```

- Use strict comparison operators (`===` and `!==`) whenever possible.
- Use `$foo === null`/`$bar !== null` rather than `is_null($foo)`/`!is_null($bar)`.
- Use `(int)$foo`/`(float)$bar` rather than `intval($foo)`/`floatval($bar)`.
- Always pass `true`/`false` to the third argument of [in_array()](http://php.net/manual/en/function.in-array.php) to indicate whether the check should be type-strict (and make it `true` whenever possible).
- Use `$obj->property !== null` rather than `isset($obj->property)` in conditions that check if an object property is set.
- Use `empty()`/`!empty()` in conditions that check if an array is/isn’t empty.
- Refer to class names using the [::class](http://php.net/manual/en/language.oop5.basic.php#language.oop5.basic.class.class) keyword (`Foo::class`) rather than as a string literal (`'some\namespace\Foo'`) or <yii2:yii\base\BaseObject::className()>.
- Initialize arrays explicitly (`$array = []`) rather than implicitly (e.g. `$array[] = 'foo'` where `$array` wasn’t defined yet).
- Use `self::_foo()` rather than `static::_foo()` when calling private static functions, since `static::` would break if the class is extended.
- Use `self::CONSTANT` rather than `static::CONSTANT` (unnecessary overhead).
- Only use the `parent::` keyword when calling a parent method with the exact same name as the current method. Otherwise use `$this->`.
- Private class property/method names should begin with an underscore (`private $_foo`) (Note that PSR-12 chapter [4.3](https://www.php-fig.org/psr/psr-12/#43-properties-and-constants) only states that leading underscores are “meaningless”).
- Don’t explicitly set class properties’ default values to `null` (e.g. `public $foo = null;`).
- Always use `require` or `include` when including a file that returns something, rather than `require_once` or `include_once`.
- Use `strpos($foo, $bar) === 0` rather than `strncmp($foo, $bar, $barLength) === 0` when checking if one string begins with another string, for short strings.
- Use `$str === ''` rather than `strlen($str) === 0` when checking if a string is empty.
- Avoid using `array_merge()` within loops when possible.
- Unset variables created by reference in foreach-loops after the loop is finished.

    ```php
    foreach ($array as &$value) {
        // ...
    }
    unset($value);
    ```

- Use `implode()` rather than `join()`.
- Use `in_array()` rather than `array_search(...) !== false` when the position of the needle isn’t needed.
- Don’t use a `switch` statement when a single `if` condition will suffice.
- Use single quotes (`'`) whenever double quotes (`"`) aren’t needed.
- Use shortcut operators (`+=`, `-=`, `*=`, `/=`, `%=`, `.=`, etc.) whenever possible.
- Use shortcut regular expression patterns (`\d`, `\D`, `\w`, `\W`, etc.) whenever possible.
- Use the `DIRECTORY_SEPARATOR` constant rather than `'/'` when defining file paths.

::: tip
The [Php Inspections (EA Extended)](https://plugins.jetbrains.com/idea/plugin/7622-php-inspections-ea-extended-) PhpStorm plugin can help you locate and fix these sorts of best practice issues.
:::

## Namespaces & Class Names

Follow PSR-12 and PSR-1 standards, with the following recommendations:

- Auto-loading must conform to [PSR-4](https://www.php-fig.org/psr/psr-4/), wherein a class’s file location can be inferred by its fully qualified name, given a known base namespace mapped to a base path.
- Namespaces should be all-lowercase.
- Only first-party code should use the `craft\` and `pixelandtonic\` namespace roots. Third party plugins should use a namespace root that refers to the vendor name and plugin name (e.g. `acme\myplugin\`).

## Method Names

Getter methods (methods whose primary responsibility is to return something, rather than do something) that **don’t accept any arguments** should begin with `get`, and there should be a corresponding `@property` tag in the class’s docblock to document the corresponding magic getter property.

- `getAuthor()`
- `getIsSystemOn()`
- `getHasFreshContent()`

Getter methods that **accept one or more arguments** (regardless of whether they can be omitted) should only begin with `get` if it “sounds right.”

- `getError($attribute)`
- `hasErrors($attribute = null)`

Static methods should generally not start with `get`.

  - `sources()`
  - `displayName()`

## Type Declarations

Use [type declarations](https://www.php.net/manual/en/language.types.declarations.php) whenever possible. The only exceptions should be:

- [Magic methods](http://php.net/manual/en/language.oop5.magic.php) (e.g. `__toString()`)
- Methods that override a parent class’s method, where the parent method doesn’t have type declarations
- Methods that are required by an interface, and the interface method doesn’t have type declarations

If an argument accepts two types and one of them is `null`, a `?` can be placed before the non-`null` type:

```php
public function foo(?string $bar): void
```

::: tip
PHP 8 introduced [union types](https://www.php.net/manual/en/language.types.type-system.php#language.types.type-system.composite.union) and the [`mixed` pseudo-type](https://www.php.net/manual/en/language.types.mixed.php), which are preferred to omitting a type altogether.
:::

## Docblocks

- Methods that override subclass methods or implement an interface method, and don’t have anything relevant to add to the docblock, should only have `@inheritdoc` in the docblock.
- Use full sentences with proper capitalization, grammar, and punctuation in docblock descriptions.
- `@param` and `@return` tags should **not** have proper capitalization or punctuation.
- Use `bool` and `int` instead of `boolean` and `integer` in type declarations.
- Specify array members’ class names in array type declarations when it makes sense (`ElementInterface[]` rather than `array`). `array` is still acceptable in the actual [method signature](#type-declarations).
- Chainable functions that return an instance of the current class should use `static` as the return type declaration.
- Functions that don’t ever return anything should have `@return void`.

### Interfaces vs. Implementation Classes

`@param` , `@return` , `@var` , `@method` and `@property` tags on public service methods should reference Interfaces (when applicable), not their implementation class:

```php
// Bad:
/**
 * @param \craft\base\Element $element
 * @param \craft\base\ElementInterface|\craft\base\Element $element
 */

// Better:
/**
 * @param \craft\base\ElementInterface $element
 */
```

Inline `@var` tags should reference implementation classes, not their interfaces:

```php
// Bad:
/** @var \craft\base\ElementInterface $element */
/** @var \craft\base\ElementInterface|\craft\base\Element $element */

// Better:
/** @var \craft\base\Element $element */
```

## Control Flow

### Happy Paths

Use [them](https://en.wikipedia.org/wiki/Happy_path). In general, the execution of a method should only make it all the way to the end if everything went as expected.

```php
// Bad:
if ($condition) {
    // Do stuff

    return true;
}

return false;

// Better:
if (!$condition) {
    return false;
}

// Do stuff

return true;
```

### `if`…`return`…`else`

Don’t do this. There’s no point, and can be misleading at first glance.

```php
// Bad:
if (!$condition) {
    return $foo;
} else {
    return $bar;
}

// Better:
if (!$condition) {
    return $foo;
}

return $bar;
```

## Controllers

### Return Types

Controller actions that should complete the request must return either a string (implying a `text/html` content type) or a <craft5:craft\web\Response> object.

```php
// Bad:
$this->asJson($obj);
$this->renderTemplate($template, $variables);

// Better:
return $this->asJson($obj);
return $this->renderTemplate($template, $variables);
```

### JSON Actions

Controller actions that have the option of returning JSON should do so if the request explicitly accepts a JSON response; not if it’s an Ajax request.

```php
// Bad:
if (\Craft::$app->getRequest()->getIsAjax()) {
    return $this->asJson([...]);
}

// Better:
if (\Craft::$app->getRequest()->getAcceptsJson()) {
    return $this->asJson([...]);
}
```

Controller actions that *only* return JSON should require that the request accepts JSON.

```php
$this->requireAcceptsJson();
```

::: tip
See [Controllers](./controllers.md#handling-requests) for more information on writing content-type-agnostic actions.
:::

## Exceptions

- If an exception is likely to occur as a result of user error (and it may be displayed to them), use the <yii2:yii\base\UserException> class (or a subclass).
- Only translate exception messages with <craft5:Craft::t()> if it’s a <yii2:yii\base\UserException>.

## DB Queries

- Always wrap a table name with `{{%` and `}}` (e.g. `{{%entries}}`) so it’s properly quoted and the [table prefix](../reference/config/db.md#tableprefix) gets inserted.
- Use the `['col1', 'col2']` syntax with `select()` and `groupBy()` instead of `'col1, col2'` even if you’re only referencing a single column.
- Use the `['{{%tablename}}']` syntax with `from()` instead of `'{{%tablename}}'`.
- Use the `['col1' => SORT_ASC, 'col2' => SORT_DESC]` syntax with `orderBy()` instead of `'col1, col2 desc'`.

### Conditions
- Always use Yii’s [declarative condition syntax](yii2:yii\db\QueryInterface::where()) when possible, as it will automatically quote table/column names and values for you.
- For consistency, use:
  - `['col' => $values]`  instead of `['in', 'col', $values]`
  - `['col' => $value]`  instead of `['=', 'col', $value]`
  - `['like', 'col', 'value']` instead of `['like', 'col', '%value%', false]`
    *(unless the `%` is only needed on one side of `value`)*
- If searching for `NULL`, use the `['col' => null]` syntax.
- If searching for `NOT NULL`, use the `['not', ['col' => null]]` syntax.
- If you cannot use the declarative condition syntax (e.g. the condition is referencing another table/column name rather than a value, as is often the case with joins), make sure you’ve quoted all column names (`[[column]]`), and any values that you aren’t 100% confident are safe to add as query params.

```php
// Bad:
$query->where('foo.thing is null');
$query->innerJoin('{{%bar}} bar', 'bar.fooId = foo.id');

// Better:
$query->where(['foo.thing' => null]);
$query->innerJoin('{{%bar}} bar', '[[bar.fooId]] = [[foo.id]]');
```

## Getters & Setters

Getter and setter methods should have a corresponding `@property` tag in the class’s docblock, so IDEs like PhpStorm can be aware of the magic properties.

```php
/**
 * @property User $author
 */
class Entry
{
    private $_author;

    /**
     * @return User
     */
    public function getAuthor()
    {
        return $this->_author;
    }
}
```

For a slight performance improvement and easier debugging, you should generally stick with calling the getter and setter methods directly rather than going through their magic properties.

```php
// Bad:
$oldAuthor = $entry->author;
$entry->author = $newAuthor;

// Better:
$oldAuthor = $entry->getAuthor();
$entry->setAuthor($newAuthor);
```

### App Component Getters

App components should have their own getter functions, which call the app component getter method [get()](yii2:yii\di\ServiceLocator::get()) directly, using component class as its [return type](#return-types):

```php
use craft\services\Entries;

// ...

public function getEntries(): Entries
{
    return $this->get('entries');
}
```

Use those instead of their magic properties:

```php
// Bad:
\Craft::$app->entries->saveEntry($entry);

// Better:
\Craft::$app->getEntries()->saveEntry($entry);
```

If you will be referencing the same app component multiple times within the same method, save a local reference to it.

```php
// Bad:
\Craft::$app->getEntries()->saveEntry($entry1);
\Craft::$app->getEntries()->saveEntry($entry2);

// Better:
$entriesService = \Craft::$app->getEntries();
$entriesService->saveEntry($entry1);
$entriesService->saveEntry($entry2);
```
</file>

<file path="extend/commands.md">
---
sidebarDepth: 2
---

# Console Commands

Plugins and modules can add additional [console commands](../reference/cli.md)
to Craft, which will be available via the `craft` executable in the terminal.

Console commands are implemented very similarly to [controllers](controllers.md), except that they should live within a `console/controllers/` folder within your plugin or module’s base source folder, and they should extend <craft5:craft\console\Controller> (rather than <craft5:craft\web\Controller>).

::: tip
For the most part, writing console commands for Craft is identical to writing console commands for Yii, so be sure to read the [Yii documentation][yii] as a starting point.
:::

## Module Setup

Plugins are [automatically configured](plugin-guide.md#automatic-defaults) to locate web and console controllers. Modules, on the other hand, must explicitly define their root `controllerNamespace` for both request types:

```php{13-17}
namespace acme;

use Craft;

class Module extends \yii\base\Module
{
    public function init()
    {
        // Define a custom alias named after the namespace:
        Craft::setAlias('@acme', __DIR__);

        // Set the controllerNamespace based on whether this is a console or web request:
        if (Craft::$app->getRequest()->getIsConsoleRequest()) {
            $this->controllerNamespace = 'acme\\console\\controllers';
        } else {
            $this->controllerNamespace = 'acme\\controllers';
        }

        // Call init() *after* setting the `controllerNamespace` so Yii doesn’t try and set it:
        parent::init();

        // Additional custom initialization code goes here...
    }
}
```

You’ll also need to make sure your module is getting [bootstrapped](guide:runtime-bootstrapping) on every request from `config/app.php` (or `config/app.console.php`):

```php{2}
return [
    'bootstrap' => ['acme'],
    'modules' => [
        'acme' => acme\Module::class,
    ],
];
```

## Adding a Controller

Any classes within the folder corresponding to your [`controllerNamespace` setting](#module-setup) will be automatically discovered when the console application initializes. Every controller has a default action (run when an action is not specified), and supports [options](guide:tutorial-console#options).

Create `GreetController.php` in `modules/console/controllers/`, with this content:

```php
namespace modules\console\controllers;

use craft\console\Controller;
use craft\helpers\Console;
use yii\console\ExitCode;

/**
 * Greet Controller
 */
class GreetController extends Controller
{
    public $defaultAction = 'developer';

    /**
     * @var string|null The name used when referring to the runner.
     */
    public ?string $who = null;

    public function options($actionID): array
    {
        $options = parent::options($actionID);

        // Always allow a --who flag:
        $options[] = 'who';

        switch ($actionID) {
            case 'developer':
                // Action-specific arguments:
                // $options[] = '...';
                break;
        }

        return $options;
    }

    /**
     * Issues a greeting to new Craft developers.
     */
    public function actionDeveloper(): int
    {
        $who = $this->who ?? 'world';

        $this->stdout("Hello, {$who}!", Console::FG_GREEN);

        return ExitCode::OK;
    }
}
```

### Running Actions

Supposing your [module ID](module-guide.md#preparation) or plugin handle was `acme`, you would access your controller like this:

```bash
# Run the "default action":
php craft acme/greet
# -> Hello, world!

# Run the developer-specific greeting:
php craft acme/greet/developer
# -> Hello, world!

# Pass a name:
php craft acme/greet/developer --who="Marvin"
# -> Hello, Marvin!
```

### Options

In the example, we’ve declared a public class property, and set up a mapping for the single _action ID_. Any [option](guide:tutorial-console#options) can be set using bash’s familiar `--kebab-case-option-name` syntax.

::: tip
Use the [`optionAliases()` method](guide:tutorial-console#options-aliases) to define shorthand options like `-m`.
:::

### Arguments

Actions can declare arguments that will be processed from the command’s input. Arguments are separated by spaces, and the values are processed according to their declared types:

```php
public function actionDeveloper(string $emotion, ?int $days = null): int
{
    $who = $this->who ?? 'world';

    if ($days >= 500) {
        $this->stderr("Sorry, I don’t remember you, {$who}!", Console::FG_YELLOW);

        return ExitCode::TEMPFAIL;
    }

    $this->stdout("Hello, {$who}! I am {$emotion} to see you!", Console::FG_GREEN);

    return ExitCode::OK;
}
```

::: tip
Read more about passing [arguments](guide:tutorial-console#arguments) to console commands.
:::

### Help Text

To assist CLI users, Yii automatically parses docblocks from your controller’s action methods (as well as any public properties matching options you’ve registered) and displays them when running `php craft help`.

```bash
php craft help acme/greet
# -> List of actions

php craft help acme/greet/developer
# -> Action description, list of available --options

php craft acme/greet --help
# This works the same way as the main `help` command!
```

## Registering Custom Console Commands

You can register custom console commands on Craft’s own controllers, or plugin-supplied controllers, so long as they extend <craft5:craft\console\Controller>. For example, plugins that supply custom element types can add their own actions to the [resave](craft5:craft\console\controllers\ResaveController) controller.

To do that, use the <craft5:craft\console\Controller::EVENT_DEFINE_ACTIONS> event.

```php
use craft\events\DefineConsoleActionsEvent;
use craft\console\Controller;
use craft\console\controllers\ResaveController;
use yii\base\Event;

Event::on(
    ResaveController::class,
    Controller::EVENT_DEFINE_ACTIONS,
    function(DefineConsoleActionsEvent $event) {
        $event->actions['products'] = [
            'options' => ['type'],
            'helpSummary' => 'Re-saves products.',
            'action' => function($params): int {
                /** @var ResaveController $controller */
                $controller = Craft::$app->controller;
                $query = Product::find();
                if ($controller->type) {
                    $query->type(explode(',', $controller->type));
                }
                return $controller->saveElements($query);
            }
        ];
    }
);
```

## Output Helpers

Internally, Craft keeps console feedback consistent with a suite of helper methods provided by <craft5:craft\console\ControllerTrait>.

- **Success** — Output a message with a ✅ icon: `$this->success('Done!');`
- **Failure** — Output a message prefixed with an `X`: `$this->failure('Something went wrong.');`
- **Tips** — Output a message with a 💡 icon: `$this->tip('Try this, next!');`
- **Warning** — Output a message with a ⚠️ icon: `$this->warning('Check your input and try again.');`
- **Generic “Note”** — Output a message with a custom icon or prefix: `$this->note('Eat your vegetables!', '🥬 ');`

The above methods run the `$note` argument through <craft5:craft\console\ControllerTrait::markdownToAnsi()>, which provides some basic formatting for long messages. All methods write to `stdout`—use `$this->stderr()` if you need to target a particular output stream.

You can also format messages directly, using <yii2:yii\console\Controller::stdout()>. Additional <craft5:craft\helpers\Console> constants can be passed after the first argument (the message itself) to decorate the text output:

```php
use craft\helpers\Console;

$this->stdout(
    'This message will be bold and vibrant!',
    Console::FG_RED,
    Console::BG_YELLOW,
    Console::BOLD,
    // ...
);
```

[yii]: https://www.yiiframework.com/doc/guide/2.0/en/tutorial-console#create-command
</file>

<file path="extend/conditions.md">
# Conditions

The Craft CMS condition builder is a powerful tool that helps content editors and site developers utilize dynamic, rule-based settings.

![Abstracted illustration of a condition builder with a criteria row and an add button](../images/abstracted-condition.png)

There are several places you can find the condition builder in action:

- Conditional field layouts, which make it possible to display specific tabs or fields only when precise criteria are met;
- Custom [sources](../system/elements.md#sources), which are optional element index sources customized to display whatever elements meet the criteria you set;
- Search field filters;
- Craft Commerce’s pricing and shipping rules;

## Architecture

A condition is a group of one or more condition rules that, when combined, can perform a collective task like modifying an element query or matching an element. The rules are available for a control panel user to configure, should they decide to utilize a condition wherever you’ve made it available.

The “condition builder” is the [Htmx](https://htmx.org/)-powered UI framework the control panel user interacts with in their browser.

Custom fields may define condition rule types to be pulled into element conditions. Most built-in field types take advantage of this and are a great source of examples.

Element types also have an opportunity to register their own conditions and condition rules for native attribute types.

At a high level, a condition rule doesn’t know anything about how it will be used. The <craft5:craft\base\conditions\BaseCondition> class does most of the work to stitch things together and construct the appropriate UI. This base condition class is extended by most of Craft’s included conditions, and all of these pieces are integral parts of the condition builder framework.

## Condition Builder Framework

Developers can work with existing conditions or introduce new ones using the condition builder framework.

Conditions need to implement [ConditionInterface](craft5:craft\base\conditions\ConditionInterface). A generic base implementation is provided by [BaseCondition](craft5:craft\base\conditions\BaseCondition).

Condition rules must implement [ConditionRuleInterface](craft5:craft\base\conditions\ConditionRuleInterface). You’ll find a generic [BaseConditionRule](craft5:craft\base\conditions\BaseConditionRule) implementation along with a handful of base condition rules in `base/conditions/` that are geared for common rule formats.

The HTML representation of a condition builder can be generated with `$condition->getBuilderHtml()`, which supports a few builder-specific options:

- `mainTag` – The container tag type (`form`, by default);
- `id` – The HTML container’s `id` attribute;
- `sortable` – Whether the rules should be user-sortable (`true` by default);
- `singleUseTypes` – Whether rules can only be used once within the condition;
- `projectConfigTypes` – Whether to limit the available rules to those which can be stored in the project config (needed for custom sources);

### Element Query Conditions

[Element types](./element-types.md) can provide their own custom condition classes which extend [ElementCondition](craft5:craft\elements\conditions\ElementCondition). Doing so will give them a chance to include additional element type-specific rules, by overriding [conditionRuleTypes()](craft5:craft\elements\conditions\ElementCondition::conditionRuleTypes()) (see [EntryCondition](craft5:craft\elements\conditions\entries\EntryCondition) for an example).

The element type should return an instance of its custom condition class from a static `createCondition()` method.

### Field Condition Rules

[Field types](./field-types.md) can provide a rule type which implements [FieldConditionRuleInterface](craft5:\craft\fields\conditions\FieldConditionRuleInterface) and uses [FieldConditionRuleTrait](craft5:craft\fields\conditions\FieldConditionRuleTrait).
</file>

<file path="extend/controllers.md">
---
sidebarDepth: 2
description: Respond to HTTP requests by connecting them with back-end services.
---

# Controllers

Plugins and modules can provide custom [controllers][yii] to Craft installations. They can also extend built-in controllers via [behaviors](behaviors.md).

::: tip
For the most part, Craft controllers behave the same as they do in Yii, so everything in the [Yii documentation][yii] still applies—this page is concerned primarily with additional features that _are_ Craft-specific.
:::

## Creating a Controller

Controllers should live within the `controllers/` directory of your plugin or module’s base source folder, and must include a `Controller` suffix in their class and filename (i.e. `LeadController` and `LeadController.php`).

Craft controllers should extend <craft5:craft\web\Controller>, which offers a few advantages over its parent, <yii2:yii\web\Controller>:

- You can decide when the controller should allow “anonymous” access by overriding
  [$allowAnonymous](craft5:craft\web\Controller::$allowAnonymous). (An active user session is required by default.)
- If an [exception](#exceptions) is thrown by a controller action and the request accepts a JSON response, the response will automatically be formatted as JSON, with an `error` key.
- It provides several [helper methods](#request-validation-methods) that ease development.

If you’re working on a _module_, its base class’s [$controllerNamespace](yii2:yii\base\Application::$controllerNamespace) property must set the right namespace for your controllers. Plugins handle this for you, automatically.

::: tip
The `$controllerNamespace` property is ultimately evaluated as a path [alias](../configure.md#aliases) but it _should not_ include a leading `@`. You may encounter errors if the first segment of the “namespace” is not a valid alias—for example, `mymodule\\controllers` will only work if the `@mymodule` alias is already defined, and points to your module’s directory.
:::

## Actions

Controllers themselves don’t provide any functionality without _actions_. Actions are methods on a controller that begin with `action`, like `actionLogin` or `actionSave`.

An action is responsible for gathering information about the request and generating a response. In the process of serving a request, you might access:

- Values passed via [route params](#routes-with-params);
- <badge vertical="baseline" type="verb">POST</badge> body params;
- <badge vertical="baseline" type="verb">GET</badge> query string params;
- HTTP headers;
- Session data;

Typically, actions return a <craft5:craft\web\Response> object—but they can also return `null` as a means of handing control back to Craft and [routing](#routing) to whatever _path_ was originally requested (ignoring the incoming [`action` param](#action-params)). As a convenience, <craft5:craft\web\Controller> includes a number of [request validation](#request-validation-methods) and [response](#sending-responses) factory methods.

A basic controller looks like this:

```php
namespace mynamespace\controllers;

use craft\web\Controller;

class WidgetsController extends Controller
{
    protected array|bool|int $allowAnonymous = true;

    public function actionEcho()
    {
        return $this->asJson(['ping' => 'Pong!']);
    }
}
```

## Routing

There are several ways to access your controller action in a request, which you can use within your own control panel features, and in documentation of developer-facing features.

::: tip
Information on [using controller actions](../development/forms.md) lives in the main documentation. Everything that applies to built-in controllers holds true for those provided by a plugin.
:::

### Action Params

Passing an [`action` param](../development/forms.md#making-requests) in a <badge vertical="baseline" type="verb">GET</badge> request’s query string or a <badge vertical="baseline" type="verb">POST</badge> request’s body lets you tell Craft exactly what controller and action you want to run.

The most common way to do this is with an HTML form, but it’s also possible via [Ajax](../development/forms.md#ajax):

```twig{3}
<form method="POST">
  {{ csrfInput() }}
  {{ actionInput('my-plugin/widgets/save') }}

  {# ... #}

  <button>Save</button>
</form>
```

<See path="../development/forms.md#form-helpers" label="Form Helpers" description="Read more about building front-end forms." />

### Action Paths

Craft will route requests using a specific “action path” format to the matching action:

**Action Trigger** + **Plugin/Module Handle** + **Controller Name** + **Action Method**

```bash
curl -X POST https://my-project.tld/actions/my-plugin/widgets/save
```

Each URL segment follows [Yii’s conventions](guide:structure-controllers) and is lower-kebab-cased:

- Plugin Handle: From [composer.json](plugin-guide.md#composer-json) or [config/app.php](module-guide.md#update-the-application-config), for modules;
- Controller Name: `WidgetsController` becomes `widgets`;
- Action `WidgetsController::actionSave()` becomes `save`

::: tip
The **Action Trigger** is the only exception to this rule, and can be customized with the <config5:actionTrigger> config setting. This setting has no effect on the [`action` param](#action-params).
:::

### Control Panel Routes

Many plugins that provide functionality via the control panel will want to register a bundle of sensible, human-readable routes.

In your plugin’s `init()` method, listen for the <craft5:craft\web\UrlManager::EVENT_REGISTER_CP_URL_RULES> event:

```php
use craft\web\UrlManager;
use craft\events\RegisterUrlRulesEvent;
use yii\base\Event;

Event::on(
    UrlManager::class,
    UrlManager::EVENT_REGISTER_CP_URL_RULES,
    function(RegisterUrlRulesEvent $event) {
        $event->rules['widgets/new'] = 'my-plugin/widgets/edit';
        $event->rules['widgets/edit/<id:\d+>'] = 'my-plugin/widgets/edit';

        // ...
    }
);
```

Here, the key represents the user-facing “path” (what will appear in the address bar of their browser), and the value is an [action path](#action-paths).

::: tip
The second rule here defines a named parameter (`id`), which will be mapped to the target action. We will cover [route params](#routes-with-params), next!
:::

### Site Routes

Plugins should generally avoid setting site URL rules. Instead, document common actions that developers may need, and encourage use of the [`actionInput()`](../reference/twig/functions.md#actioninput) Twig function or [`routes.php`](../system/routing.md#advanced-routing-with-url-rules) to route requests:

```php
return [
    'rate-widget' => 'my-plugin/widgets/submit-review',
];
```

### Routes with Params

Through the magic of [reflection](yii2:yii\web\Controller::bindActionParams()), Yii automatically maps route and query params into action arguments that share a name. For example, an action with this signature…

```php{7}
namespace mynamespace\controllers;

use craft\web\Controller;

class WidgetsController extends Controller
{
    public function actionEdit(?int $id = null)
    {
        // ...
    }
}
```

…will automatically receive the `id` parameter from a request to `?action=my-plugin/widgets/edit&id=42`.

In the previous section, we registered two control panel URL rules, the second of which included a [named parameter](guide:runtime-routing#named-parameters) pattern (`my-plugin/widgets/edit/<id:\d+>`) matching any numeric value; that value will be passed to our action as though it were a query param (so long as the named parameter matches an argument).

## Handling Requests

A controller action’s primary job is to handle an incoming web request and generate an appropriate [response](#sending-responses).

### Request Validation Methods

<craft5:craft\web\Controller> offers several methods you can call from within your actions, to validate the current request:

Method | Description
------ | -----------
[requireLogin()](craft5:craft\web\Controller::requireLogin()) | Requires that a user is logged in.
[requireGuest()](craft5:craft\web\Controller::requireGuest()) | Requires that the user is anonymous.
[requireAdmin()](craft5:craft\web\Controller::requireAdmin()) | Requires that the user is logged in with an Admin account.
[requirePermission()](craft5:craft\web\Controller::requirePermission()) | Requires that the user is logged in with an account that has a given permission.
[requireAuthorization()](craft5:craft\web\Controller::requireAuthorization()) | Requires that the user has been granted authorization to do something (whether or not they are logged in).
[requireElevatedSession()](craft5:craft\web\Controller::requireElevatedSession()) | Requires that the user has an elevated session.
[requirePostRequest()](craft5:craft\web\Controller::requirePostRequest()) | Requires that the request was sent as a POST request.
[requireAcceptsJson()](craft5:craft\web\Controller::requireAcceptsJson()) | Requires that the request was sent with an `Accept: application/json` header.
[requireToken()](craft5:craft\web\Controller::requireToken()) | Requires that the request was sent with a [token](craft5:craft\web\Request::getToken()).
[requireCpRequest()](craft5:craft\web\Controller::requireCpRequest()) | Requires that the request URI begins with the [control panel trigger](config5:cpTrigger).
[requireSiteRequest()](craft5:craft\web\Controller::requireSiteRequest()) | Requires that the request URI doesn’t begin with the [control panel trigger](config5:cpTrigger).

Generally speaking, these checks should occur at the _top_ of your action methods:

```php
public function actionFoo()
{
    // This action should only be available to the control panel
    $this->requireCpRequest();

    // ...
}
```

::: tip
Perform request validation in your controller’s `beforeAction()` method to enforce it for all actions.
:::

### CSRF

Craft requires a valid [CSRF token](../development/forms.md#csrf) for any <badge vertical="baseline" type="verb">POST</badge> requests. This can be disabled for an entire controller by overriding its `$enableCsrfValidation` property, or just for a specific action:

```php
public function beforeAction($action): bool
{
    // Don’t require a CSRF token for incoming webhooks:
    if ($action->id === 'receive-webhook') {
        $this->enableCsrfValidation = false;
    }

    return parent::beforeAction($action);
}
```

::: warning
Only disable CSRF validation when you have some other means of validating the authenticity of a request, like a webhook signature or shared secret.
:::

## Sending Responses

You may want to send different types of responses based on request conditions. All of the following situations involve calling the appropriate response factory method and _returning_ the result.

### Rendering Templates

Controller actions can render and return Twig templates using <craft5:craft\web\Controller::renderTemplate()>.

```php{11-15}
use yii\web\Response;
use craft\web\View;

public function actionFoo(): Response
{
    $variables = [
        'bar' => 'baz',
    ];

    // Render and return the plugin’s `foo.twig` template
    return $this->renderTemplate(
        'plugin-handle/foo',
        $variables,
        View::TEMPLATE_MODE_CP,
    );
}
```

<craft5:craft\web\Controller::renderTemplate()> calls <craft5:craft\web\View::renderPageTemplate()> internally, which ensures all registered assets are added to the rendered HTML—then it will set the `Content-Type` header on the response, based template’s extension, or `text/html` when a MIME type can’t be determined.

::: tip
Plugins automatically get a [template root](template-roots.md) that exposes templates in their `templates/` directory, but modules must explicitly register a template root.
:::

#### Registering Assets

To register an asset for inclusion in a rendered page, call one of the <craft5:craft\web\View> methods:

Calling… | Registers…
------ | -----------
[`registerJs()`](craft5:craft\web\View::registerJs()) | …a block of JavaScript code.
[`registerJsFile()`](craft5:craft\web\View::registerJsFile()) | …a `<script>` tag, with the provided value as its `src` attribute.
[`registerCss()`](craft5:craft\web\View::registerCss()) | …a block of CSS code.
[`registerCssFile()`](craft5:craft\web\View::registerCssFile()) | …a `<link rel="stylesheet">` tag with the provided value as its `href` attribute.
[`registerLinkTag()`](craft5:craft\web\View::registerLinkTag()) | …an arbitrary `<link>` tag.
[`registerAssetBundle()`](craft5:craft\web\View::registerAssetBundle()) | …everything in the provided [asset bundle](./asset-bundles.md).

::: tip
Some methods support passing one of the `View::POS_*` constants to determine where it is registered, or use an [asset bundle](./asset-bundles.md) to declare dependencies to ensure scripts are output in the correct order.
:::

### Returning JSON

Controller actions can explicitly return JSON responses using <yii2:yii\web\Controller::asJson()>.

```php
use Craft;
use yii\web\Response;

public function actionFoo(): Response
{
    return $this->asJson([
        'foo' => true,
    ]);
}
```

If your action is _only_ intended for use by clients expecting JSON, the request should include an `Accept` header, and the action should call <craft5:craft\web\Controller::requireAcceptsJson()>.

Alternatively, <craft5:craft\web\Controller::asSuccess()> and <craft5:craft\web\Controller::asFailure()> may be more appropriate, as they will automatically determine the best format for a response—and they keep the structure of the response consistent.

### Redirection

Controller actions can redirect the request using <craft5:craft\web\Controller::redirect()>.

```php
use yii\web\Response;

public function actionFoo(): Response
{
    return $this->redirect('bar');
}
```

Or, if the request may contain a hashed `redirect` param, you can redirect to that using <craft5:craft\web\Controller::redirectToPostedUrl()>.

```php
use yii\web\Response;

public function actionFoo(): Response
{
    // Redirect the request based on a 'redirect' param
    return $this->redirectToPostedUrl();
}
```

If the controller action is saving something, you may want to allow forms’ `redirect` params to include dynamic tokens such as `{id}`, which should be replaced with the object’s attribute values. To support that, pass the object into [redirectToPostedUrl()](craft5:craft\web\Controller::redirectToPostedUrl()).

```php
use yii\web\Response;

public function actionFoo(): Response
{
    // ...

    // Redirect the request based on a POSTed 'redirect' param,
    // which can contain entry attribute tokens, such as {id}:
    return $this->redirectToPostedUrl($entry);
}
```

### Success and Failure states

For any requests that deal primarily with a single model, you can indicate success and failure states (say, saves or validation errors, respectively) with <craft5:craft\web\Controller::asModelSuccess()> and <craft5:craft\web\Controller::asModelFailure()>.

These methods combine aspects of the options above, constructing a response based on the [`Accept` header](#returning-json), issuing a [redirect](#redirection), or setting flashes and route params. Check out the [model lifecycle](#model-lifecycle) section for an example of them in use.

::: tip
The lower-level <craft5:craft\web\Controller::asSuccess()> and <craft5:craft\web\Controller::asFailure()> methods accomplish much the same thing, but don’t require a model.
:::

### Sending Files

Actions can also return entire files, rather than HTML or JSON:

```php
return $this->response->sendFile(Craft::getAlias('@storage/path/to/temp-file.pdf'), 'Your Invoice.pdf', );

// ...or...

return $this->response->sendContentAsFile($csv, 'report.csv');
```

::: tip
Note that these methods are accessed via the <craft5:craft\web\Response> stub attached to the controller.
:::

### Control Panel Screens

When working with control panel views, you can construct a context-agnostic response by calling <craft5:craft\web\Controller::asCpScreen()>. In doing so, you allow Craft to format the response as a complete HTML document, or just the fragment required for a slide-out. The universal [element editor](./element-types.md#edit-screen) makes extensive use of this.

To set up a response, call the `asCpScreen()` method from an action:

```php
$response = $this->asCpScreen()
    ->action('my-plugin/widgets/save')
    ->docTitle("Edit {$widget->name}")
    ->title($widget->name)
    ->editUrl(UrlHelper::cpUrl("widgets/edit/{$widget->id}");

// ...

return $response;
```

::: tip
See <craft5:craft\web\CpScreenResponseBehavior> for a complete list of methods used to prepare the response object. Keep in mind that some properties are only used one context or another, but that the response can (and should) be configured without needing to know which context is being targeted!
:::

## Model Lifecycle

::: tip
This section expands on concepts covered in [models and validation](../development/forms.md#models-and-validation), with a focus on the implementation of the underlying actions. Examples here will conform to the patterns discussed in that user-facing documentation.
:::

Craft extends [parameterized URL rules](#routes-with-params) to help maintain continuity while editing models. In cases where a validation error prevents a model from saving, you’ll want to provide the user an opportunity to view and correct issues.

In this exercise, we’ll assume your plugin defines two URL rules for the control panel, like the examples above:

- `widgets/new` for creating a `Widget`;
- `widgets/<id:\d+>` for editing an existing `Widget`;

When a user arrives at `widgets/new` (or `admin/widgets/new`, more accurately), we will present them with a form to create a new `Widget`. If there are no issues with their submission, they’ll be redirected to the new widget’s edit URL (`widgets/{id}`). If there _is_ an issue creating the widget (or updating it, later), we’ll drop them back where they started—for new `Widget`s, that would mean the `new` path; for existing `Widget`s, their edit URL.

### Presentation Routes

To support this workflow, both rules must be mapped to a single “edit” action capable of handling both _new_ and _existing_ records. The action will have two arguments—one that corresponds to the `id` param from our _edit_ route, and one that will receive a [dynamically-set `widget` param](#mutation-validation). Let’s look at how this is set up, in practice:

```php{1,6,8,19}
public function actionEdit(?int $id = null, ?Widget $widget = null)
{
    $widgets = MyPlugin::getInstance()->getWidgets();

    // Do we have an incoming Widget ID from the route?
    if ($id !== null) {
        // Was a Widget model passed back via route params? It should take priority:
        if ($widget === null) {
            // Nope, let’s look it up:
            $widget = $widgets->getWidgetById($id);

            if (!$widget) {
                // Uh oh, they’re trying to edit something that doesn’t exist!
                throw new NotFoundHttpException('The requested widget does not exist.');
            }
        }
    } else {
        // Ok, so we’re dealing with a “new” Widget… was one passed back via route params?
        if ($widget === null) {
            // Still no—let’s instantiate a fresh one so we have something to pass to the template:
            $widget = new Widget();
        }
    }

    return $this->renderTemplate('my-plugin/_widgets/edit', [
        'widget' => $widget,
    ]);
}
```

This one action can handle both the `new` and `edit` routes, defined earlier—including cases when the `Widget` fails validation and is passed back to the original path. Here’s a breakdown of the possible combinations of route params that might be available and what scenario it might represent:

`$id` | `$widget` | Scenario
----- | --------- | --------
<x-mark /> | <x-mark /> | Displaying a new form, with no prior submission.
<x-mark /> | <check-mark /> | Displaying validation errors for a new `Widget`.
<check-mark /> | <x-mark /> | Displaying a form for an existing `Widget`.
<check-mark /> | <check-mark /> | Displaying a form with validation errors for an existing `Widget`.

### Mutation + Validation

But how do we actually _save_ a `Widget`? This is handled in a separate action, bearing a familiar structure:

```php{11,20,29-33,36-41}
public function actionSave()
{
    $this->requirePostRequest();

    $request = Craft::$app->getRequest();
    $widgets = MyPlugin::getInstance()->getWidgets();

    // Is the user trying to edit an existing widget?
    $id = $request->getBodyParam('id');

    if ($id) {
        // Ok, we’ve got an ID—let’s look it up.
        $widget = $widgets->getWidgetById($id);

        // Uh oh, it doesn’t exist!
        // (Or maybe you decide they don't have permission to edit it...)
        if (!$widget) {
            throw new BadRequestHttpException('Invalid widget ID.');
        }
    } else {
        // Ok, no ID was passed—looks like they want to create a new one:
        $widget = new Widget();
    }

    // ...assign, update, and validate properties...

    if (!$widgets->saveWidget($widget)) {
        // Hand the model back to the original route:
        return $this->asModelFailure(
            $widget, // Model, passed back under the key, below...
            Craft::t('my-plugin', 'Something went wrong!'), // Flash message
            'widget', // Route param key
        );
    }

    return $this->asModelSuccess(
        $widget, // Model (included in JSON responses)
        Craft::t('my-plugin', 'Widget saved.'), // Flash message
        'widget', // Key the model will be under (in JSON responses)
        'my-plugin/widgets/{id}', // Redirect “object template”
    );
}
```

This implementation of `actionSave()` doesn’t require route params to be bound to arguments—instead, it just looks for a POSTed `id` value, and attempts to load the corresponding `Widget`. Without an ID in the request, it just instantiates a new `Widget` model.

In the last return statement, you’ll notice a [redirection](#redirection) object template, which is rendered after a widget is successfully saved—the format matches our original “edit” URL rule, meaning the user will be dropped at their newly created or updated `Widget` edit screen.

::: tip
Read more about the `asModelSuccess()` and `asModelFailure()` [response factory methods](#models-and-validation).
:::

### Forms

The final piece of this puzzle is the `<form>` we use to display and update a `Widget`:

```twig
<form method="POST">
  {{ csrfInput() }}
  {{ actionInput('my-plugin/widgets/save') }}

  {# Our `widget` may be new, so it won’t always have an ID: #}
  {% if widget.id %}
    {{ hiddenInput('id', widget.id) }}
  {% endif %}

  <label>
    {{ input('text', 'name', widget.name) }}

    {# It may also have come back with validation errors attached: #}
    {% if widget.hasErrors('name') %}
        <span>{{ widget.getErrors('name') | join(', ') }}</span>
    {% endif %}
  </label>

  <button type="submit">Save Widget</button>
</form>
```

Notice that we aren’t setting an [`action` _attribute_](../development/forms.md#making-requests) on the form! This means that if the widget is _isn’t_ saved successfully, the request will fall through to the same route the user submitted the form from (in this case, mapped to the `my-plugin/widgets/edit` action), allowing them to pick back up with the model intact. If it _was_ successful, Craft will [redirect](#sending-responses) to the rendered object template (fourth argument to `asModelSuccess()` at the end of `actionSave()`).

::: tip
You may still define an `action` attribute on your form when it exists at a different path from the primary editing page. The “Quick Post” dashboard widget is representative of this pattern—a minimal form is presented in one context, but errors are displayed elsewhere, after submission.
:::

## Exceptions

Craft automatically handles exceptions that bubble out of an action, and will present an error to the client—but only subclasses of <yii2:yii\base\UserException> will display the actual message.

Yii provides <yii2:yii\web\HttpException>, which can be thrown with a specific `statusCode` to set it on the response. Specific subclasses like <yii2:yii\web\ForbiddenHttpException> should be used when available.

Do not throw `HttpException`s anywhere but web controllers. If you want to indicate an internal failure, catch and re-throw an appropriate `HttpException`.

[yii]: https://www.yiiframework.com/doc/guide/2.0/en/structure-controllers
</file>

<file path="extend/cp-edit-pages.md">
# Control Panel Edit Pages

Modules and plugins can add new edit pages to the control panel, for editing models or [elements](./element-types.md).

::: tip
Looking to support full-page interfaces _and_ slideouts? Check out the new [control panel screens](./controllers.md#control-panel-screens) API.
:::

First, decide on the URL patterns that the edit page should be accessed by, such as `my-plugin/events/new` when creating a new event, and `my-plugin/events/X` for editing an existing one.

Register two URL rules via <craft5:craft\web\UrlManager::EVENT_REGISTER_CP_URL_RULES> from your module/plugin’s `init()` method:

```php
use craft\events\RegisterUrlRulesEvent;
use craft\web\UrlManager;
use yii\base\Event;

Event::on(
    UrlManager::class,
    UrlManager::EVENT_REGISTER_CP_URL_RULES,
    function(RegisterUrlRulesEvent $event) {
        $event->rules['my-plugin/events/new'] = 'my-plugin/events/edit';
        $event->rules['my-plugin/events/<eventId:\d+>'] = 'my-plugin/events/edit';
    }
);
```

Now create a new [form page template](./cp-templates.md#form-pages) that contains the edit form, such as `templates/events/_edit.twig`.

The model being edited will be available to the template as a predefined variable (e.g. `event`). The template can refer to that model when passing current field values and validation errors to the [form inputs](./cp-templates.md#form-inputs).

```twig
{% extends '_layouts/cp.twig' %}
{% import '_includes/forms.twig' as forms %}

{% set title = 'Edit Event'|t('my-plugin') %}
{% set fullPageForm = true %}

{% block content %}
  {# Have the form submit to a my-plugin/events/save controller action #}
  {{ actionInput('my-plugin/events/save') }}
  
  {# Have the save action redirect to /my-plugin/events afterward #}
  {{ redirectInput('my-plugin/events') }}

  {{ forms.textField({
    label: 'Event Name'|t('plugin-handle'),
    instructions: 'The name of the event'|t('plugin-handle'),
    id: 'name',
    name: 'name',
    value: event.name,
    required: true,
    errors: event.getErrors('name'),
  }) }}
  
  {{ forms.dateField({
    label: 'Start Date'|t('plugin-handle'),
    instructions: 'The start date of the event.'|t('plugin-handle'),
    id: 'start-date',
    name: 'startDate',
    value: event.startDate,
    required: true,
    errors: event.getErrors('startDate'),
  }) }}
  
  {{ forms.dateField({
    label: 'End Date'|t('plugin-handle'),
    instructions: 'The end date of the event.'|t('plugin-handle'),
    id: 'end-date',
    name: 'endDate',
    value: event.endDate,
    required: true,
    errors: event.getErrors('endDate'),
  }) }}
{% endblock %}
```

Once the template is ready, create [controller actions](./controllers.md) for displaying the edit page, and handling form submissions.

```php
use mynamespace\models\Event;
use Craft;
use craft\helpers\DateTimeHelper;
use yii\web\BadRequestHttpException;
use yii\web\Response;

public function actionEdit(?int $eventId = null, ?Event $event = null): Response
{
    // Ensure the user has permission to save events
    $this->requirePermission('edit-events');

    if (!$event) {
        // Are we editing an existing event?
        if ($eventId) {
            $event = MyPlugin::getInstance()->events->getEventById($eventId);
            if (!$event) {
                throw new BadRequestHttpException("Invalid event ID: $eventId");
            }
        } else {
            // We're creating a new event
            $event = new Event();
        }
    }
    
    return $this->renderTemplate('plugin-handle/events/_edit', [
        'event' => $event,
    ]);
}

public function actionSave(): ?Response
{
    // Ensure the user has permission to save events
    $this->requirePermission('edit-events');

    $eventId = $this->request->getBodyParam('eventId');

    if ($eventId) {
        $event = MyPlugin::getInstance()->events->getEventById($eventId);
        if (!$event) {
            throw new BadRequestHttpException("Invalid event ID: $eventId");
        }
    } else {
        $event = new Event();
    }

    // Populate the event with the form data
    $event->name = $this->request->getBodyParam('name');
    $event->startDate = DateTimeHelper::toDateTime($this->request->getBodyParam('startDate'));
    $event->endDate = DateTimeHelper::toDateTime($this->request->getBodyParam('endDate'));

    // Try to save it
    if (!MyPlugin::getInstance()->events->saveEvent($event)) {
        if ($this->request->acceptsJson) {
            return $this->asJson(['errors' => $event->getErrors()]);
        }

        $this->setFailFlash(Craft::t('plugin-handle', 'Couldn’t save event.'));
        
        // Send the event back to the edit action
        Craft::$app->urlManager->setRouteParams([
            'event' => $event,
        ]);
        return null;
    }

    if ($this->request->acceptsJson) {
        return $this->asJson(['success' => true]);
    }

    $this->setSuccessFlash(Craft::t('plugin-handle', 'Event saved.'));
    $this->redirectToPostedUrl($event);
}
```

On the surface, these look like two distinct actions—one for showing the edit page, and another for handling form submissions.

But there’s one scenario where _both_ of these actions will get run, one after the other: when there are validation errors on save.

If the `saveEvent()` method returns `false` (presumably due to validation errors), our `save` action registers the model as a _route param_ called `event`, by passing it to <craft5:craft\web\UrlManager::setRouteParams()>. Then the action will return `null`, which tells Craft it should continue [routing the request](../system/routing.md) as if it was never routed to our `save` action to begin with.

The next stop in the routing will be our `edit` action, per the URL rules we’ve registered. This time, our (invalid) model will be passed to its `$event` argument, so the action won’t need to fetch/create an event based on the `$eventId`. It will pass the model to the edit template, complete with validation errors.

::: tip
See [Model Operation Methods](./services.md#model-operation-methods) for a blueprint of how the service’s `saveEvent()` method might work.
:::
</file>

<file path="extend/cp-section.md">
# Control Panel Sections

Modules and plugins can add new sections to the control panel using the [EVENT_REGISTER_CP_NAV_ITEMS](craft5:craft\web\twig\variables\Cp::EVENT_REGISTER_CP_NAV_ITEMS) event:

```php
use craft\events\RegisterCpNavItemsEvent;
use craft\web\twig\variables\Cp;
use yii\base\Event;

public function init()
{
    parent::init();

    Event::on(
        Cp::class,
        Cp::EVENT_REGISTER_CP_NAV_ITEMS,
        function(RegisterCpNavItemsEvent $event) {
            $event->navItems[] = [
                'url' => 'section-url',
                'label' => 'Section Label',
                'icon' => '@mynamespace/path/to/icon.svg',
            ];
        }
    );

    // ...
}
```

Each item within the [navItems](craft5:craft\events\RegisterCpNavItemsEvent::$navItems) array can have the following keys:

- `url` – The URL that the nav item should link to. (It will be run through <craft5:craft\helpers\UrlHelper::cpUrl()>.)
- `label` – The user-facing nav item label.
- `icon` – The path to the icon SVG that should be used. (It can begin with an alias.)
- `badgeCount` _(optional)_ – The badge count that should be displayed in the nav item.
- `subnav` _(optional)_ – An array of subnav items that should be visible when your section is accessed. (See [Subnavs](#subnavs).)


For Craft to properly designate an item as “active,” its `url` must be registered with a relative path to the plugin or module’s control panel section. Any `subnav` paths should begin with `url` in order to appear selected when active.

## Subnavs

If your section has a sub-navigation, each subnav item within your `subnav` array should be represented by a sub-array with `url` and `label` keys:

```php
'subnav' => [
    'foo' => ['label' => 'Foo', 'url' => 'section-url/foo'],
    'bar' => ['label' => 'Bar', 'url' => 'section-url/bar'],

    // Display a subnav badge count by adding the optional `badgeCount` key:
    'baz' => ['label' => 'Baz', 'url' => 'section-url/baz', 'badgeCount' => 5],
],
```

Your templates can specify which subnav item should be selected by setting a `selectedSubnavItem` variable to the key of the nav item:

```twig
{% set selectedSubnavItem = 'bar' %}
```

## Plugin Sections

Plugins that only need to add one section can set the `$hasCpSection` property on their primary plugin class, rather than using the [EVENT_REGISTER_CP_NAV_ITEMS](craft5:craft\web\twig\variables\Cp::EVENT_REGISTER_CP_NAV_ITEMS) event:

```php
<?php

namespace mynamespace;

class Plugin extends \craft\base\Plugin
{
    public bool $hasCpSection = true;

    // ...
}
```

::: tip
You can alternatively set a `hasCpSection` value in `composer.json` as noted in the [plugin guide](plugin-guide.md#composer-json). We don’t recommend setting it in both places, however, since the value set in `composer.json` will override your public class property’s value and likely create confusion.
:::

You can modify aspects of the plugin’s control panel nav item by overriding its [getCpNavItem()](craft5:craft\base\PluginInterface::getCpNavItem()) method:

```php
public function getCpNavItem(): ?array
{
    $item = parent::getCpNavItem();
    $item['badgeCount'] = 5;
    $item['subnav'] = [
        'foo' => ['label' => 'Foo', 'url' => 'plugin-handle/foo'],
        'bar' => ['label' => 'Bar', 'url' => 'plugin-handle/bar'],
        'baz' => ['label' => 'Baz', 'url' => 'plugin-handle/baz'],
    ];
    return $item;
}
```

If you do this, Craft will automatically add a new [user permission](user-permissions.md) for your plugin, and only show the nav item for users that have it.

Clicking on a plugin’s section will take the user to `/admin/plugin-handle`, which will attempt to load an `index.html` or `index.twig` template within the plugin’s [template root](template-roots.md) (its `templates/` folder within its base source folder).

::: tip
See [Control Panel Templates](cp-templates.md) for more information about developing control panel templates.
:::

Alternatively, you can route `/admin/plugin-handle` requests to a controller action (or a different template) by registering a control panel route from your plugin’s `init()` method:

```php
use craft\events\RegisterUrlRulesEvent;
use craft\web\UrlManager;
use yii\base\Event;

public function init()
{
    Event::on(
        UrlManager::class,
        UrlManager::EVENT_REGISTER_CP_URL_RULES,
        function(RegisterUrlRulesEvent $event) {
            $event->rules['plugin-handle'] = 'plugin-handle/foo/bar';
        }
    );
}
```

These rules use the same format as those [defined in `routes.php`](../system/routing.md#advanced-routing-with-url-rules). Find additional examples of control panel and site routes in the routing section of the [controllers](controllers.md#routing) documentation.
</file>

<file path="extend/cp-templates.md">
# Control Panel Templates

The control panel is built using Twig templates, so extending it with new pages should feel familiar if you’ve worked with Twig on the front end.

Plugins are automatically given a [template root](template-roots.md) that exposes files in their `templates/` folder. You can `include` or render these templates by prefixing their path with the plugin’s handle.

For example, if a plugin’s handle is `foo` and it had a template at `templates/bar.twig`, you could access it by navigating to `/admin/foo/bar` in your browser (just like the front-end), or from another Twig context (or [controller action](controllers.md#rendering-templates)) as `foo/bar` (or `foo/bar.twig`).

Modules can have templates too, but they will need to manually define a [template root](template-roots.md) before they are accessible.

::: tip
Looking to support full-page interfaces _and_ slideouts? Check out the new [control panel screens](./controllers.md#control-panel-screens) API.
:::

## Page Templates

To add a new full page to the control panel, create a template that extends the [_layouts/cp.twig](repo:craftcms/cms/blob/5.x/src/templates/_layouts/cp.twig) template.

At a minimum, your template should set a `title` variable and define a `content` block:

```twig
{% extends "_layouts/cp.twig" %}
{% set title = "Page Title"|t('plugin-handle') %}

{% block content %}
  <p>Page content goes here</p>
{% endblock %}
```

### Supported Variables

The following variables are supported by the `_layouts/cp.twig` template:

Variable | Description
-------- | -----------
`title` | The page title.
`bodyClass` | An array of class names that should be added to the `<body>` tag.
`fullPageForm` | Whether the entire page should be wrapped in one big `<form>` element (see [Form Pages](#form-pages)).
`crumbs` | An array of breadcrumbs (see [Adding Breadcrumbs](#adding-breadcrumbs)).
`tabs` | An array of tabs (see [Adding Tabs](#adding-tabs)).
`selectedTab` | The ID of the selected tab.
`showHeader` | Whether the page header should be shown (`true` by default).
`mainAttributes` | A hash of HTML attributes that should be added to the `<main>` tag. 

### Available Blocks

The `_layouts/cp` template defines the following blocks, which your template can extend:

Block | Outputs
----- | -------
`actionButton` | The primary Save button.
`content` | The page’s main content.
`contextMenu` | An optional context menus beside the page title (e.g. the revision menu on Edit Entry pages).
`details` | The page’s right sidebar content.
`footer` | The page’s footer content.
`header` | The page’s header content, including the page title and other header elements.
`pageTitle` | The page title (rendered within the `header` block).
`sidebar` | The page’s left sidebar content.
`toolbar` | The page’s toolbar content.

### Adding Breadcrumbs

To add breadcrumbs to your page, define a `crumbs` variable, set to an array of the breadcrumbs.

Each breadcrumb should be represented as a hash with the following keys:

Key | Description
--- | -----------
`label` | The breadcrumb label.
`url` | The URL that the breadcrumb should link to.

For example, the following `crumbs` array defines two breadcrumbs:

```twig
{% set crumbs = [
  {
    label: 'Plugin Name'|t('plugin-handle'),
    url: url('plugin-handle'),
  },
  {
    label: 'Products'|t('plugin-handle'),
    url: url('plugin-handle/products'),
  },
] %}
```

### Adding Tabs

To add tabs to your page, define a `tabs` variable, set to a hash of the tabs, indexed by tab IDs.

Each tab should be represented as a nested hash with the following keys:

Key | Description
--- | -----------
`label` | The tab label.
`url` | The URL or anchor that the tab should link to.
`class` | A class name that should be added to the tab (in addition to `tab`).

For example, the following `tabs` hash defines two tabs, which will toggle the `hidden` class of `<div>` elements whose IDs match the anchors:

```twig
{% set tabs = {
  content: {
    label: 'Content'|t('plugin-handle'),
    url: '#content',
  },
  settings: {
    label: 'Settings'|t('plugin-handle'),
    url: '#settings',
  },
} %}
```

The first tab will be selected by default. You can force a different tab to be selected by default by setting a `selectedTab` variable to the ID of the desired tab:

```twig
{% set selectedTab = 'settings' %}
```

### Form Pages

If the purpose of your template is to present a form to the user, start by setting the `fullPageForm` variable to `true` at the top:

```twig
{% set fullPageForm = true %}
```

When you do that, everything inside the page’s `<main>` element will be wrapped in a `<form>` element, and a Save button and CSRF input will be added to the page automatically for you. It will be up to you to define the `action` input, however.

```twig
{% block content %}
  {{ actionInput('plugin-handle/controller/action') }}
  <!-- ... -->
{% endblock %}
```

Your template can also define the following variables, to customize the form behavior:

Variable | Description
-------- | -----------
`formActions` | An array of available Save menu actions for the form (see [Alternate Form Actions](#alternate-form-actions)).
`mainFormAttributes` | A hash of HTML attributes that should be added to the `<form>` tag.
`retainScrollOnSaveShortcut` | Whether the page’s scroll position should be retained on the subsequent page load when the <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>S</kbd> keyboard shortcut is used.
`saveShortcutRedirect` | The URL that the page should be redirected to when the <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>S</kbd> keyboard shortcut is used.
`saveShortcut` | Whether the page should support a <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>S</kbd> keyboard shortcut (`true` by default).

#### Form Inputs

Craft’s [_includes/forms.twig](repo:craftcms/cms/blob/5.x/src/templates/_includes/forms.twig) template defines several macros that can be used to display your form elements.

Most input types have two macros: one for outputting _just_ the input; and another for outputting the input as a “field”, complete with a label, author instructions, etc.

For example, if you just want to output a date input, but nothing else, you could use the `date` macro:

```twig
{% import '_includes/forms.twig' as forms %}

{{ forms.date({
  id: 'start-date',
  name: 'startDate',
  value: event.startDate,
}) }}
```

However if you want to wrap the input with a label, author instructions, a “Required” indicator, and any validation errors, you could use the `dateField` macro instead:

```twig
{% import '_includes/forms.twig' as forms %}

{{ forms.dateField({
  label: 'Start Date'|t('plugin-handle'),
  instructions: 'The start date of the event.'|t('plugin-handle'),
  id: 'start-date',
  name: 'startDate',
  value: event.startDate,
  required: true,
  errors: event.getErrors('startDate'),
}) }}
```

#### Alternate Form Actions

If you want your form to have a menu button beside the Save button with alternate form actions, define a `formActions` variable, set to an array of the actions.

Each action should be represented as a hash with the following keys:

Key | Description
--- | -----------
`action` | The controller action path that the form should submit to, if this action is selected.
`confirm` | A confirmation message that should be presented to the user when the action is selected, before the form is submitted.
`data` | A hash of any data that should be passed to the form’s `submit` event.
`destructive` | Whether the action should be considered destructive, which will cause it to be listed in red text at the bottom of the menu, after a horizontal rule.
`label` | The action’s menu option label.
`params` | A hash of additional form parameters that should be included in the submission if the action is selected.
`redirect` | The URL that the controller action should redirect to if successful.
`retainScroll` | Whether the page’s scroll position should be retained on the subsequent page load.
`shift` | Whether the action’s keyboard shortcut should include the <kbd>Shift</kbd> key.
`shortcut` | Whether the action should be triggered by a keyboard shortcut.

For example, the following `formActions` array defines three alternative form actions:

```twig
{% set formActions = [
  {
    label: 'Save and continue editing'|t('plugin-handle'),
    redirect: 'plugin-handle/edit/{id}',
    retainScroll: true,
    shortcut: true,
  },
  {
    label: 'Save and add another'|t('plugin-handle'),
    redirect: 'plugin-handle/new',
    shortcut: true,
    shift: true,
  },
  {
    label: 'Delete'|t('plugin-handle'),
    confirm: 'Are you sure you want to delete this?'|t('plugin-handle'),
    redirect: 'plugin-handle',
    destructive: true,
  },
] %}
```

Note that when `formActions` is defined, the `saveShortcut`, `saveShortcutRedirect`, and `retainScrollOnSaveShortcut` variables will be ignored, as it will be up to the individual form actions to define that behavior.
</file>

<file path="extend/element-actions.md">
---
description: Give content managers access to extra features from element indexes. 
---

# Element Actions

Plugins can provide custom actions for element index pages by creating a class that implements <craft5:craft\base\ElementActionInterface>. Element actions can operate on single elements or multiple elements at the same time.

## Action Class

Use the [generator](generator.md) to scaffold your action class:

<Generator component="element-action" plugin="my-plugin" />

As a convenience, you can extend <craft5:craft\base\ElementAction>, which provides a base action type implementation. You can refer to Craft’s own element action classes (located in `vendor/craftcms/cms/src/elements/actions/`, or the `craft\elements\actions` namespace) for examples.

### Parameterization

Craft’s built-in element actions prioritize reusability over specificity. Take <craft5:craft\elements\actions\Delete>, for instance: it can be used with any element type, but entries and categories make use of its attributes to generate other actions like “Delete (with descendants)” (by setting the `withDescendants` attribute), or “Delete permanently” (with the `hard` attribute).

## Registering Element Actions

To show up on an element index page, actions must be registered with the element type.

If an action is only relevant to a custom [element type](element-types.md) that is defined by the same plugin, return it from the element class’s [defineActions()](element-types.md#actions) method:

```php
protected static function defineActions(string $source): array
{
    return [
        MyAction::class,
    ];
}
```

If it should be available to an element type that is out of the plugin’s control, register it using the <craft5:craft\base\Element::EVENT_REGISTER_ACTIONS> event:

```php
<?php
namespace mynamespace;

use craft\base\Element;
use craft\elements\Entry;
use craft\events\RegisterElementActionsEvent;
use mynamespace\elements\actions\MyAction;
use yii\base\Event;

class Plugin extends \craft\base\Plugin
{
    public function init()
    {
        Event::on(
            Entry::class,
            Element::EVENT_REGISTER_ACTIONS,
            function(RegisterElementActionsEvent $event) {
                $event->actions[] = MyAction::class;
            }
        );

        // ...
    }

    // ...
}
```

Both options give you access to the [element source](element-types.md#sources) being rendered, so that actions can be conditionally added—for `defineActions()`, it’s passed as an argument; when registering them via an event, the event object has a `source` attribute.

## Handling Actions

Craft runs all actions via <craft5:craft\controllers\ElementIndexesController::actionPerformAction()>. See the built-in actions for examples of how they handle interactions in the control panel, and for back-end implementations of `performAction()`.
</file>

<file path="extend/element-exporter-types.md">
# Element Exporter Types

Element index pages in the control panel have the ability to export elements as CSV, XML, or JSON files.

![Menu with Craft’s default export types](../images/exporters-default.png)

The data included in these files is determined by the selected **exporter type**. Craft comes with two exporter types out of the box:

1. **Raw Data (fastest)**: a simple dump of the raw element query results
2. **Expanded**: a more fleshed-out export that includes data for all custom fields, including Matrix and relational fields

## Creating Custom Exporter Types

Plugins can provide custom exporter types for element index pages by creating a class that implements <craft5:craft\base\ElementExporterInterface>.

As a convenience, you can extend <craft5:craft\base\ElementExporter>, which provides a base exporter type implementation.

There are two methods that your exporter type should define:

- **[displayName()](craft5:craft\base\ComponentInterface::displayName())** _(static)_ – returns the user-facing name of the exporter type (shown in the **Export Type** dropdown menu within the Export HUD).
- **[export()](craft5:craft\base\ElementExporterInterface::export())** – Accepts an element query, and returns the export data. Each item of the returned array represents one row of data, and should be set to a nested array of the column values.

::: tip
Make sure that each of the nested arrays returned by `export()` contain the exact same array keys.
:::

Here’s an example exporter type that provides the title, status, and URL of the selected elements, along with titles of any entries related via a field called `relatedEntries`:

```php
<?php

namespace mynamespace\exporters;

use Craft;
use craft\base\EagerLoadingFieldInterface;
use craft\base\Element;
use craft\base\ElementExporter;
use craft\base\Field;
use craft\elements\db\ElementQuery;
use craft\elements\db\ElementQueryInterface;
use craft\helpers\ArrayHelper;

class MyCustomExporter extends ElementExporter
{
    public static function displayName(): string
    {
        return 'My Exporter';
    }

    public function export(ElementQueryInterface $query): mixed
    {
        $results = [];

        // Eager-load the entries related via the relatedEntries field
        /** @var ElementQuery $query */
        $query->with(['relatedEntries']);

        foreach ($query->each() as $element) {
            /** @var Element $element */
            $results[] = [
                'Title' => $element->title ?? '',
                'Status' => ucfirst($element->status),
                'URL' => $element->getUrl(),
                'RelatedEntries' => ArrayHelper::getColumn(
                    $element->relatedEntries,
                    'title'
                ),
            ];
        }

        return $results;
    }
}
```

The user-selected output format determines how a value will be rendered. Here’s how the `Related` example above would appear in each format:

::: code

```markdown CSV
RelatedEntries
"[""Title 1"",""Title 2""]"
```

```json
{
  "RelatedEntries": [
    "Title 1",
    "Title 2"
  ]
}
```

```xml
<RelatedEntries>
  <item>Title 1</item>
  <item>Title 2</item>
</RelatedEntries>
```

:::

## Registering Custom Exporter Types

To get an element exporter type to show up on an element index page, it has to be registered with the element type.

If it’s for a custom element type that is defined by the same plugin or module, simply include your element action in the element class’s [defineExporters()](element-types.md#index-page-exporters) method.

If it’s for an element type that is out of the plugin’s control, you can register it using the `registerExporters` event:

```php
<?php
namespace mynamespace;

use craft\base\Element;
use craft\elements\Entry;
use craft\events\RegisterElementExportersEvent;
use yii\base\Event;

class Plugin extends \craft\base\Plugin
{
    public function init()
    {
        Event::on(
            Entry::class,
            Element::EVENT_REGISTER_EXPORTERS,
            function(RegisterElementExportersEvent $event) {
                $event->exporters[] = MyExporter::class;
            }
        );

        // ...
    }

    // ...
}
```
</file>

<file path="extend/element-types.md">
---
description: Add native-feeling content types to empower content authors and administrators.
---

# Element Types

[Elements](../system/elements.md) underpin Craft’s flexible and extensible content modeling features. You can supplement Craft’s seven [built-in element types](../system/elements.md#element-types) with your own, from a plugin or module.

As you implement common element features like [titles](#titles), [sources](#sources), or [statuses](#statuses), the built-in element classes will be an invaluable resource—both as templates for basic functionality and evidence of the flexibility of elements.

If your plugin provides a new content-driven resource, it should be implemented as an element type!

## Getting Started

### Element Class

Element types are defined by classes that implement <craft5:craft\base\ElementInterface> and use <craft5:craft\base\ElementTrait>. The class will serve both as a source of information about your element type (using static methods), and as a model that elements of its type will be instantiated with. As a convenience, you can extend <craft5:craft\base\Element>, which provides a bare-bones element type implementation.

Your element class should live in the `elements/` directory of your plugin’s source directory, and—per autoloading convention—be named the same as the file. Our examples will be based on a new “product” element, so the element class (`mynamespace\elements\Product`) will be defined in `src/elements/Product.php`.

::: tip
Use the [generator](./generator.md) to scaffold an element type from the command line!

<p><Generator component="element-type" plugin="my-plugin" /></p>
:::

To start, we’ll give the class a handful of public properties and define two static methods that help the control panel render labels.

```php
<?php
namespace mynamespace\elements;

use craft\base\Element;

class Product extends Element
{
    public static function displayName(): string
    {
        return 'Product';
    }

    public static function pluralDisplayName(): string
    {
        return 'Products';
    }

    public int $price = 0;
    public ?string $currency = null;

    // ...
}
```

::: tip
A `lowerDisplayName()` and `pluralLowerDisplayName()` can also be explicitly defined, if you find that Craft doesn’t get them quite right.
:::

### Registration

Register your element type using the [EVENT_REGISTER_ELEMENT_TYPES](craft5:craft\services\Elements::EVENT_REGISTER_ELEMENT_TYPES) event from your plugin or module’s `init()` method:

```php
use mynamespace\elements\Product;
use craft\events\RegisterComponentTypesEvent;
use craft\services\Elements;
use yii\base\Event;

Event::on(
    Elements::class,
    Elements::EVENT_REGISTER_ELEMENT_TYPES,
    function(RegisterComponentTypesEvent $event) {
        $event->types[] = Product::class;
    }
);
```

This is not a requirement for all element types, but provides automatic support for things like relational [condition rules](./conditions.md) and [reference tags](../system/reference-tags.md).

## Working with the Database

Part of what gives custom elements their power is the ability to store additional attributes in a predictable way—without depending on custom fields. [Entries](../reference/element-types/entries.md), for instance, have a post date (`postDate`), expiry date (`expiryDate`), and an author ID (`authorId`); [assets](../reference/element-types/assets.md) track the underlying file’s extension and what volume and folder they belong to.

While elements automatically get support for storing relations, custom field data, titles, slugs and URIs, it’s your plugin’s responsibility to create and maintain an appropriate database schema for persisting its native attributes. For our product element type, we’ll need a new table with at least `price` and `currency` columns.

::: tip
We’re going to set up the mechanisms of persistence now, and will cover [accepting data](#editing-elements) later.
:::

### Migrations

Create a new [migration](migrations.md), and add this to its `safeUp()` method:

```php
// Create the Products table:
$this->createTable('{{%plugin_products}}', [
    'id' => $this->primaryKey(),
    'price' => $this->integer()->notNull(),
    'currency' => $this->char(3)->notNull(),
    'dateCreated' => $this->dateTime()->notNull(),
    'dateUpdated' => $this->dateTime()->notNull(),
    'uid' => $this->uid(),
]);

// Give it a foreign key to the elements table:
$this->addForeignKey(
    null,
    '{{%plugin_products}}',
    'id',
    '{{%elements}}',
    'id',
    'CASCADE',
    null
);
```

Note that we’ve also specified `id`, `dateCreated`, `dateUpdated`, and `uid` “audit” columns (used by Craft’s [`insert`](craft5:craft\db\Command::insert()), [`upsert`](craft5:craft\db\Command::upsert()), and [`update`](craft5:craft\db\Command::update()) commands)—as well as a foreign key to tie our records back to the source `elements` table. A foreign key ensures records are not orphaned when the underlying element is [hard-deleted](./soft-deletes.md).

::: tip
Plugins should always keep their [install migration](./migrations.md#plugin-install-migrations) up to date. If this is your plugin’s first migration, it can live solely in `Install.php`; otherwise, equivalent code will also need to be added via a regular migration.
:::

Install your plugin (or run `php craft migrate/up --plugin=my-plugin`) to create the database table.

### Save Hooks

The presence of attributes alone doesn’t give Craft enough information to persist them, automatically. You will need to implement this logic in an `afterSave()` method on your element class, which is called as part of the standard element saving [control flow](services.md#interface-oriented-methods).

```php
use craft\helpers\Db;

// ...

public function afterSave(bool $isNew)
{
    if (!$this->propagating) {
        Db::upsert('{{%plugin_products}}', [
            'id' => $this->id,
        ], [
            'price' => $this->price,
            'currency' => $this->currency,
        ]);
    }

    parent::afterSave($isNew);
}
```

::: tip
`afterSave()` gets called by <craft5:craft\services\Elements::saveElement()>, after rows in the `elements`, `elements_sites`, and `content` tables have been saved, and the element has an `id` and `uid`. Craft encapsulates the entire element saving operation in a [transaction](guide:db-dao#performing-transactions), so any modifications you make in `afterSave()` will automatically be rolled back in the event of a failure.
:::

Every element save emits [`EVENT_BEFORE_SAVE_ELEMENT`](craft5:craft\services\Elements::EVENT_BEFORE_SAVE_ELEMENT) and [`EVENT_AFTER_SAVE_ELEMENT`](craft5:craft\services\Elements::EVENT_AFTER_SAVE_ELEMENT) events, but you are free to create and emit your own (say, based on certain type of change like an increase or decrease in price) in the `afterSave()` method.

Keep in mind that a “save” can happen in a number of circumstances (like the creation of a draft or revision), and doesn’t always mean that changes are being applied to the canonical version of an element—or that it’s even part of a web request.

### Element Query Class

All element types need a corresponding [element query](../development/element-queries.md) class. Element query classes are an extension of [query builders](guide:db-query-builder), tuned for fetching elements. They have three responsibilities:

- Provide public properties and setter methods for capturing custom criteria parameters;
- Join in the custom element table and select the appropriate columns within it;
- Synthesize custom parameters into conditions on the query;

Refer to Craft’s own element query classes for examples, in `vendor/craftcms/cms/src/elements/db/`.

Extend <craft5:craft\elements\db\ElementQuery> in a new `elements/db/ProductQuery.php` file:

```php
<?php
namespace mynamespace\elements\db;

use craft\elements\db\ElementQuery;
use craft\helpers\Db;

class ProductQuery extends ElementQuery
{
    public $price;
    public $currency;

    public function price($value): self
    {
        $this->price = $value;

        return $this;
    }

    public function currency($value): self
    {
        $this->currency = $value;

        return $this;
    }

    protected function beforePrepare(): bool
    {
        // JOIN our `products` table:
        $this->joinElementTable('products');

        // SELECT the `price` and `currency` columns:
        $this->query->select([
            'products.price',
            'products.currency',
        ]);

        if ($this->price) {
            $this->subQuery->andWhere(Db::parseParam('products.price', $this->price));
        }

        if ($this->currency) {
            $this->subQuery->andWhere(Db::parseParam('products.currency', $this->currency));
        }

        return parent::beforePrepare();
    }
}
```

The lack of type declarations for the `price` and `currency` properties (or their corresponding setter method arguments) on the element query class is intentional: they should accept any values compatible with [Db::parseParam()](craft5:craft\helpers\Db::parseParam()). We’ll cover some more examples of [param normalization](#normalizing-query-params) in a moment.

Back in your element class, implement the `find()` method and return a new instance of your query class:

```php
use craft\base\Element;
use mynamespace\elements\db\ProductQuery;

// ...

class Product extends Element
{
    public static function find(): ProductQuery
    {
        return new ProductQuery(static::class);
    }

    // ...
}
```

Now you’re ready to start querying for elements of your type:

```php
Product::find()
    ->price(100)
    ->all();
```

#### `$this->query` vs. `$this->subQuery`

Behind the scenes, <craft5:craft\elements\db\ElementQuery> creates two <craft5:craft\db\Query> instances: the main query (`$this->query`), and a subquery (`$this->subQuery`). Column selections should go in the main query, and conditions/joins should be applied to the subquery. The subquery will ultimately become the `FROM` clause of the main query.

The reason for this separation is performance. It allows MySQL/PostgreSQL to figure out exactly which element rows should be fetched before it has to worry about which columns to select, avoiding the need to run expensive condition operations on temporary tables.

#### Normalizing Query Params

Your query class is responsible for synthesizing and normalizing its params in the `beforePrepare()` method and applying them as <craft5:craft\db\Query::where()>-compatible conditions. Oftentimes, this is only a matter of processing params with the appropriate helper methods:

- [`Db::parseParam()`](craft5:craft\helpers\Db::parseParam()): Type-agnostic.
- [`Db::parseDateParam()`](craft5:craft\helpers\Db::parseDateParam()): Normalizes `DateTime` values.
- [`Db::parseBooleanParam()`](craft5:craft\helpers\Db::parseBooleanParam()): Normalizes boolean values and provides a means for dealing with `null` values in the database.
- [`Db::parseNumericParam()`](craft5:craft\helpers\Db::parseNumericParam()): Rejects non-numeric values.
- [`Db::parseMoneyParam()`](craft5:craft\helpers\Db::parseMoneyParam()): Process conditions including currency-like values into storage-safe integers;

This may also mean reconciling conflicting params, or expanding short-hand params into real column-based conditions.

Query params don’t have to match column names, nor do all column names have to be represented as query params. For instance, if our element also tracked `stock`, and our table included a `stock` column, we _could_ provide a query parameter of the same name—but we could also make it simpler for developers using our element type to query for “available” products, like this:

```php
class ProductQuery extends ElementQuery
{
    public $stock;
    public bool $isAvailable;

    // ...

    public function isAvailable(null|bool $value): self
    {
        $this->isAvailable = $value;

        return $this;
    }

    public function beforePrepare(): bool
    {
        // ...

        if ($this->isAvailable !== null) {
            if ($this->isAvailable) {
                $this->subQuery->andWhere(Db::parseParam('products.stock', '>', 0));
            } else {
                $this->subQuery->andWhere(Db::parseParam('products.stock', '<=', 0));
            }
        }

        return parent::beforePrepare();
    }
}
```

Other criteria may contribute to the definition of “available,” or create situations where an impossible set of conditions are applied (like “available” products with a stock of less than 0). It’s up to you whether you allow contradictions, silently resolve them, or throw an exception.

::: warning
When modifying your query, new params should be applied with `andWhere()` instead of `where()`, as the latter will clear _any_ existing conditions, including those that Craft uses to handle soft-deleted and disabled elements.
:::

### Querying for Elements in Templates

If your element type is useful to developers in Twig, you’ll want to expose an element query factory function. For consistency, we’ll look at how to add a method like `craft.entries()` or `craft.categories()` to the global `craft` variable (an instance of [CraftVariable](craft5:craft\web\twig\variables\CraftVariable)) by attaching a [behavior](behaviors.md) to it.

Your behavior class (in a new file at `variables/CraftVariableBehavior.php`) should look like this:

```php
namespace mynamespace\variables;

use mynamespace\elements\Product;
use mynamespace\elements\db\ProductQuery;
use Craft;
use yii\base\Behavior;

/**
 * The class name isn't important, but we've used something that describes
 * how it is applied, rather than what it does.
 * 
 * You are only apt to need a single behavior, even if your plugin or module
 * provides multiple element types.
 */
class CraftVariableBehavior extends Behavior
{
    public function products(array $criteria = []): ProductQuery
    {
        // Create a query via your element type, and apply any passed criteria:
        return Craft::configure(Product::find(), $criteria);
    }
}
```

To attach the behavior, return to your main class’s `init()` method and listen for the `CraftVariable::EVENT_DEFINE_BEHAVIORS` event:

```php
use yii\base\Event;
use craft\events\DefineBehaviorsEvent;
use craft\web\twig\variables\CraftVariable;
use mynamespace\variables\CraftVariableBehavior;

Event::on(
    CraftVariable::class,
    CraftVariable::EVENT_DEFINE_BEHAVIORS,
    function(DefineBehaviorsEvent $e) {
        $e->sender->attachBehaviors([
            CraftVariableBehavior::class,
        ]);
    }
);
```

## Fields + Content

Every element comes with automatic support for custom fields and multi-site content.

### Titles

If your elements need user-defined titles, add a static `hasTitles()` method to your element class:

```php
public static function hasTitles(): bool
{
    return true;
}
```

### Field Layouts

Element types that support content need to define a field layout. Field layouts are stored in the database, but can be reflected in (and controlled by) [project config](./project-config.md), as well.

This process begins by providing administrators a place to manage the field layout—usually as part of your plugin’s [settings](./plugin-settings.md) screen. Craft provides a `fieldLayoutDesignerField` macro via `_includes/forms.twig`, which will output a field layout designer and register all the necessary scripts:

```twig
{% import '_includes/forms.twig' as forms %}

{{ forms.fieldLayoutDesignerField({
  fieldLayout: craft.app.fields.getLayoutByType(
    'mynamespace\\elements\\Product'
  ),
}) }}
```

Place that within a `<form>` that posts to one of your plugin’s [controllers](./controllers.md). Craft provides a convenience method for collecting field layout data from a POST request:

```php
$fieldLayout = Craft::$app->getFields()->assembleLayoutFromPost();
$fieldLayout->type = Product::class;
```

The controller (or a [service](./services.md)) can save the field layout by passing it to <craft5:craft\services\Fields::saveLayout()>:

```php
Craft::$app->getFields()->saveLayout($fieldLayout);
```

For element types that only require a single field layout, you can look them up with just the class name—its ID is irrelevant:

```php
public function getFieldLayout()
{
    return \Craft::$app->getFields()->getLayoutByType(self::class);
}
```

::: tip
Read about managing [multiple field layouts](#variations-multiple-field-layouts), or storing [field layouts in project config](#project-config).
:::

#### Native Layout Elements

<See path="field-layout-element-types.md" />

Native element properties (like our Product’s `price`) can be made editable via the [sidebar](#edit-screen), or as customizable [field layout elements](field-layout-elements.md). Craft has some pre-packaged field layout elements (like <craft5:craft\fieldlayoutelements\TitleField>), but you are responsible for configuring others—either with the existing classes, or by implementing new layout elements:

```php
use craft\models\FieldLayout;
use craft\events\DefineFieldLayoutFieldsEvent;
use craft\fieldlayoutelements\TextField;
use craft\fieldlayoutelements\TitleField;
use mynamespace\elements\Product;

Event::on(
    FieldLayout::class,
    FieldLayout::EVENT_DEFINE_NATIVE_FIELDS,
    function(DefineFieldLayoutFieldsEvent $event) {
        /** @var FieldLayout $fieldLayout */
        $fieldLayout = $event->sender;

        // We only want to provide these options to our product field layouts:
        if ($fieldLayout->type !== Product::class) {
            return;
        }

        // Add a title field:
        $event->fields[] = TitleField::class;

        // Add a customized "text" field for our `price` attribute:
        $event->fields[] = [
            'class' => TextField::class,
            'attribute' => 'price',
            'type' => 'number',
            'mandatory' => true,
            'min' => 0,
            // ...see the `TextField` definition for more options!
        ];
    }
);
```

`mandatory` here means that the layout element _must_ be present in the field layout, not that a value is required. Even if a developer has not customized the field layout, Craft will ensure this layout element is added to the first tab. The `TitleField` layout element is mandatory by default, and assumes the title comes from a `title` attribute, so there’s nothing to customize!

Field layout elements that map to native attributes on your element should be [declared as “safe”](guide:structure-models#safe-attributes) so that they can be mass-assigned by the `elements/save` action. If you maintain your own controller, you will need to manually assign each attribute (i.e: `$element->price = Craft::$app->getRequest()->getRequiredBody('price'))`).

Take a look at the existing [field layout element types](repo:craftcms/cms/blob/5.x/src/fieldlayoutelements) to see which makes the most sense for your attribute. Field layout elements that exist only to provide feedback or information should extend <craft5:craft\fieldlayoutelements\BaseUiElement>.

::: tip
Despite basing our `price` layout element on <craft5:craft\fieldlayoutelements\TextField>, the class supports a wide variety of customizations. Here, we’ve begun to transform it into a `number` input.
:::

Custom fields are handled for you, automatically—they’ll appear just below your element type’s native field layout elements in the field layout designer sidebar.

### Saving Custom Field Values

When saving values to a custom field attached to your element, can use any combination of [`setFieldValue()`](craft5:craft\base\ElementInterface::setFieldValue()), [`setFieldValues()`](craft5:craft\base\ElementInterface::setFieldValues()), and direct assignment to a property corresponding to its instance handle.

::: code
```php Single Value
// Direct assignment:
$product->myCustomField = 'foo';

// Via helper method:
$product->setFieldValue('myCustomField', 'foo');

\Craft::$app->getElements()->saveElement($product);
```
```php Multiple Values
// Direct assignment:
$product->myCustomField = 'foo';
$product->myOtherCustomField = 'bar';

// Via bulk method:
$product->setFieldValues([
    'myCustomField' => 'foo',
    'myOtherCustomField' => 'bar',
]);

\Craft::$app->getElements()->saveElement($product);
```
:::

When using Craft’s default `elements/save` controller action, field values are automatically assigned from POST data.

#### Validating Required Custom Fields

Required custom fields are only enforced when the element is saved using the `live` [validation scenario](guide:structure-models#scenarios). Set the scenario before calling `saveElement()`:

```php
$element->setScenario(\craft\base\Element::SCENARIO_LIVE);
```

### Localization

If your elements’ title and custom field values should be stored on a per-site basis, add a static `isLocalized()` method:

```php
public static function isLocalized(): bool
{
    return true;
}
```

By default, elements will be stored in all sites. If an element should only be stored for certain sites, add a `getSupportedSites()` method to it.

```php
public function getSupportedSites(): array
{
    return [
        1,
        2,
        ['siteId' => 3, 'enabledByDefault' => false],
    ];
}
```

The values in the array returned by `getSupportedSites()` can either be integers (site IDs) or an array with a `siteId` key and optionally an `enabledbyDefault` key (boolean) indicating whether the element should be enabled by default for that site. The actual values here should be determined dynamically, or via configuration—not hard-coded.

::: tip
Elements that support multiple sites will have their `afterSave()` method called multiple times, once for each site that the element supports. You can tell whether it’s being called for the originally-submitted site versus a propagated site by checking `$this->propagating`.
:::

## Element Index

All that is required to support [element indexes](../system/elements.md#indexes) is a route that points to a template containing this:

```twig
{# This template is provided by Craft: #}
{% extends '_layouts/elementindex.twig' %}

{# Set a page title: #}
{% set title = 'Products'|t('my-plugin') %}

{# Let Craft know what element type the index is for: #}
{% set elementType = 'mynamespace\\elements\\Product' %}
```

To let authors create new elements from this page, define an `actionButton` block:

```twig
{% block actionButton %}
    {{ tag('a', {
        class: 'btn submit add icon',
        href: actionUrl('elements/create', {
            elementType: elementType
        }),
        text: 'New product'|t('my-plugin'),
    }) }}
{% endblock %}
```

::: tip
Some element types may require more information to properly initialize, or will enforce permissions based on initial configuration. Entries, for example, are always created in a particular _section_—and a user may not be [permitted](#permissions) to create them in every section they’re allowed to view or publish in. In these cases, you may need to define extra params in the action URL, or <badge vertical="baseline" type="verb">POST</badge> to your own controller.
:::

Your index’s route should be registered via [`EVENT_REGISTER_CP_URL_RULES`](craft5:craft\web\UrlManager::EVENT_REGISTER_CP_URL_RULES):

```php
use craft\events\RegisterUrlRulesEvent;
use craft\web\UrlManager;
use yii\base\Event;

Event::on(
    UrlManager::class,
    UrlManager::EVENT_REGISTER_CP_URL_RULES,
    function (RegisterUrlRulesEvent $event) {
        $event->rules['products'] = ['template' => 'my-plugin/products/_index.twig'];
    }
);
```

A controller is not necessary, here—the route maps directly to a template.

At this point, your element index will be empty. You can skip down to the [Editing Elements](#editing-elements) section to learn more about populating and persisting elements!

### Sources

Element sources are sets of criteria that form the basis of how users interact with your index and [relation fields](#relation-field). Default sources can be defined by your element type by implementing the protected static [defineSources()](craft5:craft\base\Element::defineSources()) method:

```php
protected static function defineSources(string $context = null): array
{
    return [
        [
            'key' => '*',
            'label' => 'All Products',
            'criteria' => []
        ],
        [
            // Optional: Divide your source list into groups!
            'heading' => Craft::t('plugin-handle', 'Currencies'),
        ],
        [
            'key' => 'cad',
            'label' => 'CAD',
            'criteria' => [
                'currency' => 'cad',
            ]
        ],
        [
            'key' => 'usd',
            'label' => 'USD',
            'criteria' => [
                'currency' => 'usd',
            ],
            // Define a default sort attribute and direction:
            'defaultSort' => ['price', 'desc'],
        ],
    ];
}
```

When a source is selected, Craft will configure the element index’s query with the defined `criteria`. Each key in the `criteria` array must correspond to a public property on your [query class](#element-query-class).

Administrators are able to rearrange and customize columns of default sources, but cannot _remove_ them entirely. [Conditions](./conditions.md) can only be applied to new, custom sources. _Any_ user can temporarily create additive conditions via the search + filter bar on an element index.

::: tip
The returned array can also be built dynamically. For example, [entries](../reference/element-types/entries.md) define a source for each _section_, and [categories](../reference/element-types/categories.md) define a source for each _category group_.

Consider hiding sources that the current user would not be able to access, based on their [permissions](#permissions).
:::

<Block label="Criteria vs. Conditions">

You may combine the opaque `criteria` source option with the more transparent `defaultFilter`. Default filters are constructed as [conditions](conditions.md), and allow users to tweak them after a source is loaded:

```php
use craft\elements\Entry;
use craft\elements\conditions\DateUpdatedConditionRule;

// ...

$condition = Entry::createCondition();
$condition->setConditionRules([
    new DateUpdatedConditionRule([
        'attributes' => [
            // Keep in mind, these are just defaults!
            // Users will be able to update them via the filter/condition UI.
            'rangeType' => DateRange::TYPE_AFTER,
            'periodValue' => 7,
            'periodType' => DateRange::PERIOD_DAYS_AGO,
        ],
    ]),
]);

// ...

return [
    // ...
    [
        'key' => 'recent-edits',
        'label' => 'Recently Edited',
        'criteria' => [],
        'defaultFilter' => $condition,
        'defaultSort' => ['dateUpdated', 'desc'],
    ],
];
```

The applied conditions are _additive_, so:

- Condition rules that get [exclusive control](craft5:craft\elements\conditions\ElementConditionRuleInterface::getExclusiveQueryParams()) will not be available to users when already present in the source’s `criteria`;
- Users may not expand the visible results beyond what is defined in the source’s `criteria`;

Default filters can also be used when registering sources via <craft5:craft\base\Element::EVENT_REGISTER_SOURCES>.

</Block>

### Table Attributes

You can customize which columns should be available to your element indexes’ Table views by adding a protected [defineTableAttributes()](craft5:craft\base\Element::defineTableAttributes()) method to your element class:

```php
protected static function defineTableAttributes(): array
{
    return [
        'title' => \Craft::t('app', 'Title'),
        'price' => \Craft::t('plugin-handle', 'Price'),
        'currency' => \Craft::t('plugin-handle', 'Currency'),
    ];
}
```

Custom fields attached via a [field layout](#field-layouts) are always available for selection.

::: tip
The first attribute you list here is a special case. It defines the header for the first column in the table view, which is the only one admins can’t remove. Its values will come from your elements’ <craft5:craft\base\ElementInterface::getUiLabel()> method.
:::

If it’s a big list, you can also limit which columns should be visible by default for new [sources](#sources) by adding a protected [defineDefaultTableAttributes()](craft5:craft\base\Element::defineDefaultTableAttributes()) method to your element class:

```php
protected static function defineDefaultTableAttributes(string $source): array
{
    return ['title', 'price', 'currency'];
}
```

If a user has customized a source, the default attributes will no longer apply to that view. For your [default sources](#sources), consider tailoring the default columns by building the list of attributes dynamically.

Table attribute values default to the corresponding element attribute, cast as a string. Add a protected `tableAttributeHtml()` method on your element class to override the returned HTML:

```php
protected function attributeHtml(string $attribute): string
{
    switch ($attribute) {
        case 'price':
            return \Craft::$app->formatter->asCurrency($this->price, $this->currency);

        case 'currency':
            return strtoupper($this->currency);
    }

    return parent::attributeHtml($attribute);
}
```

Craft can automatically handles a wide variety of data types—including arrays and relationships—by calling the parent implementation. You may not need to customize the output of every attribute! Custom fields that implement <craft5:craft\base\PreviewableFieldInterface> are handled automatically.

### Sort Options

In order for your element index to be sortable, you must implement the protected static [defineSortOptions()](craft5:craft\base\Element::defineSortOptions()) method:

```php
protected static function defineSortOptions(): array
{
    return [
        'title' => \Craft::t('app', 'Title'),
        'price' => \Craft::t('plugin-handle', 'Price'),
    ];
}
```

When a sort option is selected on an index, its key will be passed to the `$orderBy` property of your [element query](#element-query-class) class (e.g. `['price' => SORT_ASC]`). Should you need to customize the behavior of a sort attribute provide that attribute as an array:

```php
[
    'label' => Craft::t('app', 'Date Updated'),
    'orderBy' => 'elements.dateUpdated',
    'attribute' => 'dateUpdated',
    'defaultDir' => 'desc',
],
```

### Exporters

Define which [exporter types](element-exporter-types.md) your element type supports on its index page by adding a protected static [defineExporters()](craft5:craft\base\Element::defineExporters()) method on your element class:

```php
protected static function defineExporters(string $source): array
{
    $exporters = parent::defineExporters($source);
    $exporters[] = MyExporter::class;
    return $exporters;
}
```

### Actions

The [defineActions()](craft5:craft\base\Element::defineActions()) method determines which [actions](element-actions.md) your element type supports on its index page:

```php
protected static function defineActions(string $source = null): array
{
    return [
        FooAction::class,
        BarAction::class,
    ];
}
```

#### Restore Action

All element types are [soft-deletable](soft-deletes.md) out of the box, but it’s up to each element type to decide whether they can be restored.

To make an element restorable, add the <craft5:craft\elements\actions\Restore> action to the array returned by your [defineActions()](#actions) method. Craft will automatically hide it during normal index views, and show it when a user selects the “Trashed” status option.

### Thumb View

Thumbnail views can be be enabled for your element index page on a [source](#sources)-by-source basis.

To enable thumbnail view for a source, add a `hasThumbs` key to its definition:

```php
protected static function defineSources(string $context = null): array
{
    return [
        [
            'key' => 'cad',
            'label' => 'CAD',
            'criteria' => [
                'currency' => 'cad',
            ],
            'hasThumbs' => true,
        ],
        // ...
    ];
}
```

Then, add a `getThumbUrl()` method to your element class, which returns the URL to the current element’s thumbnail:

```php
use craft\helpers\UrlHelper;

// ...

public function getThumbUrl(int $size): ?string
{
    return UrlHelper::resourceUrl("product-images/{$this->id}/{$size}");
}
```

## Statuses

If your elements should have their own statuses, give your element class a static <craft5:craft\base\ElementInterface::hasStatuses()> method:

```php
public static function hasStatuses(): bool
{
    return true;
}
```

### Custom Statuses

An element’s status can be determined by a single property, or a combination of multiple properties. Similarly, _setting_ an element’s status may mean multiple properties are being assigned.

By default, your elements will support two statuses: Enabled and Disabled. If you’d like to give your element type its own custom statuses, first define what they are by overriding its static <craft5:craft\base\ElementInterface::statuses()> method:

```php
public static function statuses(): array
{
    return [
        'foo' => ['label' => \Craft::t('plugin-handle', 'Foo'), 'color' => '27AE60'],
        'bar' => ['label' => \Craft::t('plugin-handle', 'Bar'), 'color' => 'F2842D'],
    ];
}
```

Next add a <craft5:craft\base\ElementInterface::getStatus()> method that returns the current status of an element:

```php
public function getStatus(): ?string
{
    if ($this->fooIsTrue) {
        return 'foo';
    }

    return 'bar';
}
```

Finally, override the <craft5:craft\elements\db\ElementQuery::statusCondition()> method on your [element query class](#element-query-class):

```php
protected function statusCondition(string $status): mixed
{
    switch ($status) {
        case 'foo':
            return ['foo' => true];
        case 'bar':
            return ['bar' => true];
        default:
            // Call the base method to handle `enabled` or `disabled`:
            return parent::statusCondition($status);
    }
}
```

Custom statuses are automatically added to the filter menu on your element index.

### Status Action

Craft adds the <craft5:craft\elements\actions\SetStatus> action to your [element index](#element-index) so users may enable and disable elements in bulk—but if you want your custom statuses to be selectable here, you will need to create a <craft5:craft\base\ElementAction> subclass and return it from your element’s [defineActions()](#actions) method.

## Searchable Attributes

When an element is saved, Craft’s _search_ service will index its “searchable attributes” as keywords on the element. By default, the list of searchable attributes will only include the element’s title and slug—plus any custom field values.

If your element type has additional attributes you want to make searchable, return them from a protected static [defineSearchableAttributes()](craft5:craft\base\Element::defineSearchableAttributes()) method:

```php
protected static function defineSearchableAttributes(): array
{
    return [
        'price',
        'sku',
        'vendor',
    ];
}
```

### Keywords

Craft can handle a variety of data types when generating keywords, but for anything requiring customization, implement the `searchKeywords()` method:

```php
protected function searchKeywords(string $attribute): string
{
    // Add the currency to search terms:
    if ($attribute === 'price') {
        return join(' ', [
            $this->$attribute,
            $this->currency,
        ]);
    }

    return parent::searchKeywords($attribute);
}
```

Keywords are normalized by the search service, but you are welcome to do any additional grooming to the data prior to returning it.

## Element URLs

When an element is being saved, its `getUriFormat()` method will be called to find out whether the element should have its own URI in the system, and if so, what it should look like.

If your elements need their own URLs, you must implement this method and have it return a string that can be parsed with <craft5:craft\web\View::renderObjectTemplate()> (e.g. `products/{slug}`). Usually, this should be a user-defined string, rather than something hard-coded. Supposing our product element type made use of an intermediate _Type_ that determines its URI format (as entries and sections do), the method might look like this:

```php
public function getUriFormat(): ?string
{
    return $this->getType()->uriFormat;
}
```

URIs are rendered and stored on a per-site basis. Whenever an element’s URL is requested, Craft will instantiate the element and call its `getRoute()` method. Internally, <craft5:craft\base\Element::getRoute()> will call a protected `route()` method, which is what you should implement in your element class:

```php
protected function route(): array|string|null
{
    return [
        'templates/render', [
            // Again, assuming a `ProductType` model makes this configurable:
            'template' => $this->getType()->template,
            'variables' => [
                'product' => $this,
            ]
        ]
    ];
}
```

## Editing Elements

Craft makes editing elements frictionless by providing turn-key edit screens as well as automatic support for [slideouts](#slideouts).

### Edit Screen

To give your elements dedicated edit pages, you must define a route that agrees with their `getCpEditUrl()` method. Collocate this rule with the one that defines your [index](#element-index):

```php{5}
// Index:
$event->rules['products'] = ['template' => 'my-plugin/products/_index.twig'];

// Edit:
$event->rules['products/<elementId:\d+>'] = 'elements/edit';
```

Craft takes care of assembling the actual edit template, through the unified [`elements/edit`](craft5:craft\controllers\ElementsController::actionEdit()) controller action.

::: warning
You can use your own controller to render element edit screens, but it becomes your responsibility to handle permissions, drafts, revisions, and auto-saving.
:::

The areas of the element edit screen that require customization are typically handled by implementing additional methods on your element:

[`metadata()`](craft5:craft\base\Element::metadata())
: Defines pairs of labels + data that are rendered in the element’s sidebar. Metadata is not intended to be editable. Values will be merged with the [defaults](craft5:craft\base\Element::getMetadata()).

[`metaFieldsHtml()`](craft5:craft\base\Element::metaFieldsHtml())
: Responsible for rendering the region of the sidebar intended for editable fields.

#### Slideouts

Craft uses the same methods that build element edit screens to generate responses that target [slideouts](../system/control-panel.md#slideouts).

Elements are given an opportunity to customize control panel screen responses via the `prepareEditScreen()` method:

```php
public function prepareEditScreen(Response $response, string $containerId): void
{
    $response->crumbs([
        [
            'label' => Craft::t('my-plugin', 'Products'),
            'url' => UrlHelper::cpUrl('products'),
        ],
        [
            'label' => $this->getType()->name,
            'url' => UrlHelper::cpUrl("products/{$type->handle}"),
        ],
    ]);
}
```

::: tip
If you are interested in rendering context-agnostic views for your element (or other features), take a look at the [control panel screens](./controllers.md#control-panel-screens) controller documentation.
:::

### Saving

Most element types can use the generic `elements/save` controller action to persist data. Craft will use the <badge vertical="baseline" type="verb">POST</badge> body to bulk-assign and typecast [safe attributes](guide:structure-models#safe-attributes) with <craft5:craft\base\Model::setAttributes()>, populate custom fields with <craft5:craft\base\Element::setFieldValues()>, check permissions, validate, and eventually save the element.

Any time you _do_ require some special handling (or need to do more sophisticated authorization than is encapsulated by the element’s [`canSave()`](#permissions) method), you should implement a custom [controller](./controllers.md) action. To programmatically save an element, you will need to do at least the following:

```php
// Create a new product element (or look it up by ID):
$product = new Product();

// Set the main properties from POST data
$request = Craft::$app->getRequest();

$product->price = $request->getBodyParam('price');
$product->currency = $request->getBodyParam('currency');
$product->enabled = (bool)$request->getBodyParam('enabled');

// Set custom field values from POST data in a `fields` namespace
$product->setFieldValuesFromRequest('fields');

// Save the product
if (!Craft::$app->getElements()->saveElement($product)) {
    // Return errors, if necessary:
    return $this->asModelFailure(
        $product,
        Craft::t('my-plugin', 'Product could not be saved.'),
        'product',
    );
}

// Done! Return a success message and redirect:
return $this->asModelSuccess(
    $product,
    Craft::t('my-plugin', 'Product saved.'),
    'product',
    'products/{id}',
);
```

The elements service will in turn call your element’s [`beforeSave()` and `afterSave()` methods](#save-hooks), in which you must persist any native attributes.

::: tip
This process is discussed in greater depth in the [controllers documentation](./controllers.md#model-lifecycle).
:::

## Permissions

It is up to you to design a [permissions scheme](./user-permissions.md) that makes sense for your element type. A user’s ability to perform certain actions on an element (view, delete, duplicate, etc.) is ultimately determined by one the element’s `can*` methods, which must return a boolean.

Action | Method
------ | ------
View | [`canView()`](craft5:craft\base\Element::canView())
Update | [`canSave()`](craft5:craft\base\Element::canSave())
Duplicate | [`canDuplicate()`](craft5:craft\base\Element::canDuplicate())
Delete | [`canDelete()`](craft5:craft\base\Element::canDelete()) and [`canDeleteForSite()`](craft5:craft\base\Element::canDeleteForSite())
Create Drafts | [`canCreateDraft()`](craft5:craft\base\Element::canCreateDraft())

::: warning
The default implementation of these methods in <craft5:craft\base\Element> is typically _restrictive_, meaning users will be _denied_ access by default.

Your element should always call the parent method to ensure that [events](events.md) are emitted when a permission check is taking place.
:::

If your element would benefit from a user-manageable permissions structure, you must [register each relevant permission](./user-permissions.md) and check them in the corresponding methods—or as part of custom [controller actions](#saving).

## Relations

### Relation Field

You can give your element its own relation field by creating a new [field type](field-types.md) that extends <craft5:craft\fields\BaseRelationField>.

That base class does most of the grunt work for you, so you can get your field up and running by implementing three methods:

```php
<?php
namespace mynamespace\fields;

use craft\fields\BaseRelationField;
use mynamespace\elements\Product;

class Products extends BaseRelationField
{
    public static function displayName(): string
    {
        return \Craft::t('plugin-handle', 'Products');
    }

    public static function elementType(): string
    {
        return Product::class;
    }

    public static function defaultSelectionLabel(): string
    {
        return \Craft::t('plugin-handle', 'Add a product');
    }
}
```

Be sure and [register your field type](field-types.md#registering-custom-field-types), so that developers can select it!

## Eager-Loading

If your element type has its own [relation field](#relation-field), it is already eager-loadable through that. Furthermore, if you have declared support for [content](#fields--content), any elements that are selected as relations via other relational fields will be eager-loadable from your element.

Eager-loading support is _not_ provided automatically for “hard-coded” relations with other elements. For example, entries have authors (user elements), but those relationships are stored in a separate `entries_authors` table.

If your elements maintain this kind of relationship to other elements, make them eager-loadable by adding an `eagerLoadingMap()` method to your element class:

```php
use craft\db\Query;
use craft\elements\User;
use craft\helpers\ArrayHelper;

// ...

public static function eagerLoadingMap(array $sourceElements, string $handle): array|null|false
{
    // Memoize the source element IDs:
    $sourceElementIds = ArrayHelper::getColumn($sourceElements, 'id');

    // The “handle” is the key that users will specify
    // when eager-loading this relationship:
    if ($handle === 'vendor') {
        // Do a fresh selection from the products table
        // to create a map of element IDs to vendor IDs,
        // excluding products with no vendor ID:
        $map = (new Query())
            ->select(['id as source', 'vendorId as target'])
            ->from(['{{%plugin_products}}'])
            ->where([
                'and',
                ['id' => $sourceElementIds],
                ['not', ['vendorId' => null]],
            ])
            ->all();

        return [
            'elementType' => User::class,
            'map' => $map,
        ];
    }

    return parent::eagerLoadingMap($sourceElements, $handle);
}
```

This function takes an array of already-queried elements (the “source” elements) and an eager-loading handle. It returns a map of which _source_ element IDs should eager-load which _target_ element IDs. The structure of that array should look something like this:

```php
[
    'elementType' => User::class,
    'map' => [
        // Source: Product ID; Target: User ID
        ['source' => 8735, 'target' => 385],
        ['source' => 7319, 'target' => 1388],
        ['source' => 6684, 'target' => 139],
        ['source' => 6693, 'target' => 139],
        // ...
    ]
]
```

Note that user ID `139` appears twice, for product IDs `6684` and `6693`! That’s to be expected—Craft knows to only load that element _once_, but will make it available on both of those products.

::: tip
You may be able to create the source-target map without another database query, if the target IDs have already been loaded along with the elements! In the example, if products are owned by a single vendor, the vendor ID could be stored an [selected](#element-query-class) such that the map can be assembled in memory:

```php
$map = array_map(function($src) {
    return [
        'source' => $src->id,
        'target' => $src->vendorId,
    ];
}, $sourceElements);
```
:::

To assign eager-loaded elements to a specific attribute (or process the value in some other way), add a `setEagerLoadedElements()` method to your element class:

```php
public function setEagerLoadedElements(string $handle, array $elements, EagerLoadPlan $plan): void
{
    // The handle can be anything, so long as it matches what is used in `eagerLoadingMap()`:
    if ($handle === 'vendor') {
        $vendor = $elements[0] ?? null;
        $this->setVendor($vendor);
    } else {
        parent::setEagerLoadedElements($handle, $elements, $plan);
    }
}
```

Otherwise, Craft stashes the results in a generic `_eagerLoadedElements` array by handle, which you must retrieve later. Be sure and handle each eager-loadable native attribute in this method.

## Advanced Topics

### Reference Tags

If you want your elements to support reference tags (e.g. `{product:100}`), add a static `refHandle()` method to your element class that returns a unique “handle” that should be used for its reference tags.

```php
public static function refHandle(): ?string
{
    return 'product';
}
```

To make it easier for users to copy your elements’ reference tags, you may want to add a “Copy reference tag” [action](#actions) to your element’s index page.

```php
use craft\elements\actions\CopyReferenceTag;

// ...

protected static function defineActions(string $source = null): array
{
    return [
        [
            'type' => CopyReferenceTag::class,
            'elementType' => static::class,
        ],
        // ...
    ];
}
```

### Expiration

In cases where your elements have a “lifespan,” its class should implement <craft5:craft\base\ExpirableElementInterface>, and define a `getExpiryDate()` method. The returned date will be used to calculate the maximum allowable cache duration, when using template caches.

```php
public function getExpiryDate(): ?DateTime
{
    return $this->getNextSaleEndDate();
}
```

### Garbage Collection

Element types should opt into [garbage collection](../system/gc.md) by hooking into the [Gc::EVENT_RUN](craft5:craft\services\Gc::EVENT_RUN) event and calling [Gc::deletePartialElements()](craft5:craft\services\Gc::deletePartialElements()):

```php
use mynamespace\elements\Product;
use craft\db\Table;
use craft\services\Event;
use craft\services\Gc;
use yii\base\Event;

Event::on(
    Gc::class,
    Gc::EVENT_RUN,
    function(Event $event) {
        // Delete `elements` table rows without peers in our custom products table
        Craft::$app->getGc()->deletePartialElements(
            Product::class,
            'plugin_products',
            'id',
        );

        // Delete `elements` table rows without corresponding `content` table rows for the custom element
        Craft::$app->getGc()->deletePartialElements(
            Product::class,
            Table::CONTENT,
            'elementId',
        );
    }
);
```

This helps ensure that any elements missing data get deleted instead of lingering in the database.

::: danger
If not every element is expected to have a row in your custom table (say, you are only creating the record when a certain flag is set by an administrator), garbage-collecting based on that relationship may delete legitimate element records!
:::

### Project Config

One of the benefits of field layouts is that they can be tracked in [project config](project-config.md). Instead of directly saving a field layout to the database from your controller, you can validate and write the layout into a known config key:

```php
use Craft;
use craft\helpers\ArrayHelper;
use craft\helpers\StringHelper;
use craft\web\Controller;
use mynamespace\elements\Product;

$fieldLayout = Craft::$app->getFields()->assembleLayoutFromPost();
$fieldLayout->type = Product::class;

$key = 'myplugin.productFieldLayout';

Craft::$app->getProjectConfig()->set($key, $layout->getConfig());

return $this->asSuccess(Craft::t('plugin-handle', 'Field layout saved.'), $layout);
```

This approach requires that you listen for the resulting [project config events](./project-config.md#step-1-listen-for-config-changes) and make the equivalent changes in the database.

```php
Craft::$app->getProjectConfig()
    ->onAdd('myplugin.productFieldLayout', [$this, 'handleChangedProductLayout'])
    ->onUpdate('myplugin.productFieldLayout', [$this, 'handleChangedProductLayout'])
    ->onRemove('myplugin.productFieldLayout', [$this, 'handleDeletedProductLayout']);
```

In this case, the callable is assumed to be a method on the main plugin or module class—but for more complex extensions, this kind of work is best delegated to a [service](./services.md). See [handling project config changes](./project-config.md#step-2-handle-config-changes) for more information on reacting to the emitted events.

Unlike the main project config example, this single-layout setup doesn’t need to worry about UIDs, because it will always be uniquely identifiable by its `type` column in the database, and its key in project config:

```php
use craft\db\Query;
use craft\db\Table;
use craft\events\ConfigEvent;
use craft\models\FieldLayout;
use mynamespace\elements\Product;

public function handleChangedProductLayout(ConfigEvent $event)
{
    $layout = FieldLayout::createFromConfig($event->newValue);

    // The `type` is not stored in project config:
    $layout->type = Product::class;

    // Look up and assign the database ID, if it exists:
    $id = (new Query())
        ->select(['id'])
        ->from([Table::FIELDLAYOUTS])
        ->where(['type' => Product::class])
        ->scalar();

    // This might be null, but that's OK—just means it's new!
    $layout->id = $id;

    // Save without validating (validation happened before updating project config)
    Craft::$app->getFields()->saveLayout($layout, false);
}

public function handleDeletedProductLayout(ConfigEvent $event)
{
    // There's only one thing to do here—clear any layouts for the element type:
    Craft::$app->getFields()->deleteLayoutsByType(Product::class);
}
```

### Variations + Multiple Field Layouts

In Craft, some element types maintain multiple field layouts: entry field layouts are defined for each entry type; asset field layouts are defined for each asset volume, etc. Custom element types can provide the same functionality—so long as they’re able to reliably match an element with a layout.

Looking at entries again: each entry keeps track of its _type_, which in turn designates a field layout. Entry types are a kind of model that represent configuration rather than data—and in doing so, support some methods that make them easier to serialize for storage in project config.

Let’s look at how we might implement a `ProductType` model that allows different products to have unique field layouts (or other configuration), a la Commerce. Most of the functionality we require will be provided by <craft5:craft\behaviors\FieldLayoutBehavior>:

```php
namespace myplugin\models;

use craft\base\Model;
use craft\behaviors\FieldLayoutBehavior;

use myplugin\elements\Product;

class ProductType extends Model
{
    public ?int $id = null;
    public ?string $name = null;
    public ?int $fieldLayoutId = null;

    protected function defineBehaviors(): array
    {
        return [
            'fieldLayout' => [
                'class' => FieldLayoutBehavior::class,
                'elementType' => Product::class,
            ],
        ];
    }

    public function getConfig(): array
    {
        // Define base component configuration:
        $config = [
            'name' => $this->name,
        ];

        // Add a field layout, if one is defined:
        $fieldLayout = $this->getFieldLayout();

        if ($fieldLayoutConfig = $fieldLayout->getConfig()) {
            // Store the field layout, keyed by its UID:
            $config['fieldLayout'] = [
                $fieldLayout->uid => $fieldLayoutConfig,
            ];
        }

        return $config;
    }
}
```

This is an incomplete implementation (it should—at a minimum—declare validation rules and set [reservedFieldHandles](craft5:craft\behaviors\FieldLayoutBehavior::reservedFieldHandles) on the `FieldLayoutBehavior`), but the skeleton contains enough for us to build on.

Saving a product type looks similar to how we were handling a [single field layout](#single-field-layouts), but the project config keys are updated such that each product type is identified by a UID:

```php
use Craft;
use craft\helpers\Db;
use craft\web\Controller;

use mynamespace\models\Product;
use mynamespace\models\ProductType;

class SettingsController extends Controller
{
    public function actionSaveProductType()
    {
        // Load or instantiate a `ProductType` model and apply incoming params...

        if ($isNew) {
            // Ensure we have a UID for use when updating project config:
            $productType->uid = StringHelper::UUID();
        }

        // Gather the incoming field layout:
        $fieldLayout = Craft::$app->getFields()->assembleLayoutFromPost();
        $fieldLayout->type = Product::class;

        $productType->setFieldLayout($fieldLayout);

        // (In the process of building the field layout, it gives itself a UID!)

        // From above, let the model generate its own config:
        $config = $productType->getConfig();

        Craft::$app->getProjectConfig()->set("myplugin.productTypes.{$productType->uid}", $config, "Updated “{$productType->name}” product type definition.");

        // Was this the first time we saved this model?
        if (!$productType->id) {
            $productType->id = Db::idByUid('{{%plugin_producttypes}}', $productType->uid);
        }
    }
}
```

#### Associating Elements to their Field Layouts

When an element supports content, its `getFieldLayout()` method determines what field layout is used. The base implementation looks it up based on the element’s `$fieldLayoutId` property, but you can use whatever criteria makes sense. Setting an ID as you save the element ensures Craft can load it again later:

```php
// ...
$product->fieldLayoutId = $productType->fieldLayoutId;
Craft::$app->getElements()->saveElement($product);
```

If the `$fieldLayoutId` property is set, <craft5:craft\services\Elements::saveElement()> will store it in the `elements.fieldLayoutId` column in the database, and your elements will be re-populated with the appropriate custom field data when they are fetched, down the road.

::: tip
See the [Edit Screen](#edit-screen) section to learn about creating an edit interface for your elements.
:::
</file>

<file path="extend/environmental-settings.md">
# Environmental Settings

Plugin settings that may need to change per-environment, or contain sensitive information, should be implemented as **environmental settings**.

Environmental settings are settings whose raw values may reference an environment variable or alias, and which get parsed by <craft5:craft\helpers\App::parseEnv()> at runtime.

Here’s an example model with a `$secretKey` property that may be set to an environment variable, and a `getSecretKey()` method that is responsible for parsing the value.

```php
use craft\base\Model;
use craft\helpers\App;

class MyModel extends Model
{
    /**
     * @var string the raw secret key (e.g. '$ENV_NAME')
     */
    public $secretKey;

    /**
     * @return string the parsed secret key (e.g. 'XXXXXXXXXXX')
     */
    public function getSecretKey(): string
    {
        return App::parseEnv($this->secretKey);
    }
}
```

## Validation

If your environmental settings require special validation rules, you can have the validators check the parsed values rather than the raw values using <craft5:craft\behaviors\EnvAttributeParserBehavior>.

```php
use craft\base\Model;
use craft\behaviors\EnvAttributeParserBehavior;

class MyModel extends Model
{
    public function behaviors(): array
    {
        return [
            'parser' => [
                'class' => EnvAttributeParserBehavior::class,
                'attributes' => ['secretKey'],
            ],
        ];
    }

    public function rules(): array
    {
        return [
            ['secretKey', 'required'],
            ['secretKey', 'string', 'length' => 50],
        ];
    }

    // ...
}
```

## Autosuggest Inputs

To guide users when entering your setting’s value in the control panel, give your setting an autosuggest input.

```twig
{% import '_includes/forms.twig' as forms %}

{{ forms.autosuggestField({
  label: 'Secret Key'|t('plugin-handle'),
  id: 'secret-key',
  name: 'secretKey',
  value: myModel.secretKey,
  suggestEnvVars: true
}) }}
```

When `suggestEnvVars` is set to `true`, the autosuggest input will call <craft5:craft\web\twig\variables\Cp::getEnvSuggestions()> to get its suggestions, and a tip will show up below the form field advising the user that they can set the value to an environment variable.

If your setting is for a URL or file system path, you should also set `suggestAliases` to `true`.

```twig{4}
{{ forms.autosuggestField({
  // ...
  suggestEnvVars: true,
  suggestAliases: true
}) }}
```

### Limiting Values

When a setting has a limited number of valid values (and isn’t open-ended), the `forms.selectizeField()` helper can help users discover appropriate environmental values:

```twig{11}
{{ forms.selectizeField({
  label: 'Region'|t('my-plugin'),
  instructions: 'The region this resource is located in.'|t('my-plugin'),
  id: 'region',
  name: 'region',
  options: [
    { label: 'Asia Pacific (Hong Kong)', value: 'ap-east-1' },
    { label: 'Europe (Milan)', value: 'eu-south-1' },
    { label: 'US West (N. California)', value: 'us-west-1' },
  ],
  includeEnvVars: true,
  value: model.region,
  errors: model.getErrors('region')
}) }}
```

For boolean settings, a similar `forms.booleanMenuField()` is available:

```twig
{{ forms.booleanMenuField({
  label: "Use authentication"|t('my-plugin'),
  id: 'useAuthentication',
  name: 'useAuthentication',
  includeEnvVars: true,
  value: model.useAuthentication,
}) }}
```

Boolean fields only list environment variables that contain values satisfying PHP’s underlying [boolean filters](https://www.php.net/manual/en/filter.filters.validate.php).
</file>

<file path="extend/events.md">
---
description: Explore the myriad events Craft emits for customizing the behavior of built-in features.
---

# Events

Craft has all kinds of events you can use to customize how core features work, or connect built-in processes to new functionality. Events are a [Yii concept](guide:concept-events), and are used extensively throughout its architecture. In cases where Yii components are extended for internal use (like <craft5:craft\base\Model>), Craft provides additional events to expose a greater customization surface for developers.

::: tip
See [Using Events in a Custom Module](kb:custom-module-events) for an end-to-end tutorial on wiring up your first event handler in a module.
:::

This page covers customizing Craft’s native behavior by registering event handlers in your plugin, and how to implement [your own events](#custom-events) that other developers can take advantage of.

## Event Code Generator

Quickly find events and generate code samples. Many events will appear more than once, as they’re listed for each class that emits them—read about [discovering events](#discovering-events) for more information!

<event-browser source="craft-5" />

## Anatomy of an Event

We use “event” to describe the **name** and **sender** that uniquely identify it, as well as the actual <yii2:yii\base\Event> instance that is emitted.

### Sender

The class that emits an event is considered its **sender**. The sender is always available via the `sender` property of an event object, and inherits from <yii2:yii\base\Component>. Events are emitted by calling a component’s `trigger()` method, which automatically sets up the event-sender relationship. You can see an example of this in the [custom events](#custom-events) section.

### Name

Combined with the sender, an event’s **name** identifies what a given handler is listening for. Event names are unique among those on the same class. Typically, you will access event names via constants on the sender class (like <craft5:craft\services\Dashboard::EVENT_REGISTER_WIDGET_TYPES>), instead of using the underlying string (`registerWidgetTypes`). Using event constants also allows your IDE to give you suggestions for events, and provide feedback when referencing a non-existent one—they’re also part of our formal deprecation process, receiving docblock tags and [upgrade](updating-plugins.md#events) instructions.

### Event Object

Events are emitted as a <yii2:yii\base\Event> instance, or a subclass thereof. Craft has a number of specific event classes (in the `craft\events\` namespace) that act as specialized containers for data that a handler might be interested in.

### Handled

Each time an event is emitted, a new [event object](#event-object) is created. That object is passed as an argument to each registered handler, until a handler sets the `handled` property to `true`—subsequent handlers are then skipped.

::: warning
Plugins should generally avoid flagging events `handled` unless they expect to have exclusive control over another event property. Craft events that use the `EVENT_SET_*`, `EVENT_DEFINE_*`, or `EVENT_REGISTER_*` naming convention are good examples of this—situations where a handler might need to authoritatively replace an event’s value to guarantee some behavior of the extension.
:::

#### Cancelable Events

Craft extends the “handled” concept via <craft5:craft\events\CancelableEvent>. In addition to `handled`, handlers can set the event’s `isValid` property to `false` to signal that the sender should halt further processing. If you want to prevent other handlers from overriding your `isValid` setting, also set `handled` to `true`.

::: tip
The `isValid` property is not necessarily related to model validation. A handful of Yii events use an `isValid` property to mean a variety of things, but Craft standardizes the behavior via [CancelableEvent](craft5:craft\events\CancelableEvent), using it exclusively as a means to halt a built-in procedure (say, to prevent a user from being activated).

Preventing something from happening in this way is _not_ equivalent to throwing an exception or attempting to end the request from a handler. If an event is cancelable, Craft expects to be able to react to its cancellation—including, potentially, releasing locks or rolling back database transactions.
:::

## Discovering Events

Every event emitted by an application is logged and can be reviewed with the Yii debug toolbar.

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/settings"
    :link="false"
    caption="List of events emitted by Craft and Yii, in the debug toolbar.">
<img src="../images/debug-toolbar-events.png" alt="Screenshot of the Yii debug toolbar">
</BrowserShot>

But what about all the events that _weren’t_ emitted during a given request? Craft and Yii use the same convention for events: every event name is defined exactly one time, as a class constant starting with `EVENT_`.

### Code Diving

The best way to discover an event is to get familiar with a known procedure by stepping through it with a tool like [xdebug](README.md#xdebug) and looking for event constants within or adjacent to the logical flow, or on classes that logic is part of. Alternatively, setting a breakpoint on the low-level <yii2:yii\base\Event::trigger()> or <yii2:yii\base\Component::trigger()> methods will allow you to inspect _every_ event emitted during a request—and view the current call’s trace.

::: tip
A fresh Craft install can easily emit 100 or more events per request, so using your IDE’s _conditional breakpoint_ may be necessary to cut down on noise!
:::

Directly searching the Craft source is a great way to learn about Craft-specific events—but it will miss a host of events emitted by Yii, as well as those that are inherited from parent classes. The [event browser](#event-code-generator) and generator enumerates _all_ of those events, even if they’re technically defined by a parent.

### Inherited Events

Events provided by Craft (those defined on classes in the `craft\*` namespace) represent just the tip of the iceberg. Many classes inherit events from their parents, including classes defined by Yii—let’s use <craft5:craft\elements\Entry> as an example:

1. Only two events exist directly on the `Entry` class:
  - [`EVENT_DEFINE_ENTRY_TYPES`](craft5:craft\elements\Entry::EVENT_DEFINE_ENTRY_TYPES)
  - [`EVENT_DEFINE_PARENT_SELECTION_CRITERIA`](craft5:craft\elements\Entry::EVENT_DEFINE_PARENT_SELECTION_CRITERIA)
2. Its parent class, <craft5:craft\base\Element> defines 38 more:
  - [`EVENT_REGISTER_SOURCES`](craft5:craft\base\Element::EVENT_REGISTER_SOURCES)
  - [`EVENT_REGISTER_FIELD_LAYOUTS`](craft5:craft\base\Element::EVENT_REGISTER_FIELD_LAYOUTS)
  - …
3. `Element` extends <craft5:craft\base\Component>, which doesn’t contribute any—but its parent class <craft5:craft\base\Model> defines five more:
  - [`EVENT_INIT`](craft5:craft\base\Model::EVENT_INIT)
  - [`EVENT_DEFINE_BEHAVIORS`](craft5:craft\base\Model::EVENT_DEFINE_BEHAVIORS)
  - …
4. From here, we jump into <yii2:yii\base\Model>, which defines two more:
  - [`EVENT_BEFORE_VALIDATE`](yii2:yii\base\Model::EVENT_BEFORE_VALIDATE)
  - [`EVENT_AFTER_VALIDATE`](yii2:yii\base\Model::EVENT_AFTER_VALIDATE)
5. The final two classes in the chain of inheritance (<yii2:yii\base\Component> and <yii2:yii\base\BaseObject>) don’t implement any events, themselves.

This one class contains many more events (47, at the time of writing) than is immediately evident. This also represents only the events that would designate an _entry_ as its [sender](#sender)—entries (and elements or models) are passed to a variety of other services, which emit their own events. Another 33 events are emitted by <craft5:craft\services\Elements>, alone!

## Handling Events

Events can be attached with different scopes, depending on your needs.

### Class-Level Events

In this mode, a handler is registered for _all_ occurrences of an event on a class. Class-level handlers are attached using the static <yii2:yii\base\Event::on()>:

```php
use Craft;
use yii\base\Event;
use craft\services\Users;
use craft\events\UserEvent;

Event::on(
    Users::class,
    Users::EVENT_AFTER_ACTIVATE_USER,
    function(UserEvent $e) {
        $message = Craft::$app->getMailer()
            ->composeFromKey('custom.welcome')
            ->setTo($e->user);

        // ...

        $message->send();
    }
);
```

Let’s look at the required arguments:

1. The fully-qualified class name that we expect to emit an event.
2. The event name we want to register the handler for. This should _always_ be a class constant).
3. The [handler](#handler-signature).

Class-level events are almost always attached from a plugin’s `init()` method—but be aware that Craft’s bootstrapping process may trigger some events before handlers can be registered! We advise developers defer as much of their public plugins’ initialization as possible by wrapping it in a call to <craft5:craft\base\ApplicationTrait::onInit()>—this gives other extensions an opportunity to register handlers prior to them actually being triggered.

### Instance-Level Events

If you’re only concerned about events emitted by a _single_ instance of a class, handlers can be directly attached to any subclass of <yii2:yii\base\Component> (effectively every service and model in Craft, including Craft itself).

This example attaches a handler via the singleton <yii2:yii\base\Application> instance that is available as `Craft::$app`:

```php
use Craft;
use yii\base\Application;

Craft::$app->on(
    Application::EVENT_AFTER_REQUEST,
    function(Event $e) {
        // ...
    }
);
```

In a different scenario, we may want to attach a handler on any object that passes through some method in our extension:

```php
namespace mynamespace\myplugin\services;

use craft\base\Element;
use craft\events\ModelEvent;
use yii\base\Component;

class TrackChanges extends Component
{
    public function watch(Element $element): void
    {
        $element->on(
            Element::EVENT_AFTER_SAVE,
            function(ModelEvent $e) {
                $originalAttributes = $e->data->originalAttributes;

                // Perform some comparison of new/old attributes...
            },
            [
                'originalAttributes' => $element->getAttributes(),
            ],
        );
    }
}
```

::: warning
This is a much less common pattern for dealing with built-in components, and will usually involve an initial [class-level](#class-level-events) event handler to discover objects as they’re created, anyway.

In most cases, it’s best to set a class-level listener and check in your handler whether the event (or its sender) is relevant. If you know every instance of a class will require an event, you can also attach them via [behaviors](behaviors.md#events).
:::

This listener makes use of the fourth `$data` argument, which allows you to capture data as part of the handler. This is available on the event object when the handler is invoked, under a `data` property. Be mindful of the volume of data you’re capturing at this stage, as it may prevent PHP from freeing memory.

### Handler Signature

Handlers must be a valid [callable](https://www.php.net/manual/en/language.types.callable.php), and should accept a single argument that matches the expected event type. Our examples so far have used either the generic <yii2:yii\base\Event>, or a type hint of <craft5:craft\events\UserEvent>.

Our previous “[welcome email](#class-level-events)” example could be rewritten to use an external method, like this:

```php
Event::on(
    Users::class,
    Users::EVENT_AFTER_ACTIVATE_USER,
    [MyService::class, 'handleUserActivation']
);
```

In addition to closures and callable expressions, you may also use the native [callable syntax](https://www.php.net/manual/en/functions.first_class_callable_syntax.php):

```php{4}
Event::on(
    Users::class,
    Users::EVENT_AFTER_ACTIVATE_USER,
    MyPlugin::getInstance()->getMyService()->someMethod(...),
);
```

#### Return Values

Return values from handlers are ignored—instead, Craft expects that the handler modifies properties on the event object (or its sender). You may explicitly declare a `void` return type on handlers as a means to identify misuse within your own plugin, but the signature is not enforced.

### Cloning Handlers

Instance-level event handlers are _not_ copied to new instances when using PHP’s `clone()`. If you want to guarantee that your handlers survive this process, create a [behavior](behaviors.md#events) and attach that—behaviors _do_ get copied thanks to <craft5:craft\base\CloneFixTrait>, and any event handlers declared by <yii2:yii\base\Behavior::events()> are re-installed.

Instead of maintaining a behavior for a single handler, you can use the built-in <craft5:craft\behaviors\EventBehavior> as a proxy for registering handlers:

```php
use craft\behaviors\EventBehavior;
use craft\elements\db\ElementQuery;
use craft\elements\Entry;
use craft\events\CancelableEvent;

$query = Entry::find();

$query->attachBehavior('myBehavior', new EventBehavior([
    ElementQuery::EVENT_AFTER_PREPARE => function(CancelableEvent $event, ElementQuery $query) {
        // ...
    },
], true));
```

The second argument to the `EventBehavior` constructor tells the behavior to mimic <craft5:craft\base\Event::once()> and will only invoke your handler once. All handlers are treated the same way, but you may mix one-time and continuous handlers by attaching multiple `EventBehavior` instances.

## Common Event Flows

### Adding Validation Rules

Models in Craft (including [elements](element-types.md)) implement [validation rules](guide:tutorial-core-validators) via a `defineRules()` method. When any model is validated, its `rules()` method is called, which in turn calls `defineRules()`, then emits a <craft5:craft\events\DefineRulesEvent> with those rules set on a `rules` property.

A handler that registers additional rules would look something like this:

```php
use yii\base\Event;
use craft\elements\User;
use craft\events\DefineRulesEvent;

Event::on(
    User::class,
    User::EVENT_DEFINE_RULES,
    function(DefineRulesEvent $e) {
        // Enforce password minimum length:
        $e->rules[] = [['newPassword'], 'string', 'min' => 16];
    }
);
```

Note that the handler is pushing a new rule onto the event’s `rules` property, rather than [returning a value](#return-values).

::: tip
You can add validation rules to custom fields in the same handler:

```php
// Reject a value if it looks like spam:
$e->rules[] = [
    ['field:myCustomFieldHandle'],
    'match',
    'pattern' => '/extended warranty/i',
    'not' => true,
];
```

Building your own [field type](field-types.md)? It should provide validation rules via `getElementValidationRules()`.
:::

This process is the same for any class that extends <craft5:craft\base\Model>—the `EVENT_DEFINE_RULES` event is available on any subclass! To add validation rules to an entry, you would swap out `craft\elements\User` for `craft\elements\Entry`:

```php
use yii\base\Event;
use craft\elements\Entry;
use craft\events\DefineRulesEvent;

Event::on(
    Entry::class,
    Entry::EVENT_DEFINE_RULES,
    function(DefineRulesEvent $e) {
        // Disallow strings of digits that look like years:
        $e->rules[] = [
            ['slug'],
            'match',
            'pattern' => '/[0-9]{4}/',
            'not' => true,
            'message' => Craft::t('my-plugin', 'Slugs should not contain year-like values.'),
        ];
    }
);
```

Custom fields on entries can be validated the same way, by prefixing the handle with `field:`.

### Saving Entries

While every element in Craft has a common set of events your custom code can subscribe to, the entry-saving workflow is one of the most common and complex.

::: tip
See [Handling Entry Saves](kb:handling-entry-saves) for more on entry-specific concepts.
:::

Generally, entries progress through the following order of operations:

1. Pre-flight checks that trigger `EVENT_BEFORE_SAVE`.
2. Validation that triggers `EVENT_BEFORE_VALIDATE` and `EVENT_AFTER_VALIDATE`.
3. Saving for the initial site that triggers `EVENT_AFTER_SAVE`.
4. Propagating non-translatable changes to the entry’s other sites, which repeats steps 1-3 for each site before triggering `EVENT_AFTER_PROPAGATE`.

This process is actually a bit more abstract than this, because it covers _all_ element types. The events above live on the <craft5:craft\base\Element> class, but are inherited by other element types, meaning you can listen to only the subset of element lifecycle events you care about.

#### Bulk Operations

Craft 5 encapsulates operations that affect one or more elements in a special event, <craft5:craft\services\Elements::EVENT_AFTER_BULK_OP>. In cases where you need to act on the final result of a save that may involve multiple elements, consider using this in conjunction with the new element query method <craft5:craft\elements\db\ElementQuery::inBulkOp()>:

```php
use craft\elements\Entry;
use craft\events\BulkOpEvent;
use craft\helpers\Db;
use craft\services\Elements;
use yii\base\Event;

Event::on(Elements::class, Elements::EVENT_AFTER_BULK_OP, function(BulkOpEvent $event) {
    // Fetch the affected entries in batches:
    $entries = Entry::find()
        ->inBulkOp($event->key)
        ->status(null);

    foreach (Db::each($entries) as $entry) {
        // ...
    }
});
```

Note that we didn’t immediately execute the entry query, above; instead, it’s passed to `Db::each()` and “batched” to help keep the memory usage flat. By default, elements will be loaded in chunks of 100.

::: warning
Avoid memoizing the individual `$entry` objects, within the loop! This can prevent PHP from releasing the memory saved by batching the queries. If you need to tally special cases (say, failed communication with a remote API), consider capturing just the ID of the entry, instead:

```php
$skipped = [];

foreach (Db::each($entries) as $entry) {
    if (!$entry->getIsCanonical()) {
        $skipped[] = $entry->id;

        continue;
    }

    // ...
}
```
:::

If your plugin performs many sequential element saves, you can explicitly start and end a bulk operation via the elements service:

```php
$key = Craft::$app->getElements()->beginBulkOp();

// ... save or delete elements ...

Craft::$app->getElements()->endBulkOp($key);
```

The `$key` will be attached to the emitted <craft5:craft\events\BulkOpEvent> so that other code can get a list of elements involved! After the operation is complete (and any handlers have been called), the key will be cleaned up. It is your responsibility to save element IDs elsewhere if you need to do asynchronous processing on elements that were part of a bulk operation!

### Adding and Modifying Search Keywords

If you’d like to extend system components to add your own searchable custom attributes, you can hook into the [`EVENT_REGISTER_SEARCHABLE_ATTRIBUTES`](craft5:craft\base\Element::EVENT_REGISTER_SEARCHABLE_ATTRIBUTES) event.

Here, we’re making the `myCustomAttribute` property searchable for Commerce orders:

```php
use craft\base\Element;
use craft\commerce\elements\Order;
use craft\events\RegisterElementSearchableAttributesEvent;
use yii\base\Event;

Event::on(
    Order::class,
    Element::EVENT_REGISTER_SEARCHABLE_ATTRIBUTES,
    function(RegisterElementSearchableAttributesEvent $event) {
        $event->attributes[] = 'billingCountry';
        // ...
    }
);
```

A “searchable attribute” doesn’t need to correspond to a real property, so long as you later handle the <craft5:craft\base\Element::EVENT_DEFINE_KEYWORDS> event:

```php

use craft\base\Element;
use craft\commerce\elements\Order;
use craft\events\DefineAttributeKeywordsEvent;
use yii\base\Event;

Event::on(
    Order::class,
    Element::EVENT_DEFINE_KEYWORDS,
    function(DefineAttributeKeywordsEvent $event) {
        if ($event->attribute !== 'billingCountry') {
            return;
        }

        $billingAddress = $event->sender->getBillingAddress();
        $country = Craft::$app->getAddresses()
            ->getCountryRepository()
            ->get($billingAddress->countryCode);

        $event->keywords = $country->name;
    }
);
```

The same process can be repeated for each searchable attribute you wish to define—or it can all be packaged into a [behavior](behaviors.md#events)!

## Custom Events

Events are only necessary (or practical) for your extension if you expect other developers to want to customize or react to its behavior. Private plugins and modules generally do not need to emit events, as you (the author) already have complete control over its internal logic!

### The “Evented” Mindset

As you design your extension, it may still be worthwhile to consider some of the patterns that events fit into. Let’s use a newsletter sign-up plugin as an example. Our plugin will need…

- …a **controller** to receive input from a front-end form;
- …a **model** to hold the contact’s details;
- …a **service** to communicate with a third-party API;

Where do events fit in this process? Craft will automatically emit events before our controller action is run, when an instance of our model is created, before and after our model is validated, after a response is sent… and potentially dozens more places in the normal request-response lifecycle.

Our “API” service is still a bit of a black box, though. Let’s give developers access to our request and response objects by creating a pair of events; one emitted just before our request to the API (with a reference to the contact being subscribed), and another emitted when we’re confident a contact has been subscribed (with references to the contact and the raw response data from the API).

::: code
```php Event (Before)
namespace mynamespace\newsletter\events;

use craft\events\CancelableEvent;
use mynamespace\newsletter\models\Contact;

class SubscribeEvent extends CancelableEvent
{
    public Contact $contact;
}
```
```php Event (After)
namespace mynamespace\newsletter\events;

use mynamespace\newsletter\models\Contact;
use yii\base\Event;

class ApiResponseEvent extends Event
{
    public Contact $contact;
    public array $response;
}
```
```php{14,19,35-44,63-66} Service
namespace mynamespace\newsletter\services;

use craft\helpers\Json as JsonHelper;
use mynamespace\newsletter\events\ApiResponseEvent;
use mynamespace\newsletter\events\SubscribeEvent;
use mynamespace\newsletter\models\Contact;
use yii\base\Component;

class MailingList extends Component
{
    /**
     * @var string Event emitted before a contact is added to the mailing list.
     */
    public const EVENT_BEFORE_SUBSCRIBE = 'beforeSubscribe';

    /**
     * @var string Event emitted after a contact has been added to the mailing list.
     */
    public const EVENT_AFTER_SUBSCRIBE = 'afterSubscribe';

    /**
     * Subscribes a contact to the mailing list.
     *
     * @param Contact $contact
     * @return bool
     */
    public function subscribe(Contact $contact): bool
    {
        // Create an HTTP client:
        $client = Craft::createGuzzleClient([
            'base_uri' => 'https://api.mycrm.com/',
        ]);

        // We’re ready! Emit an event:
        $subscribeEvent = new SubscribeEvent([
            'contact' => $contact,
        ]);

        $this->trigger(self::EVENT_BEFORE_SUBSCRIBE, $subscribeEvent);

        // Check if a handler canceled it:
        if (!$subscribeEvent->isValid) {
            return false;
        }

        // Ok, we’re good to go!
        $response = $client->post('org/1234/lists/5678', [
            'form_params' => [
                'name' => $contact->name,
                'email' => $contact->email,
            ],
        ]);

        // Did we upset the API?
        if ($response->getStatusCode() !== 200) {
            return false;
        }

        // Unpack the response:
        $data = JsonHelper::decode($response->getBody()->getContents());

        // Give plugins a chance to react to this, regardless of success state:
        $this->trigger(self::EVENT_AFTER_SUBSCRIBE, new ApiResponseEvent([
            'contact' => $contact,
            'response' => $response,
        ]));

        // Make sure it actually contained the expected “success” flag:
        if ($data['success'] !== true) {
            return false;
        }

        return true;
    }
}
```

The event classes are relatively sparse—they only need to declare properties for the data we wish to send along with them. Note that we are extending <craft5:craft\events\CancelableEvent> for the “before” event!

On the other hand, the service contains a bit of noisy boilerplate for the HTTP request, which isn’t essential to understand. The highlighted lines show where event code has been injected, and how we’re handling any side-effects. 

::: warning
As a product of the [sender](#sender) always being available to an event handler, handlers can pretty easily create infinite loops or call methods that would otherwise interfere with your plugin’s functionality.
:::
</file>

<file path="extend/extending-twig.md">
# Extending Twig

Craft provides two ways for plugins to extend its Twig templating environment.

## Extend the Global `craft` Variable

The [global `craft` template variable](../reference/twig/global-variables.md#craft-2) is an instance of <craft5:craft\web\twig\variables\CraftVariable>. Methods and properties of that class are available in Twig via dot notation—for example, when a template uses `craft.entries` (or `craft.entries()`), Twig calls [CraftVariable::entries()](craft5:craft\web\twig\variables\CraftVariable::entries()) behind the scenes.

That `CraftVariable` instance can be extended by plugins with [behaviors](behaviors.md) and [services](services.md). Choosing the right approach depends on what you’re trying to add to it.

- Use a **behavior** to add custom properties or methods directly onto the `craft` variable (e.g. `craft.foo()`).
- Use a **service** to add a sub-object to the `craft` variable, which can be accessed with a custom property name, called the service’s “ID”. (e.g. `craft.foo.*`).

You can attach your behavior or service to the `CraftVariable` instance by registering an [EVENT_INIT](craft5:craft\web\twig\variables\CraftVariable::EVENT_INIT) event handler from your plugin’s `init()` method:

```php{18-20,23}
use craft\web\twig\variables\CraftVariable;
use yii\base\Event;
use mynamespace\myplugin\behaviors\MyBehavior;
use mynamespace\myplugin\services\MyService;

public function init()
{
    parent::init();

    Event::on(
        CraftVariable::class,
        CraftVariable::EVENT_INIT,
        function(Event $e) {
            /** @var CraftVariable $variable */
            $variable = $e->sender;

            // Attach a behavior:
            $variable->attachBehaviors([
                MyBehavior::class,
            ]);

            // Attach a service:
            $variable->set('serviceId', MyService::class);
        }
    );
}
```

::: tip
On their own, [behaviors](behaviors.md#attachment) are typically attached in response to the dedicated `EVENT_DEFINE_BEHAVIORS` event.
:::

## Create a Twig Extension

New features can be added to Twig by creating a [Twig extension](https://twig.symfony.com/doc/3.x/advanced.html#creating-an-extension).

Extensions follow this signature:

```php
namespace mynamespace\myplugin\twig;

use Craft;
use Twig\Extension\AbstractExtension;
use Twig\TwigFilter;
use Twig\TwigFunction;
use Twig\TwigTest;

class Extension extends AbstractExtension
{
    public function getFilters(): array
    {
        return [
            // First argument is the filter name; second is a callable:
            new TwigFilter('total', 'array_sum'),
        ];
    }

    public function getFunctions(): array
    {
        return [
            // First argument is the function name; second is a callable:
            new TwigFunction('log', [Craft::class, 'info']),
        ];
    }

    public function getTests(): array
    {
        return [
            // First argument is the test name; second is a callable:
            new TwigTest('infinite', 'is_infinite'),
        ];
    }
}
```

::: tip
Filters, functions, and tests are mostly equivalent in their capabilities, but as language constructs have specific uses in the template layer. Consider which makes the most sense for your users! It should be clear in a template what features come from which extensions—either from their naming or how they’re used.
:::

You do not need to define methods that your extension has no use for—except when explicitly implementing the `GlobalsInterface` to inject global variables:

```php {5,8}
namespace mynamespace\myplugin\twig;

use Craft;
use Twig\Extension\AbstractExtension;
use Twig\Extension\GlobalsInterface;
use mynamespace\myplugin\MyPlugin;

class Extension extends AbstractExtension implements GlobalsInterface
{
    // ...

    public function getGlobals(): array
    {
        // Keys are variable names!
        return [
            'myPlugin' => MyPlugin::getInstance(),
        ];
    }
}
```

Here, we’ve set a variable (`myVariable`) to our plugin’s singleton instance. This means that any [services](services.md) you’ve defined will be accessible in all Twig templates:

```twig
{{ myPlugin.myServiceName.myServiceMethod() }}
```

::: warning
Avoid defining global variables that are ambiguous (like `plugin` or `elements`), apt to be frequently overwritten (like `entry` or `block`), or conflict with [built-in globals](../reference/twig/global-variables.md).
:::

### Registering the Extension

Register your Twig extension in your plugin or module’s `init()` method by calling <craft5:craft\web\View::registerTwigExtension()>:

```php {7-8}
public function init()
{
    parent::init();

    if (Craft::$app->getRequest()->getIsSiteRequest()) {
        // Instantiate + register the extension:
        $extension = new mynamespace\myplugin\twig\Extension();
        Craft::$app->getView()->registerTwigExtension($extension);
    }
}
```

The `getIsSiteRequest()` check is optional. If your extension provides features that will be useful in system emails (commonly triggered from the control panel), or will be used when rendering templates from console requests (less common, but still valid), you may want to register it in all contexts.

::: tip
We’ve only covered the simplest means of extending the Twig environment—you can also provide custom _tags_ or _operators_. Craft’s own [Twig extension](https://github.com/craftcms/cms/tree/5.x/src/web/twig) is a great place to look for examples of advanced features.
:::
</file>

<file path="extend/field-layout-element-types.md">
---
description: Create composable editing and UI components for field layouts.
sidebarDepth: 2
related:
  - uri: ../system/fields.md
    label: Fields + Field Layouts
  - uri: ../system/elements.md
    label: Introduction to Elements
  - uri: element-types.md
    label: Element Types
  - uri: field-types.md
    label: Field Types
---

# Field Layout Elements

In addition to content fields, developers can add a handful of other built-in _field layout elements_ to their [field layouts](../system/fields.md#field-layouts) to optimize the author’s attention or productivity. Craft uses field layout elements for titles, some [address](../reference/element-types/addresses.md) components, alt text on [assets](../reference/element-types/assets.md), native [user](../reference/element-types/users.md) attributes, and more. They also power “UI” elements like horizontal rules, breaks, and templates.

Plugins can supplement the built-in field layout elements by creating and registering a class that extends <craft5:craft\base\FieldLayoutElement>. Broadly speaking, field layout elements come in two flavors:

- **Fields** — Features that enhance (or are essential to) collecting data for an element. **Title** fields, users’ **Email** field, and Commerce’s **Variants** nested element management interface are examples of fields. Fields typically extend <craft5:craft\fieldlayoutelements\BaseField> (or one of its subclasses).
- **UI** — Optional features that can be added any number of times, and are not part of the critical authoring path. The built-in **Template** and **Tip** components are examples of UI elements, and are based on <craft5:craft\fieldlayoutelements\BaseUiElement> (or one of its subclasses).

All layout elements are rendered in the context of an element, and support user and element conditions in addition to their own custom settings. We’ll look at how you can adopt these behaviors via your class’s [inheritance](#base-definitions), [public properties](#settings-features), and configuration.

::: tip
Plugins that provide field types _do not_ need to maintain their own field layout element! Instead, they should [return HTML appropriate to the editing context](field-types.md#inputs), which will be wrapped in an instance of <craft5:craft\fieldlayoutelements\CustomField>.
:::

Field layout elements are only used to build the body of the element editor. The sidebar (or “metadata” column), header, and toolbar are managed by each [element type](element-types.md), individually, but can be customized using [events](events.md).

## Class + Registration

Create a new class that extends <craft5:craft\base\FieldLayoutElement> (or one of the [other existing types](#base-definitions)). Our example will display some sort of read-only status information from an external source:

```php
namespace myplugin\fieldlayoutelements;

use Craft;
use craft\base\ElementInterface;
use craft\fieldlayoutelements\BaseUiElement;
use craft\helpers\Html;

class SynchronizationStatus extends BaseUiElement
{
    public function selectorLabel(): string
    {
        return Craft::t('site', 'Synchronization Status');
    }

    public function formHtml(?ElementInterface $element = null, bool $static = false): ?string
    {
        return Html::tag('div', 'Hello, world!');
    }

    protected function selectorIcon(): ?string
    {
        return 'satellite-dish';
    }
}
```

This is only the minimum implementation for a _UI_ field layout element. Explore deeper customization options in the [base definitions](#base-definitions) and [settings](#settings) sections.

To register a field layout element, add the appropriate event listener:

- For native fields, use <craft5:craft\models\FieldLayout::EVENT_DEFINE_NATIVE_FIELDS>;
- For UI elements, use <craft5:craft\models\FieldLayout::EVENT_DEFINE_UI_ELEMENTS>;

::: code
```php Fields
use craft\events\DefineFieldLayoutElementsEvent;
use craft\models\FieldLayout;
use yii\base\Event;

Event::on(
    FieldLayout::class,
    FieldLayout::EVENT_DEFINE_NATIVE_FIELDS,
    function(DefineFieldLayoutFieldsEvent $event) {
        /** @var FieldLayout $layout */
        $layout = $event->sender;

        if ($layout->type === MyElementType::class) {
            $event->fields[] = MyNativeField::class;
        }
    }
);
```
```php UI Elements
use craft\events\DefineFieldLayoutElementsEvent;
use craft\models\FieldLayout;
use yii\base\Event;

Event::on(
    FieldLayout::class,
    FieldLayout::EVENT_DEFINE_UI_ELEMENTS,
    function(DefineFieldLayoutFieldsEvent $event) {
        $event->elements[] = SynchronizationStatus::class;
    }
);
```
:::

In the first example (registering a “native field”), we perform a check to make sure the layout element is only available in layout designers that target a specific element type.

## Base Definitions

Craft includes a handful of abstract types that can be extended to leverage specific features and provide hints as to the layout element’s purpose:

- <craft5:craft\fieldlayoutelements\BaseUiElement> — A static component that typically does not correspond to a specific element property or accept input. Its appearance and output can still
- <craft5:craft\fieldlayoutelements\BaseField> — Common features for native and custom fields, including a label, instructions, tip, warning, whether or not input is “required,” and whether its underlying attribute can be rendered in [element cards](../system/elements.md#chips--cards) or provide [thumbnails](../system/elements.md#chips--cards). HTML inputs that are rendered into layout elements that extend this class are automatically factored in to change tracking, and their values are sent to Craft when saving an element.
- <craft5:craft\fieldlayoutelements\BaseNativeField> — A subclass of `BaseField` that is intended for use with native element attributes (or an attribute provided via a [behavior](behaviors.md)).
- <craft5:craft\fieldlayoutelements\TextField> — General-purpose input element suitable for most scalar values. You can customize many of the underlying HTML element’s attributes via class properties—see below for an example.

::: tip
Somewhat counterintuitively, the <craft5:craft\fieldlayoutelements\CustomField> class is _not_ intended to be extended. Craft automatically wraps each custom field instance with this layout element, exposing actions and [indicators](#indicators-fields) that make sense for the field type. New [field types](field-types.md) should _not_ introduce their own field layout element type—instead, their `getInputHtml()` method should return all markup required for the field to function, and other field methods should signal what features it supports (like multiple instances or conditions).
:::

### Ad-Hoc Elements

In some cases, you may not need to create a dedicated class at all! Suppose we were creating a custom element type to manage currencies and exchange rates—the element type might have a property like `$symbol` to hold a three-character ISO code, which we want to let administrators edit alongside other custom fields. Instead of a custom class, we could register a suitable layout element based on the `TextField` class:

```php
namespace myplugin;

use craft\events\DefineFieldLayoutElementsEvent;
use craft\fieldlayoutelements\TextField;
use craft\models\FieldLayout;
use yii\base\Event;
use myplugin\elements\Currency;

Event::on(
    FieldLayout::class,
    FieldLayout::EVENT_DEFINE_NATIVE_FIELDS,
    function(DefineFieldLayoutFieldsEvent $event) {
        /** @var FieldLayout $layout */
        $layout = $event->sender;

        if ($layout->type === Currency::class) {
            $event->fields[] = [
                'class' => TextField::class,
                'type' => 'text',
                'title' => Craft::t('my-plugin', 'Currency Symbol'),
                'maxlength' => 3,
                'placeholder' => 'USD',
                'autocorrect' => false,
                // ...
            ];
        }
    }
);
```

You can register any value compatible with <craft5:Craft::createObject()>, including strings (like the fully-qualified class name in the previous section), a config object (as above), or an already- instantiated object.

## Settings + Features

For a comprehensive list of methods and properties you can use to customize a field layout element’s behavior, refer to the classes that extend <craft5:craft\base\FieldLayoutElement>. The most important divide in feature sets is between _UI Elements_ (classes that extend <craft5:craft\fieldlayoutelements\BaseUiElement>) and _Fields_ (classes that extend <craft5:craft\fieldlayoutelements\BaseField>). Features available to one or the other are noted.

### Cosmetic

These settings exist primarily to improve the usability and accessibility of fields and UI elements in field layouts.

#### Selector Label

The label displayed when viewing a field layout element in the selector palette, and when it appears within a field layout designer.

```php
protected function selectorLabel(): string
```

#### Icon

An icon that helps identify layout elements of the same type. In mosts cases, this return value should be consistent—but Craft makes use of it to bubble up [dynamic icons](craft5:craft\fieldlayoutelements\CustomField::selectorIcon()) from custom fields.

```php
protected function selectorIcon(): ?string
```

#### Width

By default, field layout elements are full-width. Opt-in to customizable width using `hasCustomWidth()`:

```php
public function hasCustomWidth(): bool
{
    return true;
}
```

#### Indicators (Fields)

To make field layout elements more useful at-a-glance, they support icon-based “indicators.” Craft handles many built-in features (like fields marked as _Required_, or elements with configured conditions), but you can supplement them with your own indicators.

```php
protected function selectorIndicators(): array
{
    // Preserve built-in indicators:
    $indicators = parent::selectorIndicators();

    if ($this->someCustomSetting) {
        $indicators[] = [
            'label' => Craft::t('my-plugin', 'This field layout element may behave differently!'),
            'icon' => 'triangle-exclamation',
            'iconColor' => 'fuchsia',
        ];
    }

    return $indicators;
}
```

#### Label and Instructions (Fields)

Bind assistive text to a native field input.

```php
public ?string $label = null;
public ?string $instructions = null;
```

Override the `defaultLabel()` and `defaultInstructions()` methods instead, if you wish to allow users to customize labels and instructions—or to provide translatable defaults.

#### Tips + Warnings (Fields)

In addition to [labels and instructions](#label-and-instructions-fields), fields can provide a `tip` and `warning` box below their markup.

```php
public ?string $tip = null;
public ?string $warning = null;
```

These strings should be plain text or Markdown; HTML is encoded before parsing.

### Functional

These settings govern the actual behavior and configurability of your field layout element, throughout the system.

#### Multi-instance

Whether your field layout element can be added to a layout more than once. Typically, native fields _do not_ support this, as they represent an underlying element property. Most UI elements _do_, except in cases where multiple instances would be redundant or confusing. Consider that semi-dynamic UI elements may be rendered at different times—say, in response to a new tab becoming visible—and therefore show different information.

```php
public function isMultiInstance(): bool
{
    return true;
}
```

#### Settings Support

If your field layout element has aspects that should be configurable on a per-instance basis, you should return `true` from `hasSettings()`:

```php
public function hasSettings()
{
    return true;
}
```

It is then your responsibility to render additional settings HTML:

```php
protected function settingsHtml(): ?string
{
    return Cp::lightswitchFieldHtml([
        'label' => Craft::t('my-plugin', 'Refresh automatically?'),
        'instructions' => Craft::t('my-plugin', 'Periodically refresh the sync status while the element editor is open and in the foreground.'),
        'id' => 'autoRefresh',
        'name' => 'autoRefresh',
        'on' => $this->autoRefresh,
    ]);
}
```

This markup is prepended to any default settings, like the user and element condition builders. Craft hides the **Settings** action for a field layout element if it doesn’t support [conditions](#conditions) and doesn’t explicitly return `true` from `hasSettings()`.

#### Conditions

All field layout elements support conditions, by default. Opt-out by returning `false` from a `conditional()` method:

```php
protected function conditional(): bool
{
    return false;
}
```

#### Mandatory (Fields)

You can force a field layout element to be present in any field layout it is supported in by marking it as “mandatory:”

```php
public function mandatory(): bool
{
    return false;
}
```

If a mandatory field layout element has not been explicitly added to a field layout via a field layout designer, Craft injects it at the bottom of the first tab (when rendering the layout) to ensure it is available to authors.

#### Requirable (Fields)

When added to a layout, you can include a **Make required/optional** action (along with a corresponding [indicator](#indicators-fields)). The state of this selection is available when rendering a field layout element as the `required` property, and can be used in your `inputHtml()` method.

#### Thumbnail + Card Support (Fields)

Field layout elements also underpin Craft’s handling of [element chips and cards](../system/elements.md#chips-cards).

To make your field layout element available for selection as element thumbnails, implement the `thumbable()` and `thumbHtml()` methods:

```php
public function thumbable(): bool
{
    return true;
}

public function thumbHtml(ElementInterface $element, int $size): ?string
{
    $value = $element->{$this->attribute()};

    return Html::tag('div', Cp::fallbackIconSvg($value), ['class' => 'cp-icon']);
}
```

Any other kind of value can be exposed to element cards by returning `true` from a `previewable()` method:

```php
public function previewable(): bool
{
    return true;
}
```

You must then implement `previewHtml()` to return a representation of your data. By default, Craft will attempt to access a property of the element corresponding to your field layout element’s `attribute`.

```php
public function previewHtml(ElementInterface $element): string
{
    return Html::tag('code', Html::encode($element->{$this->attribute()}));
}
```

#### Fieldset (Fields)

Wrap the input HTML in a `fieldset`, and use special handling for labels, instructions, and errors.

```php
protected function useFieldset(): bool
{
    return true;
}
```

#### Refresh Behavior <Since ver="5.7.0" feature="Refreshable field layout elements" />

By default, field layout elements are only rendered when the form is initially loaded, or when their visibility changes (due to a user or element condition being satisfied). To refresh it after every auto-save, implement the `alwaysRefresh()` method:

```php
protected function alwaysRefresh(): bool
{
    return true;
}
```
</file>

<file path="extend/field-types.md">
---
description: Custom field types are an essential piece of Craft’s powerful content modeling toolkit.
---

# Field Types

Plugins can provide custom [field types](../system/fields.md) by creating a class that implements <craft5:craft\base\FieldInterface> and <craft5:craft\base\FieldTrait>. This class serves as both a way to communicate features and behaviors of the field type (like [how it stores data](#database-type) and [what kinds of values](#php-type) it exposes), and as a model that fields of its type will be instantiated with (when used in a field layout or loaded via the API).

Field types are primarily concerned with providing [novel authoring interfaces](#inputs), and storing data in a sensible way. Most fields _do not_ control how that data is displayed in the front-end; instead, they yield a [minimally-normalized](#php-type) value to developers, who can then use it in any number of contexts.

## Field Class

Scaffold a field type with the [generator](generator.md):

<Generator component="field-type" plugin="my-plugin" />

If you would prefer to write a field class from scratch, it should extend <craft5:craft\base\Field>. The base implementation provides some sane defaults, but lacks many specifics that differentiate your field.

Refer to Craft’s own field classes (located in `vendor/craftcms/cms/src/fields/`, or the `craft\fields` namespace) for examples. You may be able to start with a more specific base field type, if your field’s anticipated value type(s) are compatible.

## Registering Custom Field Types

Field classes must be registered with the `Fields` service so Craft knows about it when populating the list of available field types:

```php
<?php
namespace mynamespace;

use craft\events\RegisterComponentTypesEvent;
use craft\services\Fields;
use yii\base\Event;
use mynamespace\fields\MyField;

class Plugin extends \craft\base\Plugin
{
    public function init()
    {
        Event::on(
            Fields::class,
            Fields::EVENT_REGISTER_FIELD_TYPES,
            function(RegisterComponentTypesEvent $event) {
                $event->types[] = MyField::class;
            }
        );

        // ...
    }

    // ...
}
```

If you used the generator to scaffold the field type, it ought to have inserted this, automatically. You may register as many field types as you wish, from one `EVENT_REGISTER_FIELD_TYPES` event handler.

### Missing Fields

If your field class ever goes missing (say, because a developer uninstalls your plugin or removes the package), Craft will use an instance of <craft5:craft\fields\MissingField>, and display a message in any field layouts it was present in. This ensures the control panel doesn’t become inoperable, but doesn’t prevent front-end templates from breaking.

## Settings

Field types can offer any number of settings that determine how individual fields behave. [Plain text](../reference/field-types/plain-text.md) fields (<craft5:craft\fields\PlainText>), for instance, have **Placeholder Text** and **Field Limit** settings, whereas [country](../reference/field-types/country.md) fields have no options.

Your field type’s settings should be represented as class properties, and `getSettingsHtml()` should return markup for corresponding form inputs:

```php
public bool $useSecurities = false;

// ...

public function getSettingsHtml(): ?string
{
    return Craft::$app->getView()->renderTemplate('my-plugin/fields/currency/settings', [
        'field' => $this,
    ]);
}
```

The template might look something like this:

```twig
{# Import field helpers from Craft: #}
{% import "_includes/forms" as forms %}

{{ forms.lightswitchField({
    label: 'Use securities symbols?'|t('my-plugin'),
    instructions: 'Enable this to allow arbitrary ISIN (ISO6166) symbols.'|t('my-plugin'),
    id: 'currency-allow-securities',
    name: 'useSecurities',
    on: field.useSecurities,
}) }}
```

When an admin is creating or editing a field in the control panel, Craft displays this output below the **Field Type** dropdown menu. Its inputs are namespaced such that <craft5:craft\controllers\FieldsController::actionSaveField()> can assign the settings onto an instance of your field type.

Ultimately, your field type’s settings are serialized into [project config](project-config.md). If your class has non-scalar public properties, or uses a getter/setter pattern around a private property, you may need to explicitly declare the attributes that should be considered “settings” (via `settingsAttributes()`) or return a custom array of settings (via `getSettings()`):

```php
/**
 * Return a list of properties that include settings that should be preserved in project config:
 */
public function settingsAttributes(): array

    // Let Craft determine most, automatically:
    $names = parent::settingsAttributes();

    // Add an attribute...
    $names[] = 'someVirtualProperty';

    // ...or remove one:
    $names = ArrayHelper::withoutValue('someEphemeralProperty');

    return $names;
}

/**
 * Directly return the array that will be packed into project config:
 */
public function getSettings(): array
{
    $settings = parent::getSettings();

    // Sections should be stored as UUIDs, not models:
    $settings['restrictCurrenciesBySectionUsage'] = array_map(fn(Section $s) => $s->uid, $this->_sections);

    return $settings;
}
```

Craft automatically handles serialization of settings that resolve to `DateTime` objects or enums. Read more about handling these values (and taking advantage of environment variables and aliases) on the [project config](project-config.md) page.

::: warning
Even though the `Section` models in this example can _technically_ be serialized and stored in their entirety, you are strongly encouraged to store only a stable identifier that can be dereferenced at runtime—typically its UUID.
:::

## Inputs

A core part of a field’s identity is how authors populate it with data. You are responsible for returning the appropriate markup from an `inputHtml()` method:

```php
use craft\helpers\Cp;

protected function inputHtml(mixed $value, ?ElementInterface $element, bool $inline): string
{
    $id = $this->getInputId();

    $components = [
        Cp::selectizeHtml([
            'id' => "$id-currency",
            'describedBy' => $this->describedBy,
            'name' => "$this->handle[currency]",
            'value' => $value->currency ?? null,
            'options' => $this->getCurrencyOptions(),
            'disabled' => $static,
        ]),
        Cp::textHtml([
            'id' => "$id-amount",
            'name' => "$this->handle[amount]",
            'value' => $value->amount ?? null,
            'type' => 'number',
            'size' => 10,
        ]),
    ];

    return join('', $components);
}
```

In many of Craft’s built-in field types, this method returns different markup depending on the field’s settings. Our currency field example might have two primary “branches,” depending on whether arbitrary security symbols are allowed:

```php
use craft\base\ElementInterface;
use craft\helpers\Cp;

protected function inputHtml(mixed $value, ?ElementInterface $element, bool $inline): string
{
    $id = $this->getInputId();

    $components = [];

    if ($this->useSecurities) {
        $components[] = Cp::textHtml([
            'id' => "$id-security-symbol",
            'name' => "$this->handle[symbol]",
            'value' => $value->symbol ?? null,
            'type' => 'text',
            'class' => 'code',
            'size' => 14,
        ]);
    } else {
        $components[] = Cp::selectizeHtml([
            'id' => "$id-currency-symbol",
            'describedBy' => $this->describedBy,
            'name' => "$this->handle[symbol]",
            'value' => $value->symbol ?? null,
            'options' => $this->getCurrencyOptions(),
            'disabled' => $static,
        ]);
    }

    $components[] = Cp::textHtml([
        'id' => "$id-amount",
        'name' => "$this->handle[amount]",
        'value' => $value->amount ?? null,
        'type' => 'number',
        'size' => 10,
    ]);

    return join('', $components);
}
```

::: tip
You can also render a template instead of generating HTML directly from PHP, like we did for the [settings](#settings) inputs.
:::

### Read-Only Mode

Craft will handle the static or read-only mode for most simple inputs by adding the appropriate HTML attributes, automatically. If you would prefer to control that output directly, define a `getStaticHtml()` method.

Read-only representations of fields are most commonly encountered when viewing element revisions, and are intended to resembles the regular input—in contrast to [previews](#previews) for indexes and element cards, which display a final, formatted value.

### Inline Editing

You also have an opportunity to provide a simplified or alternative input for the [inline editing](../system/elements.md#in-line-editing) mode on element indexes. When a field implements <craft5:craft\base\InlineEditableFieldInterface>, Craft will call its `inputHtml()` method with the `$inline` argument set to `true`:

```php{8-10}
use Craft;
use craft\helpers\Html;

// ...

public function inputHtml(mixed $value, ?ElementInterface $element, bool $inline): string
{
    if ($inline) {
        // Return a simplified UI element, or a static representation
    }

    // Return the normal UI
}
```

### Fieldsets

When your field appears in a field layout, it is wrapped in an instance of <craft5:craft\fieldlayoutelements\CustomField>. You can customize the structure and semantics of your field’s [input](#inputs)(s) by implementing the `useFieldset()` method on your field class:

```php
public function useFieldset(): bool
{
    return true;
}
```

The field layout element calls this method as it renders the surrounding markup, including the field label, instructions, and errors. You may wish to base the return value on your field’s configuration—the <craft5:craft\fields\Date> field, for example, uses a fieldset only when its `showTime` setting is _enabled_ and the user will be presented with two discrete HTML inputs.

## Validation

Field types provide two sets of [validation rules](guide:structure-models#validation-rules).

### Settings Rules

Like other configurable models, your field type’s static `defineRules()` method should return an array of rules that govern its own [settings](#settings).

### Value Rules

When a developer adds an instance of your field type to a field layout, you have an opportunity to contribute rules to the element’s validation, via [`getElementValidationRules()`](craft5:craft\base\Field::getElementValidationRules()):

```php
public function getElementValidationRules(): array
{
    return [
        [
            'string',
            'length' => 3,
        ],
        [
            'in',
            'range' => $this->getSupportedCurrencySymbols(),
        ],
    ];
}
```

Rules defined in this way should _not_ include the field or field instance handle—Craft normalizes the returned rules so that they apply to the current instance. You can, however, use the field’s configuration to conditionally apply some rules:

```php
public function getElementValidationRules(): array
{
    // Set up some default rules that apply to all instances:
    $rules = [
        // ...
    ];

    // Fields that allow allows ISIN (ISO6166) codes for stocks and other securities require special validation:
    if ($this->useSecurities) {
        $rules[] = ['validateSymbol'];
    }

    // Otherwise, just make sure the provided value is among a known list of currencies:
    if (!$this->useSecurities) {
        $rules[] = [
            'in',
            'range' => $this->getSupportedCurrencySymbols(),
        ];
    }

    // Return the final list:
    return $rules;
}
```

::: tip
In this example, `validateSymbol` is a method _on the field class itself_—not the element being validated. Craft normalizes this in such a way that the validation method will be correctly located and bound.
:::

When the effective rules differ this greatly, however, it may be a sign that your field type should actually be _two_ distinct types. Short of that, field settings can also influence the sort of [inputs](#inputs) you display to an author: for this “currency” field, the default appearance could be a dropdown menu with a fixed set of known options; then, in “securities” mode, it could switch to a plain-text input with a placeholder value that takes the shape of a typical ISIN.

### Emptiness

Implement the `isValueEmpty()` to tell Craft what kinds of values you consider “empty.” Internally, we use this to determine whether an author explicitly selected a value (or if it’s a default or incidental) in the process of saving elements and propagating content between sites. The base method treats `null` and zero-length arrays (`[]`) and strings (`''`) as empty.

## Previews

In order for your field type to be displayed on [element indexes](../system/elements.md#indexes) or [cards](../system/elements.md#chips-cards), it must implement <craft5:craft\base\PreviewableFieldInterface>. Some field types will work with no additional configuration, as the base <craft5:craft\base\Field\getPreviewHtml()> method handles a number of common value types including booleans, dates, and anything that can be cast to a string.

You can override this method to apply custom formatting, and take into consideration the field’s configuration:

```php
public function getPreviewHtml(mixed $value, ElementInterface $element): string
{
    // Display securities amounts + symbols, verbatim:
    if ($this->useSecurities) {
        return $value->amount . ' ' . Html::tag('code', $value->symbol);
    }

    // Display a flag for the currency and a formatted value:
    return MyCurrencyHelper::currencyToFlagSvg($value->symbol) . MoneyHelper::toString($value->amount);
}
```

### Placeholder

When a developer is configuring an element card via the field layout designer, it is helpful to show a representative “placeholder” value. Define a `previewPlaceholderHtml()` method, and return an HTML fragment with some [greeked](https://en.wikipedia.org/wiki/Greeking) content:

```php
public function previewPlaceholderHtml(mixed $value, ?ElementInterface $element): string
{
    return Html::tag('code', 'XX-123456789');
}
```

The `value` and `element` arguments are not currently used.

## Supporting Delta Saves

Craft does its best to reduce the amount of unnecessary content churn, and provide a record of what fields change in each draft and revision. The fields that are part of a “delta” save are in large part determined by client-side JavaScript in the control panel that observes `form` elements and only submits updated values. As long as you are using semantic HTML inputs, you don’t typically need to do anything to support delta saves.

However, if your field type needs to perform some post-processing in [afterElementSave()](<craft5:craft\base\FieldInterface::afterElementSave()>) or [afterElementPropagate()](<craft5:craft\base\FieldInterface::afterElementPropagate()>) (say, fetching data from a remote API), you can skip those tasks when the field’s value is unchanged by checking [isFieldDirty()](<craft5:craft\base\ElementInterface::isFieldDirty()>):

```php
public function afterElementSave(ElementInterface $element, bool $isNew): void
{
    if ($element->isFieldDirty($this->handle)) {
        // logic for handling saved element
    }

    parent::afterElementSave($element, $isNew);
}
```

::: tip
Craft considers a field “dirty” as soon as it’s been set, even if the new and old values are effectively the same.
:::

## Storing Content

Craft can take care of storing and retrieving content for your field type, so long as it declares valid [PHP](#php-type) and [database](#database-type) value types. In doing so, you also give Craft an idea about what default [element query capabilities](#query-api)) your field type will support.

### PHP Type

At runtime, Craft generates a special class (`CustomFieldBehavior`) that includes properties and type hints for each custom field. You are responsible for returning a valid PHP [type declaration](https://www.php.net/manual/en/language.types.declarations.php):

```php
public static function phpType(): string
{
    // The field’s value can be `null` or any class that implements a special `CurrencyInterface` interface:
    return sprintf('\\%s|null', CurrencyInterface::class);
}
```

This type declaration must describe the kinds of values your field type returns from its [`normalizeValue()`](craft5:craft\base\Field::normalizeValue()) method:

```php
public function normalizeValue(mixed $value, ?ElementInterface $element): mixed
{
    // Already normalized?
    if ($value instanceof BaseCurrency) {
        return $value;
    }

    // Not set?
    if ($value === null) {
        return null;
    }

    // Misconfigured in some other way?
    if (!is_array($value)) {
        return null;
    }

    return BaseCurrency::create($value);
}
```

Of course, this example hides some of the complexity behind the implementation of other classes—but let’s look at how returning a class affects the developer API:

```twig
{# Output a formatted amount in the selected currency: #}
{% set currency = entry.myCurrencyField %}
{{ curreny.amount | currency(currency.symbol) }}

{# Output just the currency: #}
{{ entry.myCurrencyField.symbol }}
```

### Database Type

Similarly, Craft needs to know the “shape” of values your field type stores, in the database. This can be a singular value type, an array of types representing nested keys, or `null` to signal that your plugin [manages its own content](#custom-tables):

::: code
```php Simple Type
use yii\db\Schema;

// ...

public static function dbType(): array|string|null
{
    return Schema::TYPE_INTEGER;
}
```
```php Complex/Nested Types
use yii\db\Schema;

// ...

public static function dbType(): array|string|null
{
    return [
        'amount' => Schema::TYPE_INTEGER,
        'symbol' => Schema::TYPE_STRING,
    ];
}
```
:::

When returning an array, the order of values is significant! Unless otherwise specified in `queryCondition()`, Craft will use the first key and type when generating coalesce expressions for `WHERE` clauses and [ordering](#sortable-fields).

::: tip
If your field needs to store a more deeply-nested data structure (or one of unknown structure), consider using `Schema::TYPE_JSON`.
:::

### Multi-Instance Fields

Craft treats any field that returns a non-`null` value from `dbType()` as implicitly supporting [multiple instances](../system/fields.md#multi-instance-fields) per field layout, but you can explicitly opt in or out:

```php
public static function isMultiInstance(): bool
{
    return true;
}
```

<Block label="How Field Instances Work">

The database’s `COALESCE()` function is used to discover values among field instance candidates. For example: an entry query may involve any field layout provided via an entry type. Those field layouts can contain field layout elements with overlapping handles—but they are each guaranteed a unique UUIDs under which their content is indexed in the element’s JSON blob.

In order to `SELECT` that data and build `WHERE` and `ORDER BY` expressions, Craft must look at each possible “location” for field data with that handle. This means that despite scanning multiple candidate keys in the JSON blob, only one will ever be contain a value for a given element! At the same time, however, it’s possible that a single handle is used by two otherwise unrelated fields or field types—in these cases, Craft uses the first instance’s handle to build a [query condition](#query-api).

</Block>

### Custom Tables

If you’d rather have your field type store its content in a separate database table, you can return `null` from `dbType()`. You are then responsible for managing…

- …creation, duplication, retrieval, and deletion of field content in the database;
- …support for drafts, revisions, and [sites and localization](../system/sites.md);
- …[multi-instance](#multi-instance-fields) support;
- …inclusion of content fields in element queries and GraphQL;
- …automatic de/serialization + normalization of values;

On the other hand, you get access to a variety of powerful database capabilities, like foreign key constraints, custom indexes, joins, selections, and so on. 

### Sortable Fields

Custom fields that use the native content storage system (not a [custom table](#custom-tables)) are automatically orderable via database queries:

```twig
{% set topAssets = craft.entries()
  .orderBy('myCurrencyField DESC')
  .limit(5)
  .all() %}
```

Craft determines how to sort the data using the `dbType()`’s first (or only) key and type. In [our example](#database-type), that would be either the single “simple” value, or the nested `amount` key.

::: tip
Developers may specify a nested key using dot notation to override the default. <Since ver="5.6.0" feature="Ordering by nested field keys" />

```twig{2}
{% set assetsBySymbol = craft.entries()
  .orderBy('myCurrencyField.symbol ASC')
  .all() %}
```
:::

To be eligible for sortable columns within [element indexes](../system/elements.md#indexes), field types must implement <craft5:craft\base\SortableFieldInterface> and the `getSortOption()` method. The default implementation from <craft5:craft\base\Field> covers most use cases, again using the first `dbType()`. You can override this to gain more control over the handling—suppose the field’s values don’t naturally sort how users would expect, as is often the case with “statuses” or other strings whose order in a process don’t agree with their alphabetic order:

```php
public function getSortOption(): array
{
    $col = $this->getValueSql();

    // Re-map statuses so they are "in order," semantically (not alphabetically):
    $orderBy = <<<SQL
CASE
    WHEN $col = "draft" THEN 0
    WHEN $col = "submitted" THEN 1
    WHEN $col = "approved" THEN 2
    WHEN $col = "published" THEN 3
    ELSE 4
END; 
SQL;

    // This is identical to the base implementation:
    return [
        'label' => Craft::t('site', $this->name),
        'orderBy' => $orderBy,
        'attribute' => isset($this->layoutElement->handle)
            ? "fieldInstance:{$this->layoutElement->uid}"
            : "field:$this->uid",
    ];
}
```

::: tip
Notice that we’re using the [`site` translation category](../system/sites.md#static-message-translations) for the sort option’s `label`! A field’s `name` is chosen by the developer as they build a site; this allows them to localize those names for control panel users.
:::

## Query API

A key quality of your field type is its developer API and query capabilities. Each instance of your field type automatically gets a corresponding query method, which provides many of the basic features you would expect, like automatic `and` and `or` handling, inversion with `not`, `:empty:` and `:notempty:` tokens, operators, and so on.

For additional control over your field type’s query features, implement the static `queryCondition()` method:

```php
public static function queryCondition(
    array $instances,
    mixed $value,
    array &$params,
): array|string|ExpressionInterface|false|null {
    if (is_array($value)) {
        $conditions = [];

        // Build COALESCE() “column” names to properly extract nested values from
        // all possible uses of a field across eligible field layouts:
        if (isset($value['type'])) {
            $valueSql = static::valueSql($instances, 'symbol');

            $conditions[] = match ($value['type']) {
                'currency' => new Expression("CHAR_LENGTH($valueSql) = 3"),
                'security' => new Expression("CHAR_LENGTH($valueSql) = 12"),
            };
        }

        if (isset($value['amount'])) {
            $valueSql = static::valueSql($instances, 'amount');
            $conditions[] = Db::parseNumericParam($valueSql, $value['amount']);
        }

        if (isset($value['symbol'])) {
            $valueSql = static::valueSql($instances, 'symbol');
            $conditions[] = Db::parseParam($valueSql, $value['symbol']);
        }

        // Did we come up with anything?
        if (!empty($conditions)) {
            return $conditions;
        }
    }

    // Everything else can be handled by the default behavior:
    return parent::queryCondition($instances, $value, $params);
}
```

Expressed in Twig (where a developer using your plugin is most apt to encounter these features), queries might look like this:

```twig
{# Find assets with a "zero" amount: #}
{% set zeroValueAssets = craft.entries().myCurrencyField(0).all() %}

{# Find USD assets: #}
{% set usdAssets = craft.entries()
    .myCurrencyField({
        symbol: 'USD',
    })
    .all() %}

{# Find US-based securities: #}
{% set domesticSecurities = craft.entries()
    .myCurrencyField({
        type: 'securities',
        symbol: 'US-*',
    })
    .all() %}
```

By intercepting and processing a couple of extra cases, we’re able to solve common problems for developers that would otherwise require advanced SQL knowledge.

::: tip
Return `false` if the provided `$value` is invalid or unprocessable to skip applying conditions entirely.
:::
</file>

<file path="extend/filesystem-types.md">
---
description: Filesystems are the foundation of Craft’s flexible asset management tools.
---

# Filesystem Types

Asset storage is split into two concepts:

- **Filesystems** establish relationships between Craft and a storage medium, like the local disk or an object storage API. A plugin can provide one or more [filesystem types](#filesystem-class).
- **Volumes** organize assets into sources that make sense for a site’s content model, define fields available to assets, and bind those sources to filesystems. All volumes are represented by the same class, and are not extensible.

## Filesystem Class

Use the [generator] to create a filesystem class and register it with Craft:

<Generator component="filesystem-type" plugin="my-plugin" />

If you are inclined to implement the filesystem type from scratch, extend <craft5:craft\base\Fs>. There are a number of first-party examples to look at, as well:

- [Amazon AWS S3](repo:craftcms/aws-s3)
- [Google Cloud Storage](repo:craftcms/google-cloud )
- [Azure Blob Storage](repo:craftcms/azure-blob)

Many more filesystem types are available in the [Plugin Store](https://plugins.craftcms.com/categories/assets?craft4).

## Registering your Filesystem Type

Once you have created your filesystem class, you must register it with the `Fs` service so Craft will know about it when populating the list of available filesystem types:

```php
<?php
namespace mynamespace;

use craft\events\RegisterComponentTypesEvent;
use craft\services\Fs;
use mynamespace\fs\MyFs;
use yii\base\Event;

class Plugin extends \craft\base\Plugin
{
    public function init()
    {
        Event::on(
            Fs::class,
            Fs::EVENT_REGISTER_FILESYSTEM_TYPES,
            function(RegisterComponentTypesEvent $event) {
                $event->types[] = MyFs::class;
            }
        );

        // ...
    }

    // ...
}
```

The generator takes care of this for you!

## Implementation

Filesystems are complex components, and their implementation is almost entirely dependent on the storage medium they target. Consider reviewing <craft5:craft\base\FsInterface>, as well as the built-in [Local](craft5:craft\fs\Local) filesystem for some ideas about their responsibilities.

### Flysystem

If you are targeting a popular storage service, you may be able to extend [`craft\flysystem\base\FlysystemFs`](repo:craftcms/flysystem), and connect an existing [Flysystem](repo:thephpleague/flysystem) adapter.

Should that support exist, you can focus on exposing the adapter’s parameters as [settings](#settings) in a Craft-native way.

## Settings

A filesystem class is responsible for declaring configurable attributes, validating and normalizing input, and mapping those settings to its underlying adapter (when using [Flysystem](#flysystem)), or using them in the class itself as part of authorizing or managing file operations.

Users will be presented with the output of your class’s `getSettingsHtml()` method when configuring a new or existing filesystem.

::: tip
Use [auto-suggest inputs](environmental-settings.md#autosuggest-inputs) to make entry of environment variables and aliases easier on your users.
:::

Craft will take care of assigning settings fields into your filesystem class prior to validating or saving it, as long as your inputs’ `name`s match up with filesystem class properties. The entire return value from `getSettingsHtml()` is namespaced to avoid collisions with other filesystem type properties, and settings common to all filesystems (like their name and handle) are merged automatically.

Filesystems are stored in [project config](project-config.md). Craft takes care of packing your class’s public properties into a serializable configuration object by virtue of extending from <craft5:craft\base\SavableComponent> and <craft5:craft\base\ConfigurableComponent>.
</file>

<file path="extend/generator.md">
# Generator

The [Generator](repo:craftcms/generator) is a first-party tool for scaffolding modules, plugins, or components thereof. It was designed to reduce friction when setting up extensions—and contributing to Craft itself! We like to think of it as both a learning _and_ productivity tool.

## Installation

New Craft projects come with the Generator package installed and ready to use. If you started your project with a version of Craft earlier than 4.3.5, [update](../update.md) and run:

```bash
composer require craftcms/generator --dev
```

## Usage

Generator’s API is accessible via the command line, under the `make` command:

<Generator />

Without passing an argument, you will be presented with the command’s help text, and two primary options:

1. `php craft make plugin`: Initialize and wire up a new [Plugin](plugin-guide.md).
1. `php craft make module`: Create a new [Module](module-guide.md).

Feel free to explore the generator API at your own pace. See the official readme for a list of [currently-supported components](repo:craftcms/generator#system-component-generation), or run `php craft make` to see what is supported by your installed version.

Subsequent commands should be run with either a `--module` or `--plugin` flag, using the target module ID or plugin handle, respectively.

## Updates

To get the latest Generator functionality, run `composer update` in your project directory. Generator is not considered a plugin, and therefore will not appear in Craft’s built-in updater tool, nor will its presence be recorded in [project config](project-config.md).

### Documentation Changes

We will be gradually rolling out Generator examples to system component documentation, and plan to make it the recommended tool for scaffolding new extensions and components (rather than providing bare-bones examples, in-line).

Keep an eye out for these special Generator command call-outs, throughout the documentation:

<Generator component="controller" plugin="hello-world" />

## Generating Generators

::: warning
There’s no two ways about it: this section is extremely confusing. It’s intended only for developers with complete or near-complete plugins that provide their own extension points.

If you’re new here, consider skipping to our [topics](topics.md) overview!
:::

Generator can even generate _generators_ for your plugin! Any plugin that itself exposes [points of extension](topics.md) may benefit from bundling a generator:

<Generator component="generator" plugin="my-plugin" />

Each component supported by Generator is backed by a class in the `craft\generator\generators` namespace, extending `craft\generator\BaseGenerator`. These classes are responsible for gathering parameters from CLI input, then loading, modifying, and writing new classes to disk, using convenience methods provided by `BaseGenerator`.

### Registering a Generator

Once you’ve generated the generator class, you must register it with Generator for it to be available from the command line:

```php
use craft\events\RegisterComponentTypesEvent;
use craft\generator\Command;
use mynamespace\myplugin\generators\MyGenerator;
use yii\base\Event;

Event::on(
    Command::class,
    Command::EVENT_REGISTER_GENERATOR_TYPES,
    function(RegisterComponentTypesEvent $e) {
        $e->types[] = MyGenerator::class;
    }
);
```

This code belongs in your plugin’s [`init()` method](plugin-guide.md#initialization).

::: tip
The metaprogramming involved in generators is not for the faint of heart! Make sure you have a good grasp on the structure and substance of the base component you’re targeting and what the output of a subclass should look like. Some aspects of the generated classes can be defined with code (via the `properties()` or `methods()` methods, for example), but advanced customization may require manually concatenating PHP code while controlling indentation, quoting, brackets, etc—without the help of syntax highlighting or linting.

Test your generators early and often!
:::

## Trivia

Rather than implementing Generator as a plugin or module, we chose to use a Yii feature known as [bootstrapping](yii2:yii\base\BootstrapInterface), which automatically initializes the core class based on the [`extra.bootstrap`](guide:structure-extensions#bootstrapping-classes) key in `composer.json`.

This is generally _not_ a recommended extension point for Craft, as its presence in a project is opaque and non-optional once installed (bootstrapped classes cannot be temporarily disabled, unlike plugins and modules).
</file>

<file path="extend/graphql.md">
# Extending GraphQL

Developers can use Craft’s [GraphQL implementation](../development/graphql.md) to provide their own GraphQL data and access level for custom plugins and modules.

If you’ve created a custom element or field type, chances are you’ll want to make its data available via the GraphQL API.

## Overview

Unlike Craft’s element queries that are built on the fly, a GraphQL schema needs to define every possible query and data type up front.

This fundamental difference between Craft and GraphQL APIs, combined with Craft’s flexible content modeling, means _mapping out_ your custom implementation will probably take more effort than writing the code to make it happen.

Important questions to consider:

1. What kinds of data do you need to expose, and how complex is each?\
(Are there nested objects or multiple types? Will you need to support eager loading?)
2. What sort of arguments, if any, do you need to make available for narrowing your result set?
3. Should this data be available in the public schema, or will you need to add and honor schema “permissions”?

Craft relies on the [webonyx/graphql-php](https://github.com/webonyx/graphql-php) library and we’ll assume you’ve familiarized yourself with [GraphQL basics](https://graphql.org/learn/). It’s worth taking a look at each if you haven’t already.

::: tip
Be mindful of Craft vs. GraphQL terminology, because there are overlapping terms that can be confusing. It helps to pay careful attention to namespacing when looking at code examples.
:::

The rest of this page will cover each of the main things you may need to work with. If you’d like some concrete examples, have a look at Craft’s own pieces in the [`src/gql/` directory](https://github.com/craftcms/cms/tree/main/src/gql).

### Limitations

If you’re planning advanced or elaborate GraphQL features, please be aware of the following limitations with Craft’s GraphQL implementation:

- GraphQL subscriptions aren’t currently supported.
- Advanced query builder functions [are not exposed for GraphQL](https://github.com/craftcms/cms/issues/7842).

## Folder Structure

Here’s a high-level look at the folder structure we’ll explore in our example adding a “Widget” element. You can structure things however you want, we’re just following [Craft’s organization](https://github.com/craftcms/cms/tree/main/src/gql):

```treeview
src/gql/
├── arguments/
│   └── elements/
│       └── Widget.php
├── directives/
│   └── BarTheFoo.php
├── interfaces/
│   └── elements/
│       └── Widget.php
├── mutations/
│   └── Widget.php
├── queries/
│   └── Widget.php
├── resolvers/
│   └── elements/
│       └── Widget.php
│   └── mutations/
│       └── Widget.php
└── types/
    ├── elements/
    │    └── Widget.php
    ├── generators/
    │   └── WidgetType.php
    └── input/
        └── Widget.php
```

## The Gql Service

The <craft5:craft\services\Gql> class offers methods mostly for managing schemas and tokens and executing queries, so you won’t need to do much with it if you’re primarily exposing data to GraphQL. The Gql class does, however, define and trigger the events you’ll use to register any components you’d like to add to the system. (We’ll get to those in a moment.)

### Modifying Queries Before or After Execution

The Gql service includes events you can use to modify [queries](#queries) before and after they’re executed.

#### beforeExecuteGqlQuery

```php
use craft\events\ExecuteGqlQueryEvent;
use craft\services\Gql;
use yii\base\Event;

Event::on(
    Gql::class,
    Gql::EVENT_BEFORE_EXECUTE_GQL_QUERY,
    function(ExecuteGqlQueryEvent $event) {
        // Set the result from cache
        $event->result = ...;
    }
);
```

#### afterExecuteGqlQuery

```php
use craft\events\ExecuteGqlQueryEvent;
use craft\services\Gql;
use yii\base\Event;

Event::on(
    Gql::class,
    Gql::EVENT_AFTER_EXECUTE_GQL_QUERY,
    function(ExecuteGqlQueryEvent $event) {
        // Cache results from $event->result or just tweak them
    }
);
```

## Queries

Queries are the top-level starting points someone will use fetching data from the GraphQL API. Craft includes query definitions for `entries` and `entry`, for example, and Craft Commerce adds its own custom queries for `products` and `product`.

Imagine we’ve added a custom element type for “Widgets”.

A simple query to list `widgets` titles might look like this:

```graphql{2}
{
  widgets {
    title
  }
}
```

A <craft5:craft\gql\base\Query> class provides one or more query names, each describing a GraphQL type it will return, any arguments that can be used to tailor results, and pointing to a resolver that will be responsible for translating the GraphQL query into equivalent logic with Craft’s APIs.

### Example Query Class

This example provides a `widgets` query that returns an array of custom [interfaces](#interfaces), optionally filtered by custom [arguments](#arguments). The [resolver](#resolvers) describes how to provide data for each interface.

```php
namespace mynamespace\gql\queries;

use GraphQL\Type\Definition\Type;
use mynamespace\helpers\Gql as GqlHelper;
use mynamespace\gql\interfaces\elements\Widget as WidgetInterface;
use mynamespace\gql\arguments\elements\Widget as WidgetArguments;
use mynamespace\gql\resolvers\elements\Widget as WidgetResolver;

class Widget extends \craft\gql\base\Query
{
    public static function getQueries($checkToken = true): array
    {
        // Make sure the current token’s schema allows querying widgets
        if ($checkToken && !GqlHelper::canQueryWidgets()) {
            return [];
        }

        // Provide one or more query definitions
        return [
            'widgets' => [
                'type' => Type::listOf(WidgetInterface::getType()),
                'args' => WidgetArguments::getArguments(),
                'resolve' => WidgetResolver::class . '::resolve',
                'description' => 'This query is used to query for custom widgets.'
            ],
        ];
    }
}
```

::: tip
The careful reader will notice a custom GqlHelper class above, which is a tiny extension of <craft5:craft\helpers\Gql> that makes it trivial to check whether entities are allowed by the schema:

```php
public static function canQueryWidgets(): bool
{
    $allowedEntities = self::extractAllowedEntitiesFromSchema();
    return isset($allowedEntities['widgets']);
}
```
:::

### Registering Queries

You can register one or more query classes using the [registerGqlQueries](craft5:craft\services\Gql::EVENT_REGISTER_GQL_QUERIES) event and appending them to the `queries` array:

```php
use craft\events\RegisterGqlQueriesEvent;
use craft\services\Gql;
use yii\base\Event;
use mynamespace\gql\queries\Widget;

Event::on(
    Gql::class,
    Gql::EVENT_REGISTER_GQL_QUERIES,
    function(RegisterGqlQueriesEvent $event) {
        $event->queries = array_merge(
            $event->queries,
            Widget::getQueries()
        );
    }
);
```

## Arguments

A [query](#queries) can support any number of arguments someone can use to filter results.

Any Craft element can be filtered by `id`, `slug`, or its `enabledForSite` property, for example.

Our pretend Widget element could provide its own `approved` argument for narrowing results to approved widgets:

```graphql{2}
{
  widgets(approved: true) {
    title
  }
}
```

### Example Arguments Class

```php
namespace mynamespace\gql\arguments\elements;

use GraphQL\Type\Definition\Type;

class Widget extends craft\gql\base\ElementArguments
{
    public static function getArguments(): array
    {
        // append our argument to common element arguments and any from custom fields
        return array_merge(parent::getArguments(), self::getContentArguments(), [
            'approved' => [
                'name' => 'approved',
                'type' => Type::boolean(),
                'description' => 'Narrows query results based on approved status.'
            ],
        ]);
    }
}
```

::: tip
This example extends <craft5:craft\gql\base\ElementArguments> in order to take advantage of common element arguments for free. It’s fine if you don’t have your own element type or even a class for arguments; you ultimately just need to provide an array of argument definitions for your queries if you want to use them.
:::

## Types

Not to be confused with Craft’s entry types, GraphQL types are the vital and specific descriptions of whatever the API can return.

::: tip
GraphQL is a _type system_, and if you’re not already familiar we recommend reading about its [schema and types](https://graphql.org/learn/schema/) for context.
:::

Each type must exhaustively describe what it contains—including any nested types—and every type in the GraphQL schema must be unique.

Everything has a `__typename`:

::: code
```graphql GraphQL Query
{
  __typename
  entry {
    __typename
  }
  user {
    __typename
  }
  widget {
    __typename
  }
}
```
```json JSON Response
{
  "data": {
    "__typename": "Query",
    "entry": {
      "__typename": "blog_blog_Entry"
    },
    "user": {
      "__typename": "User"
    },
    "widget": {
      "__typename": "Widget"
    }
  }
}
```
:::

Every available part of Craft’s content model, and every kind of data your custom plugin or module needs to expose via GraphQL, needs to be translated into an explicitly-named GraphQL type.

Craft’s <craft5:craft\gql\GqlEntityRegistry> keeps track of these GraphQL types, and you’ll use it to add, fetch, and modify them.

When adding fields to a given type, you should run them through <craft5:craft\gql\TypeManager::prepareFieldDefinitions()>. This makes it possible for others to programmatically [modify type fields](#modifying-type-fields) you’re introducing.

### Scalar Types

Pay special attention to the [GraphQL\Type\Definition\Type](https://github.com/webonyx/graphql-php/blob/master/src/Type/Definition/Type.php) class, which you’ll probably want to use for returning scalar types:

- `GraphQL\Type\Definition\Type::id()` is used to represent the GraphQL’s `ID` type.
- `GraphQL\Type\Definition\Type::string()` is used to represent the GraphQL’s `String` type.
- `GraphQL\Type\Definition\Type::boolean()` is used to represent the GraphQL’s `Boolean` type.
- `GraphQL\Type\Definition\Type::int()` is used to represent the GraphQL’s `Int` type.
- `GraphQL\Type\Definition\Type::float()` is used to represent the GraphQL’s `Float` type.
- `craft\gql\types\QueryArgument::getType()` is used to specify an integer, string, or boolean value. (It’s a catch-all for query methods that accept a variety of types like `2`, `['not', 2]`, `'handle'`, `false`, etc.)
- `craft\gql\types\DateTime::getType()` is used to specify a point in time.
- `craft\gql\types\Number::getType()` is used to specify a number than can be either an integer or a float. It can also be `null`.

::: tip
For consistency, use the `ID` type—not `Int`—when you’re returning IDs. The `ID` type serializes to a string rather than an integer.
:::

### Utility Types

You can specify a non-null value by wrapping it with the `\GraphQL\Type\Definition\Type::nonNull()` method.

To specify a list of types, you must wrap the type with the `\GraphQL\Type\Definition\Type::listOf()` method.

### Input Types

In addition to simple generic scalar values like strings and integers, you’ll probably want to describe more specific, complex data.

Craft includes several scalar input types like [DateTime](craft5:craft\gql\types\DateTime), [Number](craft5:craft\gql\types\Number), and [TableRow](craft5:craft\gql\types\TableRow).

Craft also includes more complex, relational input objects:

- [Asset](craft5:craft\gql\types\input\criteria\Asset)
- [Category](craft5:craft\gql\types\input\criteria\Category)
- [Entry](craft5:craft\gql\types\input\criteria\Entry)
- [Tag](craft5:craft\gql\types\input\criteria\Tag)
- [User](craft5:craft\gql\types\input\criteria\User)
- [File](craft5:craft\gql\types\input\File)
- [Matrix](craft5:craft\gql\types\input\Matrix)

You can use any of these in your type definitions, i.e. `DateTime::getType()` or `Asset::getType()`.

### Example Element Type

::: tip
“Element Type” in this context refers to the GraphQL type for our custom element, as opposed to Craft’s concept of [Element Types](element-types.md) that are not GraphQL-specific.
:::

A custom element like our Widget would probably best be described by two classes: an [interface](#interfaces) and a type class that implements it.

The type class for the element is simple: it declares its interface—which we’ll get to in a moment—and otherwise leans on <craft5:craft\gql\types\elements\Element::resolve()>, which you could further customize in a more complex situation.

```php
namespace mynamespace\gql\types\elements;

use mynamespace\gql\interfaces\elements\Widget as WidgetInterface;

class Widget extends \craft\gql\types\elements\Element
{
    public function __construct(array $config)
    {
        $config['interfaces'] = [
            WidgetInterface::getType(),
        ];

        parent::__construct($config);
    }
}
```

While there are many GraphQL types you could implement, your custom objects will most likely want to provide interfaces that describe data models and input types for any [mutations](#mutations).

### Registering Types

The Gql service includes a `registerGqlTypes` event you can use to register your types.

Here we’re registering the `Widget` interface we just looked at above. While you’re not limited to adding interfaces, any class you add must have a `getType()` method that returns a valid GraphQL type definition.

```php
use craft\events\RegisterGqlTypesEvent;
use craft\services\Gql;
use yii\base\Event;
use mynamespace\gql\interfaces\elements\Widget as WidgetInterface;

Event::on(
    Gql::class,
    Gql::EVENT_REGISTER_GQL_TYPES,
    function(RegisterGqlTypesEvent $event) {
        $event->types[] = WidgetInterface::class;
    }
);
```

### Modifying Type Fields

Attach a handler to <craft5:craft\gql\TypeManager::EVENT_DEFINE_GQL_TYPE_FIELDS> to add, remove or modify fields on any GraphQL type.

Below we’re removing IDs throughout the schema in favor of UIDs, and adding an `authorEmail` field to the entry interface:

```php
use craft\events\DefineGqlTypeFieldsEvent;
use craft\gql\TypeManager;
use GraphQL\Type\Definition\Type;
use yii\base\Event;

Event::on(
    TypeManager::class,
    TypeManager::EVENT_DEFINE_GQL_TYPE_FIELDS,
    function(DefineGqlTypeFieldsEvent $event) {
        // Remove all ids to enforce use of uids
        unset($event->fields['id']);

        // Add author email to all entries
        if ($event->typeName == 'EntryInterface') {
            $event->fields['authorEmail'] = [
                'name' => 'authorEmail',
                'type' => Type::string(),
                'resolve' => function($source, $arguments, $context, $resolveInfo) {
                    // Illustrative only; a query per entry would perform poorly
                    return $source->getAuthor()->email;
                }
            ];
        }
    }
);
```

## Interfaces

Just like PHP interfaces, GraphQL interfaces are abstract types that describe the fields a type must implement.

You don’t have to use interfaces, but they’re a nice way of formalizing the fields exposed by your type. Craft provides GraphQL interfaces for each included element type:

- <craft5:craft\gql\interfaces\Element>
- <craft5:craft\gql\interfaces\Structure>
- <craft5:craft\gql\interfaces\elements\Asset>
- <craft5:craft\gql\interfaces\elements\Category>
- <craft5:craft\gql\interfaces\elements\Entry>
- <craft5:craft\gql\interfaces\elements\GlobalSet>
- <craft5:craft\gql\interfaces\elements\Tag>
- <craft5:craft\gql\interfaces\elements\User>

### Example Interface

This example extends Craft’s element GraphQL interface.

It does this in order to define a single GraphQL type for our custom Widget element that adds a custom `approved` field:

```php
namespace mynamespace\gql\interfaces\elements;

use GraphQL\Type\Definition\Type;
use GraphQL\Type\Definition\InterfaceType;
use craft\gql\GqlEntityRegistry;

class Widget extends \craft\gql\interfaces\Element
{
    public static function getName(): string
    {
        return 'WidgetInterface';
    }

    public static function getType($fields = null): Type
    {
        // Return the type if it’s already been created
        if ($type = GqlEntityRegistry::getEntity(self::getName())) {
            return $type;
        }

        // Otherwise create the type via the entity registry, which handles prefixing
        return GqlEntityRegistry::createEntity(self::getName(), new InterfaceType([
            'name' => static::getName(),
            'fields' => self::class . '::getFieldDefinitions',
            'description' => 'This is the interface implemented by all widgets.',
            'resolveType' => self::class . '::resolveElementTypeName',
        ]));
    }

    public static function getFieldDefinitions(): array
    {
        // Add our custom widget’s field to common ones for all elements
        return TypeManager::prepareFieldDefinitions(array_merge(
            parent::getFieldDefinitions(),
            [
                'approved' => [
                    'name' => 'approved',
                    'type' => Type::boolean(),
                    'description' => 'Whether the widget is approved.'
                ],
            ]
        ), self::getName());
    }
}
```

## Resolvers

A resolver is responsible for mapping a GraphQL API field to its Craft API equivalent.

You won’t see or interact with a resolver querying the GraphQL API because the resolver works behind the scenes to connect the query or mutation to the value it’s supposed to return.

### Example Resolver Class

This example resolver extends the base [ElementResolver](craft5:craft\gql\base\ElementResolver) and implements a single [prepareQuery()](craft5:craft\gql\base\ElementResolver::prepareQuery()) method whose job is to return an element query:

```php
namespace mynamespace\gql\resolvers\elements;

use mynamespace\elements\Widget as WidgetElement;
use mynamespace\helpers\Gql as GqlHelper;

class Widget extends \craft\gql\base\ElementResolver
{
    public static function prepareQuery($source, array $arguments, $fieldName = null): mixed
    {
        if ($source === null) {
            // If this is the beginning of a resolver chain, start fresh
            $query = WidgetElement::find();
        } else {
            // If not, get the prepared element query
            $query = $source->$fieldName;
        }

        // Return the query if it’s preloaded
        if (is_array($query)) {
            return $query;
        }

        foreach ($arguments as $key => $value) {
            if (method_exists($query, $key)) {
                $query->$key($value);
            } elseif (property_exists($query, $key)) {
                $query->$key = $value;
            } else {
                // Catch custom field queries
                $query->$key($value);
            }
        }

        // Don’t return anything that’s not allowed
        if (!GqlHelper::canQueryWidgets()) {
            return [];
        }

        return $query;
    }
}
```

If this wasn’t a custom element type, we’d need a class to extend <craft5:craft\gql\base\Resolver> instead, implementing a [resolve()](craft5:craft\gql\base\Resolver::resolve()) method to return the field’s value rather than translating it into an element query.

The handling of `$source` here is important, because `prepareQuery()` may be called at different points in the request flow depending on exactly where `WidgetField` is accessed. `$source` will only have a `null` value if `WidgetField` is accessed at the top level of the query, and once populated `$fieldName` will either contain an array of `Widget` objects (if eager loading) or a prepped element query for returning `Widget` objects from the database.

## Generators

Craft introduces the concept of generators to bridge the gap between a complex content model and a GraphQL schema that needs to detail every potential type of content.

In the [example interface](#example-interface) above, we kept things simple by adding only one GraphQL type to the schema. In other words, our widget only comes in one “flavor.” If the data you’re representing only appears in one form, that may work great!

It’s common in Craft, however, for elements to have multiple types: entries have sections and entry types, assets have volumes, categories have groups, and so on. The site developer can create however many of these flavors they’d like, and yet we still need each one to be accounted for in the GraphQL schema. This is exactly the situation generators help with.

![Diagram of single- vs. multi-type element](../images/gql-type-generator.png =550x550)

Like the name implies, a generator can dynamically create GraphQL types based on whatever _contexts_ are needed. The generator needs to know about the unique scopes in which an element may appear for each unique flavor or context.

For example:

- An Asset’s context is its volume: `volumes.[UID]`
- A category’s context is its category group: `categorygroups.[UID]`
- An entry’s context is its entry type, and it has an additional section context: \
`sections.[section UID]`, `entrytypes.[UID]`

You can use your custom element’s <craft5:craft\base\Element::gqlScopesByContext()> method to declare its context-specific scopes. That’s exactly where Craft’s elements are defining those contexts in the list above:

- <craft5:craft\elements\Address::gqlScopesByContext()>
- <craft5:craft\elements\Asset::gqlScopesByContext()>
- <craft5:craft\elements\Category::gqlScopesByContext()>
- <craft5:craft\elements\Entry::gqlScopesByContext()>
- <craft5:craft\elements\GlobalSet::gqlScopesByContext()>
- <craft5:craft\elements\Tag::gqlScopesByContext()>
- <craft5:craft\elements\User::gqlScopesByContext()>

If you’ll benefit from using a generator, you will need to write a class that extends <craft5:craft\gql\base\Generator> and implements <craft5:craft\gql\base\GeneratorInterface> and <craft5:craft\gql\base\SingleGeneratorInterface>.

The base Generator provides a `getContentFields()` method that gets custom fields for a given context, while the interfaces require `generateTypes()` and `generateType()` respectively—responsible for registering types based on the provided context.

### Example Generator Classes

Our single-flavor widget wouldn’t actually need to generate multiple types since it only has one context. It wouldn’t need a generator class, so just for illustration a single-type generator could look like this:

```php
namespace mynamespace\gql\types\generators;

use mynamespace\elements\Widget as WidgetElement;
use mynamespace\gql\types\elements\Widget;
use mynamespace\gql\interfaces\elements\Widget as WidgetInterface;
use craft\gql\base\GeneratorInterface;
use craft\gql\GqlEntityRegistry;
use craft\gql\TypeManager;

class WidgetType implements GeneratorInterface
{
    public static function generateTypes($context = null): array
    {
        // Widgets have no context
        $type = static::generateType($context);
        return [$type->name => $type];
    }

    public static function generateType($context): ObjectType
    {
        $pluginType = new WidgetElement();
        $typeName = $pluginType->getGqlTypeName();
        $widgetFields = TypeManager::prepareFieldDefinitions(
            WidgetInterface::getFieldDefinitions(),
            $typeName
        );

        // Return the type if it exists, otherwise create and return it
        return GqlEntityRegistry::getEntity($typeName) ?:
            GqlEntityRegistry::createEntity(
                $typeName,
                new Widget([
                    'name' => $typeName,
                    'fields' => function() use ($widgetFields) {
                        return $widgetFields;
                    },
                ])
            );
    }
}
```

::: tip
We’re assuming `mynamespace\elements\Widget` was an existing [element class](element-types.md#element-class).
:::

Now let’s spice things up and pretend our widgets come in multiple flavors, each one having custom field layouts—similar to Craft’s entry types.

We can think of each “flavor” as a context that widget might appear in, and use the generator to dynamically create a type for each context.

This example pretends a `getAllWidgetTypes()` method can give us back all the contexts we need to handle, then loops through them to generate an array of GraphQL types. The `generateTypes()` method does the work of determining which types we need, handing each one off to `generateType()` in order to get a context-specific GraphQL type definition:

```php
namespace mynamespace\gql\types\generators;

use mynamespace\Plugin;
use mynamespace\elements\Widget as WidgetElement;
use mynamespace\gql\types\elements\Widget;
use mynamespace\gql\interfaces\elements\Widget as WidgetInterface;
use mynamespace\helpers\Gql as MyGqlHelper;
use craft\gql\base\GeneratorInterface;
use craft\gql\GqlEntityRegistry;
use craft\gql\TypeManager;

class WidgetType implements GeneratorInterface
{
    public static function generateTypes($context = null): array
    {
        // Fetch all our pretend widget types to be used as contexts
        $widgetTypes = Plugin::getInstance()->getAllWidgetTypes();
        $gqlTypes = [];

        foreach ($widgetTypes as $widgetType) {
            // Get relevant scopes that may limit schema access
            $requiredContexts = WidgetElement::gqlScopesByContext($widgetType);

            // Ignore this widget variation if the schema doesn’t include it
            if (!MyGqlHelper::isSchemaAwareOf($requiredContexts)) {
                continue;
            }

            // Generate a GQL type for this widget type
            $type = static::generateType($widgetType);
            $gqlTypes[$type->name] = $type;
        }

        return $gqlTypes;
    }

    public static function generateType($context): ObjectType
    {
        // Get the intended GQL type name as determined by the element type
        $typeName = WidgetElement::gqlTypeNameByContext($context);

        // Get element’s user-defined content fields and
        $contentFieldGqlTypes = self::getContentFields($context);

        // Merge in GQL types for the widget element’s own custom fields
        $widgetFields = TypeManager::prepareFieldDefinitions(
            array_merge(
                WidgetInterface::getFieldDefinitions(),
                $contentFieldGqlTypes
            ),
            $typeName
        );

        // Return the type if it exists, otherwise create and return it
        return GqlEntityRegistry::getEntity($typeName) ?:
            GqlEntityRegistry::createEntity(
                $typeName,
                new Widget([
                    'name' => $typeName,
                    'fields' => function() use ($widgetFields) {
                        return $widgetFields;
                    },
                ])
            );
    }
}
```

The term “context” here is deliberately vague because you’re the one that decides what that should be.

Since Craft elements and field types are integral to the GraphQL API, their base classes include methods for describing their type names:

- <craft5:craft\base\Element::getGqlTypeName()>
- <craft5:craft\base\Element::gqlTypeNameByContext()>
- <craft5:craft\base\Field::getContentGqlType()>

These include sensible defaults since Craft can make some assumptions about how elements and fields will be used.

::: tip
A field can also use <craft5:craft\base\Field::includeInGqlSchema()>—`true` by default—to determine whether it should appear in a given schema.
:::

## Directives

Directives return types that can be used to transform result data in specified locations relative to the GraphQL query.

They’re invoked after Craft has returned everything to satisfy the query, so they can only manipulate results—not influence what’s returned in the first place.

The [`formatDateTime` directive](../development/graphql.md#the-formatdatetime-directive), for example, can be used to return any date in a specific format:

```graphql{3}
{
  widgets {
    dateCreated @formatDateTime (format: "Y-m-d")
  }
}
```

Craft’s included directives apply exclusively to requested fields, though they may be applied in mutations and numerous parts of the type system.

A directive needs to provide a name, description, and the relevant query location(s) it can be applied. It can optionally specify [arguments](#arguments).

### Example Directive Class

This simple example returns the field value, replacing any instances of `foo` with `bar`.

```php
namespace mynamespace\gql\directives;

use craft\gql\base\Directive;
use craft\gql\GqlEntityRegistry;
use GraphQL\Language\DirectiveLocation;
use GraphQL\Type\Definition\Directive as GqlDirective;
use GraphQL\Type\Definition\ResolveInfo;

class BarTheFoo extends Directive
{

    public static function create(): GqlDirective
    {
        if ($type = GqlEntityRegistry::getEntity(self::name())) {
            return $type;
        }

        $type = GqlEntityRegistry::createEntity(static::name(), new self([
            'name' => static::name(),
            'locations' => [
                DirectiveLocation::FIELD,
            ],
            'description' => 'Replace `foo` with `bar`.',
            'args' => [],
        ]));

        return $type;
    }

    public static function name(): string
    {
        return 'fooTheBar';
    }

    public static function apply($source, $value, array $arguments, ResolveInfo $resolveInfo): mixed
    {
        return str_replace('foo', 'bar', (string)$value);
    }
}
```

### Registering Directives

You can register your directive by appending its class name to the `directives` array on the [registerGqlDirectives](craft5:craft\services\Gql::EVENT_REGISTER_GQL_DIRECTIVES) event object:

```php
use mynamespace\gql\directives\BarTheFoo;
use craft\events\RegisterGqlDirectivesEvent;
use craft\services\Gql;
use yii\base\Event;

Event::on(
    Gql::class,
    Gql::EVENT_REGISTER_GQL_DIRECTIVES,
    function(RegisterGqlDirectivesEvent $event) {
        $event->directives[] = BarTheFoo::class;
    }
);
```

## Mutations

A Mutation class defines named mutations that should be available, including consideration for scope access. Each mutation can have its own [arguments](#arguments) and type, and it will need a mutation resolver for modifying data using Craft’s API.

Our example could provide a `createWidget` mutation for creating a new widget:

::: code
```graphql{2} GraphQL Query
mutation NewWidget($title: String) {
  createWidget(title: $title) {
    id
    title
  }
}

# query variables:
# {
#  "title": "My Glorious Mutated Widget",
# }
```
```json JSON Response
{
  "data": {
    "createWidget": {
        "id": "123",
        "title": "My Glorious Mutated Widget"
    }
}
```
:::

::: tip
Like the name-getting methods mentioned earlier, Craft’s base elements include a <craft5:craft\base\Element::gqlMutationNameByContext()> method for providing context-sensitive type names.
:::

### Input Type Value Normalizers

Craft supports an additional `'normalizeValue'` option for [input object types](#input-types) that can be used to prep validated mutation data before it’s passed on to be saved by the [resolver](#resolvers).

This can be useful, for example, if you want to accept GraphQL arguments in one form (like strings) that Craft will expect in another (like IDs).

If you provide a `'normalizeValue'` key in your type definition, the value must be a method that receives the field value, does whatever it needs with that value, and returns it.

### Example Mutation Class

Similar to the [queries](#queries) example, this class implements `getMutations()` to return a list of available mutations. The mutation definition has a name, description, type, arguments, and a resolver:

```php
namespace mynamespace\gql\mutations;

use mynamespace\helpers\Gql as GqlHelper;
use mynamespace\gql\interfaces\Widget;
use mynamespace\gql\resolvers\mutations\Widget as WidgetMutationResolver;
use craft\gql\base\Mutation;
use GraphQL\Type\Definition\Type;

class Widget extends Mutation
{
    public static function getMutations(): array
    {
        // Make sure we should be able to mutate widgets
        if (!GqlHelper::canMutateWidgets()) {
            return [];
        }

        $mutations = [];

        // Create an instance of our mutation resolver
        $resolver = Craft::createObject(WidgetMutationResolver::class);

        if (GqlHelper::canSchema('widget', 'edit')) {
            // Create a new widget
            $mutations['createWidget'] = [
                'name' => 'createWidget',
                'args' => [
                    'title' => Type::nonNull(Type::string())
                ],
                'resolve' => [$resolver, 'saveWidget'],
                'description' => 'Saves a new widget.',
                'type' => Widget::getType(),
            ];
        }

        if (GqlHelper::canSchema('widget', 'save')) {
            // Save an existing widget
            // ...
        }

        if (GqlHelper::canSchema('widget', 'delete')) {
            // Delete a widget
            // ...
        }

        return $mutations;
    }
}
```

### Example Mutation Resolver

We saw earlier how a [resolver](#resolvers) translates the GraphQL request to data Craft can return. We’ll need a separate resolver that can translate the GraphQL mutation into data Craft saves.

```php
namespace mynamespace\gql\resolvers\mutations;

use mynamespace\elements\Widget as WidgetElement;
use craft\gql\base\ElementMutationResolver;
use GraphQL\Type\Definition\ResolveInfo;
use GraphQL\Error\UserError;
use Craft;

class Widget extends ElementMutationResolver
{
    protected $immutableAttributes = ['id', 'uid'];

    public function saveWidget($source, array $arguments, $context, ResolveInfo $resolveInfo)
    {
        $this->requireSchemaAction('widget', 'edit');

        $elementService = Craft::$app->getElements();
        $widget = $elementService->createElement(WidgetElement::class);
        // Have Craft populate the element’s content
        $widget = $this->populateElementWithData($widget, $arguments);
        // Always set our custom approved field to false for mutations
        $widget->approved = false;
        // Save the new element
        $widget = $this->saveElement($widget);

        if ($widget->hasErrors()) {
            $validationErrors = [];

            foreach ($widget->getFirstErrors() as $attribute => $errorMessage) {
                $validationErrors[] = $errorMessage;
            }
            
            // Throw a UserError with validation messages if we can’t save
            throw new UserError(implode("\n", $validationErrors));
        }

        // Return the newly-saved element
        return $elementService->getElementById($widget->id, WidgetElement::class);
    }
}
```

### Registering Mutations

You can register your mutation by including its definitions to the `mutations` array on the [registerGqlMutations](craft5:craft\services\Gql::EVENT_REGISTER_GQL_MUTATIONS) event object:


```php
use mynamespace\gql\resolvers\mutations\Widget as WidgetMutations;
use craft\events\RegisterGqlMutationsEvent;
use craft\services\Gql;
use GraphQL\Type\Definition\Type;
use yii\base\Event;

Event::on(
    Gql::class,
    Gql::EVENT_REGISTER_GQL_MUTATIONS,
    function(RegisterGqlMutationsEvent $event) {
        $event->mutations = array_merge(
            $event->mutations,
            WidgetMutations::getMutations(),
        );
    }
);
```

## Advanced Components

### Schema Components

Schema components define the distinct parts that can be enabled in Craft’s GraphQL schemas:

![Schema components in the Craft control panel](../images/control-panel-schema-components.png)

While these look like GraphQL permissions, the configuration of these components directly determines how a schema is built—not simply whether something has access to a part of the schema.

How you label, organize, and enforce your schema components is entirely up to you.

::: warning
If your GraphQL implementation doesn’t add and honor these settings, your types will be available by default to the public schema. Once you register schema components and check for them in your code, they’ll only be available for each schema in which they’re explicitly enabled.
:::

Each component’s key may include an applicable action scope in `:action` format. So the `widget` component having a `read` action would be `widget:read`.

The default action is `read`, and the available actions are:

- `read`
- `edit`
- `save`

If you provide explicit schema components, you a `:read` action is required.

::: danger
You must honor whatever components you register; this is not done by default!
:::

#### Registering Schema Components

The Gql service provides a [registerGqlSchemaComponents](craft5:craft\services\Gql::EVENT_REGISTER_GQL_SCHEMA_COMPONENTS) event you can use to append your own schema components to the event object’s `queries` and/or `mutations` arrays:

```php
use craft\events\RegisterGqlSchemaComponentsEvent;
use craft\services\Gql;
use yii\base\Event;

Event::on(
    Gql::class,
    Gql::EVENT_REGISTER_GQL_SCHEMA_COMPONENTS,
    function(RegisterGqlSchemaComponentsEvent $event) {
        $event->queries = array_merge($event->queries, [
            // “Widgets” group
            'Widgets' => [
                // widget component with read action, labelled “View Widgets” in UI
                'widget:read' => ['label' => 'View Widgets']
            ],
        ]);

        // Same format applies for $event->mutations
    }
);
```

If you’d like to further specify individual types, you can append each relevant UID in the key:

```php
use mynamespace\Plugin;
use craft\events\RegisterGqlSchemaComponentsEvent;
use craft\services\Gql;
use yii\base\Event;

Event::on(
    Gql::class,
    Gql::EVENT_REGISTER_GQL_SCHEMA_COMPONENTS,
    function(RegisterGqlSchemaComponentsEvent $event) {
        // Assume an array of objects each having `uid` and `name` properties
        $widgetTypes = Plugin::getInstance()->getAllWidgetTypes();

        if (!empty($widgetTypes)) {
            $queryComponents = [];

            foreach ($widgetTypes as $widgetType) {
                $queryComponents['widget.' . $widgetType->uid . ':read'] = [
                    'label' => 'View Widgets – ' . $widgetType->name
                ];
            }
        }

        $event->queries = array_merge($event->queries, [
            // “Widgets” group
            'Widgets' => $queryComponents,
        ]);
    }
);
```

### Eager Loading

If you’re adding relational fields that would benefit from eager loading, you’ll want to register those by adding them to the `fieldList` array on the [registerGqlEagerLoadableFields](craft5:craft\gql\ElementQueryConditionBuilder::EVENT_REGISTER_GQL_EAGERLOADABLE_FIELDS) event object.

::: tip
Any fields you add using Craft’s stock GraphQL types do _not_ need to be registered for eager loading.
:::

If we had added a custom field with the handle `widgets`, we’d register it like this:

```php
use mynamespace\fields\Widgets;
use craft\gql\ElementQueryConditionBuilder;
use craft\events\RegisterGqlEagerLoadableFields;
use yii\base\Event;

Event::on(
    ElementQueryConditionBuilder::class,
    ElementQueryConditionBuilder::EVENT_REGISTER_GQL_EAGERLOADABLE_FIELDS,
    function(RegisterGqlEagerLoadableFields $event) {
        $event->fieldList['widgets'] = [Widgets::class];
    }
);
```

The key should be the field name, and the value can be one or more classes that define it.

Any classes you provide determine the context for that field to be eager-loadable. You may otherwise pass `*` which, if present, allows that field to be used and eager loaded anywhere at all:

```php
// ...
$event->fieldList['widgets'] = ['*'];
// ...
```

::: tip
Craft makes use of an additional `canBeAliased` option internally, `true` by default and set to `false` in some specific situations—but you shouldn’t ever need to use that.
:::

### Argument Handlers

Argument handlers are another Craft-specific concept. These are like the inverse of directives, used for pre-processing an argument’s value before a query is executed.

#### Example Argument Handler Class

This example class extends [RelationArgumentHandler](craft5:craft\gql\base\RelationArgumentHandler) to translate a `relatedToWidgets` argument into a query argument for our Widget IDs:

```php
namespace mynamespace\gql\argumenthandlers;

use mynamespace\elements\Widget;
use craft\gql\base\RelationArgumentHandler;

class RelatedWidgets extends RelationArgumentHandler
{
    protected $argumentName = 'relatedToWidgets';

    protected function handleArgument($argumentValue)
    {
        $argumentValue = parent::handleArgument($argumentValue);
        return $this->getIds(Widget::class, $argumentValue);
    }
}
```

#### Registering Argument Handlers

Add a listener for [defineGqlArgumentHandlers](craft5:craft\gql\ArgumentManager::EVENT_DEFINE_GQL_ARGUMENT_HANDLERS) and append any argument handler class names:

```php
use mynamespace\gql\argumenthandlers\RelatedWidgets;
use craft\gql\ArgumentManager;
use craft\events\RegisterGqlArgumentHandlersEvent;

Event::on(
    ArgumentManager::class,
    ArgumentManager::EVENT_DEFINE_GQL_ARGUMENT_HANDLERS,
    function(RegisterGqlArgumentHandlersEvent $event) {
        $event->handlers["argumentName"] = RelatedWidgets::class;
    }
);
```

### Complexity Values

GraphQL complexity values are numeric scores assigned to fields that indicate how much processing power will be needed to return a result.

The combined values are limited by Craft’s <config5:maxGraphqlComplexity> setting. If a query or mutation’s complexity exceeds that limit, it will not be executed. Assigning appropriate complexity values ensures that a Craft site developer may manage that threshold for a safe, optimal use of compute resources.

If you provide a field definition that involves relations or processor-intensive operations, you should specify a complexity score.

The <craft5:craft\services\Gql> service has the following complexity constants:

| Constant                          | Value | Description |
| --------------------------------- | --- | -----------
| `GRAPHQL_COMPLEXITY_SIMPLE_FIELD` | 1   | Complexity value for accessing a simple field.
| `GRAPHQL_COMPLEXITY_QUERY`        | 10  | Complexity value for accessing a field that will trigger a single query for the request.
| `GRAPHQL_COMPLEXITY_EAGER_LOAD`   | 25  | Complexity value for accessing a field that will add an instance of eager-loading for the request.
| `GRAPHQL_COMPLEXITY_CPU_HEAVY`    | 200 | Complexity value for accessing a field that will likely trigger a CPU heavy operation.
| `GRAPHQL_COMPLEXITY_NPLUS1`       | 500 | Complexity value for accessing a field that will trigger a query for every parent returned.

The <craft5:craft\services\Gql> service also provides static methods to help calculate complexity values:

- <craft5:craft\services\Gql::eagerLoadComplexity()>
- <craft5:craft\services\Gql::singleQueryComplexity()>
- <craft5:craft\services\Gql::relatedArgumentComplexity()>
- <craft5:craft\services\Gql::nPlus1Complexity()>

Any field definition has the option of providing a `'complexity'` value in its array:

```php{7-9}
// ...
'children' => [
    'name' => 'children',
    'args' => WidgetArguments::getArguments(),
    'type' => Type::listOf(WidgetInterface::getType()),
    'description' => 'Widget’s children. Accepts same arguments as `widgets` query.',
    'complexity' => Gql::relatedArgumentComplexity(
        GqlService::GRAPHQL_COMPLEXITY_EAGER_LOAD
    ),
],
// ...
```

### Validation Rules

GraphQL queries are validated against the schema, and in some cases you may want to adjust the GraphQL validation rules that are applied.

Craft, for example, removes validation rules when <config5:devMode> is enabled so faulty queries can be investigated in a development environment. (Those same faults may cause problems in production.)

#### Registering Validation Rules

```php
use craft\events\DefineGqlValidationRulesEvent;
use craft\services\Gql;
use yii\base\Event;
use GraphQL\Type\Definition\Type;
use GraphQL\Validator\Rules\DisableIntrospection;

Event::on(
    Gql::class,
    Gql::::EVENT_DEFINE_GQL_VALIDATION_RULES,
    function (DefineGqlValidationRulesEvent $event) {
        // Permanently disable introspection
        $event->validationRules[DisableIntrospection::class] = new DisableIntrospection();
    }
);
```
</file>

<file path="extend/migrations.md">
# Migrations

Migrations are PHP classes that make one-time changes to the system.

For the most part, migrations in Craft work similarly to [Yii’s implementation](https://www.yiiframework.com/doc/guide/2.0/en/db-migrations), but unlike Yii, Craft manages three different types of migrations:

- **App migrations** – Craft’s own internal migrations.
- **Plugin migrations** – Each installed plugin has its own migration track.
- **Content migrations** – Your Craft project itself can have migrations, too.

## Creating Migrations

::: tip
If your Craft install is running from a Vagrant box, you will need to SSH into the box to run these commands.
:::

To create a new migration for your plugin or project, open up your terminal and go to your Craft project:

```bash
cd /path/to/project
```

Then run the following command to generate a new migration file for your plugin or project:

::: code

```bash Plugin Migration
php craft migrate/create my_migration_name --plugin=my-plugin-handle
```

```bash Content Migration
php craft migrate/create my_migration_name
```

:::

Enter `yes` at the prompt, and a new migration file will be created for you. You can find it at the file path output by the command.

If this is a plugin migration, increase your plugin’s [schema version](craft5:craft\base\PluginTrait::$schemaVersion), so Craft knows to check for new plugin migrations as people update to your new version.

### What Goes Inside

Migration classes contain methods: [safeUp()](<yii2:yii\db\Migration::safeUp()>) and [safeDown()](<yii2:yii\db\Migration::safeDown()>). `safeUp()` is run when your migration is _applied_, and `safeDown()` is run when your migration is _reverted_.

::: tip
You can usually ignore the `safeDown()` method, as Craft doesn’t have a way to revert migrations from the control panel.
:::

You have full access to [Craft’s API](https://docs.craftcms.com/api/v5/) from your `safeUp()` method, but plugin migrations should try to avoid calling the plugin’s own API here. As your plugin’s database schema changes over time, so will your APIs assumptions about the schema. If an old migration calls a service method that relies on database changes that haven’t been applied yet, it will result in a SQL error. So in general you should execute all SQL queries directly from your own migration class. It may feel like you’re duplicating code, but it will be more future-proof.

### Manipulating Database Data

Your migration class extends <craft5:craft\db\Migration>, which provides several methods for working with the database. It’s better to use these than their <craft5:craft\db\Command> counterparts, because the migration methods are both simpler to use, and they’ll output a status message to the terminal for you.

```php
// Bad:
$this->db->createCommand()
    ->insert('{{%mytablename}}', $rows)
    ->execute();

// Good:
$this->insert('{{%mytablename}}', $rows);
```

<craft5:craft\helpers\MigrationHelper> provides several helpful methods as well:

- [dropForeignKeyIfExists()](craft5:craft\helpers\MigrationHelper::dropForeignKeyIfExists()) removes a foreign key if it exists, without needing to know its exact name.
- [dropIndexIfExists()](craft5:craft\helpers\MigrationHelper::dropIndexIfExists()) removes an index if it exists, without needing to know its exact name.
- [dropTable()](craft5:craft\helpers\MigrationHelper::dropTable()) drops a table, along with any foreign keys that reference it (some of which your plugin might not even be aware of).

::: warning
The <yii2:yii\db\Migration::insert()>, [batchInsert()](<craft5:craft\db\Migration::batchInsert()>), and [update()](<yii2:yii\db\Migration::update()>) migration methods will automatically insert/update data in the `dateCreated`, `dateUpdated`, `uid` table columns in addition to whatever you specified in the `$columns` argument. If the table you’re working with does’t have those columns, make sure you pass `false` to the `$includeAuditColumns` argument so you don’t get a SQL error.
:::

::: tip
<craft5:craft\db\Migration> doesn’t have a method for _selecting_ data, so you will still need to go through Yii’s [Query Builder](https://www.yiiframework.com/doc/guide/2.0/en/db-query-builder) for that.

```php
use craft\db\Query;

$result = (new Query())
    // ...
    ->all();
```

:::

### Logging

If you want to log messages in your migration code, echo it out rather than calling [Craft::info()](<yii2:yii\BaseYii::info()>):

```php
echo "    > some note\n";
```

If the migration is being run from a console request, this will ensure the message is seen by whoever is executing the migration, as the message will be output into the terminal. If it’s a web request, Craft will capture it and log it to `storage/logs/` just as if you had used `Craft::info()`.

## Executing Migrations

You can have Craft apply your new migration from the terminal:

::: code

```bash Plugin Migration
php craft migrate/up --plugin=my-plugin-handle
```

```bash Content Migration
php craft migrate/up
```

:::

Or you can have Craft apply all new migrations across all migration tracks:

```bash
php craft migrate/all
```

Craft will also check for new plugin migrations on control panel requests, for any plugins that have a new [schema version](craft5:craft\base\PluginTrait::$schemaVersion), and content migrations can be applied from the control panel by going to Utilities → Migrations.

## Plugin Install Migrations

Plugins can have a special “Install” migration which handles the installation and uninstallation of the plugin. Install migrations live at `migrations/Install.php` alongside normal migrations. They should follow this template:

```php
<?php
namespace mynamespace\migrations;

use craft\db\Migration;

class Install extends Migration
{
    public function safeUp(): bool
    {
        // ...
    }

    public function safeDown(): bool
    {
        // ...
    }
}
```

You can give your plugin an install migration with the `migrate/create` command if you pass the migration name “`install`”:

```bash
php craft migrate/create install --plugin=my-plugin-handle
```

When a plugin has an Install migration, its `safeUp()` method will be called when the plugin is installed, and its `safeDown()` method will be called when the plugin is uninstalled (invoked by the plugin’s [install()](<craft5:craft\base\Plugin::install()>) and [uninstall()](<craft5:craft\base\Plugin::uninstall()>) methods).

::: tip
It is _not_ a plugin’s responsibility to manage its row in the `plugins` database table. Craft takes care of that for you.
:::

### Setting Default Project Config Data

If you want to add things to the [project config](project-config.md) on install, either directly or via your plugin’s API, be sure to only do that if the incoming project config YAML doesn’t already have a record of your plugin.

```php
public function safeUp(): bool
{
    // ...

    // Don’t make the same config changes twice
    if (Craft::$app->projectConfig->get('plugins.my-plugin-handle', true) === null) {
        // Make the config changes here...
    }
}
```

That’s because there’s a chance that your plugin is being installed as part of a project config sync, and if its install migration were to make any project config changes of its own, they would overwrite all of the incoming project config YAML changes.

The reverse could be useful if you need to make changes when your plugin is uninstalled:

```php{6-14}
public function safeUp(): bool
{
    // ...
}

public function safeDown(): bool
{
    // ...

    // Don’t make the same config changes twice
    if (Craft::$app->projectConfig->get('plugins.my-plugin-handle', true) !== null) {
        // Make the config changes here...
    }
}
```
</file>

<file path="extend/module-guide.md">
# How to Build a Module

Functionally, modules are every bit as capable as [plugins](plugin-guide.md), but they are best suited for project-specific extensions or customizations as opposed to public, distributable packages.

At a technical level, modules (a [Yii concept](guide:structure-modules)) are registered with Craft and initialized alongside the application, giving them an opportunity to observe, supplement, and change what it does.

## Preparation

Two characteristics must be decided before you begin work on a module:

Namespace
: The root namespace that your module’s classes will live in. Note that this should *not* begin with `craft\`; use something that identifies you (the developer), or the project.
: See the [PSR-4](https://www.php-fig.org/psr/psr-4/) autoloading specification for details.

Module ID
: Something that uniquely identifies the module within your project. IDs must begin with a letter and contain only lowercase letters, numbers, and dashes, and should be `kebab-cased`.
: The module ID will become the first segment in [controller action](./controllers.md) paths. Avoid names that will conflict with Craft’s core [controllers](repo:craftcms/cms/tree/develop/src/controllers) or the handles of any installed plugins (e.g. `app` would conflict with <craft5:craft\controllers\AppController>, and `commerce` would collide with [Commerce](/commerce/5.x/README.md)).


As an alternative to modules, private [plugins](plugin-guide.md) provide all the functionality of a regular plugin, but are intended to be tracked as part of a project rather than distributed.

## Scaffolding

::: tip
If this is your first time setting up a module, consider using the [Generator](generator.md)—it will prompt you for all of the required information, and leave you with a nicely-organized workspace.

<p><Generator component="module" /></p>
:::

To create a module, create a new directory for it somewhere within your Craft project, such as `modules/<ModuleID>/`. For example, if your [module ID](#preparation) is `foo`, you might set it up like this:

```treeview
my-project/
├── modules/
│   └── foo/
│       └── Module.php
├── templates/
└── ...
```

## Set up class autoloading

Next up, you need to tell Composer how to find your module’s classes by setting the [`autoload`](https://getcomposer.org/doc/04-schema.md#autoload) field in your project’s `composer.json` file. Unlike a plugin, modules don’t need their own `composer.json` file.

If your module’s namespace is `foo`, and it’s located at `modules/foo/`, this is what you should add:

```json
{
  // ...
  "autoload": {
    "psr-4": {
      "foo\\": "modules/foo/"
    }
  }
}
```

With that in place, go to your project’s directory in your terminal, and run the following command:

```bash
composer dump-autoload -a
```

That will tell Composer to update its class autoloader script based on your new `autoload` mapping.

## The Module class

The `Module.php` file is your module’s entry point for the system. Its `init()` method is the best place to register event listeners, and any other steps it needs to take to initialize itself.

Use this template as a starting point for your `Module.php` file:

```php
namespace foo;

use Craft;

class Module extends \yii\base\Module
{
    public function init()
    {
        // Define a custom alias named after the namespace
        Craft::setAlias('@foo', __DIR__);

        // Set the controllerNamespace based on whether this is a console or web request
        if (Craft::$app->getRequest()->getIsConsoleRequest()) {
            $this->controllerNamespace = 'foo\\console\\controllers';
        } else {
            $this->controllerNamespace = 'foo\\controllers';
        }

        parent::init();

        // Custom initialization code goes here...
    }
}
```

Replace `foo` with your module’s actual namespace, and `'@foo'` with an [alias](guide:concept-aliases) name based on your actual namespace (with any `\`s converted to `/`s).

### Initialization

Most initialization logic belongs in your module’s `init()` method.

However, there are some situations where this doesn’t guarantee a certain part of the application is ready (another plugin, for instance). Conversely, a module that isn’t [bootstrapped](#update-the-application-config) at the beginning of a request may have `init()` called too late to listen to <craft5:craft\web\Application::EVENT_INIT>, and would never be notified that the app is indeed ready.

In those cases, it’s best to register a callback via <craft5:craft\base\ApplicationTrait::onInit()>:

```php
namespace foo;

use Craft;

class Module extends \yii\base\Module
{
    public function init()
    {
        // ...

        // Defer some setup tasks until Craft is fully initialized:
        Craft::$app->onInit(function() {
            // ...
        });
    }
}
```

::: tip
If Craft has already fully initialized, your callback will be invoked immediately.
:::

In particular, avoid creating [element queries](../element-queries.md) or causing the [Twig environment](../dev/twig-primer.md) to be loaded from your `init()` method. Both can result in race conditions and incomplete initialization.

### Update the application config

You can add your module to your project’s [application configuration](../configure.md#application-configuration) by listing it in the [modules](yii2:yii\base\Module::modules) and [bootstrap](yii2:yii\base\Application::bootstrap) arrays. For example, if your module ID is `foo` and its Module class name is `foo\Module`, this is what you should add to `config/app.php`:

```php{4,7}
return [
    // ...
    'modules' => [
        'foo' => foo\Module::class,
    ],
    'bootstrap' => [
        'foo',
    ],
];
```

::: tip
If your module doesn’t need to get loaded on _every_ request (say, because it only provides controllers), you can remove its ID from the `bootstrap` array, and lazily instantiate it via `foo\Module::getInstance()`. Keep in mind that event listeners in your module’s `init()` method are only attached once it is initialized, which can lead to “missed” events.
:::


## Further Reading

To learn more about modules, see the [Yii documentation](guide:structure-modules).
</file>

<file path="extend/plugin-editions.md">
# Plugin Editions

The Plugin Store supports multi-edition plugins, which work similarly to Craft’s two editions (Solo and Pro).

- Plugins that support multiple editions are still comprised of a single Composer package.
- Plugins’ active edition is recorded in the [project config](../project-config.md).
- Plugins can implement feature toggles by checking their active edition.

::: warning
Not every plugin can or should support editions. [Contact](https://craftcms.com/contact) Pixel & Tonic before you begin adding edition support to make sure it will be allowed for your plugin.
:::

## Define the Editions

To add edition support to a plugin, begin by defining the available editions (in ascending order), by overriding <craft5:craft\base\Plugin::editions()>.

```php
class Plugin extends \craft\base\Plugin;
{
    const EDITION_LITE = 'lite';
    const EDITION_PRO = 'pro';

    public static function editions(): array
    {
        return [
            self::EDITION_LITE,
            self::EDITION_PRO,
        ];
    }

    // ...
}
```

## Add Feature Toggles

Your feature toggles can call your plugin’s [is()](craft5:craft\base\Plugin::is()) method.

::: code

```php
if (Plugin::getInstance()->is(Plugin::EDITION_PRO) {
    // Pro edition-only code goes here...
}
```

```twig
{% if plugin('plugin-handle').is('pro') %}
  {# Pro edition-only code goes here... #}
{% endif %}
```

:::

`is()` accepts two arguments, `$edition` and `$operator`.

`$edition` is the name of the edition you’re concerned with.

`$operator` is how you wish to compare that edition with the installed edition. By default it is set to `=`, which tests for version equality.

The following operators are also supported:

Operator | Tests if the active edition is ____ the given edition
- | -
`<` or `lt` | …less than…
`<=` or `le` | …less than or equal to…
`>` or `gt` | …greater than…
`>=` or `ge` | …greater than or equal to…
`==` or `eq` | …equal to… (same as default behavior)
`!=`, `<>`, or `ne` | …not equal to…

::: tip
Changing editions should always be a lossless operation; no plugin data should change as a result of the edition change. Editions can change back and forth at any time, and plugins should have no problem rolling with it.
:::

## Testing

You can toggle the active edition by changing the `plugins.<plugin-handle>.edition` property in `config/project/project.yaml`.

After changing the value to a valid edition handle (one returned by your plugin’s `editions()` method), Craft will prompt you to sync your project config YAML changes into the loaded project config. Once that’s done, your plugin’s active edition will be set to the new edition, and feature toggles should start behaving accordingly.
</file>

<file path="extend/plugin-guide.md">
# How to Build a Plugin

Plugins are typically designed and built as public packages, distributable via the first-party [Plugin Store](plugin-store.md). You can also create [private plugins](#private-plugins) in lieu of a [module](module-guide.md) when the full suite of features are desirable (i.e. control panel navigation, settings, and project config) but the added functionality is still project-specific.

At a technical level, plugins are a type of [Yii module](guide:structure-modules) that are registered with Craft and initialized alongside the application, giving them an opportunity to supplement, change, or observe what the application does.

## Preparation

Your first task is to decide on a few characteristics that will dictate how your plugin is [scaffolded](#scaffolding):

Package name
:   Used to name your Composer package for the plugin. (See Composer’s [documentation][package name] for details.) We recommend prefixing the second segment (after the `/`) with `craft-`, to help identify that this is a Craft plugin. For example, `pixelandtonic/craft-recipes`.

Namespace
:   The root namespace that your plugin’s classes will live in. (See the [PSR-4] autoloading specification for details.) Note that this should _not_ begin with `craft\`; use something that identifies you, the developer or vendor.

Plugin handle
:   Something that uniquely identifies your plugin within the Craft ecosystem. (Plugin handles must begin with a letter and contain only lowercase letters, numbers, and dashes. They should be `kebab-cased`.)

Plugin name
:   What your plugin will be called within the control panel. This should be a clear and consistent identifier throughout its design and digital presence (if you choose to distribute it). Consider the longevity of your name, and how it fits with these guidelines:

    - **Don’t** reference the Craft version in your plugin’s name, folder, or repository URL. It’ll require more work and licensing considerations if you update it for another major Craft release.\
    Example: `craft-foo`, not `craft3-foo`.
    - **Do** add `craft-` as a prefix in your GitHub repository name. This helps differentiate any Craft plugins from other projects.\
    Example: `craft-foo`, not `foo-plugin`.
    - **Do** keep your Composer package name reasonably concise. Developers will see (and type) the package name when installing the plugin.\
    Example: `composer require acme/craft-thinginator`, not `composer require acme/craft-super-advanced-thinginator-by-acme`.

    ::: warning
    Your plugin’s name _must not_ begin with “Craft”, or include an [edition](plugin-editions.md)-sounding word like “Lite”, “Plus”, or “Pro”.
    :::

### Private Plugins

A plugin can be made “private” by prefixing its handle with an underscore (like `_my-private-plugin`). Private plugins have all the same features as regular plugins, but are excluded from license verification (and are ineligible for listing on the [Plugin Store](plugin-store.md)); you can even publish a private plugin to GitHub or Packagist and share it between multiple projects, taking advantage of features like [migration tracks](migrations.md).

Private plugins can also be scaffolded with the [Generator](generator.md).

## Scaffolding

::: tip
If this is your first time setting up a plugin, consider using the [Generator](generator.md)—it will prompt you for all of the required information, and leave you with a nicely-organized workspace.

<p><Generator component="plugin" /></p>

The remainder of this section covers the outcome of the choices you’ll make when using the Generator—but you won’t need to follow any instructions that involve creating files or folders.
:::

To create a plugin, create a new directory for it somewhere on your computer. A common approach is to store them in a `~/dev/` folder alongside your Craft projects:

```treeview
~/dev/
├── my-project/
│   └── ...
└── my-plugin/
    ├── CHANGELOG.md
    ├── LICENSE.md
    ├── README.md
    ├── composer.json
    └── src/
        └── Plugin.php
```

The name of your plugin directory doesn’t matter. Just choose something that is easy to identify.

## composer.json

Create a `composer.json` file at the root of your plugin directory, and use this template as a starting point:

```json
{
  "name": "package/name",
  "description": "Your plugin’s package description",
  "type": "craft-plugin",
  "keywords": ["some", "keywords", "here"],
  "license": "MIT",
  "authors": [
    {
      "name": "Developer Name",
      "homepage": "https://developer-website.tld"
    }
  ],
  "support": {
    "email": "email@developer-website.tld",
    "issues": "https://github.com/developer/repo/issues?state=open",
    "source": "https://github.com/developer/repo",
    "docs": "https://github.com/developer/repo/blob/master/README.md"
  },
  "require": {
    "craftcms/cms": "^5.3.0"
  },
  "autoload": {
    "psr-4": {
      "namespace\\prefix\\": "src/"
    }
  },
  "extra": {
    "name": "Plugin Name",
    "handle": "my-plugin-handle"
  }
}
```

Review and replace the following values:

- `package/name` with your package name.
- `Developer Name` with your name, or the organization name that the plugin should be attributed to.
- `https://developer-website.tld` with the URL to the website the developer name should link to in the control panel.
- `email@developer-website.tld` with your support email.
- `developer/repo` with the actual GitHub account and repository names where the plugin will live.
- `master` with the actual primary branch name of your GitHub repository.
- `namespace\\prefix\\` with your namespace prefix. (Use double-backslashes because this is JSON, and note this must end with `\\`.)
- `Plugin Name` with your plugin name.
- `my-plugin-handle` with your plugin handle.
- `MIT` with `proprietary` if you plan to use [Craft License](https://craftcms.github.io/license/). Read more about [choosing a license](plugin-store.md#choose-a-license).

In addition to `name` and `handle` (both of which are required), there are a few other things you can include under the `extra` key:

- `class` — The [main plugin class](#the-plugin-class) name. If not set, the installer will look for a `Plugin.php` file at the root of each `autoload` path.
- `description` — A brief description of your plugin’s purpose. If not set, the main `description` property will be used.
- `developer` — The developer name. If not set, the first author’s `name` will be used (via the `authors` property).
- `developerUrl` — The developer URL. If not set, the `homepage` property will be used, or the first author’s `homepage` (via the `authors` property).
- `developerEmail` — The support email. If not set, the `support.email` property will be used.
- `documentationUrl` — The plugin’s documentation URL. If not set, the `support.docs` property will be used.

Some of these values are displayed in the Craft control panel (in <Journey path="Settings, Plugins" />—[see below](#plugin-icons) for an example) and used to auto-populate a handful of fields when you begin the Plugin Store submission process. We encourage you to provide a more thorough description—or update its details any time thereafter—via [Craft Console](kb:what-is-craft-console)—descriptions and URLs are _not_ synchronized again.

## The Plugin Class

The `src/Plugin.php` file is your plugin’s entry point for the system. Craft instantiates a singleton of your plugin class at the beginning of every request, [invoking its `init()` method](#initialization). This is the best place to register [event listeners](events.md), and perform any other setup steps.

Use this template as a starting point for your `Plugin.php` file:

```php
namespace mynamespace;

class Plugin extends \craft\base\Plugin
{
    public function init()
    {
        parent::init();

        // Custom initialization code goes here...
    }
}
```

::: warning
Don’t move or rename this class or file after [publishing](plugin-store.md) a plugin. Craft stores references to its fully-resolved class name in configuration, and may have issues initializing if it goes missing.
:::

### Automatic Defaults

Plugins are automatically given a few key features to simplify setup and provide a consistent developer experience:

- An [alias](../configure.md#aliases) is registered, corresponding to each autoloading namespace. If your plugin’s root namespace was `acmelabs\mousetrap`, Craft would create `@acmelabs/mousetrap`.
- The plugin’s `controllerNamespace` is configured such that web requests are served by [controllers](controllers.md) in a `controllers/` directory adjacent to the main plugin file, and [console commands](commands.md) are resolved using classes in `console/controllers/`.

### Initialization

Most initialization logic belongs in your plugin’s `init()` method. However, there are some situations in which parts of the application aren’t ready yet (like another plugin)—in particular, creating [element queries](../development/element-queries.md) or causing the [Twig environment](../development/twig.md) to be loaded prematurely can result in race conditions and incomplete initialization.

In these cases, it’s best to register a callback via <craft5:craft\base\ApplicationTrait::onInit()>, from your plugin’s `init()` method:

```php
namespace mynamespace;

use Craft;

class Plugin extends \craft\base\Plugin
{
    public function init(): void
    {
        // Always let the parent init() method run, first:
        parent::init();

        // Set up critical components + features...

        // Defer some setup tasks until Craft is fully initialized:
        Craft::$app->onInit(function() {
            // ...
        });
    }

    // ...
}
```

::: tip
If Craft has already fully initialized, your callback will be invoked immediately.
:::

Conversely, there are cases in which attaching [event listeners](events.md) in `onInit()` may be _too late_—by the time your callback is invoked, those events may have already happened.

### Accessing your Plugin

When you need a reference to your main plugin class (say, from a [controller](controllers.md) or [service](services.md)), use the static instance getter:

```php
use mynamespace\Plugin as MyPlugin;

$pluginInstance = MyPlugin::getInstance();
```

Each time you call this, the same “singleton” will be returned, so anything you’ve memoized on the class (say, as private properties) will be preserved.

::: warning
You should never need to create additional instances of your plugin!
:::

### Components and Getters

As your plugin’s capabilities grow, you may want to organize functionality into [services](services.md). Yii is able to resolve any services you configure via your plugin’s [setComponents()](yii2:yii\base\Component::setComponents()) method, but some [IDE](README.md#ide)s are aided by [`@property` docblock tags](https://docs.phpdoc.org/guide/references/phpdoc/tags/property.html) or explicit [component getters](services.md#component-getters).

## Loading your plugin into a Craft project

When you scaffold a new plugin with the [generator](#scaffolding), Craft takes care of connecting the project’s `composer.json` to the new local directory using a [path repository](#path-repository). You are free to continue local development like this, indefinitely—but it’s important to understand how other developers might install your plugin, later!

Once published, other developers can [install your plugin via Packagist](#packagist). These steps are identical for any plugin in the [Plugin Store](plugin-store.md).

### Packagist

If you’re ready to [publicly release](plugin-store.md) your plugin, register it as a new Composer package on [Packagist](https://packagist.org/). Other developers can install it like any other package, by passing its name to Composer’s `require` command:

```bash
# go to the project directory
cd /path/to/my-project

# require the plugin package
composer require package/name
```

DDEV users have access to this shortcut when interacting with Composer:

```bash
ddev composer require package/name
```

<See path="plugin-store.md" label="Publishing to the Plugin Store" description="Get your plugin ready to publish in the official Plugin Store!" />

### Path Repository

During development, the easiest way to work on your plugin is with a [path repository][path]. This allows Composer to _symbolically link_ your plugin into the `vendor/` folder, right alongside other dependencies.

To set it up, open your Craft project’s `composer.json` file and make the following changes:

- Set [minimum-stability](https://getcomposer.org/doc/04-schema.md#minimum-stability) to `"dev"`
- Set [prefer-stable](https://getcomposer.org/doc/04-schema.md#prefer-stable) to `true`
- Add a new [path repository](https://getcomposer.org/doc/05-repositories.md#path) record, pointed at your plugin’s root directory.

```json
{
  "minimum-stability": "dev",
  "prefer-stable": true,
  "repositories": [
    {
      "type": "path",
      "url": "./local/my-plugin"
    }
  ]
}
```

Set the `url` value to the absolute or relative path to your plugin’s source directory. The `./local/my-plugin` example above assumes that the plugin was cloned into a directory named `local/`, which exists alongside `composer.json`.

::: tip
If you are using a containerized development environment like DDEV, Composer may not be able to see directories outside the current project! You can either clone another copy of the repository into the project, or configure a new mount by creating `./config/docker-compose.plugin-mount.yml`:

```yml
services:
  web:
    volumes:
      - "$HOME/Developer/my-plugin:/home/shared/my-plugin"
```

This will be merged with DDEV’s main web container config; you can then replace the path repository’s `url` with the absolute path `/home/shared/my-plugin`.
:::

In a terminal, go to your Craft project and require the plugin using the same package name you gave your plugin in its `composer.json` file:

```bash
composer require package/name
```

Composer’s output should show that the package was installed via a symlink:

```
  - Installing package/name (X.Y.Z): Symlinking from ./local/my-plugin
```

::: warning
One caveat of `path` Composer repositories is that Composer may ignore `path`-based dependencies when you run `composer update`. So any time you change anything in a plugin’s `composer.json` (like its dependencies or [extras](#composer-json)), you may need to completely remove and re-require your plugin for those changes to take effect:

```bash
# Remove the plugin package from your project:
composer remove package/name

# Re-require the plugin package, and allow updates to dependencies:
composer require package/name -w
```
:::

This same process can be used to fork, clone, and contribute to any open-source or source-available plugin!

## Plugin Icons

Plugins can provide an icon, which will be visible on the **Settings** → **Plugins** page.

<BrowserShot url="https://my-project.tld/admin/settings/plugins" :link="false" caption="The Settings → Plugins page in Craft’s control panel.">
<img src="../images/plugin-index.png" alt="Screenshot of control panel Settings → Plugins">
</BrowserShot>

Plugin icons must be square SVG files, saved as `icon.svg` at the root of your plugin’s source directory (e.g `src/`).

If your plugin has a [control panel section](cp-section.md), you can also give its global nav item a custom icon by saving an `icon-mask.svg` file in the root of your plugin’s source directory. Note that this icon cannot contain strokes, and will always be displayed in a solid color (respecting alpha transparency).

[package name]: https://getcomposer.org/doc/04-schema.md#name
[psr-4]: https://www.php-fig.org/psr/psr-4/
[path]: https://getcomposer.org/doc/05-repositories.md#path
</file>

<file path="extend/plugin-settings.md">
# Plugin Settings

## Settings Model

Once you’ve indicated your plugin will have settings by enabling `hasCpSettings` in your main plugin class or `composer.json`, you’ll need to provide a model for defining them.

This “settings model” is responsible for storing and validating the setting values.

Settings models are just like any other [model](guide:structure-models). To create it, create a `models/` directory within your plugin’s source directory, and create a `Settings.php` file within it:

```php
<?php

namespace mynamespace\models;

use craft\base\Model;

class Settings extends Model
{
    public $foo = 'defaultFooValue';
    public $bar = 'defaultBarValue';

    public function defineRules(): array
    {
        return [
            [['foo', 'bar'], 'required'],
            // ...
        ];
    }
}
```

Next up, add a `createSettingsModel()` method on your main plugin class, which returns a new instance of your settings model:

```php
<?php
namespace mynamespace;

class Plugin extends \craft\base\Plugin
{
    protected function createSettingsModel(): ?Model
    {
        return new \mynamespace\models\Settings();
    }

    // ...
}
```

::: warning
The setting model’s [`fields()`](<https://www.yiiframework.com/doc/api/2.0/yii-base-model#fields()-detail>) are serialized for project config, so any complex or nested data types that aren’t compatible with [`toArray()`](<https://www.yiiframework.com/doc/api/2.0/yii-base-arrayabletrait#toArray()-detail>) should be excluded from `fields()` and declared in [`extraFields()`](<https://www.yiiframework.com/doc/api/2.0/yii-base-arrayabletrait#extraFields()-detail>) instead.
:::

## Accessing Settings

With your settings model and `createSettingsModel()` method in place, you can now access your settings model, populated with any custom values set for the current project, via a `getSettings()` method on your main plugin class:

```php
// From your main plugin class:
$foo = $this->getSettings()->foo;

// From elsewhere:
$foo = \mynamespace\Plugin::getInstance()->getSettings()->foo;
```

Or you can use the `$settings` magic property:

```php
// From your main plugin class:
$foo = $this->settings->foo;

// From elsewhere:
$foo = \mynamespace\Plugin::getInstance()->settings->foo;
```

## Overriding Setting Values

Your setting values can be overridden on a per-project basis from a PHP file within the project’s `config/` folder, named after your plugin handle. For example, if your plugin handle is `foo-bar`, its settings can be overridden from a `config/foo-bar.php` file.

The file just needs to return an array with the overridden values:

```php
<?php

return [
    'foo' => 'overriddenFooValue',
    'bar' => 'overriddenBarValue',
];
```

It can also be a multi-environment config:

```php
<?php

return [
    '*' => [
        'foo' => 'defaultValue',
    ],
    '.test' => [
        'foo' => 'devValue',
    ],
];
```

::: warning
The config file cannot contain any keys that are not defined in the plugin’s settings model.
:::

## Settings Pages

Plugins can also provide a settings page in the control panel, which may make it easier for admins to manage settings values, depending on the plugin.

To give your plugin a settings page, create a `templates/` directory within your plugin’s source directory, and create a `settings.twig` file within it:

```twig
{% import '_includes/forms.twig' as forms %}

{{ forms.textField({
  label: 'Foo',
  name: 'foo',
  value: settings.foo
}) }}

{{ forms.textField({
  label: 'Bar',
  name: 'bar',
  value: settings.bar
}) }}
```

Then, within your main plugin class, set the `$hasCpSettings` property to `true`, and define a `settingsHtml()` method that returns your new rendered template:

```php{9,16-22}
<?php

namespace mynamespace;

use craft\base\Model;

class Plugin extends \craft\base\Plugin
{
    public bool $hasCpSettings = true;

    protected function createSettingsModel(): ?Model
    {
        return new \mynamespace\models\Settings();
    }

    protected function settingsHtml(): ?string
    {
        return \Craft::$app->getView()->renderTemplate(
            'my-plugin-handle/settings',
            ['settings' => $this->getSettings()]
        );
    }

    // ...
}
```

With all that in place, your plugin will now get its own icon on the Settings page, and a cog icon in its row on the <Journey path="Settings, Plugins" /> page, which will link to `/admin/settings/plugins/my-plugin-handle`. Craft manages the routing internally, for both displaying settings pages and receiving POSTed data; `settingsHtml()` should _not_ return an entire HTML `<form>` element.

<See path="project-config.md" hash="secrets-and-environmental-differences" label="Settings and Project Config" description="Learn how to support environment variables and aliases in your plugin settings." />

### Advanced Settings Pages

When the `/admin/settings/plugins/my-plugin-handle` control panel URL is requested, your plugin is ultimately in charge of the response. Namely, your plugin’s `getSettingsResponse()` method. The default `getSettingsResponse()` implementation in <craft5:craft\base\Plugin> will call your plugin’s `settingsHtml()` method, and then tell the active controller to render Craft’s `settings/plugins/_settings` template (the layout template for plugin settings pages), passing it the HTML returned by `settingsHtml()`.

If a plugin needs more control over its settings page(s), it can override its `getSettingsResponse()` method and do whatever it wants with the request, like render its own template…

```php
public function getSettingsResponse(): mixed
{
    return \Craft::$app
        ->controller
        ->renderTemplate('my-plugin-handle/settings/template');
}
```

…or redirect the request:

```php
public function getSettingsResponse(): mixed
{
    $url = \craft\helpers\UrlHelper::cpUrl('my-plugin-handle/settings');

    return \Craft::$app->controller->redirect($url);
}
```

Be aware that whatever you return is directly returned by <craft5:craft\controllers\PluginsController::actionEditPluginSettings()>, and therefore must be compatible with a standard controller action.
</file>

<file path="extend/plugin-store.md">
# Publishing to the Plugin Store

If you want to make your plugin available in the in-app Plugin Store (and on [plugins.craftcms.com](https://plugins.craftcms.com/)) follow this guide.

## Choose a License

All plugins in the Plugin Store must select a software license.

Commercial plugins are recommended to use the [Craft license](https://raw.githubusercontent.com/craftcms/license/master/index.md).

To use the Craft license:

1. Copy the license text into a `LICENSE.md` file at the root of your repository, and replace `[YOUR_NAME_HERE]` with your personal/organization name.
2. Set the `license` value in `composer.json` to `"proprietary"`.

The following open source licenses are also allowed:

- [Apache-2.0](https://raw.githubusercontent.com/licenses/license-templates/master/templates/apache.txt)
- [GPL-2.0](https://raw.githubusercontent.com/licenses/license-templates/master/templates/gpl2.txt)
- [GPL-3.0](https://raw.githubusercontent.com/licenses/license-templates/master/templates/gpl3.txt)
- [MIT](https://raw.githubusercontent.com/licenses/license-templates/master/templates/mit.txt)

The MIT license is generally recommended, unless you have a good reason to use something else.

To use an open source license:

1. Copy the license text into a `LICENSE.txt` file at the root of your repository, prefixed with a copyright notice (e.g. `Copyright (c) Pixel & Tonic, Inc.`).
2. Set the `license` value in `composer.json` to the appropriate [license name](https://getcomposer.org/doc/04-schema.md#license).

## Registering your Plugin

To register a plugin, it must be pushed to a public GitHub repository. Create a Craft Console account at [console.craftcms.com](https://console.craftcms.com) and connect it to your GitHub account. Then, [set up an organization](kb:craft-console-organizations) to represent you (or your business) in the Plugin Store; organizations also determine [how you get paid](#payouts).

In your Console organization, navigate to **Plugin Store** &rarr; **Plugins** &rarr; **Add a plugin**, then search for and select a repository. Some details will be pre-populated for you (based on information [provided in the root `composer.json` file](plugin-guide.md#composerjson)), but you can make any desired changes to its description, screenshots, and other details, before submitting.

### Choose a Price

If you wish to sell your plugin, choose a price point that makes sense. Here are some suggested price ranges to consider:

| Price Range | Example Use Cases
| ----------- | ------------------------------------------------------
| $10–$29     | Lightweight “plug and play” utilities and integrations
| $49–$99     | Complex field types and integrations
| $149–$249   | Plugins that add significant new system functionality
| $499–$999   | Major or highly niche applications

You will also be required to pick a **Renewal Price**, which is the annual fee the Plugin Store will charge customers who wish to continue installing new updates, after the first year. Pick a Renewal Price that is around 20–50% of the initial Price. For example, if you are charging $99 for your plugin, your Renewal Price should be between $19-$49.

Pixel & Tonic takes a 20% processing fee on all plugin sales; be sure and factor this into your plugin pricing.

::: warning
If you initially submit your plugin as free, you will not be allowed to change it to commercial later. You can, however, give it a commercial [edition](plugin-editions.md) that offers extended functionality, as long as you don’t remove crucial functionality from the free edition.

All plugins (and editions thereof) can be trialed in development and staging environments, prior to purchase.
:::

### Declare Craft Version Support

Every plugin needs to explicitly require a minimum Craft CMS version in `composer.json`:

```json
"require": {
  "craftcms/cms": "^5.0.0"
}
```

This version can change between releases. As long as you’ve tagged a release declaring major-version compatibility, we will display that on its individual listing, and include it in that version’s catalog for browsing and searching.

If your plugin is compatible with multiple major versions of Craft, we will honor version constraints that include the logical “or” operator (`||`), like `^4.8.1||^5.0.0`.

### Submit for Approval

When you’re ready to submit your plugin, click the “Submit for approval” button. Once your plugin is approved, it will become visible on [plugins.craftcms.com](https://plugins.craftcms.com/).

You must [tag a release](#plugin-releases) before your plugin will appear in the Plugin Store within Craft’s [control panel](../system/control-panel.md#).

::: tip
Consider registering your plugin on [Packagist](https://packagist.org/) in addition to the Plugin Store, so that developers can install and update your plugin via Composer. Packagist is _not_ a requirement for listing in the Plugin Store, but it makes discovery and automation easier for your customers!
:::

### Payouts

Plugin authors in the United States, Europe, Australia, and New Zealand are eligible for automatic payouts via our payment processor, [Stripe](https://stripe.com/). Vendors outside these markets are paid out via PayPal.

::: warning
If neither option is viable for your business, please send us an email before publishing your plugin!
:::

## Plugin Releases

To release a new version of your plugin, first decide on the version number. The Plugin Store follows the same [Semantic Versioning](https://semver.org/) conventions supported by Composer:

- Versions should have 3 or 4 segments (e.g. `1.2.3` or `1.2.3.4`).
- Prerelease versions should end with a release identifier (`-alpha.X`, `-beta.X`, or `-RCX`).

Once you’ve decided on a version, follow these steps:

1. If your plugin has a [changelog](changelogs-and-updates.md), make sure the new version has a correctly-formatted heading, including the release date.

   ```markdown
   ## 5.0.0 - 2018-03-31
   ```

2. If your plugin’s `composer.json` file includes a `version` property, make sure that it is set to the new version number.

3. Once everything is good to go and committed to Git, [create a tag](https://git-scm.com/book/en/v2/Git-Basics-Tagging) named after the version number, optionally beginning with `v` (e.g. `v5.0.0` or `v5.0.0-beta.1`). Prefixing the tag name with `release-` is also allowed (e.g. `release-5.0.0` or `release-v5.0.0`).

4. Push your latest commits and your new version tag to GitHub. The Plugin Store will automatically be notified about the release, and will start recording it. Changes typically show up in the Plugin Store within a minute or two.

### Automating GitHub Releases

You can automate creating new [GitHub releases](https://docs.github.com/en/repositories/releasing-projects-on-github/about-releases) for your plugin versions by giving your plugin a new GitHub action.

To do that, add a `.github/workflows/create-release.yml` file on the plugin repository’s **default branch**, with the following contents:

```yaml
name: Create Release
run-name: Create release for ${{ github.event.client_payload.version }}

on:
  repository_dispatch:
    types:
      - craftcms/new-release

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: ncipollo/release-action@v1
        with:
          body: ${{ github.event.client_payload.notes }}
          makeLatest: ${{ github.event.client_payload.latest }}
          name: ${{ github.event.client_payload.version }}
          prerelease: ${{ github.event.client_payload.prerelease }}
          tag: ${{ github.event.client_payload.tag }}
```

That’s it! Going forward, whenever the Plugin Store is notified about new version tags, a new release will be created for the tag, with release notes extracted from `CHANGELOG.md`—provided it follows the [recommended format](changelogs-and-updates.md).

## Changing the GitHub Repository URL

You can change your plugin’s GitHub repository URL at any time. After you’ve done so, you will need to contact [support@craftcms.com](mailto:support@craftcms.com) to notify Pixel & Tonic of the change, so we can update your plugin’s listing with the new URL. Until the listing has been updated, new release tags won’t be picked up automatically by the Plugin Store.

## Changing the Package Name

If you need to change your plugin’s Composer package name (the `name` property in `composer.json`), follow these steps:

1. [Tag a new release](#plugin-releases) with the new package name, for _each_ of the major Craft versions your plugin has ever been compatible with. For example, if your plugin is listed in the [Craft 4 Plugin Store](https://plugins.craftcms.com/?craft4) and the [Craft 5 Plugin Store](https://plugins.craftcms.com/?craft5), you will need to tag new Craft 4 and Craft 5 versions of your plugin with the updated package name.
2. [Submit](https://packagist.org/packages/submit) your plugin as a **new** package on [Packagist](https://packagist.org/).
3. If your plugin was already listed on Packagist with its old package name, mark the old package as abandoned, and list your new package name as the recommended replacement package.
4. Contact [support@craftcms.com](mailto:support@craftcms.com) to notify Pixel & Tonic of the change, so we can update your plugin’s listing with the new package name.

## Transferring Ownership

If you need to transfer ownership of your plugin to another developer, follow these steps:

1. Visit your plugin’s GitHub repository and click on its **Settings** tab.
2. Scroll down to the bottom and press the **Transfer** button within the **Danger Zone** section, and submit the transfer form. 
3. The new developer will likely want to [change the package name](#changing-the-package-name) at this point. Once they’ve done so, remember to mark the old package name as abandoned.
4. Have the new developer contact [support@craftcms.com](mailto:support@craftcms.com) to notify Pixel & Tonic of the change, so we can transfer the plugin to their Craft Console account and update its repository URL and package name.
</file>

<file path="extend/project-config.md">
# Supporting Project Config

If your plugin has any configurable components that store settings outside of your main [plugin settings](plugin-settings.md), they may be good candidates for [project config](../system/project-config.md) support.

<Block label="Is Project Config Support Right for You?">

Before adding project config support to your component, consider the tradeoff: components that are managed via project config [should only be editable by administrators](../system/project-config.md#production-changes-reverted) in development environments.

Ask yourself:

- Can this component be managed by non-admins?
- Does it depend on anything that can be managed by non-admins?
- Would it be cumbersome to admins’ workflows if the component could only be edited in development environments?

If the answer to any of those is **yes** (now or in the foreseeable future), then it’s likely _not_ a good candidate for project config support. See the [scope](../system/project-config.md#scope) section of the main project config docs for examples of what Craft itself tracks in project config.

Plugins do not need to track _everything_ in project config for it to be worthwhile managing one or two components this way. Incremental adoption is a totally valid and encouraged approach. You may even be able to implement project config in a minor release, with no disruption to your plugin’s service APIs. We do discourage opt-in/out support of project config (i.e. a plugin setting that enables or disables project config support for one or more of its features).

::: tip
We also maintain some recommendations for effective use of project config in [teams and multi-environment systems](../deploy.md)—keep these in mind as you consider project config support.
:::

</Block>

## Project Config Theory

To add project config support to a plugin, some of your existing <abbr title="Create, Read, Update, Delete">CRUD</abbr> operations will have to be reorganized. Your existing workflow might look something like this:

- A controller populates a model with request data;
- The model is passed to a service;
- The service copies properties from the model onto a corresponding `ActiveRecord` class, then saves it (or directly writes data to a table via `Db::upsert()` or an equivalent);

Instead, we’re going to split this into two parts, and connect them via project config “events.” Our new workflow will look like this:

### Express Changes

The first step involves taking input and telling the system what changes ought to be made.

- A controller populates a model with request data;
- The model is passed to a service;
- The service [writes the model’s config data](#step-3-push-config-changes) to project config;

### Emit Events

At this point, Craft emits a [series of events](#step-1-listen-for-config-changes) to let the system know that project config values have been added, changed, or removed—but it hasn’t touched the database.

::: tip
These events are emitted _regardless_ of how a project config change occurs. In fact, they’re an essential part of how Craft is able to reconcile and synchronize state between YAML files and what is in the database. By “air-gapping” the changes to project config from changes to the database, we are able to express _intended changes_ and _actual changes_ as two discrete steps, then play the actual changes back in other environments.
:::

### Update Database

In response to those events, our only responsibility is [getting the updates into the database](#step-2-handle-config-changes).

## Implementing Project Config

Let’s take a look at how this works for saving product types in Craft Commerce. The order above represents the flow as it pertains to usage, but we’re going to walk through implementation in a slightly different order:

### Step 1: Listen for Config Changes

From your plugin’s `init()` method, use <craft5:craft\services\ProjectConfig::onAdd()>, [onUpdate()](craft5:craft\services\ProjectConfig::onUpdate()), and [onRemove()](craft5:craft\services\ProjectConfig::onRemove()) to register event handlers that are triggered when product types are added, updated, and removed from project config:

```php
public function init()
{
    parent::init();

    Craft::$app->getProjectConfig()
        ->onAdd('myplugin.productTypes.{uid}', [$this->productTypes, 'handleChangedProductType'])
        ->onUpdate('myplugin.productTypes.{uid}', [$this->productTypes, 'handleChangedProductType'])
        ->onRemove('myplugin.productTypes.{uid}', [$this->productTypes, 'handleDeletedProductType']);
}
```

The first argument is a “config path” that uses dot notation to describe where the data we’re interested in lives. The second is a [callable](https://www.php.net/manual/en/language.types.callable.php) that refers to a method of service class (in this case, Commerce’s [ProductTypes](commerce4:craft\commerce\services\ProductTypes)) mounted on the main plugin instance.

::: tip
`{uid}` is a special config path token that will match any valid UID (such as ones generated by [StringHelper::UUID()](craft5:craft\helpers\StringHelper::UUID())). When an event handler is called, if the path contained a `{uid}` token, the matching UID will be available via [ConfigEvent::$tokenMatches](craft5:craft\events\ConfigEvent::$tokenMatches).

The UID will be generated in [Step 3](#step-3-push-changes-to-the-config).
:::

### Step 2: Handle Config Changes

Now it’s time to implement the `handleChangedProductType()` and `handleDeletedProductType()` methods we’re referencing in our config event listeners. These functions are only responsible for making database changes, based on new (or removed) project config values.

```php{23,50}
use Craft;
use craft\db\Query;
use craft\events\ConfigEvent;
use craft\helpers\Db;
use craft\commerce\events\ProductTypeEvent;

// ...

public function handleChangedProductType(ConfigEvent $event)
{
    // Get the UID that was matched in the config path
    $uid = $event->tokenMatches[0];

    // Does this product type exist?
    $id = Db::idByUid('{{%plugin_producttypes}}', $uid);
    $isNew = empty($id);

    // Insert or update its row, accordingly:
    if ($isNew) {
        Db::insert('{{%plugin_producttypes}}', [
            'name' => $event->newValue['name'],
            // ...
            'uid' => $uid,
        ]);
    } else {
        Db::update('{{%plugin_producttypes}}', [
            'name' => $event->newValue['name'],
            // ...
        ], ['id' => $id]);
    }

    // Fire an 'afterSaveProductType' event?
    if ($this->hasEventHandlers('afterSaveProductType')) {
        // Load the product type so we can emit the event with a fully-hydrated model:
        $productType = $this->getProductTypeByUid($uid);

        $this->trigger('afterSaveProductType', new ProductTypeEvent([
            'productType' => $productType,
            'isNew' => $isNew,
        ]));
    }
}

public function handleDeletedProductType(ConfigEvent $event)
{
    // Get the UID that was matched in the config path:
    $uid = $event->tokenMatches[0];

    // Look up the product type by its UID:
    $productType = $this->getProductTypeByUid($uid);

    // If that came back empty, we’re done—must have already been deleted!
    if (!$productType) {
        return;
    }

    // Fire a 'beforeApplyProductTypeDelete' event:
    if ($this->hasEventHandlers('beforeApplyProductTypeDelete')) {
        $this->trigger('beforeApplyProductTypeDelete', new ProductTypeEvent([
            'productType' => $productType,
        ]));
    }

    // Delete its row:
    Db::delete('{{%plugin_producttypes}}', ['id' => $productType->id]);

    // Fire an 'afterDeleteProductType' event?
    if ($this->hasEventHandlers('afterDeleteProductType')) {
        $this->trigger('afterDeleteProductType', new ProductTypeEvent([
            'productType' => $productType,
        ]));
    }
}
```

We are able to implement this with just two methods, because the process for creating new product types and updating existing ones is almost identical—the only difference being that we explicitly set the `uid` column when creating new records. This is an essential part of how project config tracks records across environments, and it’s discussed more in the [IDs and UIDs](#ids-and-uids) section!

At this point, if product types were added or removed from project config _manually_ (say, by creating the corresponding YAML files in your `config/project/` directory, then running `php craft project-config/apply`), those changes would be synchronized with the database, and any `afterSaveProductType`, `beforeApplyProductTypeDelete`, and `afterDeleteProductType` event listeners would be triggered.

If you’d like to test what we’ve implemented so far, you can set project config data via the command line:

```bash
php craft project-config/set myPlugin.productTypes.689fcbe5-9433-4fb0-bc88-d89fdd9bb2df.name "Widgets"
```

We don’t generally recommend this as a means of manipulating project config, but it _is_ a great way to test changes in an isolated way.

#### Component Dependencies

If your component depends on other components in the system (whether or not your plugin owns them), you can ensure those components’ changes are applied _first_ by calling [ProjectConfig::processConfigChanges()](craft5:craft\services\ProjectConfig::processConfigChanges()) (or one of the [ProjectConfig](craft5:craft\helpers\ProjectConfig) helper’s shortcut methods) within your handler:

```php
Craft::$app->getProjectConfig()->processConfigChanges('productTypeGroups');
```

To illustrate this, suppose a plugin had configurable alerts for user activity. If someone created a new user group _and_ set up a notification rule in the plugin targeting that group, Craft might come to an impasse when applying those changes in another environment—suddenly, an alert references a user group that doesn’t exist yet! Project config doesn’t track when each change was made, nor what its dependencies are—so it’s your responsibility to fill in the gaps.

Keep in mind that circular dependencies can cause project config to enter an infinite loop. You may always require Craft changes are processed before your plugin’s changes, but two of your own components cannot declare one another as dependencies.

::: tip
While components can be connected in the database via their IDs, references in project config must be tracked using [UIDs](#ids-and-uids).
:::

### Step 3: Push Config Changes

Now that we have our handlers set up, it’s time to update our service methods so that they operate directly on the project config store, rather than the database. Items in the project config can be added or updated using <craft5:craft\services\ProjectConfig::set()>, and removed using [remove()](craft5:craft\services\ProjectConfig::remove()). _The keys you use when setting project config data must match your handlers from [step 1](#step-1-listen-for-config-changes), or they will not trigger, and you will be left with an inconsistent database state._

::: tip
`ProjectConfig::set()` will sort all associative arrays by their keys, recursively. If you are storing an associative array where the order of the items is important (e.g. editable table data), then you must run the array through <craft5:craft\helpers\ProjectConfig::packAssociativeArray()> before passing it to `ProjectConfig::set()`.
:::

```php{22-27,39-41}
use Craft;
use craft\helpers\Db;
use craft\helpers\StringHelper;
use craft\commerce\models\ProductType;

public function saveProductType(ProductType $productType)
{
    $isNew = empty($productType->id);

    // Ensure the product type has a UID:
    if ($isNew) {
        $productType->uid = StringHelper::UUID();
    } else if (!$productType->uid) {
        $productType->uid = Db::uidById('{{%plugin_producttypes}}', $productType->id);
    }

    // Make sure it validates:
    if (!$productType->validate()) {
        return false;
    }

    // Save it to the project config:
    $path = "myPlugin.productTypes.{$productType->uid}";

    Craft::$app->getProjectConfig()->set($path, [
        'name' => $productType->name,
        // ...
    ]);

    // Now set the ID on the product type in case the caller expects it to exist after being saved:
    if ($isNew) {
        $productType->id = Db::idByUid('{{%plugin_producttypes}}', $productType->uid);
    }

    return true;
}

public function deleteProductType(ProductType $productType)
{
    $path = "myPlugin.productTypes.{$productType->uid}";

    Craft::$app->getProjectConfig()->remove($path);
}
```

::: tip
Plugins can be made extensible themselves by adopting an [interface-oriented](services.md#interface-oriented-methods) control flow, as opposed to the [class-oriented](services.md#class-oriented-methods) control flow demonstrated above.

This may involve adding your own [events](events.md), or defining a class `interface` that other developers can adopt. [Gateways](/commerce/5.x/system/gateways.md) are an example of this, in Commerce.
:::

### IDs and UIDs

If your component references other records or built-in features (like sites, sections, entry types, etc.), those relationships must be stored in project config as UIDs instead of IDs. Project config makes extensive use of UIDs as a means of stabilizing relationships when moving between environments. In the above methods, <craft5:craft\helpers\Db::idByUid()> is used to translate between identifiers that are unique to a database or environment (IDs) and universally unique identifiers (UIDs). Suppose our product type definition included a “site” setting—we would track that relationships with foreign keys in the database, but with UIDs in project config:

::: code
```php Updating Config
use craft\helpers\Db;

$siteUid = Db::uidById('{{%sites}}', $productType->siteId);

// ...

Craft::$app->getProjectConfig()->set($path, [
    'name' => $productType->name,
    'site' => $siteUid,
    // ...
]);
```
```php Updating DB
// (Some context omitted!)

$siteId = Db::idByUid('{{%sites}}', $event->newValue['site']);

Db::update('{{%plugin_producttypes}}', [
    'name' => $event->newValue['name'],
    'siteId' => $siteId,
    // ...
], ['id' => $id]);
```
:::

::: warning
When [creating new records](#step-2-handle-config-changes) in response to project config changes, you **must** set the UID, and that value **must** come from the project config map that is being applied. In the examples so far, the UID is part of the project config “path” that our product type model definition lives within.
:::

## Migrations

You can add, update, and remove items from project config in a [migration](migrations.md). However, because migrations are run in _every_ environment, those changes may have already been made to project config in a different environment.

Consider this scenario:

1. Your plugin is updated in a development environment, which includes a new migration that makes a change to the project config.
1. The updated `composer.lock` and project config YAML files are committed to git.
1. The commit is pulled into the production environment, where Craft must now run the new plugin migration _and_ apply the changes in the project config YAML files.

When new migrations _and_ project config YAML changes are both pending, Craft runs migrations first, then applies project config changes. If your plugin migration were to set the same project config values _again_ on the secondary environment, those changes will be combined with the app’s current state (reflected by the database, not the YAML files) and written over the YAML files on disk, losing any pending changes. When Craft later checks for pending project config changes, it will not see any differences between its internal state and the clobbered YAML files.

### Schema Version

To avoid this, check your plugin’s **schema version** _in the YAML file_ before making project config changes from a migration. You can do this by passing `true` as the second argument when calling [ProjectConfig::get()](craft5:craft\services\ProjectConfig::get()):

```php
public function safeUp()
{
    // Don’t make the same config changes twice:
    $schemaVersion = Craft::$app->getProjectConfig()
        ->get('plugins.myPlugin.schemaVersion', true);

    // It’s OK to hard-code a schema version, because they’re always tied to migrations:
    if (version_compare($schemaVersion, '1.2.3', '<')) {
        // Project config changes made in this block will only be run once,
        // wherever the plugin is updated...
    }
}
```

Any time you make this sort of change, your plugin class’s [`schemaVersion` property](migrations.md) must also updated.

::: warning
Craft never forces project config changes to be applied. Code defensively, and make sure your plugin works normally _without_ relying on project config YAML changes.
:::

## Rebuilding Project Config Data

If your plugin is storing data in both the project config (i.e. global plugin settings) and elsewhere in the database (i.e. product types), you should listen to <craft5:craft\services\ProjectConfig::EVENT_REBUILD> to aid Craft in rebuilding the project config based on database-stored data, when the `php craft project-config/rebuild` command is run.

```php
use craft\events\RebuildConfigEvent;
use craft\services\ProjectConfig;
use yii\base\Event;

Event::on(
    ProjectConfig::class,
    ProjectConfig::EVENT_REBUILD,
    function(RebuildConfigEvent $e) {
        // Add plugin’s project config data...
        $productTypes = MyPlugin::getInstance()->getProductTypes()->getAllProductTypes();

        $config = [];

        foreach ($productTypes as $productType) {
            $config[$productType->uid] = $productType->getConfig();
        }

        $e->config['myPlugin']['productTypes'] = $config;
    }
);
```

## Validating Models

Craft treats project config as the authority on system state, so config must be validated _before_ committing it to the store. Beyond some basic organizational features (like when a folder is created instead of a file), the project config map does not have a schema, and makes no attempt to validate the key-value pairs set on it.

Similarly, project config handlers can (and should) only care about how to bring the database’s state into agreement with that map. Unless your plugin emits [events](events.md) when a savable component is updated, you may not even need to populate a model!

Looking back at the examples, notice that we _are_ validating a `ProductType` model [when making changes](#step-3-push-config-changes) to project config, but _not_ [when synchronizing](#step-2-handle-config-changes) project config into the database.

## Secrets and Environmental Differences

One of the benefits of project config is that secrets and other environment-specific settings can be kept out of the database and tracked files. Whenever you capture a setting or component bound for project config, make sure only the raw, un-parsed value is saved.

The best way to manage this is by attaching <craft5:craft\behaviors\EnvAttributeParserBehavior> to a model, and declaring the properties that you wish to be parsed as environment strings:

```php
use craft\base\Model;
use craft\behaviors\EnvAttributeParserBehavior;

class Webhook extends Model
{
    public ?string $targetUrl;
    public ?string $secret;
    public ?string $secretParam;

    protected function defineBehaviors(): array
    {
        return [
            'parser' => [
                'class' => EnvAttributeParserBehavior::class,
                'attributes' => [
                    'targetUrl',
                    'secret',
                ],
            ],
        ];
    }
}
```

The class property will still return the literal configured value when accessed (i.e. `$API_KEY`), so you must evaluate it at the time of use:

```php{7}
$client = \Craft::createGuzzleClient([
    'baseUri' => App::parseEnv($crm->targetUrl),
]);

$response = $client->post('', [
    'body' => [
        $webhook->secretParam => \craft\helpers\App::parseEnv($crm->secret),
        'payload' => [
            // ...
        ],
    ],
]);
```

If you would prefer this to be automatic, consider using a private property and a pair of getter/setter methods:

```php
private ?string $_secret;

public function getSecret(bool $parse = true): ?string
{
     if ($this->_secret) {
        if ($parse) {
            return \craft\helpers\App::parseEnv($this->_secret);
        }

        return $this->_secret;
    }

    return null;
}

public function setSecret(?string $secret): void
{
    $this->_secret = $secret;
}
```

::: tip
Yii helps make these methods transparent, allowing you (and other developers) to use `$webhook->secret` [as though it were a regular property](guide:concept-properties).
:::

Note that we are never memoizing or overwriting the parsed value. In situations where you need to get the raw value, you can call `getSecret(false)`—perhaps most importantly, when building the object that will get serialized into config:

```php{11}
use craft\base\Model;

class Webhook extends Model
{
    // ...

    public function getConfig(): array
    {
        return [
            'targetUrl' => $this->targetUrl,
            'secret' => $this->getSecret(false),
            'secretParam' => $this->secretParam,
        ];
    }
}
```

You would then call the `getConfig()` method on your configurable component just before [pushing it to project config](#step-3-push-config-changes):

```php
$path = "myPlugin.webhooks.{$webhook->uid}";

Craft::$app->getProjectConfig()->set($path, $webhook->getConfig());
```

### Settings UI

Settings that accept an alias or environment variable should use the autosuggest input helper:

```twig
{% from "_includes/forms" import autosuggestField %}

{{ autosuggestField({
    label: 'Secret'|t('my-plugin'),
    instructions: 'Provide a shared secret that will be sent under the `secretParam` key in the request body.'|t('my-plugin'),
    id: 'webhook-secret',
    name: 'secret',
    suggestEnvVars: true,
    value: webhook.secret,
    required: true,
    placeholder: 'https://',
    errors: webhook.getErrors('secret'),
}) }}
```

The `value` passed to the autosuggest input should always be the raw, un-parsed setting. In the getter/setter example above, this means you might need to call `webhook.getSecret(false)` to explicitly bypass parsing.
</file>

<file path="extend/queue-jobs.md">
---
description: Offloading work to a background process can improve the experience and reliability of your plugin’s functionality.
---

# Queue Jobs

Craft uses a queue for processing background tasks like updating indexes, propagating entries, and pruning revisions. You can write simple queue job classes to register your asynchronous queue tasks.

This feature relies on [Yii’s queue system](https://www.yiiframework.com/extension/yiisoft/yii2-queue/doc/guide/2.0/en/usage), to which Craft adds a [BaseJob](craft5:craft\queue\BaseJob) class for some perks:

- The ability to set a fallback description for the job.
- The ability to label and report task progress for a better user experience.

## To Queue or Not to Queue?

An ideal queue job is something slow that the a user shouldn’t have to wait on while using a site’s front end or the control panel. Multi-step processes and actions that connect with third-party APIs can be ideal candidates for queueing.

Critical tasks, however, should not necessarily be entrusted to the queue. A default Craft install will have <config5:runQueueAutomatically> enabled and be reliant on a control panel browser session to trigger the queue. This could result in queue processing delays for infrequently-accessed sites.

Similarly, failed queue jobs may pause the queue and require admin intervention. Both are worth considering as you’re contemplating whether or not to utilize a queue job for your plugin or custom module.

## Writing a Job

You can add your own queue job by first writing a class that extends <craft5:craft\queue\BaseJob> and implements `execute()`.

This example class sends an email:

```php
<?php

namespace modules\jobs;

use Craft;
use craft\mail\Message;

class MyJob extends \craft\queue\BaseJob
{
    public function execute($queue): void
    {
        $message = new Message();

        $message->setTo('to@domain.tld');
        $message->setSubject('Craft Queue Test');
        $message->setTextBody('Hello from the Craft queue worker! 👋');

        Craft::$app->getMailer()->send($message);
    }

    protected function defaultDescription(): string
    {
        return Craft::t('app', 'Sending a test email');
    }
}
```

### Updating Progress

If your job involves multiple steps, you might want to report its progress while it’s executing.

You can do this with BaseJob’s [`setProgress()`](craft5:craft\queue\BaseJob::setProgress()) method, whose arguments are:

- the queue instance
- a number between 0 and 1 representing the percent complete
- an optional, human-friendly label describing the progress

We can modify our example `execute()` method to send an email to a number of users and report the job’s progress between each send.

```php{7-14}
public function execute($queue): void
{
    $users = \craft\elements\User::find()
        ->admin(false)
        ->all();
    $totalUsers = count($users);

    foreach ($users as $i => $user) {
        $this->setProgress(
            $queue,
            $i / $totalUsers,
            Craft::t('app', '{step, number} of {total, number}', [
                'step' => $i + 1,
                'total' => $totalUsers,
            ])
        );

        $message = new Message();

        $message->setTo($user->email);
        $message->setSubject('Craft Queue Test');
        $message->setTextBody('Hello from the Craft queue worker! 👋');

        // Swallow exceptions from the mailer:
        try {
            Craft::$app->getMailer()->send($message);
        } catch (\Throwable $e) {
            Craft::warning("Something went wrong: {$e->getMessage()}", __METHOD__);
        }
    }
}
```

Depending on the number of users (or any kind of record or item) and the app’s mailer configuration, this may take longer than the queue’s allowed <abbr title="Time to reserve">TTR</abbr>. Consider [batching](#batched-jobs) jobs that act on many individual items!

### Dealing with Failed Jobs

In our first example, exceptions from the mailer can bubble out of our job—but in the second example, we catch those errors so the job is not halted prematurely.

This decision is up to you: if the work in a job is nonessential (or can be done again later without consequence, as is the case with <craft5:craft\queue\jobs\GeneratePendingTransforms>), you can catch errors, log them, and let the job exit nominally; if the work is critical (like synchronizing something to or from an external API), it may be better to let the exception bubble out of `execute()`.

The queue wraps every job in its own `try` block, and will mark any jobs that throw exceptions as _failed_. The exception message that caused the failure will be recorded along with the job. Failed jobs can be retried from the control panel or with the `php craft queue/retry [id]` command.

#### Retryable Jobs

The queue will automatically retry failed jobs that implement [`RetryableJobInterface`](https://www.yiiframework.com/extension/yiisoft/yii2-queue/doc/guide/2.0/en/retryable#retryablejobinterface). A job will only be retried after its “time to reserve” has passed—even if it didn’t use up the allowed time—and will be marked as failed once `canRetry()` returns false.

::: warning
Unconditionally returning `true` from `canRetry()` will pollute your queue with jobs that may never succeed. Failed jobs are not necessarily bad—exceptions can (and should) be thrown to track failures in code that runs unattended!
:::

### Batched Jobs

In situations where there is simply too much work to do in a single request (or within PHP’s memory limit), consider extending <craft5:craft\queue\BaseBatchedJob>.

Batched jobs’ `execute()` method is implemented for you. Instead, you must define two new methods:

- `loadData()` — Returns a class implementing <craft5:craft\base\Batchable>, like <craft5:craft\db\QueryBatcher>. Data is not necessarily _loaded_ at this point—instead, you’ll return a means of fetching data in “slices” or “pages.”
- `processItem($item)` — Your logic for handling a single item in each batch.

::: tip
<craft5:craft\db\QueryBatcher> can be passed any <craft5:craft\db\Query> subclass, including element queries. Use it to wrap queries returned from `loadData()`:

```php
use craft\db\QueryBatcher;
use craft\elements\Asset;

$query = Asset::find()
    ->volume('whitepapers')
    ->orderBy('id ASC');

return new QueryBatcher($query);
```

Also note that we’re explicitly ordering by `id`—this can help avoid skipped or double-processed items across batches when the underlying data changes (including changes made _within a job_)!
:::

Batched jobs can also define a default `$batchSize` that is appropriate for the workload. The batch size is a _maximum_ value, carried from job to job—Craft keeps track of memory usage and _may_ stop short and push a new job for the next batch. Every job maintains an `itemOffset` so they can be resumed exactly where the last one left off.

::: warning
Batched jobs **must** be pushed using <craft5:craft\helpers\Queue::push()>, or `delay` and `ttr` settings may be lost for subsequent batches.
:::

#### Batch Hooks

Special setup and cleanup actions can be defined in two pairs of methods:

| Method… | Runs… |
| --- | --- |
| `before()` | …at the very beginning of a series of batched jobs. |
| `beforeBatch()` | …prior to each batch in a series. |
| `afterBatch()` | …after each batch in a series. |
| `after()` | …at the very end of a series of batched jobs. |

`before()` and `after()` are invoked _once_ per manually-pushed batched job, whereas `beforeBatch()` and `afterBatch()` are run for _every_ slice. If all the items in a batched job are processed in a single job, it will invoke all four hooks.

## Adding Your Job to the Queue

Once you’ve created your job, add it to the queue with the helper:

```php{4}
use craft\helpers\Queue;
use mynamespace\queue\jobs\MyJob;

Queue::push(new MyJob());
```

Users and developers typically cannot (and should not need to) trigger specific jobs at-will, so it’s important that your plugin push jobs where it makes sense—typically in a [controller action](controllers.md) or [service](services.md).

### Specifying Priority

You can specify priority when pushing a job by passing an integer in a second argument:

```php
use mynamespace\queue\jobs\MyJob;

\craft\helpers\Queue::push(new MyJob(), 10);
```

The default priority is `1024`, and jobs with a lower priority are executed first.

Not all queue drivers support setting a priority; `Queue::push()` will attempt to set it and fall back to pushing without a priority if the driver throws a `NotSupportedException`.

| Queue Driver                 | Supports Priority
| ---------------------------- | -----------------
| [amqp](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/amqp/Queue.php)         | <x-mark />
| [amqp_interop](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/amqp_interop/Queue.php) | <check-mark />
| [beanstalk](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/beanstalk/Queue.php) | <check-mark />
| [db](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/db/Queue.php) | <check-mark />
| [file](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/file/Queue.php) | <x-mark />
| [gearman](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/gearman/Queue.php) | <check-mark />
| [redis](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/redis/Queue.php) | <x-mark />
| [sqs](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/sqs/Queue.php) | <x-mark />
| [stomp](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/stomp/Queue.php) | <x-mark />
| [sync](https://github.com/yiisoft/yii2-queue/tree/master/src/drivers/sync/Queue.php) | <x-mark />
</file>

<file path="extend/README.md">
---
sidebarDepth: 2
---

# Extending Craft

[Craft](../README.md) is a powerful and flexible content management system built on top of the popular PHP application framework [Yii](https://yiiframework.com/).

Yii’s [application structure](guide:structure-overview) informs much of Craft’s internal organization. You may already be familiar with some [core components](guide:structure-application-components) if you’ve made changes to the [application config](../reference/config/app.md).

A Craft extension (often referred to as a [module](#modules) or [plugin](#plugins)) can be as lean as a single class, or as complex as an embedded <abbr title="Model, View, Controller">MVC</abbr>-style application. Either way, Craft’s entire API is at your finger tips.

<See path="./generator.md" description="Jump right in by generating your first plugin or module!" />

Let’s take a moment to survey the means and motives for developing an extension.

## Fundamentals

The inspiration to extend Craft can come from _anywhere_. Our community is replete with developers who have embraced Craft’s extensibility to satisfy personal curiosity, grow professionally, provide a broader array of client services, or build first-party platform integrations.

While expanding the footprint of what you can do with Craft is a reward unto itself, many developers are able to monetize that expertise by publishing paid plugins to the official [Plugin Store](./plugin-store.md).

### The Lay of the Land

The public [Plugin Store](https://plugins.craftcms.com/) is a great place to familiarize yourself with the kinds of things extensions can do. Adding capabilities and value to your Craft projects by installing existing plugins is a huge part of what makes Craft such an accessible, powerful, and vibrant platform—but for the enterprising developer, this is just a gateway to building truly bespoke web applications.

::: tip Did you know?
The Plugin Store and Craft Console are both built with Craft!
:::

Not all extensions must be conceived as portable or publishable! In fact, the most common kinds of customization you are apt to need are more akin to configuration—altering or augmenting built-in components to suit your application or infrastructure.

### Types of Extensions

Most customizations come in the form of a **module** or a **plugin**.

::: tip
Private plugins combine the best of both worlds. If this is your first time writing an extension, we recommend using the [Generator](generator.md) to scaffold a private plugin.
:::

#### Modules

**Modules** are a great way to tightly couple extra functionality with the parent application—say, business logic that is specific to a single website or project.

Initially, this may afford you a greater sense of freedom when designing your extension:

- Instead of having intermediate [settings](environmental-settings.md) layer for consumers, you might directly reference environment variables that you know will exist in your project;
- Referencing specific field handles, sections, globals, or other resources is acceptable, because the module is versioned with the parent application’s project config;

While you will miss _some_ convenience features provided by [plugins](#plugins), modules are equally capable in almost every way.

<See path="./module-guide.md" description="Learn how to add functionality to a Craft project by creating your first module." />

#### Plugins

**Plugins** are a Craft-specific concept, so—unlike _modules_—you won’t find any mention of them in the Yii documentation. They can do everything modules can do (plugins are, in fact, modules), but are better suited for public distribution:

- They can be installed/trialed/purchased from the Craft [Plugin Store](plugin-store.md);
- They can make [database changes](migrations.md) when installed, updated, or uninstalled;
- They get their own config file and [settings](plugin-settings.md) page within the control panel, and are automatically registered with [project config](project-config.md);
- They can be enabled/disabled by an admin, without running any Composer commands;

If the thing you want to build would benefit from any of these features (or you’re unsure whether it might), make it a plugin. Just like modules, plugins can live as [part of a project](plugin-guide.md#path-repository).

<See path="./plugin-guide.md" description="Learn about the Craft plugin ecosystem." />

### Design + Approach

Extensions naturally invite technical debt—for maintainers _and_ users. This isn’t necessarily a bad thing, though! The most common manifestation is some additional friction during major version upgrades. Craft itself has enough abstractions in place to protect most developers from significant API changes (for example, Twig templates are largely compatible back to Craft 2), but as you get deeper into Craft’s API, you will need to pay special attention to deprecation notices and our dedicated [plugin upgrade guides](updating-plugins.md).

One of the most important things to consider as you set out is how you will communicate to others (your teammates, a client’s future development partners, or even your future self) where a project’s special features come from. It could be documentation or training—or nothing at all, if the scope of the extension is limited!

Craft automatically handles this for [plugins](#plugins)—from the control panel, you can see what’s currently installed and [temporarily disable](config5:disabledPlugins) one (or all) to track down problems. Registered [modules](#modules) are also disclosed in the control panel… but without understanding how they’re organized, auto-loaded, bootstrapped, or otherwise factored into the logic of your application, their purpose and specific effects may be unclear.

#### Extension Points

An extension usually leverages one or more of these concepts:

Controllers
: Provide new endpoints for [web](controllers.md) or [console](commands.md) requests.

Events
: React to, prevent, or modify default behaviors by listening to [events](events.md) or attaching [hooks](template-hooks.md).

Component Types
: Create new kinds of existing components like [element exporters](element-exporter-types.md) or [background jobs](queue-jobs.md).

Services
: Add, modify, or replace components accessible via `Craft::$app` or as part of your own extension.

Templates
: Expose functionality to [Twig](extending-twig.md) via built-in language features like functions and filters—or add your own!

::: tip
This is not an exhaustive list! Check the sidebar for more info on what aspects of Craft are extensible, or take a spin through the [topics](topics.md) page for some more ideas.
:::

These fixtures can be combined to create advanced front-end and control panel interfaces, communicate with external services, improve developer experience… or build virtually any other web- or console-based functionality.

<See path="topics.md" />

### First Steps

While the [Generator](./generator.md) has dramatically simplified the process of initializing a new extension, it’s still a good idea to get a sense for what you can do with the tools you already know.

Here are a few activities (in no particular order) that can help you get oriented with the Craft API, without treading into completely new territory:

1. In a Twig template, use the [`{% dd %}` tag](../reference/twig/tags.md#dd) to output a value or variable to the browser.  
  _What kinds of values do you see?_
1. Dive in to the `vendor/craftcms/cms/` directory and look for a familiar-sounding class.  
  _Can you find the corresponding documentation in the [class reference][class-ref]?_
1. Look at the list of common services that are available on the [`craft.app` variable](../reference/twig/global-variables.md#craft-app) in any template.  
  _Can you determine what other services are accessible in the same way?_
1. Install one of the [recommended editors](#ide) and open up a config file. Move your cursor over one of the [`use` statements](repo:craftcms/craft/blob/5.x/config/general.php#L11-L12) at the top to get information about the classes.  
  _Can you figure out how to open the file that the class is defined in?_

## Resources

Keep these learning tools in mind, as you get started!

### Links

- [**Generator**](./generator.md): Let Craft generate and wire up boilerplate components.
- [**Coding Guidelines**](./coding-guidelines.md): Keeping your own code organized will make source-diving less daunting.
- [**Class Reference**][class-ref]: Comprehensive documentation for Craft’s source code, automatically generated with every release.
- [**Craft Source**](repo:craftcms/cms): Dive into Craft’s source code.
- [**Issues + Discussions**](repo:craftcms/cms): Join the conversation about Craft’s future.

::: tip
All of our [first-party plugins](https://github.com/search?q=topic%3Acraft-plugin+org%3Acraftcms&type=Repositories&ref=advsearch&l=&l=) are published on GitHub as learning resources. Please be aware that use of a plugin is still subject to its license.
:::

### Tools

The “right” development tools can make or break your initial experience building an extension. These are only recommendations, though—the only requirement is that you are comfortable enough PHP and your development environment to debug or troubleshoot unexpected errors, as they emerge.

#### IDE

Any time you’re working with PHP, [PhpStorm](https://www.jetbrains.com/phpstorm/) (or [VS Code](https://code.visualstudio.com) with the [Intelephense](https://marketplace.visualstudio.com/items?itemName=bmewburn.vscode-intelephense-client) extension) will provide valuable insight into your (and Craft’s) code.

#### DDEV

[DDEV](https://ddev.readthedocs.io/en/stable/) is our recommended [local development tool](../install.md). Everything you need to run Craft and build extensions is neatly packaged into a consistent, container-based environment.

#### xdebug

DDEV comes [pre-configured with xdebug](https://ddev.readthedocs.io/en/stable/users/debugging-profiling/step-debugging/), and can be connected to your IDE of choice to support breakpoints and step-debugging.

#### Debug Toolbar

Yii’s built-in [debug toolbar](repo:yiisoft/yii2-debug) is invaluable, especially while troubleshooting database queries, [events](events.md), and other performance issues.

#### Composer

If your journey with Craft so far has not involved [Composer](https://getcomposer.org), certain concepts (like namespacing and auto-loading) may present additional difficulty. Consider reviewing our article on using the [starter project](kb:using-the-starter-project), and try running [updates](../update.md#composer) or installing a plugin with Composer.

::: danger
In the course of extending Craft, you will _never_ need to modify files that live in the `vendor/` directory. Changes to source files will be lost any time Composer installs or updates packages.

This documentation does not cover altering Craft’s source code, even with the intention of submitting a pull request.
:::

[class-ref]: https://docs.craftcms.com/api/v5/
</file>

<file path="extend/services.md">
---
description: Services are the clearinghouse for your plugin’s critical operations.
---

# Services

Services are [singleton](https://en.wikipedia.org/wiki/Singleton_pattern) classes that get attached to your primary plugin class as [components](guide:structure-application-components).

They have two jobs:

- They contain most of your plugin’s business logic.
- They define your plugin’s API, which it (and other plugins) can access.

For example, Craft’s field management code is located in <craft5:craft\services\Fields>, which is available at `Craft::$app->getFields()`. It has a `getFieldByHandle()` method that returns a field model by its handle. If that’s something you want to do, you can call `Craft::$app->getFields()->getFieldByHandle('my-field-handle')`.

## Service Class

Create a service class using the [generator](generator.md):

<Generator component="service" plugin="my-plugin" />

If you would prefer to start from scratch, create a `services/` subdirectory within your plugin’s `src/` directory, and a file within it named the same as the class itself. If you want to name your service class `Foo` then name the file `Foo.php`.

Open the file in your text editor and use this template as its starting point:

```php
<?php
namespace mynamespace\services;

use yii\base\Component;

class Foo extends Component
{
    // ...
}
```

Once the service class exists, you can register it as a component on your primary plugin or module class by calling [setComponents()](yii2:yii\di\ServiceLocator::setComponents()) from its [init()](yii2:yii\base\BaseObject::init()) method:

```php
public function init()
{
    parent::init();

    $this->setComponents([
        'foo' => \mynamespace\services\Foo::class,
    ]);

    // ...
}
```

Plugins also have a special [config()](craft5:craft\base\PluginInterface::config()) method you can use instead if you’d like to make your service extensible at the project level:

```php
public static function config(): array
{
    return [
        'components' => [
            'foo' => ['class' => \mynamespace\services\Foo::class],
        ],
    ];
}
```

Any component registered via the `config()` method can be customized from the project’s `config/app.php`:

```php
return [
    'components' => [
        'plugins' => [
            'pluginConfigs' => [
                'my-plugin' => [
                    'components' => [
                        'foo' => [
                            'myProperty' => 'bar',
                        ],
                    ],
                ],
            ],
        ],
    ],
];
```

## Calling Service Methods

You can access your service from anywhere in the codebase using `MyPlugin::getInstance()->serviceName`. So if your service name is `foo` and it has a method named `bar()`, you could call it like this:

```php
MyPlugin::getInstance()->foo->bar()
```

If you need to call a service method directly from your primary plugin class, you can skip `MyPlugin::getInstance()` and use `$this` instead:

```php
$this->foo->bar()
```

### Component Getters

Components set via `setComponents()` are ultimately resolved via Yii’s [service locator](yii2:yii\di\ServiceLocator::__get()), which is why it’s possible to access them as “magic” properties.

This opaque access can break some IDE’s ability to infer the correct class, so it can be helpful to provide hints in your main plugin or module class:

- Use [phpDocumentor](https://www.phpdoc.org/) tags to describe these virtual properties: `@property Foo $foo`;
- Add your own getter methods, with the correct return types;

Together, this might mean your class looks like this:

```php
namespace mynamespace;

use craft\base\Plugin;
use mynamespace\services\Foo;

/**
 * My Plugin Class
 * 
 * @property Foo $foo
 */
class MyPlugin extends BasePlugin
{
    public function init()
    {
        // ...

        $this->setComponents([
            'foo' => Foo::class,
        ]);
    }

    public function getFoo(): Foo
    {
        return $this->get('foo');
    }
}
```

## Model Operation Methods

Many service methods perform some sort of operation for a given model, such as a CRUD operation.

There are two common types of model operation methods in Craft:

1. Methods that accept a *specific model class* (e.g. <craft5:craft\services\Categories::saveGroup()>, which saves a category group represented by the given <craft5:craft\models\CategoryGroup> model). We call these **class-oriented methods**.

2. Methods that accept any class so long as it implements an *interface* (e.g. <craft5:craft\services\Fields::deleteField()>, which deletes a field represented by the given model that implements <craft5:craft\base\FieldInterface>, regardless of its actual class). We call these **interface-oriented methods**.

Both types of methods should follow the same general control flow, with one difference: interface-oriented methods should trigger callback methods on the model before and after the action is performed, giving the model a chance to run its own custom logic.

Here’s an example: <craft5:craft\services\Elements::saveElement()> will call `beforeSave()` and `afterSave()` methods on the element model before and after it saves a record of the element to the `elements` database table. Entry elements (<craft5:craft\elements\Entry>) use their `afterSave()` method as an opportunity to save a row in the entry-specific `entries` database table.

### Class-Oriented Methods

Here’s a control flow diagram for class-oriented methods:

![An example flow for a saveRecipe() method.](../images/save-component--class.png =612x1176)

::: tip
It’s only necessary to wrap the operation in a database transaction if the operation encompasses multiple database changes.
:::

Here’s a complete code example of what that looks like:

```php
public function saveRecipe(Recipe $recipe, $runValidation = true)
{
    $isNewRecipe = !$recipe->id;

    // Fire a 'beforeSaveRecipe' event
    $this->trigger(self::EVENT_BEFORE_SAVE_RECIPE, new RecipeEvent([
        'recipe' => $recipe,
        'isNew' => $isNewRecipe,
    ]));

    if ($runValidation && !$recipe->validate()) {
        \Craft::info('Recipe not saved due to validation error.', __METHOD__);
        return false;
    }

    // ... Save the recipe here ...

    // Fire an 'afterSaveRecipe' event
    $this->trigger(self::EVENT_AFTER_SAVE_RECIPE, new RecipeEvent([
        'recipe' => $recipe,
        'isNew' => $isNewRecipe,
    ]));

    return true;
}
```

### Interface-Oriented Methods

Here’s a control flow diagram for interface-oriented methods:

![An example flow for a saveIngredient() method.](../images/save-component--interface.png =660x1488)

Here’s a complete code example of what that looks like:

```php
public function saveIngredient(IngredientInterface $ingredient, $runValidation = true)
{
    /** @var Ingredient $ingredient */
    
    $isNewIngredient = !$ingredient->id;

    // Fire a 'beforeSaveIngredient' event
    $this->trigger(self::EVENT_BEFORE_SAVE_INGREDIENT, new IngredientEvent([
        'ingredient' => $ingredient,
        'isNew' => $isNewIngredient,
    ]));

    if (!$ingredient->beforeSave()) {
        return false;
    }

    if ($runValidation && !$ingredient->validate()) {
        \Craft::info('Ingredient not saved due to validation error.', __METHOD__);
        return false;
    }

    $transaction = \Craft::$app->getDb()->beginTransaction();
    try {
        // ... Save the ingredient here ...

        $ingredient->afterSave();

        $transaction->commit();
    } catch (\Exception $e) {
        $transaction->rollBack();
        throw $e;
    }

    // Fire an 'afterSaveIngredient' event
    $this->trigger(self::EVENT_AFTER_SAVE_INGREDIENT, new IngredientEvent([
        'ingredient' => $ingredient,
        'isNew' => $isNewIngredient,
    ]));

    return true;
}
```
</file>

<file path="extend/soft-deletes.md">
---
description: Make destructive actions reversible with soft-deletion.
---

# Soft Deletes

Modules and plugins can add soft delete support to their components by following this guide.

::: tip
All element types support soft deletes out of the box. See [Element Types](element-types.md#restore-action) for information on how to make them restorable.
:::

## Prepare the Database Table

Components that are soft-deletable must have a `dateDeleted` column in their database table. Rows that have a `dateDeleted` value will be considered soft-deleted.

```php
// New table migration
$this->createTable('{{%mytablename}}', [
    // other columns...
    'dateDeleted' => $this->dateTime()->null(),
]);

// Existing table migration
$this->addColumn(
    '{{%mytablename}}',
    'dateDeleted',
    $this->dateTime()->null()->after('dateUpdated')
);
```

Tables containing soft-deletable component data should not enforce any unique constraints (besides a primary key). If yours does, you’ll need to remove them.

```php
use craft\helpers\MigrationHelper;

// Stop enforcing unique handles at the database level
MigrationHelper::dropIndexIfExists('{{%mytablename}}', ['handle'], true, $this);
$this->createIndex(null, '{{%mytablename}}', ['handle'], false);
```

## Hard-Delete Rows When Their Time Is Up

Table rows that have been soft-deleted should only stick around as long as the <config5:softDeleteDuration> config setting wants them to, and then be hard-deleted.

Rather than check for stale rows on every request, we can make this a part of Craft’s [garbage collection](../system/gc.md) routines.

<craft5:craft\services\Gc> will fire a `run` event each time that it is running. You can tap into that from your module/plugin’s `init()` method.

```php
use craft\services\Gc;
use yii\base\Event;

public function init()
{
    parent::init();

    Event::on(
        Gc::class,
        Gc::EVENT_RUN,
        function() {
            Craft::$app->gc->hardDelete('{{%mytablename}}');
        }
    );
}
```

[hardDelete()](craft5:craft\services\Gc::hardDelete()) method will delete any rows with a `dateDeleted` value set to a timestamp that’s older than the <config5:softDeleteDuration> config setting.

::: tip
If you need to check multiple tables for stale rows, you can pass an array of table names into [hardDelete()](craft5:craft\services\Gc::hardDelete()) instead.
:::

## Update the Active Record Class

If the component has a corresponding [Active Record](https://www.yiiframework.com/doc/guide/2.0/en/db-active-record) class, you can add soft delete support to it by importing <craft5:craft\db\SoftDeleteTrait>:

```php
use craft\db\ActiveRecord;
use craft\db\SoftDeleteTrait;

class MyRecord extends ActiveRecord
{
    use SoftDeleteTrait;

    // ...
}
```

That trait will give your class the following features:

- [find()](craft5:craft\db\SoftDeleteTrait::find()) will only return rows that haven’t been soft-deleted (where the `dateDeleted` column is still `null`).
- A [findWithTrashed()](craft5:craft\db\SoftDeleteTrait::findWithTrashed()) static method will be added for finding rows regardless of whether they’ve been soft-deleted.
- A [findTrashed()](craft5:craft\db\SoftDeleteTrait::findTrashed()) static method will be added for finding rows that have been soft-deleted (where the `dateDeleted` column is not `null`).
- A `softDelete()` method will be added that should be called instead of [delete()](yii2:yii\db\ActiveRecord::delete()), which will update the row’s `dateDeleted` column to a current timestamp, rather than deleting the row.
- A `restore()` method will be added for restoring a soft-deleted row by removing its `dateDeleted` value.

Internally, the trait uses the [ActiveRecord Soft Delete Extension](https://github.com/yii2tech/ar-softdelete) for Yii 2, which is implemented as a [behavior](https://www.yiiframework.com/doc/guide/2.0/en/concept-behaviors).

If your class already defines its own behaviors, you will need to rename the trait’s [behaviors()](craft5:craft\db\SoftDeleteTrait::behaviors()) method on import, and manually call it from your `behaviors()` method:

```php
use craft\db\ActiveRecord;
use craft\db\SoftDeleteTrait;

class MyRecord extends ActiveRecord
{
    use SoftDeleteTrait {
        behaviors as softDeleteBehaviors;
    }

    public function behaviors(): array
    {
        $behaviors = $this->softDeleteBehaviors();
        $behaviors['myBehavior'] = MyBehavior::class;
        return $behaviors;
    }

    // ...
}
```

If your class is overriding <yii2:yii\db\ActiveRecord::find()>, you will need to add a `dateDeleted` condition to the resulting query yourself:

```php{5}
public static function find()
{
    // @var MyActiveQuery $query
    $query = Craft::createObject(MyActiveQuery::class, [static::class]);
    $query->where(['dateDeleted' => null]);
    return $query;
}
```

## Update the Rest of Your Code

Check your code for any database queries that involve your component’s table. They will need to be updated as well.

- When selecting data from your table, make sure that you’re ignoring rows with a `dateDeleted` value.

  ```php{4}
  $results = (new \craft\db\Query())
      ->select(['...'])
      ->from(['{{%mytablename}}'])
      ->where(['dateDeleted' => null])
      ->all();
  ```

- When deleting rows from your table using your Active Record class, call its new `softDelete()` method rather than [delete()](yii2:yii\db\ActiveRecord::delete()).

  ```php
  $record->softDelete();
  ```

- When deleting rows from your table using a query command, call <craft5:craft\db\Command::softDelete()> rather than [delete()](yii2:yii\db\Command::delete()).

  ```php
  \Craft::$app->db->createCommand()
      ->softDelete('{{%mytablename}}', ['id' => $id])
      ->execute();
  ```

## Restoring Soft-Deleted Rows

There are two ways to restore soft-deleted rows not yet hard-deleted by garbage collection:

1. With your Active Record class, by calling its `restore()` method.

  ```php
  $record = MyRecord::findTrashed()
      ->where(['id' => $id])
      ->one();

  $record->restore();
  ```

2. With a query command, by calling <craft5:craft\db\Command::restore()>.

  ```php
  \Craft::$app->db->createCommand()
      ->restore('{{%mytablename}}', ['id' => $id])
      ->execute();
  ```

::: tip
See [this Stack Exchange post](https://craftcms.stackexchange.com/questions/38628/how-to-make-custom-element-types-restorable) for supporting custom element restores from the control panel.
:::
</file>

<file path="extend/template-hooks.md">
---
description: Inspect template data and modify output with hooks.
---

# Template Hooks

Craft templates can give modules and plugins an opportunity to hook into them using [hook tags](../reference/twig/tags.md#hook).

```twig
{# Give plugins a chance to make changes here #}
{% hook 'my-custom-hook-name' %}
```

Plugins and modules can register methods to be called by template hooks using <craft5:craft\web\View::hook()>.

```php
Craft::$app->getView()->hook('my-custom-hook-name', function(array &$context) {
    // Modify template *context*
    $context['foo'] = 'bar';

    // Return *output*
    return '<p>Hey!</p>';
});
```

The callback method will pass a `$context` argument, which represents the current template context (all of the currently defined template variables). Any changes to this array will result in changes to the template’s variables for any tags that follow the `{% hook %}` tag.

The method can optionally return a string, which will be output where the `{% hook %}` tag is in the template.

## Control Panel Template Hooks

Your custom plugin or module can use existing template hooks to modify parts of the Craft control panel.

::: tip
Pay close attention to what you intend to modify; some hooks are provided for modifying context while others make most sense for output.
:::

| Hook                         | Description & Template
| ---------------------------- | -------------------------------------------------------------------
| `cp.elements.element`        | Base “element” template, used for rendering relational tiles.<br><small>[_elements/element.twig](repo:craftcms/cms/blob/5.x/src/templates/_elements/element.twig)</small>
| `cp.layouts.base`            | Before `doctype` declaration in base template.<br><small>[_layouts/base.twig](repo:craftcms/cms/blob/5.x/src/templates/_layouts/base.twig)</small>
| `cp.globals.edit`            | Before global set detail view’s template blocks.<br><small>[globals/_edit.twig](repo:craftcms/cms/blob/5.x/src/templates/globals/_edit.twig)</small>
| `cp.globals.edit.content`    | After global set detail view’s main content.<br><small>[globals/_edit.twig](repo:craftcms/cms/blob/5.x/src/templates/globals/_edit.twig)</small>
| `cp.users.edit.prefs`        | After fields in the user’s “Preferences” tab.<br><small>[users/_edit.twig](repo:craftcms/cms/blob/5.x/src/templates/users/_edit.twig)</small>
</file>

<file path="extend/template-roots.md">
# Template Roots

Modules and plugins can register custom “template roots” for either control panel or front-end templates.

A template root is a directory that contains templates, which are accessible to other templates from a predefined template path prefix.

For example, you could create a plugin that provides common Twig utility macros, which could be accessible from `_utils/macros.twig`.

To do that, use the [EVENT_REGISTER_SITE_TEMPLATE_ROOTS](craft5:craft\web\View::EVENT_REGISTER_SITE_TEMPLATE_ROOTS) event:

```php
use craft\events\RegisterTemplateRootsEvent;
use craft\web\View;
use yii\base\Event;

public function init()
{
    parent::init();

    Event::on(
        View::class,
        View::EVENT_REGISTER_SITE_TEMPLATE_ROOTS,
        function(RegisterTemplateRootsEvent $event) {
            $event->roots['_utils'] = __DIR__ . '/template-utils';
        }
    );
}
```

If you want to register new control panel template roots, use the [EVENT_REGISTER_CP_TEMPLATE_ROOTS](craft5:craft\web\View::EVENT_REGISTER_CP_TEMPLATE_ROOTS) event instead.

## Plugin Control Panel Templates

Plugins get a control panel template root added automatically, named after the plugin handle, which points to the `templates/` folder within the plugin’s base source folder.
</file>

<file path="extend/topics.md">
---
description: Ideas and inspiration for customizing Craft.
sidebarDepth: 2
---

# Topics

Craft is both a fully-featured content management system _and_ a powerful web application framework. Extensions allow you to build on top of its smart abstractions, or create completely new features that live alongside the main application.

This page collects some common extension vectors along that continuum.

::: tip
Pardon the mess! We just launched this page, and plan to collect more resources here as they are updated with the [generator](generator.md) in mind.

Questions? Feedback? Use the links at the bottom of any page to let us know what’s on your mind.
:::

## Monitoring and Changing Behavior

You can be notified when certain things happen within a Craft application by listening for **events** or registering **hooks**.

### Events

Events are emitted throughout Craft’s request-response and model life cycles, giving developers a chance to react to (or alter) system behavior. This is far and away the most common point of entry for extensions—if you’re looking for a way to familiarize yourself with Craft’s internals, this is it!

<See path="events.md" />

### Hooks

Hooks are similar to [events](#events), but designed specifically for manipulating the context or output of templates. In addition to hooks provided by Craft’s own [control panel templates](template-hooks.md#control-panel-template-hooks), plugins can fire their own hooks using the [`{% hook %}` tag](../reference/twig/tags.md#hook).

<See path="template-hooks.md" />

## Adding Features

While events enable a wide variety of customizations, some extensions will need to provide entirely new features.

### System Component Types

Craft’s most powerful features like elements and custom fields are built on interfaces and base classes that are also available to developers.

<See path="element-types.md" />
<See path="field-types.md" />
<See path="filesystem-types.md" />
<See path="widget-types.md" />
<See path="queue-jobs.md" />

### Miscellany

Other high-impact places to dive in.

<See path="utilities.md" />

## Working with Data

Getting data from users and processing it safely.

### Controllers + Routing

Learn about requests, routing, URL rules, responses, and Craft’s robust authorization and permissions systems.

<See path="controllers.md" />
<See path="user-permissions.md" />

### Models + Records

Extend built-in data types, define new ones, and consolidate logic.

<See path="behaviors.md" />
<See path="services.md" />
<See path="soft-deletes.md" />

### Caching

Sometimes, it can be expensive to repeatedly generate a dataset, or to block requests while waiting for a [third-party API](#using-external-services). Craft exposes a configurable [cache component](guide:caching-data) that can store temporary data in a consistent way:

```php
use Craft;

$params = [
    'productId' => 1234,
];

$key = 'my-plugin:' . md5(json_encode($params));

$value = Craft::$app->getCache()->getOrSet($key, function() {
    // Fetch remote data...

    return $data;
}, $duration);
```

Data returned from this method will be cached with `$key` for `$duration`—or, if `$key` was set within that duration, the data will be returned immediately.

::: tip
All database queries have a [cache()](yii2:yii\db\Query::cache()) method, as well.
:::

## Using External Services

Many plugins act as a bridge between Craft features and third-party services.

### Making HTTP Requests

Whenever you need to call a remote web service, use the built-in [Guzzle](http://docs.guzzlephp.org/en/latest/) factory:

```php
use Craft;

$client = Craft::createGuzzleClient([
    'base_uri' => 'https://api.acme.com/v1',
]);

$response = $client->post('/widgets', [
    'json' => [
        'style' => 'fancy',
    ],
]);
```

Creating HTTP clients this way ensures that all outgoing requests are configured the same way—Craft will apply project-specific settings from the [Guzzle config file](../configure.md#guzzle), as well as a [global `httpProxy`](../reference/config/general.md#httpproxy).

::: warning
Some third-party packages will use their own HTTP client. Whenever possible, provide the equivalent configuration to those adapters. Guzzle configuration (if any was provided) is available through the config service:

```php
// Guzzle config object:
$guzzleConfig = Craft::$app->getConfig()->getConfigFromFile('guzzle');

// HTTP proxy:
$proxyConfig = Craft::$app->getConfig()->getGeneral()->httpProxy;
```
:::

### Writing Files

Any time your application needs to generate a temporary artifact, you can write it to a file with <craft5:craft\helpers\FileHelper>:

```php
use Craft;
use craft\helpers\FileHelper;

$content = '# Todo List';

$filename = 'todos.md';
$tempDir = Craft::$app->getPath()->getTempPath();

$path = $tempDir . DIRECTORY_SEPARATOR . uniqid() . $filename;

FileHelper::writeToFile($path, $content);

// Pass $path back to another part of the application...
```

Notice that we’ve used <craft5:craft\services\Path::getTempPath()> to keep our files alongside other runtime data. This helps Craft clean up temporary data via the [Caches utility](../system/control-panel.md#utilities), or the [`clear-caches/temp-files` console command](../reference/cli.md#clear-caches-temp-files).

::: tip
[Logging](../system/logging.md) should always be done via Craft’s convenience methods, not written directly to disk.
:::

## The Control Panel

Start learning about how to create new views in the [control panel](../system/control-panel.md).

<See path="cp-section.md" />
</file>

<file path="extend/translation-categories.md">
# Translation Categories

Modules and plugins can provide custom translation categories, for use by Yii’s [Message Translations](https://www.yiiframework.com/doc/guide/2.0/en/tutorial-i18n#message-translation) feature.

::: tip
See [Static Message Translations](../system/sites.md#static-message-translations) for more details on how message translations work.
:::

Translation categories can be added programmatically by adding a new translation source onto the <yii2:yii\i18n\I18N::$translations> array.

```php
use craft\i18n\PhpMessageSource;

public function init()
{
    parent::init();

    Craft::$app->i18n->translations['my-category'] = [
        'class' => PhpMessageSource::class,
        'sourceLanguage' => 'en',
        'basePath' => __DIR__ . '/translations',
        'allowOverrides' => true,
    ];
}
```

If you have control over the [application config](../reference/config/app.md), you could also add the translation category from there:

```php
// -- config/app.php --
return [
    'components' => [
        'i18n' => [
            'translations' => [
                'my-category' => [
                    'class' => craft\i18n\PhpMessageSource::class,
                    'sourceLanguage' => 'en',
                    'basePath' => dirname(__DIR__) . '/translations',
                    'allowOverrides' => true,
                ],
            ],
        ],
    ],
];
```

## Plugin Translations

Plugins get a custom translation category registered automatically, named after the plugin handle. Plugins can provide translation files within a `translations/` folder in their base source folder.

```treeview
src/
├── Plugin.php
├── ...
└── translations/
    └── de/
        └── plugin-handle.php
```
</file>

<file path="extend/updating-plugins.md">
---
related:
  - uri: https://github.com/craftcms/rector
    label: Rector Library
  - uri: https://github.com/craftcms/phpstan
    label: PHPStan Configuration
sidebarDepth: 2
---

# Updating Plugins for Craft 5

Craft 5 brings some of the most significant author- and developer-experience improvements _ever_—and in a way that is minimally disruptive to plugins.

The [changelog](https://github.com/craftcms/cms/blob/5.x/CHANGELOG.md) is the most comprehensive and up-to-date list of added, changed, deprecated, and removed APIs. This guide focuses on high-level changes, organized by the features they impact.

::: tip
Report issues with the upgrade guide in our [`craftcms/docs` repository](https://github.com/craftcms/docs/issues/new), and issues with the upgrade itself in the [`craftcms/cms` repository](https://github.com/craftcms/cms/issues/new?labels=bug%2Ccraft5&projects=&template=BUG-REPORT-V5.yml&title=%5B5.x%5D%3A+).
:::

## Overview

Be sure and fully review this page (and the [changelog](https://github.com/craftcms/cms/blob/5.x/CHANGELOG.md)) before getting started, taking note of features that are apt to impact your plugin.

## Process

Updating a plugin for Craft 5 starts with a fully-updated Craft 4 installation. See our guide on [loading your plugin into a Craft project](plugin-guide.md#loading-your-plugin-into-a-craft-project) to get an existing plugin up-and-running.

Once your environment is set up, this is what the process will look like:

1. Run [PHPStan](#phpstan) to address any outstanding issues with the latest version of your plugin, in Craft 4.
1. Make the recommended changes, commit the results, and tag a new release on the _current_ version.
1. Run the Craft 5 [Rector ruleset](#rector) on your plugin.
1. Update the `craftcms/cms` requirement in the root Craft project _and_ in your plugin’s `composer.json` to `^5.0.0`, then run `composer update`.
1. Run `php craft up` to perform the Craft upgrade.

At this point, your project _should_ be functional again! Go ahead and kick the tires—then come back here and review changes that may impact your plugin. If the project is still failing to bootstrap, it is likely due to incompatible API changes that Rector couldn’t address on its own.

::: tip
The next few sections cover these steps (and some other procedural concerns). Skip down to [new features](#new-features) if you’re ready to dig in.
:::

### PHPStan

We use [PHPStan](https://github.com/phpstan/phpstan) on Craft CMS, Craft Commerce, and most of our first-party plugins to continually audit code quality and consistency.

While there’s no _requirement_ that you use PHPStan, we encourage all developers to join us—with the upgrade process being a perfect opportunity to integrate code quality tools into your workflow.

Follow the instructions in our [PHPStan package](https://github.com/craftcms/phpstan) to add it as a development dependency of your plugin. You should end up with a `phpstan.neon` config file in your _plugin_ repository’s root; then go back to the Craft project root, and run:

```bash
vendor/bin/phpstan -c path/to/plugin/phpstan.neon
```

::: tip
Large plugins may benefit from the `--memory-limit 1G` flag.
:::

### Rector

Our [Rector](https://github.com/craftcms/rector) rule set for Craft 5 automates most signature changes, deprecations, and other one-for-one replacements in your codebase. With your plugin running in Craft 4, follow these steps:

1. Install Rector:

    Rule-sets are not “versioned” in the traditional sense; instead, each major version is kept in a separate file. As such, its use depends on a couple of Composer settings:

    ```
    composer config minimum-stability dev
    composer config prefer-stable true
    ```

    Require the package, using the `dev-main` version constraint. The `main` branch will be cloned, and subsequent `composer update` commands will pull any changes.

    ```
    composer require craftcms/rector:dev-main --dev
    ```

1. Run the Craft 5 ruleset:

    ```
    vendor/bin/rector process my-local-plugin/src --config vendor/craftcms/rector/sets/craft-cms-50.php
    ```

    ::: warning
    Rector may make your plugin incompatible with Craft 4, which can prevent the system from initializing. This is fine! It’s safe to continue upgrading the project.
    :::

### Versioning

Craft 5 is the first major release that may not require breaking changes for all plugins. This means that plugins that don’t immediately take advantage of new features or APIs (and aren’t affected by any currently-deprecated APIs) can tag a compatibility-only “point” release.

If you are uncertain whether your plugin will use new features, we recommend tagging a new major version, and back-porting any features and bugfixes.

We anticipate most developers will choose to release a new major version of their plugin that requires Craft 5. However, Craft and the Plugin Store only look at what is required by `composer.json` to determine major-version compatibility.

Either way, you must explicitly declare support for each major Craft version. If a single version of your plugin supports both Craft 4 _and_ 5, you’ll need to use an “or” constraint for your `craftcms/cms` requirement, like `^4.0|^5.0`. Any `craftcms/cms` constraint beginning with `>=` will be treated as `^`.

::: warning
Keep in mind that all versions of PHP 7 are [end-of-life](https://www.php.net/supported-versions.php). Your plugin does _not_ need to support PHP 7 in order to be compatible with Craft 4.
:::

### Custom Modules

The upgrade process for custom modules is very similar, except that you aren’t responsible for versioning.

[Rector](#rector) and [PHPStan](#phpstan) can be installed as a direct dependency of your project, and run against the entire `modules/` directory (or wherever your custom modules live), or one module at a time.

Commit changes to your module at the same time as the rest of the Craft 5 upgrade. We recommend tracking these changes in a separate branch.

---

## New Features

Let’s start by looking at a few completely new concepts in Craft 5. There are lots of new features associated with existing functionality (like [elements](#elements) and [fields](#field-types)), which we’ll get to in a moment.

### Authentication

Multi-factor authentication is now available for control panel users. Craft ships with two `craft\auth\methods\AuthMethodInterface` implementations:

- `craft\auth\methods\RecoveryCodes`: Generates, stores, and invalidates a series of 10 one-time-use codes.
- `craft\auth\methods\TOTP`: Sets up and and validates time-based, one-time-use passwords.

Both methods extend `craft\auth\methods\BaseAuthMethod`. Registered auth methods are always instantiated in the context of a single user:

```php
use craft\events\RegisterComponentTypesEvent;
use craft\services\Auth;
use yii\base\Event;

Event::on(
    Auth::class,
    Auth::EVENT_REGISTER_METHODS,
    function(RegisterComponentTypesEvent $e) {
        $e->types[] = EmailVerification::class;
    },
);
```

Custom authorization methods are responsible for storing their own data and associating it with users—return `true` from `isActive()` once the user has completed any required setup so Craft knows to enforce it during login.

If your `verify()` method returns `true`, the user will move on to their next configured auth method—but it’s your responsibility to call `craft\services\Auth::verify()` from a controller, passing in any context required to satisfy the method.

::: tip
See `AuthMethodInterface::getAuthFormHtml()` for complete info on procedural requirements!
:::

### Bulk Operations

Whenever Craft saves an element, it starts tracking a _bulk save operation_. This allows plugins to act on the final state in a save that _may_ involve multiple elements. If you rely on element save events, consider switching to bulk ops

<See path="events.md" hash="bulk-operations" label="Bulk Saving" description="Learn how to respond to multi-element saves." />

### Enums

PHP 8.1 introduced support for [enumeration classes](https://www.php.net/manual/en/language.types.enumerations.php), so we’ve taken the opportunity to extract some constants. See the `craft\enums` namespace for examples.

::: tip
You may define your plugin’s editions this way, but the base plugin class must still return the available edition handles via a static `editions()` method.
:::

### Database Character Sets

Craft now creates database tables using the `uft8mb4` character set (and `utf8mb4_0900_ai_ci` or `utf8mb4_unicode_ci` collation, on MySQL) by default. Developers are asked during the [upgrade process](../upgrade.md#database-character-set-and-collation) to convert existing tables with inconsistent encoding, so it will generally be safe to save emoji and other multibyte characters directly to the database.

Calls to `craft\helpers\StringHelper::emojiToShortcodes($string)` and `craft\helpers\StringHelper::shortcodesToEmoji($string)` are no longer strictly necessary; if you are supporting Craft 4 and 5, consider calling `craft\db\Connection::getSupportsMb4()` to check whether you should pack and unpack strings on their way to and from the database.

### Composer

A copy of `composer.phar` is included in `craftcms/cms`, so the `composer/composer` package has been dropped as a dependency.

Craft’s internal Composer service remains unchanged. Plugins and other low-level extensions that use the Composer PHP API _directly_ must `require` it. This change does _not_ impact how your plugin is installed by an end-user!

---

## Changes

Craft 5 has a completely new content storage engine, and _a ton_ of new tools for creating rich content authoring experiences. Plugins that provide element types or field types may require some additional attention.

### Elements

#### Content Migration

If your plugin provides a custom element type, you must include a migration that extends `craft\base\BaseContentRefactorMigration`. In this migration, you are responsible for telling Craft what existing field data (or content table columns) is relevant to a given element. For each field layout that your element type uses, call `$this->updateElements()` with a list of element IDs or a query prepared to fetch the relevant IDs.

For example, if your elements use a single field layout, your migration would contain only this:

```php
$this->updateElements(
    (new Query())->from('{{%widgets}}'),
    Craft::$app->getFields()->getLayoutByType(Widget::class),
);
```

Craft will take care of applying the appropriate `SELECT` to your query. If your element’s custom table uses something other than `id` as its primary key (and `elements` table foreign key), you should pass a list of IDs instead of a query.

When multiple field layouts are represented among your elements (as is the case with Commerce’s product type configuration), you must call `$this->updateElements()` for *each* of them:

```php
foreach (MyPlugin::getInstance()->getWidgetTypes()->getAllWidgetTypes() as $type) {
    $this->updateElements(
        (new Query())
            ->from('{{%widgets}}')
            ->where(['typeId' => $type->id]),
        $type->getFieldLayout(),
    );
}
```

#### Extra Content Tables

Element types that used a custom content table (like our own Matrix implementation did) should remove their `getContentTable()` and `getFieldColumnPrefix()` methods, and remove the `$contentTable` property from their associated `ElementQuery` subclass.

The `hasContent()` method is no longer used, as there is no `content` table to conditionally join—“content” is always loaded from the `elements_sites` table along with the essential element record data.

::: tip
You should still maintain and `JOIN` any tables that contain your element type’s native properties!
:::

#### Chips & Cards

Elements’ default representation in the control panel (and *only* representation, prior to 5.0) is now known as a “chip.” We’ve added a second display mode called “cards” that support some additional features.

- `craft\helpers\Cp::elementHtml()` has been deprecated, and should be replaced with `craft\helpers\Cp::elementChipHtml($element, $config)`. Configuration of a chip is handled via a single `$config` array, the keys of which correspond to the legacy arguments’ names.
- When generating a chip for an input, you must pass the full `name` attribute, including (or omitting) the `[]` suffix for single or multiple element inputs.
- Chips no longer display a “remove” button. Use `craft\base\Element::EVENT_DEFINE_ACTION_MENU_ITEMS` to add items to the new “action menu.”
- To modify output of an element chip rendered by an element type you don’t control, listen for the `craft\helpers\Cp::EVENT_DEFINE_ELEMENT_CHIP_HTML` event, or modify individual attributes’ output via `craft\base\Element::EVENT_DEFINE_ATTRIBUTE_HTML`.
- Use the new `elementChip()` Twig function to render a chip in your control panel templates.

Both chips and cards support *thumbnails*.

- Implement the static `hasThumbs()` method on your element and return `true` to support chip and card thumbnails.
- The existing `getThumbHtml()` method is responsible for returning a custom or fixed thumbnail; you are free to omit this and allow thumbnails to be specified by users in your element type’s field layout. [Fields that implement the `ThumbableFieldInterface`](#presentation) are eligible for selection by the user.
- Previewable fields (those implementing `PreviewableFieldInterface`) may also appear in your elements’ cards.
- Use the new `elementCard()` Twig function to render a card in your control panel templates.
- The new `craft\elements\NestedElementManager` class contains logic to render lists of nested element cards.

#### Unified Element Editor

Introduced in Craft 4, the [unified element editor](/4.x/extend/updating-plugins.md#unified-element-editor) powers full-screen forms as well as slideouts. If you haven’t already, we strongly recommend adopting the unified editor for custom elements.

#### Field Layout Elements

Native attributes for users (like **Email**, **Username**, and **Full Name**) and entries (like **Authors**) are now handled with field layout elements. To provide similar flexibility for your element types, consider moving native attributes out of the sidebar.

#### Element Actions

Elements now have a dedicated “actions” menu that consolidates common functions like viewing and editing.

::: tip
Action menus are a separate concept from [element index actions](element-types.md#actions). Action menu items are only expected to operate on a single element at a time.
:::

- The schema of these action menu items must conform with the expectations of `craft\helpers\Cp::disclosureMenu()`.
- `craft\base\Element` takes care of many element-type-agnostic actions. You may return additional “safe” actions from a `safeActionMenuItems()` method, and destructive actions from a `destructiveActionMenuItems()` method. Only safe items are displayed when rendering chips.
- To add or alter actions for an element type you don’t own, listen for its `EVENT_DEFINE_ACTION_MENU_ITEMS` event. This is emitted a single time, and 
- Action menu items that rely on JavaScript should use a temporary unique ID to tie the final markup to scripts:

    ```php
    $alertId = sprintf('action-alert-title-%s', mt_rand());
    $items[] = [
        'type' => MenuItemType::Button,
        'id' => $alertId,
        'icon' => 'alert',
        'label' => Craft::t('my-plugin', 'Show {type} title', [
            'type' => static::lowerDisplayName(),
        ]),
    ];
    
    $view = Craft::$app->getView();
    $view->registerJsWithVars(fn($id, $title) => <<<JS
    $('#' + $id).on('click', () => {
      alert($title);
    });
    JS, [$alertId, $this->title]);
    ```

See `craft\enums\MenuItemType` for the allowed `type` values, and `craft\helpers\Cp::menuItem()` for information about the required properties for each. If no `type` is passed, Craft will automatically set it based on what combination of other properties are available.

#### Breadcrumbs

In addition to action menus, elements can provide custom [breadcrumbs for full-screen control panel views](#breadcrumbs-1) via the new `crumbs()` method:

```php
public function crumbs(): array
{
    $crumbs = [];
    $type = $this->getWidgetType();

    // Add root widgets source:
    $crumbs[] = [
      'label' => Craft::t('my-plugin', 'Widgets'),
      'url' => 'widgets',
    ];

    // Gather other widget types and generate a disclosure-menu-compatible list:
    $allTypes = Collection::make(Craft::$app->getEntries()->getEditableSections());
    $typeOptions = $allTypes->map(fn(WidgetType $wt) => [
        'label' => Craft::t('site', $wt->name),
        'url' => "entries/$wt->handle",
        // Is this the current type?
        'selected' => $wt->id === $type->id,
    ]);

    // Add this widget type’s source, with a switcher for other widget type indexes:
    $crumbs[] = [
        // Note that we don’t need a top-level label or URL—Craft uses the `selected` menu item!
        'menu' => [
          'label' => Craft::t('my-plugin', 'Select widget type'),
          'items' => $typeOptions,
        ],
    ];

    return $crumbs;
}
```

This example draws from our own use of breadcrumbs in entries—authors can navigate laterally to other sections from any entry’s edit screen.

::: tip
Nested elements automatically prepend their owner’s breadcrumbs.
:::

#### Nested Elements

If you’re curious how we’re using the new `craft\elements\NestedElementManager` class, check out the [Matrix field’s implementation](repo:craftcms/cms/blob/5.x/src/fields/Matrix.php), or the [CKEditor field](repo:craftcms/ckeditor)’s use of `craft\base\ElementContainerFieldInterface`.

### Field Types

Plugins that provide field types will need to make some adjustments to properly report their runtime and storage data types:

- The `hasContentColumn()` method is no longer used.
- Multi-column fields that returned an array of values from `getContentColumnType()` must rename the method to `dbType()` and make it `static`. The return value must remain unchanged.
- Single-column fields should also switch from `getContentColumnType()` to `dbType()`.
- Field types that previously returned `false` from `hasContentColumn()` must instead return `null` from the new `dbType()` method.
- Historically, `valueType()` was used to render accurate type hints in the dynamically-generated `CustomFieldBehavior`; we have renamed this method to `phpType()`, for clarity.

These changes also help support our new [field instance](../system/fields.md#multi-instance-fields) feature.

#### Multi-Instance Fields

Craft handles multi-instance fields for you, at the field layout level.

You can explicitly opt out of multi-instance support by returning `false` from a static `isMultiInstance()` method. By default, Craft treats all field types as multi-instance unless its `dbType()` method returns `null`.

#### Presentation

Field types whose content is useful in [element cards](#element-chips-cards) should implement `PreviewableFieldInterface`. In addition to determining whether the field can be displayed in element indexes, previewable fields are now eligible for inclusion in element cards when building field layouts.

::: tip
Make sure you are returning relevant markup for each context your element appears in!
:::

Similarly, implementing the `ThumbableFieldInterface` and defining a `getThumbHtml()` method makes a field eligible for use as a [chip or card](#element-chips-cards)’s thumbnail.

#### In-line Editing

Making a field [editable in-line](../system/elements.md#in-line-editing) (in an element index) involves implementing `InlineEditableFieldInterface`, which itself extends `PreviewableFieldInterface`. Not all field types are good candidates for in-line editing—particularly those with complex interfaces, multiple inputs, or that manage long values.

Craft’s `craft\base\Field` class provides baseline support for in-line editing to all subclasses, by recycling the normal `inputHtml()` output.

#### Field Icons

Choose one of the [built-in FontAwesome icons](https://fontawesome.com/search) to represent your field type by implementing the `icon()` method and returning a valid icon handle. These icons are used in the field type selection menu, and in field layout designers.

### Project Config

Changes to Project Config are now safe to make within migrations, even when `allowAdminChanges` is `false`.

When running `php craft up`, Project Config changes originating from migrations are no longer written back out to YAML if there are other pending changes. Our assumption here is that the equivalent changes were already flushed to the YAML files in a different environment, and will be considered unchanged when Craft goes to apply them.

::: tip
This means it is no longer necessary (or advisable) to compare your plugin’s current and incoming schema versions!
:::

### Entrification

Matrix blocks are now entries! The [entrification](https://craftcms.com/blog/entrification) process will conclude in Craft 6, so we recommend plugins begin offering a clean migration path for any features they provide exclusively to categories and tags.

- If your plugin uses references to categories or tags, consider making the selectable targets *entries*. When Craft entrifies category and tag groups, the element IDs stay the same (even preserving foreign keys in the database)—so in many cases, this is only a matter of changing the element type of the selection UI and updating any validation rules on your models.
- Changes to the sidebar or `meta` region of the element edit screen are often better suited as [field layout elements](#field-layout-elements). You can mark field layout elements as `mandatory` so that they will be included in field layouts even if the developer has not explicitly added them.
- Plugins that reference Matrix block “types” should be updated to operate on entry types, instead.

### Controllers

Actions that call `$this->requirePostRequest()` will now throw a `yii\web\MethodNotAllowedHttpException` with an HTTP status code of 405 if a method other than `POST` is used.

Controllers can define action menus for any control panel screen they return, by calling `CpScreenResponseBehavior::actionMenuItems()`. `CpScreenResponseBehavior::contextMenuHtml()` and `CpScreenResponseBehavior::contextMenuTemplate()` are no longer used.

#### Modals

To complement our abstraction of control panel “screens” via `craft\web\CpScreenResponseBehavior`, Craft 5 adds `craft\web\CpModalResponseBehavior` for views that target more compact modals. Modals have a similar API as screens, but with reduced scope.

Send a modal response using `$this->asCpModal()`:

```php
return $this->asCpModal()
    ->action('my-plugin/emails/send')
    ->contentTemplate('my-plugin/emails/transactional-body', $params)
    ->submitButtonLabel(Craft::t('my-plugin', 'Send'));
```

### Services

- After globalizing entry types, remaining Section-related functionality from `craft\services\Sections` has moved to `craft\services\Entries`.

### Control Panel Templates

Craft now prefers `.twig` over `.html` when loading templates rendered in the control panel. Check your plugin for templates with the same names (aside from the extension) and ensure the correct one is being rendered. This behavior is not customizable by plugins or by the project’s developer.

#### Breadcrumbs

We saw an example of how the new breadcrumbs system works, in the context of elements—but breadcrumbs are supported on any control panel screen.

In a controller, you can set and add breadcrumbs after building a response with the `asCpScreen()` method:

```php
return $this->asCpScreen()
    ->title(Craft::t('my-plugin', 'Edit {type}', ['type' => $type->name]))
    // ...
    ->crumbs([
        [
            'menu' => [
                'label' => Craft::t('my-plugin', 'Select settings screen'),
                'items' => [
                    [
                        'label' => Craft::t('my-plugin', 'Widget Types'),
                        'url' => 'settings/acme/widget-types',
                        'selected' => true,
                    ],
                    [
                        'label' => Craft::t('my-plugin', 'Security Clearances'),
                        'url' => 'settings/acme/security',
                    ],
                    [
                        'label' => Craft::t('my-plugin', 'Project Statuses'),
                        'url' => 'settings/acme/statuses',
                    ],
                ],
            ],
        ],
        [
            'menu' => [
              'label' => Craft::t('my-plugin', 'ACME Lab Settings'),
              'url' => 'settings/acme',
            ],
        ]
    ]);
```

The supported “schema” for crumbs is available on `craft\web\CpScreenResponseBehavior::crumbs()`. 

::: warning
Breadcrumbs are _not_ rendered for slideouts or modals. If you need an action or link to be available to slideouts as well, consider using `CpScreenResponseBehavior::actionMenuItems()`.
:::

#### Non-Element Tables

`Craft.VueAdminTable` has received some significant updates. Instead of passing data directly to the component via Twig, you can set a `tableDataEndpoint` to fetch the data over Ajax:

```js{14}
new Craft.VueAdminTable({
  buttons: [
    {
      label: Craft.t('my-plugins', 'New Project Status'),
      href: Craft.getCpUrl('settings/acme/statuses/new'),
      icon: 'plus',
    }
  ],
  columns: statusColumns,
  container: '#project-statuses-vue-admin-table',
  emptyMessage: Craft.t('my-plugin', 'No statuses exist yet.'),
  padded: true,
  perPage: 10,
  tableDataEndpoint: Craft.getActionUrl('acme/project-statuses'),
  search: true,
  searchPlaceholder: Craft.t('my-plugin', 'Search statuses')
});
```

Your JSON response should include two keys: `pagination` and `data`. Each item in the `data` array must have keys that correspond to the `columns` declared when setting up the `VueAdminTable` instance:

```php
use craft\helpers\AdminTable;

return $this->asSuccess(data: [
    'pagination' => AdminTable::paginationLinks($page, $total, $limit),
    'data' => [],
]);
```

Column labels and content are largely up to you, but there are a couple of handy features that make tables feel consistent. In the constructor above, `statusColumns` would look something like this:

```js
const statusColumns = [
  { name: '__slot:title', title: Craft.t('my-plugin', 'Status Label'), sortField: 'name' },
  { name: 'description', title: Craft.t('my-plugin', 'Description') },
  // ...
];
```

`__slot:title` is a special designation for the first column, which combines multiple row attributes into a familiar link-with-status-pip representation of the record. Sending `title`, `url`, `icon`, `iconColor`, and `status` keys for each row will construct visually rich previews, a la the entry types screen:

![VueAdminTable component example](../images/vue-admin-table.png "Example of a VueAdminTable component with URLs, icons, and icon colors defined in the response.")

A `sortField` key in a column should correspond with a property that your controller understands; the component automatically appends `page`, `sort`, `per_page`, and `search` params, allowing the back-end to authoritatively sort, paginate, and filter results.

::: tip
“Search” for non-element records is not natively supported, so it’s up to you to decide how to honor a search phrase, in the database.

[Client-side searching](https://github.com/craftcms/cms/pull/14126) is also supported.
:::

### Events

#### Utilities

The `craft\services\Utilities::EVENT_REGISTER_UTILITY_TYPES` constant has been renamed `EVENT_REGISTER_UTILITIES` to agree with our other uses of “component types.” Plugins that register utilities will need to listen for this new event name.

#### Element Indexes

The event constant for customizing element table attribute output has been renamed from `craft\base\Element::EVENT_SET_TABLE_ATTRIBUTE_HTML` to `EVENT_DEFINE_ATTRIBUTE_HTML`. This same event is also emitted when rendering attributes included on [element cards](#chips-cards).

#### Condition Builder

The `craft\base\conditions\BaseCondition::EVENT_REGISTER_CONDITION_RULE_TYPES` constant has been renamed to `EVENT_REGISTER_CONDITION_RULES` to agree with our other users of “component types.”

#### Mailer

The event for registering mail transport adapters has been renamed from `craft\helpers\MailerHelper::EVENT_REGISTER_MAILER_TRANSPORT_TYPES` to `EVENT_REGISTER_MAILER_TRANSPORTS`.

#### Users

The user-specific `craft\controllers\UsersController::EVENT_REGISTER_USER_ACTIONS` has been removed. Use the generic `craft\base\Element::EVENT_DEFINE_ACTION_MENU_ITEMS`, instead. See [element actions](#element-actions) above, for more information.

### Filesystems

[Asset volumes can now share filesystems](../reference/element-types/assets.md#filesystems), so long as their base paths don’t overlap. If you have any logic that assumes volumes and filesystems are mapped one-to-one, it will need to be updated to account for the possibility that multiple volumes may point to a single filesystem.

You can always get the filesystem for a volume via `craft\models\Volume::getFs()`.

## Removed

### Matrix Blocks

Matrix blocks are now [nested entries](#nested-elements). As such, most of the supporting functionality has been removed or consolidated into either `craft\base\Element` or `craft\elements\Entry`. Familiar methods like `getOwner()` are defined by `craft\base\NestedElementInterface`, while `getType()` calls are naturally handled by the new entry elements.

If you are using `craft\models\MatrixBlockType` in any type signatures, it should _probably_ be replaced by `craft\models\EntryType`. The APIs for these two models are not entirely compatible, so be aware that down-stream changes are likely necessary.

### Field Groups

By adding support for [multi-instance fields](#multi-instance-fields) and [searchable admin tables](#non-element-tables), the need for field groups is diminished. Relevant methods on the `Fields` service (as well as field group events, the database table, and any foreign keys that pointed to it) have been removed.
</file>

<file path="extend/user-permissions.md">
---
description: Register a customizable permissions scheme for your plugin’s features.
---

# User Permissions

Modules and plugins can register new [user permissions](../system/user-management.md#permissions) to the system using the [EVENT_REGISTER_PERMISSIONS](craft5:craft\services\UserPermissions::EVENT_REGISTER_PERMISSIONS) event:

```php
use craft\events\RegisterUserPermissionsEvent;
use craft\services\UserPermissions;
use yii\base\Event;

public function init()
{
    parent::init();

    Event::on(
        UserPermissions::class,
        UserPermissions::EVENT_REGISTER_PERMISSIONS,
        function(RegisterUserPermissionsEvent $event) {
            $event->permissions[] = [
                'heading' => 'Permission Group Name',
                'permissions' => [
                    'permissionName' => [
                        'label' => 'Permission Label',
                    ],
                ],
            ];
        }
    );
}
```

Permissions can also have nested permissions by adding a `nested` key to the permission array.

```php
'permissionName' => [
    'label' => 'Permission Label',
    'nested' => [
        'nestedPermissionName' => [
            'label' => 'Nested Permission Label',
        ],
    ],
];
```

::: tip
Nesting is meant for UI only; if you wanted to reference `nestedPermissionName` in the example above you would use exactly that key.
:::

## Requiring Permissions

Controllers can require that the logged-in user has a permission by calling [requirePermission()](craft5:craft\web\Controller::requirePermission()).

```php
public function actionStayUpLate()
{
    // Require the `stayUpLate` permission
    $this->requirePermission('stayUpLate');
}
```

If the user doesn’t have that permission, then a 403 error will be returned.

Templates can also ensure that the user has a permission with the [requirePermission](../reference/twig/tags.md#requirepermission) tag:

```twig
{% requirePermission 'stayUpLate' %}
```

## Checking Permissions

You can check if the logged-in user has a permission by calling <craft5:craft\web\User::checkPermission()>:

```php
// See if they have the `stayUpLate` permission
if (Craft::$app->user->checkPermission('stayUpLate')) {
    // ...
}
```

You can also see if any given user has a permission by calling <craft5:craft\elements\User::can()>:

```php
/** @var \craft\elements\User $user */
if ($user->can('stayUpLate')) {
    // ...
}
```
</file>

<file path="extend/utilities.md">
---
description: Utilities are special, non-content pages in the control panel, that provide access to back-office features or debugging data.
---

# Utilities

Plugins can provide new utilities for the [control panel](../system/control-panel.md)’s **Utilities** section by creating a class that implements <craft5:craft\base\UtilityInterface> or extends <craft5:craft\base\Utility>. A utility is typically used to surface information and controls for administrative features that aren’t tied to specific [elements](../system/elements.md). Each registered utility gets its own [permissions](#permissions).

## Utility Class

Scaffold a utility with the [generator](generator.md):

<Generator component="utility" plugin="my-plugin" />

Answer the prompts, and generator will create the required class and register it via the appropriate [events](events.md).

Alternatively, extending <craft5:craft\base\Utility> will provide all the non-essential methods—but you must still define those that identify your utility:

```php
namespace mynamespace;

use Craft;
use craft\base\Utility;

class MyUtility extends Utility
{
    public static function displayName(): string
    {
        return Craft::t('my-plugin', 'My Utility');
    }

    public static function id(): string
    {
        return 'my-utility';
    }

    public static function icon(): ?string
    {
        return Craft::getAlias('@my-plugin/icon.svg');
    }

    public static function contentHtml(): string
    {
        $view = Craft::$app->getView();

        // Gather data to pass to the template...
        $params = [
            'myOptions' => [
                // ...
            ],
        ];

        return $view->renderTemplate('_my-plugin/utilities/my-utility.twig', $params);
    }
}
```

This utility would be accessible to any user with the correct [permission](#permissions) at `/admin/utilities/my-utility` (or whatever the site’s <config5:cpTrigger> is).

::: tip
Refer to Craft’s own utility classes (located in `vendor/craftcms/cms/src/utilities/`, or the `craft\utilities` namespace) for more complete examples.
:::

### HTML

If your utility relies on any JavaScript or CSS, be sure and register the relevant [asset bundles](asset-bundles.md) in `contentHtml()`.

You may also implement static `toolbarHtml()` and `footerHtml()` methods to inject actions and metadata.

### Badges

The static [`badgeCount()`](craft5:craft\base\UtilityInterface::badgeCount()) method can be used to surface an integer in its **Utilities** screen navigation item. Craft displays the total badge counts of all registered utilities (accessible to the current user) in the main control panel menu. See the [Updates](craft5:craft\utilities\Updates), [Migrations](craft5:craft\utilities\Migrations), and [Deprecation Warnings](craft5:craft\utilities\DeprecationErrors) classes for some examples of how badges are used.

::: warning
Badge counts are calculated on every control panel request. Be mindful of your users’ experience, and cache any expensive arithmetic or database queries!

It’s also important to display a number that reflects items that are actionable for the current user. Suppose you wanted to list “stale” entries (things that hadn’t been edited in the last month)—showing a user a count across all sections (even if they didn’t have the correct [permissions](#permissions)) might continue to display a badge, even when their backlog was cleared!

```php
public static function badgeCount(): int
{
    $user = Craft::$app->getUser()->getIdentity();

    // Check the cache before querying, or set the cache for the default `cacheDuration`:
    return Craft::$app->getCache()->getOrSet("my-plugin:utility-badge-count:{$user->uid}", function() {
        return Entry::find()
            ->dateUpdated("<= {$now->modify('-1 month')->format(DateTime::ATOM)}")
            ->savable()
            ->count();
    });
}
```

Utilities are always rendered in the context of control panel user session.
:::

## Permissions

Each utility automatically gets its own [permission](user-permissions.md). Craft checks these permissions before displaying a utility in the sidebar, and when the utility’s URL is requested.

However, those permissions do _not_ have any bearing on what functionality might be accessible to a user via other means. For example, if your utility displayed a form to authorized users and allowed them to download a specialized report of some kind, the [controller](controllers.md) or action that ultimately generates the report must also check the appropriate permissions. In general, those permissions should be discrete: an administrator would grant users access to the utility _and_ a _Modify Widgets_ permission that your plugin explicitly defines (and checks in the appropriate controller action).

## Registering your Utility

Once you have created your utility class, you will need to register it with the [Utilities](craft5:craft\services\Utilities) service, so Craft will know about it when populating the list of available utility types:

```php
<?php
namespace mynamespace\myplugin;

use craft\base\Plugin as BasePlugin;
use craft\events\RegisterComponentTypesEvent;
use craft\services\Utilities;
use yii\base\Event;

class Plugin extends BasePlugin
{
    public function init()
    {
        Event::on(
            Utilities::class,
            Utilities::EVENT_REGISTER_UTILITIES,
            function(RegisterComponentTypesEvent $event) {
                $event->types[] = MyUtility::class;
            }
        );

        // ...
    }

    // ...
}
```

::: tip
Registering your utility doesn’t mean it will automatically appear for users! You must also grant the appropriate [permissions](#permissions).
:::
</file>

<file path="extend/widget-types.md">
---
description: Create customizable, heads-up resources for control panel users.
---

# Widget Types

Plugins can provide custom widget types for the [control panel dashboard](../control-panel.md#dashboard) by creating a class that implements <craft5:craft\base\WidgetInterface> and <craft5:craft\base\WidgetTrait>. The class will serve both as a way to communicate various things about your widget type (with static methods), and as a model that widgets of its type will be instantiated with.

Each user controls what widgets are on their dashboard, and may have multiple instances of a single widget type—meaning widget [settings](#settings) can give a single widget type a great deal of flexibility.

## Widget Class

Scaffold a widget type with the [generator](generator.md):

<Generator component="widget-type" plugin="my-plugin" />

If you would prefer to write a widget class from scratch, it should extend <craft5:craft\base\Widget>. Refer to Craft’s own widget classes (located in `vendor/craftcms/cms/src/widgets/`, or the `craft\widgets` namespace) for examples.

## Registering Custom Widget Types

Once you have created your widget class, you will need to register it with the Dashboard service, so Craft will know about it when populating the list of available widget types. Generator will add this code, for you.

```php
<?php
namespace mynamespace;

use craft\events\RegisterComponentTypesEvent;
use craft\services\Dashboard;
use yii\base\Event;

class Plugin extends \craft\base\Plugin
{
    public function init()
    {
        Event::on(
            Dashboard::class,
            Dashboard::EVENT_REGISTER_WIDGET_TYPES,
            function(RegisterComponentTypesEvent $event) {
                $event->types[] = MyWidget::class;
            }
        );

        // ...
    }

    // ...
}
```

## Content

A widget’s content is determined by its `getBodyHtml()` method. This example renders a Twig template, but you can generate the HTML however you like:

```php
public function getBodyHtml(): ?string
{
    return Craft::$app->getView()->renderTemplate('my-plugin/_widgets/my-widget', [
        'local' => 'Variables!',
    ]);
}
```

### JavaScript + CSS

If the widget depends on JavaScript or CSS, you must register the appropriate [asset bundles](asset-bundles.md) from this method, as well.

Each widget is rendered inside a HTML element with an `id` attribute like `widget1`, `widget2`, `widget42`, and so on, where the number is the widget’s `id` in the database. To tie JavaScript logic to each instance of your widget, consider separating its implementation from initialization:

::: code
```js Asset Bundle
(function() {
    Craft.MyWidget = Garnish.Base.extend({
        $widget: null,
        init: function(id) {
            this.$widget = document.getElementById('widget' + id);

            // ...
        },
    });
})()
```
```php Widget Class
Craft::$app->getView()->registerAssetBundle(MyAsset::class);
Craft::$app->getView()->registerJs("new Craft.MyWidget({$this->id});");
```
:::

Here, we’ve parameterized the `Craft.MyWidget` JavaScript object so it can be instantiated multiple times, each with a unique `id` argument. The `init()` function takes care of building the complete HTML ID, looking it up in the DOM, and storing it on that instance.

## Settings

Your widget’s `getSettingsHtml()` method should return a snippet that includes input elements with `name` attributes matching its public properties. Whenever a user creates or updates a widget, Craft will assign those values, save the widget to the database, and re-render it.

::: tip
If you elect to _not_ implement `getSettingsHtml()`, your widget will display a photo of Brad Bell.
:::

### Validation

As with other [Model](craft5:craft\base\Model)s, widgets can declare [validation rules](guide:tutorial-core-validators) by implementing a `defineRules()` method. Validation rules ensure your widget is always configured in a useful way.
</file>

<file path="reference/config/bootstrap.md">
---
description: Customize your project’s directory structure and other low-level behaviors.
related:
  - uri: ../../configure.md
    label: Configuring Craft
---

# Bootstrap Variables

These variables can be set via your environment or as PHP constants in your [entry scripts](../../configure.md#entry-script). Read more about how to use bootstrap variables on the [configuration](../../configure.md#bootstrap-config) page.

<!-- more -->

<See path="../../configure" label="Configuring Craft" description="Learn about all the ways to customize Craft." />

## `CRAFT_BASE_PATH`

The path to the **base directory** that Craft will look for [config/](../../system/directory-structure.md#config), [templates/](../../system/directory-structure.md#templates), and other directories within by default. (It is assumed to be the parent of the `vendor/` folder by default.)

```php
// Tell Craft to look for config/, templates/, etc., two levels up from here
define('CRAFT_BASE_PATH', dirname(__DIR__, 2));
```

## `CRAFT_COMPOSER_PATH`

The path to the [composer.json](../../system/directory-structure.md#composer-json) file. (It is assumed to live within the base directory by default.)

```php
define('CRAFT_COMPOSER_PATH', 'path/to/composer.json');
```

## `CRAFT_CONFIG_PATH`

The path to the [config/](../../system/directory-structure.md#config) folder. (It is assumed to live within the base directory by default.)

## `CRAFT_CONTENT_MIGRATIONS_PATH`

The path to the [migrations/](../../system/directory-structure.md#migrations) folder used to store content migrations. (It is assumed to live within the base directory by default.)

## `CRAFT_CP`

Dictates whether the current request should be treated as a control panel request.

```php
// Tell Craft that this is a control panel request
define('CRAFT_CP', true);
```

If this isn’t defined, Craft will treat the request as a control panel request if either of these are true:

- The <config5:baseCpUrl> setting **is** set, and the request URL begins with it (plus the <config5:cpTrigger> setting, if set).
- The <config5:baseCpUrl> setting **is not** set, and the request URI begins with the <config5:cpTrigger> setting.

## `CRAFT_DOTENV_PATH`

Path to your project’s [`.env` file](../../system/directory-structure.md#env), including the filename. Defaults to `.env`, within [CRAFT_BASE_PATH](#craft-base-path).

## `CRAFT_EDITION` <Since ver="5.2.0" feature="The CRAFT_EDITION bootstrap variable" />

Craft’s active edition is typically set via [project config](../../system/project-config.md), but you can override it for testing with a valid edition from <craft5:craft\enums\CmsEdition>.

::: warning
It is possible to enable Craft editions that are not allowed by your current license. This means that you may see warnings in the control panel on public domains.
:::

## `CRAFT_ENVIRONMENT`

The environment name that [multi-environment configs](../../configure.md#multi-environment-configs) can reference when defining their environment-specific config arrays.

## `CRAFT_EPHEMERAL`

When set to `true`, Craft will skip file system permission checks and operations that are not available in an environment with ephemeral or read-only storage.

## `CRAFT_LICENSE_KEY`

Your Craft license key, if for some reason that must be defined by PHP rather than a license key file. (Don’t set this until you have a valid license key.)

```php
// Tell Craft to get its license key from a `LICENSE_KEY` environment variable
define('CRAFT_LICENSE_KEY', craft\helpers\App::env('LICENSE_KEY'));
```

## `CRAFT_LICENSE_KEY_PATH`

The path that Craft should store its license key file, including its filename. (It will be stored as `license.key` within your [config/](../../system/directory-structure.md#config) folder by default.)

## `CRAFT_LOG_ALLOW_LINE_BREAKS`

Adjusts the default [log target config](../../system/logging.md#monolog) to allow or disallow multi-line log statements.

## `CRAFT_LOG_PHP_ERRORS`

Can be set to `false` to prevent Craft from setting PHP’s [log_errors](https://php.net/manual/en/errorfunc.configuration.php#ini.log-errors) and [error_log](https://php.net/manual/en/errorfunc.configuration.php#ini.error-log) settings, leaving it up to whatever’s set in `php.ini`.

```php
// Don’t send PHP error logs to storage/logs/phperrors.log
define('CRAFT_LOG_PHP_ERRORS', false);
```

## `CRAFT_REBRAND_PATH` <Since ver="5.2.0" feature="The CRAFT_REBRAND_PATH bootstrap variable" />

Override the path where the [control panel](../../system/control-panel.md)’s **Login Page Logo** and **Site Icon** are stored, when uploaded via <Journey path="Settings, General" />. By default, they live in Craft’s `storage/` directory, which is typically excluded from version control.

```php
// Use a top-level `rebrand/` directory for the site logo + icon:
define('CRAFT_REBRAND_PATH', '@root/rebrand');
```

::: tip
Unlike other `*_PATH` settings, `CRAFT_REBRAND_PATH`’s value can include an [alias or other environment variable](../../configure.md#aliases-and-environment-variables) because it is only resolved after the application is fully initialized.
:::

## `CRAFT_SECRETS_PATH`

The path to a [secrets](../../configure.md#secrets) file, whose values are _not_ loaded into the environment.

```php
// Check the `secrets.php` file next to this script for sensitive values:
define('CRAFT_SECRETS_PATH', dirname(__DIR__) . 'secrets.php');
```

## `CRAFT_SITE`

The Site handle or ID that Craft should be serving from this `index.php` file. (Only set this if you have a good reason to. Craft will automatically serve the correct site by inspecting the requested URL, unless this is set.)

```php
// Show the German site
define('CRAFT_SITE', 'de');
```

## `CRAFT_STORAGE_PATH`

The path to the [storage/](../../system/directory-structure.md#storage) folder. (It is assumed to live within the base directory by default.)

::: tip
Make sure you set this to a valid folder path, otherwise it will be ignored.
:::

## `CRAFT_STREAM_LOG`

When set to `true`, Craft will send log output to `stderr` and `stdout`, instead of to log files. PHP fatal errors will be sent to `stderr`.

## `CRAFT_TEMPLATES_PATH`

The path to the [templates/](../../system/directory-structure.md#templates) folder. (It is assumed to live within the base directory by default.)

## `CRAFT_TRANSLATIONS_PATH`

The path to the `translations/` folder. (It is assumed to live within the base directory by default.)

## `CRAFT_VENDOR_PATH`

The path to the [vendor/](../../system/directory-structure.md#vendor) folder. (It is assumed to live 4 directories up from the bootstrap script by default.)

## `CRAFT_WEB_URL`

Automatically sets the `@web` [alias](../../configure.md#aliases).

## `CRAFT_WEB_ROOT`

Automatically sets the `@webroot` [alias](../../configure.md#aliases).
</file>

<file path="reference/config/db.md">
---
containsGeneratedContent: yes
sidebarLevel: 3
description: Craft supports a wide array of connection settings for MySQL and Postgres databases.
related:
  - uri: ../../configure.md
    label: Configuring Craft
  - uri: ../../system/directory-structure.md
    label: Directory Structure
---

# Database Connection Settings

Craft can connect to MySQL and Postgres databases.

<!-- more -->

Database connection settings may be set from a `config/db.php` file, but because they’re often entirely environment-specific, Craft supports assigning [directly from environment variables](../../configure.md#environment-overrides). In [a new Craft 5 project](repo:craftcms/craft), your `.env` file will need to define these options:

```bash
# Required variables:
CRAFT_APP_ID=
CRAFT_ENVIRONMENT=dev
CRAFT_SECURITY_KEY=

# Database-specific variables:
CRAFT_DB_DRIVER=mysql
CRAFT_DB_SERVER=127.0.0.1
CRAFT_DB_PORT=3306
CRAFT_DB_DATABASE=
CRAFT_DB_USER=root
CRAFT_DB_PASSWORD=
CRAFT_DB_SCHEMA=public
CRAFT_DB_TABLE_PREFIX=
```

We recommend this approach because it:

1. Keeps sensitive information out of your project’s codebase (`.env` files should never be shared or committed to version control);
2. Makes collaborating with other developers easier, as each developer can define their own settings from scratch, without overwriting someone else’s settings.

::: tip
Environment overrides are covered in greater detail on the [configuration overview page](../../configure.md#environment-overrides).
:::

If you need to use your own environment variables in a config file (or connection details are provided via platform-specific keys), create `config/db.php` and return an explicit array of settings:

```php
use craft\helpers\App;

return [
    'driver' => App::env('MY_DB_DRIVER'),
    'server' => App::env('MY_DB_SERVER'),
    'port' => App::env('MY_DB_PORT'),
    'database' => App::env('MY_DB_DATABASE'),
    'user' => App::env('MY_DB_USER'),
    'password' => App::env('MY_DB_PASSWORD'),
    'schema' => App::env('MY_DB_SCHEMA'),
    'tablePrefix' => App::env('MY_DB_TABLE_PREFIX'),
    'attributes' => [
        PDO::MYSQL_ATTR_SSL_CA => '/path/to/my.crt.pem'
        // ...
    ],
];
```

::: warning
Finer-grain control of Craft’s database connection is possible by configuring the underlying [`db` application component](app.md#database). This may be necessary if you have specific security requirements, or your app needs to connect to multiple databases.

Note that if you need to supply custom PDO attributes to your primary database connection, you should do so via the `attributes` key in your `config/db.php` file, not from `config/app.php` while overriding the `db` component.
:::

## Supported Settings

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/config-db.md)!!!
</file>

<file path="reference/config/general.md">
---
description: Learn about configuration options available via Craft’s general.php file.
containsGeneratedContent: yes
related:
  - uri: ../../configure.md
    label: Configuring Craft
---

# General Settings

This group of settings affects a wide variety of Craft’s features and behaviors. If you are uncertain about whether something is configurable or not, refer to the categories in the table of contents.

<!-- more -->

General settings go in `config/general.php`. The config file that ships with [new Craft projects](https://github.com/craftcms/craft/blob/5.x/config/general.php) looks like this:

```php
use craft\config\GeneralConfig;
use craft\helpers\App;

return GeneralConfig::create()
    ->defaultWeekStartDay(1)
    ->omitScriptNameInUrls()
    ->preloadSingles()
    ->preventUserEnumeration()
    ->aliases([
        '@webroot' => dirname(__DIR__) . '/web',
    ])
;
```

A `general.php` config file is not mandatory; omitting it from your project (or including one but not explicitly configuring a setting) will use Craft’s defaults. The list below describes the default values for each setting.

::: tip
There are a number of [ways to provide configuration](../../configure.md). This file uses the new “[fluent](../../configure.md#style)” syntax, and contains references to [environment variables](../../configure.md#env) for settings that may change between environments.
:::

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/config-general.md)!!!
</file>

<file path="reference/config/README.md">
# Configuration Reference

These pages contain comprehensive reference for Craft’s configuration files:

<See path="general.md" />
<See path="db.md" />

Additional sections cover abstract configuration schemes:

<See path="app.md" />
<See path="bootstrap.md" />
</file>

<file path="reference/element-types/addresses.md">
---
description: Store flexible, globally-aware location information.
related:
  - uri: ../../system/elements.md
    label: Introduction to Elements
  - uri: /commerce/4.x/addresses.md
    label: Using addresses in Craft Commerce
  - uri: ../controller-actions.md
    label: Controller Actions Reference
  - uri: ../field-types/addresses.md
    label: Addresses Fields
containsGeneratedContent: yes
---

# Addresses

Addresses are a type of [element](../../system/elements.md) you’ll most commonly encounter in conjunction with [Users](users.md). [Querying addresses](#querying-addresses) and working with their [field data](#fields-and-formatting) is nearly identical to the experience working with any other element type.

<!-- more -->

For sites supporting [public registration](../../system/user-management.md#public-registration) (like a storefront built on [Craft Commerce](/commerce/5.x/)) users can manage their own [address book](#managing-addresses).

::: tip
Plugins are also able to use addresses to store their own location data.
:::

## Setup

Address elements share a single field layout, which is managed in the control panel via <Journey path="Settings, Addresses" />.

<BrowserShot url="https://my-project.ddev.site/admin/settings/addresses" :link="false">
<img src="../../images/address-field-layout.png" alt="Screenshot of the address element field layout" />
</BrowserShot>

### Native and Custom Fields

The address field layout has additional native (but optional) fields for a handful of useful attributes. Addresses—just like other element types—support custom fields for anything else you might need to store.

For compatibility and localization, core address components (aside from the Country Code) can’t be separated from one another in the field layout.

### Config Options

You may set a default country for new addresses via the <config5:defaultCountryCode> setting.

### Copying Addresses <Since ver="5.7.0" feature="Copying addresses" />

Addresses can be copied and pasted between users and [addresses fields](../field-types/addresses.md).

<See path="../../system/elements.md" hash="copying-elements" label="Copying Elements" description="Learn how to copy addresses and other elements between contexts." />

## Address Repository

The [commerceguys/addressing](repo:commerceguys/addressing) library powers planet-friendly address handling and formatting, and its exhaustive repository of global address information is available to all Craft projects. If you need a list of countries, states, or provinces, for example, you can fetch them via Craft’s [Addresses](craft5:craft\services\Addresses) service, from Twig templates or PHP:

::: code
```twig
{% set countries = craft.app.getAddresses().getCountryRepository().getAll() %}
```
```php
$countries = Craft::$app->getAddresses()->getCountryRepository()->getAll();
```
:::

This returns an array of [Country](repo:commerceguys/addressing/blob/master/src/Country/Country.php) objects, indexed by their two-letter code. You might use this to populate a dropdown menu:

```twig
<select name="myCountry">
  {% for code, country in countries %}
    <option value="{{ code }}">{{ country.name }}</option>
  {% endfor %}
</select>

{# Output:
<select name="myCountry">
  <option value="AF">Afghanistan</option>
  <option value="AX">Åland Islands</option>
  ...
</select>
#}
```

Similarly, a repository of subdivisions are available, hierarchically—with up to three levels, depending on how a given country is organized: _Administrative Area_ → _Locality_ → _Dependent Locality_.

Expanding upon our previous example, we could output a nicely organized list of “administrative areas,” like this:

```twig
{% set subdivisionRepo = craft.app.getAddresses().getSubdivisionRepository() %}
{% set countriesWithSubdivisions = countries | filter(c => subdivisionRepo.getAll([c.countryCode]) | length) %}

<select name="administrativeArea">
  {% for country in countriesWithSubdivisions %}
    {% set administrativeAreas = subdivisionRepo.getAll([country.countryCode]) %}

    <optgroup label="{{ country.name }}">
      {% for a in administrativeAreas %}
        <option value="{{ a.code }}">{{ a.name }}</option>
      {% endfor %}
    </optgroup>
  {% endfor %}
</select>
```

Either repository’s `getList()` method is a shortcut that returns only key-value pairs, suitable for our examples—it also accepts an array of “parent” groups (beginning with country code) to narrow the subdivisions.

::: tip
These designations are deliberately generic, and won’t generally be recognized by users. Check out the [labels](#attribute-labels) section for information on how to output localized or context-aware names for each level (i.e. _Provinces_ in Canada or _States_ and _Counties_ in the United States).
:::

You may supplement the subdivision data provided by the [upstream repository](https://github.com/commerceguys/addressing) by listening to the <craft5:craft\services\Addresses::EVENT_DEFINE_ADDRESS_SUBDIVISIONS> event in a plugin or module. Similarly, deeper customization of the required [fields](#fields-and-formatting) (and those fields’ [labels](#attribute-labels)) may require modifying the defaults via the [EVENT_DEFINE_USED_SUBDIVISION_FIELDS](craft5:craft\services\Addresses::EVENT_DEFINE_USED_SUBDIVISION_FIELDS) or [EVENT_DEFINE_FIELD_LABEL](craft5:craft\services\Addresses::EVENT_DEFINE_FIELD_LABEL) events.

::: tip
Check out the [addressing docs](https://github.com/commerceguys/addressing#data-model) for more details and examples of what’s possible—including translation of place names, postal codes, timezones, and [formatting](#fields-and-formatting)!
:::

## Fields and Formatting

### Field Handles

Individual fields—native and custom—are accessed via their handles, like any other element:

```twig
<ul>
  <li>Name: {{ myAddress.title }}</li>
  <li>Postal Code: {{ myAddress.postalCode }}</li>
  <li>Custom Label Color: {{ myAddress.myCustomColorFieldHandle }}</li>
</ul>
```

### Attribute Labels

The addressing library’s abstracted _Administrative Area_ → _Locality_ → _Dependent Locality_ terminology probably isn’t what you are accustomed to calling those address components in your part of the world—and it’s even less likely you’d want to show those terms to site visitors.

You can use any address element’s `attributeLabel()` method to get human-friendly labels for a given locale. Assuming we’re working with a U.S. address…

```twig
{{ myAddress.attributeLabel('administrativeArea') }} {# State #}
{{ myAddress.attributeLabel('locality') }} {# City #}
{{ myAddress.attributeLabel('dependentLocality') }} {# Suburb #}
{{ myAddress.attributeLabel('postalCode') }} {# Zip Code #}
```

Labels use the address’s current `countryCode` value for localization.

### `|address` Formatter

You can use the [`|address`](../twig/filters.md#address) filter to output a formatted address with basic HTML:

```twig
{{ myAddress|address }}
{# Output:
  <p translate="no">
    <span class="address-line1">1234 Balboa Towers Circle</span><br>
    <span class="locality">Los Angeles</span>, <span class="administrative-area">CA</span> <span class="postal-code">92662</span><br>
    <span class="country">United States</span>
  </p>
#}
```

The default formatter includes the following options:

- **locale** – defaults to `'en'`
- **html** – defaults to `true`; disable with `false` to maintain line breaks but omit HTML tags
- **html_tag** – defaults to `p`
- **html_attributes** – is an array that defaults to `['translate' => 'no']`

```twig
{# Swap enclosing paragraph tag for a `div`: #}
{{ myAddress|address({ html_tag: 'div' }) }}
{# Output:
  <div translate="no">
    <span class="address-line1">1234 Balboa Towers Circle</span><br>
    <span class="locality">Los Angeles</span>, <span class="administrative-area">CA</span> <span class="postal-code">92662</span><br>
    <span class="country">United States</span>
  </div>
#}

{# Turn the entire address into a Google Maps link: #}
{{ myAddress|address({
  html_tag: 'a',
  html_attributes: {
    href: url('https://maps.google.com/maps/search/', {
      query_place_id: address.myCustomPlaceIdField,
    }),
  },
}) }}
{# Output:
  <a href="https://maps.google.com/maps/search/?query_place_id=...">
    <span class="address-line1">1234 Balboa Towers Circle</span><br>
    <span class="locality">Los Angeles</span>, <span class="administrative-area">CA</span> <span class="postal-code">92662</span><br>
    <span class="country">United States</span>
  </a>
#}

{# Omit all HTML tags: #}
{{ myAddress|address({ html: false }) }}
{# Output:
  1234 Balboa Towers Circle
  Los Angeles, CA 92662
  United States
#}

{# Force output in the Ukrainian (`uk`) locale: #}
{{ myAddress|address({ html: false, locale: 'uk' }) }}
{# Output:
  1234 Balboa Towers Circle
  Los Angeles, CA 92662
  Сполучені Штати
#}
```

#### Country Names

Only the two-letter “country code” is stored on addresses. To display the full country name, use the attached [`Country`](repo:commerceguys/addressing/blob/master/src/Country/Country.php) model: <Since ver="5.3.0" feature="Address.getCountry()" />

```twig
{% set country = address.country %}

{{ country.name }}
```

Via the `Country` object, you also have access to the following data:

- `countryCode` — Same ISO 3166-1 alpha-2 code as was stored as `address.countryCode`.
- `name` — Name of the country, localized for the current site.
- `threeLetterCode` — ISO 3166-1 alpha-3 code for the country.
- `numericalCode` — ISO ISO 3166-1 numeric codes.
- `currencyCode` — ISO 4217 currency code (not the symbol).
- `timezones` — A list of PHP timezone identifiers for the country. This is not necessarily specific to the address!
- `locale` — The locale the country name is localized for. Defaults to the app’s current language, which might be a site’s language or a control panel user’s language preference. If you need to manually localize a country’s name, see below.

In earlier versions of Craft, you must directly retrieve its definition from the [address repository](#address-repository):

```twig
{% set country = craft.app.getAddresses().getCountryRepository().get(address.countryCode) %}

{{ country.name }}
```

To get the localized name of a country outside of a formatted address, you must re-fetch it from the address repository:

```twig{2}
{% set repo = craft.app.addresses.getCountryRepository() %}
{% set country = repo.get(entry.country, currentSite.locale) %}

{{ country.name }}
{# -> In a site set to use US English (en-US): "United States" #}
{# -> In a site set to use Swiss French (fr-CH): "États-Unis" #}
```

### Customizing the Formatter

You can also pass your own formatter to the `|address` filter. The addressing library includes [PostalLabelFormatter](https://github.com/commerceguys/addressing/blob/master/src/Formatter/PostalLabelFormatter.php) to make it easier to print shipping labels. Here, we can specify that formatter and set its additional `origin_country` option:

```twig
{# Use the postal label formatter #}
{% set addressService = craft.app.getAddresses() %}
{% set labelFormatter = create(
  'CommerceGuys\\Addressing\\Formatter\\PostalLabelFormatter',
  [
    addressService.getAddressFormatRepository(),
    addressService.getCountryRepository(),
    addressService.getSubdivisionRepository(),
  ]) %}
{{ addr|address({ origin_country: 'GB' }, labelFormatter) }}
{# Output:
  1234 Balboa Towers Circle
  LOS ANGELES, CA 92662
  UNITED STATES
#}
```

You can also write a custom formatter that implements [FormatterInterface](https://github.com/commerceguys/addressing/blob/master/src/Formatter/FormatterInterface.php). We could extend the default formatter, for example, to add a `hide_countries` option that avoids printing the names of specified countries:

```php
<?php

namespace mynamespace;

use CommerceGuys\Addressing\AddressInterface;
use CommerceGuys\Addressing\Formatter\DefaultFormatter;
use CommerceGuys\Addressing\Locale;
use craft\helpers\Html;

class OptionalCountryFormatter extends DefaultFormatter
{
    /**
     * @inheritdoc
     */
    protected $defaultOptions = [
        'locale' => 'en',
        'html' => true,
        'html_tag' => 'p',
        'html_attributes' => ['translate' => 'no'],
        'hide_countries' => [],
    ];

    /**
     * @inheritdoc
     */
    public function format(AddressInterface $address, array $options = []): string
    {
        $this->validateOptions($options);
        $options = array_replace($this->defaultOptions, $options);
        $countryCode = $address->getCountryCode();
        $addressFormat = $this->addressFormatRepository->get($countryCode);

        if (!in_array($countryCode, $options['hide_countries'])) {
            if (Locale::matchCandidates($addressFormat->getLocale(), $address->getLocale())) {
                $formatString = '%country' . "\n" . $addressFormat->getLocalFormat();
            } else {
                $formatString = $addressFormat->getFormat() . "\n" . '%country';
            }
        } else {
            // If this is in our `hide_countries` list, omit the country
            $formatString = $addressFormat->getFormat();
        }

        $view = $this->buildView($address, $addressFormat, $options);
        $view = $this->renderView($view);
        $replacements = [];

        foreach ($view as $key => $element) {
            $replacements['%' . $key] = $element;
        }

        $output = strtr($formatString, $replacements);
        $output = $this->cleanupOutput($output);

        if (!empty($options['html'])) {
            $output = nl2br($output, false);

            // Add the HTML wrapper element with Craft’s HTML helper:
            $output = Html::tag($options['html_tag'], $output, $options['html_attributes']);
        }

        return $output;
    }
}
```

We can instantiate and use that just like the postal label formatter:

```twig
{# Use our custom formatter #}
{% set addressService = craft.app.getAddresses() %}
{% set customFormatter = create(
  'mynamespace\\OptionalCountryFormatter',
  [
    addressService.getAddressFormatRepository(),
    addressService.getCountryRepository(),
    addressService.getSubdivisionRepository(),
  ]
) %}
{{ addr|address({ hide_countries: ['US'] }, customFormatter) }}
{# Output:
  1234 Balboa Towers Circle
  Los Angeles, CA 92662
#}
```

To replace the default formatter, add the following to your [application configuration](../config/app.md):

```php
return [
    // ...
    'components' => [
        // ...
        'addresses' => [
            'class' => \craft\services\Addresses::class,
            'formatter' => new \mynamespace\OptionalCountryFormatter(
                new \CommerceGuys\Addressing\AddressFormat\AddressFormatRepository(),
                new \CommerceGuys\Addressing\Country\CountryRepository(),
                new \CommerceGuys\Addressing\Subdivision\SubdivisionRepository()
            )
        ],
    ],
];
```

::: warning
The default formatter is used in the control panel as well as your templates, so make sure it includes all the information required for administrators to act on users’ information! Complete address data is always be available when viewing or editing it in a slideout.
:::

## Managing Addresses

Users can add, edit, and delete their own addresses from the front-end via the `users/save-address` and `users/delete-address` [controller actions](../../development/forms.md#users-save-address).

Craft doesn’t automatically give Addresses their own URLs, though—so it’s up to you to define a [routing scheme](../../system/routing.md#advanced-routing-with-url-rules) for them via `routes.php`. We’ll cover each of these three routes in the following sections:

```php
<?php
return [
  // Listing Addresses
  'account' => ['template' => '_account/dashboard'],

  // New Addresses
  'account/addresses/new' => ['template' => '_account/edit-address'],

  // Existing Addresses
  'account/addresses/<addressUid:{uid}>' => ['template' => '_account/edit-address'],
];
```

::: tip
The next few snippets may be a bit dense—numbered comments are peppered throughout, corresponding to items in the **Guide** section just below it.
:::

#### Scaffolding

The following templates assume you have a layout functionally equivalent to the [models and validation](../../development/forms.md#models-and-validation) example.

### Listing Addresses

Let’s display the current user’s address book on their account “dashboard.”

::: code
```twig _account/dashboard.twig
{% extends '_layouts/default' %}

{% requireLogin %}

{# 1. Load Addresses: #}
{% set addresses = currentUser.getAddresses() %}

{% block content %}
  <h1>Hello, {{ currentUser.fullName }}!</h1>

  {% if addresses | length %}
    <ul>
      {% for address in addresses %}
        <li>
          {{ address.title }}<br>
          {{ address|address }}<br>

          {# 2. Build an edit URL: #}
          <a href="{{ url("account/addresses/#{address.uid}") }}">Edit</a>

          {# 3. Use a form to delete Addresses: #}
          <form method="post">
            {{ csrfInput() }}
            {{ actionInput('users/delete-address') }}
            {{ hiddenInput('addressId', address.id) }}

            <button>Delete</button>
          </form>
        </li>
      {% endfor $}
    </ul>
  {% else %}
    <p>You haven’t added any addresses, yet!</p>
  {% endif %}

  {# 4. Link to "new" route: #}
  <p><a href="{{ url('account/addresses/new') }}">New Address</a></p>
{% endblock %}
```
:::

#### Guide

1. We’re using a <craft5:craft\elements\User> convenience method to load the current user’s saved addresses, but this is equivalent to our earlier [query example](#querying-addresses).
2. These URLs will need to match the pattern defined in `routes.php`. In our case, that means we need to interpolate the Address’s UID into the path.
3. [Deleting an Address](../../development/forms.md#post-users-delete-address) requires a <badge vertical="baseline" type="verb">POST</badge> request, which—for the sake of simplicity—we’re handling with a regular HTML form.
4. The [New Address](#new-addresses) route is static—there’s nothing to interpolate or parameterize.

### New Addresses

The code for new addresses will end up being reused for [existing addresses](#existing-addresses).

::: code
```twig _account/edit-address.twig
{% extends '_layouts/default' %}

{% requireLogin %}

{% block content %}
  <h1>New Address</h1>

  {# 1. Render the form #}
  {{ include('_account/address-form', {
    address: address ?? create('craft\\elements\\Address'),
  }) }}
{% endblock %}
```
```twig _account/address-form.twig
<form method="post">
  {{ csrfInput() }}

  {# 2. Set the controller action: #}
  {{ actionInput('users/save-address') }}

  {# 3. Special cases for existing addresses: #}
  {% if address.id %}
    {{ hiddenInput('addressId', address.id) }}
  {% endif %}

  {# 4. Redirection: #}
  {{ redirectInput('account/addresses/{uid}') }}

  {# 5. Address Fields: #}

  <label for="title">Title</label>
  <input
    type="text"
    name="title"
    id="title"
    value="{{ address.title }}">

  <label for="addressLine1">Address Line 1</label>
  <input
    type="text"
    name="addressLine1"
    id="addressLine1"
    value="{{ address.addressLine1 }}">

  <label for="addressLine2">Address Line 2</label>
  <input
    type="text"
    name="addressLine2"
    id="addressLine2"
    value="{{ address.addressLine2 }}">

  <label for="countryCode">Country</label>
  <select name="countryCode" id="countryCode">
    {% for country in craft.app.getAddresses().getCountryRepository().getAll() %}
      {{ tag('option', {
        value: country.countryCode,
        selected: country.countryCode == address.countryCode,
        text: country.name,
      }) }}
    {% endfor %}
  </select>

  {# ... #}

  <button>Save</button>
</form>
```
:::

#### Guide

1. We pass an <craft5:craft\elements\Address> to the form partial—either from an `address` variable that is available to the template after an attempted submission (say, due to validation errors), or a new one instantiated with the [`create()` function](../twig/functions.md#create).
2. Whether we’re creating a new address or editing an existing one (this partial handles both), the request should be sent to the `users/save-address` action.
3. Addresses that have been previously saved will have an `id`, so we need to send that back to apply updates to the correct Address.
4. The [`redirectInput()` function](../twig/functions.md#redirectinput) accepts an [object template](../../system/object-templates.md), which can include properties of the thing we’re working with. The template won’t be evaluated when it appears in the form—instead, Craft will render it using the address element _after_ it’s been successfully saved. In this case, we’ll be taken to the [edit screen](#existing-addresses) for the newly-saved address.
5. Which fields are output is up to you—but be aware that the selected `countryCode` may influence what additional address fields are required. If you want to capture input for [custom fields](../../system/fields.md), it should be nested under the `fields` key, as it is for entries and other element types: `<input type="text" name="fields[myCustomFieldHandle]" value="...">`

::: tip
See the [complete list of parameters](../../development/forms.md#post-users-save-address) that can be sent to the `users/save-address` action.
:::

### Existing Addresses

To edit an existing address, we’ll use the `addressUid` parameter from our route.

```twig
{% extends '_layouts/default' %}

{% requireLogin %}

{# 1. Resolve the address: #}
{% set address = address ?? craft.addresses
  .owner(currentUser)
  .uid(addressUid)
  .one() %}

{# 2. Make sure we got something: #}
{% if not address %}
  {% exit 404 %}
{% endif %}

{% block content %}
  <h1>Edit Address: {{ address.title }}</h1>

  {# 3. Render form: #}
  {{ include('_account/address-form', {
    address: address,
  }) }}
{% endblock %}
```

#### Guide

1. In one statement, we’re checking for the presence of an `address` variable sent back to the template by a prior submission, and falling back to a lookup against the user’s Addresses. By calling `.owner(currentUser)`, we can be certain we’re only ever showing a user an Address they own.
2. If an Address wasn’t passed back to the template, _and_ the UID from our route didn’t match one of the current user’s addresses, we bail.
3. The Address is passed to the form partial for rendering—see the [new address example](#new-addresses) for the form’s markup.


## Validating Addresses

Addresses are validated like any other type of element, but some of the rules are dependent upon its localized format.

You can set requirements for custom fields in the Address Fields [field layout](#native-custom-fields), but additional validation of any address properties requires a [custom plugin or module](../../extend/README.md).

::: tip
Take a look at the [Using Events in a Custom Module](kb:custom-module-events) article for a dedicated primer on module setup and events.
:::

[Validation rules](guide:input-validation) are added via the `Model::EVENT_DEFINE_RULES` event:

```php
use yii\base\Event;
use craft\base\Model;
use craft\elements\Address;
use craft\events\DefineRulesEvent;

Event::on(
    Address::class,
    Model::EVENT_DEFINE_RULES,
    function(DefineRulesEvent $event) {
        $event->rules[] = [
            ['fullName'],
            'match',
            'pattern' => '/droid|bot/i',
            'message' => Craft::t('site', 'Robots are not allowed.'),
        ];
    }
);
```

Errors are available through the same `address.getErrors()` method used in other action and [model validation examples](../../development/forms.md#models-and-validation), regardless of whether they were produced by built-in rules or ones you added.

## Querying Addresses

You can fetch addresses in your templates or PHP code using an [AddressQuery](craft5:craft\elements\db\AddressQuery).

::: code
```twig
{# Create a new address query #}
{% set myAddressQuery = craft.addresses() %}
```
```php
// Create a new address query
$myAddressQuery = \craft\elements\Address::find();
```
:::

<See path="../../development/element-queries.md" label="Introduction to Element Queries" description="Learn more about how element queries work." />

### Example

Let’s output a list of the logged-in user’s addresses:

1. Create an address query with `craft.addresses()`.
2. Restrict the query to addresses owned by the current User, with the [`owner`](#owner) parameter.
3. Fetch the addresses with `.all()`.
4. Loop through the addresses using a [`{% for %}` tag](https://twig.symfony.com/doc/3.x/tags/for.html).
5. Output preformatted address details with the [`|address`](../twig/filters.md#address) filter.

```twig
{% requireLogin %}

{% set addresses = craft.addresses()
  .owner(currentUser)
  .all() %}

{% for addr in addresses %}
  <address>{{ addr|address }}</address>
{% endfor %}
```

We’ll expand on this example in the [Managing Addresses](#managing-addresses) section.

::: warning
Protect your users’ personal information by carefully auditing queries and displaying private addresses only on pages that [require login](../twig/tags.md#requirelogin).
:::

### Parameters

Address queries support the following parameters:

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/addresses.md)!!!
</file>

<file path="reference/element-types/assets.md">
---
description: Store files and rich metadata, together—then reuse them throughout the system.
containsGeneratedContent: yes
related:
  - uri: ../../system/elements.md
    label: Introduction to Elements
  - uri: ../field-types/assets.md
    label: Assets Fields
---

# Assets

Craft lets you manage media and document files (“assets”) just like entries and other content types. Assets can live anywhere—a directory on the web server, or a remote storage service like Amazon S3.

<!-- more -->

Assets are one of Craft’s built-in [element types](../../system/elements.md), and are represented throughout the application as instances of <craft5:craft\elements\Asset>.

## Volumes

Assets are organized into **volumes**, each of which sits on top of a [filesystem](#filesystems) and carries its own permissions and [content](#asset-custom-fields) options. Volumes are configured from **Settings** → **Assets**.

When setting up a volume, you will be asked to choose or create its underlying filesystem.

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/assets/volumes/new"
  :link="false"
  caption="You can create a filesystem without leaving the volume screen.">
<img src="../../images/assets-new-volume-fs.png" alt="Screenshot of the volume settings screen in Craft with a slide-out for filesystem settings">
</BrowserShot>

Volumes can store their [transforms](#image-transforms) alongside the original images, or in a separate filesystem altogether. This is useful for private volumes or filesystems that still benefit from having previews available in the control panel.

## Filesystems

Filesystems decouple the minutiae of storing and serving actual files from asset management (organization, permissions, and content).

All filesystems support the following options:

- **Files in this filesystem have public URLs**: Whether Craft should bother to generate URLs for the assets.
- **Base URL**: The public URL to files in this filesystem.

::: tip
A filesystem’s **Base URL** can be set to an environment variable, or begin with an alias. [Read more](../../configure.md#control-panel-settings) about special configuration values.

In the screenshot above, we’re using a `@cdn` [alias](../../configure.md#aliases) so that the URL can be updated across multiple filesystems with a single change in our general config file—or even with an environment variable, if the alias gets _its_ value from one!
:::

Multiple volumes can share a single filesystem, so long as they each have a unique and non-overlapping **Base Path**. If another volume is already mounted at the top level of a filesystem, that filesystem won’t be available for selection.

### Local Filesystems

Out of the box, the only type of filesystem Craft supports is a “Local” directory, which stores files on the same server that PHP is running. Local filesystems have one additional setting:

- **Base Path**: Set the filesystem’s root directory on the server. This must be within your web root for public URLs to work, and Craft/PHP must be able to write to it.

::: tip
The **Base Path** can be set to an environment variable or begin with an alias, just like the **Base URL**.
:::

<a id="remote-volumes"></a>

### Remote Filesystems

If you would prefer to store your assets on a remote storage service like Amazon S3, you can install a plugin that provides the appropriate filesystem adapter.

- [Amazon S3](plugin:aws-s3) (first party)
- [Google Cloud Storage](plugin:google-cloud) (first party)
- [Microsoft Azure Blob Storage](plugin:azure-blob) (first party)
- [DigitalOcean Spaces](plugin:dospaces) (Værsågod)

The settings for each type of filesystem will differ based on the provider, and may involve secrets. We recommend using [special config values](../../configure.md#control-panel-settings) to store and use these, securely.

::: tip
Discover more remote storage options in the [Assets category](https://plugins.craftcms.com/categories/assets?craft5) of the Plugin Store!
:::

## Asset Custom Fields

Each volume has its own [field layout](../../system/fields.md#field-layouts), configured on its setting screen under the **Field Layout** tab.

### `alt` Text

Asset field layouts can include the native **Alternative Text** <Poi label="1" target="assetFieldLayout" id="altText" /> field layout element:

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/assets/volumes/1"
  :link="false"
  id="assetFieldLayout"
  :poi="{
    altText: [90, 32.5],
  }">
<img src="../../images/assets-field-layout.png" />
</BrowserShot>

A native `alt` attribute is provided to standardize the inclusion of assistive text on `img` elements that Craft generates—especially in the control panel. Alt text is also added when outputting an image with `asset.getImg()` in Twig. You can always render `img` elements yourself, using any [custom field](../../system/fields.md) values, attributes, or combination thereof. 

We strongly recommend adding the native attribute to your volumes’ field layouts; alt text is a critical interface for many users, and essential for anyone using assistive technology in the control panel. Well-considered image descriptions (and titles!) have the added benefit of making search and discovery of previously-uploaded images much easier. The WCAG [advises against](https://www.w3.org/TR/2015/REC-ATAG20-20150924/Overview.html#gl_b23) automatically repairing alt text with “generic or irrelevant strings,” including the name of the file (which asset titles are generated from), so Craft omits the `alt` attribute when using `asset.getImg()` if no explicit text is available.

**Alternative Text** is also displayed as a “transcript” beneath video previews, in the control panel.

::: tip
Do you have existing `alt` text stored in a different field? You can migrate it to the native attribute with the [`resave/assets` command](../cli.md#resave):

```bash
php craft resave/assets --set alt --to myAltTextField --if-empty
```
:::

## Assets Page

After creating your first volume, an **Assets** item will be added to the main control panel navigation. Clicking on it will take you to the Assets page, which shows a list of all of your volumes in the left sidebar, and the selected volume’s files and subfolders in the main content area.

In addition to the normal actions available in [element indexes](../../system/elements.md#indexes), asset indexes support:

- Uploading new files using the **Upload files** toolbar button or by dragging files from your desktop;
- Creating and organizing [folders](#managing-subfolders) within a volume;
- Transferring a file from one volume to another by dragging-and-dropping it from the element index into a folder in the sources sidebar (or using the **Move…** element action);

Special [element actions](../../system/elements.md#actions) are also available for single assets:

- Rename an existing file;
- Replace a file with a new one;
- Open the [image editor](#image-editor) (images only);
- Preview a file;
- Copy a public URL to a file;
- Copy a reference tag to a file;
- Move the selected assets to a new volume and/or folder;

### Managing Subfolders

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/assets/uploads"
  :link="false"
  id="assetIndex"
  :poi="{
    breadcrumbs: [42, 21],
    folder: [57, 34],
    dragging: [46, 42],
    actions: [67, 94],
  }">
<img src="../../images/assets-index.png" alt="Asset element index showing subfolder creation and drag-and-drop interface for organizing files" />
</BrowserShot>

Volumes are initialized with only a root folder, indicated by a “home” icon in the breadcrumbs. Subfolders can be created by clicking the caret <Poi label="1" target="assetIndex" id="breadcrumbs" /> next to the current folder.

The new subfolder will appear in-line <Poi label="2" target="assetIndex" id="folder" /> with the assets in the current folder. Assets and folders can be moved in a few different ways:

- Drag-and-drop <Poi label="3" target="assetIndex" id="dragging" /> one or more assets onto a folder in the table or thumbnail view _or_ onto a breadcrumb <Poi label="1" target="assetIndex" id="breadcrumbs" /> segment;
- Select assets with the checkboxes in each row, choose **Move…** from the actions <Poi label="4" target="assetIndex" id="actions" /> menu, and pick a destination folder;
- An entire folder can also be moved using the caret next to its breadcrumb;

The first method is a great way to quickly move assets into a parent directory, or back to the volume’s root folder.

::: tip
You can automatically organize assets when they are uploaded via an [assets field](../field-types/assets.md) with the **Restrict assets to a single location** setting.
:::

## Updating Asset Indexes

If any files are ever added, modified, or deleted outside of Craft (such as over FTP), you’ll need to tell Craft to update its indexes for the volume. You can do that from <Journey path="Utilities, Asset Indexes" />, or using the [`index-assets` console commands](../cli.md#index-assets):

```bash
# Re-index all volumes:
php craft index-assets/all

# Re-index a specific volume:
php craft index-assets/one myVolumeHandle

# See available options:
php craft index-assets/one --help
```

Both tools provide the option to **Cache Remote Images**. If you don’t have any [remote filesystems](#remote-filesystems) (or the volume doesn’t contain any transformable files) you can safely ignore it.

::: tip
Enabling the setting will cause the indexing process to take longer to complete (and may consume a great deal of local disk space), but it can speed up subsequent [image transformations](../../development/image-transforms.md).

This option will have limited utility on ephemeral filesystems, as any downloaded images will be erased the next time it is restarted.
:::

Indexing assets is also a quick way to import a preexisting directory of files with Craft: with a fresh [volume](#volumes), drop the files anywhere within its **Base Path**, then index it to create the corresponding asset elements.

## Image Transforms

To help serve optimized images, Craft supports predefined (or “named”) and ad-hoc [image transformations](../../development/image-transforms.md).

## Image Editor

Craft provides a built-in Image Editor for making changes to your images. You can crop, straighten, rotate, and flip your images, as well as choose a focal point on them.

To launch the Image Editor, double-click an image (either on the Assets page or from an [Assets field](../field-types/assets.md)) and press **Edit** in the top-right of the image preview area in the HUD. Alternatively, you can select an asset on the [Assets page](#assets-page) and choose **Edit image** from the task menu (<icon kind="settings" />).

### Focal Points

Set focal points on your images so Craft knows which part of the image to prioritize when determining how to crop your images for [image transforms](../../development/image-transforms.md). Focal points take precedence over the transform’s Crop Position setting.

To set a focal point, open the Image Editor and click on the Focal Point button. A circular icon will appear in the center of your image. Drag it to wherever you want the image’s focal point to be.

To remove the focal point, click on the Focal Point button again.

Like other changes in the Image Editor, focal points won’t take effect until you’ve saved the image.

## Querying Assets

You can fetch assets in your templates or PHP code using **asset queries**.

::: code
```twig
{# Create a new asset query #}
{% set myAssetQuery = craft.assets() %}
```
```php
// Create a new asset query
$myAssetQuery = \craft\elements\Asset::find();
```
:::

Once you’ve created an asset query, you can set [parameters](#parameters) on it to narrow down the results, and then [execute it](../../development/element-queries.md#executing-element-queries) by calling `.all()`. An array of [Asset](craft5:craft\elements\Asset) objects will be returned.

<See path="../../development/element-queries.md" label="Introduction to Element Queries" description="Learn more about how element queries work." />

### Example

We can display a list of thumbnails for images in a “Photos” volume by doing the following:

1. Create an asset query with `craft.assets()`.
2. Set the [volume](#volume) and [kind](#kind) parameters on it.
3. Fetch the assets with `.all()`.
4. Loop through the assets using a [for](https://twig.symfony.com/doc/3.x/tags/for.html) tag to create the thumbnail list HTML.

```twig
{# Create an asset query with the 'volume' and 'kind' parameters #}
{% set myAssetQuery = craft.assets()
  .volume('photos')
  .kind('image') %}

{# Fetch the assets #}
{% set images = myAssetQuery.all() %}

{# Display the thumbnail list #}
<ul>
  {% for image in images %}
    <li><img src="{{ image.getUrl('thumb') }}" alt="{{ image.alt }}"></li>
  {% endfor %}
</ul>
```

::: warning
When using `asset.url` or `asset.getUrl()`, the asset’s source volume must have “Assets in this volume have public URLs” enabled and a “Base URL” setting. Otherwise, the result will always be empty.
:::

You can cache-bust asset URLs automatically by enabling the [revAssetUrls](config5:revAssetUrls) config setting, or handle them individually by using Craft’s [`url()` function](../twig/functions.md#url) to append a query parameter with the last-modified timestamp:

```twig
<img src="{{ url(image.getUrl('thumb'), { v: image.dateModified.timestamp }) }}">
{# <img src="https://my-project.tld/images/_thumb/bar.jpg?v=1614374621"> #}
```

### Parameters

Asset queries support the following parameters:

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/assets.md)!!!
</file>

<file path="reference/element-types/categories.md">
---
description: Create user-managed, hierarchical taxonomies for your content.
containsGeneratedContent: yes
related:
  - uri: ../../system/elements.md
    label: Introduction to Elements
  - uri: ../field-types/categories.md
    label: Categories Fields
---

# Categories

Craft supports user-managed, hierarchical taxonomies for content via **categories**.

<!-- more -->

Categories are one of Craft’s built-in [element types](../../system/elements.md), and are represented throughout the application as instances of <craft5:craft\elements\Category>.

<Block label="Migrating to Structures">

With the release of Craft 4.4, we began consolidating features of [other element types](../../system/elements.md) into [entries](entries.md).

As part of that process, we introduced a [console command](../cli.md#entrify-categories) that can automate the conversion of categories to [structure sections](entries.md#structures):

```bash
php craft entrify/categories myCategoryGroupHandle
```

Read more about this [transition](https://craftcms.com/blog/entrification) on our blog.

</Block>

## Category Groups

Every category belongs to a _category group_, which defines…

- …a name;
- …a handle (used when referencing the group in [queries](#querying-categories) and templates);
- …the maximum number of levels categories can be nested, within the group;
- …the format of category URIs used for [routing](#routing-and-templates);
- …which [template](#routing-and-templates) should be rendered when a category’s URL is accessed;
- …which [fields](../../system/fields.md) categories in the group should have;

To create a new category group, go to <Journey path="Settings, Categories" /> and click **New Category Group**.

## Category Field Layout

Each category group has its own _field layout_, which allows you to customize the data that’s associated with each category in the group. By default, categories only have a **Title** and **Slug**, but you can add as many other [custom fields](../../system/fields.md) as necessary to satisfy your content architecture.

<See path="../../system/fields.md" />

## Creating and Editing Categories

When you’ve defined at least one category group, **Categories** will appear in the control panel’s primary navigation. Clicking it will take you to the category index. From there, you can choose a category group <Poi label="1" target="categoryIndex" id="groups" /> from the sidebar, and add/reorder/delete categories within it:

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/categories/flavors"
    :link="false"
    caption="A category index representing coffee flavor profiles."
    id="categoryIndex"
    :poi="{
        groups: [30, 20.6],
        structure: [76.2, 9],
        statusIcon: [45, 64],
    }">
<img src="../../images/categories-category-index.png" alt="Screenshot of the categories index, with “Categories” active in the main navigation, the “Flavors” category group selected, and a listing of category names in a nested hierarchy">
</BrowserShot>

Select the “Structure” <Poi label="2" target="categoryIndex" id="structure" /> sort option to view and manipulate the categories’ [hierarchy](../../system/elements.md#structures). Double-click any element <Poi label="3" target="categoryIndex" id="statusIcon" /> to open a [slideout](../../system/control-panel.md#slideouts).

You can also click a category’s title to visit its edit page just like an entry.

When you create a category, you have the following options:

- Fill out the category fields (if you didn’t define any, the only field available will be **Title**)
- Edit the slug (it’s automatically populated based on the title).
- Choose a **Parent** category. The new category will have a hierarchical relationship with its parent. This is helpful for creating taxonomies with multiple levels. You also have the option of creating a new category while assigning the Parent.

::: tip
You can only nest categories up to the level specified in the **Max Level** field Category Group settings. By default, there is no limit to how deeply-nested categories can be.
:::

## Assigning Categories

To assign categories to things (entries, assets, users, etc.), you must first create a [categories field](../field-types/categories.md).

Each Categories field is connected to a single category group. Whatever you attach the field to will store [relations](../../system/relations.md) to categories selected from that group.

## Routing and Templates

Category groups’ **URI Format** setting is equivalent to that of [entries](entries.md), so any of the [object template](../../system/object-templates.md) strategies discussed in [this section](entries.md#entry-uri-formats) apply to categories, as well.

When a category’s URL is requested, Craft renders the template defined by its group, and makes a special `category` variable available. Supposing a _Flavors_ category group had a **URI Format** of `flavors/{slug}` and was configured to use `_categories/flavors.twig` as its **Template**:

```twig
{{ category.title }}
{# -> "Sour Aromatics" #}

{{ category.ancestors.collect()
  .select('title')
  .join(' / ') }}
{# -> "Sour & Fermented / Sour" #}
```

Custom fields attached to the group’s field layout are also available via the `category` variable.

## Querying Categories

You can fetch categories in your templates or PHP code using **category queries**.

::: code
```twig
{# Create a new category query #}
{% set myCategoryQuery = craft.categories() %}
```
```php
// Create a new category query
$myCategoryQuery = \craft\elements\Category::find();
```
:::

Once you’ve created a category query, you can set [parameters](#parameters) on it to narrow down the results, and then [execute it](../../development/element-queries.md#executing-element-queries) by calling `.all()`. An array of [Category](craft5:craft\elements\Category) objects will be returned.

<See path="../../development/element-queries" description="Learn more about element queries." />

### Example

We can display a navigation for all the categories in a _Flavors_ category group by doing the following:

1. Create a category query with `craft.categories()`.
2. Set the [group](#group) parameter on it using its handle.
3. Fetch the categories with `.all()`.
4. Loop through the categories using a [nav](../twig/tags.md#nav) tag to create the navigation HTML.

```twig
{# Create a category query with the 'group' parameter #}
{% set myCategoryQuery = craft.categories()
  .group('flavors') %}

{# Fetch the categories #}
{% set categories = myCategoryQuery.all() %}

{# Display the navigation #}
<ul>
  {% nav category in categories %}
    <li>
      <a href="{{ category.url }}">{{ category.title }}</a>
      {% ifchildren %}
        <ul>
          {% children %}
        </ul>
      {% endifchildren %}
    </li>
  {% endnav %}
</ul>
```

Keep in mind that this only holds value for category groups with multiple hierarchical levels. If you were working with a “flat” taxonomy, the template above should use a regular `{% for %}` tag in lieu of Craft’s `{% nav %}` tag.

::: tip
To maintain the exact order you see in the control panel, add `orderBy('lft ASC')` to your query:

```twig
{% set myCategoryQuery = craft.categories()
  .group('flavors')
  .orderBy('lft ASC') %}
```
:::

### Elements Related to a Category

When you’ve attached a [categories field](../field-types/categories.md) to another type of element, you can query for those elements when you have a reference to a category.

For example, if we were building a “Tasting Notes” database with dedicated _Flavor_ (category) pages, we might build a query like this to look up records:

```twig
{% set records = craft.entries()
  .relatedTo({
    targetElement: category,
    field: 'flavors',
  })
  .all() %}
```

::: tip
Here, `flavors` also happens to be the handle of the relational field. _You do not need to follow any kind of convention when naming relational fields_; the groups available for selection in a given categories field are explicitly defined on that field.
:::

<See path="../../system/relations.md" description="Read about querying with relational fields." />

You can also use the field’s query method to set up the relational constraint, automatically:

```twig
{% set records = craft.entries()
  .flavors(category)
  .all() %}
```

In both cases, we’re assuming the `category` variable comes from Craft, when loading an individual category’s [template](#routing-and-templates).

### Parameters

Category queries support the following parameters:

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/categories.md)!!!
</file>

<file path="reference/element-types/entries.md">
---
description: Model, compose, and publish content exactly the way you want.
containsGeneratedContent: yes
related:
  - uri: ../../system/elements.md
    label: Introduction to Elements
  - uri: ../field-types/entries.md
    label: Entries Fields
sidebarDepth: 2
---

# Entries

Entries are flexible content containers that—unlike [addresses](addresses.md), [assets](assets.md), or [categories](categories.md)—have no primary or implied function. They are entirely agnostic building blocks, used to model whatever kind of content or data your project needs.

<!-- more -->

All entries support some key features like **Authors**, a **Post Date** and **Expiration Date**, **Statuses**, and content defined via  [field layouts](../../system/fields.md). Additional features and properties are determined via [entry types](#entry-types), or the [sections](#sections) and [Matrix fields](../field-types/matrix.md) they’re used in.

Authors can use the [drafts and revisions](#editing-entries) system to stage different versions of content and preview it before going live.

## Entry Types

Craft uses _entry types_ to define atomic units of content, which are then exposed to editors via [sections](#sections) and [Matrix fields](../field-types/matrix.md).

<Block label="Global Entry Types">

Entry types became a global resource in Craft 5. This means you can define a content type _once_, then use it in multiple sections, as a [nested](#nested-entries) block in a [Matrix](../field-types/matrix.md) field, or some combination of the two. As a result, some settings have moved around!

Most importantly, you’ll manage entry types in the **Settings** &rarr; **Entry Types** screen—or create them on-the-fly when working on a section or Matrix field.

</Block>

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/entry-types/1"
  :link="false"
  :max-height="450"
  caption="Editing an entry type in the control panel.">
  <img src="../../images/entry-type-edit.png" alt="Screenshot of entry type settings">
</BrowserShot>

Entry types have the following settings:

- **Name** — Used throughout the control panel as a UI label.
- **Handle** — Uniquely identifies entries of this type in [templates](../../development/templates.md) and [queries](../../development/element-queries.md).
- **Icon** and **Color** — Choose a symbol and color to subtly distinguish entries of this type throughout the control panel.
- **Title Translation Method** — In multi-site projects, choose how titles are localized.
- **Default Title Format** — Entry titles can be set by the author or [dynamically defined](#dynamic-entry-titles) from other values via an [object template](../../system/object-templates.md).
- **Show the Slug field** — As with titles, slugs can be manually or automatically generated.
  - **Slug Translation Method** — In multi-site projects, choose how slugs are localized.
- **Show the Status field** — Manually set each entry’s status, or allow it to be dictated by its usage.
- **Field Layout** — Add and arrange [custom fields](../../system/fields.md) to suit your content model.
- **Card Attributes** — Select which attributes and fields appear on [cards](../../system/elements.md#chips-cards) of this type.

### Aliases <Since ver="5.6.0" feature="Entry type aliases" />

When attaching an entry type to a [section](#sections) or [field](../field-types/matrix.md), you can configure a local override for its **Name** and **Handle**. This affects labels in the control panel, but does _not_ change how you reference them in queries.

As an example, an _Announcement_ entry type could be used in a _News_ section and a _Content_ Matrix or [CKEditor](plugin:ckeditor) field; in the _Content_ field context, the entry type is given a new **Name** (_Banner_) and handle (`banner`). Authors would then see _Banner_ when selecting **New entry** in the CKEditor toolbar, but developers would need to continue using the original, global handle to directly query those nested entries:

```twig{3}
{% set embeddedAnnouncements = craft.entries()
  .field('pageContent')
  .type('announcement')
  .all() %}
```

However, when _accessing_ the entry type via those nested entries (or an entry within a section), the aliases are applied automatically:

```twig{2,8}
{% set announcements = craft.entries()
  .type('announcement')
  .all() %}

{% for announcement in announcements %}
  <article>
    <h2>{{ announcement.title }}</h2>
    <span class="type">{{ announcement.type.name }}</span>
    {{ announcement.body|md }}
  </article>
{% endfor %}
```

In this example, `announcement.type.name` might resolve to _Critical Release_ in one section, but _New Face_ in another—even though we queried for them using the original, global handle. To access the global <craft5:craft\models\EntryType>, use `entry.type.original`.

This can help improve the legibility of templates, wherein the generic `announcement` handle doesn’t describe how the entry type is actually used:

```twig{2,8-11}
{% for contentBlock in entry.myMatrixField %}
  <div class="content-block content-block--type-{{ contentBlock.type.handle }}">
    {% switch contentBlock.type.handle %}
      {% case 'carousel'}
        {# ... #}
      {% case 'recommended'}
        {# ... #}
      {% case 'banner' %}
        {# Perhaps “Banner” made more sense than “Announcement” in this context, when designing! #}
        <h3>{{ contentBlock.title }}</h3>
        {{ contentBlock.message|md }}
      {% default %}
        {{ contentBlock.render() }}
    {% endswitch %}
  </div>
{% endfor %}
```

### Dynamic Entry Titles

The **Default Title Format** field accepts an [object template](../../system/object-templates.md) (just like the **Entry URI Format** and preview target **URL Format** we looked, above), and is evaluated whenever entries with this type are saved _without an explicitly-set title_. A title format may be rendered multiple times, depending on the selected **Title Translation Method**.

If you want your entries’ titles to _always_ be generated from a template (and disallow authors from providing their own titles), remove the **Title** element from the [field layout](../../system/fields.md#field-layouts). <Since ver="5.5.0" feature="Default title formats and removable titles" />

::: tip
Prior to Craft 5.5.0, this behavior was governed by two settings (**Show the Title field** and **Show the Title field?**), with no intermediate “default” option.
:::

### Translation Settings

Most localization behavior is determined by [section](#sections) and [field](../../system/fields.md) settings, but the translation of titles and slugs is governed by entry types.

The available translation methods are covered in the [custom fields documentation](../../system/fields.md#translation-methods).

## Sections

Sections organize and expose [entry types](#entry-types) for content authors. In each section you can define the following:

- Whether entries in the section have URLs;
- What the entries’ URLs should look like;
- Which template should get loaded if an entry’s URL is requested;
- What preview targets are available to authors;
- What [entry types](#entry-types) are available in the section;
- How many authors can be associated with each entry (or disable authors <Since ver="5.7.0" feature="Authorless sections" />);

If your project has multiple [sites](../../system/sites.md), your section can define these additional settings:

- Which sites entries in the section should target;
- Which sites entries are created in, by default;

To create a new section, go to <Journey path="Settings, Sections" /> and choose **New Section**.

### Section Types

Craft has three different types of sections:

#### Singles

![Illustration of Entries layout with “Singles” selected, showing “About Us”, “Contact” and “Home” entries](../../images/section-types-singles.png)

Singles are used for one-off pages or content objects that have unique requirements, such as…

- …a website’s homepage;
- …an _About Us_ page;
- …a _Contact Us_ page;

Unlike the other section types, singles only ever have _one_ entry associated with them, meaning their URIs can be static (like `contact-us`) rather than templatized (like `news/{slug}`).

::: tip
Singles have all the functionality of [globals](globals.md), and can even be pre-loaded into global Twig variables with the <config5:preloadSingles> config setting. As such, singles don’t have an editable **Author**, **Post Date**, or **Expiration Date**.

A single’s **Status** controls can be hidden with the **Show the Status field** setting in its selected **Entry Type**.
:::

#### Channels

![Illustration of Entries layout with a “Press Releases” channel selected, showing three dated news entries](../../images/section-types-channels.png)

Channels are used for lists or streams of similar content, such as…

- …posts on a blog;
- …articles in a knowledge base;
- …recipes;
- …reviews;

Entries in channels are intended to be queried and displayed ordered by one or more of their attributes or [custom fields](../../system/fields.md). Channels are also a simple way to maintain a flat taxonomy, standing in for [tags](tags.md) or [categories](categories.md).

#### Structures

Structures are an extension of channels that support explicit, hierarchical organization.

![Illustration of Entries layout with a “Galleries” structure selected, showing nested building and gallery entries with drag-and-drop handles](../../images/section-types-structures.png)

Unlike other section types, structure sections expose a **Structure** view option on their [element indexes](../../system/elements.md#indexes):

![Illustration of an element index’s “View” options with “Structure” selected.](../../images/section-types-structure-view-mode.png)

Types of content that might benefit from being defined as a structure include…

- …documentation;
- …a “Services” section, where the order of services matters;
- …a company organization chart with personnel and teams;
- …editable navigation menus;

Just like channels, entries in structures can be assigned [types](#entry-types). Structures offer great flexibility in presentation—in particular, the ability to collect nested content on a parent page, or alter the appearance of pages based on their hierarchical “depth” within a bundle of content.

Structures have the following additional settings:

Max Levels
:   Decide how many levels deep authors can organize entries.

Default Entry Placement
:   Choose where new entries are placed in the structure. This setting applies when that entry has no parent entry (before or after other “root” entries), _and_ when a parent is selected (before or after other entries with the same parent), as well as when an entry is [moved](#moving-entries-between-sections) into the section. <Since ver="5.3.0" feature="Moving entries between sections" />

Structures can also make use of the **Maintain Hierarchy** setting on [entries fields](../field-types/entries.md).

::: tip
Entries belonging to a structure are discrete from [nested entries](#nested-entries) in [Matrix](../field-types/matrix.md) fields. Structure entries can be freely moved around in their hierarchy (receiving new “parent” elements in the process), whereas nested entries are always owned by the element they were created within.
:::

#### Custom Sources

You can supplement the automatic [sources](../../system/elements.md#sources) presented in the entries [element index](../../system/elements.md#indexes) with _custom sources_. Each custom source lists all entries by default, but can be filtered to only those that meet the specified **Entry Criteria**.

### Entry URI Formats

Channel and structure sections can choose whether their entries should be given URLs in the system by filling in the **Entry URI Format** setting. Singles also have this setting, but it is typically a static path or omitted (if it doesn’t need its own URL, like a [global set](globals.md)).

The entry URI format is an [object template](../../system/object-templates.md), which gets evaluated each time an entry in the section is saved. The result is saved as the entry’s **URI** in the system, and is used to generate URLs (i.e. via `entry.url`) and when Craft is determining how to [route](../../system/routing.md) a request.

When Craft matches a request to an entry, its section’s designated **Template** is rendered. That template is automatically provided an `entry` variable, set to the resolved <craft5:craft\elements\Entry> object, and ready to output any of its attributes or custom field data.

#### URI Recipes

Consider these tips for creating special URIs:

- A URI that evaluates to `__home__` (and nothing more) will be available at your site’s base path (this should only be used for [singles](#singles));
- An empty URI means the entry does not get a route and will not have a public URL—unless you define one manually via `routes.php`;
- Any Twig statement can be used to output values in a URI template—including ones that query for other elements, e.g. `{{ craft.entries().section('mySingle').one().slug }}/news` (see note below);
- [Aliases](../../configure.md#aliases-and-environment-variables) can be evaluated with the [`alias()` function](../twig/functions.md#alias): `{{ alias('@basePressUri') }}/news`, `{{ alias('@mySectionUri') }}`.
- The [null-coalescing operator](https://twig.symfony.com/doc/3.x/templates.html#other-operators) (`??`) can silently swallow undefined variable errors (like `parent.uri`, above);

Elements accessed via the current `object` (like authors or [relational fields](../../system/relations.md#custom-fields)) will be loaded in the appropriate site, but _new_ element queries (like the example above that uses `craft.entries()`), must explicitly use `.site()` or `.siteId()` to load elements in the same site. The current element’s site can always be accessed via `object.site` or `object.siteId`, respectively:

```
{craft.entries().section('mySingle').site(object.site).one().slug}
```

If you only have one site, you can omit this for brevity; similarly, if the resolved value tends to be the same as a value you’re already storing in project config, consider hard-coding it.

::: warning
**Do not** use element IDs directly in URI formats. They are not a [reliable identifier](../../system/project-config.md#ids-uuids-and-handles) across environments. For example, keeping channel entries’ URLs synchronized with a [single](#singles) using this format…

```
{craft.entries().id(123).one().slug}/{slug}
```

…may load the correct entry in development, but find a different one on your live site. Use a handle (like the example above) for consistency!
:::

#### Hierarchical URIs

Structure sections may benefit from nested paths, for child entries:

```twig
{parent.uri}/{slug}
```

Suppose our structure represents geographic regions on Earth. With the above **Entry URI Format**, a top-level “continent” entry URI might be `south-america`; a nested “country” entry’s URI would then be `south-america/chile`.

Structure sections might also want to include a segment before the nested path:

```twig
{parent.uri ?? 'earth'}/{slug}
```

The above template could also be expressed with this syntax:

```twig
{% if level == 1 %}earth{% else %}{parent.uri}{% endif %}/{slug}
```

With the above Entry URI Format, a top-level entry’s URI would be `earth/south-america`, with a nested entry having `earth/south-america/chile`.

#### Nested Entry URLs

[Nested entries](#nested-entries) in [Matrix fields](../field-types/matrix.md) can also be configured to have URLs—but the settings are part of the field, not a section. As a result, entries of a given [type](#entry-types) may have URLs in some contexts, and not in others!

In a nested entry’s URI format, you can access the _owner_’s attributes using `{owner.someAttribute}`:

```
{owner.uri}/steps/{slug}
```

### Preview Targets <Badge type="edition" vertical="middle" title="Preview Targets are configurable in Craft Team">Team</Badge> <Badge type="edition" vertical="middle" title="Preview Targets are configurable in Craft Pro">Pro</Badge>

Section can have one or more **Preview Targets**, or URLs where its entries are expected to be visible. This makes it possible for authors to preview entries as they are writing them in the control panel, or share a private URL with colleagues to view changes prior to publishing.

Like entry URI formats, these preview target URLs are simple Twig templates that can contain entry properties and other dynamic values.

Use single curly braces to render attributes on the entry. For example if entries in your section have their own URLs, then you can create a preview target for the entry’s primary URL using the URL template, `{url}`.

Create additional preview targets for any other areas the entry might show up, such as `news`, or `archive/{postDate|date('Y')}`. If the entries show up on the homepage, you can create a preview target with a blank URL (unlike URI formats, a blank URL _is_ valid, here).

![A section’s Preview Targets setting.](../../images/preview-targets.png)

Preview target **URL Formats** support slightly different features than for **URI Formats**:

- If you want to include the entry’s ID or UID in a preview target URL, use `{canonicalId}` or `{canonicalUid}` rather than `{id}` or `{uid}`, so the source entry’s ID or UID is used rather than the [draft](#drafts)’s;
- You can use [environment variables and aliases](../../configure.md#control-panel-settings) in the preview target URL. These _do not_ get wrapped in curly braces on their own, as they are not part of the [object template](../../system/object-templates.md). Aliases may be part of a longer URI (e.g.`@headlessUrl/news/{slug}`), but environment variables can only be used on their own (e.g. `$NEWS_INDEX`);

When an author is editing an entry from a section with custom preview targets, the **View** button will be replaced with a menu that lists the **Primary entry page** (if the section has an Entry URI Format), plus the names of each preview target.

![An entry’s View menu with 3 custom preview targets.](../../images/share-with-targets.png =394x)

If you share a link from this menu that includes a preview token, it will expire by default after one day. You can customize this with the [defaultTokenDuration](config5:defaultTokenDuration) config setting.

The targets will also be available within **Preview**.

#### Previewing Decoupled Front Ends

If your site’s front end lives outside of Craft (e.g. as a Vue or React app), you can still support previewing drafts and revisions with **Preview** or **Share** buttons. To do that, your front end must check for the existence of a `token` query string parameter (or whatever the <config5:tokenParam> setting is). If it’s in the URL, then you will need to pass that same token in the request that loads the page content. This token will cause the API request to respond with the correct content based on what the token was created to preview.

<Block label="Nuxt Example">

Whether you are using the Element API plugin or the built-in [GraphQL](../../development/graphql.md) API, Craft automatically injects preview elements whenever they match the query being executed.

To illustrate, suppose you were building a [Nuxt](https://nuxt.com/) application, and you used the [file-based routing scheme](https://nuxt.com/docs/getting-started/routing) to render blog posts: you would create `pages/blog/[slug].vue`, then define a preview target in Craft with a similar path, like `@nuxt/blog/{slug}`.

```vue
<script setup>
const route = useRoute();

// Construct a GraphQL fragment using the route param:
const query = `{
  entry(slug: "${route.params.slug}") {
    title
    description
  }
}`;

// Fetch the incoming token:
const token = route.query.token;

// Build the URL, with `query` and `token` params:
const { data: gql } = await useFetch('https://my-project.ddev.site/api', {
  params: { query, token },
});
</script>

<template>
  <article>
    <h1>{{ gql.data.entry.title }}</h1>
    <code>{{ gql.data.entry.uid }}</code>
  </article>
</template>
```

This assumes you have defined a [GraphQL API route](../../development/graphql.md#setting-up-your-api-endpoint) of `api`, and that the previewed entry will reliably have (at least) a slug set. When the `token` param is omitted, Nuxt ignores it and the GraphQL API will respond as though it were any other request for an entry with the given slug.

</Block>

You can pass the token via either a query string parameter named after your <config5:tokenParam> config setting, or an `X-Craft-Token` header.

::: tip
For live preview, you should also consider [enabling iFrame Resizer](config5:useIframeResizer) so that Craft can maintain the page scroll position between page loads.
:::

### Moving Entries Between Sections <Since ver="5.3.0" feature="Transferring entries between sections" />

Entries in [channel](#channels) and [structure](#structures) sections cane be moved to other sections that support the same [entry type](#entry-types). Use the **Move to…** element action from any entry element index, then select the new section. If the action is disabled, the entry has no suitable targets—you may be able to change its entry type _in-situ_, reconcile any custom field changes, then move it to a compatible section.

When moving an entry, it’s important to note these behaviors:

- If the new section is a structure, the entry will be placed at the root, according to its **Default Entry Placement** setting.
- Drafts and revisions will be moved along with the entry and remain accessible, but only drafts that use an entry type that is allowed in the new section can be restored—same as if an entry type were _removed_ from a section.
- If the new section has a lower **Max authors** setting, author data will remain intact and produce a validation error when saved.
- Authors who don’t have access to the new section will also be removed, the next time the entry is saved. Permissions are still checked based on the section, not authorship.
- Singles will never appear as targets for moving an entry.

## Nested Entries

Entries also power the [Matrix](../field-types/matrix.md) and [CKEditor](plugin:ckeditor) fields, which means your [entry types](#entry-types) can represent entire pages, or the building blocks thereof. How you implement your content model and authoring experience is entirely up to you!

Nested entries are an implementation of nested _elements_, a broader category of “owned” elements that includes [addresses](addresses.md) and powers Commerce’s product and variant architecture.

## Editing Entries

If you have at least one section, there will be an **Entries** menu item in the primary control panel navigation. Clicking on it will take you to the entry [index](../../system/elements.md#indexes). From there, you can navigate to the entry you wish to edit, or create a new one.

Depending on your section’s settings, can perform some or all of the following actions from any entry’s edit screen:

- Choose the entry type (if there is more than one to choose from);
- Edit the entry’s **Title**, **Slug**, and [custom field](../../system/fields.md) values;
- Choose the entry’s **Authors** <Badge type="edition" vertical="middle" title="Authors are a feature of Craft Team">Team</Badge> <Badge type="edition" vertical="middle" title="Authors are a feature of Craft Pro">Pro</Badge>;
- Choose the entry’s **Parent** (if it’s within a [Structure](#structures) section);
- Set the entry’s **Post Date** (when it will be considered published);
- Set the entry’s **Expiration Date** (optional);
- Choose whether the entry is **Enabled** or not (globally, and/or per-site);
- Save changes to the entry;
- Save a new [draft](#drafts) of the entry;
- View [revisions](#revisions) of the entry;
- Apply changes from a derivative (draft or revision);

::: tip
If you leave the **Post Date** blank, Craft will automatically set it the first time an entry is saved as enabled.
:::

<See path="../../system/drafts-revisions.md" />

### Entry Creation

As soon as you click **New entry**, Craft creates an empty entry, and redirects you to its edit screen. This gives the system a place to auto-save your edits—effectively a new entry represented only as a [draft](#drafts). Internally, this is called a “fresh” entry.

Once you add some content to a fresh entry (or explicitly choose **Save draft** from the **Create entry** menu), Craft marks the draft as having been saved, and will expose it in element indexes when using the **All** or **Draft** status options.

::: tip
Stray drafts (those that were created but never edited or explicitly saved) are automatically [garbage-collected](../../system/gc.md), respecting the <config5:purgeUnsavedDraftsDuration> setting.
:::

The entry editing lifecycle is designed to provide authors clear, actionable information about the state of their content, and to prevent unintended loss. Let’s look more closely at a few supporting features.

### Drafts

As soon as you alter a field on an entry, Craft auto-saves the changes as a [provisional draft](../../system/drafts-revisions.md#provisional-drafts).

![Screenshot of an entry with unsaved changes](../../images/entries-edit-provisional.png)

Subsequent edits are also saved to your provisional draft, and made available any time you view that entry in the control panel. Each user gets their own provisional draft, so your changes are private.

Pressing the **Save** button applies changes from a provisional draft to its _canonical_ entry, and creates a _revision_ (if its section supports revisions).

If you aren’t ready to publish your changes, you can instead press **Create a Draft** to save your work as a new _draft_. You may have as many regular drafts as you wish—and those drafts can have their own name and notes to help you track what you’re working on. The name of your current draft (if any) is shown at the top of the edit screen in the [revision](#revisions) menu.

::: warning
Your drafts may be visible to (and editable by) other users! While an auto-saved _provisional_ draft is always private, the visibility of _saved_ drafts is governed by users’ [permissions for the entry’s section](../../system/user-management.md#permissions).
:::

While Craft’s auto-saving behavior creates a provisional draft from the canonical entry, edits to an existing, explicitly-saved draft are saved directly to that draft—in other words, Craft doesn’t create drafts for another draft!

When your edits are ready to be published, press **Apply draft** to merge the changes into the canonical entry.

### Revisions

Any time you apply a draft (provisional or otherwise) to the canonical entry, Craft creates a _revision_. Revisions track which fields and attributes changed each time the canonical entry is updated, and provide a means to revert to previous versions of an entry. Drafts and revisions both have a `creator` property that stores what user initiated the update separately from the “author.”

::: tip
The revision menu only displays the ten most recent revisions. Older revisions are available via the **View all revisions &rarr;** link at the bottom of the menu.

Any time a revision is created, Craft pushes a job into the [queue](../../system/queue.md) to ensure the oldest one(s) are pruned (if there are more revisions than allowed by the <config5:maxRevisions> setting).
:::

#### Querying for Revisions

You can [find](#querying-entries) drafts and revisions of a specific entry using the [draftOf()](#draftof) and [revisionOf()](#revisionof) query params.

### Trash

All [elements](../../system/elements.md) support _soft-deletion_. When you delete an entry, its `dateDeleted` property is set to the current time, and Craft excludes it from results—unless the [`trashed` query param](#trashed) is used. Similarly, when restoring a deleted entry, its `dateDeleted` is set to `null`.

::: warning
Entries remain in the “trashed” state until they are manually hard-deleted from the control panel or their `dateDeleted` is longer ago than the <config5:softDeleteDuration> setting when [garbage collection](../../system/gc.md) runs.

**The trash should not be used to temporarily remove content from your site.** Restoring trashed entries is only intended as a means to recover inadvertently-deleted content—instead, use the global or site-specific **Enabled** settings. Entries can remain disabled indefinitely.
:::

### Activity

Craft keeps track of user activity on entries, and will push presence pips and notifications to anyone working with drafts of the same entry.

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/entries/blog/247"
  :link="false"
  caption="Other users editing the same entry will appear in the page header. TJ has corrected the page title in a draft.">
<img src="../../images/entries-edit-activity.png" alt="Screenshot of the entry edit screen with other active users">
</BrowserShot>

Notifications will appear in the bottom-left corner along with other flashes, and prompt you to reload the entry if it has changed since you opened it. This can play out in a couple ways:

- If another user applied a draft to the canonical entry while you were working on a provisional draft, Craft will merge all non-conflicting edits into your provisional draft. In situations where you both made changes to a field, Craft keeps your changes.
- If only the other user made a change, the page simply refreshes to show the new canonical entry content.

::: tip
Automatic merging of changes from canonical entries is nondestructive, and non-optional. Merging occurs just before an entry’s edit screen is viewed.
:::

### Copying Entries <Since ver="5.7.0" feature="Copying entries" />

Entries can be copied and pasted between sections and fields that support the given type(s).

<See path="../../system/elements.md" hash="copying-elements" label="Copying Elements" description="Learn how to copy entries and other elements between contexts." />

## Statuses

In addition to the [base element statuses](../../system/elements.md#statuses), entries may appear in any of these states:

- **Pending** (`pending`) — The **Post Date** is in the future, or not set.
- **Expired** (`expired`) — The **Expiry Date** is set, and in the past.
- **Live** (`live`) — The **Post Date** is in the past, and the **Expiry Date** is in the future (if set at all). This is the default status used in entry queries.

::: tip
Status pips and controls may be hidden from element edit screes, indexes, chips, and cards, if an entry’s type has the **Show the Status field** setting _off_.
:::

When [querying entries by status](../../system/elements.md#querying-by-status), keep in mind that each status identifier in the list above represents multiple conditions. Statuses and their default query conditions help make the appearance or availability of entries consistent between the control panel and front-end; for this reason, params like `.postDate()` and `.expiryDate()` introduce _additional_ constraints, rather than replacing Craft’s. If you need full control over the query constraints, call `.status(null)`.

### Static Statuses <Since ver="5.7.0" feature="Static storage of entry statuses" />

Craft’s powerful [events](../../extend/events.md) system allows developers to react to element updates, and connect author activity and content to other systems. Statuses, however, can be difficult to pin down—entries rely heavily on their **Post Date** and **Expiry Date** attributes to determine when an entry is returned, and what its “status” is at any given time.

Take this query that fetches blog articles:

```twig
{% set posts = craft.entries()
  .section('blog')
  .all() %}
```

Suppose we have an article with a **Post Date** five minutes in the future. Loading the page with this query _now_ would not display the pending article; if we wait five minutes and refresh the page, the entry _does_ show up… without any intervention by the author! This is because each query compares the server’s current time with entries’ stored `postDate` and `expiryDate` columns; depending on when you look at the data, Craft considers it to be in different statuses. Therein lies the issue: nothing _happens_ when a pending entry “goes live” (or a live entry “expires”), so Craft can’t emit status-change events.

The <config5:staticStatuses> config setting alters this behavior: instead of calculating statuses on-the-fly, Craft stores a static representation of an entry’s status at the time it is saved. Entry queries also use simplified conditions, matching against the stored values instead of date-based comparisons. In this mode, however, entries’ statuses only change when they are saved. The accompanying [`update-statuses` console command](../cli.md#update-statuses) provides a means of routinely checking and re-saving entries:

```bash
ddev craft update-statuses
```

::: warning
If you opt in to static statuses, you must run this command with a tool like [cron](https://en.wikipedia.org/wiki/Cron) to ensure your content is published and expired in a reasonable amount of time.
:::

In a [private plugin](../../extend/plugin-guide.md) or [custom module](../../extend/module-guide.md), you can [listen for save events](kb:handling-entry-saves) and check whether an entry received a new status:

```php
use craft\base\Event;
use craft\elements\Entry;
use craft\events\ModelEvent;
use craft\helpers\ElementHelper;

Event::on(
    Entry::class,
    Entry::EVENT_AFTER_SAVE,
    function (ModelEvent $event) {
        /** @var Entry $entry */
        $entry = $event->sender;

        // Make sure we’re dealing with a canonical entry, and that there was indeed a status change:
        if (
            !ElementHelper::isDraftOrRevision($entry) &&
            $entry->getStatus() !== $entry->oldStatus
        ) {
            if ($entry->getStatus() === Entry::STATUS_LIVE) {
                // The entry just moved into the "live" status!
            } elseif ($entry->oldStatus === Entry::STATUS_LIVE) {
                // The entry *was* live, but isn’t any more!
            }
        }
    });
```

Depending on your editorial process, you will need to adjust the cases here to handle different transitions. Keep in mind that this handler may also run in response to normal entry saves (during an HTTP request) so it is advisable to offload any time- or resource-intensive operations to a [queue job](../../extend/queue-jobs.md).

## Querying Entries

When Craft receives a request matching an entry’s URI, it automatically makes an `entry` variable available. Everywhere else in your front-end (or PHP code), you can fetch entries using **entry queries**.

::: code
```twig
{# Create a new entry query #}
{% set myEntryQuery = craft.entries() %}
```
```php
// Create a new entry query
$myEntryQuery = \craft\elements\Entry::find();
```
:::

Once you’ve created an entry query, you can set [parameters](#parameters) on it to narrow down the results, and then [execute it](../../development/element-queries.md#executing-element-queries) by calling `.one()` or `.all()` to return a single [Entry](craft5:craft\elements\Entry) object or an array of them, respectively.

::: warning
Nested entries _may_ show up unexpectedly in some entry queries—particularly those that don’t filter by `.section()`. If you want to return only entries _without_ owners, you can use `.section('*')`. <Since ver="5.2.0" feature="Querying for non-nested entries with the special “section wildcard”" />
:::

<See path="../../development/element-queries.md" label="Introduction to Element Queries" description="Learn more about how element queries work." />

### Example

We can display the 10 most recent entries in a “Blog” section by doing the following:

1. Create an entry query with `craft.entries()`.
2. Set the [section](#section) and [limit](#limit) parameters on it.
3. Fetch the entries with `.all()`.
4. Loop through the entries using a [for](https://twig.symfony.com/doc/3.x/tags/for.html) tag to output the blog post HTML.

```twig
{# Create an entry query with the 'section' and 'limit' parameters #}
{% set myEntryQuery = craft.entries()
  .section('blog')
  .limit(10) %}

{# Fetch the entries #}
{% set entries = myEntryQuery.all() %}

{# Display the entries #}
{% for entry in entries %}
  <article>
    <h1><a href="{{ entry.url }}">{{ entry.title }}</a></h1>
    {{ entry.summary }}
    <a href="{{ entry.url }}">Continue reading</a>
  </article>
{% endfor %}
```

### Parameters

Entry queries support the following parameters:

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/entries.md)!!!
</file>

<file path="reference/element-types/globals.md">
---
description: Make important content available anywhere.
containsGeneratedContent: yes
related:
  - uri: ../../system/elements.md
    label: Introduction to Elements
---

# Globals

Globals store content that is available globally throughout your templates but is not tied to any one URL.

<!-- more -->

Craft organizes globals into global sets. Each global set has its own [field layout](../../system/fields.md#field-layouts) and can use any of the built-in or plugin-provided custom fields.

To create a global get, go to **Settings** → **Globals**.

If you have at least one Global Set, Craft will add a new “Globals” item to the main control panel navigation. Clicking this will take you to a page that lists all your global sets in a sidebar, as well as all of the fields associated with the selected global set in the main content area.

::: tip
Unlike [entries](entries.md#entries), global sets don’t have the Live Preview feature, since they aren’t associated with any one particular URL.
:::

<Block label="Migrating to Singles">

With the release of Craft 4.4, we began consolidating features of [other element types](../../system/elements.md) into [entries](entries.md).

As part of that process, we introduced a [console command](../cli.md#entrify-global-set) that can automate the conversion of global sets to entries:

```bash
php craft entrify/global-set myGlobalSetHandle
```

You will be given an opportunity to migrate the global set into a new or existing [single](entries.md#singles). The **Title** field (and **Status** controls) for the single’s new entry type will be disabled, to maintain parity with the legacy globals interface.

Read more about this [transition](https://craftcms.com/blog/entrification) on our blog.

</Block>

## Global Sets in Templates

You can access your global sets from any template via their handles.

If you have a global set with the handle `companyInfo` and it has a field with the handle `yearEstablished`, you can access that field anywhere using this code:

```twig
{{ companyInfo.yearEstablished }}
```

For additional global set properties you can use besides your custom fields see <craft5:craft\elements\GlobalSet> for a full reference.

### Manually Loading Global Sets

In some special situations, like within email templates, global sets won’t be available by default. Any global set may still be loaded manually. The above example could be loaded with `getSetByHandle()`:

::: code
```twig
{% set companyInfo = craft.app.globals().getSetByHandle('companyInfo') %}
```
```php
$companyInfo = \Craft::$app->getGlobals()->getSetByHandle('companyInfo');
```
:::

More details are available in the [Globals service class documentation](craft5:craft\services\Globals).

## Global Sets with Multiple Sites

If you run multiple sites with Craft, global sets are available in all sites. However, you can set the values in those sets on a per site basis, even leaving some fields blank, if desired.

To do that, edit the global set’s fields, and make sure that their “Translation Method” settings are set to “Translate for each site”.

To toggle between sites while viewing global sets, use the dropdown menu at the top left of the global sets page in the control panel.

![Toggling between sites in Globals](../../images/globals-multisite-nav.png)

## Querying Globals

You can fetch global sets in your templates or PHP code using **global set queries**.

::: code
```twig
{# Create a new global set query #}
{% set myGlobalSetQuery = craft.globalSets() %}
```
```php
// Create a new global set query
$myGlobalSetQuery = \craft\elements\GlobalSet::find();
```
:::

Once you’ve created a global set query, you can set [parameters](#parameters) on it to narrow down the results, and then [execute it](../../development/element-queries.md#executing-element-queries) by calling `.all()`. An array of [GlobalSet](craft5:craft\elements\GlobalSet) objects will be returned.

<See path="../../development/element-queries.md" label="Introduction to Element Queries" description="Learn more about how element queries work." />

### Example

We can load a global set from the primary site and display its content by doing the following:

1. Create a global set query with `craft.globalSets()`.
2. Set the [handle](#handle) and [siteId](#siteid) parameters on it.
3. Fetch the global set with `.one()`.
4. Output its content.

```twig
{# Create a global set query with the 'handle' and 'siteId' parameters #}
{% set myGlobalSetQuery = craft.globalSets()
  .handle('footerCopy')
  .siteId(1) %}

{# Fetch the global set #}
{% set globalSet = myGlobalSetQuery.one() %}

{# Display the content #}
<p>{{ globalSet.copyrightInfo }}</p>
```

::: tip
All global sets are already available as global variables to Twig templates. So you only need to fetch them through  `craft.globalSets()` if you need to access their content for a different site than the current site.
:::

### Parameters

Global set queries support the following parameters:

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/globals.md)!!!
</file>

<file path="reference/element-types/README.md">
# Element Types

Use the sidebar to find information about a specific element type, or learn about [elements](../../system/elements.md) in the **System** section.

<!-- more -->

<See path="../../system/elements.md" label="Introduction to Elements" description="Read about elements, Craft’s content containers." />

<hr>

<See path="addresses.md" />

<See path="assets.md" />

<See path="categories.md" />

<See path="entries.md" />

<See path="globals.md" />

<See path="tags.md" />

<See path="users.md" />

<hr>

::: tip
Looking for [Matrix](../field-types/matrix.md) blocks? They were converted to [entries](entries.md#nested-entries) during the [upgrade](../../upgrade.md) to Craft 5!
:::
</file>

<file path="reference/element-types/tags.md">
---
description: Define flat “folksonomies” to organize content, as it grows.
containsGeneratedContent: yes
related:
  - uri: ../../system/elements.md
    label: Introduction to Elements
  - uri: ../reference/field-types/tags.md
    label: Tags Fields
---

# Tags

You can create folksonomies for your [entries](entries.md), [users](users.md), and [assets](assets.md) using Tags. Tags are another type of [element](../../system/elements.md).

<!-- more -->

<Block label="Migrating to Channels">

With the release of Craft 4.4, we began consolidating features of [other element types](../../system/elements.md) into [entries](entries.md).

::: warning
A comparable [tags field](../field-types/tags.md) UI has not yet been introduced for entries. If you or your clients value this authoring experience, it is safe to continue using tags!
:::

As part of that process, we introduced a [console command](../cli.md#entrify-categories) that can automate the conversion of tags to [channel sections](entries.md#channels):

```bash
php craft entrify/tags myTagGroupHandle
```

Read more about this [transition](https://craftcms.com/blog/entrification) on our blog.

</Block>

## Tag Groups

Before you can create tags, you must create Tag Groups to contain them.

To create a new tag group, go to **Settings** → **Tags** and click **New Tag Group**.

Each tag group holds a unique set of tags, and lets you define a custom set of [fields](../../system/fields.md) that should be available to tags within the group. However, you don’t need to assign any fields to the Tag Group Field Layout in order to use the group.

::: tip
There is no centralized editing view for tags (like there is for other element types), so fields you attach will only be editable via a [slideout](../../system/control-panel.md#slideouts), after a tag has been created and assigned to a tag field.
:::

## Assigning Tags

To assign tags to things (like Entries), you must create a [Tags field](../field-types/tags.md) and add it to a Field Layout.

Each Tags field is connected to a single tag group. Whatever you attach the field to (entries, assets, users, etc.) will be able to create new tags and create [relations](../../system/relations.md) to any of the tags within that group.

## Querying Tags

You can fetch tags in your templates or PHP code using a tag query.

::: code
```twig
{# Create a new tag query #}
{% set myTagQuery = craft.tags() %}
```
```php
// Create a new tag query
$myTagQuery = \craft\elements\Tag::find();
```
:::

Once you’ve created a tag query, you can set [parameters](#parameters) on it to narrow down the results, and then [execute it](../../development/element-queries.md#executing-element-queries) by calling `.all()`. An array of [Tag](craft5:craft\elements\Tag) objects will be returned.

::: tip
See [Element Queries](../../development/element-queries.md) to learn about how element queries work.
:::

### Example

We can display a list of the tags in a “Blog Tags” tag group by doing the following:

1. Create a tag query with `craft.tags()`.
2. Set the [group](#group) parameter on it.
3. Fetch the tags with `.all()`.
4. Loop through the tags using a [for](https://twig.symfony.com/doc/3.x/tags/for.html) tag to create the list HTML.

```twig
{# Create a tag query with the 'group' parameter #}
{% set myTagQuery = craft.tags()
  .group('blogTags') %}

{# Fetch the tags #}
{% set tags = myTagQuery.all() %}

{# Display the tag list #}
<ul>
  {% for tag in tags %}
    <li><a href="{{ url('blog/tags/'~tag.id) }}">{{ tag.title }}</a></li>
  {% endfor %}
</ul>
```

### Parameters

Tag queries support the following parameters:

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/tags.md)!!!
</file>

<file path="reference/element-types/users.md">
---
description: Manage and personalize access to your platform.
containsGeneratedContent: yes
related:
  - uri: ../../system/elements.md
    label: Introduction to Elements
  - uri: ../../system/user-management.md
    label: Managing Users
  - uri: ../field-types/users.md
    label: Users Fields
---

# Users

A user is a special type of element that represents a person.

<!-- more -->

Each user has an email address and username by default, as well as optional fields for a name and photo. Like other [elements](../../system/elements.md), users support custom fields by way of a [field layout](#custom-fields).

<BrowserShot url="https://my-project.ddev.site/admin/users/myaccount" :link="false" caption="Custom fields can be added to the “Profile” screen.">
<img src="../../images/users-profile.png" alt="Screenshot of the user profile edit screen" />
</BrowserShot>

There are also **Preferences** for localization, accessibility, and debugging that may be relevant depending on how you build your site and whether you grant the user access to the control panel. Users’ capabilities are determined by which [groups](../../system/user-management.md#user-groups) they belong to, and what individual [permissions](../../system/user-management.md#permissions) they have been granted.

<See path="../../system/user-management.md" label="User Management" description="Learn more about setting up secure multi-user experiences." />

### Custom Fields

All users share a [field layout](../../system/fields.md#field-layouts), which is managed via <Journey path="Settings, Users, User Profile Fields" />. Custom fields are added to the **Profile** tab of each user’s management screen, alongside native **Username**, **Email**, **Full Name**, and **Photo** fields.

Fields and tabs in the user field layout can be given [conditions](../../system/fields.md#conditions) to provide special functionality based on their user group or other criteria.

::: tip
Relate users to other elements with the [users field](../field-types/users.md).
:::

### Photos

Once you’ve configured an [asset volume](assets.md#volumes), you can designate it as your **User Photo Volume** by visiting <Journey path="Settings, Users, Settings" />. User photos are uploaded directly to their profiles, and cannot be picked from existing assets.

The [asset element](assets.md) attached to a user is accessible via the `photo` property:

```twig{1,6}
{% set photo = user.photo %}

<div class="profile">
  {% if photo %}
    <div class="photo">
      {{ photo.getImg('thumbnail') }}
    </div>
  {% endif %}

  <h3>{{ user.fullName }}</h3>

  <code>{{ user.email }}</code>
</div>
```

Here, `thumbnail` is a [predefined image transform](assets.md#image-transforms).

### Addresses

Users each have an address book. [Addresses](addresses.md) can be managed on behalf of a user via the control panel, or [by the user themselves](addresses.md#managing-addresses).

![Screenshot of address management UI on an individual user’s edit screen](../../images/users-addresses-tab.png)

Access a user’s addresses via the `addresses` property:

```twig{4}
<h2>Address Book</h2>

<ul>
  {% for address in user.addresses %}
    <li>{{ address|address }}</li>
  {% endfor %}
</ul>
```

### Authors

[Entries](entries.md) can be assigned one or more users as their **Authors**.

```twig
<h2>{{ entry.title }}</h2>

By {{ collect(entry.authors).pluck('fullName').join(', ', ', and ') }}

{# ... #}
```

### URLs

Unlike most other element types, users do _not_ have a “URI format” setting or support slugs, and are not factored into routing.

### Affiliated Site <Since ver="5.6.0" feature="Affiliated sites for user elements" />

[Multi-site](../../system/sites.md) projects capture the site a user [registers](../../system/user-management.md#affiliated-site) from (or is assigned to by an admin). Add the **Affiliated Site** [field layout element](#custom-fields) to manage this in the control panel.

A user’s affiliated site can be accessed in a template via `user.affiliatedSite`:

```twig
{% if currentUser.affiliatedSite %}
  You registered via {{ currentUser.affiliatedSite.name }}.
{% endif %}
```

## Querying Users

You can fetch users in your templates or PHP code using **user queries**.

::: code
```twig
{# Create a new user query #}
{% set myUserQuery = craft.users() %}
```
```php
// Create a new user query
$myUserQuery = \craft\elements\User::find();
```
:::

Once you’ve created a user query, you can set [parameters](#parameters) on it to narrow down the results, and then [execute it](../../development/element-queries.md#executing-element-queries) by calling `.all()`. An array of [User](craft5:craft\elements\User) objects will be returned.

::: tip
See [Element Queries](../../development/element-queries.md) to learn about how element queries work.
:::

### Example

We can display a list of the users in a “Members” [user group](../../system/user-management.md#user-groups) by doing the following:

1. Create a user query with `craft.users()`.
2. Set the [group](#group) parameter on it.
3. Fetch the users with `.all()`.
4. Loop through the users using a [for](https://twig.symfony.com/doc/3.x/tags/for.html) tag to create the list HTML.

```twig
{# Create a user query with the 'group' parameter #}
{% set myUserQuery = craft.users()
  .group('members') %}

{# Fetch the users #}
{% set members = myUserQuery.all() %}

{# Display the list #}
<ul>
  {% for user in members %}
    <li>{{ user.fullName }} (Member since {{ user.dateCreated|date }})</li>
  {% endfor %}
</ul>
```

### Parameters

User queries support the following parameters:

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/users.md)!!!
</file>

<file path="reference/field-types/addresses.md">
---
related:
  - uri: link.md
    label: Link fields
---

# Addresses Fields

The **Addresses** field is similar to a [Matrix](matrix.md) field, but it manages nested [address elements](../element-types/addresses.md) instead of [entries](../element-types/entries.md). When you create an address it is “owned” by the element that field is attached to. Address fields are _not_ [relational fields](../../system/relations.md#custom-fields).

::: tip
Address fields are separate from users’ [address book](../element-types/users.md#addresses), and can be added to any element type!
:::

<BrowserShot url="https://my-project.ddev.site/admin/entries/vendors/123" :link="false">
<img src="../../images/fields-addresses.png" alt="Screenshot of addresses field with two nested address elements" />
</BrowserShot>

Addresses can be [copied](../../system/elements.md#copying-elements) between fields, and to or from users’ address books. <Since ver="5.7.0" feature="Copying-and-pasting address elements" />

## Settings

Address fields can be displayed to editors as [cards](../../system/elements.md#chips-cards) or in a full [element index](../../system/elements.md#indexes). Either way, individual addresses are always displayed as cards.

You can also choose a minimum and maximum number of addresses that can be added to the field for the owner element to validate.

## Development

Like Matrix and [relational fields](../../system/relations.md#fields), address field data is provided as an [element query](../../development/element-queries.md) or [element collection](../../development/collections.md#element-collections).

Typically, you will access addresses attached to an element via the field’s handle followed by a query execution method like `.all()`:

```twig
{% set addresses = entry.contacts.all() %}

<h2>Contacts</h2>

<ul>
  {% for address in addresses %}
    <li>{{ address|address }}</li>
  {% endfor %}
</ul>
```

<See path="../element-types/addresses.md" label="Addresses" description="Learn more about managing and displaying address data." />

### GraphQL

Nested address elements are available via [GraphQL](../../development/graphql.md) anywhere you have access to their owners. Address properties are retrieved piecemeal:

```graphql{7-24}
query StationsQuery {
  entries(section: "weatherBeacons") {
    title
    id
    ... on station_Entry {
      location {
        addressLine1
        addressLine2
        addressLine3
        administrativeArea
        dependentLocality
        countryCode
        locality
        postalCode
        sortingCode

        fullName
        firstName
        lastName
        organization
        organizationTaxId

        latitude
        longitude
      }
    }
  }
}
```

Not all properties will contain data, due to differences in international storage and formatting. [Address formatters](../element-types/addresses.md#address-formatter) are not available via GraphQL, so you are responsible for handling variations in the returned data.

With the admin-only **Full Schema**, you may directly query for one or more addresses using the `address()` and `addresses()` queries:

```graphql
query Headquarters {
  address(id: 123) {
    addressLine1
    # ...
  }
}
```

```graphql
query MyAddresses {
  addresses(ownerId: 123) {
    addressLine1
    # ...
  }
}
```

::: tip
In public and custom schemas, addresses are only accessible via their owners.
:::
</file>

<file path="reference/field-types/assets.md">
---
related:
  - uri: ../element-types/addresses.md
    label: Address Elements
  - uri: ../../system/relations.md
    label: Using Relationships
  - uri: link.md
    label: Link fields
---

# Assets Fields

Assets fields allow you to upload and relate [assets](../element-types/assets.md) to other elements. It is one of Craft’s [relational](../../system/relations.md) custom fields.

<!-- more -->

## Settings

Assets fields have the following settings:

- **Restrict uploads to a single folder?** – Whether file uploads/relations should be constrained to a single folder.

  If enabled, the following setting will be visible:

  - **Asset Location** – A specific volume and folder from which assets can be selected (and into which assets uploaded directly to the field are saved). The path portion of this setting is evaluated as an [object template](../../system/object-templates.md).

  If disabled, the following settings will be visible:

  - **Sources** – Which asset volumes (or other asset index [sources](../../system/elements.md#sources)) the field should be able to relate assets from.
  - **Default Upload Location** – The default volume and path that files are stored in when uploaded directly to the field. This setting is evaluated as an [object template](../../system/object-templates.md).

- **Restrict allowed file types?** Whether the field should only be able to upload/relate files of a certain type(s).
- **Limit** – The maximum number of assets that can be related with the field at once. (Default is no limit.)
- **View Mode** – How the field should appear for authors.
- **“Add” Button Label** – The label that should be used on the field’s selection button.
- **Validate related assets** — Whether or not validation errors on the related assets will be bubbled up.
- **Preview Mode** — How this field’s values are displayed when included on element indexes.

### Multi-Site Settings

On multi-site installs, the following settings will also be available:

- **Translation Method** — How relationships are handled when [propagating changes to other sites](../../system/fields.md#translation-methods).
- **Relate assets from a specific site?** — Whether to only allow relations to assets from a specific site.
  - If _enabled_, a new setting will appear where you can choose which site.
  - If _disabled_, related assets will always be pulled from the current site.

- **Show the site menu** — Whether to display the site menu in asset selection modals. (This setting is hidden when relations are locked to a single site.)

<See path="../../system/fields.md" hash="translation-methods" label="Translation Methods" description="Learn about options for translating field values." />

### Dynamic Subfolder Paths

Subfolder paths defined by the **Upload Location** and **Default Upload Location** settings are [object templates](../../system/object-templates.md). Any properties supported by the source element (the element that has the assets field) can be used here.

::: warning
Be aware that _fields are reusable_, and can be added to [nested](#nested-elements) _and_ non-nested elements’ field layouts—and on different element types! Constructing a subfolder template that works in all contexts (and is readable and reliable) can be challenging—consider maintaining separate fields to avoid this complexity.
:::

#### IDs and UIDs

If you want to include an element’s ID or UID in a dynamic subfolder path, use `{canonicalId}` or `{canonicalUid}` rather than `{id}` or `{uid}`, so the source element’s ID or UID is used rather than the those of a draft or revision.

#### Nested Elements

If an Assets field is used by an [entry type](../element-types/entries.md#entry-types) within a [Matrix field](matrix.md), the source element will be the nested entry, _not_ the element that the entry belongs to. This means that assets attached to different nested entries may end up in different folders!

In these situations, you should use `owner.someElementProperty` instead of just `someElementProperty`; the previous example would become `owner.canonicalId` or `owner.canonicalUid`.

#### Conditional Path Segments

If a rendered subfolder path ends up blank or contains a leading, trailing, or double forward slash (e.g. `/bar/baz`, `foo/`, or `foo//bar`), Craft considers it invalid. When you suspect a value it depends on may not be available, output `:ignore:`. Suppose you want to output the first selected category, or nothing (when one isn’t selected):

```twig
blog/{{ categoriesFieldHandle.one().slug ?? ':ignore:' }}/{canonicalId}
```

This is equivalent to conditionally outputting the slashes as part of a value:

```twig
blog/{{ categoriesFieldHandle.exists() ? "#{categoriesFieldHandle.one().slug}/" : null }}{canonicalId}
```

## The Field

Assets fields list all the currently-related assets, with a button to select new ones.

Choosing **Add an asset** will bring up a modal window where you can find and select additional assets, as well as upload new ones.

::: tip
You can also upload assets by dragging files directly onto the assets field, or into the modal window.
:::

### Inline Asset Editing

Double-click on a related asset to edit it in a [slideout](../../system/control-panel.md#slideouts).

::: tip
You can choose which custom fields should be available for assets in each volume from **Settings** → **Assets** → **[Volume Name]** → **Field Layout**.
:::

## Development

Asset fields have similar features to other [relational fields](../../system/relations.md).

### Querying Elements with Assets Fields

When [querying for elements](../../development/element-queries.md) that may have an assets field, you can use values compatible with [relational query params](../../system/relations.md) to narrow the results:

| Value | Fetches elements…
| - | -
| `':empty:'` | that don’t have any related assets.
| `':notempty:'` | that have at least one related asset.
| `100` | that are related to the asset with an ID of 100.
| `[100, 200]` | that are related to an asset with an ID of 100 _or_ 200.
| `[':empty:', 100, 200]` | with no related assets, or are related to an asset with an ID of 100 _or_ 200.
| `['and', 100, 200]` | that are related to the assets with IDs of 100 and 200.
| one or more [Asset](craft5:craft\elements\Asset) elements | that are related to the asset/assets.
| an [AssetQuery](craft5:craft\elements\db\AssetQuery) object | that are related to any of the resulting assets.

In this example, we’re querying for other “product” entries that reference the same document:

```twig
{% set document = entry.materialDisclosures.one() %}

{% set similarProducts = craft.entries()
  .section('products')
  .materialDisclosures(document)
  .all() %}
```

::: tip
Exclude the current entry by setting `.id(['not', entry.id])` to the query!
:::

You might also want to search for elements that have (or _don’t_ have) assets attached to a specific field:

```twig
{# Products for which documentation of hazardous materials is provided: #}
{% set potentiallyDangerousProducts = craft.entries()
  .section('products')
  .materialDisclosures(':notempty:')
  .all() %}

{# Products that have no disclosures: #}
{% set probablySafeProducts = craft.entries()
  .section('products')
  .materialDisclosures(':empty:')
  .all() %}
```

### Working with Assets Field Data

If you have an element with an Assets field in your template, you can access its related assets using your Assets field’s handle:

::: code
```twig
{% set query = entry.myFieldHandle %}
```
```php
$query = $entry->myFieldHandle;
```
:::

That will give you an [asset query](../element-types/assets.md#querying-assets), prepped to output all the related assets for the given field.

To loop through all the related assets, call [all()](craft5:craft\db\Query::all()) and then loop over the results:

::: code
```twig
{% set relatedAssets = entry.myFieldHandle.all() %}
{% if relatedAssets|length %}
  <ul>
    {% for rel in relatedAssets %}
      <li><a href="{{ rel.url }}">{{ rel.filename }}</a></li>
    {% endfor %}
  </ul>
{% endif %}
```
```php
$relatedAssets = $entry->myFieldHandle->all();

if (count($relatedAssets)) {
    foreach ($relatedAssets as $rel) {
        // do something with $rel->url and $rel->filename
    }
}
```
:::

::: warning
When using `asset.url` or `asset.getUrl()`, the asset’s source volume must have **Assets in this volume have public URLs** enabled and a **Base URL** setting. Otherwise, the result will always be empty.
:::

If you only want the first related asset, call [one()](craft5:craft\db\Query::one()) instead and make sure it returned something:

::: code
```twig
{% set rel = entry.myFieldHandle.one() %}
{% if rel %}
  <p><a href="{{ rel.url }}">{{ rel.filename }}</a></p>
{% endif %}
```
```php
$rel = $entry->myFieldHandle->one();
if ($rel) {
    // do something with $rel->url and $rel->filename
}
```
:::

If you need to check for related assets without fetching them, you can call [exists()](craft5:craft\db\Query::exists()):

::: code
```twig
{% if entry.myFieldHandle.exists() %}
  <p>There are related assets!</p>
{% endif %}
```
```php
if ($entry->myFieldHandle->exists()) {
    // do something with related assets
}
```
:::

You can set [parameters](../element-types/assets.md#parameters) on the asset query as well. For example, to ensure that only images are returned, you can set the [kind](../element-types/assets.md#kind) param:

::: code
```twig
{% set relatedAssets = entry.myFieldHandle
  .kind('image')
  .all() %}
```
```php
$relatedAssets = $entry->myFieldHandle
    ->kind('image')
    ->all();
```
:::

### Saving Assets Fields

If you have an element form, such as an [entry form](kb:entry-form), that needs to contain an Assets field, you will need to submit your field value as a list of asset IDs in the order you want them to be related.

For example, you could create a list of checkboxes for each of the possible relations:

```twig
{# Include a hidden input first so Craft knows to update the existing value
   if no checkboxes are checked. #}
{{ hiddenInput('fields[myFieldHandle]', '') }}

{# Get all of the possible asset options #}
{% set possibleAssets = craft.assets()
  .volume('siteAssets')
  .kind('image')
  .orderBy('filename ASC')
  .withTransforms([{ width: 100, height: 100 }])
  .all() %}

{# Get the currently related asset IDs #}
{% set relatedAssetIds = entry is defined
  ? entry.myFieldHandle.ids()
  : [] %}

<ul>
  {% for possibleAsset in possibleAssets %}
    <li>
      <label>
        {{ input(
          'checkbox',
          'fields[myFieldHandle][]',
          possibleAsset.id,
          { checked: possibleAsset.id in relatedAssetIds }
        ) }}
        {{ tag('img', { src: possibleAsset.url }) }}
        {{ possibleAsset.getImg({ width: 100, height: 100 }) }}
        {{ possibleAsset.filename }}
      </label>
    </li>
  {% endfor %}
</ul>
```

You could then make the checkbox list sortable, so users have control over the order of related assets.

#### Creating New Assets

Assets fields can handle new file uploads as well:

```twig
{{ input('file', 'fields[myFieldHandle][]', options={
  multiple: true,
}) }}
```

::: tip
Don’t forget to set `enctype="multipart/form-data"` on your `<form>` tag so your browser knows to submit the form as a multipart request.
:::

Alternatively, you can submit base64-encoded file data, which the Assets field will decode and treat as an uploaded file. To do that, you have to specify both the data and the filename like this:

```twig
{{ hiddenInput(
  'fields[myFieldHandle][data][]',
  'data:image/jpeg;base64,my-base64-data'
) }}
{{ hiddenInput('fields[myFieldHandle][filename][]', 'myFile.ext') }}
```

However you upload new assets, you may want to maintain any that already exist on the field and append new ones to the set instead of replacing it.

You can do this by passing each of the related asset IDs in the field data array, like we are here with hidden form inputs:

```twig{1-8}
{# Provide each existing asset ID in the array of field data #}
{% for relatedAssetId in entry.myFieldHandle.ids() %}
  {{ input(
    'hidden',
    'fields[myFieldHandle][]',
    relatedAssetId
  ) }}
{% endfor %}

{{ input('file', 'fields[myFieldHandle][]', options={
  multiple: true,
}) }}
```

### GraphQL

<See path="../../development/graphql.md" hash="custom-fields" label="Custom Fields in GraphQL" description="Get familiar with using custom fields in GraphQL queries." />

Assets related via an assets field can be queried by via the field’s handle. You must make one or more sub-selections:

```graphql{4-8}
query News {
  entries(section: "blog") {
    ... on post_Entry {
      featureImage {
        id
        filename
        url
      }
    }
  }
}
```

The special [`@transform` directive](../../development/graphql.md#the-transform-directive) allows you to apply [image transforms](../../development/image-transforms.md#graphql) to assets, on-the-fly. The directive can be used on the entire asset field, or many subfields thereof:

```graphql{4,16}
query HomepageContent {
  hero: entries(section: "blog", limit: 1) {
    ... on post_Entry {
      featureImage@transform(handle: "hero") {
        url
        filename
        width
        height
      }
    }
  }

  feed: entries(section: "blog", offset: 1) {
    ... on post_Entry {
      featureImage {
        url@transform(handle: "thumbnail")
        filename
        width
        height
      }
    }
  }
}
```

## See Also

- [Asset Queries](../element-types/assets.md#querying-assets)
- <craft5:craft\elements\Asset>
- [Relations](../../system/relations.md)
</file>

<file path="reference/field-types/button-group.md">
---
related:
  - uri: radio-buttons.md
    label: Radio Button fields
  - uri: dropdown.md
    label: Dropdown fields
---

# Button Group <Since ver="5.7.0" feature="The button group field" />

Button group fields provide a compact, graphical option for selecting a single value from a list.

<!-- more -->

![Screenshot of the button group field interface in the Craft control panel](../../images/fields-button-group-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new button group field via the control panel.">
<img src="../../images/fields-button-group-settings.png" alt="Button group field settings screen in the Craft control panel">
</BrowserShot>

Button group fields have the following settings:

- **Options** — Define any number of options for authors to select from, each with…
  - **Label** — A text description of the option. _Labels are hidden when using the **Icons only** setting._
  - **Value** — The value stored when a given option is selected.
  - **Icon** — Choose from the standard system icon palette.
  - **Default?** — One option can be marked as the default.
- **Icons only** — Hide labels in the UI, displaying only the selected icon for each option.

The field works best with a limited number of visually distinct options.

## Development

Button group fields share template, query, and GraphQL capabilities with [dropdown fields](dropdown.md).
</file>

<file path="reference/field-types/categories.md">
---
related:
  - uri: ../element-types/categories.md
    label: Category Elements
  - uri: ../../system/relations.md
    label: Using Relationships
  - uri: link.md
    label: Link fields
---

# Categories Fields

<div class="version-warning">

Categories are being phased out in favor of [Structure sections](../element-types/entries.md#structures). The corresponding [entries field](entries.md) has a _maintain hierarchy_ setting that mimics categories fields.

Read more about this [transition](https://craftcms.com/blog/entrification) on our blog.

</div>

Categories fields allow you to relate [categories](../element-types/categories.md) to other elements. It is one of Craft’s [relational](../../system/relations.md) custom fields.

<!-- more -->

## Settings

Categories fields have the following settings:

- **Source** — Which category group (or other category index [source](../../system/elements.md#sources)) the field should be able to relate categories from.
- **Maintain Hierarchy** — Should the selected categories’ order and hierarchy be preserved?

  When **enabled**, the following options become available:

  - **Branch Limit** — How many distinct “branches” of the category tree can be selected?

  When **disabled**, these options are available:

  - **Min Relations** — The minimum number of categories that must be selected when the field is marked as “required” in a field layout. (Default is no minimum.)
  - **Max Relations** — The maximum number of categories that can be selected. (Default is no maximum.)
  - **Default Category Placement** — Whether new selections are prepended or appended to the existing relations.
  - **View Mode** — How the related users are displayed to authors (_List_ or _Cards_).

- **“Add” Button Label** — The label that should be used on the field’s selection button.
- **Validate related categories** — Whether or not validation errors on the related categories will be bubbled up.

### Advanced Settings

Additional settings are available under the **Advanced** toggle:

- **Allow self-relations** — If this field is added to a category group field layout, should the author be allowed to select the category they are editing as a relationship to itself?

### Multi-Site Settings

On multi-site installs, the following settings will also be available:

- **Translation Method** — How relationships are handled when [propagating changes to other sites](../../system/fields.md#translation-methods).
- **Relate categories from a specific site?** — Whether to only allow relations to categories from a specific site.
  - If _enabled_, a new setting will appear where you can choose which site.
  - If _disabled_, related categories will always be pulled from the current site.

- **Show the site menu** — Whether to display the site menu in category selection modals. (This setting is hidden when relations are locked to a single site.)

<See path="../../system/fields.md" hash="translation-methods" label="Translation Methods" description="Learn about options for translating field values." />

## The Field

Categories fields list all the currently-related categories with a button to select new ones.

Choosing **Add a category** will bring up a modal window where you can find and select additional categories. You can create new categories from this modal as well, by choosing **New category**.

When you select a nested category, all the ancestors leading up to that category will also automatically be related. Likewise, when you remove a category from within the main field input, any of its descendants will also be removed.

### Inline Category Editing

Double-click on a related category to edit it in a [slideout](../../system/control-panel.md#slideouts).

## Development

### Querying Elements with Categories Fields

When [querying for elements](../../development/element-queries.md) that may have a categories field, you can use values compatible with [relational query params](../../system/relations.md) to narrow the results:

| Value | Fetches elements…
| - | -
| `':empty:'` | that don’t have any related categories.
| `':notempty:'` | that have at least one related category.
| `100` | that are related to the category with an ID of 100.
| `[100, 200]` | that are related to a category with an ID of 100 or 200.
| `[':empty:', 100, 200]` | with no related categories, or are related to a category with an ID of 100 or 200.
| `['and', 100, 200]` | that are related to the categories with IDs of 100 and 200.
| one or more [Category](craft5:craft\elements\Category) elements | that are related to the category/categories.
| a [CategoryQuery](craft5:craft\elements\db\CategoryQuery) object | that are related to any of the resulting categories.

In general, you won’t know a specific category’s ID up-front. Here’s how you might use a category field param to fetch entries belonging to a particular category, in a blog:

```twig
{% set posts = craft.entries()
  .section('posts')
  .myCategoriesField(category)
  .all() %}
```

This example assumes we’re loading entries from a [category’s template](../element-types/categories.md#routing-and-templates), where the `category` variable is automatically injected. This same approach would work if we were instead looking for related content, on an individual post page:

```twig
{# Fetch IDs of the current post’s categories: #}
{% set currentPostCategories = entry.myCategoriesField.ids() %}

{# Use them in a new entries query: #}
{% set relatedPosts = craft.entries()
  .section('posts')
  .myCategoriesField(currentPostCategories)
  .limit(5)
  .all() %}
```

This query will return entries related to _any_ of the current post’s categories. Prepend `and` to the array to find entries that share _all_ their categories with the current post:

```twig
['and', ...currentPostCategories]
```

All the examples so far are achievable using generic [relational query methods](../../system/relations.md#the-relatedto-parameter), but automatically ensure that relationships are defined in a specific field, and in a specific direction (as _targets_). An equivalent query using `.relatedTo()` might look something like this:

```twig{5-8}
{% set currentPostCategories = entry.myCategoriesField.ids() %}

{% set relatedPosts = craft.entries()
  .section('posts')
  .relatedTo({
    field: 'myCategoriesField',
    targetElement: currentPostCategories,
  })
  .limit(5)
  .all() %}
```

The last example we’ll look at uses the [special `:empty:` token](../../system/relations.md#sources-and-targets) to find post entries with _no_ categories related to the field:

```twig{3}
{% set uncategorized = craft.entries()
  .section('posts')
  .myCategoriesField(':empty:')
  .all() %}
```

::: warning
This query may still return entries related to categories via _other_ fields! You can combine multiple category field params to better define “uncategorized:”

```twig{3-4}
{% set uncategorized = craft.entries()
  .section('posts')
  .topics(':empty:')
  .productFamilies(':empty:')
  .all() %}

{# ...or... }

{% set uncategorized = craft.entries()
  .section('posts')
  .relatedTo({
    targetElement: ':empty:',
    field: ['topics', 'productFamilies'],
  })
  .all() %}
```
:::

### Working with Categories Field Data

If you have an element with a categories field in your template, you can access the related category elements using the field’s handle:

::: code
```twig
{% set query = entry.myCategoriesField %}
```
```php
$query = $entry->myCategoriesField; 
```
:::

That will give you a [category query](../element-types/categories.md#querying-categories), prepped to return all the related categories for the given field. You can use the results as a list…

::: code
```twig
{% set relatedCategories = entry.myCategoriesField.all() %}
{% if relatedCategories|length %}
  <ul>
    {% for rel in relatedCategories %}
      <li><a href="{{ rel.url }}">{{ rel.title }}</a></li>
    {% endfor %}
  </ul>
{% endif %}
```
```php
$relatedCategories = $entry->myCategoriesField->all();
if (count($relatedCategories)) {
    foreach ($relatedCategories as $rel) {
        // do something with $rel->url and $rel->title
    }
}
```
:::

…or you can show them as a hierarchical list with the [nav](../twig/tags.md#nav) tag:

```twig
{% set relatedCategories = entry.myCategoriesField.all() %}
{% if relatedCategories|length %}
  <ul>
    {% nav rel in relatedCategories %}
      <li>
        <a href="{{ rel.url }}">{{ rel.title }}</a>
        {% ifchildren %}
          <ul>
            {% children %}
          </ul>
        {% endifchildren %}
      </li>
    {% endnav %}
  </ul>
{% endif %}
```

If you only want the first related category, call [one()](craft5:craft\db\Query::one()) instead and make sure it returned something:

::: code
```twig
{% set rel = entry.myCategoriesField.one() %}
{% if rel %}
  <p><a href="{{ rel.url }}">{{ rel.title }}</a></p>
{% endif %}
```
```php
$rel = $entry->myCategoriesField->one();
if ($rel) {
    // do something with $rel->url and $rel->title
}
```
:::

If you need to check for related categories without fetching them, you can call [exists()](craft5:craft\db\Query::exists()):

::: code
```twig
{% if entry.myCategoriesField.exists() %}
  <p>There are related categories!</p>
{% endif %}
```
```php
if ($entry->myCategoriesField->exists()) {
    // do something with related categories
}
```
:::

You can set [parameters](../element-types/categories.md#parameters) on the category query as well. For example, to only fetch the “leaves” (categories without any children), set the [leaves](../element-types/categories.md#leaves) param:

::: code
```twig
{% set relatedCategories = entry.myCategoriesField
  .leaves()
  .all() %}
```
```php
$relatedAssets = $entry->myCategoriesField
    ->leaves()
    ->all();
```
:::

::: tip
Each time you access a category field by its handle, Craft returns a new element query.
:::

### Saving Categories Fields

If you have an element form, such as an [entry form](kb:entry-form), that needs to contain a Categories field, you will need to submit your field value as a list of category IDs.

For example, you could create a list of checkboxes for each of the possible relations:

```twig
{# Include a hidden input first so Craft knows to update the existing value
   if no checkboxes are checked. #}
{{ hiddenInput('fields[myCategoriesField]', '') }}

{# Get all of the possible category options #}
{% set possibleCategories = craft.categories()
  .group('food')
  .all() %}

{# Get the currently related category IDs #}
{% set relatedCategoryIds = entry is defined
  ? entry.myCategoriesField.ids()
  : [] %}

<ul>
  {% nav possibleCategory in possibleCategories %}
    <li>
      <label>
        {{ input(
          'checkbox',
          'fields[myCategoriesField][]',
          possibleCategory.id,
          { checked: possibleCategory.id in relatedCategoryIds }
        ) }}
        {{ possibleCategory.title }}
      </label>
      {% ifchildren %}
        <ul>
          {% children %}
        </ul>
      {% endifchildren %}
    </li>
  {% endnav %}
</ul>
```

::: tip
When the **Maintain Hierarchy** [setting](#settings) is _enabled_, Craft enforces an order for the selected categories and normalizes the selections to “fill in” gaps in the tree.

With the setting _disabled_, only the explicitly-selected categories will be related, in the order they appear in the request—most often, their order in the form’s HTML.
:::

### GraphQL

Categories related via a categories field can be selected along with the source of the relationship:

```graphql{7-10}
query Posts {
  entries(section: "blog") {
    title
    url

    ... on post_Entry {
      topics {
        title
        url
      }
    }
  }
}
```

You can also use categories fields as query arguments, to narrow the results:

```graphql{4}
query TopicPosts {
  entries(
    section: "blog"
    topics: [1234, 5678]
  ) {
    title
    url
  }
}
```

Some relational queries may require that you translate category identifiers (like slugs or UUIDs) to IDs.

<See path="../../development/graphql.md" hash="relationships" label="Relational Fields in GraphQL" description="Get the most out of Craft’s relational fields via the GraphQL API." />

## See Also

- [Category Queries](../element-types/categories.md#querying-categories)
- <craft5:craft\elements\Category>
- [Relations](../../system/relations.md)
</file>

<file path="reference/field-types/checkboxes.md">
---
related:
  - uri: multi-select.md
    label: Multi-select fields
  - uri: radio-buttons.md
    label: Radio buttons fields
---

# Checkboxes Fields

Checkboxes fields give you a group of [checkbox](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/checkbox) inputs, and allow the author to select multiple values (or provide any number of custom values, when allowed).

<!-- more -->

![Screenshot of a checkboxes field interface in the Craft control panel](../../images/fields-checkboxes-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new checkboxes field via the control panel.">
<img src="../../images/fields-checkboxes-settings.png" alt="Checkboxes field settings screen in the Craft control panel">
</BrowserShot>

In addition to the standard field options, checkboxes fields have the following settings:

- **Checkbox Options** – Define the options that will be available to authors. Each option contains…
  - **Label** — A text description of the option, displayed to the author.
  - **Value** — The value stored when a given option is checked.
  - **Icon** (Optional) — Choose from the standard system icon palette.
  - **Color** (Optional) — A color for the icon, or, when no icon is selected, a color pip.
  - **Default?** — Whether the option should be checked by default.
- **Allow custom options** <Since ver="5.5.0" feature="Custom options" /> — Whether authors can provide “other” options, on-the-fly.

## Development

### Querying Elements with Checkboxes Fields

When [querying for elements](../../development/element-queries.md) that have a checkboxes field, you can filter the results using a query param named after your field’s handle. Possible values include:

| Value | Fetches elements…
| - | -
| `'foo'` | with a `foo` option checked (or `foo` provided as a custom value).
| `'not foo'` | without a `foo` option checked  (and without `foo` among custom values).
| `['foo', 'bar']` | with `foo` _or_ `bar` options selected (or `foo` provided as a custom value).
| `['and', 'foo', 'bar']` | with `foo` _and_ `bar` options selected (or among provided custom values).

::: code
```twig
{# Fetch entries with the 'foo' option checked #}
{% set entries = craft.entries()
  .myFieldHandle('foo')
  .all() %}
```
```php
// Fetch entries with the 'foo' option checked
$entries = \craft\elements\Entry::find()
    ->myFieldHandle('foo')
    ->all();
```
:::

### Working with Checkboxes Field Data

If you have an element with a checkboxes field in your template, you can access its data using the field’s handle:

::: code
```twig
{% set value = entry.myFieldHandle %}
```
```php
$value = $entry->myFieldHandle %}
```
:::

That will give you a <craft5:craft\fields\data\MultiOptionsFieldData> object that contains information about the selected values and the available options. This object can be used as an array; looping over it provides each selected option, in sequence:

::: code
```twig
{% for option in entry.myFieldHandle %}
  Label: {{ option.label }}
  Value: {{ option }} or {{ option.value }}
{% endfor %}
```
```php
foreach ($entry->myFieldHandle as $option) {
    // label: $option->label
    // value: $option or $option->value
}
```
:::

To loop through all available options, iterate over the [options](craft5:craft\fields\data\MultiOptionsFieldData::getOptions()) property:

::: code
```twig
{% for option in entry.myFieldHandle.options %}
  Label:   {{ option.label }}
  Value:   {{ option }} or {{ option.value }}
  Checked: {{ option.selected ? 'Yes' : 'No' }}
{% endfor %}
```
```php
foreach ($entry->myFieldHandle->options as $option) {
    // label:   $option->label
    // value:   $option or $option->value
    // checked: $option->selected ? 'Yes' : 'No'
}
```
:::

::: warning

:::

To see if any options are checked, use the [length](https://twig.symfony.com/doc/3.x/filters/length.html) filter or [empty](https://twig.symfony.com/doc/3.x/tests/empty.html) test (or the [count](https://www.php.net/manual/en/function.count.php) method in PHP):

::: code
```twig
{% if entry.myCheckboxesFieldHandle | length %}
  {# At least one option was selected! #}
{% endif %}

{% if entry.myCheckboxesFieldHandle is not empty %}
  {# Equivalent, but note that we’ve inverted the condition! #}
{% endif %}
```
```php
if (count($entry->myCheckboxesFieldHandle)) {
    // At least one option was selected!
}
// PHP’s `empty()` function is more strict than the
// Twig test, and may produce different results!
```
:::

To see if a specific option is checked, call [contains()](craft5:craft\fields\data\MultiOptionsFieldData::contains()) using the **Value** in question:

::: code
```twig
{% if entry.myCheckboxesFieldHandle.contains('foo') %}
  {# `foo` was selected! #}
{% endif %}
```
```php
if ($entry->myCheckboxesFieldHandle->contains('foo')) {
    // `foo` was selected!
}
```
:::

The `in` Twig test is equivalent:

```twig
{% if 'foo' in entry.myCheckboxesFieldHandle %}
  {# `foo` was selected! #}
{% endif %}
```

Custom values are also honored by both methods.

### Saving Checkboxes Fields

In an element or [entry form](kb:entry-form) that needs to save a value to a checkboxes field, you can use this template as a starting point:

```twig
{% set field = craft.app.fields.getFieldByHandle('myCheckboxesFieldHandle') %}

{# Include a hidden input first so Craft knows to clear the
   existing value, if no checkboxes are checked. #}
{{ hiddenInput('fields[myCheckboxesFieldHandle]', '') }}

<ul>
  {# Display native options as checkboxes: #}
  {% for option in field.options %}
    {% set checked = entry is defined
      ? entry.myCheckboxesFieldHandle.contains(option.value)
      : option.default %}

    <li>
      <label>
        <input
          type="checkbox"
          name="fields[myCheckboxesFieldHandle][]"
          value="{{ option.value }}"
          {% if checked %}checked{% endif %}>
        {{ option.label }}
      </label>
    </li>
  {% endfor %}

  {# Does this field allow custom options? #}
  {% if field.customOptions %}
    {# Loop over the *stored* values and output all the "invalid" ones as text fields: #}
    {% for option in entry.myCheckboxesFieldHandle | filter(o => not o.valid) %}
      <li>
        <label>
          <input
            type="text"
            name="fields[myCheckboxesFieldHandle][]"
            value="{{ option.value }}">
          {{ option.label }}
        </label>
      </li>
    {% endfor %}

    {# Provide one more input for new values: #}
    <li>
      <label>
        Other:
        <input
          type="text"
          name="fields[myCheckboxesFieldHandle][]">
      </label>
    </li>
  {% endif %}
</ul>
```
</file>

<file path="reference/field-types/color.md">
# Color Fields

Color fields provide a flexible way to store hexadecimal color values. You can define a [palette](#palette) to guide authors <Since ver="5.6.0" feature="Color field palettes" />, or use an [open-ended input](#custom-colors).

<!-- more -->

![Screenshot of a color field interface in the Craft control panel](../../images/fields-color-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new color field via the control panel.">
<img src="../../images/fields-color-settings.png" alt="Color field settings screen in the Craft control panel">
</BrowserShot>

### Palette

Each field contains a **Palette** of colors that authors can select from a dropdown menu.

### Custom Colors

Turn on **Allow custom colors** to display a compact input and color preview UI. When used in conjunction with a palette, an additional **Custom…** option is listed at the bottom of the dropdown menu.

::: tip
In [browsers that support `<input type="color">`](https://caniuse.com/input-color), clicking on the color preview “well” opens a native OS color picker.
:::

## Development

Accessing a color field returns a <craft5:craft\fields\data\ColorData> object, or `null` if no color was selected.

Casting a `ColorData` object to a string by outputting it directly produces a hexadecimal representation of the color:

::: code
```twig
{% if entry.myColorField %}
  <style type="text/css">
    .content a {
      {# Directly outputting the value... #}
      color: {{ entry.myColorField }};
    }
    .content b {
      {# ...is equivalent to: #}
      color: {{ entry.myColorField.getHex() }};
    }
  </style>
{% endif %}
```
```php
if ($entry->myColorField) {
    echo $entry->myColorField;
    // …is equivalent to…
    echo $entry->myColorField->getHex();
}
```
:::

`ColorData` objects have a number of methods that streamline working with color values:

::: code
```twig
{% if entry.myColorField %}
  {{ entry.myColorField }}                 {# output: #e5422b #}
  {{ entry.myColorField.getHex() }}        {# output: #e5422b #}
  {{ entry.myColorField.getRgb() }}        {# output: rgb(229,66,43) #}
  {{ entry.myColorField.getHsl() }}        {# output: hsl(7,81%,90%) #}
  {{ entry.myColorField.getLuma() }}       {# output: 0.38820862745098 #}
  {{ entry.myColorField.getHue() }}        {# output: 7 #}
  {{ entry.myColorField.getLightness() }}  {# output: 90 #}
  {{ entry.myColorField.getSaturation() }} {# output: 81 #}
  {{ entry.myColorField.getRed() }}        {# output: 229 #}
  {{ entry.myColorField.getGreen() }}      {# output: 66 #}
  {{ entry.myColorField.getBlue() }}       {# output: 43 #}
{% endif %}
```
```php
if ($entry->myColorField) {
    echo $entry->myColorField;                  // output: #e5422b
    echo $entry->myColorField->getHex();        // output: #e5422b
    echo $entry->myColorField->getRgb();        // output: rgb(229,66,43)
    echo $entry->myColorField->getHsl();        // output: hsl(7,81%,90%)
    echo $entry->myColorField->getLuma();       // output: 0.38820862745098
    echo $entry->myColorField->getHue();        // output: 7
    echo $entry->myColorField->getLightness();  // output: 90
    echo $entry->myColorField->getSaturation(); // output: 81
    echo $entry->myColorField->getRed();        // output: 229
    echo $entry->myColorField->getGreen();      // output: 66
    echo $entry->myColorField->getBlue();       // output: 43
}
```
:::

::: tip
Refer to the [`ColorData`](craft5:craft\fields\data\ColorData) class reference for a complete list of methods!
:::

## Querying by Color

There are no special query features for color fields; refer to the [plain text](plain-text.md) field for a list of standard string comparison syntaxes.
</file>

<file path="reference/field-types/country.md">
---
description: Select a country from the same database that powers address elements.
related:
  - uri: addresses.md
    label: Address fields
---

# Country Fields

The **Country** field allows authors to select from a the same list of countries made available via [address](../element-types/addresses.md) elements. When viewed as part of a form in the [control panel](../../system/control-panel.md), countries’ names will be localized into the user’s preferred language.

<!-- more -->

## Settings

This field has no configurable options.

::: tip
You can switch other text-based fields to use the country field type. As long as your existing field’s values are valid two-letter country codes (or empty), the data will be seamlessly enhanced with the country field’s richer return type.
:::

## Development

Craft stores the field’s value as a capitalized, two-letter country code.

```twig
{% if entry.country is not empty %}
  Country code: {{ entry.country }}
{% endif %}
```

Craft actually returns a [`Country`](repo:commerceguys/addressing/blob/master/src/Country/Country.php) object, which has a few [additional features](../element-types/addresses.md#country-names), including the complete name: <Since ver="5.3.0" description="{product} {ver} changed the data type for Country fields." />

```twig
<h1>Mail from {{ entry.country.name }}</h1>
```

In earlier versions of Craft, use the [address repository](../element-types/addresses.md#address-repository) available via the address service to get a `Country` model:

```twig
{# Load all country data: #}
{% set repo = craft.app.addresses.getCountryRepository() %}

{# Get just the selected country: #}
{% set country = repo.get(entry.country) %}

{# Use properties of the country model: #}
{{ country.name }} ({{ country.threeLetterCode }})
```

The `country` variable in this example is an instance of  [`CommerceGuys\Addressing\Country\Country`](repo:commerceguys/addressing/blob/master/src/Country/Country.php).

#### Localization

To get the localized name of a country, you must re-fetch it from the address repository:

```twig{2}
{% set repo = craft.app.addresses.getCountryRepository() %}
{% set country = repo.get(entry.country, currentSite.locale) %}

{{ country.name }}
{# -> In a site set to use US English (en-US): "United States" #}
{# -> In a site set to use Swiss French (fr-CH): "États-Unis" #}
```

Note that outputting the country object directly (i.e. `{{ country }}`) will always return the two-letter country code, which is standard across locales.

### Querying by Country

You can query for elements based on a country field’s value in a familiar way:

```twig{3-4}
{% set letters = craft.entries
    .section('letters')
    .fromCountry('FR')
    .toCountry('GB')
    .orderBy('dateSent DESC')
    .all() %}
```

::: warning
Queries against country fields currently only support two-letter codes, not complete names or other country properties.
:::

### Front-end Forms

Update the value of a country field on an element by submitting a two-letter country code to the [`entries/save-entry` action](../controller-actions.md#post-entries-save-entry). Supposing we are in a template used by the “Letters” section from the previous example, our form might look something like this:

```twig
{% set countries = craft.app.addresses.getCountryRepository().getAll() %}

<form method="post">
  {{ csrfInput() }}
  {{ actionInput('entries/save-entry') }}
  {{ hiddenInput('canonicalId', entry.id) }}

  {{ input('text', 'title', entry.title) }}

  <select name="fields[toCountry]">
    {% for country in countries %}
      {{ tag('option', {
        text: country.name,
        value: country.countryCode,
        selected: country.countryCode == entry.toCountry,
      }) }}
    {% endfor %}
  </select>

  <button>Save</button>
</form>
```

<See path="../controller-actions.md" description="Read more about using forms to submit data to Craft controllers." />
</file>

<file path="reference/field-types/date-time.md">
---
related:
  - uri: time.md
    label: Time-only fields
---

# Date Fields

Date fields provide a specialized input that captures and stores a date and time, in UTC. You may [configure](#settings) it to only accept a date (no time), and to expose a timezone selector.

<!-- more -->

## Settings

Date fields have the following settings:

- **Show date** or **Show date and time**\
    If **Show date and time** is selected, the following settings will be visible:
    - **Minute Increment** – number of minutes that timepicker suggestions should be incremented by. (Authors can manually enter a specific time.)
    - **Show Time Zone** – whether authors should be able to choose the time zone, rather than the system’s.
- **Min Date** – the earliest date that should be allowed.
- **Max Date** – the latest date that should be allowed.

## Development

Date values are always stored in UTC, and normalized to the system timezone (set in <Journey path="Settings, General" />), or whichever timezone was selected by the author.

As a result, outputting dates in a template will typically not require

### Working with Date Field Data

If you have an element with a date field in your template, you can access its value by its handle:

::: code
```twig
{% set value = entry.myFieldHandle %}
```
```php
$value = $entry->myFieldHandle;
```
:::

That will give you a [DateTime](http://php.net/manual/en/class.datetime.php) object that represents the selected date, or `null` if no date was selected.

::: code
```twig
{% if entry.myDateField %}
  Selected date: {{ entry.myDateField|datetime('short') }}
{% endif %}
```
```php
if ($entry->myDateField) {
    $selectedDate = \Craft::$app->getFormatter()->asDatetime(
        $entry->myDateField,
        'short'
    );
}
```
:::

Twig has a number of filters for manipulating and outputting dates:

- [date](../twig/filters.md#date)
- [time](../twig/filters.md#time)
- [datetime](../twig/filters.md#datetime)
- [duration](../twig/filters.md#duration)
- [timestamp](../twig/filters.md#timestamp)
- [atom](../twig/filters.md#atom)
- [rss](../twig/filters.md#rss)
- [date_modify](https://twig.symfony.com/doc/3.x/filters/date_modify.html)

As a `DateTime` object, you can also use PHP’s native formatting method:

```twig
{{ entry.myDateField.format('F j, Y') }}
{# -> January 1, 2025 #}
```

### Querying Elements with Date Fields

When [querying for elements](element-queries.md) that have a date field, you can filter the results using a query param named after your field’s handle.

Possible values include:

Value | Fetches elements…
--- | ---
`':empty:'` | …that don’t have a selected date.
`':notempty:'` | …that have a selected date.
`'>= 2025-01-01'` | …that have a date selected on or after 1 January, 2025.
`'< 2025-01-01'` | …that have a date selected before 1 January, 2025.
`['and', '>= 2024-01-01', '< 2024-06-01']` | …that have a date selected after 1 January, 2024 and before 1 June, 2025.
`['or', '< 2024-06-01', '> 2025-01-01']` | …that have a date selected before 1 June, 2024 or after 1 January, 2025.

::: code
```twig
{# Fetch entries with a selected date in the next month #}
{% set start = now|atom %}
{% set end = now|date_modify('+1 month')|atom %}

{% set entries = craft.entries()
  .myDateField(['and', ">= #{start}", "< #{end}"])
  .all() %}
```
```php
// Fetch entries with a selected date in the next month
$start = (new \DateTime())->format(\DateTime::ATOM);
$end = (new \DateTime('+1 month'))->format(\DateTime::ATOM);

$entries = \craft\elements\Entry::find()
    ->myDateField(['and', ">= ${start}", "< ${end}"])
    ->all();
```
:::

::: tip
The [atom](../twig/filters.md#atom) filter converts a date to an ISO-8601 timestamp. `#{...}` interpolates the timestamp into a double-quoted string (`"`) with an operator.
:::

In place of a timestamp, you can use a handful of tokens to stand in for commonly-referenced relative times:

::: code
```twig
{# Fetch entries with a selected date in the past #}
{% set pastEntries = craft.entries()
  .myDateField('< now')
  .all() %}
{# Fetch entries with a selected date now onward #}
{% set futureEntries = craft.entries()
  .myDateField('>= now')
  .all() %}
```
```php
// Fetch entries with a selected date in the past
$pastEntries = \craft\elements\Entry::find()
    ->myDateField('< now')
    ->all();
// Fetch entries with a selected date now onward
$futureEntries = \craft\elements\Entry::find()
    ->myDateField('>= now')
    ->all();
```
:::

In these examples, `now` can be substituted for `today` (midnight of the current day), `tomorrow` (midnight of the following day), or `yesterday` (midnight of the previous day).

::: tip
Me mindful of [template caching](../twig/tags.md#cache) when comparing against the current time!
:::

#### Timezones

Craft treats all dates as though they are in the system’s timezone, except when one is set explicitly for a date field.

The returned `DateTime` object’s timezone will be set, accordingly. If you wish to display the date in a _different_ timezone than it was defined, use the `timezone` argument supported by Craft’s [date](../twig/filters.md#date), [datetime](../twig/filters.md#datetime) and [time](../twig/filters.md#time) Twig filters.

::: tip
This flexibility is only a feature of date fields, and native element properties (like entries’ _post date_) are always stored in the system timezone.
:::

#### Advanced Conditions <Since ver="5.6.0" feature="Field aliases in advanced where() clauses" />

Building some date-based constraints can be cumbersome or inscrutable in Twig. In these cases, the database or query builder may be able to make them more declarative:

::: code
```twig{5} MySQL
{% set year = 2024 %}

{% set sentInYear = craft.entries()
  .section('letters')
  .andWhere("YEAR([[dateSent]]) = :y", { y: year })
  .all() %}
```
```twig{5} Postgres
{% set year = 2024 %}

{% set sentInYear = craft.entries()
  .section('letters')
  .andWhere("EXTRACT(YEAR FROM TIMESTAMP [[dateSent]]) = :y", { y: year })
  .all() %}
```
:::

This uses the database’s built-in functions to extract and compare only the year of each date; similarly, you could use the `MONTH()` function (or `MONTH FROM TIMESTAMP`) to find entries with a `dateSent` only in a specific month.

::: danger
_Do not_ pass user input (like a field value or query string) directly to `.andWhere()`! Here, we’ve used a bound parameter (`:y`) to safely escape the input.
:::

Prior to the introduction of custom field column aliases in Craft 5.6.0, advanced queries such as this were still possible, but required that you build the field value SQL expression using the [`fieldValueSql()` function](../twig/functions.md#fieldvaluesql).


### Saving Date Fields

If you have an element form, such as an [entry form](https://craftcms.com/knowledge-base/entry-form), that needs to contain a Date field, you can create a `date` or `datetime-local` input.

If you just want the user to be able to select a date, use a `date` input:

```twig
{% set currentValue = entry is defined and entry.myFieldHandle
  ? entry.myFieldHandle|date('Y-m-d', timezone='UTC')
  : '' %}

<input type="date" name="fields[myFieldHandle]" value="{{ currentValue }}">
```

If you want the user to be able to select a time as well, use a `datetime-local` input:

```twig
{% set currentValue = entry is defined and entry.myFieldHandle
  ? entry.myFieldHandle|date('Y-m-d\\TH:i', timezone='UTC')
  : '' %}

<input type="datetime-local" name="fields[myFieldHandle]" value="{{ currentValue }}">
```

#### Customizing the Timezone

By default, Craft will assume the date is posted in UTC. You can post dates in a different timezone by changing the primary input’s `name` to `fields[myFieldHandle][datetime]` and adding a hidden input named `fields[myFieldHandle][timezone]`, set to a [valid PHP timezone](http://php.net/manual/en/timezones.php):

```twig
{# Use the timezone selected under Settings → General Settings → Time Zone #}
{% set tz = craft.app.getTimezone() %}

{# Or set a specific timezone #}
{% set tz = 'America/Los_Angeles' %}

{# Normalize saved dates with the specified timezone: #}
{% set currentValue = entry is defined and entry.myFieldHandle
  ? entry.myFieldHandle|date('Y-m-d\\TH:i', timezone=tz)
  : '' %}

<input type="datetime-local" name="fields[myFieldHandle][datetime]" value="{{ currentValue }}">
{{ hiddenInput('fields[myFieldHandle][timezone]', tz) }}
```

Or you can let users decide which timezone the date should be posted in:

```twig
{% set currentValue = entry is defined and entry.myFieldHandle
  ? entry.myFieldHandle|date('Y-m-d\\TH:i', timezone='UTC')
  : '' %}

<input type="datetime-local" name="fields[myFieldHandle][datetime]" value="{{ currentValue }}">

<select name="fields[myFieldHandle][timezone]">
  <option value="UTC" selected>UTC</option>
  <option value="America/Los_Angeles">Pacific Time</option>
  {# ... #}
</select>
```

In this example, we’ve elected to normalize the stored date (and timezone) to UTC, then allow the user to send it back to Craft in a localized way.

#### Posting the Date and Time Separately

If you’d like to post the date and time as separate HTML inputs, give them the names `fields[myDateField][date]` and `fields[myDateField][time]`.

- The `date` input can use either the `YYYY-MM-DD` format, or the current locale’s short date format.
- The `time` input can use either the `HH:MM` format (24-hour), or the current locale’s short time format.

::: tip
To find out what your current locale’s date and time formats are, add this to your template:

```twig
Date format: <code>{{ craft.app.locale.getDateFormat('short', 'php') }}</code><br>
Time format: <code>{{ craft.app.locale.getTimeFormat('short', 'php') }}</code>
```

Then refer to PHP’s [date()](http://php.net/manual/en/function.date.php) function docs to see what each of the format letters mean.

The locale that Craft uses to parse dates and times depends on the [site](../../system/sites.md)’s language for front-end requests, and user preferences for control panel requests.
:::

This strategy can by combined with [timezone customization](#customizing-the-timezone).
</file>

<file path="reference/field-types/dropdown.md">
---
related:
  - uri: button-group.md
    label: Button Group fields
  - uri: radio-buttons.md
    label: Radio Button fields
---

# Dropdown Fields

Dropdown fields provide an enhanced version of the familiar `<select>` input. Optional colors and icons help authors quickly identify choices. <Since ver="5.7.0" feature="Color and icon support in dropdown fields." />

<!-- more -->

![Screenshot of the dropdown field interface in the Craft control panel](../../images/fields-dropdown-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new dropdown field via the control panel.">
<img src="../../images/fields-dropdown-settings.png" alt="Dropdown field settings screen in the Craft control panel">
</BrowserShot>

Dropdown fields have the following settings:

- **Dropdown Options** — Define any number of options to populate the menu.
  - **Label** — A text description of the option, displayed to the author.
  - **Value** — The value stored when a given option is selected.
  - **Icon** (Optional) — Choose from the standard system icon palette.
  - **Color** (Optional) — A color for the icon, or, when no icon is selected, a color pip.
  - **Default?** — One option can be marked as the default.

Unlike the [radio buttons](radio-buttons.md) field, dropdown fields do not accept custom values from authors. If you need to select multiple values, consider the [checkboxes](checkboxes.md) field.

::: tip
If you change the underlying value of an option that is used by existing entries, Craft will select the designated default option the next time one of those elements is edited.

Consider using the appropriate [`resave/*` console commands](../cli.md#resave) to migrate existing data to your new value:

```bash
php craft resave/entries --section mySection --set myDropdownField --to "={{ object.myDropdownField.value == 'oldValue' ? 'newValue' : object.myDropdownField.value }}"
```
:::

## Development

### Querying Elements with Dropdown Fields

When [querying for elements](../../development/element-queries.md) that have a Dropdown field, you can filter the results based on the Dropdown field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements…
| - | -
| `'foo'` | with a `foo` option selected.
| `'not foo'` | without a `foo` option selected.
| `['foo', 'bar']` | with either a `foo` or `bar` option selected.
| `['not', 'foo', 'bar']` | without either a `foo` or `bar` option selected.

::: code
```twig
{# Fetch entries with the 'foo' option selected #}
{% set entries = craft.entries()
  .myFieldHandle('foo')
  .all() %}
```
```php
// Fetch entries with the 'foo' option selected
$entries = \craft\elements\Entry::find()
    ->myFieldHandle('foo')
    ->all();
```
:::

### Working with Dropdown Field Data

If you have an element with a Dropdown field in your template, you can access its data using your Dropdown field’s handle:

::: code
```twig
{% set value = entry.myFieldHandle %}
```
```php
$value = $entry->myFieldHandle;
```
:::

That will give you a <craft5:craft\fields\data\SingleOptionFieldData> object that contains the field data.

To show the selected option, output it as a string, or output the [value](craft5:craft\fields\data\SingleOptionFieldData::$value) property:

```twig
{{ entry.myFieldHandle }} or {{ entry.myFieldHandle.value }}
```

To see if an option is selected, use the [value](craft5:craft\fields\data\SingleOptionFieldData::$value) property:

```twig
{% if entry.myFieldHandle.value %}
```

To show the selected option’s label, output the [label](craft5:craft\fields\data\SingleOptionFieldData::$label) property:

```twig
{{ entry.myFieldHandle.label }}
```

To loop through all of the available options, iterate over the [options](craft5:craft\fields\data\SingleOptionFieldData::getOptions()) property:

```twig
{% for option in entry.myFieldHandle.options %}
  Label:    {{ option.label }}
  Value:    {{ option }} or {{ option.value }}
  Selected: {{ option.selected ? 'Yes' : 'No' }}
{% endfor %}
```


### Saving Dropdown Fields

If you have an element form, such as an [entry form](kb:entry-form), that needs to contain a Dropdown field, you can use this template as a starting point:

```twig
{% set field = craft.app.fields.getFieldByHandle('myFieldHandle') %}

<select name="fields[myFieldHandle]">
  {% for option in field.options %}
    {% set selected = entry is defined
      ? entry.myFieldHandle.value == option.value
      : option.default %}

    <option value="{{ option.value }}"
      {% if selected %}selected{% endif %}
    >
      {{ option.label }}
    </option>
  {% endfor %}
</select>
```

### GraphQL

Dropdown fields (and the similar [button group](button-group.md) and [radio buttons](radio-buttons.md) fields) return a single string (or `null`) when selected in a GraphQL query:

::: code
```graphql{7} Query
query Reviews {
  entries(section: "reviews") {
    title
    postDate

    ... on review_Entry {
    	sentiment
    }
  }
}
```
```json{7,12,17,22} Response
{
  "data": {
    "entries": [
      {
        "title": "Meh…",
        "postDate": "2025-05-07T10:30:00-07:00",
        "sentiment": "neutral"
      },
      {
        "title": "Undecided",
        "postDate": "2025-05-07T10:20:00-07:00",
        "sentiment": null
      },
      {
        "title": "Disappointed!",
        "postDate": "2025-05-07T10:10:00-07:00",
        "sentiment": "miserable"
      },
      {
        "title": "Out-of-this-world!",
        "postDate": "2025-05-07T10:00:00-07:00",
        "sentiment": "awesome"
      }
    ]
  }
}
```
:::

Fields can also be used as query arguments:

::: code
```graphql Query
query ReviewTally {
  positive: entryCount(section: "reviews", sentiment: "awesome")
  negative: entryCount(section: "reviews", sentiment: "miserable")
  impartial: entryCount(section: "reviews", sentiment: ["neutral", null])
}
```
```json Response
{
  "data": {
    "positive": 1,
    "negative": 1,
    "impartial": 2
  }
}
```
:::
</file>

<file path="reference/field-types/email.md">
---
related:
  - uri: link.md
    label: Link fields
---

# Email Fields

Email fields give you a normal text input that requires a valid email address.

<!-- more -->

::: tip
The new [Link field](link.md) also supports email addresses.
:::

## Settings

Email fields have the following settings:

* **Placeholder Text** – The field’s placeholder text, to be displayed if the field has no value yet.

## Development

Calling an Email field in your templates will return the value that was entered in the field.

```twig
{% if user.email %}
  <h3>Email</h3>
  <a href="mailto:{{ user.email }}">{{ user.email }}</a>
{% endif %}
```
</file>

<file path="reference/field-types/entries.md">
---
related:
  - uri: ../element-types/entries.md
    label: Entry Elements
  - uri: ../../system/relations.md
    label: Using Relationships
  - uri: link.md
    label: Link fields
---

# Entries Fields

Entries fields allow you to relate [entries](../element-types/entries.md) to other elements. It is one of Craft’s [relational](../../system/relations.md) custom fields.

<!-- more -->

![Screenshot of the entries field interface in the Craft control panel](../../images/fields-entries-ui.png)

::: tip
If you would like to manage a set of _nested_ entries within another element (as opposed to selecting from an external set), consider using the [Matrix field](matrix.md).
:::

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new entries field via the control panel.">
<img src="../../images/fields-entries-settings.png" alt="Entries field settings screen in the Craft control panel">
</BrowserShot>

Entries fields have the following settings:

- **Sources** — Which sections (or other entry index sources) the field should be able to relate entries from.
- **Selectable Entries Condition** — Rules that determine which entries should be available for selection.
- **Maintain Hierarchy** — When selecting from a _structure_ section, should the entries’ order and hierarchy be preserved?

  ::: tip
  This option is available only when the selected sources are all structures.
  :::

  When **enabled**, the following options become available:

  - **Branch Limit** — How many distinct “branches” of a structure can be selected?

  When **disabled**, these options are available:

  - **Min Relations** — The minimum number of entries that must be selected when the field is marked as “required” in a field layout. (Default is no minimum.)
  - **Max Relations** — The maximum number of entries that can be selected. (Default is no maximum.)
  - **Default Entry Placement** — Whether new selections are prepended or appended to the existing relations.
  - **View Mode** — How the related users are displayed to authors (_List_ or _Cards_).
- **Show cards in a grid** — When using the **Cards** view mode, this setting allows cards to tile horizontally, as space allows.
- **“Add” Button Label** — The label that should be used on the field’s selection button.

### Advanced Settings

Additional settings are available under the **Advanced** toggle:

- **Allow self relations** — Whether the current entry (with this field) should be allowed to select itself as a relation.

### Multi-Site Settings

On multi-site installs, additional advanced settings will be available:

- **Translation Method** — How relationships are handled when [propagating changes to other sites](../../system/fields.md#translation-methods).
- **Relate entries from a specific site?** — Whether to only allow relations to entries from a specific site.
  - If _enabled_, a new setting will appear where you can choose which site.
  - If _disabled_, related entries will always be pulled from the current site.

- **Show the site menu** — Whether to display the site menu in entry selection modals. (This setting is hidden when relations are locked to a single site.)

<See path="../../system/fields.md" hash="translation-methods" label="Translation Methods" description="Learn about options for translating field values." />

## The Field

Entries fields list all of the currently-related entries, with a button to select new ones.

Pressing **Add an entry** will open a modal window where you can find and select additional entries. (You also press **+ New entry** from this modal to create a new entry in a slideout panel.)

### Inline Entry Editing

When you double-click a related entry, a slideout will appear where you can edit the entry’s title and custom fields.

## Development

### Querying Elements with Entries Fields

When [querying for elements](../../development/element-queries.md) that have an Entries field, you can filter the results based on the Entries field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements…
| - | -
| `':empty:'` | that don’t have any related entries.
| `':notempty:'` | that have at least one related entry.
| `100` | that are related to the entry with an ID of 100.
| `[100, 200]` | that are related to an entry with an ID of 100 or 200.
| `[':empty:', 100, 200]` | with no related entries, or related to an entry with an ID of 100 or 200.
| `['and', 100, 200]` | that are related to the entries with IDs of 100 and 200.
| an [Entry](craft5:craft\elements\Entry) object | that are related to the entry.
| an [EntryQuery](craft5:craft\elements\db\EntryQuery) object | that are related to any of the resulting entries.

::: code
```twig
{# Fetch artwork entries that are related to `artist` #}
{% set works = craft.entries()
  .section('artwork')
  .myFieldHandle(artist)
  .all() %}
```
```php
// Fetch artwork entries that are related to `$artist`
$works = \craft\elements\Entry::find()
    ->section('artwork')
    ->myFieldHandle($artist)
    ->all();
```
:::

### Working with Entries Field Data

If you have an element with an Entries field in your template, you can access its related entries using your Entries field’s handle:

::: code
```twig
{% set query = entry.myFieldHandle %}
```
```php
$query = $entry->myFieldHandle;
```
:::

That will give you an [entry query](../element-types/entries.md#querying-entries), prepped to output all of the related entries for the given field.

To loop through all the related entries, call [all()](craft5:craft\db\Query::all()) and then loop over the results:

::: code
```twig
{% set relatedEntries = entry.myFieldHandle.all() %}
{% if relatedEntries|length %}
  <ul>
    {% for rel in relatedEntries %}
      <li><a href="{{ rel.url }}">{{ rel.title }}</a></li>
    {% endfor %}
  </ul>
{% endif %}
```
```php
$relatedEntries = $entry->myFieldHandle->all();
if (count($relatedEntries)) {
    foreach ($relatedEntries as $rel) {
        // $rel->url, $rel->title
    }
}
```
:::

If you only want the first related entry, call [one()](craft5:craft\db\Query::one()) instead, and then make sure it returned something:

::: code
```twig
{% set rel = entry.myFieldHandle.one() %}
{% if rel %}
  <p><a href="{{ rel.url }}">{{ rel.title }}</a></p>
{% endif %}
```
```php
$rel = $entry->myFieldHandle->one();
if ($rel) {
    // $rel->url, $rel->title
}
```
:::

If you’d like to check for related entries without fetching them, you can call [exists()](craft5:craft\db\Query::exists()):

::: code
```twig
{% if entry.myFieldHandle.exists() %}
  <p>There are related entries!</p>
{% endif %}
```
```php
if ($entry->myFieldHandle->exists()) {
    // There are related entries!
}
```
:::

You can set [parameters](../element-types/entries.md#parameters) on the entry query as well. For example, to narrow the related entries to those in a `news` section, set the [section](../element-types/entries.md#section) param:

::: code
```twig
{% set relatedEntries = entry.myFieldHandle
  .section('news')
  .all() %}
```
```php
$relatedEntries = $entry->myFieldHandle
    ->section('news')
    ->all();
```
:::

::: tip
<Todo notes="Extract this into a snippet." />

In Craft 3, we recommended cloning these query objects using the [`clone` keyword](https://www.php.net/manual/en/language.oop5.cloning.php) or [`clone()`](../twig/functions.md#clone) Twig function before applying params. **This is no longer required in Craft 4**, because a new copy of the query is returned each time you access the field property.
:::

### Saving Entries Fields

If you have front-end form for saving an element, that needs to contain an Entries field, you will need to submit your field value as a list of entry IDs, in the order you want them to be related.

For example, you could create a list of checkboxes for each of the possible relations:

```twig
{# Include a hidden input first so Craft knows to update the existing value
   if no checkboxes are checked. #}
{{ hiddenInput('fields[myFieldHandle]', '') }}

{# Get all of the possible entry options #}
{% set possibleEntries = craft.entries()
  .section('galleries')
  .orderBy('title ASC')
  .all() %}

{# Get the currently related entry IDs #}
{% set relatedEntryIds = entry is defined
  ? entry.myFieldHandle.ids()
  : [] %}

<ul>
  {% for possibleEntry in possibleEntries %}
    <li>
      <label>
        {{ input(
          'checkbox',
          'fields[myFieldHandle][]',
          possibleEntry.id,
          { checked: possibleEntry.id in relatedEntryIds }
        ) }}
        {{ possibleEntry.title }}
      </label>
    </li>
  {% endfor %}
</ul>
```

You could then make the checkbox list sortable, so users have control over the order of related entries.

## See Also

- [Entry Queries](../element-types/entries.md#querying-entries)
- <craft5:craft\elements\Entry>
- [Relations](../../system/relations.md)
</file>

<file path="reference/field-types/icon.md">
# Icon Fields

Icon fields allow the user to pick from a curated list of [FontAwesome](https://fontawesome.com) icons that fit the control panel’s style. The field’s value can be used to decorate related or nested element chips and cards by enabling **Use this field’s values for element thumbnails** or **Include this field in element cards** when adding it to a field layout.

<!-- more -->

## Settings

To make FontAwesome Pro icons available, turn on the **Include Pro Icons** option. You may need to purchase a FontAwesome Pro license to use icons in your site’s front-end.

## Development

The saved value is suitable for use in the front-end with your own FontAwesome library.

### Webfonts

Following the official [web fonts tutorial](https://fontawesome.com/docs/web/setup/host-yourself/webfonts), you might display an icon like this:

```twig
<i class="fa-solid fa-{{ entry.myIconField }}"></i>
```

Change `fa-solid` to another style identifier to suit your site’s appearance!

If you added the FontAwesome files in `web/assets/fontawesome/*`, you would link to one or more style sheets like this:

```twig
{% css '/assets/fontawesome/fontawesome.css' %}
{% css '/assets/fontawesome/solid.css' %}
```

You can add [`css` tags](../twig/tags.md#css) like this anywhere in your code and Craft will hoist them into the `<head>` of the document!

### SVG + JS

The same HTML will work with the recommendations in the [SVG + JS tutorial](https://fontawesome.com/docs/web/setup/host-yourself/svg-js).
</file>

<file path="reference/field-types/json.md">
---
description: Store arbitrary, structured data as JSON.
related:
  - uri: table.md
    label: Table fields
  - uri: matrix.md
    label: Matrix fields
---

# JSON Fields <Badge text="New!" />

Validate and store arbitrary JSON data in a simple [CodeMirror](https://codemirror.net/) editor. The data is automatically [deserialized](#development) for you and can be 

<!-- more -->

![Screenshot of a JSON field interface in the Craft control panel](../../images/fields-json-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new JSON field via the control panel.">
<img src="../../images/fields-json-settings.png" alt="JSON field settings screen in the Craft control panel">
</BrowserShot>

JSON fields have no custom settings.

## Development

The JSON field returns an instance of <craft5:craft\fields\data\JsonData>, which has a handful of helpful features for interacting with the deserialized data.

Directly outputting the field’s value serializes it back to JSON:

::: code
```twig Template
{{ entry.myJsonField }}
```
```html Result
{"appId":"3beb8a4e-de95-448b-be44-ee19ab8cbe5e","environment":"production"}
```
:::

To pretty-print the JSON, you must explicitly call the `.getJson()` method:

::: code
```twig Template
<pre>{{ entry.myJsonField.getJson(true) }}</pre>
```
```html Result
<pre>{
  "appId": "3beb8a4e-de95-448b-be44-ee19ab8cbe5e",
  "environment": "production"
}</pre>
```
:::

::: tip
`<pre>` tags are necessary to retain formatting, in the browser. Similarly, the `<code>` tag can be used for inline values.
:::

The second argument allows you to customize the indentation:

```twig
{# Use tabs instead of the default (two spaces): #}
<pre>{{ entry.myJsonField.getJson(true, '\t') }}</pre>
```

### Data Types

The data type of the JSON’s root element can be a `boolean`, `integer`, `float`, `string`, or `array`.

```twig
<div class="json {{ data.getType() }}">{{ data }}</div>
```

The [scalar](../twig/tests.md#scalar) test makes it possible to quickly differentiate simple values from arrays and hashes:

```twig
{% if data.getValue() is scalar %}
  {# Output directly: #}
  {{ data }}
{% else %}
  {# This might be more complex, so we’ll print it as nicely as possible: #}
  <pre>{{ data.getJson(true) }}</pre>
{% endif %}
```

::: tip
Note that we’re directly testing against the field’s underlying deserialized value, not the `JsonData` object that wraps it. The latter will always be non-scalar!
:::

### Nested Keys

If you know the structure of a JSON value, you can access nested keys directly from the field:

```twig
{{ entry.myJsonField.appId }}
```

The field only ensures values are valid JSON, but doesn’t enforce any kind of schema. You should always handle input cautiously, to avoid runtime errors:

```twig
{{ entry.myJsonField.appId ?? null }}
```

### Objects + Arrays

JSON “objects” and “arrays” are deserialized into PHP arrays (associative and sequential, respectively), and the `JsonData` object provides a means of iterating over them, directly:

```twig
<table>
  <thead>
    <tr>
      <th>Key</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    {% for key, val in entry.myJsonField %}
        <tr>
          <td>{{ key }}</td>
          <td>
            <pre>{{ val is scalar ? val : val|json_encode }}</pre>
          </td>
        </tr>
    {% endfor %}
  </tbody>
</table>
```

Once you have traversed into a data structure, you must explicitly serialize nested objects for output—Craft doesn’t recursively wrap that data with instances of `JsonData`!

### GraphQL

JSON fields are treated like plain strings, when queried via GraphQL. Values must be deserialized in the client or app:

```js
const gql = `
query MyQuery {
  globalSet(handle: "siteOptions") {
    ... on siteOptions_GlobalSet {
      analyticsConfig
    }
  }
}
`;

fetch('/api', {
  body: gql,
  method: 'POST',
  headers: {
    'Content-Type': 'application/graphql',
    'X-Craft-Gql-Schema': '*',
  },
})
  .then(response => response.json())
  .then(json => JSON.parse(json.data.globalSet.analyticsConfig))
  .then(config => new AcmeAnalytics(config));
```
</file>

<file path="reference/field-types/lightswitch.md">
# Lightswitch Fields

Lightswitch fields give you a simple toggle input and store a boolean value.

<!-- more -->

## Development

### Querying Elements with Lightswitch Fields

When [querying for elements](../../development/element-queries.md) that have a lightswitch field, you can filter the results based on the lightswitch field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements… |
| --- | --- |
| `true` | …with the switch _on_. |
| `false` | …with the switch _off_. |

::: code
```twig
{# Fetch entries with the lightswitch field enabled #}
{% set entries = craft.entries()
  .myFieldHandle(true)
  .all() %}
```
```php
// Fetch entries with the lightswitch field enabled
$entries = \craft\elements\Entry::find()
    ->myFieldHandle(true)
    ->all();
```
:::

Elements without a value for a lightswitch field (say, because they haven’t been saved since the field was added) are treated as if they have the default field value. For example, querying against a field that defaults to _off_…

```twig{3}
{% set archive = craft.entries()
  .section('essays')
  .isFeatured(false)
  .all() %}
```

…would return all posts with an explicit `false` value, or no saved value. This can result in unpredictable behavior when some elements in a set may not have the field. Suppose we want to gather content across two sections (featured “essays” as well as implicitly high-priority “bulletins”):

```twig{2}
{% set headlines = craft.entries()
  .section(['essays', 'bulletins'])
  .isFeatured(true)
  .all() %}
```

If only the `essays` section has an `isFeatured` lightswitch field, entries in the `bulletins` section are assumed to have the field’s default value (`false`), and are therefore excluded.

For more control over this behavior, you have two options: <Since ver="5.7.0" feature="Customizing null handling for lightswitch fields" />

- Pass each acceptable value, explicitly…

  ```twig{3}
  {% set headlines = craft.entries()
    .section(['essays', 'bulletins'])
    .isFeatured([true, null])
    .all() %}
  ```

- Pass a hash with a `strict` key…

  ```twig{3-6}
  {% set headlines = craft.entries()
    .section(['essays', 'bulletins'])
    .isFeatured({
      value: true,
      strict: true,
    })
    .all() %}
  ```

### Working with Lightswitch Field Data

If you have an element with a lightswitch field in your template, you can access its value using the field’s handle:

::: code
```twig
{% if entry.myLightswitchField %}
  <p>I’m on!</p>
{% else %}
  <p>I’m off.</p>
{% endif %}
```
```php
if ($entry->myLightswitchField) {
    // I’m on!
} else {
    // I’m off.
}
```
:::

### Saving Lightswitch Fields

In an element or [entry form](kb:entry-form) that needs to save a value to a lightswitch field, you can use this template as a starting point:

```twig
{{ hiddenInput('fields[myLightswitchField]', '') }}

{{ tag('input', {
  type: 'checkbox',
  name: 'fields[myLightswitchField]',
  value: '1',
  checked: (entry.myLightswitchField ?? false) ? true : false,
  id: 'my-checkbox-input',
}) }}

<label for="my-checkbox-input">Opt In</label>
```

Your input’s `value` can be any “truthy” looking value; Craft only stores a boolean. If you wish to capture one or more explicit values, consider using a [radio](radio-buttons.md), [checkboxes](checkboxes.md), or [multi-select](multi-select.md) field.

The `hidden` input is necessary to tell Craft in the POST request that the field’s value should be updated. If you do not send a value under a custom field handle (`fields[myLightswitchField]` in the example), Craft assumes you _do not_ wish to update it. When the checkbox is ticked, its `value` is sent (`1` in the example) in place of an empty string.
</file>

<file path="reference/field-types/link.md">
---
related:
  - uri: ../../system/fields.md
    label: Learn about content and custom fields
  - uri: ../../system/relations.md
    label: Using relationships
---

# Link Fields <Badge text="New!" />

::: tip
The link field replaced the URL field in [Craft 5.3](github:craftcms/cms/releases/5.3.0). When you update, existing fields will be automatically enhanced with the new UI. If you want to take advantage of the new features (like linking to assets, categories, and entries), check out the field’s [settings](#settings) screen.
:::

Link fields provide a flexible way to link to on- and off-site resources, including assets, categories, entries, email addresses, phone numbers, or arbitrary URLs.

<!-- more -->

![Screenshot of the link field interface in the Craft control panel](../../images/fields-link-ui.png)

A populated [link field’s value](#development) is always suitable for use as an anchor tag’s `href` attribute:

```twig
<a href="{{ entry.myLinkFieldHandle }}">{{ entry.myLinkFieldHandle.label }}</a>
```

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new link field via the control panel.">
<img src="../../images/fields-link-settings.png" alt="Link field settings screen in the Craft control panel">
</BrowserShot>

In addition to the standard field options, Link fields have the following settings:

- **Allowed Link Types** — The type of resource(s) that can be linked. Selecting more than one link type displays a dropdown menu for the author.

  - **URL** — The value must be a valid URL, beginning with `http://` or `https://`.
  - **Asset** — Select an [asset](../element-types/assets.md) element.
  - **Category** — Select a [category](../element-types/categories.md) element.
  - **Email** — The value is automatically prepended with `mailto:`.
  - **Entry** — Select an [entry](../element-types/entries.md) element.
  - **Phone** — The value is automatically prepended with `tel:`.
  - **SMS** — The value is automatically prepended with `sms:`.

  ::: tip
  The list of available link types can be supplemented by plugins via the <craft5:craft\fields\Link::EVENT_REGISTER_LINK_TYPES> event.
  :::

- **Show the “Label” field** — Displays a dedicated field to override the default/generated link label.
- **Advanced Fields** <Since ver="5.6.0" feature="Advanced link settings" /> — Expose a variety of options to editors for controlling specific anchor tag attributes in the resulting HTML.
  - **Target** — Shows an **Open in a new tab?** lightswitch. (In earlier versions of Craft, this was a discrete setting labeled **Show the “Open in a new tab” field**.)
  - **URL Suffix** — Shows a field for an arbitrary URI fragment that will be appended to the resolved URL.
  - **Title Text** — Content for the anchor’s `title` attribute.
  - **Class Name** — Content for the anchor’s `class` attribute.
  - **ID** — Content for the anchor’s `id` attribute. 
  - **Relation (rel)** — Content for the anchor’s `rel` attribute.
  - **ARIA Label** — Content for the anchor’s `aria-label` attribute.
  - **Download** — Include the `download` attribute. This also provides authors a **Filename** field to customize the name of the file when downloaded.

### Advanced Options

- **Max Length** — The maximum number of characters the primary field value can contain. (Defaults to `255`.)
- **GraphQL Mode** — For backwards-compatibility with the URL field type, Craft returns the fully-rendered link as a string when requested via GraphQL; switch this to **Full data** to make individual nested properties available. View the `LinkData` type in the [GraphiQL explorer](../../development/graphql.md#using-the-graphiql-ide) for a complete list of supported sub-properties. The full URL (equivalent to the field’s behavior in **URL only** mode) is under the `url` field.

### Type-Specific Options

When the **URL** link type is enabled, three more options become available:

- **Allow root-relative URLs** — Accepts an absolute path, without a protocol or hostname (i.e. `/give`). Relative paths are still not allowed (i.e. `donate`), as they are ambiguous in most contexts.
- **Allow anchors** — Accepts values that contain _only_ a hash-prefixed fragment or anchor, like `#my-heading`. This should not be enabled alongside the **URL Suffix** advanced field.
- **Allow custom URL schemes** — Permits arbitrary URL “schemes,” so that authors can use deep-links and other nonstandard protocols (e.g: `sftp://user@domain.com:1234`).

When enabling a link type that references elements, Craft will display a set of checkboxes that allow you to limit selection to specific [sources](../../system/elements.md#sources), as well as options specific to that element type. In most cases, these match the corresponding settings for each element type’s [relational field](../../system/relations.md):

- **Assets** — _Allowed File Types_, _Show unpermitted volumes_, _Show unpermitted files_ <Since ver="5.7.0" feature="Limiting selection of assets in link fields by volume and file visibility" />;
- **Entries** — _Show unpermitted sections_, _Show unpermitted entries_ <Since ver="5.7.0" feature="Limiting selection of entries in link fields by section and entry visibility" />;

## The Field

Link fields have—at minimum—an input specific to the allowed type of link. If more than one link type is allowed, a dropdown menu will be shown before the field, allowing the author to switch between them and use a specialized input to define a value.

When the **Show the “Label” field** setting is enabled, an additional input allows authors to customize the textual representation of the link. This input’s `placeholder` text will reflect the automatically-determined value.

## Development

Outputting a link field in a template will return a normalized value suitable for use in an anchor tag’s `href` attribute:

```twig
{% if entry.myLinkFieldHandle %}
  <a href="{{ entry.myLinkFieldHandle }}">Learn More</a>
{% endif %}
```

To output a complete anchor tag, use the `link` property:

```twig
{# You can access it a property... #}
{{ entry.myLinkFieldHandle.link }}

{# ... or call the method, directly: }
{{ entry.myLinkFieldHandle.getLink() }}
```

The result is roughly equivalent to manually rendering the link like this:

```twig
{% set link = entry.myLinkFieldHandle %}

<a href="{{ link.value }}" {% if link.target %}target="{{ link.target }}"{% endif %}>{{ link.label }}</a>
```

The text representation of a link is determined by the presence of an explicit [label](#labels-attributes), and its [type](#types).

### `LinkData`

The link field returns a <craft5:craft\fields\data\LinkData> object. When used as a string, its value is intelligently coerced to something URL-like: for [element links](#elements), the element’s URL; for phone links, the number prefixed with `tel:`; and so on!

The following sections cover a variety of `LinkData` features.

#### Types

The valid `type` values are `asset`, `category`, `email`, `entry`, `phone`, and `url`. To handle link types separately, you can test or match against `entry.myLinkFieldHandle.type`:

```twig
{% switch entry.myLinkFieldHandle.type %}
  {% case 'phone' %}
    <span class="icon icon-phone"></span> {{ entry.myLinkFieldHandle.label }}
  {% case 'email' %}
    <span class="icon icon-email"></span> {{ entry.myLinkFieldHandle.link }}
  {% default %}
    {{ entry.myLinkFieldHandle.link }}
{% endswitch %}
```

#### Elements

Links to assets, categories, and entries contain a reference to the selected element:

```twig
{{ entry.myLinkFieldHandle.element.render() }}
```

In this example, we’re outputting the associated [element partial](../../system/elements.md#element-partials)—but you can use the element (and its properties and fields) however you wish.

#### Labels + Attributes <Since ver="5.5.0" feature="Link labels and targets" />

Enable the **Show the “Label” field** option to allow authors to provide custom labels for links.

When a label is _not_ explicitly defined, Craft will figure out the best textual representation for the link—the selected element’s `title`, the URL (sans protocol), or the raw phone number, for example. That text—or `label`—can be retrieved via the `LinkData` model, in addition to the raw `value`:

```twig
<a href="{{ entry.myLinkFieldHandle.value }}">{{ entry.myLinkFieldHandle.label }}</a>
```

This is the default behavior when using a link’s `link` property. If you need to retrieve the label _as it was entered_ (bypassing Craft’s internal fallback logic, and potentially returning an empty value), use `link.getLabel(true)`. Passing `false` _ignores_ explicitly-entered labels and returns the fallback label.

Craft also automatically includes the `target` attribute when rendering a link, if the **Open in a new tab** option is available (and enabled) for the field. You can access this manually via the `target` property:

```twig
{% set link = entry.myLinkFieldHandle %}

{{ tag('a', {
  href: link.value,
  target: link.target,
  rel: link.target == '_blank' ? 'noopener noreferrer' : null,
  text: link.label,
}) }}

{# ...produces output like... #}

<a href="https://custom-url.com/page" target="_blank" rel="noopener noreferrer">custom-url.com</a>
```

When the **Open in a new tab** option is _off_, the `target` attribute is omitted. Craft handles other [advanced link settings](#advanced-options) in a similar manner, across all link types.

### Relations

When using an element in a link field, Craft makes the corresponding connections in its [relations](../../system/relations.md) system. This means that you can query for elements via link fields, just like other [relational fields](../../system/relations.md#custom-fields):

```twig
{% set backlinks = craft.entries()
  .relatedTo({
    targetElement: post,
    field: 'myLinkField',
  })
  .all() %}

{# -> Returns other entries connected to the given `post` via a specific link field. #}
```

::: warning
It is not currently possible to [eager-load](../../development/eager-loading.md) link field relationships, as their element type is not known until the field data is loaded.
:::
</file>

<file path="reference/field-types/matrix.md">
---
related:
  - uri: ../../development/element-queries.md
    label: Introduction to Elements
  - uri: ../element-types/entries.md
    label: Entries
---

# Matrix Fields

Matrix fields allow you to manage nested [entries](../element-types/entries.md) in a fluid way. Entries created within a Matrix field are “owned” by the element that field is attached to, and can represent anything from a slide in a gallery to an entire resources section, each record having its own URL.

<!-- more -->

::: tip
During the Craft 5 upgrade process, _Matrix blocks_ were converted to _entries_. [Fields](../../system/fields.md) that were previously owned by a particular “block type” are now managed in (and assigned from) a global pool. You are now able to design [entry types](../element-types/entries.md#entry-types) that exist as standalone content objects (in a section), _or_ as nested entries (in a Matrix field)!
:::

## Settings

Matrix fields have the following settings:

#### Entry Types

Select from existing, globally-defined [entry types](../element-types/entries.md#entry-types), or create a new one on-the-fly.

::: tip
You can specify local overrides for each of the attached entry types’ **Name** and **Handle** by selecting **Settings** from a chip’s action <Icon kind="ellipses" /> menu. <Since ver="5.6.0" feature="Contextual entry type name and handle overrides" /> A pencil icon will be displayed in any entry type chip that has overrides.

![Opening a selected entry type’s settings](../../images/fields-matrix-entry-types.png)
:::

#### Propagation Method

Choose how nested entries are propagated to other sites. This applies only to _new_ nested entries—changes to _existing_ nested entries are propagated on a per-field basis.

#### Site Settings <Badge text="New!" />

Nested entries can have their own URIs and templates.

::: tip
Incorporate the owner’s URI in a nested element by using `{owner.uri}` in its **URI Format** [object template](../../system/object-templates.md)!
:::

#### Min Entries

The _minimum_ number of entries that can be created within the field. (Default is no lower limit.)

#### Max Entries

The _maximum_ number of entries that can be created within the field. (Default is no upper limit.)

#### Versioning <Since ver="5.7.0" feature="Control over creation of revisions for nested entries in Matrix fields" />

Nested entries using the _As inline-editable blocks_ [view mode](#view-mode) are “versioned” alongside their owner—when making a change directly within the context of the owner, Craft automatically creates [revisions](../../system/drafts-revisions.md) for both elements. However, revisions of the nested element are hidden, by default.

The **Enable versioning for entries in this field** setting exposes the revisions menu and the **Notes** field in the sidebar, when editing a nested entry on its own.

#### View Mode <Badge text="New!" />

Choose how the nested elements are represented within the [field UI](#the-field):

  - **As cards**: Read-only [element cards](../../system/elements.md#chips-cards) that surface nested field data.
  - **As inline-editable blocks**: Manage nested entries as though they were part of the current element. In prior versions of Craft, this was the _only_ display option for Matrix fields.
  - **As an element index**: A simplified [element index](../../system/elements.md#indexes) with sorting, searching, and filtering controls.

    When using the element index view mode, you can also allow authors to toggle between a card view and standard table view. Enabling the table view reveals controls for the columns that will be displayed, by default.

#### “New” Button Label

By default, the button authors use to create nested entries will be labeled **New entry**. You can override this label with one that better suits the intended content.

## The Field

The interface of a Matrix field depends on its selected [view mode](#view-mode). 

Traditionally, Matrix fields have used the **As inline-editable blocks** view mode, which makes the nested entries appear as though they are a repeating or modular region the main element’s form. An empty Matrix field shows a single button, which will either immediately create a new nested entry (if there is only a single available entry type), or present a menu of entry types to select from:

![An empty Matrix field’s entry types](../../images/fields-matrix-inline-empty.png)

A new entry of the chosen type will be appended to the list:

![A newly-added Quote entry](../../images/fields-matrix-inline-new.png)

You can add as many nested entries to your Matrix field as you’d like—or at least as many as the field’s **Min Entries** and **Max Entries** settings allow.

Each block has a menu that provides access to additional controls:

![A nested entry’s action menu](../../images/matrix-block-action-menu.png)

::: tip
If multiple nested entries are selected, the Collapse/Expand, Disable/Enable, and Delete options will apply to each of them.

You can collapse inline Matrix blocks by choosing the **Collapse** menu option or by double-clicking on a block’s title bar. When a block is collapsed, its title bar will show a preview of its content so you can still identify which block it is.

Inline-blocks can also be reordered by dragging the “Move” icon (<icon kind="move" />) at the end of the block’s title bar. If multiple blocks are selected, all the selected blocks will be going along for the ride.

You can quickly select _all_ blocks by selecting one and pressing <kbd>Ctrl</kbd>/<kbd>⌘</kbd> + <kbd>A</kbd>, or selecting a range of blocks starting with the first and then <kbd>Shift</kbd>-clicking the last.
:::

The **As cards** [view mode](#view-mode) provides many of the same management tools, but the entries are represented as read-only [cards](../../system/elements.md#chips-cards). Double-click any card to edit its content in a slideout, or use the “Move” icon (<icon kind="move" />) to drag them into a new order.

![An newly-created nested entry, represented as a card](../../images/fields-matrix-cards-new.png)

Finally, the **As an element index** view mode behaves just like a normal element index—except it only ever shows the entries owned by that field. This mode is perfect for large data sets that may span multiple pages, need to be sorted by nested fields, or that would otherwise be unwieldy as blocks or cards.

## Nesting Matrix Fields

A Matrix field can include an entry type that has another Matrix field (or the same Matrix field) in its field layout. Those Matrix fields can use the same view mode, or different view modes, depending on how they’re composed. Take care when designing your authoring experience to avoid confusing, infinitely-recursive data structures.

## Development

### Querying Elements with Matrix Fields

When [querying for elements](../../development/element-queries.md) that have a Matrix field, you can filter the results based on the Matrix field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements… |
| --- | --- |
| `':empty:'` | that don’t have any nested entries. |
| `':notempty:'` | that have at least one nested entry. |

::: code
```twig
{# Fetch entries whose Matrix field `myFieldHandle` has at least one nested entry: #}
{% set entries = craft.entries()
  .myFieldHandle(':notempty:')
  .all() %}
```
```php
// Fetch entries whose Matrix field `myFieldHandle` has at least one nested entry:
$entries = \craft\elements\Entry::find()
    ->myFieldHandle(':notempty:')
    ->all();
```
:::

::: tip
If you have a reference to a nested entry, you can get the owner element via `entry.owner`.
:::

### Working with Matrix Field Data

If you have an element with a Matrix field in your [template](../../development/templates.md), you can access its nested entries via the field’s handle:

```twig
{% set nestedElements = entry.myFieldHandle %}
```

That will give you an [Entry query](../element-types/entries.md#querying-entries), ready to load all the nested entries for a given field. To fetch the nested elements, call one of the [query execution methods](../../development/element-queries.md#executing-element-queries), or use it in a loop:

```twig
{% set nestedEntries = entry.myFieldHandle.all() %}

{% if nestedEntries|length %}
  <ul>
    {% for nestedEntry in nestedEntries %}
      {# ... #}
    {% endfor %}
  </ul>
{% endif %}
```

All the code you put inside the `for`-loop will be repeated for each nested entry. Each time, `nestedEntry` will be a <craft5:craft\elements\Entry> model populated with that nested entry’s content.

Here’s an example of what the template might look like for a Matrix field that has four entry types (_Heading_, _Text_, _Image_, and _Quote_). We can treat each entry type separately by checking its `handle`:

```twig
{% for nestedEntry in entry.myFieldHandle.all() %}
  {# Grab the entry type’s handle for comparison: #}
  {% set typeHandle = nestedEntry.type.handle %}

  {% if typeHandle == 'heading' %}
    <h3>{{ nestedEntry.heading }}</h3>
  {% elseif typeHandle == 'text' %}
    {{ nestedEntry.text|markdown }}
  {% elseif typeHandle == 'image' %}
    {% set image = nestedEntry.image.one() %}

    {% if image %}
      {{ image.getImg('thumb') }}
    {% endif %}
  {% elseif typeHandle == 'quote' %}
    <blockquote>
      <p>{{ nestedEntry.quote }}</p>
      <cite>– {{ nestedEntry.cite }}</cite>
    </blockquote>
  {% else %}
    {# Uh oh! This entry type isn’t support yet... #}
    <p>You can output something here to remind yourself to handle additional cases!</p>
  {% endif %}
{% endfor %}
```

::: tip
This code can be simplified using the [switch](../twig/tags.md#switch) tag.
:::

#### Other Query Methods

If you only want the first nested entry, call [one()](<craft5:craft\db\Query::one()>) instead of `all()`, and make sure it returned something:

::: code
```twig
{% set firstNestedEntry = entry.myFieldHandle.one() %}
{% if firstNestedEntry %}
  {# ... #}
{% endif %}
```
```php
$firstNestedEntry = $entry->myFieldHandle->one();
if ($firstNestedEntry) {
    // ...
}
```
:::

If you only want to know the total number of blocks, call [count()](<craft5:craft\db\Query::count()>).

::: code
```twig
{% set total = entry.myFieldHandle.count() %}
<p>Total nested entries: <strong>{{ total }}</strong></p>
```
```php
$total = $entry->myFieldHandle->count();
```
:::

If you just need to check if there are nested entries added to a field (but don’t need to actually load them), call [exists()](<craft5:craft\db\Query::exists()>):

::: code
```twig
{% if entry.myFieldHandle.exists() %}
  <p>Here be nested content!</p>
{% endif %}
```
```php
if ($entry->myFieldHandle->exists()) {
    // There’s at least one nested entry!
}
```
:::

::: tip
Read more about [query execution methods](../../development/element-queries.md#executing-element-queries) on the element query page.
:::

You can set [parameters](../element-types/entries.md#parameters) on the query, as well. For example, to only fetch nested entries that use a specific entry type, set the [type](../element-types/entries.md#type) param:

::: code
```twig
{% set nestedTextEntries = entry.myFieldHandle
  .type('text')
  .all() %}
```
```php
$nestedTextEntries = $entry->myFieldHandle
    ->type('text')
    ->all();
```
:::

#### Eager Loading

Nested entries can be [eager-loaded](../../development/eager-loading.md) with their owners using the special `.with()` query method. Eager-loading can greatly improve performance if you need to output one or more nested entries within a list of other elements—like generating summaries of articles in list of blog posts from their first text blocks.

The new `.eagerly()` method simplifies this in situations where you need to output or act on nested entry information within a query for their owners. Take this list of recipes, where `steps` is a Matrix field:

```twig
{% set latestRecipes = craft.entries()
  .section('recipes')
  .orderBy('postDate DESC')
  .limit(5)
  .all() %}

{% for recipe in latestRecipes %}
  <article>
    <h2>{{ recipe.title }}</h2>

    {{ recipe.summary|md }}

    <div>
      {{ recipe.estimatedTotalTime }}
      —
      {{ recipe.steps.eagerly().count() }} Step(s)
      —
      {{ recipe.difficulty }}
    </div>
  </article>
{% endfor %}
```

### Saving Matrix Fields

Working with nested entries is significantly more complex than other field types. The examples that follow assume some familiarity with [routing](../../system/routing.md) and [forms](../../development/forms.md), as well as a willingness to adapt the provided HTML (or extend it with JavaScript) to suit your needs.

If you have an element form (such as an [entry form](kb:entry-form)) that needs to manage content within a Matrix field, that data must be sent in a specific structure. We’re using JSON for the sake of its simple syntax, but the following examples will show you how to build a similarly-structured request with normal HTML `form` elements:

```json{2,7}
{
  "sortOrder": [
    321,
    654,
    "new:1"
  ],
  "entries": {
    "321": {
      "type": "myFirstTypeHandle",
      "fields": {
        "myTextFieldHandle": "...",
        "myAssetField": [
          4,
          5,
          6
        ]
      }
    },
    "654": {
      "type": "myOtherTypeHandle",
      "fields": {
        "myNumberField": 42,
        "myDateField": {
          "date": "2023-01-01",
          "time": "00:00",
          "timezone": "America/Los_Angeles"
        }
      }
    },
    "new:1": {
      "type": "myFirstTypeHandle",
      "fields": {
        "myTextFieldHandle": "...",
        "myAssetField": []
      }
    }
  }
}
```

The sections beginning with highlighted lines are covered below.

#### Entry Order

`sortOrder` should be submitted as an array of all the entry IDs you wish to persist (as well as any new entry identifiers), in the order they should be saved.

If you want all existing entries to persist in the same order they are currently in, then use this template to define your `sortOrder` array:

```twig
{% if entry is defined %}
  {% for nestedEntryId in entry.myFieldHandle.anyStatus().ids() %}
    {{ hiddenInput('fields[myFieldHandle][sortOrder][]', nestedEntryId) }}
  {% endfor %}
{% endif %}
```

::: tip
The `sortOrder` input elements do _not_ need to be adjacent in the DOM—you are free to distribute and collocate them with each entry’s data, if you wish. Wherever they are, though, they must ultimately be POSTed to Craft in the structure above.
:::

#### Entry Data

All of your entry data should be nested under a `entries` key, indexed by their ID. Each nested entry must submit its `type` (using the desired entry type’s handle) and custom field data nested under a `fields` key.

Here’s how you can output form fields for existing entries, for a Matrix field with two entry types (`text` and `image`):

```twig
{% for nestedEntry in entry.myFieldHandle.all() %}
  {# Prefix the nested entry’s input names with `fields[myFieldHandle][entries][<NestedEntryId>]` #}
  {% namespace "fields[myFieldHandle][entries][#{nestedEntry.id}]" %}
    {{ hiddenInput('type', nestedEntry.type) }}

    {% switch nestedEntry.type %}
      {% case 'text' %}
        {# Output fields relevant to the “Text” entry type: #}
        <textarea name="fields[myTextFieldHandle]">
          {{- nestedEntry.myTextFieldHandle|raw -}}
        </textarea>
      {% case 'image' %}
        {% set images = nestedEntry.myAssetFieldHandle.all() %}
        {% if images|length %}
          <ul>
            {% for image in nestedEntry.myAssetFieldHandle.all() %}
              <li>
                {{ image.getImg({ width: 100, height: 100 }) }}
                {{ hiddenInput('fields[myAssetFieldHandle][]', image.id) }}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
    {% endswitch %}
  {% endnamespace %}
{% endfor %}
```

::: tip
Outputting form fields for existing nested entries is completely optional. As long as those entries’ IDs are listed in the `sortOrder` array, they will persist even if their content was omitted from the form data.
:::

Craft also accepts nested entries’ UUIDs under the `sortOrder` key, so long as the `entries` are indexed with UUIDs _prefixed by `uid:`_. The structure would then look like this:

```js{3-4,7,10}
{
  "sortOrder": [
    "a86e9189-3bc8-4e87-ba52-58222b44c066",
    "8e7f2123-e684-4075-8680-175c5e4ab215",
  ],
  "entries": {
    "uid:a86e9189-3bc8-4e87-ba52-58222b44c066": {
      // ...
    },
    "uid:8e7f2123-e684-4075-8680-175c5e4ab215": {
      // ...
    },
  }
}
```

<a name="new-blocks"></a>

#### New Entries

To _add_ an entry from a front-end form, you’ll need a unique, temporary identifier for it, prefixed with `new:`.  Append that “ID” to the `sortOrder` array, and use it when constructing the entry’s form inputs.

For example, the first new entry that is added to the form could have an “ID” of `new:1`, so its `type` input name would end up looking like this (ignoring for a moment any `namespace` tags):

```html
<input type="hidden" name="fields[myFieldHandle][new:1][type]" value="text" />
```

Then define the form inputs for any additional entries that should be appended to the input.

```twig
{{ hiddenInput('fields[myFieldHandle][sortOrder][]', 'new:1') }}

{# Prefix the entry’s input names with `fields[myFieldHandle][blocks][new:1]` #}
{% namespace "fields[myFieldHandle][blocks][new:1]" %}
  {# This hidden `type` input will be expanded like the example above: #}
  {{ hiddenInput('type', 'text') }}

  {# Custom fields still need the `fields` prefix: #}
  <textarea name="fields[myTextFieldHandle]"></textarea>
{% endnamespace %}
```

If you want to make the new entry _optional_, you will need to give the user an opportunity to remove the inputs so they are not included in the request.

::: tip
The flexibility of Matrix fields often demands some client-side JavaScript—appending form fragments for different entry types, generating temporary IDs, rearranging entries and updating sort order, etc. are all difficult problems to solve with plain HTML. Craft’s UI relies on a host of control panel-specific scripts and markup—and therefore is generally not usable in the front-end.

However: as long as the data you ultimately POST to Craft conforms to the schema above, it will work! If you have a preferred view library like Vue or React, you may be better prepared than you think—your task then shifts from dealing with manipulating DOM elements to transforming your components’ state into a [`FormData` object](https://developer.mozilla.org/en-US/docs/Web/API/FormData) with the right parameter names and values.
:::

#### Validation Errors

Should you encounter [validation](../../development/forms.md#models-and-validation) issues within a Matrix field, Craft will set a [flash](../../development/forms.md#flashes) and add errors to the main element (under the Matrix field’s handle)—as well as on each nested entry with problems.

In these cases, it’s important to handle the nested entry data appropriately—the entries will be available directly on the main element as an array, and do not need to be fetched. In fact, trying to re-load the entries from the database would mean you are working with the last-persisted state, rather than the entries populated from the most recent request!

Instead, we’ll try three values:

1. Attempt to use the field value as an element query (load the entries fresh, assuming there are no pending changes hanging in-memory);
1. Accept the value, verbatim (assuming Craft has left the in-memory entries attached, and they _don’t_ need to be queried);
1. Default to an empty array (this ensures whatever uses the `nestedEntries` variable later on can safely assume it’s an array);

```twig
{% set nestedEntries = entry.myFieldHandle.all() ?? entry.myFieldHandle ?? [] %}
```

::: tip
The [null-coalescing operator](https://twig.symfony.com/doc/3.x/templates.html#other-operators) swallows errors that occur when attempting to access variables, properties, or methods that don’t exist.
:::

Temporary identifiers on new entries do _not_ need to stay the same between requests (say, if you created two entries but changed their order, then submitted and hit a validation error); you may output “new” entries in the order Craft has provided them, re-keying those entries:

```twig
{% for nestedEntry in nestedEntries %}
  {% set id = nestedEntry.id ?? "new:#{loop.index}" %}

  {{ hiddenInput('sortOrder[]', id) }}
  {{ hiddenInput("entries[#{id}][type]", nestedEntry.type.handle) }}

  {# ... #}
{% endfor %}
```
</file>

<file path="reference/field-types/money.md">
---
related:
  - uri: number.md
    label: Number fields
---

# Money Fields

Money fields give you a text input tailored for storing currency amounts.

<!-- more -->

## Settings

Money fields have the following settings:

- **Currency** – The currency in which values should be stored.
- **Default Value** – The default value that should be applied for new elements.
- **Min Value** – The lowest amount that may be entered in the field.
- **Max Value** – The highest amount that may be entered in the field.
- **Show Currency** – Whether to display the currency label with the field’s text input.
- **Size** – The input’s `size` attribute.

Values are always stored in the database as an integer, in the currency’s base or “minor” unit. For example, the Chilean Peso has no minor unit and is always expressed as a whole number; on the other hand, the Swiss Franc can be split into 100 _Rappen_. Even if you enter a value like `123.45 Fr.` in the control panel, it will be stored in the minor unit as `12345`.

## Development

### Querying Elements with Money Fields

When [querying for elements](../../development/element-queries.md) that have a Money field, you can filter the results based on the Money field data using a query param named after your field’s handle.

::: tip
When querying with a money field, provide amounts as you would naturally write them (`123.45`), _not_ in the currency’s minor unit (`12345`). Craft will automatically normalize the values when executing the query.
:::

Any value compatible with <craft5:craft\helpers\Db::parseMoneyParam()> can be passed as a query param:

| Value | Fetches elements…
| - | -
| `':empty:'` | …that have no amount saved.
| `':notempty:'` | …that have an amount saved.
| `'>= 123.45'` | …that have a normalized amount greater than `123.45`.
| `'< 123.45'` | …that have a normalized amount less than `123.45`.
| `['and', '>= 50.00', '< 75.00']` | …that have a normalized amount between `50.00` and `75.00`.
| `['or', '< -100.00', '> 100.00']` | …that have a normalized amount less than `-100.00` or greater than `100.00`.

All values are assumed to be in the field’s currency.

### Working with Money Field Data

If you have an element with a Money field in your template, you can output its value using the [money](../twig/filters.md#money) filter, or <craft5:craft\helpers\MoneyHelper::toString()>.

::: code
```twig
{% set value = entry.myFieldHandle|money %}
```
```php
$value = \craft\helpers\MoneyHelper::toString($entry->myFieldHandle);
```
:::

That will give you a formatted currency value for the field, if it has a value.
</file>

<file path="reference/field-types/multi-select.md">
---
related:
  - uri: checkboxes.md
    label: Checkboxes fields
  - uri: radio-buttons.md
    label: Radio buttons fields
---

# Multi-select Fields

Multi-select fields give you an input where multiple items may be selected.

<!-- more -->

![Screenshot of the multi-select field interface in the Craft control panel](../../images/fields-multi-select-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new multi-select field via the control panel.">
<img src="../../images/fields-multi-select-settings.png" alt="Dropdown field settings screen in the Craft control panel">
</BrowserShot>

Multi-select fields have the following settings:

- **Multi-select Options** – Define any number of options to populate the menu.
  - **Optgroup?** — Converts this option into a non-selectable “heading” to group other options.
  - **Label** — A text description of the option, displayed to the author.
  - **Value** — The value stored when a given option is selected.
  - **Icon** (Optional) — Choose from the standard system icon palette.
  - **Color** (Optional) — A color for the icon, or, when no icon is selected, a color pip.
  - **Default?** — One option can be marked as the default.

## Development

The order in which options are selected is _not_ preserved, and . If you wish to order the selections, consider using one of the [relational](README.md#references) fields.

### Working with Multi-select Field Data

If you have an element with a multi-select field in your template, you can access its data using your multi-select field’s handle:

::: code
```twig
{% set value = entry.myFieldHandle %}
```
```php
$value = $entry->myFieldHandle;
```
:::

That will give you a <craft5:craft\fields\data\MultiOptionsFieldData> object that contains the selected options’ labels and values. You can use this like an array:

::: code
```twig
{% for option in entry.myFieldHandle %}
  Label: {{ option.label }}
  Value: {{ option }} or {{ option.value }}
{% endfor %}
```
```php
foreach ($entry->myFieldHandle as $option) {
    // Label: $option->label
    // Value: (string)$option or $option->value
}
```
:::

To loop through _all_ the available options, iterate over the [options](craft5:craft\fields\data\MultiOptionsFieldData::getOptions()) property:

::: code
```twig
{% for option in entry.myFieldHandle.options %}
  Label:    {{ option.label }}
  Value:    {{ option }} or {{ option.value }}
  Selected: {{ option.selected ? 'Yes' : 'No' }}
{% endfor %}
```
```php
foreach ($entry->myFieldHandle->options as $option) {
    // Label:    $option->label
    // Value:    (string)$option or $option->value
    // Selected: $option->selected
}
```
:::

To see if any options are selected, use the [length](https://twig.symfony.com/doc/3.x/filters/length.html) filter (or PHP’s `count()` function):

::: code
```twig
{% if entry.myFieldHandle|length %}
  {# At least one option was selected! #}
{% endif %}
```
```php
if (count($entry->myFieldHandle)) {
    // At least one option was selected!
}
```
:::

To see if a particular option is selected, use [contains()](craft5:craft\fields\data\MultiOptionsFieldData::contains()):

::: code
```twig
{% if entry.myFieldHandle.contains('foo') %}
  {# `foo` is among the selected options! #}
{% endif %}
```
```php
if ($entry->myFieldHandle->contains('foo')) {
    // `foo` is among the selected options!
}
```
:::

### Querying Elements with Multi-select Fields

When [querying for elements](../../development/element-queries.md) that have a Multi-select field, you can filter the results based on the multi-select field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements…
| - | -
| `'foo'` | with a `foo` option selected.
| `'not foo'` | without a `foo` option selected.
| `['foo', 'bar']` | with `foo` or `bar` options selected.
| `['and', 'foo', 'bar']` | with `foo` and `bar` options selected.

::: code
```twig
{# Fetch entries with the 'foo' option selected #}
{% set entries = craft.entries()
  .myFieldHandle('foo')
  .all() %}
```
```php
// Fetch entries with the 'foo' option selected
$entries = \craft\elements\Entry::find()
    ->myFieldHandle('foo')
    ->all();
```
:::

### Saving Multi-select Fields

If you have a front-end element form (such as an [entry form](kb:entry-form)) that incorporates multi-select field data, you can use this template as a starting point:

```twig
{# Fetch the global field definition: #}
{% set field = craft.app.fields.getFieldByHandle('myFieldHandle') %}

{# Include a hidden input first so Craft knows to update the
   existing value, if no options are selected + submitted. #}
{{ hiddenInput('fields[myFieldHandle]', '') }}

<select multiple name="fields[myFieldHandle][]">
  {% for option in field.options %}
    {% set selected = entry is defined
      ? entry.myFieldHandle.contains(option.value)
      : option.default %}

    {{ tag('option', {
      value: option.value,
      text: option.label,
      selected: selected,
    })}}
  {% endfor %}
</select>
```
</file>

<file path="reference/field-types/number.md">
---
related:
  - uri: range.md
    label: Range fields
  - uri: money.md
    label: Money fields
---


# Number Fields

Number fields give you a [number input](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/number) that accepts a numeric value with specific bounds and granularity.

<!-- more -->

![Screenshot of a number field interface in the Craft control panel](../../images/fields-number-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new number field via the control panel.">
  <img src="../../images/fields-number-settings.png" alt="Number field settings screen in the Craft control panel">
</BrowserShot>

Number fields have the following settings:

- **Min Value** — The lowest number that may be entered in the field
- **Max Value** — The highest number that may be entered in the field.
- **Step Size** — The permitted granularity, mapped to the [`step`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/number#step) attribute of the resulting input.
- **Decimal Points** — The maximum number of decimal points that may be entered in the field.
- **Size** — The input’s [`size` attribute](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input#size).
- **Default Value** — The default value that should be applied for new elements.
- **Prefix Text** — Text that should be displayed before the input.
- **Suffix Text** — Text that should be displayed after the input.
- **Preview Format** — How field values will be formatted within element indexes.

## Development

### Querying Elements with Number Fields

When [querying for elements](../../development/element-queries.md) that have a Number field, you can filter the results based on the Number field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements…
| - | -
| `100` | with a value of 100.
| `'>= 100'` | with a value of at least 100.
| `['and', '>= 100', '<= 1000']` | with a value between 100 and 1,000.

::: code
```twig
{# Fetch entries with a Number field set to at least 100 #}
{% set entries = craft.entries()
  .myFieldHandle('>= 100')
  .all() %}
```
```php
// Fetch entries with a Number field set to at least 100
$entries = \craft\elements\Entry::find()
    ->myFieldHandle('>= 100')
    ->all();
```
:::

### Working with Number Field Data

If you have an element with a number field in your template, you can access its value using using the field’s handle:

::: code
```twig
{% set value = entry.myFieldHandle %}
```
```php
$value = $entry->myFieldHandle;
```
:::

That will give you the number value for the field, or `null` if there is no value.

To format the number with proper thousands separators (e.g. `,`), use the [number](../twig/filters.md#number) filter:

::: code
```twig
{{ entry.myFieldHandle|number }}
```
```php
\Craft::$app->getFormatter()->asDecimal($entry->myFieldHandle);
```
:::

If the number will always be an integer, pass `decimals=0` to format the number without any decimals.

::: code
```twig
{{ entry.myFieldHandle|number(decimals=0) }}
```
```php
\Craft::$app->getFormatter()->asDecimal($entry->myFieldHandle, 0);
```
:::


### Saving Number Fields

If you have an element form, such as an [entry form](kb:entry-form), that needs to contain a number field, you can use this template as a starting point:

```twig
{# Load the base field definition: #}
{% set field = craft.app.fields.getFieldByHandle('myFieldHandle') %}

{# Resolve a current or default value: #}
{% set value = entry is defined
  ? entry.myFieldHandle
  : field.defaultValue %}

{# Build the input: #}
<input
  type="number"
  name="fields[myFieldHandle]"
  min="{{ field.min }}"
  max="{{ field.max }}"
  step="{{ field.step }}"
  value="{{ value }}">
```
</file>

<file path="reference/field-types/plain-text.md">
# Plain Text Fields

**Plain text** fields give you either a normal text `input` or a multi-line `textarea`, where plain text can be entered. How that text is used is entirely up to you!

<!-- more -->

## Settings

Plain text fields have the following settings:

- **UI Mode** — How the field should be presented in the control panel. (Defaults to “Normal”, can be “Enlarged”.)
- **Placeholder Text** — The field’s placeholder text, to be displayed if the field has no value yet.
- **Field Limit** — The maximum number of characters or bytes the field is allowed to have. (Accepts a number and a unit, which defaults to “Characters” with another option for “Bytes”.)
- **Use a monospaced font** — Whether field input’s text will use a monospaced font.
- **Allow line breaks** — Whether to allow line breaks in this field.
  - **Initial Rows** — For multi-line inputs, choose how many lines of text fit in the field, initially. This setting does _not_ affect how many lines of text can be stored.

## The Field

Plain text fields will either show a normal text `input` element or a multi-line `textarea`, depending on whether **Allow line breaks** was checked. To give editors more space, increase the number of **Initial Rows**.

## Development

Accessing a plain text field in your templates will return the value that was entered in the field. Suppose our field was named “Summary” and had a handle of `summary`:

```twig
{{ entry.summary }}
```

### Testing for a Value

An empty text field is a “falsey” value, so you can use it in a conditional:

```twig
{% if entry.summary %}
  <h3>Summary</h3>
  <p>{{ entry.summary }}</p>
{% endif %}
```

Keep in mind that whitespace characters count the same as any other character—use the `trim` filter to remove spaces and newlines from the beginning and end:

```twig{1}
{% if entry.summary|trim %}
  {# Ok, there really is content in here! #}
  <h3>Summary</h3>
  <p>{{ entry.summary }}</p>
{% endif %}
```

### Processing Text

Craft’s [Twig environment](../../development/twig.md) has a ton of useful text processing features.

#### Markdown

Parse a field’s value as Markdown with the [`markdown` or `md` filter](../twig/filters.md#markdown-or-md):

```twig{3}
{% if entry.summary %}
  <h3>Summary</h3>
  {{ entry.summary|md }}
{% endif %}
```

Note that we’re not manually wrapping the output in `<p></p>` tags! Markdown takes care of this for us, unless you pass the `inlineOnly` argument:

```twig
<h3>{{ entry.stylizedHeader|md(inlineOnly = true) }}</h3>
```

#### Reference Tags

To include dynamic information in a Plain Text field, you can copy [reference tags](../../system/reference-tags.md) from other elements, then use the `parseRefs` filter to render their values:

::: code
``` Field Value
I can’t live without {globalset:snippets:primaryProductName}!
```
```twig Template
{{ entry.testimonial|parseRefs }}
```
```html Output
I can’t live without Butter™!
```
:::

### Querying

Plain text field values are stored as strings, and therefore support a variety of convenient query features via <craft5:craft\helpers\Db::parseParam()>.

#### Exact Matches

Open-ended inputs aren’t ideal for storing enum-style data (leave that to a [dropdown field](dropdown.md)), but you can still query based on the exact text content of a field:

```twig{3}
{% set reds = craft.entries()
  .section('swatches')
  .colorGroupCode('RED')
  .all() %}
```

#### Multiple Values

Match against a list using comma-separated values or an array:

```twig
{# Separate values with commas... #}
{% set sunrisePalette = craft.entries()
  .section('swatches')
  .colorGroupCode('PINK, RED, YELLOW, ORANGE')
  .all() %}

{# ...or use an array: #}
{% set sunrisePalette = craft.entries()
  .section('swatches')
  .colorGroupCode(['PINK', 'RED', 'YELLOW', 'ORANGE'])
  .all() %}
```

These examples are ultimately assembled into a `NOT IN (...)` SQL clause.

#### Negation

Exclude elements with a specific field value by preceding a value with `not`:

```twig
{% set notCool = craft.entries()
  .section('swatches')
  .colorGroupCode('not BLUE')
  .all() %}
```

Multiple values can be excluded by preceding each term in a comma-separated list by a `not` (`'not BLUE, not GREEN'`), or by using `not` as the first item in an array (`['not', 'BLUE', 'GREEN']`).

::: warning
The grouping of terms is important when combining ranges and negation! `not RED, YELLOW` means “Swatches with a color other than `RED`, _or_ swatches with a color of `YELLOW`.” On the other hand, `['not', 'RED', 'YELLOW']` means “Swatches with a color other than `RED` or `YELLOW`.” The former would exclude “red” swatches, but allow “yellow;” the latter would exclude both colors.
:::

#### Partial Matches

You can query using partial matches by including an asterisk (`*`) at the beginning and/or end of a value:

```twig
{# All “pastel” families: #}
{% set pastels = craft.entries()
  .section('swatches')
  .colorGroupCode('PASTEL-*')
  .all() %}

{# All “glossy” group variations: #}
{% set glosses = craft.entries()
  .section('swatches')
  .colorGroupCode('*-GLOSS')
  .all() %}
```

Combined with the above, a param like `'not *-MATTE'` is also valid. Queries that use asterisks are generally compiled into `LIKE` statements compatible with the database driver.

#### Empty Values

The special tokens `:empty:` and `:notempty:` can be used to find elements with a plain text field that is empty or populated, respectively. Both tokens are compiled into query conditions that compare against `null` _and_ empty string (`''`) values.

#### Literal Symbols

To use asterisks or commas in a query param, pass your value through the [`literal` Twig filter](../twig/filters.md#literal).

#### Case-Sensitivity

[Query values are case-sensitive](../../development/element-queries.md#case-sensitivity), by default. To make a query case-_insensitive_, use a hash with `value` and `caseInsensitive` keys:

```twig{3-6}
{% set reds = craft.entries()
  .section('swatches')
  .colorGroupCode({
    value: 'red',
    caseInsensitive: true,
  })
  .all() %}
```
</file>

<file path="reference/field-types/radio-buttons.md">
---
related:
  - uri: dropdown.md
    label: Dropdown fields
---

# Radio Buttons Fields

Radio buttons fields give you a group of [radio](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/radio) inputs, and allow the author to select a single value (or provide a custom one, when allowed).

<!-- more -->

![Screenshot of a radio buttons field interface in the Craft control panel](../../images/fields-radio-buttons-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new radio buttons field via the control panel.">
<img src="../../images/fields-radio-buttons-settings.png" alt="Radio buttons field settings screen in the Craft control panel">
</BrowserShot>

In addition to the standard field options, radio buttons fields have the following settings:

- **Radio Button Options** — Define any number of options to populate the menu.
  - **Label** — A text description of the option, displayed to the author.
  - **Value** — The value stored when a given option is selected.
  - **Icon** (Optional) — Choose from the standard system icon palette.
  - **Color** (Optional) — A color for the icon, or, when no icon is selected, a color pip.
  - **Default?** — One option can be marked as the default.
- **Allow custom options** — Whether authors can define an “other” option, on-the-fly.

## Development

### Working with Radio Buttons Field Data

If you have an element with a radio buttons field in a template, you can access its data using the field’s handle:

::: code
```twig
{% set value = entry.myRadioFieldHandle %}
```
```php
$value = $entry->myRadioFieldHandle;
```
:::

That will give you a <craft5:craft\fields\data\SingleOptionFieldData> object that contains information about the selected value and available options.

Outputting the object casts it to a string, which is equivalent to directly accessing its [value](craft5:craft\fields\data\SingleOptionFieldData::$value) property:

::: code
```twig
{{ entry.myRadioFieldHandle }} or {{ entry.myRadioFieldHandle.value }}
```
```php
$entry->myRadioFieldHandle; // -> craft\fields\data\SingleOptionFieldData
$entry->myRadioFieldHandle->value; // -> string
```
:::

To check if _any_ option is selected, you must test the [value](craft5:craft\fields\data\SingleOptionFieldData::$value) property, explicitly:

::: code
```twig
{% if entry.myRadioFieldHandle.value %}
  {# Yep, a value was selected! #}
{% endif %}
```
```php
if ($entry->myRadioFieldHandle->value) {
  // Yep, a value was selected!
}
```
:::

To show the selected option’s _label_, use the [label](craft5:craft\fields\data\SingleOptionFieldData::$label) property:

::: code
```twig
{{ entry.myRadioFieldHandle.label }}
{# "The selected option’s user-facing label!" #}
```
```php
$entry->myRadioFieldHandle->label; // -> "The selected option’s user-facing label!"
```
:::

::: warning
If the author provided a custom value, no label will be available.
:::

To loop through all the available options, iterate over the [options](craft5:craft\fields\data\SingleOptionFieldData::getOptions()) property. The selected option’s `selected` property will be `true`.

::: code
```twig
{% for option in entry.myRadioFieldHandle.options %}
  Label: {{ option.label }}
  Value: <code>{{ option.value }}</code>
  Selected: {{ option.selected ? 'Yes' : 'No' }}
{% endfor %}
```
```php
foreach ($entry->myRadioFieldHandle->options as $option) {
    $option->label;
    $option->value;
    $option->selected ? 'Yes' : 'No';
}
```
:::

If the author provides a “custom” value, no `option` will be marked as `selected`.

### Querying Elements with Radio Buttons Fields

When [querying for elements](element-queries.md) that have a radio buttons field, you can filter the results using a query param named after your field’s handle. Possible values include:

| Value | Fetches elements…
| - | -
| `'foo'` | with the `foo` option selected (or a custom value of `foo`).
| `'not foo'` | without the `foo` option selected (or a custom value of `foo`).
| `['foo', 'bar']` | with either the `foo` or `bar` options selected (or a custom value of `foo`).
| `['not', 'foo', 'bar']` | without either the `foo` or `bar` options selected (or a custom value of `foo`).

::: code
```twig
{# Fetch entries with the 'foo' option selected #}
{% set entries = craft.entries()
  .myRadioFieldHandle('foo')
  .all() %}
```
```php
// Fetch entries with the 'foo' option selected
$entries = \craft\elements\Entry::find()
    ->myRadioFieldHandle('foo')
    ->all();
```
:::

### Saving Radio Buttons Fields

If you have a front-end element form (such as an [entry form](kb:entry-form)) that incorporates radio button field data, you can use this fragment as a starting point:

```twig
{# Fetch the global field definition: #}
{% set field = craft.app.fields.getFieldByHandle('myRadioFieldHandle') %}
{% set currentValue = entry.myRadioFieldHandle.value ?? null %}
{% set hasCustomValue = currentValue and currentValue not in (field.options|map(o => o.value)) %}

<ul>
  {# Iterate over the defined options: #}
  {% for option in field.options %}
    {% set selected = currentValue == option.value or not currentValue and option.default %}

    <li>
      <label>
        {{ input('radio', 'fields[myRadioFieldHandle]', option.value, {
          checked: selected,
        }) }}
        {{ option.label }}
      </label>
    </li>
  {% endfor %}

  {# Optional — Provide a text input for a custom value: #}
  <li>
    <label>
      {{ input('radio', 'fields[myRadioFieldHandle]', '', {
        id: 'myRadioFieldHandleOther',
        checked: hasCustomValue,
      }) }}
      Other:
      {{ input('text', 'fields[myRadioFieldHandle]', hasCustomValue ? currentValue : null, {
        disabled: not hasCustomValue,
        id: 'myRadioFieldHandleCustom',
      }) }}
    </label>
  </li>
</ul>
```

Unfortunately, browsers will always send the _last_ input value among those with the same `name`. This means we need to selectively disable the text input:

```twig
<script>
  // Connect to the form element with an ID:
  const $form = document.getElementById('form');

  // 
  const $other = document.getElementById('myRadioFieldHandleOther');
  const $custom = document.getElementById('myRadioFieldHandleCustom');

  $form.addEventListener('change', function(e) {
    $custom.disabled = !$other.checked;
  });
</script>
```

The first snippet handles initializing the pair of inputs in the correct state; JavaScript takes over and watches for changes to the form, and synchronizes them in the client.
</file>

<file path="reference/field-types/range.md">
---
related:
  - uri: number.md
    label: Number fields
---

# Range Fields

Range fields give you a [range input](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/range) that allows authors to set a number using a visual slider or a number input.

<!-- more -->

![Screenshot of a range field interface in the Craft control panel](../../images/fields-range-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new range field via the control panel.">
  <img src="../../images/fields-range-settings.png" alt="Range field settings screen in the Craft control panel">
</BrowserShot>

Range fields have the following settings:

- **Min Value** — The _lowest_ number that may be accessed using the slider or entered manually.
- **Max Value** — The _highest_ number that may be accessed using the slider or entered manually.
- **Step Size** — The permitted granularity, mapped to the [`step`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/number#step) attribute of the resulting `range` and `number` inputs.
- **Default Value** — An initial value for the input, on new elements.
- **Suffix Text** — A string to include after the number input.

## Development

Working with range field values is identical to [number fields](number.md).
</file>

<file path="reference/field-types/README.md">
---
description: "Craft has over 20 built-in field types that help create tightly-tailored authoring and developer experiences."
related:
  - uri: ../../system/fields.md
    label: Fields and Content
  - uri: ../../system/elements.md
    label: Introduction to Elements
---

# Custom Field Types

Craft has over 20 built-in field types that help create tightly-tailored authoring and developer experiences. The table below lists fields in the same order you’ll encounter them in the [control panel](../../system/control-panel.md); you can also browse them by the [type of data](#data-types) they store.

<!-- more -->

<See path="../system/fields.md" label="Fields + Content" description="Get started with fields in Craft." />

## All Fields

| Field Type | Description |
| --- | --- |
| [Addresses](addresses.md) | Manage nested [address](../element-types/addresses.md) elements. |
| [Assets](assets.md) | Relate [asset](../element-types/assets.md) elements. |
| [Button Group](button-group.md) | Choose a single item from a graphical, icon-based toolbar. |
| [Categories](categories.md) | Relate [category](../element-types/categories.md) elements. |
| [Checkboxes](checkboxes.md) | Choose one or more predefined options using `checkbox` inputs. |
| [Color](color.md) | Pick a color with your platform’s native color picker—or provide a hexadecimal value. |
| [Country](country.md) | Choose from a list of countries in a `select` menu. |
| [Date/Time](date-time.md) | Set a date, time, and timezone (optional). |
| [Dropdown](dropdown.md) | Choose a single item from a predefined list using a `select` menu. |
| [Email](email.md) | Validate input as an email address. |
| [Entries](entries.md) | Relate [entry](../element-types/entries.md) elements. |
| [Icon](icon.md) | Pick from a palette of icons from [FontAwesome](https://fontawesome.com). |
| [Lightswitch](lightswitch.md) | Choose an _on_ or _off_ value using a switch. |
| [Link](link.md) | Define a link to an internal or external resource. |
| [Matrix](matrix.md) | Create [nested entries](../element-types/entries.md#nested-entries) from a list of allowed [entry types](../element-types/entries.md#entry-types). |
| [Money](money.md) | Store a value in a specific currency. |
| [Multi-Select](multi-select.md) | Choose one or more options via a tag-like [Selectize](https://selectize.dev/) input. |
| [Number](number.md) | Store a numeric value. |
| [Plain Text](plain-text.md) | Basic input for any kind of textual value. |
| [Radio Buttons](radio-buttons.md) | Choose one option from a predefined list. Equivalent to the _Dropdown_ field. |
| [Range](range.md) | Pick a number with a visual slider. |
| [Table](table.md) | Store repeating rows of simple values. |
| [Tags](tags.md) | Relate [tag](../element-types/tags.md) elements. |
| [Time](time.md) | Choose a time _without_ a date. |
| [Users](users.md) | Relate [user](../element-types/users.md) elements. |

## Data Types

Not sure which field type to use? This list is organized by the types of values that each field stores. Each field may appear in multiple groups!

### Text

Arbitrary and predefined strings.

- [Plain Text](plain-text.md) — Single- or multi-line text of any length.
- [Dropdown](dropdown.md) — A fixed set of options to choose from.
- [Radio Buttons](radio-buttons.md) — Same as a dropdown, but allows “custom” values.
- [Country](country.md) — A specific set of values used to populate addresses.
- [Email](email.md) — Validate an email address. (See: [Link](link.md))

::: tip
Our first-party [CKEditor](plugin:ckeditor) plugin provides a powerful rich text composer that also supports [nested entries](../element-types/entries.md#nested-entries).
:::

### Booleans

On or off; yes or no; 1 or 0; true or false!

- [Lightswitch](lightswitch.md) — A single on/off switch.
- [Checkboxes](checkboxes.md) — Capture multiple binary settings at once.

### Numbers

- [Money](money.md) — A safer way to store currency values.
- [Number](number.md) — Single numeric value with controls for min/max values and precision.
- [Range](range.md) — A number field with an additional slider UI for tactile selection.

### Date + Time

These fields yield `DateTime` objects that can be conveniently compared, queried, and formatted in templates.

- [Date](date-time.md) — Capture a date _and_ time.
- [Time](time.md) — Store only the time of day.

### Lists

Sometimes, you need more than a single value!

- [Checkboxes](checkboxes.md) — Select any number of predefined options, or let authors set one manually.
- [Matrix](matrix.md) — Manage nested entries as an embedded element index or inline blocks.
- [Multi-Select](multi-select.md) — A rudimentary multi-select input, without manual options.
- [Table](table.md) — Repeatable rows of simple data.

::: tip
Most of the fields in the [references](#references) section allow you to attach multiple relationships, as well.
:::

### References

Create [relationships](../../system/relations.md) to content, on- or off-site.

- [Link](link.md) — Flexible input for multiple kinds of locators, like URLs, element relationships, phone numbers, and email addresses.
- [Assets](categories.md) — Connect uploaded [media](#media) to any element.
- [Categories](categories.md) — Organize elements into hierarchical [taxonomies](#taxonomies).
- [Entries](entries.md) — Relate content to or from anywhere!
- [Tags](tags.md) — Organize elements into a flat “[folksonomy](#taxonomies).”
- [Users](users.md) — Associate users with any type of content.

### Taxonomies

Help users and authors understand content by establishing explicit connections.

- [Categories](categories.md) — Connect content to hierarchical structures.
- [Tags](tags.md) — Expressive, ad-hoc organization.
- [Entries](entries.md) — Anything can be a taxonomy!

::: tip
You can even attach fields to the elements you relate via these fields—metadata for your metadata!
:::

### Media

- [Assets](assets.md) — Upload and attach files to anything.

### Structured

Manage nested data.

- [Addresses](addresses.md)
- [Matrix](matrix.md)
- [Table](table.md)

::: tip
Have a complex content model? You can nest entries as deeply as you want!
:::

### Fun + Cosmetic

Spruce up the authoring experience with these dedicated UIs.

- [Color](color.md) — Select from a palette of colors, or choose a new one.
- [Button Group](button-group.md) — Choose from options identified by an icon—great for layout, positioning, and scale controls
- [Icon](icon.md) — Pick from a library of icons.
- [Money](money.md) — Input values in a specific currency.
- [Range](range.md) — Contextualize numeric values.
</file>

<file path="reference/field-types/table.md">
# Table Fields

Table fields give you a customizable table, where you can manage data or content in compact rows.

<!-- more -->

## Settings

Table fields have the following settings:

**Table Columns**
:   Define the columns that will be available to your Table field. Each column has the following properties:

    - **Column Heading** — The name that will appear in the head of the table.
    - **Handle** — How you’ll refer to this column from your templates.
    - **Width** — The width for this column specified in either pixels or a percentage.
    - **Type** — The field or content type for the column. Choose from: Checkbox, Color, Date, Dropdown, Email, Lightswitch, Multi-line text, Number, Single-line text, Time, or URL. An additional _Row Heading_ column type provides a non-editable area for labels, and is most useful in combination with the **Static Rows** option.

      ::: tip
      Not all field types are available as table columns due to UI and storage constraints. If you need the full array of custom field types, consider using nested entries via a [Matrix field](matrix.md), instead.
      :::

**Default Values**
:   Define the default row and column values for new instances of the field.

**Static Rows**
:   Choose whether rows can be managed by the author, or if the table should include only the rows defined in **Default Values**. Use the **Row Heading** column type to create read-only labels for each row, and clear all **Column Heading** fields to remove the table’s header.

**Min Rows**
:   The _minimum_ number of rows that must be provided.

**Max Rows**
:   The _maximum_ number of rows allowed.

## The Field

Table fields’ appearance and available controls depends on their configuration and whether you are working on a new or existing element.

- **New elements** show the rows as defined by the **Default Values** setting.
- **Existing elements** will display an empty table. (An “existing element” is one that was created prior to the field being added to its field layout.)

Fields that use the **Static Rows** setting will _always_ display the rows defined in the field’s settings, but the values of each cell will still be determined by the stored data—or the defaults, for fresh elements. **Row Heading** columns are never editable.

::: tip
The appearance of a table field in an element editor will be identical to the table shown in the **Default Values** setting.
:::

## Development

### Querying Elements with Table Fields

Due to the way Table field data is stored (a blob of JSON), [element queries](../../development/element-queries.md) can be challenging to construct. Internally, Craft stores each row with keys that are stable across changes to [project config](../../system/project-config.md), and won’t always agree with the handles you’ve defined in the field’s settings.

::: tip
If you anticipate needing to query by sub-fields, consider using nested entries via the [Matrix](matrix.md) field, instead. As a native element type, entries support the full array of element query params required to narrow results by specific fields’ values.
:::

### Working with Table Field Data

Table fields return an array of rows, whether you access the data via its field handle on an element or by requesting it via GraphQL.

Each row is an array of values indexed by their column handles. For example, a field that catalogued whiskeys might have columns for:

- **Name**, Single-line text, `whiskey`;
- **Description**, Single-line text, `description`;
- **Proof**, Number, `proof`;

::: code
```twig
<h3>Whiskeys</h3>
<ul>
  {% for row in entry.myFieldHandle %}
    <li>{{ row.whiskey }}: {{ row.description }} ({{ row.proof }} proof, {{ row.proof / 2 }}%)</li>
  {% endfor %}
</ul>
```
```php
foreach ($entry->myFieldHandle as $row) {
    // Each row is a plain array, not an object:
    $row['whiskey'];
    $row['description'];
    $row['proof'];
}
```
```graphql
{
  # (...) query for relevant entry
  myFieldHandle {
    whiskey
    description
    proof
  }
}
```
:::

::: tip
In each example above, the custom column handle can also be accessed by a key named `'col*'`, where `*` is the order in which it was created. Example:

- `whiskey` → `col1`
- `description` → `col2`
- `proof` → `col3`

This is also how Craft stores the data, under the hood—which makes it possible to rename and rearrange columns without misplacing their values!
:::

Table field data evaluates cleanly as a boolean, but you can explicitly check whether one [has any data](../../development/twig.md#emptiness) by using the [`is empty` test](https://twig.symfony.com/doc/3.x/tests/empty.html) or the [`length` filter](https://twig.symfony.com/doc/3.x/filters/length.html):

```twig
{# Basic conditional: #}
{% if entry.myFieldHandle %}
  {# An array with any values is “truthy!” #}
{% endif %}

{# Emptiness test: #}
{% if entry.myFieldHandle is not empty %}
  {# Note the `not`—we only want to render this block if there *is* data! #}
{% endif %}

{# Length check: #}
{% if entry.myFieldHandle|length %}
  {# At least one row is present! #}
{% endif %}

{# Test for a specific number of rows: #}
{% if entry.myFieldHandle|length >= 3 %}
  {# Three or more rows have been added to this table field. #}
{% endif %}
```

Other functions, filters, and tags that operate on arrays can also be used on table field data!

### Mutating Table Data

You can mutate table data by providing an array of rows, each representing its column’s data with a `'col*'` key:

```graphql
mutation saveEntry(
  $title: String,
  $slug: String,
  $authorId: ID,
  $tableRows: [myFieldHandle_TableRowInput],
) {
  save_cocktails_cocktails_Entry(
    title: $title,
    slug: $slug,
    authorId: $authorId,
    myFieldHandle: $tableRows
  ) {
    title
    slug
    authorId
    dateCreated @formatDateTime (format: "Y-m-d")
    myFieldHandle {
      whiskey
      description
      proof
    }
  }
}

# query variables:
{
  "title": "Whiskies",
  "slug": "whiskies",
  "authorId": 1,
  "tableRows": [
    {
      "col1": "High West Double Rye",
      "col2": "Blend of straight and rye whiskeys.",
      "col3": 92
    },
    {
      "col1": "Blanton’s Single Barrel",
      "col2": "Has been called liquid gold.",
      "col3": 92
    },
  ]
}
```

Check your field’s definition in the database (or inspect the field in an entry form) to find the appropriate `col*` names.
</file>

<file path="reference/field-types/tags.md">
---
description: Use element-based “folksonomies” to connect content.
related:
  - uri: ../element-types/tags.md
    label: Tag Elements
  - uri: ../../system/relations.md
    label: Using Relationships
---

# Tags Fields

Tags fields allow you relate [tags](../element-types/tags.md) to other elements. It is one of Craft’s [relational](../../system/relations.md) custom fields.

<!-- more -->

![Screenshot of the tags field interface in the Craft control panel](../../images/fields-tags-ui.png)

## Settings

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Adding a new tags field via the control panel.">
<img src="../../images/fields-tags-settings.png" alt="Tags field settings screen in the Craft control panel">
</BrowserShot>

Tags fields have the following settings:

- **Source** — Which tag group the field should be able to relate tags from. Only one source is allowed, because Craft needs to know which group to create new tags in.
- **Default Tag Placement** — Whether new selections are prepended or appended to the existing relations.
- **“Add” Button Label** — The label that should be used on the field’s search input.
- **Validate related tags** — Whether or not validation errors on the related tags will be bubbled up.

### Advanced Settings

Additional settings are available under the **Advanced** toggle:

- **Allow self-relations** — If this field is added to a tag group field layout, should the author be allowed to select the tag they are editing as a relationship to itself?

### Multi-Site Settings

On multi-site installs, the following settings will also be available:

- **Translation Method** — How relationships are handled when [propagating changes to other sites](../../system/fields.md#translation-methods).
- **Relate tags from a specific site?** — Whether to only allow relations to tags from a specific site.
  - If _enabled_, a new setting will appear where you can choose which site.
  - If _disabled_, related tags will always be pulled from the current site.

- **Show the site menu** — Whether to display the site menu in tag selection modals. (This setting is hidden when relations are locked to a single site.)

<See path="../../system/fields.md" hash="translation-methods" label="Translation Methods" description="Learn about options for translating field values." />

## The Field

Tags fields list all the currently-related tags with a text input to add new ones.

As you type into the text input, the Tags field will search through the existing tags that belong to the field’s tag group (per its Source setting), and suggest tags in a menu below the text input. If an exact match is not found, the first option in the menu will create a new tag named after the input value.

::: tip
By default you won’t be able to create multiple tags that are too similar in name. You can change that behavior by enabling the <config5:allowSimilarTags> config setting.
:::

### Inline Tag Editing

When you double-click on a related tag, a [slideout](../../system/control-panel.md#slideouts) will appear where you can edit the tag’s title and any custom fields added to its group’s field layout.

## Development

### Querying Elements with Tags Fields

When [querying for elements](../../development/element-queries.md) that have a Tags field, you can filter the results based on the Tags field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements…
| - | -
| `':empty:'` | that don’t have any related tags.
| `':notempty:'` | that have at least one related tag.
| `100` | that are related to the tag with an ID of 100.
| `[100, 200]` | that are related to a tag with an ID of 100 or 200.
| `[':empty:', 100, 200]` | with no related tags, or related to a tag with an ID of 100 or 200.
| `['and', 100, 200]` | that are related to the tags with IDs of 100 and 200.
| an [Tag](craft5:craft\elements\Tag) object | that are related to the tag.
| an [TagQuery](craft5:craft\elements\db\TagQuery) object | that are related to any of the resulting tags.

::: code
```twig
{# Fetch entries with a related tag #}
{% set entries = craft.entries()
  .myFieldHandle(':notempty:')
  .all() %}
```
```php
// Fetch entries with a related tag
$entries = \craft\elements\Entry::find()
    ->myFieldHandle(':notempty:')
    ->all();
```
:::

### Working with Tags Field Data

If you have an element with a Tags field in your template, you can access its related tags using your Tags field’s handle:

::: code
```twig
{% set query = entry.myFieldHandle %}
```
```php
$query = $entry->myFieldHandle;
```
:::

That will give you a [tag query](../element-types/tags.md#querying-tags), prepped to output all the related tags for the given field.

To loop through all the related tags, call [all()](craft5:craft\db\Query::all()) and then loop over the results:

::: code
```twig
{% set relatedTags = entry.myFieldHandle.all() %}
{% if relatedTags|length %}
  <ul>
    {% for rel in relatedTags %}
      <li><a href="{{ url('tags/'~rel.slug) }}">{{ rel.title }}</a></li>
    {% endfor %}
  </ul>
{% endif %}
```
```php
$relatedTags = $entry->myFieldHandle->all();
if (count($relatedTags)) {
    foreach ($relatedTags as $rel) {
        // \craft\helpers\UrlHelper::url('tags/' . $rel->slug)
        // $rel->title
    }
}
{% endif %}
```
:::

If you only want the first related tag, call [one()](craft5:craft\db\Query::one()) and make sure it returned something:

::: code
```twig
{% set rel = entry.myFieldHandle.one() %}
{% if rel %}
  <p><a href="{{ url('tags/'~rel.slug) }}">{{ rel.title }}</a></p>
{% endif %}
```
```php
$rel = $entry->myFieldHandle->one();
if ($rel) {
    // \craft\helpers\UrlHelper::url('tags' . $rel->slug)
    // $rel->title
}
```
:::

If you need to check for any related tags without fetching them, you can call [exists()](craft5:craft\db\Query::exists()):

::: code
```twig
{% if entry.myFieldHandle.exists() %}
  <p>There are related tags!</p>
{% endif %}
```
```php
if ($entry->myFieldHandle->exists()) {
    // There are related tags!
}
```
:::

You can set [parameters](../element-types/tags.md#parameters) on the tag query as well.

::: code
```twig
{% set relatedTags = entry.myFieldHandle
  .group('blogEntryTags')
  .all() %}
```
```php
$relatedTags = $entry->myFieldHandle
    ->group('blogEntryTags')
    ->all();
```
:::

::: tip
<Todo notes="Extract this into a snippet." />

In Craft 3, we recommended cloning these query objects using the [`clone` keyword](https://www.php.net/manual/en/language.oop5.cloning.php) or [`clone()`](../twig/functions.md#clone) Twig function before applying params. **This is no longer required in Craft 4**, because a new copy of the query is returned each time you access the field property.
:::

### Saving Tags Fields

If you have an element form, such as an [entry form](kb:entry-form), that needs to contain a Tags field, you will need to submit your field value as a list of tag IDs, in the order you want them to be related.

For example, you could create a list of checkboxes for each of the possible relations:

```twig
{# Include a hidden input first so Craft knows to update the existing value
   if no checkboxes are checked. #}
{{ hiddenInput('fields[myFieldHandle]', '') }}

{# Get all of the possible tag options #}
{% set possibleTags = craft.entries()
  .group('blogEntryTags')
  .orderBy('title ASC')
  .all() %}

{# Get the currently related tag IDs #}
{% set relatedTagIds = entry is defined
  ? entry.myFieldHandle.ids()
  : [] %}

<ul>
  {% for possibleTag in possibleTags %}
    <li>
      <label>
        {{ input(
          'checkbox',
          'fields[myFieldHandle][]',
          possibleTag.id,
          { checked: possibleTag.id in relatedTagIds }
        ) }}
        {{ possibleTag.title }}
      </label>
    </li>
  {% endfor %}
</ul>
```

You could then make the checkbox list sortable, so users have control over the order of related tags.

## See Also

- [Tag Queries](../element-types/tags.md#querying-tags)
- <craft5:craft\elements\Tag>
- [Relations](../../system/relations.md)
</file>

<file path="reference/field-types/time.md">
---
related:
  - uri: date-time.md
    label: Date + Time fields
---

# Time Fields

Time fields provide a time picker input without a date component. When you [access a time field’s value](#development), Craft hydrates the stored “time” value (a string with the format `H:i`, in the system’s timezone) into a native PHP `DateTime` object.

<!-- more -->

![Screenshot of two side-by-side time fields in the Craft control panel](../../images/fields-time-ui.png)

## Settings

When creating a time field, you can customize the minute increment and optionally set minimum and maximum times that are allowed.

::: warning
Changing the system’s timezone can cause previously-saved time field values to become inaccurate!
:::

## Development

### Querying Elements with Time Fields

When [querying for elements](../../development/element-queries.md) that have a time field, you can filter the results based on the time field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements…
| - | -
| `':empty:'` | …that don’t have a selected time.
| `':notempty:'` | …that have a selected time.
| `'>= 09:00'` | …that have a time selected on or after 9:00AM.
| `'< 09:00'` | …that have a time selected before 9:00AM.
| `['and', '>= 09:00', '< 17:00']` | …that have a time selected between 9:00AM and 5:00PM.
| `['or', '< 09:00', '> 17:00']` | …that have a time selected before 9:00AM or after 5:00PM.

::: code
```twig
{# Fetch entries with with a selected time before 9:00AM #}
{% set entries = craft.entries()
  .myFieldHandle('< 09:00')
  .all() %}
```
```php
// Fetch entries with with a selected time before 9:00 AM
$entries = \craft\elements\Entry::find()
    ->myFieldHandle('< 09:00')
    ->all();
```
:::

::: warning
All query parameters must use 24-hour timestamps. Time field values are compared as strings (not database-native dates or times).
:::

### Working with Time Field Data

If you have an element with a time field in your template, you can access its value by its handle:

::: code
```twig
{% set time = entry.myTimeFieldHandle %}
```
```php
$time = $entry->myTimeFieldHandle;
```
:::

That will give you a [DateTime](http://php.net/manual/en/class.datetime.php) object that represents the selected time with the date implicitly set to “today” (or `null` if no time was selected).

If it’s set, you can output a formatted time based on its value using the [time](../twig/filters.md#time) filter.

::: code
```twig
{% if entry.myFieldHandle %}
  Selected time: {{ entry.myFieldHandle|time('short') }}
{% endif %}
```
```php
if ($entry->myFieldHandle) {
    $selectedTime = \Craft::$app->getFormatter()->asTime(
        $entry->myFieldHandle, 
        'short'
    );
}
```
:::

You can compare a time field’s value with any other `DateTime` instance:

```twig
{% if storeInfo.openTime <= now() and storeInfo.closeTime > now() %}
  Come on in!
{% else %}
  Sorry, we’re closed!
{% endif %}
```

### Saving Time Fields

If you have an element form, such as an [entry form](kb:entry-form), that needs to contain a Time field, you can create a `time` input.

```twig
{% set currentValue = entry is defined and entry.myTimeField
  ? entry.myTimeField|date('H:i')
  : '' %}

<input type="time" name="fields[myTimeField]" value="{{ currentValue }}">
```

#### Customizing the Timezone

By default, Craft will assume the date is sent in the system timezone. You can use a different timezone by changing the input name to `fields[myTimeField][time]` and adding a hidden input named `fields[myTimeField][timezone]`, set to a [valid PHP timezone](http://php.net/manual/en/timezones.php):

```twig{5}
{# Set a specific timezone #}
{% set tz = 'America/Los_Angeles' %}

{% set currentValue = entry is defined and entry.myTimeField
  ? entry.myTimeField|date('H:i', timezone=tz)
  : '' %}

<input type="time" name="fields[myTimeField][time]" value="{{ currentValue }}">
{{ hiddenInput('fields[myTimeField][timezone]', tz) }}
```

Note that we are converting the field’s current value into the specified timezone before rendering it into the `input`.

You can also let users decide which timezone the time value should be posted in:

```twig
{% set currentValue = entry is defined and entry.myTimeField
  ? entry.myTimeField|date('H:i', timezone='UTC')
  : '' %}

<input type="time" name="fields[myTimeField][time]" value="{{ currentValue }}">

<select name="fields[myTimeField][timezone]">
  <option value="UTC" selected>UTC</option>
  <option value="America/Los_Angeles">Pacific Time</option>
  <!-- ... -->
</select>
```

In this example, we always display the time in UTC and reset the time zone menu to match. If you would prefer to use the system timezone as the default, you can omit `timezone='UTC'` from the [`date()` filter](../twig/filters.md#date), and determine the timezone menu’s initially-selected option using `craft.app.timezone`:

```twig
{% set tzs = [
  { label: 'UTC', value: 'UTC' },
  { label: 'Los Angeles', value: 'America/Los_Angeles' },
] %}

<select name="fields[myTimeField][timezone]">
  {% for tz in tzs %}
    <option value="{{ tz.value }}" {{ craft.app.timezone == tz.value ? 'selected' : null }}>{{ tz.label }}</option>
  {% endfor %}
</select>
```

::: tip
While applicable mostly to generating HTML in the [control panel](../../system/control-panel.md), Craft provides access to a list of all timezones supported by the system:

```twig
{% set tzs = craft.cp.getTimeZoneOptions() %}

<select name="fields[myTimeField][timezone]">
  {% for tz in tzs %}
    <option value="{{ tz.value }}" {{ craft.app.timezone == tz.value ? 'selected' : null }}>{{ tz.data.hint }}</option>
  {% endfor %}
</select>
```

Human-friendly descriptions are provided in each timezone’s `data.hint` property.
:::
</file>

<file path="reference/field-types/users.md">
---
related:
  - uri: ../element-types/users.md
    label: User Elements
  - uri: ../../system/relations.md
    label: Using Relationships
  - uri: ../../system/user-management.md
    label: Managing Users + Permissions
---


# Users Fields

Users fields allow you relate [users](../element-types/users.md) to other elements. It is one of Craft’s [relational](../../system/relations.md) custom fields.

<!-- more -->

## Settings

Users fields have the following settings:

- **Sources** – Which user groups (or other user index [source](../../system/elements.md#sources)) the field should be able to relate users from.
- **Selectable Users Condition** – Rules that determine which users should be available for selection.
- **Min Relations** – The _minimum_ number of users that must be selected. (Default is no limit.)
- **Max Relations** – The _maximum_ number of users that can be selected. (Default is no limit.)
- **Default User Placement** — Whether new selections are prepended or appended to the existing relations.
- **View Mode** — How the related users are displayed to authors (_List_ or _Cards_).
- **“Add” Button Label** – The label that should be used on the field’s selection button.
- **Validate related users** — Whether or not validation errors on the related users will be bubbled up.

### Advanced Settings

Additional settings are available under the **Advanced** toggle:

- **Allow self-relations** — If this field is added to the user element field layout, should the author be allowed to select the user they are editing as a relationship to itself?


### Multi-Site Settings

On multi-site installs, the following setting will also be available:

- **Translation Method** — How relationships are handled when [propagating changes to other sites](../../system/fields.md#translation-methods).

While user elements do have an [affiliated site](../../system/user-management.md#affiliated-site) <Since ver="5.6.0" feature="Affiliated sites for users" />, their content is not localized (and therefore, you cannot establish relationships to a specific site, as you can with other relational fields). You may still use the **Translation Method** setting to determine whether authors can select different users for each site, site group, or language.

## The Field

Users fields list all of the currently-related users, with a button to select new ones.

Clicking the “Add a user” button will bring up a modal window where you can find and select additional users.

### Inline User Editing

When you double-click on a related user, a [slideout](../../system/control-panel.md#slideouts) will appear where you can edit the user’s custom fields.

## Development

### Querying Elements with Users Fields

When [querying for elements](../../development/element-queries.md) that have a Users field, you can filter the results based on the Users field data using a query param named after your field’s handle.

Possible values include:

| Value | Fetches elements…
| - | -
| `':empty:'` | that don’t have any related users.
| `':notempty:'` | that have at least one related user.
| `100` | that are related to the user with an ID of 100.
| `[100, 200]` | that are related to a user with an ID of 100 or 200.
| `[':empty:', 100, 200]` | without related users, or related to a user with an ID of 100 or 200.
| `['and', 100, 200]` | that are related to the users with IDs of 100 and 200.
| an [User](craft5:craft\elements\User) object | that are related to the user.
| an [UserQuery](craft5:craft\elements\db\UserQuery) object | that are related to any of the resulting users.

::: code
```twig
{# Fetch entries with a related user #}
{% set entries = craft.entries()
  .myFieldHandle(':notempty:')
  .all() %}
```
```php
// Fetch entries with a related user
$entries = \craft\elements\Entry::find()
    ->myFieldHandle(':notempty:')
    ->all();
```
:::

### Working with Users Field Data

If you have an element with a Users field in your template, you can access its related users using your Users field’s handle:

::: code
```twig
{% set query = entry.myFieldHandle %}
```
```php
$query = $entry->myFieldHandle;
```
:::

That will give you a [user query](../element-types/users.md#querying-users), prepped to output all the related users for the given field.

To loop through all the related users, call [all()](craft5:craft\db\Query::all()) and then loop over the results:

::: code
```twig
{% set relatedUsers = entry.myFieldHandle.all() %}
{% if relatedUsers|length %}
  <ul>
    {% for rel in relatedUsers %}
      <li><a href="{{ url('profiles/'~rel.username) }}">{{ rel.name }}</a></li>
    {% endfor %}
  </ul>
{% endif %}
```
```php
$relatedUsers = $entry->myFieldHandle->all();
if (count($relatedUsers)) {
    foreach ($relatedUsers as $rel) {
        // \craft\helpers\UrlHelper::url('profiles/' . $rel->username)
        // $rel->name
    }
}
```
:::

If you only want the first related user, call [one()](craft5:craft\db\Query::one()) and make sure it returned something:

::: code
```twig
{% set rel = entry.myFieldHandle.one() %}
{% if rel %}
  <p><a href="{{ url('profiles/'~rel.username) }}">{{ rel.name }}</a></p>
{% endif %}
```
```php
$rel = $entry->myFieldHandle->one();
if ($rel) {
    // \craft\helpers\UrlHelper::url('profiles/' . $rel->username)
    // $rel->name
}
```
:::

If you need to check for related users without fetching them you can call [exists()](craft5:craft\db\Query::exists()):

::: code
```twig
{% if entry.myFieldHandle.exists() %}
  <p>There are related users!</p>
{% endif %}
```
```php
if ($entry->myFieldHandle->exists()) {
    // There are related users!
}
```
:::

You can set [parameters](../element-types/users.md#parameters) on the user query as well. For example, to only fetch users in the `authors` group, set the [groupId](../element-types/users.md#groupid) param:

::: code
```twig
{% set relatedUsers = entry.myFieldHandle
    .group('authors')
    .all() %}
```
```php
$relatedUsers = $entry->myFieldHandle
    ->group('authors')
    ->all();
```
:::

::: tip
<Todo notes="Extract this into a snippet." />

In Craft 3, we recommended cloning these query objects using the [`clone` keyword](https://www.php.net/manual/en/language.oop5.cloning.php) or [`clone()`](../twig/functions.md#clone) Twig function before applying params. **This is no longer required in Craft 4**, because a new copy of the query is returned each time you access the field property.
:::

### Saving Users Fields

If you have an element form, such as an [entry form](kb:entry-form), that needs to contain a Users field, you will need to submit your field value as a list of user IDs, in the order you want them to be related.

For example, you could create a list of checkboxes for each of the possible relations:

```twig
{# Include a hidden input first so Craft knows to update the existing value
   if no checkboxes are checked. #}
{{ hiddenInput('fields[myFieldHandle]', '') }}

{# Get all of the possible user options #}
{% set possibleUsers = craft.users()
  .group('authors')
  .orderBy('username ASC')
  .all() %}

{# Get the currently related user IDs #}
{% set relatedUserIds = entry is defined
  ? entry.myFieldHandle.ids()
  : [] %}

<ul>
  {% for possibleUser in possibleUsers %}
    <li>
      <label>
        {{ input(
          'checkbox',
          'fields[myFieldHandle][]',
          possibleUser.id,
          { checked: possibleUser.id in relatedUserIds }
        ) }}
        {{ possibleUser.friendlyName }}
      </label>
    </li>
  {% endfor %}
</ul>
```

You could then make the checkbox list sortable, so users have control over the order of related entries.

## See Also

- [User Queries](../element-types/users.md#querying-users)
- [Addresses](../element-types/addresses.md)
- <craft5:craft\elements\User>
- [Relations](../../system/relations.md)
</file>

<file path="reference/twig/filters.md">
---
description: Fluidly manipulate and decorate values in your templates.
related:
  - uri: ../../development/templates.md
    label: Introduction to Templating
  - uri: ../../development/twig.md
    label: Using Twig in Craft
---

# Filters

The following [filters](https://twig.symfony.com/doc/3.x/templates.html#filters) are available to Twig templates in Craft.

<See path="../../development/templates.md" />

Filter | Description
------ | -----------
[abs](https://twig.symfony.com/doc/3.x/filters/abs.html) | Returns the absolute value of a number.
[address](#address) | Formats an address.
[append](#append) | Appends HTML to the end of another element.
[ascii](#ascii) | Converts a string to ASCII characters.
[atom](#atom) | Converts a date to an ISO-8601 timestamp.
[attr](#attr) | Modifies an HTML tag’s attributes.
[base64_decode](#base64-decode) | Decodes a base64 string.
[base64_encode](#base64-encode) | Encodes a string as base64.
[batch](https://twig.symfony.com/doc/3.x/filters/batch.html) | Batches items in an array.
[boolean](#boolean) | Coerces the passed value to a boolean.
[camel](#camel) | Formats a string into camelCase.
[capitalize](https://twig.symfony.com/doc/3.x/filters/capitalize.html) | Capitalizes the first character of a string.
[column](#column) | Returns the values from a single property or key in an array.
[contains](#contains) | Returns whether an array contains a nested item with a given key-value pair.
[convert_encoding](https://twig.symfony.com/doc/3.x/filters/convert_encoding.html) | Converts a string from one encoding to another.
[currency](#currency) | Formats a number as currency.
[date_modify](https://twig.symfony.com/doc/3.x/filters/date_modify.html) | Modifies a date.
[date](#date) | Formats a date.
[datetime](#datetime) | Formats a date with its time.
[default](https://twig.symfony.com/doc/3.x/filters/default.html) | Returns the value or a default value if empty.
[diff](#diff) | Returns the difference between arrays.
[duration](#duration) | Returns a `DateInterval` object.
[encenc](#encenc) | Encrypts and base64-encodes a string.
[escape](https://twig.symfony.com/doc/3.x/filters/escape.html) | Escapes a string.
[explodeClass](#explodeclass) | Converts a `class` attribute value into an array of class names.
[explodeStyle](#explodestyle) | Converts a `style` attribute value into an array of property name/value pairs.
[filesize](#filesize) | Formats a number of bytes into something else.
[filter](#filter) | Filters the items in an array.
[first](https://twig.symfony.com/doc/3.x/filters/first.html) | Returns the first character/item of a string/array.
[firstWhere](#firstwhere) | Get the first item in an array that matches the provided predicate.
[flatten](#flatten) | Recursively flatten a multi-dimensional array into a single level.
[float](#float) | Coerces the passed value to a float.
[format](https://twig.symfony.com/doc/3.x/filters/format.html) | Formats a string by replacing placeholders.
[group](#group) | Groups items in an array.
[hash](#hash) | Prefixes a string with a keyed-hash message authentication code (HMAC).
[httpdate](#httpdate) | Converts a date to the HTTP format.
[id](#id) | Normalizes an element ID into only alphanumeric characters, underscores, and dashes.
[index](#index) | Indexes the items in an array.
[indexOf](#indexof) | Returns the index of a given value within an array, or the position of a passed-in string within another string.
[integer](#integer) | Coerces the passed value to an integer.
[intersect](#intersect) | Returns the intersecting items of two arrays.
[join](https://twig.symfony.com/doc/3.x/filters/join.html) | Concatenates multiple strings into one.
[json_decode](#json_decode) | JSON-decodes a value.
[json_encode](#json_encode) | JSON-encodes a value.
[kebab](#kebab) | Formats a string into “kebab-case”.
[keys](https://twig.symfony.com/doc/3.x/filters/keys.html) | Returns the keys of an array.
[last](https://twig.symfony.com/doc/3.x/filters/last.html) | Returns the last character/item of a string/array.
[lcfirst](#lcfirst) | Lowercases the first character of a string.
[length](#length) | Returns the length of a string or array, or the count of a query.
[literal](#literal) | Escapes an untrusted string for use with element query params.
[lower](https://twig.symfony.com/doc/3.x/filters/lower.html) | Lowercases a string.
[map](https://twig.symfony.com/doc/3.x/filters/map.html) | Applies an arrow function to the items in an array.
[markdown](#markdown-or-md) | Processes a string as Markdown.
[merge](#merge) | Merges an array with another one.
[money](#money) | Outputs a value from a Money object.
[multisort](#multisort) | Sorts an array by one or more keys within its sub-arrays.
[namespace](#namespace-or-ns) | Namespaces input names and other HTML attributes, as well as CSS selectors.
[namespaceAttributes](#namespaceattributes) | Namespaces `id` and other HTML attributes, as well as CSS selectors.
[namespaceInputId](#namespaceinputid) | Namespaces an element ID.
[namespaceInputName](#namespaceinputname) | Namespaces an input name.
[nl2br](https://twig.symfony.com/doc/3.x/filters/nl2br.html) | Replaces newlines with `<br>` tags.
[number_format](https://twig.symfony.com/doc/3.x/filters/number_format.html) | Formats numbers.
[number](#number) | Formats a number.
[parseAttr](#parseAttr) | Parses an HTML tag to find its attributes.
[parseRefs](#parserefs) | Parses a string for reference tags.
[pascal](#pascal) | Formats a string into “PascalCase”.
[percentage](#percentage) | Formats a percentage.
[prepend](#prepend) | Prepends HTML to the beginning of another element.
[purify](#purify) | Runs HTML code through HTML Purifier.
[push](#push) | Appends one or more items onto the end of an array.
[raw](https://twig.symfony.com/doc/3.x/filters/raw.html) | Marks as value as safe for the current escaping strategy.
[reduce](https://twig.symfony.com/doc/3.x/filters/reduce.html) | Iteratively reduces a sequence or mapping to a single value.
[removeClass](#removeclass) | Removes a class (or classes) from the given HTML tag.
[replace](#replace) | Replaces parts of a string with other things.
[reverse](https://twig.symfony.com/doc/3.x/filters/reverse.html) | Reverses a string or array.
[round](https://twig.symfony.com/doc/3.x/filters/round.html) | Rounds a number.
[rss](#rss) | Converts a date to RSS date format.
[slice](https://twig.symfony.com/doc/3.x/filters/slice.html) | Extracts a slice of a string or array.
[snake](#snake) | Formats a string into “snake_case”.
[sort](https://twig.symfony.com/doc/3.x/filters/sort.html) | Sorts an array.
[spaceless](https://twig.symfony.com/doc/3.x/filters/spaceless.html) | Removes whitespace between HTML tags.
[split](https://twig.symfony.com/doc/3.x/filters/split.html) | Splits a string by a delimiter.
[string](#string) | Coerces the passed value to a string.
[striptags](https://twig.symfony.com/doc/3.x/filters/striptags.html) | Strips SGML/XML tags from a string.
[time](#time) | Formats a time.
[timestamp](#timestamp) | Formats a human-readable timestamp.
[title](https://twig.symfony.com/doc/3.x/filters/title.html) | Formats a string into “Title Case”.
[translate](#translate-or-t) | Translates a message.
[trim](https://twig.symfony.com/doc/3.x/filters/trim.html) | Strips whitespace from the beginning and end of a string.
[truncate](#truncate) | Truncates a string to a given length, while ensuring that it does not split words.
[unique](#unique) | Removes duplicate values from an array.
[unshift](#unshift) | Prepends one or more items to the beginning of an array.
[upper](https://twig.symfony.com/doc/3.x/filters/upper.html) | Formats a string into “UPPER CASE”.
[url_encode](https://twig.symfony.com/doc/3.x/filters/url_encode.html) | Percent-encodes a string as a URL segment or an array as a query string.
[ucwords](#ucwords) | Uppercases the first character of each word in a string.
[values](#values) | Returns all the values in an array, resetting its keys.
[where](#where) | Filters an array by key-value pairs.
[widont](#widont) | Inserts a non-breaking space between the last two words of a string.
[without](#without) | Returns an array without the specified element(s).
[withoutKey](#withoutkey) | Returns an array without the specified key.

## `address`

Applies formatting to an [Address](../element-types/addresses.md#address-formatter).

```twig
{% set myAddress = currentUser.getAddresses()|first %}
{{ myAddress|address }}
{# Output:
  <p translate="no">
  <span class="address-line1">1234 Balboa Towers Circle</span><br>
  <span class="locality">Los Angeles</span>, <span class="administrative-area">CA</span> <span class="postal-code">92662</span><br>
  <span class="country">United States</span>
  </p>
#}
```

This calls [Addresses::formatAddress()](craft5:craft\services\Addresses::formatAddress()), so you can optionally provide an array of `options` and even your own [`formatter`](https://github.com/commerceguys/addressing/blob/master/src/Formatter/FormatterInterface.php).

## `append`

Appends HTML to the end of another element.

```twig
{{ '<div><p>Lorem</p></div>'|append('<p>Ipsum</p>') }}
{# Output: <div><p>Lorem</p><p>Ipsum</p></div> #}
```

If you only want to append a new element if one of the same type doesn’t already exist, pass `'keep'` as a second argument.

```twig
{{ '<div><p>Lorem</p></div>'|append('<p>Ipsum</p>', 'keep') }}
{# Output: <div><p>Lorem</p></div> #}
```

If you want to replace an existing element of the same type, pass `'replace'` as a second argument.

```twig
{{ '<div><p>Lorem</p></div>'|append('<p>Ipsum</p>', 'replace') }}
{# Output: <div><p>Ipsum</p></div> #}
```

## `ascii`

Converts a string to ASCII characters.

```twig
{{ 'über'|ascii }}
{# Output: uber #}
```

By default, the current site’s language will be used when choosing ASCII character mappings. You can override that by passing in a different locale ID.

```twig
{{ 'über'|ascii('de') }}
{# Output: ueber #}
```

## `atom`

Converts a date to an ISO-8601 timestamp (e.g. `2038-01-19T03:14:07+00:00`), which should be used for Atom feeds, among other things.

```twig
{{ entry.postDate|atom }}
```

Pass `false` to prevent the date from being converted to the system’s timezone:

```twig
{{ entry.customDateFieldWithTimezone|atom(false) }}
```

## `attr`

Modifies an HTML tag’s attributes, using the same attribute definitions supported by using <yii2:yii\helpers\BaseHtml::renderTagAttributes()>.

```twig
{% set tag = '<div>' %}
{{ tag|attr({
  class: 'foo'
}) }}
{# Output: <div class="foo"> #}
```

Only the first tag will be modified, and any HTML comments or doctype declarations before it will be ignored.

```twig
{% set svg %}
  <?xml version="1.0" encoding="utf-8"?>
  <svg>...</svg>
{% endset %}
{{ svg|attr({
  class: 'icon'
}) }}
{# Output:
  <?xml version="1.0" encoding="utf-8"?>
  <svg class="icon">...</svg> #}
```

Attributes can be removed by setting them to `false`.

```twig
{% set tag = '<input type="text" disabled>' %}
{{ tag|attr({
    disabled: false
}) }}
{# Output: <input type="text"> #}
```

`class` and `style` attributes will be combined with the element’s existing attributes, if set.

```twig
{% set tag = '<div class="foo" style="color: black;">' %}
{{ tag|attr({
  class: 'bar',
  style: {background: 'red'}
}) }}
{# Output: <div class="foo bar" style="color: black; background: red;"> #}
```

All other attributes will replace the existing attribute values.

```twig
{% set tag = '<input type="text">' %}
{{ tag|attr({
  type: 'email'
}) }}
{# Output: <input type="email"> #}
```

If you want to completely replace a `class` or `style` attribute, remove it first, then set the new value:

```twig
{% set tag = '<div class="foo">' %}
{{ tag|attr({class: false})|attr({class: 'bar'}) }}
{# Output: <div class="bar"> #}
```

::: tip
Attribute values are HTML-encoded automatically:
```twig
{% set tag = '<input type="text">' %}
{{ tag|attr({
  type: 'submit',
  value: 'Register & Subscribe →'
}) }}
{# Output: <input type="submit" value="Register &amp; Subscribe →"> #}
```
:::

## `base64_decode`

Decodes a base64-encoded string. The encoded value can come from anywhere, as base64 is widely supported and its input and output is consistent across implementations.

```twig
{{ 'Q3JhZnQgQ01T' | base64_decode }}
{# -> Craft CMS #}
```

::: tip
JavaScript uses the [`btoa()`](https://developer.mozilla.org/en-US/docs/Web/API/btoa) function to encode values as base64, and [`atob()`](https://developer.mozilla.org/en-US/docs/Web/API/atob) to decode them.
:::

## `base64_encode`

Encodes a value as base64. Base64 can be useful for making unpredictable strings or data URL-safe.

```twig
{{ 'Craft CMS' | base64_encode }}
{# -> Q3JhZnQgQ01T #}
```

If you intend to use the value in a style sheet or URI, consider the [`dataUrl()` function](functions.md#dataurl), instead.

::: danger
Encoding is _not_ the same as encryption! The result may appear random, but is completely reversible. Read more about the principles and applications of [base64](https://en.wikipedia.org/wiki/Base64) if you are unsure whether it is appropriate!
:::

## `boolean`

Coerces the passed value to a boolean using PHP’s [`boolval()`](https://www.php.net/manual/en/function.boolval.php) function. Useful when dealing with stronger typing in PHP 8 and Twig 3.x.

## `camel`

Returns a string formatted in “camelCase”.

```twig
{{ 'foo bar'|camel }}
{# Output: fooBar #}
```

## `column`

Returns the values from a single property or key in the input array.

```twig
{% set entryIds = entries|column('id') %}
```

An arrow function can be passed instead, if the values that should be returned don’t exist as a property or key on the array elements.

```twig
{% set authorNames = entries|column(e => e.author.fullName) %}
```

This works similarly to Twig’s core [`column`](https://twig.symfony.com/doc/3.x/filters/column.html) filter, except that [ArrayHelper::getColumn()](yii2:yii\helpers\BaseArrayHelper::getColumn()) is used rather than PHP’s [array_column()](https://secure.php.net/array_column) function.

## `contains`

Returns whether the passed-in array contains any nested arrays/objects with a particular key/attribute set to a given value.

```twig
{% set works = craft.entries()
  .section('artwork')
  .all() %}

{# See if any of the artwork has a mature rating #}
{% if works|contains('rating', 'm') %}
  <p class="mature">Some of this artwork is meant for mature viewers.</p>
{% endif %}
```

## `currency`

Formats a number with a given currency according to the user’s preferred language.

```twig
{{ 1000000|currency('USD') }}
{# Output: $1,000,000.00 #}
```

You can pass `stripZeros=true` to remove any fraction digits if the value to be formatted has no minor value (e.g. cents):

```twig
{{ 1000000|currency('USD', stripZeros=true) }}
{# Output: $1,000,000 #}
```

If the passed-in value isn’t a valid number it will be returned verbatim:

```twig
{{ 'oh hai'|currency('USD') }}
{# Output: oh hai #}
```

## `date`

Formats a timestamp or [DateTime](http://php.net/manual/en/class.datetime.php) object.

```twig
{{ entry.postDate|date }}
{# Output: Jan 19, 2038 #}
```

#### Arguments

`format`

:   You can customize how the date is presented by passing a [custom date format](https://www.php.net/manual/en/datetime.format.php), just like Twig’s core [`date`](https://twig.symfony.com/doc/3.x/filters/date.html) filter:

    ```twig
    {{ now|date('n/d/Y') }}
    {# Output: 1/19/2038 #}
    ```

    Craft also provides some special format keywords that will output locale-specific date formats:

    | Format               | Example                   |
    | -------------------- | ------------------------- |
    | `short`              | 1/19/2038                 |
    | `medium` _(default)_ | Jan 19, 2038              |
    | `long`               | January 19, 2038          |
    | `full`               | Tuesday, January 19, 2038 |

    ```twig
    {{ entry.postDate|date('short') }}
    {# Output: 1/19/2038 #}
    ```

`locale`

:   The current application locale will be used by default. If you want to format the date for a different locale, use the `locale` argument:

    ```twig
    {{ entry.postDate|date('short', locale='en-GB') }}
    {# Output: 19/1/2038 #}
    ```

`timezone`

:   You can customize the timezone the time is output in, using the `timezone` param:

    ```twig
    {{ entry.postDate|date('Y-m-d H:i', timezone='UTC') }}
    {# Output: 2038-01-19 03:14 #}
    ```

    Pass `false` to prevent the date from being converted to the system’s timezone:

    ```twig
    {{ entry.customDateFieldWithTimezone|date('Y-m-d H:i', timezone=false) }}
    {# Output: 2038-01-18 19:14 #}
    ```

::: tip
Applying the filter to a `null` value uses the current date. If this is the desired behavior, consider explicitly passing the [`now` variable](global-variables.md#now): `now|date`.
:::

## `datetime`

Formats a timestamp or [DateTime](http://php.net/manual/en/class.datetime.php) object, including the time of day.

```twig
{{ entry.postDate|datetime }}
{# Output: Jan 19, 2038, 5:00:00 PM #}
```

#### Arguments

`format`
:   Craft provides some special format keywords that will output locale-specific date and time formats:

    ```twig
    {{ entry.postDate|datetime('short') }}
    {# Output: 1/19/2038, 5:00 PM #}
    ```

    Possible `format` values (in addition to any valid [PHP date format](https://www.php.net/manual/en/datetime.format.php)) are:

    | Format               | Example                                     |
    | -------------------- | ------------------------------------------- |
    | `short`              | 1/19/2038, 3:14 AM                          |
    | `medium` _(default)_ | Jan 19, 2038, 3:14:07 AM                    |
    | `long`               | January 19, 2038 at 3:14:07 AM UTC          |
    | `full`               | Tuesday, January 19, 2038 at 3:14:07 AM UTC |

`locale`

:   The current application locale will be used by default. If you want to format the date and time for a different locale, use the `locale` argument:

    ```twig
    {{ entry.postDate|datetime('short', locale='en-GB') }}
    {# Output: 19/01/2038, 3:14 #}
    ```

`timezone`

:   You can customize the timezone the time is output in, using the `timezone` param:

    ```twig
    {{ entry.postDate|datetime('short', timezone='UTC') }}
    {# Output: 1/19/2038, 3:14 AM #}
    ```

    Pass `false` to prevent the date from being converted to the system’s timezone:

    ```twig
    {{ entry.customDateFieldWithTimezone|date('short', timezone=false) }}
    {# Output: 1/18/2038, 7:14 PM #}
    ```

::: tip
Applying the filter to a `null` value uses the current date. If this is the desired behavior, consider explicitly passing the [`now` variable](global-variables.md#now): `now|date`.
:::

## `diff`

Returns the difference between arrays, using [array_diff()](https://www.php.net/manual/en/function.array-diff.php).

It will return a new array with any values that were in the initial array, which weren’t present in any of the
arrays passed into the filter.

```twig
{% set arr1 = ['foo', 'bar'] %}
{% set arr2 = ['bar', 'baz'] %}
{% set arr3 = arr1|diff(arr2) %}
{# Result: ['foo'] #}
```

## `duration`

Runs a [DateInterval](http://php.net/manual/en/class.dateinterval.php) object or integer (number of seconds) through <craft5:craft\helpers\DateTimeHelper::humanDuration()> to output human-friendly duration text.

```twig
<p>Posted {{ entry.postDate.diff(now)|duration(false) }} ago.</p>
```

## `encenc`

Encrypts and base64-encodes a string.

```twig
{{ 'secure-string'|encenc }}
```

## `explodeClass`

Converts a `class` attribute value into an array of class names.

If an array is passed in, it will be returned as-is.

```twig
{% set classNames = 'foo bar baz'|explodeClass %}
{# Result: ['foo', 'bar', 'baz'] #}
```

## `explodeStyle`

Converts a `style` attribute value into an array of property name/value pairs.

If an array is passed in, it will be returned as-is.

```twig
{% set styles = 'font-weight: bold; color: red;'|explodeStyle %}
{# Result: {'font-weight': 'bold', 'color': 'red'} #}
```

## `filesize`

Formats a number of bytes into something nicer.

```twig
{{ asset.size }}
{# Output: 1944685 #}
{{ asset.size|filesize }}
{# Output: 1.945 MB #}
```

If the passed-in value isn’t a valid number it will be returned verbatim:

```twig
{{ 'oh hai'|filesize }}
{# Output: oh hai #}
```

## `filter`

Filters elements of an array.

If nothing is passed to it, any “empty” elements will be removed.

```twig
{% set array = ['foo', '', 'bar', '', 'baz'] %}
{% set filteredArray = array|filter %}
{# Result: ['foo', 'bar', 'baz'] #}
```

When an arrow function is passed, this works identically to Twig’s core [`filter`](https://twig.symfony.com/doc/3.x/filters/filter.html) filter.

```twig
{% set array = ['foo', 'bar', 'baz'] %}
{% set filteredArray = array|filter(v => v[0] == 'b') %}
{# Result: ['bar', 'baz'] #}
```

## `firstWhere`

Searches the incoming array for an element that matches the provided criteria.

```twig
{% set mountains = [
  { name: 'Mount Hood', height: 11250, range: 'Cascade' },
  { name: 'Mount Jefferson', height: 10495, range: 'Cascade' },
  { name: 'South Sister', height: 10358, range: 'Cascade' },
  { name: 'North Sister', height: 10085, range: 'Cascade' },
  { name: 'Middle Sister', height: 10052, range: 'Cascade' },
  { name: 'Sacajawea Peak', height: 9843, range: 'Wallowa' },
  { name: 'Steens Mountain', height: 9738, range: null },
  { name: 'Aneroid Mountain', height: 9707, range: 'Wallowa' },
] %}

{% set notInRange = mountains | firstWhere('range', null) %}
{% set tallestUnder10kft = mountains | firstWhere(m => m.height < 10000) %}
{% set tallestSister = mountains | firstWhere(m => m.name contains 'Sister') %}
```

When using a closure, complex comparisons are possible by returning a boolean, which is implicitly checked for “truthiness.” You can also compute a value in the closure for comparison against an explicitly-passed value.

#### Arguments

The signature of `firstWhere()` is the same as <craft5:craft\helpers\ArrayHelper::firstWhere()>, but the first argument comes from the filter’s input.

`key`
:   A key used to resolve a value from each item in the array, or a closure that returns a value for comparison.

    When using a string, you can target a nested key within each item using “dot notation,” like `author.name`. See <craft5:craft\helpers\ArrayHelper::getValue()> for details.

`value`
:   The fixed value to compare against. Defaults to `true`.

`strict`
:   Whether the comparison should be performed with strict typing. Defaults to `false`.

::: tip
This filter is similar in functionality to the [collection](../../development/collections.md) method of the same name.
:::

## `flatten`

Flattens an array into a single level, up to `depth` levels.

```twig
{% set songEmphasis = [
  ['A', 'B', 'C', 'D'],
  ['E', 'F', 'G'],
  ['H', 'I', 'J', 'K', ['L', 'M', 'N', 'O', 'P']],
  ['Q', 'R', 'S'],
  ['T', 'U', 'V'],
  [['W', 'X'], ['Y', 'Z']],
] %}

{% set alphabet = songEmphasis | flatten %}
{# ->  ['A', 'B', 'C', 'D', 'E', ...] #}
```

#### Arguments

:   `depth`
    How many levels to flatten. There is no limit, by default.

## `float`

Coerces the passed value to a float using PHP’s [`floatval()`](https://www.php.net/manual/en/function.floatval.php) function. Useful when dealing with stronger typing in PHP 8 and Twig 3.x.

## `group`

Groups items in an array by the results of an arrow function.

```twig
{% set allEntries = craft.entries().section('blog').all() %}
{% set allEntriesByYear = allEntries|group(e => e.postDate|date('Y')) %}

{% for year, entriesInYear in allEntriesByYear %}
  <h2>{{ year }}</h2>

  <ul>
    {% for entry in entriesInYear %}
      <li><a href="{{ entry.url }}">{{ entry.title }}</a></li>
    {% endfor %}
  </ul>
{% endfor %}
```

## `hash`

Prefixes the given string with a keyed-hash message authentication code (HMAC), for passing data in plain view (i.e. via front-end forms) that must not be tampered with.

```twig
{{ hiddenInput('foo', 'bar'|hash) }}
```

PHP scripts can validate the value via [Security::validateData()](yii2:yii\base\Security::validateData()):

```php
$foo = Craft::$app->getRequest()->getBodyParam('foo');
$foo = Craft::$app->getSecurity()->validateData($foo);

if ($foo !== false) {
    // $foo is valid!
}
```

::: danger
**Do not hash sensitive data.** Hashed values are tamper-proof, but still expose the original value!
:::

[Request::getValidatedBodyParam()](craft5:craft\web\Request::getValidatedBodyParam()) can also perform this comparison in a controller, automatically throwing an error when it finds a missing or invalid value:

```php
public function actionSubmitData()
{
    $foo = Craft::$app->getRequest()->getValidatedBodyParam('foo');

    // $foo is valid!
}
```

::: warning
Hashing data uses your app’s [`securityKey` config setting](config5:securityKey), by default. If this setting changes between generating and validating a hash, it will fail!
:::

## `httpdate`

Converts a date to the HTTP format, used by [RFC 7231](https://tools.ietf.org/html/rfc7231#section-7.1.1.1)-compliant HTTP headers like `Expires`.

```twig
{% header "Expires: " ~ expiry|httpdate %}
{# Output: Expires: Thu, 08 Apr 2021 13:00:00 GMT #}
```

#### Arguments

`timezone`
:   You can use the `timezone` param to specify the date’s timezone for conversion to GMT:

    ```twig
    {% header 'Expires: ' ~ expiry|httpdate('CET') %}
    {# Result: Expires: Thu, 08 Apr 2021 21:00:00 GMT #}
    ```

    Pass `false` to use the date’s existing timezone as the basis (prior to conversion to GMT).

## `id`

Formats a string into something that will work well as an HTML input `id`, via <craft5:craft\web\View::formatInputId()>.

```twig
{% set name = 'input[name]' %}
<input type="text" name="{{ name }}" id="{{ name|id }}">
```

## `index`

Runs an array through [ArrayHelper::index()](yii2:yii\helpers\BaseArrayHelper::index()).

```twig
{% set entries = entries|index('id') %}
```

## `indexOf`

Returns the index of a passed-in value within an array, or the position of a passed-in string within another string. (Note that the returned position is 0-indexed.) If no position can be found, `-1` is returned instead.

```twig
{% set colors = ['red', 'green', 'blue'] %}
<p>Green is located at position {{ colors|indexOf('green') + 1 }}.</p>

{% set position = 'team'|indexOf('i') %}
{% if position != -1 %}
  <p>There <em>is</em> an “i” in “team”! It’s at position {{ position + 1 }}.</p>
{% endif %}
```

## `integer`

Coerces the passed value to a integer using PHP’s [`intval()`](https://www.php.net/manual/en/function.intval.php) function. Useful when dealing with stronger typing in PHP 8 and Twig 3.x.

## `intersect`

Returns an array containing only the values that are also in a passed-in array.

```twig
{% set ownedIngredients = [
  'vodka',
  'gin',
  'triple sec',
  'tonic',
  'grapefruit juice'
] %}

{% set longIslandIcedTeaIngredients = [
  'vodka',
  'tequila',
  'rum',
  'gin',
  'triple sec',
  'sweet and sour mix',
  'Coke'
] %}

{% set ownedLongIslandIcedTeaIngredients =
  ownedIngredients|intersect(longIslandIcedTeaIngredients)
%}
```

## `json_encode`

Returns the JSON representation of a value.

This works similarly to Twig’s core [`json_encode`](https://twig.symfony.com/doc/3.x/filters/json_encode.html) filter, except that the `options` argument will default to `JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_QUOT` if the response content type is either `text/html` or `application/xhtml+xml`.

## `json_decode`

JSON-decodes a string into an array  by passing it through <yii2:yii\helpers\Json::decode()>.

```twig
{% set arr = '[1, 2, 3]'|json_decode %}
```

## `kebab`

Returns a string formatted in “kebab-case”.

::: tip
That’s a reference to [shish kebabs](https://en.wikipedia.org/wiki/Kebab#Shish) for those of you that don’t get the analogy.
:::

```twig
{{ 'foo bar?'|kebab }}
{# Output: foo-bar #}
```

## `lcfirst`

Lowercases the first character of a string.

```twig
{{ 'Foobar'|lcfirst }}
{# Output: foobar #}
```

## `length`

Returns the length of a string or array, or a query’s result [count](../../development/element-queries.md#count).

If used on anything besides a query, Twig’s built-in [length](https://twig.symfony.com/doc/3.x/filters/length.html) filter logic will be used.

## `literal`

Runs a string through <craft5:craft\helpers\Db::escapeParam()> to escape commas and asterisks so they’re are not treated as special characters in query params.

```twig
{% set titleParam = craft.app.request.getQueryParam('title') %}
{% set entry = craft.entries()
  .title(titleParam|literal)
  .one() %}
```

## `markdown` or `md`

Processes a string with [Markdown](https://daringfireball.net/projects/markdown/).

```twig
{% set content %}
# Everything You Need to Know About Computer Keyboards

The only *real* computer keyboard ever made was famously
the [Apple Extended Keyboard II] [1].

    [1]: https://www.flickr.com/photos/gruber/sets/72157604797968156/
{% endset %}

{{ content|markdown }}
```

This filter supports two arguments:
- `flavor` — Choose the “flavor” of Markdown the parser will use. Must be one of:
  - `'original'` (Default)
  - `'gfm'`([GitHub-Flavored Markdown](https://docs.github.com/en/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax))
  - `'gfm-comment'` (GitHub-Flavored Markdown with newlines converted to `<br>`s)
  - `'extra'` ([Markdown Extra](https://michelf.ca/projects/php-markdown/extra/))
  - `'pre-escape'` (Same as `'original'` but forces the `encode` argument to `true`)
- `inlineOnly` — Determines whether to only parse inline elements, omitting any `<p>` tags (defaults to `false`)
- `encode` — Equivalent to pre-processing the input string with Twig’s [`escape` or `e` filter](https://twig.symfony.com/doc/3.x/filters/escape.html), i.e: `{{ content|e|md }}`. _Only the `original` and `pre-escape` flavors are allowed when encoding is enabled._

::: danger
**Do not output user-submitted content with this filter.** The resulting markup is “trusted” by the Twig environment (as though it were output with the `|raw` filter), and can result in [XSS vulnerabilities](https://owasp.org/www-community/attacks/xss/).

To protect your site or app, first pass the text through the [`escape` or `e` filter](https://twig.symfony.com/doc/3.x/filters/escape.html), or set the `escape` argument to `true`.
:::

## `merge`

Merges the passed array with another one.

This has the same behavior as [Twig’s merge filter](https://twig.symfony.com/doc/3.x/filters/merge.html) which uses PHP’s [array_merge()](https://www.php.net/manual/en/function.array-merge.php) under the hood:

```twig
{% set values = [1, 2] %}
{% set values = values|merge(['Lucille', 'Buster']) %}
{# Result: [1, 2, 'Lucille', 'Buster'] #}
```

It also works on hashes, where merging occurs on the keys. A key that doesn’t already exist is added, and a key that does already exist only has its value overridden:

```twig
{% set items = { 'Buster': 'Bluth', 'Lindsay': 'Bluth' } %}
{% set items = items|merge({ 'Tobias': 'Fünke', 'Lindsay': 'Fünke' }) %}
{# Result: { 'Buster': 'Bluth', 'Tobias': 'Fünke', 'Lindsay': 'Fünke' } #}
```

::: tip
If you want to make sure specific values are defined by default in an array, like `'Lindsay': 'Bluth'` below, reverse the elements in the call:

```twig
{% set items = { 'Buster': 'Bluth', 'Lindsay': 'Bluth' } %}
{% set items = { 'Tobias': 'Fünke', 'Lindsay': 'Fünke' }|merge(items) %}
{# Result: { 'Tobias': 'Fünke', 'Lindsay': 'Bluth', 'Buster': 'Bluth' } #}
```
:::

You can also provide an optional `recursive` argument that will use [ArrayHelper::merge()](craft5:craft\helpers\ArrayHelper::merge()) to merge nested arrays or hashes.

Without `recursive`:

```twig
{% set items = {
  'rebellion': { 'Bespin': 'Calrissian', 'Hoth': 'Organa', 'Crait': 'Organa' },
  'empire': { 'Coruscant': 'Palpatine', 'Endor': 'Palpatine' }
} %}
{% set items = items|merge({
  'rebellion': { 'Endor': 'Solo/Organa' },
  'empire': { 'Bespin': 'Vader', 'Hoth': 'Veers' }
}) %}
{# Result: {
  'rebellion': { 'Endor': 'Solo/Organa' },
  'empire': { 'Bespin': 'Vader', 'Hoth': 'Veers' }
} #}
```

With `recursive`:

```twig{8}
{% set items = {
  'rebellion': { 'Bespin': 'Calrissian', 'Hoth': 'Organa', 'Crait': 'Organa' },
  'empire': { 'Coruscant': 'Palpatine', 'Endor': 'Palpatine' }
} %}
{% set items = items|merge({
  'rebellion': { 'Endor': 'Solo/Organa' },
  'empire': { 'Bespin': 'Vader', 'Hoth': 'Veers' }
}, true) %}
{# Result: {
  'rebellion': {
    'Bespin': 'Calrissian',
    'Hoth': 'Organa',
    'Crait': 'Organa',
    'Endor': 'Solo/Organa'
  },
  'empire': {
    'Coruscant': 'Palpatine',
    'Endor': 'Palpatine',
    'Bespin': 'Vader',
    'Hoth': 'Veers'
  }
} #}
```

## `money`

Outputs a value from a Money object.

```twig
{{ myMoneyField|money }}
{# Output: $123.00 #}
```

An optional **formatLocale** argument can be provided if you don’t want to use the default formatter’s locale:

```twig
{{ myMoneyField|money('de') }}
{# Output: 123,00 $ #}
```

## `multisort`

Sorts an array by one or more properties or keys within an array’s values.

To sort by a single property or key, pass its name as a string:

```twig
{% set entries = entries|multisort('title') %}
```

To sort by multiple properties or keys, pass them in as an array. For example, this will sort entries by their post date first, and then by their title:

```twig
{% set entries = entries|multisort(['postDate', 'title']) %}
```

An arrow function can be passed instead, if the values that should be sorted by don’t exist as a property or key on the array elements.

```twig
{% set entries = entries|multisort(e => e.author.fullName) %}
```

The values will be sorted in ascending order by default. You can switch to descending order with the `direction` param:

```twig
{% set entries = entries|multisort('title', direction=SORT_DESC) %}
```

You can also customize which sorting behavior is used, with the `sortFlag` param. For example, to sort items numerically, use `SORT_NUMERIC`:

```twig
{% set entries = entries|multisort('id', sortFlag=SORT_NUMERIC) %}
```

See PHP’s [sort()](https://www.php.net/manual/en/function.sort.php) documentation for the available sort flags.

When sorting by multiple properties or keys, you must set the `direction` and `sortFlag` params to arrays as well.

```twig
{% set entries = entries|multisort([
  'postDate',
  'title',
], sortFlag=[SORT_NATURAL, SORT_FLAG_CASE]) %}
```

## `namespace` or `ns`

The `|namespace` filter can be used to namespace input names and other HTML attributes, as well as CSS selectors.

For example, this:

```twig
{% set html %}
<style>
  .text { font-size: larger; }
  #title { font-weight: bold; }
</style>
<input class="text" id="title" name="title" type="text">
{% endset %}
{{ html|namespace('foo') }}
```

would become this:

```html
<style>
  .text { font-size: larger; }
  #foo-title { font-weight: bold; }
</style>
<input class="text" id="foo-title" name="foo[title]" type="text">
```

Notice how the `#title` CSS selector became `#foo-title`, the `id` attribute changed from `title` to `foo-title`, and the `name` attribute changed from `title` to `foo[title]`.

If you want class names to get namespaced as well, pass `withClasses=true`. That will affect both class CSS selectors and `class` attributes:

```twig
{{ html|namespace('foo', withClasses=true) }}
```

That would result in:

```html{2,5}
<style>
  .foo-text { font-size: larger; }
  #foo-title { font-weight: bold; }
</style>
<input class="foo-text" id="foo-title" name="foo[title]" type="text">
```

## `namespaceAttributes`

The `|namespaceAttributes` filter can be used to namespace `id` and other HTML attributes, as well as CSS selectors.

It’s identical to the [namespace](#namespace) filter, except that inputs’ `name` attributes won’t be modified.

For example, this:

```twig
{% set html %}
<style>
  .text { font-size: larger; }
  #title { font-weight: bold; }
</style>
<input class="text" id="title" name="title" type="text">
{% endset %}
{{ html|namespaceAttributes('foo') }}
```

would become this:

```html
<style>
  .text { font-size: larger; }
  #foo-title { font-weight: bold; }
</style>
<input class="text" id="foo-title" name="title" type="text">
```

Notice how the `#title` CSS selector became `#foo-title`, the `id` attribute changed from `title` to `foo-title`, but the `name` attribute wasn’t changed.

If you want class names to get namespaced as well, pass `withClasses=true`. That will affect both class CSS selectors and `class` attributes:

```twig
{{ html|namespaceAttributes('foo', withClasses=true) }}
```

That would result in:

```html{2,5}
<style>
  .foo-text { font-size: larger; }
  #foo-title { font-weight: bold; }
</style>
<input class="foo-text" id="foo-title" name="title" type="text">
```

## `namespaceInputId`

Namepaces an element ID.

For example, this:

```twig
{{ 'bar'|namespaceInputId('foo') }}
```

would output:

```html
foo-bar
```

::: tip
If this is used within a [namespace](tags.md#namespace) tag, the namespace applied by the tag will be used by default.
:::

## `namespaceInputName`

Namepaces an input name.

For example, this:

```twig
{{ 'bar'|namespaceInputName('foo') }}
```

would output:

```html
foo[bar]
```

::: tip
If this is used within a [namespace](tags.md#namespace) tag, the namespace applied by the tag will be used by default.
:::

## `number`

Formats a number according to the user’s preferred language.

For example, comma group symbols are added by default in English:

```twig
{{ 1000000|number }}
{# Output: 1,000,000 #}
```

The value is passed to [`Craft::$app->getFormatter()->asDecimal()`](yii2:yii\i18n\Formatter::asDecimal()) and may include three additional arguments:

- **decimals** – number of digits that should appear after the decimal point (defaults to `null`)
- **options** – key-value array of [number formatter options](https://www.php.net/manual/en/class.numberformatter.php#intl.numberformatter-constants.unumberformatattribute) (ignored if PHP intl extension is not installed)
- **textOptions** – key-value array of [text formatting options](https://www.php.net/manual/en/class.numberformatter.php#intl.numberformatter-constants.unumberformattextattribute) for the formatter

```twig
{{ 1000000|number(2) }}
{# Output: 1,000,000.00 #}

{{ 1000000|number(null, { (constant('NumberFormatter::GROUPING_SIZE')): 4 }) }}
{# Output: 100,0000 #}

{{ (-5)|number(null, {}, { (constant('NumberFormatter::NEGATIVE_PREFIX')): '☹' }) }}
{# Output: ☹5 #}
```

If the passed-in value isn’t a valid number it will be returned verbatim:

```twig
{{ 'oh hai'|number }}
{# Output: oh hai #}
```

## `parseAttr`

Parses an HTML tag to find its attributes.

```twig
{% set content %}
  <a class="text-xl pt-0" href="/foo.pdf" download>Save File</p>
{% endset %}

{{ content|parseAttr }}
{# Result: ["class" => ["text-xl", "pt-0"], "href" => "/foo.pdf", "download" => true] #}
```

## `parseRefs`

Parses a string for [reference tags](../../system/reference-tags.md).

```twig
{% set content %}
  {entry:blog/hello-world:link} was my first blog post. Pretty geeky, huh?
{% endset %}

{{ content|parseRefs|raw }}
```

## `pascal`

Returns a string formatted in “PascalCase” (AKA “UpperCamelCase”).

```twig
{{ 'foo bar'|pascal }}
{# Output: FooBar #}
```

## `percentage`

Formats a percentage according to the user’s preferred language.

```twig
{{ 0.85|percentage }}
{# Output: 85% #}
```

If the passed-in value isn’t a valid number it will be returned verbatim:

```twig
{{ 'oh hai'|percentage }}
{# Output: oh hai #}
```

## `prepend`

Prepends HTML to the beginning of another element.

```twig
{{ '<div><p>Ipsum</p></div>'|prepend('<p>Lorem</p>') }}
{# Output: <div><p>Lorem</p><p>Ipsum</p></div> #}
```

If you only want to append a new element if one of the same type doesn’t already exist, pass `'keep'` as a second argument.

```twig
{{ '<div><p>Ipsum</p></div>'|prepend('<p>Lorem</p>', 'keep') }}
{# Output: <div><p>Ipsum</p></div> #}
```

If you want to replace an existing element of the same type, pass `'replace'` as a second argument.

```twig
{{ '<div><p>Ipsum</p></div>'|prepend('<p>Lorem</p>', 'replace') }}
{# Output: <div><p>Lorem</p></div> #}
```

## `purify`

Runs the given text through [HTML Purifier](http://htmlpurifier.org).

```twig
{{ user.bio|purify }}
```

To load predefined rules from a file in `config/htmlpurifier/`, pass its filename as an argument (without `.json`):

```twig
{{ user.bio|purify('user-profile') }}
```

Define config on-the-fly by passing an object:

```twig
{{ user.bio|purify({
  'HTML.AllowedElements': 'p, a',
  'HTML.Nofollow': true,
}) }}
```

See the [configuration docs](../../configure.md#html-purifier) for more information on using HTML Purifier.

## `push`

Appends one or more items onto the end of an array, and returns the new array.

```twig
{% set array1 = ['foo'] %}
{% set array2 = array1|push('bar', 'baz') %}
{# Result: ['foo', 'bar', 'baz'] #}
```

## `removeClass`

Removes a class (or classes) from the given HTML tag.

```twig
{% set markup = '<p class="apple orange banana">A classy bit of text.</p>' %}
{{ markup|removeClass('orange') }}
{# Result: <p class="apple banana">A classy bit of text.</p> #}
```

```twig
{% set markup = '<p class="apple orange banana">A classy bit of text.</p>' %}
{{ markup|removeClass(['orange', 'banana']) }}
{# Result: <p class="apple">A classy bit of text.</p> #}
```

## `replace`

Match and replace parts of a string.

When a mapping array is passed, this works identically to Twig’s core [`replace`](https://twig.symfony.com/doc/3.x/filters/replace.html) filter:

```twig
{% set str = 'Hello, FIRST LAST' %}

{{ str|replace({
  FIRST: currentUser.firstName,
  LAST:  currentUser.lastName
}) }}
```

To replace one string at a time, pass the string you want to replace as the first argument, and the replacement as the second argument:

```twig
{% set str = 'Hello, NAME' %}

{{ str|replace('NAME', currentUser.name) }}
```

You can also use a regular expression to search for matches by starting and ending the replacement string’s value with forward slashes:

```twig
{{ tag.title|lower|replace('/[^\\w]+/', '-') }}
```

When passing an array, its keys can be regular expressions:

```twig
{{ tag.title|lower|replace({
  '/^the\\s/': '',
  '/[^\\w]+/': '-',
}) }}
```

To treat patterns as literal strings (when using positional arguments _or_ a map), pass `false` to the `regex` argument:

```twig{4}
{{ tag.title|lower|replace({
  '/you/i': 'y’all',
  '/-_-/': '(^_^)',
}, regex=false) }}
```

## `rss`

Outputs a date in the format required for RSS feeds (`D, d M Y H:i:s O`).

```twig
{{ entry.postDate|rss }}
{# Expires: Wed, 31 May 2023 12:23:09 -0700 #}
```

#### Arguments

`timezone`

:   You can use the `timezone` param to specify the date’s timezone for conversion to GMT:

    ```twig
    {% header 'Expires: ' ~ expiry|httpdate('CET') %}
    {# Expires: Thu, 08 Apr 2021 21:00:00 +0000 #}
    ```

    Pass `false` to use the date’s existing timezone as the basis (prior to conversion to GMT).

## `snake`

Returns a string formatted in “snake_case”.

```twig
{{ 'foo bar'|snake }}
{# Output: foo_bar #}
```

## `string`

Coerces the passed value to a string using PHP’s [`strval()`](https://www.php.net/manual/en/function.strval.php) function. Useful when dealing with stronger typing in PHP 8 and Twig 3.x.

## `time`

Outputs the time of day for a timestamp or [DateTime](http://php.net/manual/en/class.datetime.php) object.

```twig
{{ entry.postDate|time }}
{# Output: 3:14:07 AM #}
```

Craft provides some special format keywords that will output locale-specific time formats:

```twig
{{ entry.postDate|time('short') }}
{# Output: 3:14 AM #}
```

Possible `format` values are:

| Format               | Example        |
| -------------------- |----------------|
| `short`              | 3:14 AM        |
| `medium` _(default)_ | 3:14:07 AM     |
| `long`               | 3:14:07 AM UTC |

The current application locale will be used by default. If you want to format the date and time for a different locale, use the `locale` argument:

```twig
{{ entry.postDate|time('short', locale='en-GB') }}
{# Output: 17:00 #}
```

You can customize the timezone the time is output in, using the `timezone` param:

```twig
{{ entry.postDate|time('short', timezone='UTC') }}
{# Output: 12:00 AM #}
```

## `timestamp`

Outputs a date with <craft5:craft\i18n\Formatter::asTimestamp()>, using plain-language relative terms when possible. Dates with the same day return only the time, using the provided `format`; dates from the previous 24-hour window return `yesterday`; dates within the last week return the day’s name (like `Wednesday`). Anything longer ago than that 

```twig
{{ now|timestamp }}
{# Output: 16:25 #}

{{ now|date_modify('-1 day')|timestamp }}
{# Output: Yesterday #}

{{ now|date_modify('-4 days')|timestamp }}
{# Output: Friday #}

{{ now|date_modify('-2 months')|timestamp(withPreposition=true) }}
{# Output: 'on March 29, 2023' #}
```

#### Arguments

`withPreposition`

:   Pass `true` to include `at` or `on` prepositions when outputting the timestamp (when appropriate). These values are localized based on the current site’s language. Defaults to `false`.

## `translate` or `t`

Translates a message with [Craft::t()](yii2:yii\BaseYii::t()).

```twig
{{ 'Hello world'|t('myCategory') }}
```

If no category is specified, it will default to `site`.

```twig
{{ 'Hello world'|t }}
```

::: tip
See [Static Message Translations](../../system/sites.md#static-message-translations) for a full explanation on how this works.
:::

## `truncate`

Truncates a string to a given length, while ensuring that it does not split words.

```twig
{{ 'Hello world'|truncate(10) }}
{# Output: Hello… #}
```

An ellipsis (`…`) will be appended to the string if it needs to be truncated, by default. You can customize what gets appended by passing a second argument. (Note that a longer appended string could result in more of the original string getting truncated.)

```twig
{{ 'Hello world'|truncate(10, '...') }}
{# Output: Hello... #}

{{ 'Hello world'|truncate(10, '') }}
{# Output: Hello #}
```

If the truncated string cuts down to less than a single word, that first word will be split by default.

```twig
{{ 'Hello world'|truncate(2) }}
{# Output: H… #}
```

If you’d prefer to have the entire word removed, set the `splitSingleWord` argument to `false`. 

```twig
{{ 'Hello world'|truncate(2, splitSingleWord=false) }}
{# Output: … #}
```

## `ucfirst`

::: warning
The `ucfirst` filter is deprecated. Use Twig’s native [`capitalize`](https://twig.symfony.com/doc/3.x/filters/capitalize.html) filter, instead.
:::

Capitalizes the first character of a string.

```twig
{{ 'foobar'|ucfirst }}
{# Output: Foobar #}
```

## `ucwords`

Uppercases the first character of each word in a string.

```twig
{{ 'foo bar baz hyphenated-pair'|ucwords }}
{# Output: Foo Bar Baz Hyphenated-Pair #}
```

## `unique`

Runs an array through [array_unique()](http://php.net/manual/en/function.array-unique.php).

```twig
{% set array = ['Larry', 'Darryl', 'Darryl'] %}
{{ array|unique }}
{# Result: ['Larry', 'Darryl'] #}
```

## `unshift`

Prepends one or more items to the beginning of an array, and returns the new array.

```twig
{% set array1 = ['foo'] %}
{% set array2 = array1|unshift('bar', 'baz') %}
{# Result: ['bar', 'baz', 'foo'] #}
```

## `values`

Returns an array of all the values in a given array, but without any custom keys.

```twig
{% set arr1 = {foo: 'Foo', bar: 'Bar'} %}
{% set arr2 = arr1|values %}
{# arr2 = ['Foo', 'Bar'] #}
```

## `where`

Runs an array through <craft5:craft\helpers\ArrayHelper::where()>.

```twig
{% set array = { 'foo': 'bar', 'bar': 'baz', 'bat': 'bar' } %}
{{ array|where(v => v == 'bar') }}
{# Result: { 'foo': 'bar', 'bat': 'bar' } #}
```

## `widont`

Inserts a non-breaking space between the last two words of a string.

This can be useful to prevent typographic [widows and orphans](https://en.wikipedia.org/wiki/Widows_and_orphans).

```twig
{% set content %}
  Don’t leave any word stranded on its own line.
{% endset %}

{{ content|widont }}
{# Output: Don’t leave any word stranded on its own&nbsp;line. #}
```

## `without`

Returns an array without the specified item(s).

```twig
{% set entries = craft.entries().section('articles').limit(3).all() %}
{% set firstEntry = entries|first %}
{% set remainingEntries = entries|without(firstEntry) %}
```

## `withoutKey`

Returns an array without one or more specified keys.

The key can be a single key as a string:

```twig
{% set array = {
  foo: 'foo',
  bar: 'bar',
  baz: 'baz'
} %}
{% set filtered = array|withoutKey('baz') %}
{# Result: { 'foo': 'foo', 'bar: 'bar' } #}
```

You can also pass multiple keys in an array:

```twig
{% set array = {
  foo: 'foo',
  bar: 'bar',
  baz: 'baz'
} %}
{% set filtered = array|withoutKey(['bar', 'baz']) %}
{# Result: { 'foo': 'foo' } #}
```
</file>

<file path="reference/twig/functions.md">
---
description: Process and generate data or markup.
---

# Functions

The following [functions](https://twig.symfony.com/doc/3.x/templates.html#functions) are available to Twig templates in Craft:

Function | Description
-------- | -----------
[actionInput](#actioninput) | Outputs a hidden `action` input.
[actionUrl](#actionurl) | Generates a controller action URL.
[alias](#alias) | Parses a string as an alias.
[attr](#attr) | Generates HTML attributes.
[attribute](https://twig.symfony.com/doc/3.x/functions/attribute.html) | Accesses a dynamic attribute of a variable.
[beginBody](#beginbody) | Outputs scripts and styles that were registered for the “begin body” position.
[block](https://twig.symfony.com/doc/3.x/functions/block.html) | Prints a block’s output.
[canCreateDrafts](#cancreatedrafts)<br> [canDelete](#candelete)<br> [canDeleteForSite](#candeleteforsite)<br> [canDuplicate](#canduplicate)<br> [canSave](#cansave)<br> [canView](#canview) | Check permissions for a given element.
[ceil](#ceil) | Rounds a number up.
[className](#classname) | Returns the fully qualified class name of a given object.
[clone](#clone) | Clones an object.
[collect](#collect) | Returns a new collection.
[combine](#combine) | Combines two arrays into one.
[configure](#configure) | Sets attributes on the passed object.
[constant](https://twig.symfony.com/doc/3.x/functions/constant.html) | Returns the constant value for a given string.
[cpUrl](#cpurl) | Generates a control panel URL.
[create](#create) | Creates a new object.
[csrfInput](#csrfinput) | Returns a hidden CSRF token input.
[cycle](https://twig.symfony.com/doc/3.x/functions/cycle.html) | Cycles on an array of values.
[dataUrl](#dataurl) | Outputs an asset or file as a base64-encoded data URL.
[date](#date) | Creates a date.
[dump](#dump) | Dumps information about a variable.
[encodeUrl](#encodeurl) | Encodes and unencoded components of a URL.
[endBody](#endbody) | Outputs scripts and styles that were registered for the “end body” position.
[entryType](#entrytype) | Gets an entry type definition by its handle.
[expression](#expression) | Creates a database expression object.
[failMessageInput](#failmessageinput) | Outputs a hidden `failMessage` input.
[fieldValueSql](#fieldvaluesql) | Generates an SQL expression for accessing specific fields in elements’ JSON content column.
[floor](#floor) | Rounds a number down.
[getenv](#getenv) | Returns the value of an environment variable.
[gql](#gql) | Executes a GraphQL query against the full schema.
[head](#head) | Outputs scripts and styles that were registered for the “head” position.
[hiddenInput](#hiddeninput) | Outputs a hidden input.
[include](https://twig.symfony.com/doc/3.x/functions/include.html) | Returns the rendered content of a template.
[input](#input) | Outputs an HTML input.
[max](https://twig.symfony.com/doc/3.x/functions/max.html) | Returns the biggest value in an array.
[min](https://twig.symfony.com/doc/3.x/functions/min.html) | Returns the lowest value in an array.
[ol](#ol) | Outputs an array of items as an ordered list.
[parent](https://twig.symfony.com/doc/3.x/functions/parent.html) | Returns the parent block’s output.
[parseBooleanEnv](#parsebooleanenv) | Parses a string as an environment variable or alias having a boolean value.
[parseEnv](#parseenv) | Parses a string as an environment variable or alias.
[plugin](#plugin) | Returns a plugin instance by its handle.
[random](https://twig.symfony.com/doc/3.x/functions/random.html) | Returns a random value.
[range](https://twig.symfony.com/doc/3.x/functions/range.html) | Returns a list containing an arithmetic progression of integers.
[raw](#raw) | Wraps the given string in a `Twig\Markup` object to prevent it from getting HTML-encoded when output.
[redirectInput](#redirectinput) | Outputs a hidden `redirect` input.
[renderObjectTemplate](#renderobjecttemplate) | Renders an [object template](../../system/object-templates.md).
[seq](#seq) | Outputs the next or current number in a sequence.
[shuffle](#shuffle) | Randomizes the order of the items in an array.
[siteUrl](#siteurl) | Generates a front-end URL.
[source](#source) | Returns the content of a template without rendering it.
[successMessageInput](#successmessageinput) | Outputs a hidden `successMessage` input.
[svg](#svg) | Outputs an SVG document.
[tag](#tag) | Outputs an HTML tag.
[template_from_string](https://twig.symfony.com/doc/3.x/functions/template_from_string.html) | Loads a template from a string.
[ul](#ul) | Outputs an array of items as an unordered list.
[url](#url) | Generates a URL.

## `actionInput`

A shortcut for outputting a hidden input used to route a POST request to a particular controller action. This is effectively the same as writing `<input type="hidden" name="action" value="controller/action/route">` directly into a template.

```twig
{{ actionInput('users/save-user') }}
```

You can optionally set additional attributes on the tag by passing an `options` argument.

```twig
{{ actionInput('users/save-user', {
  id: 'action-input'
}) }}
```

## `actionUrl`

Returns a controller action URL, automatically accounting for relative vs. absolute format and the active <config5:actionTrigger> setting.

### Arguments

The `actionUrl()` function has the following arguments:

- **`path`** – The path that the resulting URL should point to on your site. It will be appended to your base site URL.
- **`params`** – Any query string parameters that should be appended to the URL. This can be either a string (e.g. `'foo=1&bar=2'`) or a [hash](../../development/twig.md#hashes) (e.g. `{ foo: '1', bar: '2' }`).
- **`scheme`** – Which scheme the URL should use (`'http'` or `'https'`). The default value depends on whether the current request is served over SSL or not. If not, then the scheme in your Site URL will be used; if so, then `https` will be used.

## `alias`

Passes a string through [Craft::getAlias()](yii2:yii\BaseYii::getAlias()), which will check if the string begins with an [alias](guide:concept-aliases). (See [Configuration](../../configure.md#aliases) for more info.)

```twig
<img src="{{ alias('@assetBaseUrl/images/logo.png') }}">
```

## `attr`

Generates a list of HTML attributes based on the given [hash](../../development/twig.md#hashes), using <yii2:yii\helpers\BaseHtml::renderTagAttributes()>.

```twig
{% set myAttributes = {
  class: ['one', 'two'],
  disabled: true,
  readonly: false,
  data: {
    baz: 'Escape this "',
    qux: {
      some: ['data', '"quoted"']
    }
  },
  style: {
    'background-color': 'red',
    'font-size': '20px'
  },
} %}

<div {{ attr(myAttributes) }}></div>
```

::: tip
Attribute values are HTML-encoded automatically:
```twig
<div {{ attr({ title: 'Greetings & Salutations' }) }}></div>
{# Output: <div title="Greetings &amp; Salutations"> #}
```
:::

## `beginBody`

Outputs any scripts and styles that were registered for the “begin body” position. It should be placed right after your `<body>` tag.

```twig
<body>
  {{ beginBody() }}

  <h1>{{ page.name }}</h1>
  {{ page.body }}
</body>
```

## `block`

Prints a block’s output.

This works identically to Twig’s core [`block`](https://twig.symfony.com/doc/3.x/functions/block.html) function.

## `canCreateDrafts`

Checks whether the current user (or a specific user, when provided) can create drafts from the passed element.

```twig
{% if canCreateDrafts(entry) %}
  <a href="{{ entry.getCpEditUrl() }}">Edit</a>
{% endif %}
```

## `canDelete`

Checks whether the current user (or a specific user, when provided) can delete the passed element.

```twig
{% if canDelete(entry) %}
  <a href="{{ entry.getCpEditUrl() }}">Edit</a>
{% endif %}
```

## `canDeleteForSite`

Checks whether the current user (or a specific user, when provided) can delete the passed element from the site it was loaded in.

```twig
{% if canDeleteForSite(entry) %}
  <a href="{{ entry.getCpEditUrl() }}">Edit</a>
{% endif %}
```

## `canDuplicate`

Checks whether the current user (or a specific user, when provided) can duplicate the passed element.

```twig
{% if canDuplicate(entry) %}
  <a href="{{ entry.getCpEditUrl() }}">Edit</a>
{% endif %}
```

## `canSave`

Checks whether the current user (or a specific user, when provided) can save the passed element.

```twig
{% if canSave(entry) %}
  <a href="{{ entry.getCpEditUrl() }}">Edit</a>
{% endif %}
```

## `canView`

Checks whether the current user (or a specific user, when provided) can view the passed element within the control panel.

```twig
{% if canView(entry) %}
  <a href="{{ entry.getCpEditUrl() }}">Edit</a>
{% endif %}
```

## `ceil`

Rounds a number up.

```twig
{{ ceil(42.1) }}
{# Output: 43 #}
```

## `className`

Returns the fully qualified class name of a given object.

```twig
{% set class = className(entry) %}
{# Result: 'craft\\elements\\Entry' #}
```

## `clone`

Clones a given object.

```twig
{% set query = craft.entries().section('news') %}
{% set articles = clone(query).type('articles') %}
```

## `collect`

Returns a new [collection](../../development/collections.md).

```twig
{% set collection = collect(['a', 'b', 'c']) %}
```

## `combine`

Combines two arrays into one, using the first array to define the keys, and the second array to define the values.

```twig
{% set arr1 = ['a', 'b', 'c'] %}
{% set arr2 = ['foo', 'bar', 'baz'] %}
{% set arr3 = combine(arr1, arr2) %}
{# arr3 will now be `{a: 'foo', b: 'bar', c: 'baz'}` #}
```

## `configure`

Passes through the behavior of the `Craft::configure()` method inherited from [`Yii::configure()`](yii2:yii\BaseYii::configure()). It’s similar to [`create`](#create) in that it applies attributes to an object, but instead of creating new instances it accepts an existing object and modifies it.

```twig
{# Modify an `EntryQuery` object set up by a relational field: #}
{% set myRelatedEntries = configure(entry.myEntriesField, {
  section: 'blog'
}).all() %}
```

`configure()` _can_ be used to set a model or element’s attributes—but we don’t generally recommend this, as templates are intended to present content rather than modify it:

```twig
{% do configure(entry, { title: 'New Title' }) %}
{% do craft.app.elements.saveElement(entry) %}
```

## `constant`

Returns the constant value for a given string.

This works identically to Twig’s core [`constant`](https://twig.symfony.com/doc/3.x/functions/constant.html) function.

## `cpUrl`

Returns a control panel URL, automatically accounting for relative vs. absolute format and the active <config5:cpTrigger> setting.

```twig
<a href="{{ cpUrl('settings') }}">Visit control panel settings</a>
```

### Arguments

The `cpUrl()` function has the following arguments:

- **`path`** – The path that the resulting URL should point to on your site. It will be appended to your base site URL.
- **`params`** – Any query string parameters that should be appended to the URL. This can be either a string (e.g. `'foo=1&bar=2'`) or a [hash](../../development/twig.md#hashes) (e.g. `{foo:'1', bar:'2'}`).
- **`scheme`** – Which scheme the URL should use (`'http'` or `'https'`). The default value depends on whether the current request is served over SSL or not. If not, then the scheme in your Site URL will be used; if so, then `https` will be used.

## `create`

Creates a new object instance based on a given class name or object configuration. See <yii2:Yii::createObject()> for a full explanation of supported arguments.

```twig
{# Pass in a class name #}
{% set cookie = create('yii\\web\\Cookie') %}

{# Or a full object configuration hash #}
{% set cookie = create({
  class: 'yii\\web\\cookie',
  name: 'foo',
  value: 'bar'
}) %}
```

## `csrfInput`

Renders a CSRF token `input` element for use in an HTML form. All sites that have CSRF protection enabled must include this in each [form](../../development/forms.md) that makes a POST request.

::: code
```twig Usage
{{ csrfInput() }}
```
```html Output
<input type="hidden" name="CRAFT_CSRF_TOKEN" value="MfVs9Nyp33VKpXH7S0eUZZxy74Dw25VUYHGti-(...)">
```
:::


You can set additional attributes on the rendered tag by passing an `options` argument:

```twig
{{ csrfInput({
  id: 'my-csrf-input',
}) }}
```

::: warning
The output of `csrfInput()` should not be cached—statically, or using [template caches](tags.md#cache).
:::

Craft automatically sends [`no-cache` headers](craft5:craft\web\Response::setNoCacheHeaders()) when generating or outputting a CSRF token. <Since ver="5.3.0" description="We began sending automatic no-cache headers in {product} {ver}." />

A special `async` key in the passed hash allows you to override the global <config5:asyncCsrfInputs> setting for a single input <Since ver="5.1.0" feature="The asyncCsrfInputs setting" />:

```twig
{{ csrfInput({
  async: true,
}) }}
```

Asynchronous CSRF inputs _are_ cacheable, and therefore no headers are sent—but other features of the page (including other `csrfInput()` calls) can still cause no-cache headers to be sent.

Craft outputs a placeholder element, and registers a snippet of JavaScript that requests a token over Ajax, once the page has loaded in the client. Only one request is made, regardless of the number of inputs on the page.

## `dataUrl`

Outputs an asset or file as a base64-encoded [data URL](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs). You can pass it an <craft5:craft\elements\Asset> object or a file path (optionally using an [alias](../../configure.md#aliases)).

```twig
{# Asset object `myLogoAsset` #}
<img src="{{ dataUrl(myLogoAsset) }}" />

{# File path, optionally using an alias #}
<img src="{{ dataUrl('@webroot/images/my-logo-asset.svg') }}" />

{# Output: <img src="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjEwMCIgdmd(...)" /> #}
```

The `dataUrl()` function has the following arguments:

- **`file`** - The asset or path to a file to be encoded.
- **`mimeType`** - Optional MIME type. If omitted, the file’s MIME type will be determined automatically.

## `date`

Converts an argument to a date to allow comparison, like [Twig’s `date()` function](https://twig.symfony.com/doc/3.x/functions/date.html).

The argument can be one of PHP’s supported [date and time formats](https://www.php.net/manual/en/datetime.formats.php), or additionally a `date`/`time` array.

```twig
{% if date(asset.dateModified) < date('-2days') %}
  {# asset is not new #}
{% endif %}
```

A `null` or empty argument defaults to the current date:

```twig
{% if date() > date('2021/06/01') %}
  {# today is past June 1, 2021 #}
{% endif %}
```

Craft additionally supports passing a `date`/`time` array:

```twig
{% set myDate = {
  date: '2021-01-15',
  timezone: 'America/Los_Angeles',
  time: '10:57',
} %}

{% if now > date(myDate) %}
  {# today is past January 15, 2021 #}
{% endif %}
```

## `dump`

Overrides Twig’s default [`dump()`](https://twig.symfony.com/doc/3.x/functions/dump.html) function  with one that is available in all contexts (not just when the Twig environment is in “debug” mode), and produces consistent output with the [`{% dd %}` tag](./tags.md#dd).

```twig
{% set news = craft.entries()
  .section('news')
  .all() %}

{{ dump(news|column('title')) }}
```

## `encodeUrl`

Ensures a URL contains only ASCII characters. The underlying <craft5:craft\helpers\UrlHelper::encodeUrl()> function is automatically called by Craft’s internal redirection logic. This is typically only required when using a URL in an HTTP header. Supposing we have a URL with accented characters like `https://my-project.ddev.site/pages/åbçdé`…

```twig
{# …unencoded output leads to garbled characters, and won’t resolve if requested: #}
{% header "X-See-Also: #{entry.url}" %}
{# -> https://my-project.ddev.site/Ã¥bÃ§dÃ©  #}

{# …but encoding the output preserves the original accented characters: #}
{% header "X-See-Also: #{encodeUrl(entry.url)}" %}
{# -> https://my-project.ddev.site/%C3%A5b%C3%A7d%C3%A9 #}
```

## `endBody`

Outputs any scripts and styles that were registered for the “end body” position. It should be placed right before your `</body>` tag.

```twig{9}
<html>
  <head>
    {# ... #}
  </head>
  <body>
    <h1>{{ page.name }}</h1>
    {{ page.body }}

    {{ endBody() }}
  </body>
</html>
```

## `entryType`

Get a reference to an entry type, by its handle:

```twig{1}
{% set type = entryType('post') %}

{{ type.name }}
```

This is equivalent to using the entries service, directly:

```twig{1}
{% set type = craft.app.entries.getEntryTypeByHandle('post') %}

{{ type.name }}
```

When creating entries in a [front-end form](../../development/forms.md), you can use the `entryType()` function to find the correct ID to submit (IDs can be unstable between environments, due to the way [project config](../../system/project-config.md#ids-uuids-and-handles) works):

```twig
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('entries/save-entry') }}

  {{ hiddenInput('typeId', entryType('post').id) }}

  {# ... #}
</form>
```

## `expression`

Creates and returns a new <yii2:yii\db\Expression> object, for use in database queries.

```twig
{% set entries = craft.entries()
  .andWhere(expression('[[authorId]] = :authorId', {authorId: currentUser.id}))
  .all() %}
```

## `failMessageInput`

Renders a hidden `input` element with a tamper-proof [failure](../../development/forms.md#failure) message.

```twig{3}
<form method="post">
  {{ actionInput('users/save-user') }}
  {{ failMessageInput('Something went wrong when updating your profile.') }}

  {# ... #}
</form>
```

You can set additional attributes on the `input` tag by passing an `options` argument:

```twig
{{ failMessageInput('Something went wrong when updating your profile.', {
  id: 'failure-message-input'
}) }}
```

The output is equivalent to this Twig:

```twig
<input
  type="hidden"
  name="failMessage"
  value="{{ 'Something went wrong when updating your profile.'|hash }}">
```

Failure messages are stored in the session as [flashes](../../development/forms.md#flashes).

<See path="../../development/forms.md" label="Working with Forms" />

## `fieldValueSql`

Generates a platform-specific SQL expression to extract a value from elements’ JSON content column.

```twig
{% set longestFilm = craft.entries()
  .section('films')
  .max(fieldValueSql(entryType('film'), 'runtimeMinutes')) %}
```

::: tip
Craft automatically handles this for `orderBy()` and `select()` expressions, as well as when using field methods, directly:

```twig
{% set shortFilms = craft.entries()
  .section('films')
  .runtimeMinutes('<= 20')
  .orderBy('runtimeMinutes DESC')
  .all() %}
```
:::

### Arguments

- `provider` — An object that implements `craft\base\FieldLayoutProviderInterface`, like an [entry type](../element-types/entries.md#entry-types) or [asset volume](../element-types/assets.md#volumes)—basically anything that defines a field layout.
    ```twig
    {# Load a field layout provider: #}
    {# set volume = craft.app.volumes.getVolumeByHandle('photos') %}
    {% set longExposures = craft.assets()
      .volume('photos')
      .andWhere('between', (fieldValueSql(volume, 'shutterSpeed')), 0.17, 1)
      .all() %}
    ```

    The provider can also be passed from an existing resource, like `entry.type`.

- `fieldHandle` — The field’s handle in the given field layout. This may be different than the field’s global definition—especially if the field is present [multiple times](../../system/fields.md#multi-instance-fields) in the layout.

## `floor`

Rounds a number down.

```twig
{{ floor(42.9) }}
{# Output: 42 #}
```

## `getenv`

Returns the value of an environment variable, using <craft5:craft\helpers\App::env()>.

```twig
{{ getenv('MAPS_API_KEY') }}
```

::: danger
Take care to not leak sensitive environment variables into your HTML!
:::

## `gql`

Executes a GraphQL query against the full schema.

```twig
{% set result = gql('{
  entries (section: "news", limit: 2, orderBy: "dateCreated DESC") {
    postDate @formatDateTime (format: "Y-m-d")
    title
    url
    ... on news_article_Entry {
      shortDescription
      featuredImage {
        url @transform (width: 300)
        altText
      }
    }
  }
}') %}

{% for entry in result.data %}
  <h3><a href="{{ entry.url }}">{{ entry.title }}</a></h3>
  <p class="timestamp">{{ entry.postDate }}</p>

  {% set image = entry.featuredImage[0] %}
  <img class="thumb" src="{{ image.url }}" alt="{{ image.altText }}">

  {{ entry.shortDescription|markdown }}
  <p><a href="{{ entry.url }}">Continue reading…</a></p>
{% endfor %}
```

## `head`

Outputs any scripts and styles that were registered for the “head” position. It should be placed right before your `</head>` tag.

```twig
<head>
  <title>{{ siteName }}</title>
  {{ head() }}
</head>
```

## `hiddenInput`

Generates an HTML input tag.

```twig
{{ hiddenInput('entryId', entry.id) }}
{# Output: <input type="hidden" name="entryId" value="100"> #}
```

You can optionally set additional attributes on the tag by passing an `options` argument.

```twig
{{ hiddenInput('entryId', entry.id, {
  id: 'entry-id-input'
}) }}
```

## `include`

Returns the rendered content of a template.

This works identically to Twig’s core [`include`](https://twig.symfony.com/doc/3.x/functions/include.html) function.

## `input`

Generates an HTML input tag.

```twig
{{ input('email', 'email-input', '') }}
{# Output: <input type="email" name="email-input" value=""> #}
```

You can optionally set additional attributes on the tag by passing an `options` argument.

```twig
{{ input('email', 'email-input', '', {
  id: 'custom-input'
}) }}
{# Output: <input type="email" id="custom-input" name="email-input" value=""> #}
```

## `max`

Returns the biggest value in an array.

This works identically to Twig’s core [`max`](https://twig.symfony.com/doc/3.x/functions/max.html) function.

## `min`

Returns the lowest value in an array.

This works identically to Twig’s core [`min`](https://twig.symfony.com/doc/3.x/functions/min.html) function.

## `ol`

Outputs an array of items as an ordered list.

```twig
{% set titles = craft.entries()
  .section('news')
  .select('title')
  .column() %}
{{ ol(titles) }}
{# Output:
<ol>
  <li>Shocking Foo</li>
  <li>You Won’t Believe This Bar</li>
  <li>Ten Baz You Can’t Live Without</li>
</ol>
#}
```

### Arguments

The `ol()` function has the following arguments:

- **`items`** – An array of items to be wrapped in `<li>`s. These will be HTML-encoded by default.
- **`params`** – An attributes argument where each key+value will be set as attributes on the `<ol>`, with the exception of two special options:
    - **`encode: false`** – Prevents the list items from being HTML-encoded.
    - **`itemOptions: {...}`** – Tag attributes to be applied to each of the `<li>`s.

## `parseBooleanEnv`

Checks if a string references an environment variable (`$VARIABLE_NAME`) and returns the referenced boolean value, or `null` if a boolean value can’t be determined.

## `parseEnv`

Checks if a string references an environment variable (`$VARIABLE_NAME`) and/or an alias (`@aliasName`), and returns the referenced value.

If the string references an environment variable with a value of `true` or `false`, a boolean value will be returned.

## `plugin`

Returns a plugin instance by its handle, or `null` if no plugin is installed and enabled with that handle.

```twig
{{ plugin('commerce').version }}
```

## `raw`

Wraps the given string in a `Twig\Markup` object to prevent it from getting HTML-encoded when output.

```twig
{% set html = raw('<p>Don’t encode me.</p>') %}
{{ html }}
```

::: tip
This works similarly to the [raw](https://twig.symfony.com/doc/3.x/filters/raw.html) filter, except that Twig will remember not to escape the HTML even if the variable is passed to another template/macro, whereas `|raw` filters only have an effect if used directly in an output tag.
:::

## `redirectInput`

Output an HTML input equivalent to `<input type="hidden" name="redirect" value="{{ url|hash }}">`, for use in [forms](../../development/forms.md) that POST data to Craft or a plugin.

```twig
{{ redirectInput(url) }}
```

The URL is typically parsed as an object template, meaning dynamic redirects are possible, based on the data being manipulated.

You can optionally set additional attributes on the resulting `input` tag by passing an `options` argument:

```twig
{{ redirectInput(url, {
  id: 'redirect-input'
}) }}
```

::: warning
Don’t include user-provided data in redirection URLs, directly (via interpolation in a template) or indirectly (rendered in an object template).
:::

## `renderObjectTemplate`

Evaluates a string as an [object template](../../system/object-templates.md), using the provided element, model, or hash.

```twig
{{ renderObjectTemplate('👋 Hi, {fullName}!', currentUser) }}
{# Output: 👋 Hi, Oli! #}

{{ renderObjectTemplate('✨ {foo}', { foo: "I’m a made-up hash!" }) }}
{# Output: ✨ I’m a made-up hash! #}
```

::: danger
Do not pass user-supplied templates to the `renderObjectTemplate()` function!
:::

## `seq`

Outputs the next or current number in a sequence, defined by `name`:

```twig
<p>This entry has been read {{ seq('hits:' ~ entry.id) }} times.</p>
```

Each time the function is called, the given sequence will be automatically incremented.

You can optionally have the number be zero-padded to a certain length.

```twig
{{ now|date('Y') ~ '-' ~ seq('orderNumber:' ~ now|date('Y'), 5) }}
{# Output: 2018-00001 #}
```

To view the current number in the sequence without incrementing it, set the `next` argument to `false`.

```twig
<h5><a href="{{ entry.url }}">{{ entry.title }}</a></h5>
<p>{{ seq('hits:' ~ entry.id, next=false) }} views</p>
```

## `shuffle`

Randomizes the order of the elements within an array.

```twig
{% set promos = craft.entries().section('promos').all() %}
{% set shuffledPromos = shuffle(promos) %}

{% for promo in shuffledPromos %}
  <div class="promo {{ promo.slug }}">
    <h3>{{ promo.title }}</h3>
    <p>{{ promo.description }}</p>
    <a class="cta" href="{{ promo.ctaUrl }}">{{ promo.ctaLabel }}</a>
  </div>
{% endfor %}
```

## `siteUrl`

Similar to [url()](#url-path-params-scheme-mustshowscriptname), except _only_ for creating URLs to pages on your site.

```twig
<a href="{{ siteUrl('company/contact') }}">Contact Us</a>
```

### Arguments

The `siteUrl()` function has the following arguments:

- **`path`** – The path that the resulting URL should point to on your site. It will be appended to your base site URL.
- **`params`** – Any query string parameters that should be appended to the URL. This can be either a string (e.g. `'foo=1&bar=2'`) or a [hash](../../development/twig.md#hashes) (e.g. `{foo:'1', bar:'2'}`).
- **`scheme`** – Which scheme the URL should use (`'http'` or `'https'`). The default value depends on whether the current request is served over SSL or not. If not, then the scheme in your Site URL will be used; if so, then `https` will be used.
- **`siteId`** – The ID of the site that the URL should point to. By default the current site will be used.

## `source`

Returns the content of a template without rendering it.

This works identically to Twig’s core [`source`](https://twig.symfony.com/doc/3.x/functions/source.html) function.

## `successMessageInput`

Renders a hidden `input` element with a tamper-proof [success](../../development/forms.md#success) message.

```twig{3}
<form method="post">
  {{ actionInput('users/save-user') }}
  {{ successMessageInput('Your profile has been updated!') }}

  {# ... #}
</form>
```

You can set additional attributes on the `input` tag by passing an `options` argument:

```twig
{{ successMessageInput('Your profile has been updated!', {
  id: 'success-message-input'
}) }}
```

The output is equivalent to this Twig:

```twig
<input
  type="hidden"
  name="successMessage"
  value="{{ 'Your profile has been updated!'|hash }}">
```

Success messages are stored in the session as [flashes](../../development/forms.md#flashes).

<See path="../../development/forms.md" label="Working with Forms" />

## `svg`

Outputs an SVG document.

You can pass the following things into it:

- An SVG file path.

  ```twig
  {{ svg('@webroot/icons/lemon.svg') }}
  ```

- A <craft5:craft\elements\Asset> object, such as one pulled in from an [Assets field](../field-types/assets.md).

  ```twig
  {% set image = entry.myAssetsField.one() %}
  {% if image and image.extension == 'svg' %}
    {{ svg(image) }}
  {% endif %}
  ```

- Raw SVG markup.

  ```twig
  {% set image = include('_includes/icons/lemon.svg') %}
  {{ svg(image) }}
  ```

By default, if you pass an asset or raw markup into the function, the SVG will be sanitized of potentially malicious scripts using [svg-sanitizer](https://github.com/darylldoyle/svg-sanitizer), and any IDs or class names within the document will be namespaced so they don’t conflict with other IDs or class names in the DOM. You can disable those behaviors using the `sanitize` and `namespace` arguments:

```twig
{{ svg(image, sanitize=false, namespace=false) }}
```

Images passed via path/alias will _not_ automatically be sanitized and namespaced.

<!-- textlint-disable terminology -->

You can also specify a custom class name that should be added to the root `<svg>` node using the [attr](filters.md#attr) filter:

<!-- textlint-enable terminology -->

```twig
{{ svg('@webroot/icons/lemon.svg')|attr({ class: 'lemon-icon' }) }}
```

::: tip
Consider caching the output, especially if you’re loading SVG files from a remote volume, so Craft doesn’t download the file each time your template is rendered.
:::

## `tag`

Renders a complete HTML tag.

```twig
{{ tag('div', {
  class: 'foo'
}) }}
{# Output: <div class="foo"></div> #}
```

If `text` is included in the attributes argument, its value will be HTML-encoded and set as the text contents of the tag.

```twig
{{ tag('div', {
  text: 'Hello'
}) }}
{# Output: <div>Hello</div> #}
```

If `html` is included in the attributes argument (and `text` isn’t), its value will be set as the inner HTML of the tag (without getting HTML-encoded).

::: warning
Be sure you trust any input you provide via `html` since it could be an XSS (cross-site scripting) attack vector. It’s safer to use `text` wherever possible.
:::

```twig
{{ tag('div', {
  html: 'Hello<br>world'
}) }}
{# Output: <div>Hello<br>world</div> #}
```

All other keys passed to the second argument will be set as attributes on the tag, using <yii2:yii\helpers\BaseHtml::renderTagAttributes()>.

If an attribute is set to `true`, it will be added without a value.

```twig
{{ tag('input', {
  id: 'foo',
  name: 'bar',
  required: true
}) }}
{# Output: <input id="foo" name="bar" required> #}
```

Any attribute set to `null` or `false` will be omitted.

::: tip
Attribute values are HTML-encoded automatically:
```twig
{{ tag('input', {
  name: 'bar',
  value: 'Foobar & Baz',
}) }}
{# Output: <input name="bar" value="Foobar &amp; Baz"> #}
```
:::

## `ul`

Outputs an array of items as an unordered list.

```twig
{% set titles = craft.entries()
  .section('news')
  .select('title')
  .column() %}
{{ ul(titles) }}
{# Output:
<ul>
  <li>Shocking Foo</li>
  <li>You Won’t Believe This Bar</li>
  <li>Ten Baz You Can’t Live Without</li>
</ul>
#}
```

### Arguments

The `ul()` function has the following arguments:

- **`items`** – An array of items to be wrapped in `<li>`s. These will be HTML-encoded by default.
- **`params`** – An attributes argument where each key+value will be set as attributes on the `<ul>`, with the exception of two special options:
    - **`encode: false`** – Prevents the list items from being HTML-encoded.
    - **`itemOptions: {...}`** – Tag attributes to be applied to each of the `<li>`s.

## `url`

Returns a URL.

```twig
<a href="{{ url('company/contact') }}">Contact Us</a>
```

### Arguments

The `url()` function has the following arguments:

- **`path`** – The path that the resulting URL should point to on your site. It will be appended to your base site URL.
- **`params`** – Any query string parameters that should be appended to the URL. This can be either a string (e.g. `'foo=1&bar=2'`) or a [hash](../../development/twig.md#hashes) (e.g. `{foo:'1', bar:'2'}`).
- **`scheme`** – Which scheme the URL should use (`'http'` or `'https'`). The default value depends on whether the current request is served over SSL or not. If not, then the scheme in your Site URL will be used; if so, then `https` will be used.
- **`mustShowScriptName`** – If this is set to `true`, then the URL returned will include “index.php”, disregarding the <config5:omitScriptNameInUrls> config setting. (This can be useful if the URL will be used by POST requests over Ajax, where the URL will not be shown in the browser’s address bar, and you want to avoid a possible collision with your site’s .htaccess file redirect.)

Using the `url()` function has advantages over hard-coding URLs in your templates:

- Generated URLs will encourage consistency by respecting settings like [addTrailingSlashesToUrls](config5:addTrailingSlashesToUrls).
- Your site will be more portable, making it easier to do something like move to a new domain or subdomain.
- If the page has a `token` URL parameter, that token will automatically get appended to generated URLs to maintain preview context navigating around the site.

::: tip
You can use the `url()` function for appending query string parameters and/or enforcing a scheme on an absolute URL:
```twig
{{ url('http://my-project.tld', 'foo=1', 'https') }}
{# Output: "https://my-project.tld?foo=1" #}
```
:::
</file>

<file path="reference/twig/global-variables.md">
---
description: Discover objects and data available to you in any Twig context.
---

# Global Variables

A number of [global variables](https://twig.symfony.com/doc/3.x/templates.html#global-variables) are available to Twig templates. Some come from Twig itself, and some are Craft-specific.

Global variables are accessible in _every_ Twig template, including [system messages](../../system/mail.md#system-messages) and [object templates](../../system/object-templates.md) used for element URIs.

This page is split into four sections:

1. [**Twig defaults**](#twig-defaults): Variables provided by Twig itself.
1. [**Craft**](#craft): Variables injected by Craft.
1. [**Constants**](#php-constants--equivalents): Equivalents of PHP constants.
1. [**Elements**](#automatically-loaded-elements): Auto-loaded elements.

::: tip
These lists may be supplemented by plugins, so refer to their documentation to see what kind of functionality is exposed to your templates!
:::

## Twig Defaults

Global variables [provided directly by Twig](https://twig.symfony.com/doc/3.x/templates.html#global-variables).

Variable | Description
--- | ---
`_self` | The current template name.
`_context` | The currently-defined variables.
`_charset` | The current charset.

## Craft

Additional variables provided by Craft. 

Variable | Description
--- | ---
[_globals](#globals) | Get and set values on a globally-available store.
[craft](#craft-2) | A <craft5:craft\web\twig\variables\CraftVariable> object.
[currentSite](#currentsite) | The requested site.
[currentUser](#currentuser) | The currently logged-in user.
[devMode](#devmode) | Whether Dev Mode is enabled.
[loginUrl](#loginurl) | The URL to the front-end Login page.
[logoutUrl](#logouturl) | The URL to the front-end Logout page.
[now](#now) | The current date/time.
[primarySite](#primarysite) <Since ver="5.6.0" feature="Global Twig variable for the primary site" /> | In multi-site projects, the “primary” site.
[setPasswordUrl](#setpasswordurl) | The URL to the front-end [Reset Password](kb:front-end-user-accounts#reset-password-form) page.
[siteName](#sitename) | The name of the current site.
[siteUrl](#siteurl) | The base URL of the current site.
[systemName](#systemname) | The system name.
[today](#today) | Midnight of the current day.
[tomorrow](#tomorrow) | Midnight, tomorrow.
[view](#view) | The app’s `view` component.
[yesterday](#yesterday) | Midnight, yesterday.
[Global set variables](#global-set-variables) | Variables for each of the global sets.
[Single variables](#singles) | Variables for each [single section](../element-types/entries.md#singles) entry.

### `_globals`

An empty [Collection](../../development/collections.md) object. You may set and get values with the corresponding methods:

```twig
{% do _globals.set('theme', 'dark') %}
{% do _globals.set({
  red: '#F00',
  green: '#0F0',
  blue: '#00F',
}) %}

{{ _globals.get('theme') }}
{# -> 'dark' #}

{{ _globals.get('red') }}
{# -> '#F00' #}
```

The `_globals` variable has all the native [collection methods](../../development/collections.md#methods), as well as a few that Craft provides (via [macros](https://laravel.com/docs/10.x/collections#method-macro))—including the `set()` method used in the example above, which adds support for setting multiple Collection keys at once.

::: tip
Note that we’re using Twig’s `do` tag to _set_ values. You can _get_ values in any kind of Twig expression—like an output statement or a `set` tag.
:::

If you need to set or manipulated _nested_ values, consider creating a top-level Collection object:

```twig
{% do _globals.set('events', collect()) %}

{# ... #}

{% do _globals.get('events').push("show:element:#{entry.id}") %}
```

View the current contents of the `_globals` variable by passing it to the [`dump` tag](tags.md#dump):

```twig
{# .all() turns the Collection into a plain array: #}
{% dump _globals.all() %}
```

### `craft`

A <craft5:craft\web\twig\variables\CraftVariable> object, which provides access points to various helper functions and objects for templates. Many plugins will attach functionality here.

#### `craft.app`

A reference to the main <craft5:craft\web\Application> or <craft5:craft\console\Application> instance (the same object you get when accessing `Craft::$app` in PHP) is also available to templates via `craft.app`.

::: warning
Accessing things via `craft.app` is considered advanced. There are more security implications than other Twig-specific variables and functions, and your templates will be more susceptible to breaking changes between major Craft versions.
:::

Some of the services commonly used in templates:

- `craft.app.request` – [Request](craft5:craft\web\Request) object with information about the current HTTP request
- `craft.app.session` – [Session](craft5:craft\web\Session) object useful for getting and setting [flash messages](../../development/forms.md#flashes)
- `craft.app.user` – [User](craft5:craft\web\User) object for getting information about the client’s identity
- `craft.app.config.general` – [GeneralConfig](craft5:craft\config\GeneralConfig) object of [General Config Settings](../config/general.md)
- `craft.app.fields` – [Fields](craft5:craft\services\Fields) service for accessing [custom field](../../system/fields.md) details
- `craft.app.sites` – [Sites](craft5:craft\services\Sites) service for getting [site](../../system/sites.md) details

::: tip
Keep in mind that Twig templates can be rendered from web requests, the CLI, and within queue jobs—so there are situations in which certain features may no be available (like the “[current user](#currentuser),” or information about the request).

The specific services (or “components”) available via `craft.app` correspond to the keys defined in Craft’s [`app.php`](repo:craftcms/cms/blob/5.x/src/config/app.php), [`app.web.php`](repo:craftcms/cms/blob/5.x/src/config/app.web.php), and your project’s [equivalent config files](../config/app.md).
:::

Here are some examples of these services being used in a template:

```twig
{# get the value of an `email` query parameter or post field #}
{% set address = craft.app.request.getParam('email') %}

{# get the value of the `notice` flash message #}
{% set message = craft.app.session.getFlash('notice') %}

{# get the current user’s email address #}
{% set email = craft.app.user.email %}

{# is `devMode` enabled? #}
{% set isDevMode = craft.app.config.general.devMode %}

{# get a custom field by its `body` handle #}
{% set field = craft.app.fields.getFieldByHandle('body') %}

{# get all the sections for the current site #}
{% set sections = craft.app.entries.getAllSections() %}

{# get all the sites for the current Craft installation #}
{% set sites = craft.app.sites.allSites() %}
```

### `currentSite`

The requested site, represented by a <craft5:craft\models\Site> object.

```twig
{{ currentSite.name }}
```

You can access all of the sites in the same group as the current site via `currentSite.group.sites`:

```twig
<nav>
  <ul>
    {% for site in currentSite.group.sites %}
      <li><a href="{{ alias(site.baseUrl) }}">{{ site.name }}</a></li>
    {% endfor %}
  </ul>
</nav>
```

### `currentUser`

The currently-logged-in user, represented by a <craft5:craft\elements\User> object, or `null` if no one is logged in.

```twig
{% if currentUser %}
  Welcome, {{ currentUser.friendlyName }}!
{% endif %}
```

::: warning
Some templates are rendered in contexts that don’t use sessions or have any concept of a “current user,” like the command line. [System messages](../../system/mail.md#system-messages) are also somewhat unintuitive in this regard, because the current user may not be the recipient!
:::

### `devMode`

Whether the <config5:devMode> config setting is currently enabled.

```twig
{% if devMode %}
  Craft is running in dev mode.
{% endif %}
```

### `loginUrl`

The URL to your site’s login page, based on the <config5:loginPath> config setting.

```twig
{% if not currentUser %}
  <a href="{{ loginUrl }}">Login</a>
{% endif %}
```

### `logoutUrl`

The URL Craft uses to log users out, based on the <config5:logoutPath> config setting. Note that Craft will automatically redirect users to your homepage after going here; there’s no such thing as a “logout _page_”.

```twig
{% if currentUser %}
  <a href="{{ logoutUrl }}">Logout</a>
{% endif %}
```

### `now`

A [DateTime](http://php.net/manual/en/class.datetime.php) object set to the current date and time.

```twig
Today is {{ now|date('M j, Y') }}.
```

### `primarySite` <Since ver="5.6.0" feature="Global Twig variable for the primary site" />

The _primary_ site (as designated in <Journey path="Settings, Sites" />), as an instance of <craft4:craft\models\Site>.

```twig
{# Output the primary site’s name: #}
We are a proud member of {{ primarySite.name }}

{# Link to a page on the primary site: #}
{{ tag('a', {
  href: siteUrl('about/governance', siteId = primarySite.id),
  text: 'Learn about our family of businesses',
}) }}
```

`primarySite` will be a reference to the same object as [`currentSite`](#currentsite), when `currentSite.primary` is `true`. You can also retrieve the primary site via `craft.app.sites.primarySite`.

### `setPasswordUrl`

The URL to [`setPasswordRequestPath`](config5:setPasswordRequestPath) if it’s set. (This wraps the path in [`siteUrl`](#siteurl).)

```twig
{% if setPasswordUrl %}
  <a href="{{ setPasswordUrl }}">Reset password</a>
{% endif %}
```

### `siteName`

The name of the current site, as defined in **Settings** → **Sites**.

```twig
<h1>{{ siteName }}</h1>
```

### `siteUrl`

The base URL of the current site.

```twig
<link rel="home" href="{{ siteUrl }}">
```

::: tip
To generate a URL relative to the current site, use the [`siteUrl()` function](functions.md#siteurl).
:::

### `systemName`

The **System Name**, as defined in **Settings** → **General**.

### `today`

A [DateTime](http://php.net/manual/en/class.datetime.php) object in the system’s timezone, set to midnight (00:00 in 24-hour time, or 12:00AM in 12-hour) of the _current_ day.

### `tomorrow`

A [DateTime](http://php.net/manual/en/class.datetime.php) object in the system’s timezone, set to midnight (00:00 in 24-hour time, or 12:00AM in 12-hour) of the _next_ day.

### `view`

A reference to the <craft5:craft\web\View> instance that is driving the template.

### `yesterday`

A [DateTime](http://php.net/manual/en/class.datetime.php) object in the system’s timezone, set to midnight (00:00 in 24-hour time, or 12:00AM in 12-hour) of the _previous_ day.

## PHP Constants + Equivalents

Twig doesn’t distinguish between variables and constants, nor does it expose PHP’s global constants for use in templates (except via the `constant()` function, discussed below). However, Craft exposes a few that make it easier to work with built-in features.

Variable | Description
-------- | -----------
[POS_BEGIN](#pos-begin) | The [craft\web\View::POS_BEGIN](craft5:craft\web\View#constants) constant.
[POS_END](#pos-end) | The [craft\web\View::POS_END](craft5:craft\web\View#constants) constant.
[POS_HEAD](#pos-head) | The [craft\web\View::POS_HEAD](craft5:craft\web\View#constants) constant.
[POS_LOAD](#pos-load) | The [craft\web\View::POS_LOAD](craft5:craft\web\View#constants) constant.
[POS_READY](#pos-ready) | The [craft\web\View::POS_READY](craft5:craft\web\View#constants) constant.
[SORT_ASC](#sort-asc) | The `SORT_ASC` PHP constant.
[SORT_DESC](#sort-desc) | The `SORT_DESC` PHP constant.
[SORT_FLAG_CASE](#sort-flag-case) | The `SORT_FLAG_CASE` PHP constant.
[SORT_LOCALE_STRING](#sort-locale-string) | The `SORT_LOCALE_STRING` PHP constant.
[SORT_NATURAL](#sort-natural) | The `SORT_NATURAL` PHP constant.
[SORT_NUMERIC](#sort-numeric) | The `SORT_NUMERIC` PHP constant.
[SORT_REGULAR](#sort-regular) | The `SORT_REGULAR` PHP constant.
[SORT_STRING](#sort-string) | The `SORT_STRING` PHP constant.

Other constants are accessible with the [`constant()` function](https://twig.symfony.com/doc/3.x/functions/constant.html). Pass a string representing the way you would access it in PHP, including (when applicable) the fully-qualified, properly-escaped class name:

```twig
{# You can fetch native PHP constants... #}
{{ constant('PHP_VERSION') }}

{# ...constants defined by Craft... #}
{{ constant('CRAFT_BASE_PATH') }}

{# ...and even class constants: #}
{{ constant('craft\\elements\\Entry::STATUS_LIVE') }}
```

### `POS_BEGIN`

Twig-facing copy of the [craft\web\View::POS_BEGIN](craft5:craft\web\View#constants) constant. Used in conjunction with the registration of JS and HTML fragments to place them at the _beginning_ of the `<body>` element in the rendered page:

```twig
{% set js %}
  console.log('Hello, Craft!');
{% endset %}

{% do view.registerJs(js, POS_BEGIN) %}
```

### `POS_END`

Twig-facing copy of the [craft\web\View::POS_END](craft5:craft\web\View#constants) constant. Used in conjunction with the registration of JS and HTML fragments to place them at the _end_ of the `<body>` element in the rendered page:

```twig
{% set js %}
  console.log('Goodbye, Craft!');
{% endset %}

{% do view.registerJs(js, POS_END) %}
```

### `POS_HEAD`

Twig-facing copy of the [craft\web\View::POS_HEAD](craft5:craft\web\View#constants) constant. Used in conjunction with the registration of JS and HTML fragments to place them at the end of the `<head>` element in the rendered page:

```twig
{% set js %}
  console.log('Where am I?!');
{% endset %}

{% do view.registerJs(js, POS_HEAD) %}
```

### `POS_LOAD`

Twig-facing copy of the [craft\web\View::POS_LOAD](craft5:craft\web\View#constants) constant. Used only for registering JS fragments, wrapping the code in a jQuery “load” handler:

::: code
```twig Template
{% set js %}
  console.log('Page has finished loading.');
{% endset %}

{% do view.registerJs(js, POS_LOAD) %}
```
```js Output
jQuery(window).on('load', function () {
  console.log('Page has finished loading.');
});
```
:::

::: warning
Using `POS_LOAD` with `view.registerJs()` causes Craft to include its own copy of jQuery in the page.
:::

### `POS_READY`

Twig-facing copy of the [craft\web\View::POS_READY](craft5:craft\web\View#constants) constant. Used in the same way as `POS_LOAD`, but passes the script body to jQuery’s [ready](https://api.jquery.com/ready/) handler:

```js
jQuery(function ($) {
  console.log('DOM is ready.');
});
```

### `SORT_ASC`

Twig-facing copy of the `SORT_ASC` PHP constant.

### `SORT_DESC`

Twig-facing copy of the `SORT_DESC` PHP constant.

### `SORT_FLAG_CASE`

Twig-facing copy of the `SORT_FLAG_CASE` PHP constant.

### `SORT_LOCALE_STRING`

Twig-facing copy of the `SORT_LOCALE_STRING` PHP constant.

### `SORT_NATURAL`

Twig-facing copy of the `SORT_NATURAL` PHP constant.

### `SORT_NUMERIC`

Twig-facing copy of the `SORT_NUMERIC` PHP constant.

### `SORT_REGULAR`

Twig-facing copy of the `SORT_REGULAR` PHP constant.

### `SORT_STRING`

Twig-facing copy of the `SORT_STRING` PHP constant.

## Automatically Loaded Elements

Craft makes some elements available to all templates.

### Global Sets

Each of your site’s [global sets](../element-types/globals.md) will be available to your templates as global variables, named the same as their handle.

They will be represented as <craft5:craft\elements\GlobalSet> objects.

```twig
<p>{{ companyInfo.companyName }} was established in {{ companyInfo.yearEstablished }}.</p>
```

### Singles

Your [single section](../element-types/entries.md#singles) entries can also be loaded automatically by setting <config5:preloadSingles> to `true`. This makes them available by handle in all Twig contexts, just as global sets are. For example, if you had an “About Us” single with the handle `about`, you could access content from that entry in your footer, without setting up a query:

```twig{3}
<footer>
  &copy;{{ now|date('Y') }}
  {{ about.phoneNumber }}
</footer>

::: tip
When you convert a global set to a single using the [`entrify/global-set` command](../cli.md#entrify-global-set), template references should remain compatible, so long as <config5:preloadSingles> is enabled.
:::

### Other Elements

When an element’s URI is requested, Craft automatically loads that element into the Twig environment before rendering the template defined in the [element type](../../system/elements.md)’s settings.

For [entries](../element-types/entries.md), the variable is always named `entry`; for [categories](../element-types/categories.md), `category`. Element types provided by plugins may obey other conventions!
</file>

<file path="reference/twig/README.md">
# Twig Reference

This section covers features available in Twig, Craft’s template environment.

<See path="../../development/twig.md" label="Twig Fundamentals" />

<hr>

Craft provides additional functionality through all of Twig’s language features.

<See path="filters.md" />

<See path="functions.md" />

<See path="global-variables.md" />

<See path="tags.md" />

<See path="tests.md" />
</file>

<file path="reference/twig/tags.md">
---
description: Twig tags give your templates advanced logical capabilities.
---

# Tags

The following [tags](https://twig.symfony.com/doc/3.x/templates.html#control-structure) are available to Twig templates in Craft:

Tag | Description
--- | -----------
[apply](https://twig.symfony.com/doc/3.x/tags/apply.html) | Applies Twig filters to the nested template code.
[autoescape](https://twig.symfony.com/doc/3.x/tags/autoescape.html) | Controls the escaping strategy for the nested template code.
[block](https://twig.symfony.com/doc/3.x/tags/block.html) | Defines a template block.
[cache](#cache) | Caches a portion of your template.
[css](#css) | Registers a `<style>` tag on the page.
[dd](#dd) | Dump and die.
[dump](#dump) | Quietly dump a variable to the Yii debug toolbar.
[deprecated](https://twig.symfony.com/doc/3.x/tags/deprecated.html) | Triggers a PHP deprecation error.
[do](https://twig.symfony.com/doc/3.x/tags/do.html) | Does.
[embed](https://twig.symfony.com/doc/3.x/tags/embed.html) | Embeds another template.
[exit](#exit) | Ends the request.
[expires](#expires) | Set cache headers in a human-readable way.
[extends](https://twig.symfony.com/doc/3.x/tags/extends.html) | Extends another template.
[flush](https://twig.symfony.com/doc/3.x/tags/flush.html) | Flushes the output buffer.
[for](https://twig.symfony.com/doc/3.x/tags/for.html) | Loops through an array.
[from](https://twig.symfony.com/doc/3.x/tags/from.html) | Imports macros from a template.
[header](#header) | Sets an HTTP header on the response.
[hook](#hook) | Invokes a template hook.
[html](#html) | Registers arbitrary HTML code on the page.
[if](https://twig.symfony.com/doc/3.x/tags/if.html) | Conditionally executes the nested template code.
[import](https://twig.symfony.com/doc/3.x/tags/import.html) | Imports macros from a template.
[include](https://twig.symfony.com/doc/3.x/tags/include.html) | Includes another template.
[js](#js) | Registers a `<script>` tag on the page.
[macro](https://twig.symfony.com/doc/3.x/tags/macro.html) | Defines a macro.
[namespace](#namespace) | Namespaces input names and other HTML attributes, as well as CSS selectors.
[nav](#nav) | Creates a hierarchical nav menu.
[paginate](#paginate) | Paginates an element query.
[redirect](#redirect) | Redirects the browser.
[requireAdmin](#requireAdmin) | Requires that an admin user is logged in.
[requireEdition](#requireEdition) | Requires Craft’s edition to be equal to or better than what’s specified.
[requireGuest](#requireguest) | Requires that no user is logged in.
[requireLogin](#requirelogin) | Requires that a user is logged in.
[requirePermission](#requirepermission) | Requires that a user is logged in with a given permission.
[script](#script) | Renders an HTML script tag on the page.
[set](https://twig.symfony.com/doc/3.x/tags/set.html) | Sets a variable.
[switch](#switch) | Switch the template output based on a give value.
[tag](#tag) | Renders an HTML tag on the page.
[use](https://twig.symfony.com/doc/3.x/tags/use.html) | Inherits from another template horizontally.
[verbatim](https://twig.symfony.com/doc/3.x/tags/verbatim.html) | Disables parsing of nested Twig code.
[with](https://twig.symfony.com/doc/3.x/tags/with.html) | Creates a nested template scope.

## `cache`

This tag will cache the output from a portion of your template, which can improve performance for subsequent requests.

```twig
{% cache %}
  {% for block in entry.myMatrixField.all() %}
    <p>{{ block.text }}</p>
  {% endfor %}
{% endcache %}
```

Since the cache tag is for caching _output_ and not _logic_, avoid caching `{{ csrfInput() }}`, form fields, or parts of templates where the markup is highly dynamic or personalized.

By default, cached output will be kept by URL without regard for the query string.

While carefully-placed `{% cache %}` tags can offer significant boosts to performance, it’s important to know how the cache tag’s parameters affect its behavior.

::: tip
The `{% cache %}` tag captures code and styles registered with `{% js %}`, `{% script %}` and `{% css %}` tags.

External references from `{% js %}` and `{% css %}` tags will be stored as well.
:::

### Parameters

The `{% cache %}` tag provides multiple ways to define how long a fragment will be cached. Parameters can be combined to achieve the desired result:

#### `globally`

Caches the output globally (for the current site), rather than on a per-URL basis.

```twig
{% cache globally %}
```

#### `using key`

Specifies the name of the key the cache should use. When the key changes, the tag’s contents are re-rendered. If this parameter is not provided, a random key will be generated each time Twig re-parses the template.

```twig
{% cache using key "page-header" %}
```

::: warning
If you change template code within a `{% cache %}` that uses a custom key, existing template caches will not automatically be purged. Either assign the tag a new key, or clear your existing template caches manually by navigating to **Utilities** → **Caches** and clearing **Data caches**.
:::

You can provide a dynamic key and combine it with [globally](#globally) for more control over template caching. For example, you could cache based on the URL *with* the query string that’s ignored by default:

```twig
{% set request = craft.app.request %}
{% set uriWithQueryString = request.fullUri ~ request.queryStringWithoutPath %}
{% cache globally using key uriWithQueryString %}
```

#### `for`

The amount of time it should take for the cache to expire.

```twig
{% cache for 3 weeks %}
```

The accepted duration units are defined by <craft5:craft\helpers\DateTimeHelper::RELATIVE_TIME_UNITS>:

- `sec`(`s`)
- `second`(`s`)
- `min`(`s`)
- `minute`(`s`)
- `hour`(`s`)
- `day`(`s`)
- `fortnight`(`s`)
- `forthnight`(`s`)
- `month`(`s`)
- `year`(`s`)
- `week`(`s`)

If this parameter is omitted, your <config5:cacheDuration> config setting will be used to define the default duration.

#### `until`

A [DateTime](http://php.net/manual/en/class.datetime.php) object defining when the cache should expire.

```twig
{% cache until entry.eventDate %}
```

::: tip
You can only use [for](#for) **_or_** [until](#until) in a single `{% cache %}` tag.
:::

#### `if`

Only activates the `{% cache %}` tag if a certain condition is met.

```twig
{# Only cache if this is a mobile browser #}
{% cache if craft.app.request.isMobileBrowser() %}
```

#### `unless`

Prevents the `{% cache %}` tag from activating if a certain condition is met.

```twig
{# Don’t cache if someone is logged in #}
{% cache unless currentUser %}
```

::: tip
You can only use [if](#if) _or_ [unless](#unless) in a single `{% cache %}` tag.
:::

### Cache Clearing

Your template caches will automatically clear when any elements (entries, assets, etc.) within the tags are saved or deleted.

If you have any element _queries_ within the tags (e.g. a `craft.entries`), and you create a new element that should be returned by one of the queries, Craft will also be able to figure that out and clear the cache.

You can also manually clear your template caches from the Utilities page, using the “Clear Caches” tool, or by using the `invalidate-tags/template` console command.

```bash
php craft invalidate-tags/template
```

### When to Use `{% cache %}` Tags

You should use `{% cache %}` tags when a template requires many database queries, or you’re doing something very computationally expensive with Twig. Some examples include…

- N+1 queries: Lists of elements or other records for which [eager-loading](../../development/eager-loading.md) is not possible.
- Other complex queries: Sections of pages that involve expensive database queries or post-processing, like sums, averages, etc.
- External data: Pulling in data from a remote source, like a JSON endpoint or RSS feed.

There are also some cases where it’s _not_ a good idea to use them:

- Static text: retrieving text from the cache is slower than just outputting it.
- Logic: anything outside a `{% block %}` tag can’t be cached. Variables set inside a `cache` tag won’t be available to the surrounding template when the output is retrieved from the cache.
- Shuffled content: If the order of items on a page should be randomized each time the page is loaded, don’t cache it.

Depending on your project’s infrastructure and [cache configuration](../config/app.md#cache), it may take more time to read a value from the cache than it would to regenerate it. If the cache tag does not affect response times, profile your templates in the debug toolbar to find your bottleneck.

::: tip
The `{% cache %}` tag detects un-generated [image transform](../../development/image-transforms.md) URLs within it and holds off caching the template until the next request so those temporary image URLs aren’t cached.
:::

To cache scalar values that don’t benefit from the cache tag’s automatic invalidation, you can use Craft’s caching API directly via `craft.app.cache`.

## `css`

The `{% css %}` tag can be used to register a CSS file or a CSS code block.

```twig
{# Register a CSS file #}
{% css "/assets/css/style.css" %}

{# Register a CSS code block #}
{% css %}
  .content {
    color: {{ entry.textColor }};
  }
{% endcss %}
```

::: tip
To register a CSS file, the URL must begin with `https://` or `http://`, or end in `.css`.
:::

### Parameters

The `{% css %}` tag supports the following parameters:

#### `with`

Any HTML attributes that should be included on the `<style>` tag.

```twig
{% css with {type: 'text/css'} %}
```

Attributes will be rendered by <yii2:yii\helpers\BaseHtml::renderTagAttributes()>.

## `dd`

Outputs a variable to the browser and ends the request. (`dd` is short for “Dump-and-Die”)

```twig
{% set entry = craft.entries().id(entryId).one() %}
{% dd entry %}
```

## `dump`

Unlike [`dd`](#dd) (which halts execution), `{% dump %}` quietly logs the current context (or a provided variable) to the Yii debug toolbar, in a special **Dumps** tab. You can use the tag any number of times during a request, and Craft will keep track of the template path and line number that produced the output. For example, this template…

```twig{3}
{# templates/_blog/post #}

{% dump entry %}

{# ... #}
```

…would log a <craft5:craft\elements\Entry> object tagged `templates/_blog/post:3` to the debug toolbar. If you’re not sure what variables you have access to in a given template, you can use the tag _without_ a variable to dump everything:

```twig
{% dump %}
```

In this scenario, keys of the dumped array are variable names, and the values represent the [data types](../../development/twig.md#types-of-values). Expand complex types to view nested properties by clicking any value with a signature like `craft\elements\Category {#123 ▶}`.

::: tip
To enable the debug toolbar, visit your user profile in the [control panel](../../system/control-panel.md) and check **Show the debug toolbar on the front end** within the **Preferences** tab.
:::

## `exit`

This tag will prevent the rest of the template from executing, and end the request.

```twig
{% set entry = craft.entries().id(entryId).one() %}

{% if not entry %}
  {% exit 404 %}
{% endif %}
```

### Parameters

The `{% exit %}` tag supports the following parameters:

#### Status

If you choose to set the HTTP status code that should be included with the response, Craft will look for the appropriate error template to render. For example, `{% exit 404 %}` will get Craft to return the `404.twig` template. If the template doesn’t exist, Craft will fall back on its own template corresponding to the status code.

::: tip
`{% exit %}` throws an [HttpException](yii2:yii\web\HttpException) with the appropriate status code, so with <config5:devMode> enabled a full error report and stack trace will be shown instead of an error template.
:::

#### Message

The second parameter is passed to the [error template](../../system/routing.md#error-templates) as the `message` variable:

```twig
{% if not currentUser.isInGroup('powerUsers') ?? false %}
  {% exit 403 'You must be a power user to access this page!' %}
{% endif %}
```

## `expires` <Since ver="5.2.0" feature="The “expires” Twig tag" />

Control HTTP caching headers with a Twig-friendly date expression.

### Parameters

The `expires` tag accepts a single, optional expression beginning with either `in` or `on`.

`in`
:   Uses a duration expression to set cache headers:

    - `{% expires in 1 week %}`
    - `{% expires in 2 hours %}`
    - `{% expires in 4 days %}`

    The allowed units are the same as those supported by the (unrelated) [`cache` tag](#cache).

`on`
:   Sets cache headers to a specific date:

    - `{% expires on entry.expiryDate %}` — Derived from an element attribute or custom field.
    - `{% expires on now|date_modify('midnight next friday') %}` — Using an offset compatible with PHP’s [relative date parser](https://www.php.net/manual/en/datetime.formats.php#datetime.formats.relative).
    - `{% expires on tomorrow %}` — One of the [date variables](global-variables.md#tomorrow) Craft provides.

When neither an `in` nor `on` clause are used in the tag, Craft instead calls <craft5:craft\web\Response::setNoCacheHeaders()>. Using the `expires` tag multiple times in a single request will only honor the _last_ evaluated call. This behavior be unintuitive due to Twig’s processing order, particularly when using `extends` and `embed` tags.

## `header`

This tag will set an HTTP header on the response.

```twig
{# Tell the browser to cache this page for 30 days #}
{% set expiry = now|date_modify('+30 days') %}

{% header "Cache-Control: max-age=" ~ (expiry.timestamp - now.timestamp) %}
{% header "Pragma: cache" %}
{% header "Expires: " ~ expiry|date('D, d M Y H:i:s', 'GMT') ~ " GMT" %}
```

::: tip
Headers which contain dates must be formatted according to [RFC 7234](https://tools.ietf.org/html/rfc7231#section-7.1.1.2). You can use the [httpdate](filters.md#httpdate) filter (added in Craft 3.6.10) to do this:
```twig
{% header "Expires: #{myDate|httpdate}" %}
```
:::

Setting a header this way will override any previously-set value. Some headers are best set with dedicated features like the [`expires` tag](#expires), or internal cookie APIs ([`craft.app.response.cookies`](yii2:yii\web\Response::getCookies()))

### Parameters

The `{% header %}` tag supports the following parameter:

#### Header

You specify the full header (including its name and value, separated by a `:`) that should be sent by typing it as a string after the word `header`. This parameter is required.

## `hook`

This tag gives plugins and modules an opportunity to hook into the template, to either return additional HTML or make changes to the available template variables.

```twig
{# Give plugins a chance to make changes here #}
{% hook 'my-custom-hook-name' %}
```

See [Template Hooks](../../extend/template-hooks.md) for details on plugins and modules can work with `{% hook %}` tags.

## `html`

The `{% html %}` tag can be used to register arbitrary HTML code on the page.

```twig
{% html %}
  <p>This will be placed right before the <code>&lt;/body&gt;</code> tag.</p>
{% endhtml %}
```

::: tip
The tag calls <craft5:craft\web\View::registerHtml()> under the hood, which can also be accessed via the [global `view` variable](global-variables.md#view).

```twig
{% set para = '<p>This will be placed right before the <code>&lt;/body&gt;</code> tag.</p>' %}
{% do view.registerHtml(para) %}
```
:::

### Parameters

The `{% html %}` tag supports the following parameters:

#### Position

You can specify where the HTML code should be injected into the page using one of these position keywords:

| Keyword | Description
| ------- | -----------
| `at head` | In the page’s `<head>`
| `at beginBody` | At the beginning of the page’s `<body>`
| `at endBody` | At the end of the page’s `<body>`

```twig
{% html at head %}
```

By default, `at endBody` will be used.

## `js`

The `{% js %}` tag can be used to register a JavaScript file or a JavaScript code block.

```twig
{# Register a JS file: #}
{% js "/assets/js/script.js" %}

{# Register a JS code block: #}
{% js %}
  _gaq.push([
    "_trackEvent",
    "Search",
    "{{ searchTerm|e('js') }}"
  ]);
{% endjs %}
```

::: tip
To register a JavaScript file, the URL must begin with `https://` or `http://`, or end in `.js`.

To provide a *dynamic* filename reference, use [`view.registerJsFile()`](craft5:craft\web\View::registerJsFile()) instead:
```twig
{% set myJsFile = "/assets/js/script.js" %}
{% do view.registerJsFile(myJsFile) %}
```
:::

If a duplicate URL or JavaScript block is registered, Craft will only output it once. Blocks are registered with a key derived from the `md5` hash of its contents, after stripping whitespace from its start and end, and ensuring it is terminated by a semicolon.

Suppose one of your entries relied on a carousel library for slideshows managed via a Matrix field—some entries may have _no_ slideshows, but others may have _multiple_:

```twig
{% for block in entry.myMatrixField.all() %}
  {% switch block.type %}
    {% case 'text' %}
      {{ block.text|md }}
    {% case 'slideshow' %}
      {# 1. Include carousel library: #}
      {% js 'https://cdn.jsdelivr.net/npm/package/file' %}

      {# 2. Initialize this carousel instance: #}
      {% js %}
        Carousel.init('#carousel-{{ block.uid | e('js') }}')
      {% endjs %}

      {# 3. Output carousel markup: #}
      <div id="carousel-{{ block.uid }}">
        {% for image in block.images.all() %}
          {{ image.getImg() }}
        {% endfor %}
      </div>
    {% default %}
      <p>Unknown block type!</p>
{% endfor %}
```

Rendering this template would result in the library (1) being output _once_ (because the URL is the same each time), but each initialization block (2) being output individually (because it includes a unique `id` target for the current carousel). If no `slideshow` blocks were rendered, no scripts would be output—but you could still register the same script elsewhere on your site without fear of it being included twice.

### Parameters

The `{% js %}` tag supports the following parameters:

#### Position

You can specify where the `<script>` tag should be added to the page using one of these position keywords:

| Keyword | Description
| ------- | -----------
| `at head` | In the page’s `<head>`
| `at beginBody` | At the beginning of the page’s `<body>`
| `at endBody` | At the end of the page’s `<body>`
| `on load` | At the end of the page’s `<body>`, within `jQuery(window).load()`
| `on ready` | At the end of the page’s `<body>`, within `jQuery(document).ready()`

```twig
{% js at head %}
```

By default, `at endBody` will be used.

::: warning
Setting the position to `on load` or `on ready` will cause Craft to load its internal copy of jQuery onto the page (even if the template is already including its own copy), so you should probably avoid using them in front-end templates.
:::

#### `with`

Any HTML attributes that should be included on the `<script>` tag.

```twig
{% js "/assets/js/script.js" with {
  defer: true
} %}
```

Attributes will be rendered by <yii2:yii\helpers\BaseHtml::renderTagAttributes()>.

::: warning
The `with` parameter is only available when you specify a JavaScript file; it won’t have any effect with a JavaScript code block.
:::

## `namespace`

The `{% namespace %}` tag can be used to namespace input names and other HTML attributes, as well as CSS selectors.

For example, this:

```twig
{% namespace 'foo' %}
<style>
  .text { font-size: larger; }
  #title { font-weight: bold; }
</style>
<input class="text" id="title" name="title" type="text">
{% endnamespace %}
```

would become this:

```html
<style>
  .text { font-size: larger; }
  #foo-title { font-weight: bold; }
</style>
<input class="text" id="foo-title" name="foo[title]" type="text">
```

Notice how the `#title` CSS selector became `#foo-title`, the `id` attribute changed from `title` to `foo-title`, and the `name` attribute changed from `title` to `foo[title]`.

If you want class names to get namespaced as well, add the `withClasses` flag. That will affect both class CSS selectors and `class` attributes:

```twig
{% namespace 'foo' withClasses %}
```

That would result in:

```html{2,5}
<style>
  .foo-text { font-size: larger; }
  #foo-title { font-weight: bold; }
</style>
<input class="foo-text" id="foo-title" name="foo[title]" type="text">
```

::: tip
This tag works identically to the [namespace](filters.md#namespace-or-ns) filter, except that it will call <craft5:craft\web\View::setNamespace()> at the beginning, so any PHP code executed within it can be aware of what the nested IDs will become.
:::

## `nav`

This tag helps create a hierarchical navigation menu for entries in a [Structure section](../element-types/entries.md#section-types) or a [Category Group](../element-types/categories.md).

```twig
{% set entries = craft.entries()
  .section('pages')
  .orderBy('lft ASC')
  .all() %}

<ul id="nav">
  {% nav entry in entries %}
    <li>
      <a href="{{ entry.url }}">{{ entry.title }}</a>
      {% ifchildren %}
        <ul>
          {% children %}
        </ul>
      {% endifchildren %}
    </li>
  {% endnav %}
</ul>
```

Note that we are doing two things to ensure the entire tree of pages is displayed correctly:

- The query fetches _all_ elements: we grab everything in the structure in a single, flat array.
- Ordering by `lft ASC`: this ensures that the pages are properly sorted, such that every child appears after its parent.

Craft then takes this one-dimensional array of elements and evaluates the opening and closing template content (fragments on either side of `{% children %}`, within `{% ifchildren %}`) a number of times appropriate to each item’s `level` relative to the last item.

::: tip
The `{% nav %}` tag should _only_ be used in times when you want to show elements in a hierarchical list. If you want to show elements in a flat list, use a [for](https://twig.symfony.com/doc/tags/for.html) tag instead.
:::

### Parameters

The `{% nav %}` tag has the following parameters:

#### Item name

The first thing to follow “`{% nav`” is the variable name you’d like to use to represent each item in the loop, e.g. `item`, `entry`, or `category`. You will be using this variable name to reference the items inside the loop.

#### `in`

Next you need to type the word “`in`”, followed by the array of entries the tag should loop through. This can be an array of elements, or an [element query](../../development/element-queries.md).

::: warning
The `{% nav %}` tag requires elements to be queried in a specific (hierarchical) order, so make sure you don’t override the `order` criteria parameter in conjunction with this tag.
:::

### Showing children

The `{% children %}` tag will output the children of the current element in the loop, using the same template defined between your `{% nav %}` and `{% endnav %}` tags.

If you want to show some additional HTML surrounding the children, but only in the event that the element actually has children, wrap your `{% children %}` tag with `{% ifchildren %}` and `{% endifchildren %}` tags.

::: warning
Don’t add any special logic between your `{% ifchildren %}` and `{% endifchildren %}` tags. These are special tags that are used to identify the raw HTML that should be output surrounding nested nav items. They don’t get parsed in the order you’d expect.
:::

## `paginate`

This tag makes it easy to paginate query results across multiple pages.

```twig
{% set query = craft.entries()
  .section('blog')
  .limit(10) %}

{% paginate query as pageInfo, pageEntries %}

{% for entry in pageEntries %}
  <article>
    <h1>{{ entry.title }}</h1>
    {{ entry.body }}
  </article>
{% endfor %}

{% if pageInfo.prevUrl %}<a href="{{ pageInfo.prevUrl }}">Previous Page</a>{% endif %}
{% if pageInfo.nextUrl %}<a href="{{ pageInfo.nextUrl }}">Next Page</a>{% endif %}
```

Complete reference for the `paginate` tag and the related `pageInfo` objects is available on the [element queries](../../development/element-queries.md#pagination) page.

::: warning
Only a single `{% paginate %}` tag should be used per request.
:::

### Parameters

The `{% paginate %}` tag has the following parameters:

#### Query

The first thing you pass into the `{% paginate %}` tag is a query object (such as an [element query](../../development/element-queries.md)), which defines all of the results that should be paginated. Use the `limit` parameter to define how many results should show up per page (100 by default).

::: warning
This parameter needs to be an actual query object, not an array of pre-fetched results. So don’t call `all()` on the query before passing it in.
:::

#### `as`

Next up you need to type “`as`”, followed by one or two variable names:

- `as pageInfo, pageEntries`
- `as pageEntries`

Here’s what they get set to:

- `pageInfo` gets set to a <craft5:craft\web\twig\variables\Paginate> object, which provides info about the current page, and some helper methods for creating links to other pages. (See [below](#the-pageInfo-variable) for more info.)
- `pageEntries` gets set to an array of the results (e.g. the elements) that belong to the current page.

::: tip
If you only specify one variable name here, the `pageInfo` variable will be called `paginate` by default for backwards compatibility.
:::

### Showing the results

The `{% paginate %}` tag won’t actually output the current page’s results for you. It will only give you an array of the results that should be on the current page (referenced by the variable you defined in the `as` parameter.)

Following your `{% paginate %}` tag, you will need to loop through this page’s results using a [for](https://twig.symfony.com/doc/tags/for.html) tag.

```twig
{% paginate craft.entries().section('blog').limit(10) as pageEntries %}

{% for entry in pageEntries %}
  <article>
    <h1>{{ entry.title }}</h1>
    {{ entry.body }}
  </article>
{% endfor %}
```

### The `pageInfo` variable

The `pageInfo` variable (or whatever you’ve called it) provides the following properties and methods:

- **`pageInfo.first`** – The offset of the first result on the current page.
- **`pageInfo.last`** – The offset of the last result on the current page.
- **`pageInfo.total`** – The total number of results across all pages
- **`pageInfo.currentPage`** – The current page number.
- **`pageInfo.totalPages`** – The total number of pages.
- **`pageInfo.prevUrl`** – The URL to the previous page, or `null` if you’re on the first page.
- **`pageInfo.nextUrl`** – The URL to the next page, or `null` if you’re on the last page.
- **`pageInfo.firstUrl`** – The URL to the first page.
- **`pageInfo.lastUrl`** – The URL to the last page.
- **`pageInfo.getPageUrl( page )`** – Returns the URL to a given page number, or `null` if the page doesn’t exist.
- **`pageInfo.getPrevUrls( [dist] )`** – Returns an array of URLs to the previous pages, with keys set to the page numbers. The URLs are returned in ascending order. You can optionally pass in the maximum distance away from the current page the function should go.
- **`pageInfo.getNextUrls( [dist] )`** – Returns an array of URLs to the next pages, with keys set to the page numbers. The URLs are returned in ascending order. You can optionally pass in the maximum distance away from the current page the function should go.
- **`pageInfo.getRangeUrls( start, end )`** – Returns an array of URLs to pages in a given range of page numbers, with keys set to the page numbers.
- **`pageInfo.getDynamicRangeUrls( max )`** – Returns an array of URLs to pages in a dynamic range of page numbers that surround (and include) the current page, with keys set to the page numbers.

### Navigation examples

The [pageInfo](#the-pageInfo-variable) variable gives you lots of options for building the pagination navigation that’s right for you. Here are a few common examples.

#### Previous/Next Page Links

If you just want simple Previous Page and Next Page links to appear, you can do this:

```twig
{% set query = craft.entries()
  .section('blog')
  .limit(10) %}

{% paginate query as pageInfo, pageEntries %}

{% if pageInfo.prevUrl %}<a href="{{ pageInfo.prevUrl }}">Previous Page</a>{% endif %}
{% if pageInfo.nextUrl %}<a href="{{ pageInfo.nextUrl }}">Next Page</a>{% endif %}
```

Note that we’re wrapping those links in conditionals because there won’t always be a previous or next page.

#### First/Last Page Links

You can add First Page and Last Page links into the mix, you can do that too:

```twig
{% set query = craft.entries()
  .section('blog')
  .limit(10) %}

{% paginate query as pageInfo, pageEntries %}

<a href="{{ pageInfo.firstUrl }}">First Page</a>
{% if pageInfo.prevUrl %}<a href="{{ pageInfo.prevUrl }}">Previous Page</a>{% endif %}
{% if pageInfo.nextUrl %}<a href="{{ pageInfo.nextUrl }}">Next Page</a>{% endif %}
<a href="{{ pageInfo.lastUrl }}">Last Page</a>
```

There’s no reason to wrap those links in conditionals since there will always be a first and last page.

#### Nearby Page Links

If you want to create a list of nearby pages, perhaps surrounding the current page number, you can do that too!

```twig
{% set query = craft.entries()
  .section('blog')
  .limit(10) %}

{% paginate query as pageInfo, pageEntries %}

<a href="{{ pageInfo.firstUrl }}">First Page</a>
{% if pageInfo.prevUrl %}<a href="{{ pageInfo.prevUrl }}">Previous Page</a>{% endif %}

{% for page, url in pageInfo.getPrevUrls(5) %}
  <a href="{{ url }}">{{ page }}</a>
{% endfor %}

<span class="current">{{ pageInfo.currentPage }}</span>

{% for page, url in pageInfo.getNextUrls(5) %}
  <a href="{{ url }}">{{ page }}</a>
{% endfor %}

{% if pageInfo.nextUrl %}<a href="{{ pageInfo.nextUrl }}">Next Page</a>{% endif %}
<a href="{{ pageInfo.lastUrl }}">Last Page</a>
```

In this example we’re only showing up to five page links in either direction of the current page. If you’d prefer to show more or less, just change the numbers that are passed into `getPrevUrls()` and `getNextUrls()`. You can also choose to not pass any number in at all, in which case *all* previous/next page URLs will be returned.

## `redirect`

This tag will redirect the browser to a different URL.

```twig
{% if not user or not user.isInGroup('members') %}
  {% redirect "pricing" %}
{% endif %}
```

### Parameters

The `{% redirect %}` tag has the following parameter:

#### The URL

Immediately after typing “`{% redirect`”, you need to tell the tag where to redirect the browser. You can either give it a full URL, or just the path.

#### The Status Code

By default, redirects will have `302` status codes, which tells the browser that the requested URL has only been moved to the redirected URL _temporarily_.

You can customize which status code accompanies your redirect response by typing it right after the URL. For example, the following code would return a `301` redirect (permanent):

```twig
{% redirect "pricing" 301 %}
```

#### Flash Messages

You can optionally set flash messages that will show up for the user on the next request using the `with notice` and/or `with error` params:

```twig
{% if not currentUser.isInGroup('members') %}
  {% redirect "pricing" 301 with notice "You have to be a member to access that!" %}
{% endif %}
```

## `requireAdmin`

This tag will ensure that an admin user is logged in. If the user is not logged in, they’ll be redirected to the Login page specified by your <config5:loginPath> config setting and returned to the original page after logging in as an admin. A user that’s already logged in but *not* an admin will get a 403 response.

```twig
{% requireAdmin %}
```

You can place this tag anywhere in your template, including within a conditional. If/when Twig gets to it, the admin enforcement will take place.

By default, Craft also ensures <config5:allowAdminChanges> is _on_. If not, a different 403 error is returned. You can opt out of this behavior (say, to display a [read-only](../../system/control-panel.md#read-only-mode) settings screen) by passing `false`:

```twig
{% requireAdmin false %}
```

## `requireEdition`

Requires Craft’s active edition to be equal to or “greater” than what’s specified. This is generally only useful to plugin developers who need to expose features only when a plugin is installed in a site running one edition or another.

If the Craft edition does not meet the requirement, the visitor will get a 404 response.

- `0` – Craft Solo
- `1` – Craft Team
- `2` – Craft Pro

```twig
{# Require Craft Pro #}
{% requireEdition 1 %}
```

You can place this tag anywhere in your template, including within a conditional. If/when Twig gets to it, the edition enforcement will take place.

::: tip
Control panel templates can use the `CraftSolo`, `CraftTeam`, and `CraftPro` edition variables.\
Example: `{% requireEdition CraftPro %}`.
:::

## `requireGuest`

This tag will ensure that the user is **not** logged in. If they’re already logged in, they’ll be redirected to the page specified by your <config5:postLoginRedirect> config setting.

```twig
{% requireGuest %}
```

You can place this tag anywhere in your template, including within a conditional. If/when Twig gets to it, the guest enforcement will take place.

## `requireLogin`

This tag will ensure that the user is logged in. If they aren’t, they’ll be redirected to a Login page and returned to the original page after successfully logging in.

```twig
{% requireLogin %}
```

You can place this tag anywhere in your template, including within a conditional. If/when Twig gets to it, the login enforcement will take place.

The login page location is based on your <config5:loginPath> config setting. If you do not set <config5:loginPath>, it defaults to `login`. That will throw a `404` error if you have not handled the `/login` route with a custom template. To use the control panel’s login form, set it to `admin/login` or `[your cpTrigger]/login`.

## `requirePermission`

This tag will ensure that the current user is logged in with an account that has a given permission.

```twig
{% requirePermission 'stayUpLate' %}
```

The user can have the permission either directly or through one of their user groups. If they don’t have it, a 403 (Forbidden) error will be served.

<See path="../../system/user-management.md" hash="permissions" label="User Permissions" description="View a complete list of available permissions." />

## `script`

Similar to the [`{% js %}`](#js) tag, but with full control over the resulting `<script>` tag’s attributes.

```twig
{% script with {type: 'module'} %}
// some JavaScript
{% endscript %}
```

## `switch`

“Switch statements” offer a clean way to compare a variable against multiple possible values, instead of using several repetitive `{% if %}` conditionals.

Take this template for example, which is running different template code depending on a Matrix block’s type:

```twig
{% if matrixBlock.type == "text" %}
  {{ matrixBlock.textField|markdown }}
{% elseif matrixBlock.type == "image" %}
  {{ matrixBlock.image[0].getImg() }}
{% else %}
  <p>A font walks into a bar.</p>
  <p>The bartender says, “Hey, we don’t serve your type in here!”</p>
{% endif %}
```

Since all of the conditionals are evaluating the same thing – `matrixBlock.type` – we can simplify that code using a `{% switch %}` tag instead:

```twig
{% switch matrixBlock.type %}
  {% case "text" %}
    {{ matrixBlock.textField|markdown }}
  {% case "image" %}
    {{ matrixBlock.image[0].getImg() }}
  {% default %}
    <p>A font walks into a bar.</p>
    <p>The bartender says, “Hey, we don’t serve your type in here!”</p>
{% endswitch %}
```

::: tip
Unlike `switch` statements in other languages, the matching `case` block will be broken out of automatically. You don’t need to worry about adding `break` statements.
:::

### Checking multiple values from a single `{% case %}` tag

If you want to check for mulitple values from a single `{% case %}` tag, separate the values with `or` operators.

```twig
{% case "h2" or "h3" or "p" %}
  {# output an <h2>, <h3>, or <p> tag, depending on the block type #}
  {{ tag(matrixBlock.type, {
      text: matrixBlock.text
  }) }}
```

### Accessing the parent `loop` variable

If you’re using the `{% switch %}` tag inside of a `{% for %}` loop, you won’t be able to access Twig’s [loop variable](https://twig.symfony.com/doc/tags/for.html#the-loop-variable) directly inside of the `{% switch %}` tag.  Instead, you can access it like so:

```twig
{% for matrixBlock in entry.matrixField.all() %}
  {% set loopIndex = loop.index %}

  {% switch matrixBlock.type %}

    {% case "text" %}

        Loop #{{ loopIndex }}

  {% endswitch %}
{% endfor %}
```

## `tag`

The `{% tag %}` tag can be used to render an HTML element in a template.

It’s similar to the [tag](functions.md#tag) _function_, however the `{% tag %}` tag is better suited for cases where the tag contents need to be dynamic.

```twig
{% tag 'p' with {
  class: 'welcome',
} %}
  Hello, {{ currentUser.friendlyName }}
{% endtag %}
{# Output: <p class="welcome">Hello, Tim</p> #}
```

`{% tag %}` tags can also be nested:
```twig
{% tag 'div' with {
  class: 'foo',
} %}
  {% tag 'p' with {
    class: 'welcome',
  } -%}
    Hello, {{ currentUser.friendlyName }}
  {%- endtag %}
{% endtag %}
{# Output: <div class="foo"><p class="welcome">Hello, Tim</p></div> #}
```

::: tip
Attribute values are HTML-encoded automatically:
```twig
{% tag 'p' with {
  title: 'Hello & Welcome',
} %}
  Hello, {{ currentUser.friendlyName }}
{% endtag %}
{# Output: <p title="Hello &amp; Welcome">Hello, Tim</p> #}
```
:::

### Parameters

The `{% tag %}` tag has the following parameters:

#### Name

<!-- textlint-disable terminology -->

The first thing you must pass to the `{% tag %}` tag is the name of the node that should be rendered.

<!-- textlint-enable terminology -->

#### `with`

<!-- textlint-disable terminology -->

Next, you can optionally type “` with `” followed by an object with attributes for the node.

<!-- textlint-enable terminology -->

These will be rendered using <yii2:yii\helpers\BaseHtml::renderTagAttributes()> just like the [tag](functions.md#tag) function, except for the `html` and `text` keys because inner content will go between `{% tag %}` and `{% endtag %}` instead.

If an attribute is set to `true`, it will be added without a value:

```twig
{% tag 'textarea' with {
  name: 'message',
  required: true
} -%}
  Please foo some bar.
{%- endtag %}
{# Output: <textarea name="message" required>Please foo some bar.</textarea> #}
```
</file>

<file path="reference/twig/tests.md">
---
description: Perform comparisons in natural language.
---

# Tests

The following [tests](https://twig.symfony.com/doc/3.x/templates.html#test-operator) are available to Twig templates in Craft:

Test | Description
---- | -----------
[array](#array) | Whether a variable is an array.
[boolean](#boolean) | Whether a variable is a boolean value.
[callable](#callable) | Whether a variable is callable.
[constant](https://twig.symfony.com/doc/3.x/tests/constant.html) | Whether a variable is the same as a PHP constant value.
[countable](#countable) | Whether a variable is a countable value.
[defined](https://twig.symfony.com/doc/3.x/tests/defined.html) | Whether a variable is defined.
[divisible by](https://twig.symfony.com/doc/3.x/tests/divisibleby.html) | Whether a number is divisible by another number.
[empty](https://twig.symfony.com/doc/3.x/tests/empty.html) | Whether a variable is empty.
[even](https://twig.symfony.com/doc/3.x/tests/even.html) | Whether a number is even.
[float](#float) | Whether a variable is a float value.
[instance of](#instance-of) | Whether an object is an instance of a namespace or parent class.
[integer](#integer) | Whether a variable is an integer value.
[iterable](https://twig.symfony.com/doc/3.x/tests/iterable.html) | Whether a variable is an array or a traversable object.
[missing](#missing) | Whether an object is missing its expected class.
[null](https://twig.symfony.com/doc/3.x/tests/null.html) | Whether a variable is `null`.
[numeric](#numeric) | Whether a variable is numeric.
[object](#object) | Whether a variable is an object.
[odd](https://twig.symfony.com/doc/3.x/tests/odd.html) | Whether a number is odd.
[resource](#resource) | Whether a variable is a resource.
[same as](https://twig.symfony.com/doc/3.x/tests/sameas.html) | Whether a variable is the same as another.
[scalar](#scalar) | Whether a variable is a scalar.
[string](#string) | Whether a variable is a string value.

## `array`

Returns whether an object is an array via PHP’s [`is_array()`](https://www.php.net/manual/en/function.is-array.php) method.

```twig
{{ ['oh', 'hello', 'there'] is array ? 'true' : 'false' }}
{# result: true #}

{{ 'oh hai' is array ? 'true' : 'false' }}
{# result: false #}
```

## `boolean`

Returns whether an object is a boolean via PHP’s [`is_bool()`](https://www.php.net/manual/en/function.is-bool.php) method.

```twig
{% if myVar is boolean %}
  {{ myVar ? 'true' : 'false' }}
{% endif %}
```

## `callable`

Returns whether an object is callable via PHP’s [`is_callable()`](https://www.php.net/manual/en/function.is-callable.php) method.

```twig
{{ [entry, 'getStatus'] is callable ? 'true' : 'false' }}
{# result: true #}
```

## `countable`

Returns whether an object is a countable value via PHP’s [`is_countable()`](https://www.php.net/manual/en/function.is-countable.php) method.

::: tip
`is_countable()` was added in PHP 7.3.0, so for versions less than 7.3 this returns `true` if the object [is an array](#array) or instance of [Countable](https://www.php.net/manual/en/class.countable.php).
:::

```twig
{{ craft.entries() is countable ? 'true' : 'false' }}
{# result: true #}

{{ ['apple', 'orange'] is countable ? 'true' : 'false' }}
{# result: true #}

{{ 'dracula' is countable ? 'true' : 'false' }}
{# result: false #}
```

## `float`

Returns whether an object is a float via PHP’s [`is_float()`](https://www.php.net/manual/en/function.is-float.php) method.

```twig
{{ 10.5 is float ? 'true' : 'false' }}
{# result: true #}

{{ 9 is float ? 'true' : 'false' }}
{# result: false #}

{{ 'duck' is float ? 'true' : 'false' }}
{# result: false #}
```

## `instance of`

Returns whether an object is an instance of another object or class.

```twig
{% if element is instance of('craft\\elements\\Entry') %}
  <h1>{{ entry.title }}</h1>
{% endif %}
```

## `integer`

Returns whether an object is an integer via PHP’s [`is_int()`](https://www.php.net/manual/en/function.is-int.php) method.

```twig
{{ 23 is integer ? 'true' : 'false' }}
{# result: true #}

{{ '23' is integer ? 'true' : 'false' }}
{# result: false #}
```

## `missing`

Returns whether a given object is an instance of <craft5:craft\base\MissingComponentInterface>, an interface used to represent components whose types are missing.

```twig
{% if field is missing %}
  <p>😱</p>
{% endif %}
```

## `numeric`

Returns whether an object is numeric via PHP’s [`is_numeric()`](https://www.php.net/manual/en/function.is-numeric.php) method.

```twig
{{ 23 is numeric ? 'true' : 'false' }}
{# result: true #}

{{ '23' is numeric ? 'true' : 'false' }}
{# result: true #}

{{ 'twenty-three' is numeric ? 'true' : 'false' }}
{# result: false #}
```

## `object`

Returns whether a given object satisfies PHP’s [`is_object()`](https://www.php.net/manual/en/function.is-object.php) method.

```twig
{{ entry is object ? 'true' : 'false' }}
{# result: true #}

{{ entry.url is object ? 'true' : 'false' }}
{# result: false #}
```

## `resource`

Returns whether an object is a resource via PHP’s [`is_resource()`](https://www.php.net/manual/en/function.is-resource.php) method.

```twig
{{ asset.getStream() is resource ? 'true' : 'false' }}
{# result: true #}

{{ siteUrl is resource ? 'true' : 'false' }}
{# result: false #}
```

## `scalar`

Returns whether an object is a scalar via PHP’s [`is_scalar()`](https://www.php.net/manual/en/function.is-scalar.php) method.

```twig
{{ 'hai' is scalar ? 'true' : 'false' }}
{# result: true #}

{{ 23 is scalar ? 'true' : 'false' }}
{# result: true #}

{{ [23, 'hai'] is scalar ? 'true' : 'false' }}
{# result: false #}
```

## `string`

Returns whether an object is a string via PHP’s [`is_string()`](https://www.php.net/manual/en/function.is-string.php) method.

```twig
{{ '23' is string ? 'true' : 'false' }}
{# result: true #}

{{ 23 is string ? 'true' : 'false' }}
{# result: false #}
```
</file>

<file path="reference/cli.md">
---
keywords: cli, terminal, command
containsGeneratedContent: yes
---

# Console Commands

<Todo notes="Split into controllers?" />

The complete list of available commands will include those from any plugins or custom modules you’ve added to your project. Only those that are present by default in all Craft installations are listed below.

::: tip
Run `ddev craft help` to see a list of commands your project supports.
:::

### Global Options

All commands support the following options:

`--color`
: Explicitly enable or disable ANSI coloring in output. When omitted, color will only be used in environments that support it.

`--help`
: Displays help about the command, rather than running it. Alternative to `php craft help controller/action`.

`--interactive`
: Enable or disable interactive prompts for the command. When using the CLI in unattended or automated workflows (like CRON or deployments), consider setting `--interactive=0`.

`--isolated`
: Acquire a [mutex lock](yii2:yii\mutex\Mutex) before running the command to prevent simultaneous execution. Some commands (like `migrate` and `project-config`) have their own internal locking mechanism.

`--silent-exit-on-exception`
: Force a nominal exit code (`0`), even if an exception occurred. Useful when inconsequential failures would otherwise block chained commands in automated environments.

<!-- This section of the page is dynamically generated! Changes to the file below may be overwritten by automated tools. -->
!!!include(docs/.artifacts/cms/5.x/console-commands.md)!!!
</file>

<file path="reference/controller-actions.md">
---
description: Craft has a powerful and secure HTTP API for interacting with accounts, content, and other features from your front-end.
sidebarDepth: 2
related:
  - uri: ../development/forms.md
    label: Working with Forms in Craft
  - uri: https://craftcms.com/knowledge-base/front-end-user-accounts
    label: Supporting Public Registration
  - uri: https://www.yiiframework.com/doc/guide/2.0/en/structure-controllers
    label: Yii Controllers Guide
---

# Controller Actions

Controllers are Craft’s way of talking to the outside world. Pretty much everything you do with Craft is part of a request that involves a [controller action](guide:structure-controllers)—from updating settings to rendering an entry.

Most controllers and actions are carefully locked down with [permissions](../system/user-management.md#permissions) to prevent malicious activity, but a select few are necessarily available to users and guests _without_ special permissions to support features like [public registration](../system/user-management.md#public-registration) or [cart management](/commerce/5.x/system/orders-carts.md).

The following list of controller actions is non-exhaustive, but covers common patterns like [logging in](#post-userslogin), [creating entries](#post-entriessave-entry), and [managing an address book](#post-userssave-address).

<See path="../development/forms.md" label="Using Forms" description="Start here to learn about sending data to Craft." />

## Available Actions

This is not a comprehensive list! We have selected a few actions to illustrate fundamentals that many projects can benefit from—and to get you prepared to explore the rest of Craft’s [HTTP API](craft5:craft\controllers\AddressesController).

Action | Description
------ | -----------
<badge vertical="baseline" type="verb">POST</badge> [entries/save-entry](#post-entries-save-entry) | Creates or updates an entry.
<badge vertical="baseline" type="verb">POST</badge> [users/login](#post-users-login) | Logs a user in.
<badge vertical="baseline" type="verb">POST</badge> [users/save-user](#post-users-save-user) | Creates or updates a user account.
<badge vertical="baseline" type="verb">POST</badge> [users/upload-user-photo](#post-users-upload-user-photo) | Sets a user’s photo.
<badge vertical="baseline" type="verb">POST</badge> [users/send-password-reset-email](#post-users-send-password-reset-email) | Sends a password reset email.
<badge vertical="baseline" type="verb">GET/POST</badge> [users/set-password](#get-post-users-set-password) | Sets a new password on a user account.
<badge vertical="baseline" type="verb">POST</badge> [users/save-address](#post-users-save-address) | Create or update an [address](element-types/addresses.md) element.
<badge vertical="baseline" type="verb">POST</badge> [users/delete-address](#post-users-delete-address) | Delete an address element.
<badge vertical="baseline" type="verb">GET</badge> [users/session-info](#get-users-session-info) | Retrieve information about the current session.
<badge vertical="baseline" type="verb">GET</badge> [app/health-check](#get-app-health-check) | Ping your app to make sure it’s up.

In each of the following examples, you’ll find a list of **Supported Params** (the values you can send as <badge vertical="baseline" type="verb">GET</badge> query params or in the <badge vertical="baseline" type="verb">POST</badge> body) and information about the possible **Response** conditions.

**Supported Params** can be encoded in the query string, submitted with form inputs, or sent as properties in a [JSON payload](../development/forms.md#ajax).

<a name="global-params" title="Parameters respected for all POST requests"></a>

### Globally-Supported Params

All POST actions honor a few additional parameters, except when using an `Accepts: application/json` header:

- `redirect` — A [hashed](twig/filters.md#hash) URL or path that Craft will send the user to after a [successful request][success-after-post] (i.e. a user is registered or an entry is saved).
- `successMessage` — Overrides the default flash notice for the action.
- `failMessage` — Overrides the default flash error for the action.

::: tip
You can use the [`redirectInput()`](twig/functions.md#redirectinput), [`successMessageInput()`](twig/functions.md#successmessageinput), and [`failMessageInput()`](twig/functions.md#failmessageinput) Twig functions to inject these params into a form.
:::

### <badge vertical="baseline" type="verb">POST</badge> `entries/save-entry`

Create or update an entry the current User has appropriate permissions for.

::: tip
See the [Entry Form](kb:entry-form) guide for an example of working with this action.
:::

::: warning
Note that _all_ custom fields can updated by users. For this reason, you should not assume that custom fields are protected from modification simply because they are omitted from the form.

Similarly, if you are outputting user-submitted content anywhere on site, take special care to prevent yourself or other users from being exposed to [XSS vulnerabilities](https://owasp.org/www-community/attacks/xss/)!
:::

#### Supported Params

Param | Description
----- | -----------
`author` | The ID of the user account that should be set as the entry author. (Defaults to the entry’s current author, or the logged-in user.)
`canonicalId` | The ID of the entry to save, if updating an existing entry.
`enabledForSite` | Whether the entry should be enabled for the entry’s `siteId` (`1`/`0`), or an array of site IDs that the entry should be enabled for. (Defaults to the `enabled` param.)
`enabled` | Whether the entry should be enabled (`1`/`0`). (Defaults to enabled.)
`entryId` | Fallback if `canonicalId` isn’t passed, for backwards compatibility.
`entryVariable` | The [hashed](twig/filters.md#hash) name of the variable that should reference the entry, if a validation error occurs. (Defaults to `entry`.)
`expiryDate` | The expiry date for the entry. (Defaults to the current expiry date, or `null`.)
`fieldsLocation` | Parameter name under which Craft will look for custom field data. (Defaults to `fields`.)
`fields[...]` | [Custom field](../development/forms.md#custom-fields) values.
`parentId` | The ID of the parent entry, if it belongs to a structure section.
`postDate` | The post date for the entry. (Defaults to the current post date, or the current time.)
`provisional` | Updates the current user’s provisional draft (in the control panel, this correlates to an auto-save).
`revisionNotes` | Notes that should be stored on the new entry revision.
`sectionId` | The ID of the section the entry will be created in. (Only for new entries. User must have appropriate permissions.)
`siteId` | The ID of the site to save the entry in.
`slug` | The entry slug. (Defaults to the current slug, or an auto-generated slug.)
`sourceId` | Fallback if `canonicalId` isn’t passed, for backwards compatibility.
`title` | The entry title. (Defaults to the current entry title.)
`typeId` | The entry type ID to save the entry as. (Defaults to the current entry type for existing entries, or the first configured type for new ones.)

#### Permissions

Requests to `entries/save-entry` must by made by a logged-in user with the appropriate permissions. Permissions are dependent upon the site, section, and the original author (for existing entries).

It is not currently possible to allow anonymous access without [a plugin](https://plugins.craftcms.com/guest-entries?craft4).

#### Response

The action’s output depends on whether the entry saved successfully and the `Accept` header.

<span class="croker-table">

State | `text/html` | `application/json`
----- | ----------- | ------------------
<check-mark/> | [Standard behavior][success-after-post]. | [Standard behavior][success-after-post]; entry available under an `entry` key in the response object.
<x-mark/> | [Standard behavior][failure-during-post]; entry available under an `entry` variable, in the template. | [Standard behavior][failure-during-post].

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/login`

Logs a user in.

::: tip
See the [Front-End User Accounts](kb:front-end-user-accounts#login-form) guide for an example of working with this action.
:::

#### Supported Params

Param | Description
----- | -----------
`loginName` | The username or email of the user to login.
`password` | The user’s password.
`rememberMe` | Whether to keep the user logged-in for an extended period of time per the <config5:rememberedUserSessionDuration> config setting (`1`/`0`).

#### Response

The output of the action depends on whether the login was successful and the `Accept` header.

<span class="croker-table">

State | `text/html` | `application/json`
----- | ----------- | ------------------
<check-mark/> | [Standard behavior][success-after-post]. | [Standard behavior][success-after-post]; additional `returnUrl`,  `csrfTokenValue`, and `user` properties are included in the response object.
<x-mark/> | [Standard behavior][failure-during-post]; additional `loginName`, `rememberMe`, `errorCode`, and `errorMessage` variables will be available in the template. | [Standard behavior][failure-during-post]; additional `loginName`, `rememberMe`, `errorCode`, and `errorMessage` properties are included in the response object.

</span>

::: tip
The `errorCode` corresponds to one of the [`craft\elements\User::AUTH_*` constants](craft5:craft\elements\User).
:::

### <badge vertical="baseline" type="verb">POST</badge> `users/save-user`

Registers a new [user account](../system/user-management.md), or updates an existing one.

::: tip
See the [Front-End User Accounts](kb:front-end-user-accounts#registration-form) guide for an example of working with this action.
:::

::: warning
Note that _all_ custom fields can updated by users. For this reason, you should not assume that custom fields are protected from modification simply because they are omitted from the form.
:::

#### Supported Params

Param | Description
----- | -----------
`admin` | Whether the user should be saved as an admin (`1`/`0`). Only assignable if the logged-in user is an admin.
`currentPassword` | The user’s current password, which is required if `email` or `newPassword` are sent.
`email` | The user’s email address. (Only checked if registering a new user, updating the logged-in user, or the logged-in user is allowed to administrate users.)
`fieldsLocation` | Parameter name under which Craft will look for custom field data. (Defaults to `fields`.)
`fields[...]` | [Custom field](../development/forms.md#custom-fields) values.
`fullName` | The user’s full name. Preferred to discrete `firstName` and `lastName` params.
`firstName` | The user’s first name. `fullName` is preferred.
`lastName` | The user’s last name. `fullName` is preferred.
`newPassword` | The user’s new password, if updating the logged-in user’s account. (If registering a new user, send `password`.)
`passwordResetRequired` | Whether the user must reset their password before logging in again (`1`/`0`). Only assignable if the logged-in user is an admin.
`password` | The user’s password, when registering a new user. (Has no effect if <config5:deferPublicRegistrationPassword> is `true`. To change the current user’s password, send `newPassword`.)
`photo` | An uploaded user photo. Use `<input type="file">`.
`sendVerificationEmail` | Whether a verification email should be sent before accepting the new `email` (`1`/`0`). (Only used if email verification is enabled, and the logged-in user is allowed to opt out of sending it.)
`userId` | The ID of the user to save, if updating an existing user.
`userVariable` | The hashed name of the variable that should reference the user, if a validation error occurs. (Defaults to `user`.)
`username` | The user’s username. (Only checked if the <config5:useEmailAsUsername> config setting is `false`.)

#### Permissions

Special permissions are required to allow users to administrate or update other users. A user can always update their own account.

::: danger
Granting administrative permissions to front-end users opens your site up to permissions escalation and significant abuse.
:::

#### Response

The output depends on whether the user save action was successful and the `Accept` header.

<span class="croker-table">

State | `text/html` | `application/json`
----- | ----------- | ------------------
<check-mark label="Success" /> | [Standard behavior][success-after-post]; default redirection uses the <config5:activateAccountSuccessPath> config setting, if email verification is not required. | [Standard behavior][success-after-post]; additional `id` and `csrfTokenValue` keys.
<x-mark label="Success" /> | [Standard behavior][failure-during-post]; user will be available in the template under a variable determined by the `userVariable` param, or `user` by default. | [Standard behavior][failure-during-post].

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/upload-user-photo`

Sets a user’s photo to an uploaded image.

::: tip
You can update a user’s other properties and fields at the same time as uploading a photo, via [`users/save-user`](#post-users-save-user).
:::

#### Supported Params

Param | Description
----- | -----------
`userId` | ID of the user. Required, pass `{{ currentUser.id }}` to change a user’s own photo.
`photo` | Uploaded image. Use `<input type="file">`.

::: warning
Files cannot be uploaded using `Content-Type: application/json`.
:::

#### Response

The output depends on whether the upload was successful. Only JSON is returned, and the request must include the `Accept: application/json` header.

<span class="croker-table">

State | `application/json`
----- | ------------------
<check-mark label="Success" /> | [Standard behavior][success-after-post]; `html` and `photoId` properties. `html` is only useful in control panel contexts.
<x-mark label="Failure" /> | [Standard behavior][failure-during-post]; additional `error` key is available in the response object, with the exception message.

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/send-password-reset-email`

Sends a password reset email.

::: tip
See the [Front-End User Accounts](kb:front-end-user-accounts#reset-password-form) guide for an example of working with this action.
:::

#### Supported Params

Param | Description
----- | -----------
`loginName` | The username or email of the user to send a password reset email for.
`userId` | The ID of the user to send a password reset email for. (Only checked if the logged-in user has permission to edit other users.)

#### Response

The output of the action depends on whether the user exists, the reset password email was sent successfully, and the `Accept` header.

<span class="croker-table">

State | `text/html` | `application/json`
----- | ----------- | ------------------
<check-mark label="Success" /> | [Standard behavior][success-after-post]. | [Standard behavior][success-after-post].
<x-mark label="Failure" /> | [Standard behavior][failure-during-post]; additional `errors` and `loginName` variables are passed to the template. | [Standard behavior][failure-during-post]; additional `errors` and `loginName` keys are available in the response object.

</span>

::: tip
The `errors` variable may include multiple discrete failure messages, but the standard `message` variable will still be an accurate summary.
:::

### <badge vertical="baseline" type="verb">GET/POST</badge> `users/set-password`

A <badge vertical="baseline" type="verb">GET</badge> request displays a form allowing a user to set a new password on their account, and <badge vertical="baseline" type="verb">POST</badge> sets a new password on a user account. If the user is [pending](../../system/user-management.md), their account will be activated.

::: tip
This action is responsible for rendering the route defined by the <config5:setPasswordPath> setting.
:::

#### Supported Params

Param | Description
----- | -----------
`code` | <badge vertical="baseline" type="verb">GET/POST</badge> The user’s verification code. Craft will provide this in URLs generated from the control panel, or when a link is sent via email.
`id` | <badge vertical="baseline" type="verb">GET/POST</badge> The user’s UUID.
`newPassword` | <badge vertical="baseline" type="verb">POST</badge> The user’s new password.

::: tip
`code` and `id` are required for both <badge vertical="baseline" type="verb">GET</badge> and <badge vertical="baseline" type="verb">POST</badge> requests; users may click a link from an email that includes both as query params—it’s your responsibility to pass these to Craft as hidden fields (along with `newPassword`) in a subsequent form submission.

See the [Front-End User Accounts](kb:front-end-user-accounts#set-password-form) article for an example of how to set up this form.
:::

#### Response

The output of the action depends on the request method, whether the password was updated successfully, and the `Accept` header.

For <badge vertical="baseline" type="verb">GET</badge> requests:

<span class="croker-table">

State | `text/html`
----- | -----------
<check-mark label="Success" /> | [Standard behavior][success-after-post]; template determined by <config5:setPasswordPath> is rendered with `id` and `code` variables available.
<x-mark label="Failure" /> | [Standard behavior][failure-during-post]; exception message will point to the issue—commonly, a missing or invalid token.

</span>

For <badge vertical="baseline" type="verb">POST</badge> requests:

<span class="croker-table">

State | `text/html` | `application/json`
----- | ----------- | ------------------
<check-mark label="Success" /> | [Standard behavior][success-after-post]; redirection depends on the <config5:autoLoginAfterAccountActivation> and <config5:setPasswordSuccessPath> config settings, and whether the user has access to the control panel. | [Standard behavior][success-after-post]; additional `csrfTokenName` key will be available in the response object.
<x-mark label="Failure" /> | [Standard behavior][failure-during-post]; `errors` , `code`, `id`, and `newUser` variables will be passed to the resulting template. | [Standard behavior][failure-during-post].

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/save-address`

Saves or updates an [address](element-types/addresses.md) element against the current user’s account.

#### Supported Params

Param | Description
----- | -----------
`addressId` | An existing address’s ID can be sent to update it, as long as it’s owned by the current user.
`userId` | Owner of the new address. Owners cannot be changed after creation, and new addresses can only be created for the current user or other users they are allowed to edit.
`fullName` | Name for the address. First and last names are not stored discretely, but can by submitted separately.
`firstName` | Can be submitted independently from `lastName`, but will be combined for storage.
`lastName` | Can be submitted independently from `firstName`, but will be combined for storage.
`countryCode` | Required to localize and validate the rest of the address.
`organization` | Additional line for an organization or business name.
`organizationTaxId` | Tax/VAT ID.
`latitude` and `longitude` | GPS coordinates for the address. Not automatically populated or validated.
`fields[...]` | [Custom field](../development/forms.md#custom-fields) values.
`fieldsLocation` | Parameter name under which Craft will look for custom field data. (Defaults to `fields`.)

::: warning
**This list is incomplete!**

The remaining params depend upon the submitted `countryCode`—refer to the [`commerceguys/addressing` library](https://github.com/commerceguys/addressing/blob/master/src/AddressFormat/AddressField.php#L15-L25) for a comprehensive list, or [learn more about managing addresses](element-types/addresses.md#managing-addresses) in Craft.
:::

#### Response

The output of the action depends on whether the address was saved successfully and the `Accept` header.

<span class="croker-table">

State | `text/html` | `application/json`
----- | ----------- | ------------------
<check-mark label="Success" /> | [Standard behavior][success-after-post]. | [Standard behavior][success-after-post]; address available under the `address` property in the response object.
<x-mark label="Failure" /> | [Standard behavior][failure-during-post]; additional `address` variable will be passed to the resulting template. | [Standard behavior][failure-during-post]; additional `address` property will be available in the response object.

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/delete-address`

Deletes an address owned by the current user or another user they can edit.

#### Supported Params

Param | Description
----- | -----------
`addressId` | An existing address ID, owned by the current user or a user they’re allowed to edit.

#### Response

<span class="croker-table">

State | `text/html` | `application/json`
----- | ----------- | ------------------
<check-mark label="Success" /> | [Standard behavior][success-after-post]. | [Standard behavior][success-after-post]; additional `address` property will be available in the response object.
<x-mark label="Failure" /> | [Standard behavior][failure-during-post]. | [Standard behavior][failure-during-post].

</span>


### <badge vertical="baseline" type="verb">GET</badge> `users/session-info`

Retrieves information about the current session. Data is returned as JSON, and is only intended for consumption via [Ajax](../development/forms.md#ajax).

#### Response

Only JSON responses are sent, but its content will differ for guests and logged-in users.

<span class="croker-table">

State | `application/json`
----- | ------------------
<check-mark label="Success" /> | [Standard behavior][success-after-post]; response object will contain at least `isGuest` and `timeout` keys, plus a `csrfTokenName` and `csrfTokenValue` (when CSRF protection is enabled), and the current user’s `id`, `uid`, `username`, and `email` (if logged in).
<x-mark label="Failure" /> | [Standard behavior][failure-during-post].

</span>

### <badge vertical="baseline" type="verb">GET</badge> `app/health-check`

A “[no-op](https://en.wikipedia.org/wiki/NOP_(code))” action provided for automated monitoring.

#### Response

The response will be successful (but empty) in all but “exceptional” situations, like an issue connecting to the database. Read more about [the criteria](kb:configuring-load-balanced-environments#health-check-endpoint) for a successful health check.

<span class="croker-table">

State | Any
----- | ---
<check-mark/> | An empty document with a 200 status code.
<x-mark/> | 400- or 500-level status, with an error message or stack trace (in `devMode`, or when the current user has enabled the “show full exception views” preference enabled).

</span>

## Plugins + Custom Actions

Many plugins expose functionality via their own controllers and actions. Their accepted parameters and response types are entirely up to the author, but the [fundamentals](../development/forms.md#making-requests) will be the same. Consult the appropriate documentation for specifics!

Here are some examples in our own plugins:

- [Commerce](https://plugins.craftcms.com/commerce): A variety of cart management capabilities are provided for users and guests.
- [Contact Form](https://plugins.craftcms.com/contact-form): Adds the `contact-form/send` action for processing submissions and delivering notifications.
- [Element API](https://plugins.craftcms.com/element-api): Customizable routes get mapped to queries, and return JSON representations of elements.

Custom modules can also provide actions via a [Controller](../extend/controllers.md).

[success-after-post]: ../development/forms.md#after-a-post-request
[success-after-get]: ../development/forms.md#after-a-get-request
[failure-during-post]: ../development/forms.md#during-a-post-request
[failure-during-get]: ../development/forms.md#during-a-get-request
</file>

<file path="reference/README.md">
# Reference

This section contains technical details for built-in Craft components like [element types](element-types/), [field types](field-types/), and the [Twig environment](twig/). It is intended primarily for developers charged with building or maintaining a Craft project who need frequent access to code-specific features.

[Element Types](element-types/README.md) &rarr;
:   Deep-dives on each of Craft’s built-in [element types](../system/elements.md).

[Field Types](field-types/README.md) &rarr;
:   Discover Craft’s built-in [field types](../system/fields.md).

[Configuration](config/README.md) &rarr;
:   Descriptions for every [general](config/general.md) and [database](config/db.md) config setting, as well as help with [application config](config/app.md).

[Twig](twig/README.md) &rarr;
:   Lists of filters, functions, tags, tests, and variables that Craft provides to the [Twig templating environment](../development/twig.md).

[Controller Actions](controller-actions.md) &rarr;
:   Common HTTP endpoints for use with [forms](../development/forms.md).

[Command-Line Interface](cli.md) &rarr;
:   Special back-office features available via the command line.

## Additional Resources

<See url="https://github.com/craftcms/cms" label="Craft CMS Source" description="Browse Craft’s source code, releases, issues, and discussions on GitHub." />

<See url="https://docs.craftcms.com/api/v5" label="Class Reference" description="Auto-generated class reference for Craft CMS 5.x." />
</file>

<file path="system/cli.md">
---
description: Many of Craft’s powerful content and administrative tools are also available via the command-line.
---

# Command-Line Interface

<Todo notes="Move usage info out of console commands page, leaving in place only controller reference sections." />

Craft’s [HTTP API](../development/forms.md) is complemented by its command-line interface or _CLI_, which exposes powerful back-office tools to your terminal. Both means of accessing Craft’s features are part of a broader [controller-action architecture](guide:structure-controllers).

This can be useful for automating tasks with `cron`, running actions in a [deployment process](kb:deployment-best-practices), working with Craft via SSH, and running resource-intensive tasks that might otherwise be constrained by the limits of your web server. If you installed Craft using our [quick-start guide](../install.md), you’ve already used the CLI!

The Craft CLI executable typically lives at the root of your project (as [a file named `craft`](directory-structure.md#craft)) and requires a compatible PHP installation to run. You can view a [list of available commands](../reference/cli.md) in the **Reference** section.

::: tip
The version of PHP that handles HTTP requests may not be the same as the one that is available directly in your terminal.

Some development environments or hosting platforms have specific tools for running console commands—for example, DDEV has a special `ddev craft …` command that automatically attaches to the appropriate container before running a command. In this case, you would use `ddev craft` instead of `php craft`.
:::

Running `php craft` without any arguments will output a complete list of available options.

```
$ php craft

This is Yii version 2.0.36.

The following commands are available:

- db                                    Performs database operations.
    db/backup                           Creates a new database backup.
    db/convert-charset                  Converts tables’ character sets and collations. (MySQL only)
    db/restore                          Restores a database backup.

- cache                                 Allows you to flush cache.
    cache/flush                         Flushes given cache components.
    cache/flush-all                     Flushes all caches registered in the system.
    cache/flush-schema                  Clears DB schema cache for a given connection
                                        component.
    cache/index (default)               Lists the caches that can be flushed.

...

To see the help of each command, enter:

  craft help <command-name>
```

You can also run `php craft help <command-name>` to learn more about a command and whatever parameters and options it may accept.

<See path="../reference/cli.md" label="Console Commands Reference" description="Explore Craft’s CLI API" />

::: tip
See the [Console Commands](../extend/commands.md) page in the _Extending Craft_ section to learn about adding your own console commands.
:::
</file>

<file path="system/control-panel.md">
---
sidebarDepth: 2
---

# Control Panel

The control panel is one of Craft’s greatest strengths. Developers and content authors appreciate its smart design and powerful feature set:

- Locate and edit content quickly and confidently;
- Design a schema that makes sense for your site or application;
- Customize views into deep and complex data;
- Invite users and work collaboratively;
- Find, install, and configure first- and third-party plugins;

We are working to make these features available to _everyone_ as part of our established [accessibility remediation process](https://craftcms.com/accessibility/accessibility-conformance-report).

<BrowserShot url="https://my-craft-project.ddev.site/admin" :link="false" caption="The Craft control panel viewed in a fresh installation.">
<img src="../images/control-panel-dashboard.png" alt="Craft dashboard">
</BrowserShot>

::: tip
If this is your first time using Craft, it might feel a little bit empty—don’t worry, that’s by design! Craft doesn’t impose a content model on your site, so you won’t see any default features like posts or pages—instead, you’re given tools to create the features you do need from agnostic [element types](./elements.md) and other [settings](#settings).
:::

## Tour

The appearance and organization of the control panel can differ based on what types of content you’ve set up, your permissions, user preferences, and the environment—but the general structure will always be the same.

Craft also has multiple [editions](../editions.md), some of which give you access to additional control panel features.

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/entries/exhibits/38"
    id="tour"
    :poi="{
        navigation: [13, 10],
        globalHeader: [60, 3],
        header: [40, 11],
        content: [55, 40],
        details: [79, 21],
    }"
    :link="false"
    caption="An entry edit screen in the control panel.">
<img src="../images/control-panel-tour-screen.png" alt="A representative screen from the Craft control panel">
</BrowserShot>

Let’s take a quick spin around a typical control panel _screen_:
- On the left edge is the _main navigation_ <Poi label="1" target="tour" id="navigation" />. At the top of this bar, your system name and icon are displayed. Below, each [main section](#main-sections) of the control panel you have access to is linked, and the current one is highlighted. Click the **Toggle sidebar** button to collapse it and make more room for the page content.
- At the top, the _global header_ <Poi label="2" target="tour" id="globalHeader" /> contains breadcrumbs (when working with nested content or settings), actions for the current screen, and the user menu.
- The current screen’s _main container_ takes up the remainder of the horizontal space, and will scroll if the content is tall enough. Within this region, you’ll find some combination of the following features:
    - A _header_ <Poi label="3" target="tour" id="header" />, displaying a title and controls for the current screen;
    - A _sub-menu_ at the left edge (not pictured), listing siblings of the current screen;
    - A _content container_ <Poi label="4" target="tour" id="content" /> for the screen’s primary content (usually set off from the background on a lighter color);
    - _Tabs_, splitting the screen’s content or settings into logical groups (not pictured);
    - A _details_ <Poi label="5" target="tour" id="details" /> pane at the right edge, with metadata and controls specific to the type of content being viewed;

You will see these same page components crop up in other screens—and even in [slideouts](#slideouts)!

#### Main Sections

You may not see (or need) all these sections in your _main navigation_. They’ll appear only when Craft determines that they’ll be useful to the logged-in user—for example, _Categories_ is hidden until you’ve configured at least one [Category Group](../reference/element-types/categories.md#category-groups).

Section | Description
------- | -----------
[Dashboard](#dashboard) | Customizable landing page.
[Assets](../reference/element-types/assets.md) | Create and edit asset elements.
[Entries](../reference/element-types/entries.md) | Create and edit entry elements.
[Categories](../reference/element-types/categories.md) | Create and edit category elements.
[Globals](../reference/element-types/globals.md) | Edit content in global sets.
[Users](../reference/element-types/users.md) | <Badge type="edition" vertical="middle" title="Available in Craft Team">Team</Badge><Badge type="edition" vertical="middle" title="Available in Craft Pro">Pro</Badge> View and moderate users.
[GraphQL](../development/graphql.md) | Configure GraphQL schemas, create tokens, and access the built-in playground.
[Utilities](#utilities) | Get system info and perform a variety of upkeep actions.
[Settings](#settings) | Configure Craft’s system settings and content model.
[Plugin Store](#plugin-store) | Browse, install, and purchase Craft and plugin licenses from the official Plugin Store.
…and more! | Some plugins provide their own control panel screens; others may only have a pane in the [Settings](#settings) section.

#### Announcements

Keep an eye on the _global header_ for a <Icon kind="gift" /> gift icon—Craft and any installed plugins may send notifications about new features to all control panel users, when updates are applied.

### Dashboard

After logging in, control panel users are directed to their **dashboard**. Each user manages their own dashboard, which is comprised of _widgets_. Craft comes with a few widgets:

- **Support:** Get official support from the Craft team.
- **Feed:** Scrape an external RSS feed.
- **Drafts:** Viewing your unpublished entry drafts.
- **New Users:** Visualize new registrations.
- **Quick Post:** Provide a simplified [entry](../reference/element-types/entries.md) form for publishing new content with one click.
- **Recent Entries:** Display a list of recently-posted entries from one or more sections.
- **Updates:** Keep tabs on Craft and plugin updates.

Widgets can be rearranged, resized, and customized based on the user’s needs, and will be available to them wherever they log in.

::: tip
Plugins can [register their own widgets](../extend/widget-types.md)!
:::

### Utilities

Utilities expose bundles of miscellaneous functionality to users with the correct permissions.

All Craft installations will include these utilities:

- **Updates:** View Craft and plugin updates, and apply them (when <config5:allowAdminChanges> is on).
- **System Report:** Get information about the Craft installation and server.
- **Project Config:** View the state of [Project Config](project-config.md).
- **PHP Info:** Additional information about your server’s PHP installation.
- **System Messages:** Customize email messages that are sent by the system.
- **Asset Indexes:** Rebuild an [asset](../reference/element-types/assets.md) volume from its underlying storage medium.
- **Queue Manager:** Audit running and queued background jobs.
- **Caches:** Flush caches for various parts of the Craft application.
- **Deprecation Warnings:** View or clear deprecation warnings generated by templates and plugins.
- **Database Backup:** Capture and download a backup of Craft’s primary database.
- **Find and Replace:** Search for (and replace) a string across all element content.
- **Migrations:** View (and apply) pending migrations, or view a history of all previously-run content migrations.

Plugins can [register utilities](../extend/utilities.md), and Craft will give each one a corresponding permission.

::: danger
Access to utilities should be granted only to trusted users, especially the innocuous _System Messages_ pane. Messages can include arbitrary Twig code, which effectively gives the author access to the entire Craft API—including the ability to modify their own permissions.

Keep in mind that any user marked as an “Admin” implicitly has access to _all_ utilities.
:::

#### Disabling Utilities

You can disable a utility for all users with the [`disabledUtilities` config setting](config5:disabledUtilities). Refer to each [utility class](repo:craftcms/cms/tree/main/src/utilities)’s `id()` method for their handles—including those provided by plugins.

### Settings

The **Settings** screen is where you’ll configure the system and design your content model. Settings complement [configuration](../configure.md) are typically stored in [Project Config](project-config.md) so that you can easily deploy them to other environments.

::: tip
Don’t see **Settings** in the main navigation? Make sure you have admin privileges, and that <config5:allowAdminChanges> is enabled. In Craft 5.6 and later, administrators always have access to settings in [read-only mode](#read-only-mode).

We recommend that this is enabled [only in development environments](../deploy.md#admin-changes).
:::

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/settings"
    :link="false"
    caption="The settings screen in Craft Pro. Some tiles may only be available in paid editions of Craft."
    id="settings"
    :poi="{
        system: [80, 24],
        content: [80, 46],
        media: [80, 68],
    }">
<img src="../images/control-panel-settings.png" alt="Craft settings screen">
</BrowserShot>

#### System <Poi label="1" target="settings" id="system" />

System settings govern low-level Craft behaviors that often influence how other content and media features are used.

Group | Description
----- | -----------
**General** | Turn your site on or off, set a timezone, and configure the login page and site icons.
**Sites** | Define [Sites and Site Groups](sites.md) to organize and localize your content.
**Routes** | Manage [dynamic routes](routing.md#dynamic-routes).
**Users** | Set [registration policies](user-management.md#public-registration), define your [permissions structure](user-management.md#permissions) with [user groups](user-management.md#user-groups), and add [custom fields](fields.md) to users.
**Addresses** | Set up the field layout used by [address](../reference/element-types/addresses.md) elements.
**Email** | Configure how Craft sends [email](mail.md).
**Plugins** | Manage available [plugins](plugins.md).

#### Content <Poi label="2" target="settings" id="content" />

Combined with [sites](sites.md), the **Content** section is where you design your schema.

Group | Description
----- | -----------
**Sections** | Manage entry [sections](../reference/element-types/entries.md#sections).
**Entry types** | Manage entry [types](../reference/element-types/entries.md#entry-types), used by sections and Matrix fields.
**Fields** | Create and organize [custom fields](fields.md) available to your elements.
**Globals** | Configure [globals](../reference/element-types/globals.md).
**Categories** | Define complex taxonomies with [category groups](../reference/element-types/categories.md#category-groups).
**Tags** | Define simple taxonomies with [tag groups](../reference/element-types/tags.md#tag-groups).

#### Media <Poi label="3" target="settings" id="media" />

Decide how you want to store and organize uploaded files.

Group | Description
----- | -----------
**Assets** | Create volumes for organizing [assets](../reference/element-types/assets.md) and attach them to filesystems, and configure [image transforms](../reference/element-types/assets.md#image-transforms).
**Filesystems** | Set up local or remote storage for an [asset volume](../reference/element-types/assets.md#filesystems).

#### Plugins

Additional tiles may appear in a fourth group, after installing [plugins](plugins.md). Plugin settings are also accessible via the <Journey path="Settings, Plugins" /> screen.

#### Read-Only Mode <Since ver="5.6.0" feature="Read-only settings screens" />

[Administrators](user-management.md#admin-accounts) can always _view_ settings. A banner appears at the top of each settings screen, and inputs and controls are simplified or disabled:

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/settings"
    :link="false"
    caption="The settings screen in read-only mode">
<img src="../images/control-panel-settings-read-only.png" alt="Craft settings screen in read-only mode">
</BrowserShot>

### Plugin Store

The control panel provides an easy way to browse the [Plugin Store](plugins.md#the-plugin-store) and try or buy plugins with one click. Plugins can only be installed when [admin changes](config5:allowAdminChanges) are allowed.

## Tips + Tricks

The control panel has some cool tricks up its sleeve.

### Slideouts

Slideouts are used in a number of situations to simplify or contextualize an editing experience.

Any time you see an [element chip or card](elements.md#chips-cards) attached to a [relational field](relations.md) (or within a [Matrix](../reference/field-types/matrix.md) field), or in an [index](elements.md#indexes), you can double-click it to summon a _slideout_.

<BrowserShot url="https://my-craft-project.ddev.site/admin/entries/habitats/1234-eagle-canyon" :link="false" caption="Slideouts can also be opened from other slideouts! In this example, double-clicking “Canopy Carnivores” opened the current one; double-clicking “Bald Eagle” would open another; and so on.">
<img src="../images/control-panel-slideouts.png" alt="A slideout opened from an attached entry">
</BrowserShot>

Slideouts also work for creating new elements on-the-fly from an [element browser](elements.md#modals-contexts).

::: tip
There is one exception, here: slideouts cannot be opened if the user doesn’t have [permission](user-management.md#permissions) to edit the element—even if they were able to select it from a relational field.
:::

While slideouts support most element edit screen features, you may find that it’s more comfortable to open it in a new window—just click the icon in the upper-right corner, or use the [action menu](#action-menus). Features you’d normally find in the sidebar have been tucked into a secondary panel for slideouts; this can be toggled with the button next to the pop-out link.

### Action Menus

Wherever you see a small button with three dots (<Icon kind="ellipses" />) on a chip, card, or page header, it opens an _action menu_. These menus are typically divided into two or more sections, with one dedicated to “destructive” actions like deletion or removal.

![A Matrix block’s action menu](../images/matrix-block-action-menu.png)

Each [element type](elements.md#element-types) provides its own set of actions—some of which may be dependent on the current user’s [permissions](user-management.md#permissions), or the characteristics of the individual element (like what entry type it is, which section it belongs to, or what asset filesystem it uses).

### Keyboard Shortcuts

#### Saving

Any time you are on a screen (or slideout) that represents a single editable record or form, <kbd>Command</kbd>+<kbd>S</kbd> will save it and keep you on the page. In most places the save shortcut is supported, <kbd>Command</kbd>+<kbd>Shift</kbd>+<kbd>S</kbd> will save the current record and set you up to create another.

::: tip
Always check “combo-box” menus (the fly-out arrow next to a red button) for more shortcuts!
:::

#### Group Selections

Throughout the control panel, you will find groups of checkboxes or other focusable controls in a list of items. Ticking one checkbox, then holding <kbd>Shift</kbd> and clicking a second one will tick all the intermediate ones, as well. Element indexes are a great place to try this out—but it will also work on nested entries within [Matrix](../reference/field-types/matrix.md) fields.

### Drag-and-Drop

The <Icon kind="move" /> move icon indicates that something can be dragged into a new position—like an element in a [structure](elements.md#structures) or relational field, a nested entry in a [Matrix field](../reference/field-types/matrix.md), or a [table row](../reference/field-types/table.md).

In some situations, dragging can be combined with [group selections](#group-selections)!

### Search

Craft has a powerful [search](searching.md) system that complements the [condition builder](elements.md#filters-and-columns) on every element index.
</file>

<file path="system/directory-structure.md">
# Directory Structure

A fresh Craft installation will have the following [folders](#folders) and [files](#files) in it. Existing projects may have [additional files](#other-common-files) in the root.

You don’t need to be familiar with everything in the working directory to get started with Craft, but it is a great way to discover tools and configuration that will help you work more efficiently, down the line.

## Customizing Paths

Craft’s default directory structure is intended to work for most projects and [hosting](../deploy.md) environments, but it is deeply customizable. Paths to many of the core files and folders can be changed by setting special [environment overrides](../configure.md#environment-overrides).

::: warning
Many of these directories’ locations are defined relative to Craft’s _base path_. Manually setting the [`CRAFT_BASE_PATH`](../reference/config/bootstrap.md#craft_base_path) environment override without making the corresponding adjustments to the rest of your project’s structure (or explicitly setting other paths) can lead to a non-functional installation.
:::

## Folders

### `config/`

Purpose
: Holds all of your project’s static [configuration](../configure.md#where-configuration-happens) files, as well as its `license.key` file. Your [`.env` file](#env), however, is typically located in the project root!

Configuration
: [`CRAFT_CONFIG_PATH`](../reference/config/bootstrap.md#craft-config-path)

### `storage/`

Purpose
: This is where Craft stores a variety of files that are dynamically generated at runtime.

  Some of the folders you might find in the storage directory include:

  - `backups/` — Stores database backups that get created when you update Craft, or capture a backup via the control panel utility or [CLI](../reference/cli.md#db-backup).
  - `logs/` — Stores Craft’s [logs](logging.md) and PHP error logs.
  - `rebrand/` — Stores the custom Login Page Logo and Site Icon files, if you’ve uploaded them. <badge type="edition" vertical="middle" title="Craft Pro only">Pro</badge>
  - `runtime/` — Pretty much everything in here is there for caching and logging purposes. Nothing that Craft couldn’t live without, if the folder happened to get deleted.

  For the curious, here are the types of things you will find in `storage/runtime/` (though this is not a comprehensive list):

  - `assets/` — Stores temporary uploads, image thumbnails, resized file icons, image editor scratch files, and copies of images stored on remote asset volumes (to save Craft an HTTP request when it needs the images to generate new thumbnails or transforms).
  - `cache/` — Stores arbitrary data caches, when using the [`FileCache` driver](../reference/config/app.md#cache).
  - `compiled_classes/` — Stores some dynamically-defined PHP classes.
  - `compiled_templates/` — Stores compiled Twig templates. This is _not_ your main [templates](#templates) folder!
  - `temp/` — Other temporary files. The names and contents of files in here do not obey any convention—the assumption should be that they will be deleted or overwritten between requests.

Configuration
: [`CRAFT_STORAGE_PATH`](../reference/config/bootstrap.md#craft-storage-path) — This is useful when running on systems with an [ephemeral](../reference/config/bootstrap.md#craft-ephemeral) or “read-only” filesystem (wherein the only place to write temporary files is a central `/tmp` directory).

### `templates/`

Purpose
: Your front-end Twig templates go in here. Any local site assets, such as images, CSS, and JS that should be statically served, should live in the [web/](directory-structure.md#web) folder. The [Routing](routing.md) page has an overview of how files in this folder are handled.

Configuration
: [`CRAFT_TEMPLATES_PATH`](../reference/config/bootstrap.md#craft-templates-path) — Plugins may register additional _template roots_ that behave similarly, but are not affected by this setting and generally do not contain user-editable templates.

### `vendor/`

Purpose
: This is where all of your Composer dependencies go—including Craft and any plugins you’ve installed. This directory should _not_ be tracked in version control. Instead, commit [`composer.lock`](#composerlock), and use [`composer install`](https://getcomposer.org/doc/03-cli.md#install-i) to rebuild it.

Configuration
: [`CRAFT_VENDOR_PATH`](../reference/config/bootstrap.md#craft-vendor-path) — If you choose to relocate your `vendor/` directory, make sure you update your `.gitignore` file to continue excluding it from version control.

### `web/`

Purpose
: This directory represents your server’s web root. The public `index.php` file lives here, alongside your static images, stylesheets, and JavaScript files.

  You can generate a URL to a file in this folder with Twig’s [`siteUrl()` function](../reference/twig/functions.md#siteurl).

Customization
: [`CRAFT_WEB_ROOT`](../reference/config/bootstrap.md#craft-web-root) — This is primarily used to set the [`@webroot` alias](../configure.md#aliases).

## Files

### `.env`

Purpose
: This is your [PHP dotenv](https://github.com/vlucas/phpdotenv) `.env` configuration file. It defines sensitive or [environment-specific config](../configure.md#env) values that don’t make sense to commit to version control.

  The [starter project](repo:craftcms/craft) provides a few examples of configuration that is apt to change between environments—you’ll see a group of similarly-named files, like `.env.example.staging`.

  These are `.env` file templates. Maintain one of them (with sensitive data removed) as a starting point for your actual `.env` file, so collaborators know what variables the project requires. When they set up the project, they can run `cp .env.example .env` to duplicate the file and fill out missing keys!

Configuration
: [`CRAFT_DOTENV_PATH`](../reference/config/bootstrap.md#craft-dotenv-path) — This setting _was_ technically available in prior versions, but unreliable.

### `.gitignore`

This file tells Git which files it should exclude when committing changes. At minimum, it should contain entries for `.env` and Composer’s `vendor/` directory.

Check out our [Hosting & Deployment](../deploy.md#be-aware-of-artifacts) article for a list of other things you’ll want to exclude.

### `bootstrap.php`

The [starter project](repo:craftcms/craft) consolidates important bootstrapping logic (like defining path [constants](../configure.md#bootstrap-config) that determine the above directories’ locations, and loading environment variables from a [`.env`](#env) file) into this file. Both the HTTP and console entry scripts (`web/index.php` and [`craft`](#craft), respectively) include this file—but each goes on to instantiate a different [type of application](guide:structure-entry-scripts) suited for that request context.

This file’s location only matters to your entry scripts, so it is not “configurable” like other paths are. If you make changes to the layout of your project directory, be sure and update the references to `bootstrap.php` in `index.php` and the CLI entry point.

### `composer.json`

Your project’s PHP dependencies are declared in this file. If you just started your project, the only two packages it will explicitly require are `craftcms/cms` (Craft’s core) and `vlucas/phpdotenv` (used in the entry scripts). Existing projects may contain more packages—say, if the it relies on Craft [plugins](plugins.md) or includes other [custom functionality](../extend/README.md).

Craft uses Composer to update itself and install plugins. See the [Composer documentation](https://getcomposer.org/doc/04-schema.md) for details on how this file works.

### `composer.lock`

This is a Composer-managed file that contains the _exact_ list of packages (and their versions) that should be installed in the `vendor/` directory. It should be committed to version control so that anyone working on the project can run `composer install` to download all its dependencies.

### `craft`

This is a command line executable used to run Craft’s [console commands](../reference/cli.md). Its structure is similar to `web/index.php` (insofar as it is responsible for bootstrapping Craft), but instead of a <craft5:craft\web\Application>, it creates a <craft5:craft\console\Application> and handles the “request” with a different set of controllers.

## Other Common Files

Depending on the age and structure of your Craft project (as well as the tools used to build it), your project directory may look a little bit different! Here are some examples of common things you might find when inheriting a project:

### `.ddev/`

If you (or another maintainer) followed the [installation](../install.md) instructions or [Getting Started Tutorial](/getting-started-tutorial/README.md), DDEV will have left a `.ddev/` directory in the root of your project. This is safe to keep in version control—DDEV may make changes to it from time to time, but a separate `.gitignore` file exists within it to ensure only necessary files are tracked.

### `migrations/`

Projects that use [content migrations](../extend/migrations.md) will typically use this directory, but it is customizable with the [`CRAFT_CONTENT_MIGRATIONS_PATH`](../reference/config/bootstrap.md#craft-content-migrations-path) variable.

### `modules/`

For a time, our [starter project](repo:craftcms/craft) came with a pre-initialized [custom module](../extend/module-guide.md) in the `modules/` directory. This is typically harmless, but it cannot be removed without also modifying your project’s `config/app.php` file.

### `public/`

Older projects may have carried over a Craft 2 convention of naming their public web directory `public/`. There is no functional difference between these folder names, but most Craft resources will refer to it as `web/`.

### `tests/`

When using tests to validate application changes, you are apt to have a dedicated `tests/` directory.

::: warning
Documentation for automated testing of Craft 5 has not been published. The [Craft 4 testing](/4.x/testing/README.md) documentation is still available!
:::

### `translations/`

Multi-site projects often make use of [static translations](sites.md#static-message-translations), which are stored in this directory, indexed by their language code. Customize this location with the [`CRAFT_TRANSLATIONS_PATH`](../reference/config/bootstrap.md#craft-translations-path) variable.

### `package.json`

Projects that use Node.js will typically contain `package.json` and `package-lock.json` files, as well as a `node_modules/` directory. Craft does not interact with these files, but they often contain information about how the front-end of your site works.

Oftentimes, a Node.js “build step” will output files that are then loaded by a user’s browser—those should be written to the web root so they can be directly requested via HTTP.

### `craft.bat`

A Windows-specific command line entry point or “batch file.”

### Docker Files

A `Dockerfile` or `docker-compose.yml` in your project root suggests that it is intended to be run in [Docker](https://www.docker.com/), a containerized development environment. DDEV users will typically _not_ see these files, as they’re abstracted by configuration stored in the [`.ddev/` directory](#ddev).

### IDE Configuration

Some editors write configuration to a file or folder within your project—for example, PhpStorm will create a `.idea/` directory; Visual Studio Code uses `.vscode/`. Coordinate with your team about which tools are valuable to your process, and commit anything that supports it.
</file>

<file path="system/drafts-revisions.md">
---
description: Propose and track changes to your content with powerful workflow tools.
---

# Drafts & Revisions

Craft supports a variety of publishing workflows through sophisticated permissions and version-tracking systems.

Drafts and revisions behave similarly to collaborative source code control, like git:

- Nondestructive changes can be [drafted](#drafts) (or “forked”) from the canonical version of an element;
- The draft is kept up-to-date by periodically [merging](#merging-changes) (or “rebasing”) upstream changes;
- A changeset is later applied (or “pulled”) into the canonical element;
- [Revisions](#revisions) capture the state of an element, over time (like a “commit”);

This same process is used, no matter the scale of an edit—even the smallest typo receives its own draft, so that authors can be confident they are publishing exactly what they want.

::: tip
Most of this page describes the draft and revisions systems in the context of [entries](../reference/element-types/entries.md), but other [element types](elements.md) (including those provided by plugins) provide support for some or all of the same features! One notable exception here is [assets](../reference/element-types/assets.md), due to their relationship with files, on-disk.
:::

## Drafts

_Drafts_ are used to capture changes that shouldn’t be immediately published to your site. They also power Craft’s live preview functionality, making changes extremely reliable to visualize.

Most elements begin their life as an _unsaved draft_. When you press a **New entry** button in the control panel, Craft quietly creates element with only the essential attributes (like section and entry type IDs), then redirects to its “edit” page. This means that there is always a place for Craft to [auto-save](#auto-saving) your input.

Unsaved drafts are typically short-lived. They don’t appear in element indexes, and are largely disposable. Once a user begins making changes to an unsaved draft, Craft assumes the element should remain accessible and it becomes a regular _draft_. Using the **Create entry** action from this state immediately makes the draft [live](#statuses-visibility) (so long as it [validates](#validation)). Leaving the page or selecting **Save draft** from the fly-out menu keeps the element in an unpublished state.

::: tip
Unsaved drafts are periodically purged during [garbage collection](gc.md) based on the <config5:purgeUnsavedDraftsDuration> setting.
:::

Special [permissions](user-management.md#permissions) control whether users can see, edit, and delete one another’s drafts.

### Provisional Drafts

A _provisional draft_ holds changes to a canonical, non-draft element—typically as part of an [auto-save](#auto-saving). Provisional drafts are only accessible to the user who created them, and that user will only ever have one provisional draft per element. When viewing an element in the control panel for which your user has an existing provisional draft, the “unsaved changes” banner is displayed:

![A provisional draft in the Craft control panel](../images/drafts-revisions-provisional.png)

Changes in a provisional draft are applied to the canonical entry by pressing **Save**, or deleted by pressing **Discard**. You may also convert changes to a saved draft by pressing **Create draft**.

You can identify elements with provisional drafts elsewhere in the system by their **Edited** badge.

### Auto-Saving

Any time you make a change to an element on its edit screen (or in a slideout), the modified fields and attributes are stored in a _derivative_ element. The _first_ edit to a canonical element triggers the creation of a provisional draft; _subsequent_ changes are then recorded on that draft.

Drafts that have been explicitly created (using the **Create a draft** button) also use the auto-save system. As derivative elements themselves, changes are saved directly against them—in other words, drafts don’t get their _own_ provisional drafts. On a draft edit screen, the **Save** button is mostly cosmetic; your work has likely already been auto-saved!

Whenever Craft is auto-saving an element, you’ll see a spinner in its toolbar. If something prevents changes from being saved, a caution icon will appear in its place, and you will be notified when attempting to navigate away from the page or close a slideout.

### Validation

Craft uses Yii’s [validation scenarios](guide:structure-models#scenarios) to determine which attributes and fields are validated at a given stage. As drafts, elements’ custom fields are typically _not_ validated, so that authors can progressively add content with the protection of auto-saving.

Once an author goes to publish or apply a draft, Craft will only validate the entry if it would be [enabled](#statuses-visibility).

::: tip
To avoid issues when rendering drafts in live preview, [templates](../development/templates.md) should guard against missing field data. When <config5:devMode> is _off_, Craft ignores some template errors—but in doing so, it may omit sections of problematic markup, causing disruptions to the structure or layout of the final document. Here’s an example of a resilient template:

```twig
{# Attempt to load the field’s value: #}
{% set topic = entry.primaryTopic.one() %}

{# Check if anything came back: #}
{% if topic %}
    <span class="topic-flag">{{ topic.title }}</span>
{% else %}
    {# Optional: Fallback output! #}
{% endif %}
```
:::

### Change Tracking

Fields that have been modified in a draft are recorded in the database and marked in the editor with a status badge. These fields’ values are protected against automatic [merging](#merging-changes) of changes from the canonical element.

### Merging Changes

When a draft is viewed in the control panel, Craft merges in any changes from the canonical element, retaining the draft’s edits. A notice is displayed in the metadata column whenever this happens.

### Saved Drafts

Each user is only allowed one _provisional_ draft per canonical element, but can create any number of _saved_ drafts. If you need to stash provisional changes, press the **Create a draft** button.

Use the **Edit draft settings** item in the action menu next to the **Save* button to give your draft a name. This helps you and any collaborators identify a draft by more than its number and creator. You can also add **Notes** to most elements, in the sidebar; these are copied into the [revision](#revisions) when the draft is eventually merged.

## Nested Elements

When you create a new nested element (within a [Matrix](../reference/field-types/matrix.md) or [CKEditor](plugin:ckeditor) field), it will always be owned by a draft; one will be created if the nested entry is the first change to a canonical element.

Nested entries are only returned by [element queries](../development/element-queries.md) once their _primary owner_ becomes the canonical element.

Nested entries are sometimes *not* drafts and *not* canonical. We carefully filter them out of normal results, but swap them in so that edits are visible in the control panel.

## Revisions

In the process of saving an element (or in technical terms, applying a [draft](#drafts) to a canonical element), Craft copies the canonical element into a derivative, called a _revision_. Support for revisions (and the number of revisions each element can have) depends on the element type and [configuration](config5:maxRevisions). 

Revisions ensure that edits to an element are both auditable and recoverable. An element’s revisions can be viewed via the menu in its breadcrumbs:

![The drafts + revisions menu among an entry’s breadcrumbs in the Craft control panel](../images/drafts-revisions-menu.png)

Selecting a revision takes you to a read-only version of the element’s edit screen, where you can **View** the previous state, or **Revert content from this revision**. If there are more than ten revisions for an element, a **View all revisions** button appears at the end of the menu, linking to a dedicated revisions browser. The “Current” revision displays the canonical element, or a provisional draft of it.

Restoring a revision copies its content (fields and attributes) into the canonical element.

::: warning
Unlike merging upstream changes into a draft, restoring a revision _does not_ take into consideration which fields and attributes were changed in that particular revision; the entire revision effectively becomes the canonical version. Changes in other drafts are not replaced, but the next time a draft is loaded, Craft will merge in any compatible non-conflicting “changes” from the canonical element.
:::

## Vocabulary

This list collects all the terms we’ve used to describe the state of an element.

Derivative
:   Opposite of _canonical_; the element was derived from another one, typically as a draft or revision.

Canonical
:   The primary element from which drafts and revisions are derived. Most [element queries](#querying) return these, by default.

Revision
:   A read-only derivative element that represents a canonical element’s prior state.

Draft
:   A special kind of derivative element whose changes can be applied to its canonical element.

Provisional Draft
:   A draft that hasn’t been explicitly saved.

Owner
:   Nested elements are always created in the context of an owner, and in most cases, a specific field. A nested element may have multiple owners; its “primary owner” can be a canonical element _or_ a draft.

## Statuses + Visibility

Several interrelated systems affect whether an element is accessible by users of your site, or by developers working with [element queries](#querying). For Craft to [route](routing.md) to an element, it must…

- …be **Enabled** globally, _and_ for the requested site;
- …be _canonical_;
- …_not_ be a draft (this sounds redundant, but unpublished drafts are technically both a draft _and_ a canonical element);
- …meet other element type-specific “status conditions” (like entries’ **Post Date** and **Expiry Date**);

Craft’s default behavior safeguards drafts and revisions from public view, and developers must explicitly expose them using [queries](#querying). Suppose you wanted to be transparent with an audience about edits to pages in a particular section:

```twig
<h1>{{ entry.title }}</h1>

{# ... #}

{% set edits = craft.entries()
  .revisionOf(entry)
  .with(['revisionCreator'])
  .all() %}

{% if edits is not empty %}
  <h3>History for {{ entry.title }}</h3>

  <ol>
    {% for edit in edits %}
      <li>{{ edit.dateUpdated|date('short') }} — {{ edit.revisionNotes }} ({{ edit.revisionCreator.fullName }})</li>
    {% endfor %}
  </ol>
{% endif %}
```

Unless otherwise specified, Craft returns revisions in the same sequence that is displayed in the control panel.

## Previews

[Entries](../reference/element-types/entries.md) belonging to sections can have any number of **Preview Targets**, each representing a location in the front-end where the entry might appear. Authors can use the **Preview** button when editing an entry to open the split “live preview” interface, or the **View** action to open a preview in a new window. Both show the same content, but—as the name suggests—_live_ preview refreshes any time a draft is auto-saved.

The URL of a preview includes a temporary `token` param that Craft validates before swapping in the unpublished entry. Tokenized preview URLs can be shared with anyone (even users without an account), and will reflect the state of the draft at the time it is accessed—but it will _not_ auto-refresh like a live preview does.

::: tip
The lifespan of preview tokens is determined by the <config5:previewTokenDuration> setting.
:::

## Querying

You can include drafts and revisions in [element queries](../development/element-queries.md) by using a handful of special parameters:

[`drafts()`](craft5:craft\elements\db\ElementQuery::drafts())
:   Returns only element drafts.

    ```twig
    {% set newsDrafts = craft.entries()
      .section('news')
      .drafts()
      .all() %}
    ```

[`draftOf($element)`](craft5:craft\elements\db\ElementQuery::draftOf())
:   Get drafts of a specific element.

    ```twig
    {% set proposedChanges = craft.entries()
      .draftsOf(entry)
      .all() %}
    ```

[`draftId($id)`](craft5:craft\elements\db\ElementQuery::draftId())
:   Find a specific draft by its ID. Draft IDs are distinct from element IDs!

    ```twig
    {% set specificDraft = craft.entries()
      .draftId(1234)
      .one() %}
    ```

[`draftCreator($user)`](craft5:craft\elements\db\ElementQuery::draftCreator())
:   Finds drafts by a specific user. The returned drafts may be from different canonical elements!

    ```twig
    {% set myNewsDrafts = craft.entries()
      .section('news')
      .draftCreator(currentUser)
      .all() %}
    ```

[`provisionalDrafts()`](craft5:craft\elements\db\ElementQuery::provisionalDrafts())
:   Returns only unsaved drafts.

    ```twig
    {% set proposedChanges = craft.entries()
      .section('news')
      .provisionalDrafts()
      .all() %}
    ```

[`withProvisionalDrafts()`](craft5:craft\elements\db\ElementQuery::withProvisionalDrafts())
:   Any results in the query that have provisional drafts belonging to the current user are swapped out for those drafts. This has no effect for anonymous users.

    ```twig
    {% set posts = craft.entries()
      .section('news')
      .withProvisionalDrafts()
      .all() %}

    <ul>
      {% for post in posts %}
        <li>
          <strong>{{ post.title }}</strong>
          {% if post.isDraft %}
            <em>Showing your proposed changes</em>
            <a href="{{ post.getCpEditUrl() }}">Edit</a>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    ```

[`revisions()`](craft5:craft\elements\db\ElementQuery::revisions())
:   Returns only element revisions. To find revisions of a specific entry, use `.revisionOf()`.

    ```twig
    {% set changelog = craft.entries()
      .section('news')
      .revisions()
      .all() %}
    ```

[`revisionOf($element)`](craft5:craft\elements\db\ElementQuery::revisionOf())
:   Get revisions of a specific element.

    ```twig
    {% set editHistory = craft.entries()
      .section('news')
      .revisionOf(entry)
      .all() %}
    ```

[`revisionId($id)`](craft5:craft\elements\db\ElementQuery::revisionId())
:   Find a specific revision by its revision ID. Revision IDs are distinct from element IDs, and are typically only discovered by first querying for revisions of an element using `revisionOf()` (at which point you’ll already have the revision, anyway)!

    ```twig
    {% set specificRevision = craft.entries()
      .revisionId(5678)
      .one() %}
    ```

[`revisionCreator($user)`](craft5:craft\elements\db\ElementQuery::revisionCreator())
:   Finds element revisions by a specific user. The returned revisions may be from different canonical elements!

    ```twig
    {% set myChangelog = craft.entries()
      .section('news')
      .revisionCreator(currentUser)
      .all() %}
    ```

These query methods are apt to be most useful when building [authenticated front-end areas](user-management.md#logging-in), or in templates for the control panel (like with the **Template** [field layout UI element](fields.md#field-layout-elements)).
</file>

<file path="system/elements.md">
---
description: Explore Craft’s massively flexible atomic unit of content.
related:
  - uri: ../reference/element-types/addresses.md
    label: Address Elements
  - uri: ../reference/element-types/assets.md
    label: Asset Elements
  - uri: ../reference/element-types/categories.md
    label: Category Elements
  - uri: ../reference/element-types/entries.md
    label: Entry Elements
  - uri: ../reference/element-types/globals.md
    label: Global Set Elements
  - uri: ../reference/element-types/tags.md
    label: Tag Elements
  - uri: ../reference/element-types/users.md
    label: User Elements
  - uri: relations.md
    label: Working with Relationships
---

# Elements

An _element_ is the most basic unit of [content](#fields-and-content) in Craft. Elements provide smart management, routing, and querying interfaces for users and developers. Each [type](#element-types) of element has some unique capabilities, but they’re all built on top of a set of [common features](#common-features).

## Element Types

In the control panel, you’ll encounter the seven _element types_ common to all Craft installations:

- [**Addresses**](../reference/element-types/addresses.md) — Attach physical locations to other elements.
- [**Assets**](../reference/element-types/assets.md) — Upload files and store rich metadata.
- [**Categories**](../reference/element-types/categories.md) — Design hierarchical or ordered taxonomies.
- [**Entries**](../reference/element-types/entries.md) — Model anything with flexible and nestable content containers.
- [**Global Sets**](../reference/element-types/globals.md) — Manage universally-accessible data.
- [**Tags**](../reference/element-types/tags.md) — Grow a _folksonomy_ alongside your content.
- [**Users**](../reference/element-types/users.md) — Represent people with powerful identity and access tools.

Choosing the appropriate element type for your content model is essential—but don’t be afraid to mix, match, and combine them. Plugins (and custom modules) can provide [custom element types](../extend/element-types.md), giving developers and authors a consistent experience across all their content.

## Common Features

Some features are available to all (or most) element types:

- Control panel interfaces, including forms, [indexes](#indexes), [slide-outs](control-panel.md#slideouts), and [chips and cards](#chips-cards);
- [Custom fields](fields.md) and field layouts with advanced condition rules for storing [content](#fields-and-content);
- Slugs, URIs, URLs, and automatic [routing](routing.md);
- Localization via [sites](sites.md);
- [Drafts and revisions](drafts-revisions.md);
- Sophisticated [permissions](user-management.md#permissions);
- [Element queries](../development/element-queries.md) with advanced sorting and filtering capabilities;
- Bi-directional [relationships](relations.md);
- Automatic indexing for [search](searching.md);
- Statuses for managing visibility of content;

Other features are specific to a type—like Assets’ tie to files, or Entries’ nesting capability.

## Fields and Content

In a fresh installation, element types are distinguished only by a handful of native features. The identity and utility of an element is often defined by the [custom fields](fields.md) attached to it via a [field layout](fields.md#field-layouts): elements and their custom field values are collectively referred to as _content_.

Craft is adamantly agnostic about your content model, and comes with no predefined notion of what a “page” or “post” should be. Instead, it treats all your content as _data_, and provides the means to use it how you see fit—whether that’s as HTML accessible via public URLs, a private database, GraphQL for a decoupled or statically-generated front-end, or even a CSV to populate a printed document.

Content can be a great deal more than text, too! Craft has a number of built-in [field types](../reference/field-types/README.md) that provide a highly-customizable authoring and developer experience.

<See path="fields.md" />

## Indexes

You’ll access most elements via their element index. Indexes allow you to browse, sort, filter, and [search](searching.md) for elements in a paginated, table-like view.

::: tip
[Matrix fields](../reference/field-types/matrix.md) also have a compact element index **View Mode**.
:::

### Sources

Indexes are broken down into **sources**. Sources can be permanent fixtures of an element type (like the **Admin** source for [users](../reference/element-types/users.md)), dynamically added based on configuration (like those for user groups), or defined by an admin using custom _condition rules_.

Each source also controls what columns are visible in the index, and its default sorting.

<BrowserShot url="https://my-craft-project.ddev.site/categories/species" :link="false" caption="Customizing element sources.">
<img src="../images/element-index-customize-sources.png" alt="Customizing element sources">
</BrowserShot>

::: tip
Custom sources are stored in [Project Config](project-config.md). The interface for conditions that involve specific elements (like an author) may appear differently than the equivalent [filter](#filters-and-columns), because the ID may not be stable between environments.

Instead of an element select field, you’ll see an [autosuggest input](project-config.md#secrets-and-the-environment).
:::

### Filters and Columns

As a complement to [search](searching.md) and [custom sources](#sources), any user with access to an element index can temporarily filter results using the condition builder interface:

<BrowserShot url="https://my-craft-project.ddev.site/categories/species" :link="false" caption="Using the condition builder to narrow results.">
<img src="../images/element-index-condition-builder.png" alt="Craft’s condition builder">
</BrowserShot>

Similarly, they can customize which columns appear in the table (and how the results are ordered) with the **View** menu:

<BrowserShot url="https://my-craft-project.ddev.site/categories/species" :link="false">
<img src="../images/element-index-view-options.png" alt="Customizing element index columns and sorting">
</BrowserShot>

If every field layout that would be used by an element in a source defines the same label override for a field, that label will appear in the column’s header. When a consensus cannot be reached, the original field’s label is used. This most commonly applies when a source is limited to a single entry type, asset volume, category group, or other quality that also defines field layouts.

### Structures

[Entries](../reference/element-types/entries.md) in _Structure_ sections and [Categories](../reference/element-types/categories.md) support a hierarchical view mode on their indexes. Elements in structures track their relative position among siblings, and can be easily relocated by dragging-and-dropping <Icon kind="move" /> their row in an [element index](#indexes). Reordering is still possible, even when the structure is limited to a single level.

::: tip
Use the **View** controls to switch back into structure mode on an index if you had previously sorted it by another attribute.
:::

### Actions

Each element type supports its own set of _actions_ that can be performed on one or more elements, from an index. These actions are either visible directly in the index toolbar (like _Status_), or collected under the <Icon kind="action" /> icon in the footer (like _Delete_). Actions may be hidden or disabled when they don’t apply to the selection or [source](#sources).

### In-line Editing <Badge text="New!" />

Click **Edit** at the bottom of any element index to switch into an in-line editor. Click **Save** to update any rows that changed, or **Cancel** to return to the read-only mode.

Not all fields are editable in-line, and some may have simplified controls or interfaces. This is best used when the index’s default [columns](#filters-and-columns) include scalar values like text, numbers, and dates.

### Exporters

Craft can export sets of elements to CSV, JSON, or XML. The **Export…** button in the index footer displays all options, including any [custom exporters](../extend/element-exporter-types.md) registered by modules and plugins.

### Modals & Contexts

A streamlined version of indexes are used when adding elements to a [relational](relations.md) field via a modal. Depending on the field’s configuration, Craft may hide sources or actions, and disable [slideouts](control-panel.md#slideouts) (except to create a new element, in-context) and pagination (in favor of scrolling). Internally, Craft refers to these variations as “contexts,” which [plugins](../extend/element-types.md#sources) have an opportunity to modify.

## Chips & Cards <Badge text="New!" />

<img src="../images/element-chips.png" alt="An element “chip” with a title, thumbnail, and label indicated it has been modified." />

Throughout the control panel, you’ll encounter references to elements in a number of different contexts, like element indexes, [Matrix](../reference/field-types/matrix.md) fields, and other [relational](relations.md) fields. Element _cards_ are a new way to display nested or related elements. They share the core features of element _chips_ (like quick-actions and ordering controls), but provide an additional layer of customization via the element’s [field layout](fields.md#field-layouts).

Both chips and cards support thumbnails, but only cards allow additional custom field values to be bubbled up. The presence and order of those fields is dictated by a combination of the field layout and customizable [card attributes](#custom-card-attributes) <Since ver="5.5.0" feature="Customizable card attributes" />; additional features like colorization and icons are supported by [entries](../reference/element-types/entries.md).

<img src="../images/element-cards.png" alt="Two element “cards” in the Craft control panel, show thumbnails, titles, and statuses." />

### Custom Card Attributes <Since ver="5.5.0" feature="Customizable card attributes" />

The attributes and fields displayed on element cards is ultimately determined by the interface below each [field layout designer](fields.md#field-layouts):

<img src="../images/element-card-attributes.png" alt="Element card attribute customization interface." />

An element’s **Title** and **Status** are always visible, and the presence of a thumbnail is determined by the field layout itself (by selecting **Use for element thumbnails** in the field layout element’s <Icon kind="ellipses" /> action menu). Additional attributes _not_ present in the field layout can be enabled in the card customization interface; those that _are_ part of the field layout will indicate when they are enabled with an “eye” icon.

::: tip
A card’s thumbnail can come from any field that implements <craft5:craft\base\ThumbableFieldInterface> (like [assets](../reference/field-types/assets.md) or [icon](../reference/field-types/icon.md) fields), or be “inherited” from another element via a [relational field](relations.md).
:::

## Copying Elements <Since ver="5.7.0" feature="Copying elements" />

[Entries](../reference/element-types/entries.md) and [addresses](../reference/element-types/addresses.md) can by copied-and-pasted between sections and fields. Open the action menu <Icon kind="ellipses" /> on any chip, card, or inline nested entry and select **Copy <Placeholder help="A built-in or plugin-provided element type.">element type</Placeholder>**:

![Screenshot](../images/entries-copy-action.png)

From an element index, you can copy multiple elements by selecting any number of rows, then pressing **Copy** from the element actions menu <Icon kind="settings" /> in the bottom toolbar.

Only one group of elements can be copied at a time—copying another element or group of elements will replace whatever was previously copied. Craft will display a notification on every control panel screen, until you press **Cancel** (or paste it somewhere else).

![Screenshot](../images/entries-copy-notification.png)

When pasting an element, you will see a notification confirming the element has been “duplicated” into the new context.

You can paste elements anywhere the special **Paste** button appears. The eligible targets are determined by the type of copied element—addresses are portable between user address books and custom fields; entries can only be pasted into fields and sections that support the copied element’s entry type.

![Screenshot](../images/entries-copy-target.png)

The **Paste** button is displayed in the same row as the **Add** button for nested element interfaces; on an element index, it is displayed in the bottom toolbar, where the element action <Icon kind="settings" /> menu would be.

::: warning
A copied [draft](drafts-revisions.md) (provisional or otherwise) is pasted as a _canonical_ element, with the pending changes applied.
:::

## Statuses

Most element types support _statuses_. An element’s status is most often a combination of its `enabled` and `enabledForSite` attributes (which Craft stores explicitly for all elements), and any number of other attributes determined by its [type](#element-types). Statuses are represented as strings, and can be accessed via `element.status` in a template, or fed into element query’s `.status()` param as a short-hand for the combination of specific properties they represent.

- **Draft** (`draft`) — The element has a `draftId`.
- **Archived** (`archived`) — The element’s `archived` property is `true`; currently only used by [user](../reference/element-types/users.md) elements.
- **Disabled** (`disabled`) — One or both of the `enabled` and `enabledForSite` attributes are `false`.
- **Enabled** (`enabled`) — Both the `enabled` _and_ `enabledForSite` attributes are `true`.

::: tip
To query for elements without applying _any_ status constraints (including the element type’s defaults), use `query.status(null)`.
:::

An element’s status is reflected in element indexes, chips, and cards through color pips and labels.

![Sample element status badges](../images/elements-statuses.png)

<Block label="Provisional Drafts and Statuses">

In the illustration above, **Edited** is technically a supplemental label applied to [provisional drafts](drafts-revisions.md#provisional-drafts), and is not a status on its own—but it is often applied in combination with other statuses. Elements with this label have been “substituted” for their canonical counterparts, meaning that provisional changes (like a new title) will appear with a **Live** status.

Conversely, disabling an element in a provisional draft may make it _appear_ as **Disabled** throughout the control panel, despite its canonical element actually being **Live**. Despite this, sorting and filtering always operates on the canonical element; the derivative is substituted as the final step in the query.

</Block>

### Querying by Status

When querying for elements using the `.status()` param, you’ll need to refer to the list of global identifiers above, and to additional statuses provided by the specific element type:

```twig{3,9,15}
{% set currentDeals = craft.entries()
  .section('deals')
  .status('live')
  .order('postDate DESC')
  .all() %}

{% set upcomingDeals = craft.entries()
  .section('deals')
  .status('pending')
  .order('postDate ASC')
  .all() %}

{% set pastDeals = craft.entries()
  .section('deals')
  .status('expired')
  .order('expiryDate DESC')
  .all() %}
```

Statuses can be logically combined in a single query, as well:

```twig
{# Two explicit statuses: #}
{% set bannedUsers = craft.users()
  .status([
    'suspended',
    'locked',
  ])
  .all() %}

{# One explicit status: #}
{% set inactiveUsers = craft.users()
  .status('inactive')
  .all() %}

{# Negated/inverted status: #}
{% set inactiveUsersAlt = craft.users()
  .status(['not', 'active'])
  .all() %}
```

## Nested Elements <Badge text="New!" />

Craft ships with two native _nested element_ implementations, which provide unique authoring or administrative experiences:

- [**Entries**](../reference/element-types/entries.md) and the [**Matrix field**](../reference/field-types/matrix.md) — Create dynamic or repeatable content sections, or manage any kind of records that belong to a single owner.
- [**Addresses**](../reference/element-types/addresses.md) and the [**Address fields**](../reference/field-types/addresses.md) — Capture region-aware location information.

While [relationships](relations.md) are supported by every element type, only addresses and entries are eligible for nesting. Plugins may use the nested element interface to provide other functionality, like Commerce’s product and variant system.

<a name="rendering-elements"></a>

## Element Partials <Badge text="New!" />

Every element has a `render()` method, which you can call from a template to get an HTML representation of the object.

::: tip
The [CKEditor plugin](plugin:ckeditor) uses the `.render()` method to [convert each nested entry](repo:craftcms/ckeditor#rendering-nested-entries-on-the-front-end) from a placeholder to a rich, personalized block—while remaining exactly where the author placed it in the editor.

This is not the _only_ way to output your elements’ [content](#fields-and-content), though! Any time you have access to an element, you are free to use its attributes and field values, directly.
:::

Without any configuration, this will typically be the element’s _title_ (if the element type uses titles), or it’s element type and ID. This default behavior is handled by the element’s magic `__toString()` method, meaning `{{ element.render() }}` and `{{ element }}` are functionally equivalent.

However, the output of `element.render()` can be customized by placing a template in your <config5:partialTemplatesPath> that follows a specific naming convention. The full path to each element’s partial template is comprised of:

- The element’s type or `refHandle`: Typically its lower-cased, singular name—`entry` or `address`, for instance. The `refHandle` is the same as is used for [reference tags](reference-tags.md), elsewhere in the system.
- The field layout provider’s handle: Differs based on the type of element and how its field layout is configured. For assets, it would be the volume’s handle; for entries, its entry type handle; for global sets, the set handle.

As an example, if you wanted to customize the output of an asset in a volume with the handle `images`, you would create a template with this path:

```
_partials/asset/images.twig
```

For element types without a _field layout provider_ (like addresses and users)—or when a more specific template is not found—Craft falls back to just the `refHandle`. In the example above, if `_partials/assets/images.twig` doesn’t exist, `_partials/asset.twig` would also be checked. <Since ver="5.6.0" feature="Element partial template fallbacks for elements without field layout providers" />

If some property of the asset (like its extension, or the user group its uploader is in) should affect its template, you can put whatever logic you need into the template and render something different:

```twig
<figure>
  {{ asset.getImg() }}

  <figcaption>
    {{ asset.title }}

    {% if asset.uploader.can('accessCp') %}
      <a href="{{ asset.getCpEditUrl() }}">Edit</a>
    {% endif %}
  </figcaption>
</figure>
```

::: tip
You can also render lists of elements by calling the `render()` method on an [element query](../development/element-queries.md) or [element collection](../development/collections.md#element-collections).
:::

[Nested entries](../reference/element-types/entries.md#nested-entries) (like those in [Matrix](../reference/field-types/matrix.md) and [CKEditor](plugin:ckeditor) fields) include information about where they live in the system, via `owner` and `field` properties:

```twig
{# _partials/entry/ingredient.twig #}
{{ entry.title }}

{% if entry.field and entry.field.handle == 'nutritionHighlights' %}
  {{ entry.typicalCalories }}
{% endif %}
```

Because entries can be nested within fields on different element types (i.e. a CKEditor field on an entry or a Matrix field in a [global set](../reference/element-types/globals.md)), it’s important that your template consider discrepancies between properties on the owner. For instance, an entry that owns another entry will have a `type` property; a category that owns an entry has a `group` property. If an entry type is used both in a section _and_ as a nested entry, the `owner` and `field` properties will only be available in the latter context!

::: warning
Users and addresses don’t have field layout providers, and therefore do not support element partials.
:::

### Parameters

Each partial is passed its element under a variable that agrees with its `refHandle`—same as would be passed to a template, when Craft matches an [element’s route](routing.md).

When manually rendering an element partial (by calling `element.render()` or `.render()` on an [element collection](../development/collections.md#element-collections)), you have an opportunity to make additional variables available to the template:

```twig
{{ recipe.ingredients.render({
  portionSize: currentUser.householdSize,
}) }}
```

Keep in mind that partials can be rendered from multiple contexts, not all of which will provide these extra variables. Guard against missing parameters with the `|default()` filter or null-coalesce operator (`??`):

```twig
{# _partials/entry/ingredient.twig #}
{% set portionSize = portionSize|default(1) %}

{{ entry.title }}: {{ entry.quantity * portionSize }} {{ entry.unit }}
```

### Eager-Loading

When accessing related or nested content within an element partial, use the `.eagerly()` method to [eager-load](../development/eager-loading.md#lazy-eager-loading) elements for other partials that might be rendered in sequence.

```twig{2}
{# _parials/entry/post.twig #}
{% set headerImage = entry.headerImage.eagerly().one() %}

{% if headerImage %}
  {{ headerImage.getImg() }}
{% endif %}

<h3>{{ entry.title }}</h3>

{# ... #}
```

## Properties and Methods

All elements share a few characteristics that make them familiar to work with in your [templates](../development/templates.md). Each [element type](#element-types) will supplement these lists with their own properties and methods.

Additionally, [custom fields](fields.md) attached to an element are automatically made available as properties corresponding to their handles—so a field called “Post Summary” with a handle of `summary` would be accessed as `entry.summary` (if it were attached to an [entry type](../reference/element-types/entries.md#entry-types)’s field layout, and its handle was not overridden).

::: warning
This is not an exhaustive list! If you’re curious, consult the <craft5:craft\base\Element> and <craft5:craft\base\ElementTrait> class reference for a complete picture of what data is available inside elements and how it can be used.
:::

### Properties

Properties give you access to values, and do not accept arguments.

Property | Type | Notes
--- | --- | ---
`archived` | `bool|null` | Whether the element is soft-deleted, or “trashed.”
`dateCreated` | `DateTime` | Date the element was originally created.
`dateDeleted` | `DateTime|null` | Date the element was soft-deleted or `null` if not.
`dateUpdated` | `DateTime` | Date the element was last updated.
`enabled` | `bool` | Whether the element is enabled (globally).
`id` | `int` | ID of the element.
`level` | `int|null` | Depth of the element in a structure. _Structures only._
`ownerId` | `int|null` | ID of the element that “owns” this element. _[Nested elements]() only._
`parentId` | `int|null` | ID of the parent element. _Structures only._
`searchScore` | `int` | Score relative to other results when returned from an [element query](../development/element-queries.md) using the [`search` param](searching.md).
`siteId` | `int` | ID of the <craft5:craft\models\Site> the element was loaded in.
`slug` | `string|null` | _Only for elements with slugs._
`title` | `string|null` | _Only for elements with titles._
`trashed` | `bool` | Whether or not the element has been soft-deleted.
`uid` | `string|null` | A UUIDv4 string that uniquely identifies this element.
`uri` | `string|null` | Rendered URI or path for the site the element was loaded in. _Only for elements with URLs._

### Methods

Methods also return values, but may accept or require arguments.

::: tip
Any method beginning with `get` (and that accepts no arguments) can be used like a [property](#properties) by removing the prefix and down-casing the first letter. For example, `{{ entry.getLink() }}` can also be used as `{{ entry.link }}` in a template. This is referred to as a “getter” or “magic getter,” and works in part due to the [design of Yii](guide:concept-properties), Craft’s underlying PHP library.
:::

Method | Notes
--- | ---
`getAncestors(dist)` | Returns up to `dist` parents of the element, or all parents when omitted. _Structures only._
`getChildren()` | Returns immediate children of the element. _Structures only._
`getCpEditUrl()` | Gets a URL to the Craft control panel.
`getDescendants(dist)` | Returns descendants of the element, down to `dist` levels below this one, or all descendants, when omitted. _Structures only._
`getEnabledForSite(siteId)` | Whether the element is enabled in the provided site, or the site it was loaded in if no ID is provided.
`getHasDescendants()` | Build an HTML anchor tag with its front-end URL and title. _Elements with URLs only._
`getLink()` | Build an HTML anchor tag with its front-end URL and title. _Elements with URLs only._
`getNext(criteria)` | Load the “next” element relative to this one, given a set of criteria.
`getNextSibling()` | Load the next sibling of this element, within a structure. _Structures only._
`getOwner()` | Return the element that “owns” a [nested element](../reference/element-types/entries.md#nested-entries). _Nested elements only._
`getParent()` | Returns the element’s parent. _Structure elements only._
`getPrev(criteria)` | Load the previous element relative to this one, given a set of criteria.
`getPrevSibling()` | Load the previous sibling of this element, within a structure. _Structures only._
`getRef()` | Builds the part of a [reference tag](reference-tags.md) unique to the element.
`getSiblings()` | Load siblings within the element’s structure. _Structures only._
`getSite()` | Returns the <craft5:craft\models\Site> the element was loaded for.
`getStatus()` | Returns a plain-text representation of the element’s status, which may be synthesized from a number of other attributes.
`getUrl()` | Builds a complete front-end URL based on the element’s URI.

The full list of element properties and methods can be found in the [`craft\base\Element` class reference](craft5:craft\base\Element), or [individual element types](../reference/element-types/README.md).
</file>

<file path="system/fields.md">
---
description: Craft’s powerful content features are driven by custom fields.
related:
  - uri: elements.md
    label: Learn about Elements
sidebarDepth: 2
---

# Custom Fields

On their own, [elements](elements.md) only provide a scaffold for your content—most of the content itself will be stored in *fields*.

Fields are managed in <Journey path="Settings, Fields" />, and can be created on-the-fly from a [field layout](#field-layouts) designer. Field layouts and [conditions](#conditions) determine where and when your fields should appear for content authors.

## Field Types

Choosing a field type determines what the field’s input UI is going to look like, how it stores data, how you’ll use that data in [templates](../development/templates.md), and the ways that you can [query](../development/element-queries.md) against that data.

<See path="../reference/field-types/" />

## Field Settings

<BrowserShot
  url="https://my-project.tld/admin/settings/fields/new"
  :link="false"
  :max-height="500"
  caption="Creating a field in the Craft control panel.">
<img src="../images/fields-new.png" alt="Editing a field in the Craft control panel">
</BrowserShot>

Most field types share these core settings:

Name
:   The user-facing label for the field. This should identify the field reasonably well among other fields, and be descriptive enough for authors. _You can override this in a field layout._

Handle
:   A developer-facing identifier for the field, used to access or query by its value from code. _You can override this in a field layout._

Default Instructions
:   Text displayed to authors in the field layout. Basic Markdown formatting is supported. _You can override this in a field layout._

Translation Method
:   How Craft handles the field’s value for elements that exist in multiple [sites](sites.md). See [Translation Methods](#translation-methods) below for more information.

::: tip
A field’s _name_ and _instructions_ can be overridden when adding it to a [layout](#field-layouts).  When a field supports [multiple instances](#multi-instance-fields) per layout, you can also override its _handle_.
:::

### Handles

Craft will auto-generate a **Handle** as you enter a **Name**, but you can adjust it however you see fit.

::: warning
Some handles are reserved so that custom fields don’t collide with native element attributes.
:::

Handles are used when accessing field data from code:

```twig
<div class="summary">
  {# Display a plain text field: #}
  <p>{{ entry.summaryShort }}</p>
</div>
```

They’re also how you [query by a field’s value](../development/element-queries.md#querying-with-custom-fields):

```twig
{# Filter by the value of a lightswitch field: #}
{% set featuredPosts = craft.entries()
  .isFeatured(true)
  .all() %}
```

Refer to each field type’s documentation for information about what kinds of data it returns, and how to use it in your templates!

### Translation Methods

If you’re running a multi-site Craft installation, most of your fields will have a **Translation Method** setting.

Fields can have the following translation method:

- **Not translatable** – The field will have the same value across all sites.
- **Translate for each site** – The field can have a different value for each site.
- **Translate for each site group** – The field can have a different value for each site group.
- **Translate for each language** – The field can have a different value for each unique language associated with your sites.
- **Custom…** – The field can have different values based on a custom differentiator.

If you choose **Custom…**, a **Translation Key Format** setting will appear below, where you can define an [object template](object-templates.md) that determines how Craft copies the field’s value to other sites. When an element that uses the field is saved, Craft renders this template for each site the element exists in, and copies the value to any that produce the same key.

For example, if a field’s translation key format were `{site.handle[0:2]}`, then new field values would be copied over to any other sites where the first two characters of the site handle matches the first two characters of the original site’s handle. Looking at this from the opposite direction: any site that produces a _unique_ translation key for a field will have its value isolated from other sites.

If the translation key format returns an empty string (`''`), the field will not appear as translatable, and its value will not be copied to any other sites. A key format of `{section.handle == 'blog' ? site.handle : ''}`, for example, would display its field as translatable per-site from _only_ the `blog` section—in all other contexts, it would not be translatable.

::: tip
Keep in mind that fields can be assigned to multiple element types. Accessing invalid properties of the current element (like `section` on an [asset](../reference/element-types/assets.md)) may cause the key to end up blank (and therefore not translated).
:::

## Field Layouts

Everything in Craft that has content associated with it will expose a configurable _field layout_, to which you can add your fields:

- **[Entries](../reference/element-types/entries.md)** use the field layout defined by their entry type in **Settings** → **Entry Types** → [entry type name] → **Field Layout**.
- **[Global sets](../reference/element-types/globals.md)** each get their own field layout, defined in **Settings** → **Globals** → [global set name] → **Field Layout**.
- **[Assets](../reference/element-types/assets.md)** use the field layout defined by their asset volume in **Settings** → **Assets** → [asset volume name] → **Field Layout**.
- **[Categories](../reference/element-types/categories.md)** use the field layout defined by their category group in **Settings** → **Categories** → [category group name] → **Field Layout**.
- **[Tags](../reference/element-types/tags.md)** use the field layout defined by their tag group in **Settings** → **Tags** → [tag group name] → **Field Layout**.
- **[Users](../reference/element-types/users.md)** share a single field layout defined in **Settings** → **Users** → **User Fields**.
- **[Addresses](../reference/element-types/addresses.md)** also share a field layout, which can be found alongside **Users** in **Settings** → **Users** → **Address Fields**.

The field layout editor works roughly the same way, regardless of which element type you’re configuring:

![Screenshot of an entry’s field layout editor, with a Content tab containing three fields and a sidebar menu with “Fields” and “UI Elements” items that can be placed in the field layout](../images/field-layout-designer.png)

::: tip
Fields and other element-specific attributes can also be added to [element cards](elements.md#chips--cards) using the [card designer](#card-designer).
:::

### Tabs

Every layout starts with a _Content_ tab. Add more tabs with the **New Tab** button, or update an existing tab by clicking its action button (<icon kind="ellipses" />) and selecting **Settings**. Drag and drop those tabs into whatever order you prefer—the first tab is selected by default when editing an entry.

::: tip
When editing an element, if its field layout has only one tab (or only one tab is visible due to applied conditions), the fields within it will be displayed _without_ the tab or tab bar. Its name will not be visible until there are at least two tabs.
:::

A tab’s settings include its name and optional conditions that determine when it will be displayed for editors:

<BrowserShot
  url="https://my-project.tld/admin/settings/entry-types/42"
  :link="false"
  caption="Updating a tab’s settings in the field layout designer.">
<img src="../images/field-layout-tab-settings.png" alt="Screenshot of field layout editor with “Content” tab settings open in a slideout: Name, Current User Condition, and Entry Condition">
</BrowserShot>

- **Name** – the label displayed for the tab when it’s visible in the editor.
- **Current User Condition** – optional rules for determining which users should see the tab in the editor. (When the tab is not displayed, its fields are hidden regardless of their individual conditions.)
- **Element Condition** – optional rules (based on the current element) that determine when the tab and its fields should be displayed in the editor.

### Field Layout Elements

Add fields to any tab using the **+ Add** button, then dragging them into the desired order. Most layouts include at least a **Title** field by default—even if it’s marked as _hidden_. To remove a field, select **Remove** from its action <Icon kind="ellipses" /> menu. Some field layout elements are designated as _mandatory_ by an element type, meaning they cannot be removed from its field layout.

::: warning
Take care when removing a field from a layout: Craft stores field content using each instance’s UID. _Re-adding a field (whether or not it uses the same handle) will give it a new UID, meaning it will no longer be associated with existing content!_ By relegating these changes to a development environment, your live data is typically insulated from major loss—if you do mistakenly remove a field, you can always roll back the corresponding [project config](project-config.md) changes via git before deploying.

Moving field layout elements between tabs, however, is nondestructive.
:::

By default, each field will be displayed at the full width (100%) of its tab. Use the field width control to adjust this in increments of 25%. Fields can appear side by side as long as the content editor’s browser window is wide enough. On narrow screens, fields may be shown at full width, even if they are configured differently.

Click the action button (<icon kind="ellipses" />) next to a field and select **Instance settings** to open a slideout with its settings:

<BrowserShot
  url="https://my-project.tld/admin/settings/entry-types/42"
  :link="false"
  caption="Customizing a field instance within a field layout.">
<img src="../images/field-layout-instance-settings.png" alt="Screenshot of field layout editor with “Summary” field instance settings open in a slideout: Required, Label, Instructions, Current User Condition, and Entry Condition">
</BrowserShot>

The field’s settings let you control how and when it’s displayed:

- **Label** – Override the field’s default label, or hide it entirely.
- **Handle** – Override the field’s handle.
- **Instructions** – Override the field’s default instructions.
- **Current User Condition** – Set rules for determining which users can see the field and change its value.
- **Element Condition** – Set rules (based on the current element) that determine when the field should be displayed in an editor.
- **Required** – When a field is marked as **Required**, the element only validate when a value is present in the field. This may have different effects on different field types.
- **Use this field’s values for element thumbnails** — For fields that can be used as thumbnails in [chips and cards](elements.md#chips-cards), this option will appear.
- **Include this field in element cards** — Any fields with this enabled will appear whenever the element is rendered as a [card](elements.md#chips-cards). Fields that are also eligible for use as a thumbnail may be displayed twice!

::: tip
Only one field can be used as an element’s thumbnail at a time.
:::

Some field layout elements’ settings are bubbled up to the layout designer as _indicators_, beside the field’s name:

- An _asterisk_ (<icon kind="asterisk" />) means the field is **Required**.
- A _diamond_ means that it has been assigned one or more user or element [condition rules](#conditions).
- A _photo_ icon means the field will be used as the thumbnail in element [chips and cards](elements.md#chips-cards).
- An _eye_ means the field will appear in element cards.
- A _pencil_ icon indicates that the field contains overridden settings.

You can also edit the original field’s configuration by selecting **Edit global field settings** from its action menu.

### Multi-Instance Fields <Badge text="New!" />

Most fields can be added to a single layout multiple times. Craft will automatically assign a new handle to fields that are used more than once in a layout. To customize a field’s handle for a given layout, click its action button (<Icon kind="ellipses" />) and select **Instance settings** slideout, then look for the **Handle** field.

Multi-instance fields behave as though they were entirely different fields, in almost every situation: templates, element queries, condition builders, search, and so on. The field layout will retain a reference to the underlying field, so any settings updated for the base field will be reflected on each instance. For example, a [plain text](../reference/field-types/plain-text.md) field named “Attribution” could be used two (or more) times in a single entry type’s field layout: once for an article “Byline,” then again as “Photo Credit.” In a template, you would use those fields exactly like any other field:

```twig{7,12}
{% set image = entry.image.one() %}

<article>
  {% if image %}
    <figure>
      {{ image.getImg() }}
      <figcaption>{{ entry.photoCredit }}</figcaption>
    </figure>
  {% endif %}

  <h2>{{ entry.title }}</h2>
  <address rel="author">{{ entry.byline }}</address>

  {# ... #}
</article>
```

This example uses the same “Attribution” field as `photoCredit` _and_ `byline`, each storing its own content. You can target one instance of a field with [element queries](../development/element-queries.md), just as you’d expect:

```twig{4}
{% set postsMissingImageAttribution = craft.entries()
  .section('blog')
  .image(':notempty:')
  .photoCredit(':empty:')
  .count() %}
```

Conversely, adding one field to multiple different layouts (using the same handle—either its original handle, or by renaming each of them the same way) allows you to query across all instances. Craft quietly reconciles those field handles and builds the query appropriately:

```twig
{% set products = craft.entries()
  .section('products')
  .manufacturer('ACME%')
  .all() %}
{# -> Products made by ACME Labs and ACME Inc. across multiple product “types” with similar field layouts #}
```

This example assumes you have multiple [entry types](../reference/element-types/entries.md#entry-types) in a “Products” section, each using a centrally-defined, generic “Product Details” field—one instance of which per layout using the name “Manufacturer” and handle `manufacturer`.

### Conditions

Any fields (or [tabs](#tabs)) that have a _condition_ configured will display an orange rhombus.

<img src="../images/field-layout-conditional.png" alt="A field layout element with conditions applied">

Conditions determine when (and to whom) a field or tab is [displayed](#visibility-conditions) and [editable](#editability-conditions). You can create sophisticated editorial processes by exposing parts of the authoring interface only when specific criteria are met.

::: warning
Conditions are not intended as complete substitute for [permissions](user-management.md#permissions)! It’s still important to configure sensible base permissions for your editors.

However, Craft only populates fields that are visible _and_ editable to a given user, regardless of context; as a result, your [front-end forms](../development/forms.md) are automatically protected against clever manipulation of POST values.
:::

#### Visibility Conditions

Two conditions are available to determine when a field (or tab) is visible within a field layout, and whether it will be validated:

- **Current User Condition** — Evaluated against the user that is currently editing the element.
- **<Placeholder help="One of Craft’s built-in or plugin-provided element type names.">Element Type</Placeholder> Condition** — Evaluated against the element being edited. Available rules depend on the element type, its configuration (i.e. entry type or asset volume), and the field layout.

As you edit an element, the visibility of conditional fields is determined while [auto-saving](drafts-revisions.md#auto-saving). Take care when designing a field layout to avoid major visual shifts as fields are shown or hidden. Only visible fields are validated.

::: tip
Prior to Craft 5.7.0, these were the only two condition builders, and the UI did not explicitly group them into **Visibility Conditions**.
:::

#### Editability Conditions <Since ver="5.7.0" feature="Editability conditions in the field layout designer" />

User and element conditions completely hide field layout elements when their criteria are not met. If you would prefer to make a field read-only or “static” (so that authors can still reference its value), you can move conditions into the **Editability Conditions**.

To be editable, a field must also be [visible](#visibility-conditions).

::: warning
It’s possible to short-circuit validation with editability conditions! Fields marked as **Required** that the user cannot populate with content still prevent entries from being saved.
:::

### UI Elements

Switch to the **UI Elements** tab in the **New field** popover to add special field layout elements:

- **Heading** — Create a label that splits up form inputs, within a tab.
- **Tip** + **Warning** — Display a message with the corresponding urgency. Equivalent, except in visual design.
- **Template** — Render a Twig template from your [`templates/` directory](directory-structure.md#templates). The template will receive the element being edited under an `element` variable.
- **Horizontal Rule** — A thin divider line. Subsequent fields will start in a new row.
- **Line Break** — An invisible element that ensures the next field is rendered in a new row.
- **Markdown** — Renders a multi-line Markdown snippet. HTML is encoded prior to parsing as Markdown; if you want to add arbitrary HTML, use the **Template** UI element.

In addition to their own options (accessible via their <Icon kind="ellipses" /> action menu), most field layout UI elements share regular fields’ [condition](#conditions) settings.

### Card Designer <Since ver="5.5.0" feature="Customizable card attributes" />

Below the field layout designer, you can add previews of field and attribute data to the [card](elements.md#chips-cards) representation of that element. Note that values that appear in the card preview do not represent the content of any specific element.

![Screenshot of an element card preview within a field layout designer.](../images/element-card-preview.png)

#### Thumbnails

Card thumbnails are assigned using the main field layout designer. Select **Use for element thumbnails** from the action <Icon kind="ellipses" /> menu of any [relational field](relations.md) to display the first attached asset—or, when using a non-asset relational field, _that_ element’s thumbnail!

Only one field can be used as the thumbnail source at a time. Additional asset fields’ values can be displayed in the card body, as chips.
</file>

<file path="system/gc.md">
# Garbage Collection

Craft occasionally runs a few garbage collection routines to remove stale data, including:

- Purge unsaved [drafts](drafts-revisions.md) (per the <config5:purgeUnsavedDraftsDuration> config setting).
- Delete expired template caches.
- Purge any expired pending user accounts (per the <config5:purgePendingUsersDuration> config setting).
- Hard delete expired soft-deleted rows (per the <config5:softDeleteDuration> config setting).
- Delete stale user session data.
- Delete orphaned search indexes (any indexes belonging to elements that don’t exist anymore).
- Delete empty user folders from the **Temp Uploads Location** defined in **Settings** → **Assets** → **Settings**.

By default, each web request has a 1 in 100,000 chance of triggering garbage collection. That can be configured from `config/app.php` by overriding <craft5:craft\services\Gc::$probability>.

```php
return [
    'components' => [
        'gc' => [
            'probability' => 0,     // no chance
            'probability' => 1,     // 1 in 1,000,000
            'probability' => 10,    // 1 in 100,000 (default)
            'probability' => 100,   // 1 in 10,000
            'probability' => 1000,  // 1 in 1,000
            'probability' => 10000, // 1 in 100
        ],
    ],
];
```

## Forcing Garbage Collection

You can force garbage collection to run at any time with a terminal command.

In your terminal, go to your Craft project and then run:

```bash
php craft gc
```

If the shell is interactive, you will be asked whether Craft should delete all trashed items. If you enter `yes` at that prompt, all of your database rows that have been soft-deleted will get hard-deleted immediately, even if they hadn’t waited the full [soft delete duration](config5:softDeleteDuration) yet.

You can also force hard-deletion for all soft-deleted rows with the `delete-all-trashed` option:

```bash
php craft gc --delete-all-trashed=1
```
</file>

<file path="system/logging.md">
# Logging

Craft’s application logs can help you confirm expected behavior and investigate issues. If you’ve ever encountered a cryptic error page on a live site and wondered what actually went wrong, the logs will have the complete story.

## Finding and Reading Log Files

By default, Craft writes log files to the `storage/logs/` directory. Messages are split into a few different files, and are [rotated](#log-rotation) daily:

- `console-[Y-m-d].log`: logs generated from running console commands
- `queue-[Y-m-d].log`: logs generated from running queue jobs
- `web-[Y-m-d].log`: logs generated from front-end web requests

::: tip
You can change where runtime artifacts are stored (including logs) using the [CRAFT_STORAGE_PATH](../reference/config/bootstrap.md#craft-storage-path) PHP constant.
:::

Additionally, low-level PHP errors are logged to `phperrors.log` if allowed by [your configuration](../reference/config/bootstrap.md#craft-log-php-errors). These messages are special, and bypass Craft’s logging system entirely.

All other messages follow the same format:

```
2022-07-15 00:00:04 [web.INFO] [yii\db\Connection::open] Opening DB connection: mysql:host=ddev-starter-blog-db;dbname=db;port=3306 {"memory":913536} 
```

| Part | Example | Description
|----- | ------- | -----------
| Timestamp | `2022-07-15 00:00:04` | Precise time that the log was created.
| Target + Level | `[web.INFO]` | Type of request involved (`web`, `console`, `queue`), and log level (`TRACE`, `INFO`, `WARNING`, `ERROR`).
| Category | `[yii\db\Connection::open]` | Yii convention that broadly defines the area of concern. Defaults to `application`, but may be the calling class or method or a plugin handle.
| Message | `Opening DB connection: (...)` | Description explicitly passed to the logger.
| Context | `{"memory":913536}` | Additional parameters that were captured along with the message.

Session and environment variables are printed after the last log line for the request, preceded by a `Request context:` message.

### What Gets Logged?

The types of messages you’ll find in a log file depend on the current environment, allowed logging level(s), installed plugins, and a host of other factors.

#### Levels

Log volume generally increases as level (or “severity”) decreases—there are _a ton_ of debugging messages emitted in development environments, but when only warnings and errors are logged in a live environment, you may go long periods of time without a single message.

Levels are a great way to summarize the substance of logs:

- **Error:** Something happened that interfered with Craft’s expected behavior. Usually logged in the process of handling an exception.
- **Warning:** Craft encountered an unusual (but recoverable) circumstance. Warnings often point to abuse, misuse, or misconfiguration.
- **Info:** Messages emitted during normal operation. Oftentimes, these messages will correspond to things like failed validation, and include specifics that aren’t otherwise communicated to users.
- **Debug:** Extraneous data that is likely only useful when actively investigating an issue with a feature or plugin.
- **Profiling:** Normally excluded from logs. Profiling data is available to help identify low-level performance issues, like template rendering or database queries.

#### Exceptions

Craft will also log uncaught exceptions. Exceptions can occur for all sorts of reasons, and will often use a specific class to reflect the nature of the issue. Those that extend <yii2:yii\base\UserException> are considered safe to display to a user, and will render this default view (or one matching your <config5:errorTemplatePrefix>):

![Default presentation of a 404 HTTP Exception](../images/exception-404.png)

For security, other exceptions are hidden from the front-end, and only available by examining logs. When <config5:devMode> is _on_, a stack trace will be output just after the exception’s message; otherwise, the stack trace is encoded as JSON and appended to the log message.

::: tip
You can see a stack trace for any log message by increasing the `traceLevel` in your [log configuration](#trace-level).
:::

### Logs in Different Environments

What you see in your log files depends on the environment.

When you’re working locally with <config5:devMode> enabled, logs are output in a verbose, multi-line format that’s human-readable. Any exceptions will include a stack trace.

```
[2022-04-15T17:00:11+00:00] web.INFO: Opening DB connection: pgsql:host=db;dbname=db;port=5432 {"trace":[],"memory":9646256,"category":"yii\\db\\Connection::open"}
[2022-04-15T17:00:11+00:00] web.WARNING: Some warning… {"trace":[],"memory":13577888,"category":"application"}
[2022-04-15T17:00:11+00:00] web.INFO: Request context
$_GET = []

$_POST = []
[…truncated] {"ip":"172.18.0.1"}
```

When <config5:devMode> is off, log files are written in a machine-readable format that’s best for log aggregators. Each message will be represented on a single, longer line that includes context:

```
[2022-04-15T16:57:54+00:00] web.WARNING: Some warning… {"trace":[],"memory":13579752,"category":"application"}
[2022-04-15T16:57:54+00:00] web.WARNING: Request context  {"ip":"172.18.0.1","userId":1,"vars":{"_GET":[],"_POST":[],"_COOKIE":{"1031b8c41dfff97a311a7ac99863bdc5_username":"2756d05ef7521bdc1dac02da066e1658e3e16d6acc7360cfc6256cb1cec311cca:2:{i:0;s:41:\"1031b8c41dfff97a311a7ac99863bdc5_username\";i:1;s:5:\"admin\";}","CraftSessionId":"if0uq3uj36d8ek6n5o9eak2l04","1031b8c41dfff97a311a7ac99863bdc5_identity":"8ddb6a5ce28f3fb2d23567df9228ce31614d6b19572c4f60db3b4b5eae78f2a3a:2:{i:0;s:41:\"1031b8c41dfff97a311a7ac99863bdc5_identity\";i:1;s:159:\"[1,\"[\\\"QwoFhu6pBsTvSOkCXqNvu2_cIr16fde6AK1DHP7GLiyXmnv7qY5BscDi8sl_QRT9z2uGh051J7r9IkSawusrx-ijCLZWZ6bHB433\\\",null,\\\"d9667159e600aea00a68fcc215cc4f6e\\\"]\",3600]\";}","CRAFT_CSRF_TOKEN":"••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••"},"_FILES":[],"_SERVER":{"PATH":"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin","HOSTNAME":"my-project.tld","PHP_DISPLAY_ERRORS":"on","PHP_MEMORY_LIMIT":"512M","PHP_MAX_EXECUTION_TIME":"5000","PHP_UPLOAD_MAX_FILESIZE":"512M","PHP_MAX_INPUT_VARS":"5000","PHP_POST_MAX_SIZE":"512M","PHP_OPCACHE_ENABLE":"0","PHP_OPCACHE_REVALIDATE_FREQ":"0","PHP_OPCACHE_VALIDATE_TIMESTAMPS":"0","XDEBUG_SESSION":"PHPSTORM","PHP_IDE_CONFIG":"serverName=my-project.tld","XDEBUG_CONFIG":"client_host=host.docker.internal client_port=9003","XDEBUG_MODE":"develop,debug","IMAGE_USER":"nitro","PHP_VERSION":"8.0","NVM_VERSION":"0.38.0","DEBIAN_FRONTEND":"noninteractive","HOME":"/home/nitro","LC_CTYPE":"C.UTF-8","SUPERVISOR_ENABLED":"1","SUPERVISOR_PROCESS_NAME":"php-fpm","SUPERVISOR_GROUP_NAME":"php-fpm","USER":"nitro","HTTP_X_FORWARDED_PROTO":"https","HTTP_X_FORWARDED_FOR":"172.18.0.1","HTTP_UPGRADE_INSECURE_REQUESTS":"1","HTTP_SEC_FETCH_USER":"?1","HTTP_SEC_FETCH_SITE":"none","HTTP_SEC_FETCH_MODE":"navigate","HTTP_SEC_FETCH_DEST":"document","HTTP_SEC_CH_UA_PLATFORM":"\"macOS\"","HTTP_SEC_CH_UA_MOBILE":"?0","HTTP_SEC_CH_UA":"\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"100\", \"Google Chrome\";v=\"100\"","HTTP_COOKIE":"1031b8c41dfff97a311a7ac99863bdc5_username=2756d05ef7521bdc1dac02da066e1658e3e16d6acc7360cfc6256cb1cec311cca%3A2%3A%7Bi%3A0%3Bs%3A41%3A%221031b8c41dfff97a311a7ac99863bdc5_username%22%3Bi%3A1%3Bs%3A5%3A%22admin%22%3B%7D; 1031b8c41dfff97a311a7ac99863bdc5_identity=8ddb6a5ce28f3fb2d23567df9228ce31614d6b19572c4f60db3b4b5eae78f2a3a%3A2%3A%7Bi%3A0%3Bs%3A41%3A%221031b8c41dfff97a311a7ac99863bdc5_identity%22%3Bi%3A1%3Bs%3A159%3A%22%5B1%2C%22%5B%5C%22QwoFhu6pBsTvSOkCXqNvu2_cIr16fde6AK1DHP7GLiyXmnv7qY5BscDi8sl_QRT9z2uGh051J7r9IkSawusrx-ijCLZWZ6bHB433%5C%22%2Cnull%2C%5C%22d9667159e600aea00a68fcc215cc4f6e%5C%22%5D%22%2C3600%5D%22%3B%7D; CRAFT_CSRF_TOKEN=9779283c4e1eba389e1017adc948f01af0a22c04a007ab820e41e540b501e74ca%3A2%3A%7Bi%3A0%3Bs%3A16%3A%22CRAFT_CSRF_TOKEN%22%3Bi%3A1%3Bs%3A147%3A%22XBmAAP6UFlrOfMEOHl9coZnXbJKENF2LtqdsItB7%7C11c6df0a319dfd02ab5a74652e290bf2aa260e6423b903fc38fee0c76e1dbc06XBmAAP6UFlrOfMEOHl9coZnXbJKENF2LtqdsItB7%7C1%22%3B%7D","HTTP_CACHE_CONTROL":"max-age=0","HTTP_ACCEPT_LANGUAGE":"en-US,en;q=0.9","HTTP_ACCEPT_ENCODING":"gzip, deflate, br","HTTP_ACCEPT":"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","HTTP_USER_AGENT":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.88 Safari/537.36","HTTP_HOST":"my-project.tld","SCRIPT_FILENAME":"/app/web/index.php","REDIRECT_STATUS":"200","SERVER_NAME":"","SERVER_PORT":"80","SERVER_ADDR":"172.18.0.12","REMOTE_USER":"","REMOTE_PORT":"46122","REMOTE_ADDR":"172.18.0.19","SERVER_SOFTWARE":"nginx/1.18.0","GATEWAY_INTERFACE":"CGI/1.1","REQUEST_SCHEME":"http","SERVER_PROTOCOL":"HTTP/1.1","DOCUMENT_ROOT":"/app/web","DOCUMENT_URI":"/index.php","REQUEST_URI":"/","SCRIPT_NAME":"/index.php","CONTENT_LENGTH":"","CONTENT_TYPE":"","REQUEST_METHOD":"GET","QUERY_STRING":"","FCGI_ROLE":"RESPONDER","PHP_SELF":"/index.php","REQUEST_TIME_FLOAT":1650041873.980016,"REQUEST_TIME":1650041873,"PRIMARY_SITE_URL":"https://my-project.tld/","CRAFT_ENVIRONMENT":"dev","CRAFT_SECURITY_KEY":"•••","CRAFT_DEV_MODE":"0","CRAFT_DB_URL":"","CRAFT_DB_DATABASE":"db","CRAFT_DB_USER":"db","CRAFT_DB_PASSWORD":"•••••","CRAFT_DB_DRIVER":"pgsql","CRAFT_DB_SCHEMA":"public","CRAFT_DB_SERVER":"postgres-13-5432.database.nitro"},"_SESSION":{"bd62416aa8538ede709019a5e113eea5__flash":[],"1031b8c41dfff97a311a7ac99863bdc5__token":"••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••","1031b8c41dfff97a311a7ac99863bdc5__id":1,"__authKey":"••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••","1031b8c41dfff97a311a7ac99863bdc5__expire":1650045474,"__duration":3600}}}
```

### Tools

Log files are just plain text, but their growth can gradually become a problem for some programs. Let’s look at a few ways to monitor logs for new messages.

#### Command Line

UNIX provides the `tail` command for printing files:

```bash
tail -f storage/logs/web-*.log
```

This will output new `web` logs as they’re written, and will continue to work even as files are rotated. You can clear any old output with <kbd>Ctrl</kbd>/<kbd>Command</kbd> + <kbd>K</kbd>.

To hunt for specific messages, pipe the output through [`grep`](https://linux.die.net/man/1/grep):

```bash
tail -f storage/logs/web-*.log | grep "specific message or category" -C 10
```

The `-C` flag preserves a few lines on either side of a message that matches. Some characters have special meaning in `grep`, and may need to be escaped.

#### Console

MacOS comes with a utility called [Console](https://support.apple.com/guide/console/welcome/mac), designed for log processing. When opening a file, it will automatically watch for new messages and can filter them by search terms.

#### Log Drains

Some platforms will have built-in support for aggregating logs and “draining” them to first- and third-party tools. In these situations, the expectation is generally that logs are sent to [`stdout` and `stderr`](#stdout-and-stderr).

Docker operates in a similar way, making output streams available to the host via `docker logs --follow my-container-name`.

### Sensitive Information

To prevent leaking secrets into logs, Craft automatically redacts sensitive-sounding environment or “context” variable names, like “password”, “token”, and “key.” The final output ends up looking like this:

```
"CRAFT_DB_DATABASE":"db","CRAFT_DB_USER":"db","CRAFT_DB_PASSWORD":"•••••",
```

These keywords are customizable via the `security` component’s `sensitiveKeywords` property in [config/app.php](repo:craftcms/cms/blob/5.x/src/config/app.php#L110-L122):

```php
<?php

return [
    'components' => [
        'security' => [
            'sensitiveKeywords' => [
                // Anything added here gets merged with the defaults:
                'private',
            ],
        ],
    ],
];
```

::: danger
Craft does _not_ attempt to redact the message content itself. It is your responsibility to prevent sensitive information from being explicitly logged, say, via interpolation in a message.
:::

### Log Rotation

Logs are grouped by date without any specific size limit. The number of files is limited to 5 by default, per <craft5:craft\log\MonologTarget::$maxFiles>.

For high-traffic environments, configuring [`logrotate`](https://linux.die.net/man/8/logrotate) or streaming your logs to [`stdout` and `stderr`](#stdout-and-stderr) is recommended.

## Customizing Logs

Craft gives you fine-grained control over how logs are formatted and where they end up.

Configuration is handled via the `log` component, in `config/app.php`. If this is your first time dealing with `app.php`, we recommend reading a bit about [application configuration](../reference/config/app.md).

### Monolog

Craft uses [Monolog](https://seldaek.github.io/monolog/) to standardize log output. The defaults used for creating the built-in `web`, `console`, and `queue` targets can be customized via the `monologTargetConfig` property:

```php
<?php

use craft\helpers\App;
use Monolog\Formatter\LineFormatter;
use Psr\Log\LogLevel;
use yii\i18n\PhpMessageSource;
use yii\web\HttpException;

return [
    'components' => [
        'log' => [
            'monologTargetConfig' => [
                // Only log context in `devMode`
                'logContext' => App::devMode(),

                // Only export messages with `warning` severity and higher:
                'level' => LogLevel::WARNING,

                // Force single-line logs, even in `devMode`:
                'allowLineBreaks' => false,

                // Override message filtering to exclude *all* 400-level exceptions:
                // (This replaces the default exclusions, `PhpMessageSource:*` and `HttpException:404`)
                'except' => [
                    PhpMessageSource::class . ':*',
                    HttpException::class . ':4*',
                ],

                // Change the default log formatter and date format:
                'formatter' => new LineFormatter(
                    format: "%datetime% [%level_name%][%context.category%] %message% %context% %extra%\n",
                    dateFormat: DATE_ATOM
                ),
            ],
        ],
    ],
];
```

### Targets

Unless configured otherwise, all logs for a request will be written to the same file.

Additional [targets](https://www.yiiframework.com/doc/guide/2.0/en/runtime-logging#log-targets) can be defined to send your logs (or a subset of them, based on severity or category) to other destinations.

```php
<?php

use craft\helpers\App;
use craft\log\MonologTarget;
use Psr\Log\LogLevel;
use yii\log\FileTarget;
use yii\web\HttpException;

return [
    'components' => [
        'log' => [
            'targets' => [
                // 1. Add a traditional Yii file target for auditing 404 errors that are normally excluded:
                [
                    'class' => FileTarget::class,
                    'logFile' => '@storage/logs/missing-pages.log',
                    'categories' => [
                        HttpException::class . ':404',
                    ],
                    'logVars' => [],
                ],

                // 2. Add a Monolog target for module-specific messages:
                [
                    'class' => MonologTarget::class,
                    'name' => 'custom-module',
                    'extractExceptionTrace' => !App::devMode(),
                    'allowLineBreaks' => App::devMode(),
                    'level' => App::devMode() ? LogLevel::INFO : LogLevel::WARNING,
                    'categories' => ['custom-module'],
                    'logContext' => false,
                ],
            ],
        ],
    ],
];
```

Here, we’re defining two new targets:

1. A simple <yii2:yii\log\FileTarget> that only includes messages with the `yii\web\HttpException:404` category. These are emitted by Yii, but excluded by Craft’s default targets.
2. A custom <craft5:craft\log\MonologTarget> to siphon messages emitted by a custom module into a separate log file, and discards context info. Read about [logging your own events](#logging-your-own-events) to learn how to send a message here.

Our new targets don’t affect Craft’s normal logging behavior—the default targets are still configured. As a result, a single message may be dispatched to multiple targets; if you want to filter messages out of the default targets, you can use the `categories` and `except` properties within the [`monologTargetConfig`](#monolog), above. See the Yii documentation on [messaging filtering](guide:runtime-logging#message-filtering) for more information on how this works.

`monologTargetConfig` and the `MonologTarget` are the only places you should use [PSR-3](#psr-3-logging) `Psr\Log\LogLevel` constants—other Yii-compatible log targets should use <yii2:yii\log\Logger> constants.

::: tip
The available options for each type of `Target` will differ, and may include things like API keys or hostnames for external services. Refer to the author’s documentation for specific requirements!
:::

### `stdout` and `stderr`

Craft redirects all log output from Monolog targets to `stdout` and `stderr` when [`CRAFT_STREAM_LOG`](../reference/config/bootstrap.md#craft-stream-log) is set to `true`. This is common in load-balanced environments and servers with ephemeral filesystems, where log output is aggregated from multiple sources, or the sources themselves are not directly accessible.

### Trace Level

To see exception-like traces for _all_ logs, set the log component’s [`traceLevel` property](guide:runtime-logging#trace-level):

```php
<?php
# config/app.php
return [
    'components' => [
        'log' => [
            // Include this many levels of the call stack:
            'traceLevel' => 5,
        ],
    ],
];
```

::: warning
Keep in mind that non-zero `traceLevel` values can incur a performance hit as the system accumulates debugging data!
:::

## Logging Your Own Events

You can log your own messages from a plugin or module.

### Using Craft’s Logger

Convenience methods are available for different severity levels:

- `Craft::debug()` – non-essential information that can be used for debugging issues
- `Craft::info()` – standard level for informative contextual details
- `Craft::warning()` – messages that indicate something problematic or unexpected even though everything continues to work
- `Craft::error()` – most urgent level before an exception, used to indicate that something didn’t function properly

::: tip
By default, Craft logs levels `info` and up when <config5:devMode> is enabled. Otherwise, anything lower than `warning` will be ignored. To override this behavior, set the `level` property in your [log configuration](#monolog).
:::

Logged messages should designate a message body, level, and optional category. Here, the we’re using the `custom-module` category, overriding the default of `application`:

```php
// Short form, using a helper function for the `info` level:
Craft::info('My first log message!', 'custom-module');

// The equivalent call, with an explicit level:
Craft::getLogger()->log('My first log message!', Logger::LEVEL_INFO, 'custom-module');
```

These messages would be dispatched to the main log files (in environments where `info`-level messages are processed), as well as the custom `MonologTarget` we set up earlier! In both places, it will receive a `[custom-module]` designation:

```
2022-09-16 16:50:49 [web.INFO] [custom-module] My first log message! {"memory":1038928}
```

Anything that can be serialized as JSON can be logged.

### PSR-3 Logging

Craft 4 doesn’t require any changes to existing logging setups, but now accepts PSR-3 messages:

```php
use samdark\log\PsrMessage;

// Traditional Yii2 Logging:
Craft::error('Some error…', 'Some category (logged as context.category)');

// PSR-3 Logging, with context and message substitutions:
Craft::error(new PsrMessage(
    'Some error, {psr3Replacement}',
    [
        'some' => 'context',
        'to' => ['be', 'serialized'],
        'psr3Replacement' => 'https://www.php-fig.org/psr/psr-3/'
    ],
));
```

Using the [convenience methods](#using-crafts-logger) will automatically translate Yii log levels to the most appropriate PSR-3 level when dispatched to a `MonologTarget`.

## Further Reading

- [Adding Logging to Craft Plugins with Monolog](https://putyourlightson.com/articles/adding-logging-to-craft-plugins-with-monolog)
</file>

<file path="system/mail.md">
# Email

Craft sends email in response to some user actions, like account activation, email verification, password resets, and testing [email settings](#settings). All Craft editions are capable of sending emails, but system messages are only customizable in **Pro**.

Plugins may send email under other circumstances, either by registering a global [system message](#system-messages), or using [their own management tools](#other-messages).

## System Messages <badge type="edition" vertical="middle" text="Pro" title="Craft Pro only" />

You can view and edit the built-in (and plugin-provided) email messages by navigating to <Journey path="Utilities, System Messages" />.

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/utilities/system-messages"
    :link="false"
    caption="Viewing system messages in the utilities section of the control panel. Customizing system messages is limited to Craft Pro.">
<img src="../images/system-messages.png" alt="System messages">
</BrowserShot>

Click on any message to open a modal and edit its subject and body.

::: tip
Running a [multi-site](sites.md) installation? You can customize system messages (and [mail settings](#settings)) on a per-site basis using the site selection menu in the upper-right corner of the message editor modal.
:::

### Twig

The body of each system message is evaluated as a Twig template, then parsed as [Markdown](https://daringfireball.net/projects/markdown/). Subject lines may also include Twig.

<See path="../development/twig.md" description="Get to know Twig, Craft’s template engine." />

The default templates include some basic output tags that take advantage of the [variables](#variables) Craft provides:

```twig
Hey {{user.friendlyName|e}},

Thanks for creating an account with {{systemName}}! To activate your account, click the following link:

<{{link}}>

If you were not expecting this email, just ignore it.
```

#### Variables

Each system message (and subject line) is provided some special, context-specific variables, in addition to those available in normal Twig environments.

All Messages
: These variables are available across all system messages:
: - `emailKey`: Handle or “key” of the message being sent—usually a `snake_case` version of its name, below.
: - `fromEmail`: Email address being used in the message’s `From:` header.
: - `replyToEmail`: Email address being used in the message’s `ReplyTo:` header. Same as `fromEmail`, unless it was explicitly set in [settings](#settings), or was overridden prior to sending.
: - `fromName`: Display name that was used to build the `From:` header. Reflects the **Sender Name** in [settings](#settings), unless it was overridden prior to sending.
: - `language`: Language that the current message was defined for. This may agree with the site in use when the message was triggered, or the user’s preferred language.

Account Activation
: - `user`: The Craft [user](../reference/element-types/users.md) element a message is being sent to.
: - `link`: A tokenized activation URL.

Email Verification
: - `user`: The Craft [user](../reference/element-types/users.md) element a message is being sent to.
: - `link`: A tokenized verification URL.

Password Reset
: - `user`: The Craft [user](../reference/element-types/users.md) element a message is being sent to.
: - `link`: A tokenized password reset URL.

::: warning
When outputting user-provided values (like a username, email, or [address](../reference/element-types/addresses.md)), always use the [escape](https://twig.symfony.com/doc/3.x/filters/escape.html) filter. You can see the shorter version (`|e`) in use in the template, above.
:::

Keep in mind that users may have different amounts of profile data populated when they register or reset their password. Include default or alternate text when the desired text may not be available:

```twig
{# Output a comma before the user’s name, or jump right to a punctuation mark: #}
Hello{{ user.fullName is not empty ? ", #{user.fullName}" : null }}!
```

#### URLs

You may output element URLs just as you would in a front-end template. However, if you are linking to an arbitrary path, use the appropriate URL helper function, in Twig:

```twig
{# Forces a site URL: #}
{{ siteUrl('dashboard') }}

{# Forces a control panel URL: #}
{{ cpUrl('myaccount')}}
```

Using the agnostic `url()` function may generate incorrect URLs that reflect how an email was triggered rather than the kind of access the recipient has. For example, a user requesting a password reset link from the front-end will get the proper site URL, but the same email sent in response to an administrator’s action would be prefixed with the <config5:cpTrigger>.

#### Language

In addition to having site-specific messages, emails sent to a Craft user can use the [`t` filter](../reference/twig/filters.md#translate-or-t) to localize strings based on their preferred language. Read more about [static translations](sites.md#static-message-translations) in the **Sites** documentation.

::: tip
Plugins may register messages that are not sent to Craft users—in these cases (where we don’t know the recipient’s desired language), the current site’s language will be used.
:::

#### Image Transforms

Craft generates transforms for images used within emails prior to sending them. This ensures that no [ambiguous URLs](repo:craftcms/cms/issues/7267) are included in an email, which could later point to an incorrect transform.

## Other Messages

Plugins may create and send email messages outside of [system messages](#system-messages). For example, [Commerce](/commerce/5.x/README.md) provides a [user-configurable suite of messages](/commerce/5.x/system/emails.md) and status-based triggers, rather than defining messages in the global space. The mailer will use the **System Email**

::: tip
If you are unsure where an email is sent from (or how to edit it), check the system messages utility, then consult the documentation for any installed plugins.
:::

## Settings

Craft uses a single configuration for its [mailer component](craft5:craft\mail\Mailer), on the assumption that all email should flow through a single [transport](#transport-adapters).

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/settings/email"
    :link="false"
    :maxHeight="800"
    id="mail-settings"
    :poi="{
        systemAddress: [28, 14],
        replyToAddress: [28, 22],
        htmlTemplate: [28, 39.5],
        siteOverrides: [48, 52],
        transportAdapter: [18, 62],
    }"
    caption="Email settings screen in the control panel.">
<img src="../images/mail-settings.png" alt="Craft email settings">
</BrowserShot>

After making changes to your configuration, click **Test** at the bottom of the screen. Craft will attempt to send a message with the new settings; if you see a confirmation, apply the settings by clicking **Save**. Mail settings are stored in [project config](project-config.md).

::: warning
Craft only knows as much about delivery as the current [transport](#transport-adapters) can provide. For example, an adapter that calls a third-party HTTP API considers a send “successful” if the request completed nominally; therefore, a test may appear successful at first blush, but be undeliverable for an unrelated reason.
:::

### System Address <Poi target="mail-settings" id="systemAddress" label="1" />

All email will appear to be sent “from” this address. You may also set a **Reply-To Address** <Poi target="mail-settings" id="replyToAddress" label="2" /> if the system address is not a real or monitored inbox.

::: tip
Some plugins provide an option to override this address for messages that they send.
:::

### HTML Template <Poi target="mail-settings" id="htmlTemplate" label="3" />

If you wish to customize your emails’ structure or appearance, consider creating a template in your `templates/` directory and selecting it, here.

This template is handled a bit differently than the normal Twig “layout” scheme—the body of the email is [processed](#twig) first, then passed to the template as a `body` variable:

```twig{18}
<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      /* Custom styles! */
    </style>
  </head>
  <body>
    <div class="email-wrapper">
      <div class="email-header">
        <img
          class="email-logo"
          src="{{ siteUrl('assets/images/email/logo.png') }}"
          width="140"
          alt="{{ siteName }}">
      </div>
      <div class="email-body">
        {{ body }}
      </div>
      <div class="email-footer">
        ©{{ now.format('Y') }}, <a href="{{ siteUrl }}">{{ siteName }}</a>
      </div>
    </div>
  </body>
</html>
```

Otherwise, this is a regular Twig environment, so all the filters, functions, global variables, tags, and tests are available to you—including element queries!

### Site Overrides <Since ver="5.6.0" feature="Site-specific overrides for email settings" /> <Poi target="mail-settings" id="siteOverrides" label="4" />

Multi-site projects provide a means to override the **System Email Address**, **Reply-To Address**, **Sender Name**, and **HTML Email Template** on a site-by-site basis. Like the fields above, overrides accept environment variables that are resolved at runtime. When a value is not populated for a site, the global setting is used.

Craft uses site-specific settings when sending email to users with an [affiliated site](user-management.md#affiliated-site).

### Transport Adapters <Poi target="mail-settings" id="transportAdapter" label="5" />

Three adapters are provided with Craft, with more installable from the [Plugin Store](https://plugins.craftcms.com/categories/mailer-adapters?craft4). You can switch adapters at any time—each adapter exposes a [Transport](https://symfony.com/doc/current/mailer.html#using-a-3rd-party-transport) class that conforms to a consistent interface, allowing Craft and plugins to send email without worrying about the underlying implementation or service.

::: tip
For the most reliable delivery, consider using one of the third-party transactional email service integrations, like [Amazon SES](https://plugins.craftcms.com/amazon-ses?craft4), [Mailgun](https://plugins.craftcms.com/mailgun?craft4), [Postmark](https://plugins.craftcms.com/postmark?craft4), or [Sendgrid](https://plugins.craftcms.com/sendgrid?craft4). These adapters all communicate with an API over HTTP instead of SMTP, and ultimately use their own, trusted origin to send email. In some situations, this is essential, as some <abbr title="Internet Service Provider">ISP</abbr>s and network maintainers will throttle or completely block outbound SMTP traffic.

These services often require non-invasive adjustments to your DNS records for proof-of-ownership and security.
:::

#### Gmail

Sends via an existing Google Gmail account. You must [enable IMAP access](https://support.google.com/mail/answer/7126229) in order to access a Gmail account over SMTP.

::: danger
This adapter requires credentials for your Google account. If it is your only option, consider using an account that would not pose a security risk to you or your clients, should the password be compromised.

_As of May, 2022, Google has phased out most support for “[less-secure apps](https://support.google.com/accounts/answer/6010255),” in favor of [App Passwords](https://support.google.com/accounts/answer/185833)._
:::

#### SMTP

A generic adapter for any SMTP connection. You must specify an SMTP host, but which remaining fields are required is dependent upon the server.

Some third-party platforms offer SMTP integrations paths, and do not require a custom adapter! DDEV, for instance, gives you a [Mailpit](https://ddev.readthedocs.io/en/stable/users/usage/developer-tools/#email-capture-and-review-mailpit) instance for capturing and reviewing outbound email. When starting a project, DDEV will write some variables prefixed with `MAILPIT_` into your `.env` file:

```bash
MAILPIT_SMTP_HOSTNAME="127.0.0.1"
MAILPIT_SMTP_PORT="1025"
```

You can use these in the adapter configuration by [prefixing them with a dollar sign](../configure.md#control-panel-settings) (`$`), or consume them via [application configuration](../reference/config/app.md#mailer).

::: tip
The default port for SMTP has traditionally been `25`, but some networks completely block this traffic. Your SMTP server may support communication on an alternate port—usually `587`.
:::

#### Sendmail

`sendmail` is a unix command-line tool for sending email. Unless a host has properly configured and documented their installation, `sendmail` tends to be extremely unreliable. As a spam prevention measure, most email providers will outright reject messages coming from unknown IP addresses.

This adapter only requires a “command,” and defaults to `/usr/sbin/sendmail -bs`.

### Development + Testing

In development and staging environments, you can ensure all outbound email is sent to a single address with the <config5:testToEmailAddress> setting.

Alternatively, the entire [mailer component](../reference/config/app.md#mailer) can be replaced via application config, should you want to use an entirely different [transport](#transport-adapters) for local development.
</file>

<file path="system/object-templates.md">
# Object Templates

Craft uses single-line [Twig](../development/twig.md) “templates” in a number of places throughout the control panel to generate values from data that is only known at runtime. These templates are most often stored in [Project Config](project-config.md), but the resulting values are typically part of a record stored in the database, or only used temporarily.

Some examples of object templates in use are:

- [Element](elements.md) title and slug formats;
- [Asset field](../reference/field-types/assets.md) default upload paths;
- [Section](../reference/element-types/entries.md#sections) and [category group](../reference/element-types/categories.md#category-groups) URI formats;
- Values sent to controllers via a [`redirectInput()`](../reference/twig/functions.md) function;
- The [`group()` filter](../reference/twig/filters.md) in Twig;
- Console controllers that [re-save elements](../reference/cli.md#resave);
- Translation keys for fields;
- Some condition rules stored in Project Config;

Object templates _are_ Twig templates—but there are a few behavioral differences to be aware of!

::: warning
Like system messages, object templates grant access to the full suite of Craft APIs (via `craft.app`), and are therefore considered a trusted template environment. See the [Security](#security) section below for details.
:::

## Evaluation & Invalidation

Craft typically renders object templates in response to specific actions, like an element being saved. This is important for performance reasons, especially when building URIs: the system can’t generate thousands or millions of URIs on-the-fly for the purposes of matching against the current request! Instead, Craft evaluates a template and stores the resulting string, which can be scanned quickly by the database.

Consequently, it’s possible for those values to become stale. If the dynamic attributes in a URI template belong exclusively to the object it was rendered for, it should always be up-to-date—but if it includes attributes or variables from _other_ sources (like the [environment](../configure.md#env) or another element), Craft isn’t always able to invalidate those cached values. There are two features in place, though, to help avoid common problems with URIs:

- Whenever an entry in a [structure](../reference/element-types/entries.md#structures) are saved, the slugs and URIs of its descendants are recursively re-rendered. This helps hierarchical URIs stay in sync with their parent element(s).
- If a component is updated via project config in a way that _could_ change URIs of the elements it governs, Craft re-saves those elements. An example of this would be the URI format for a category group in a given site; only elements in sites that 

::: tip
Craft’s [`resave/*` commands](../reference/cli.md#resave) can be run on an entire section, category group, or other slice of your elements to re-render their URIs, if you believe a change has caused them to become stale. You must run this command in each environment the change is made!
:::

Most templates (like redirects after a form submission or default asset field upload paths) aren’t affected by this, because it’s always possible to efficiently resolve their values at runtime.

## Objects & Variables

Every object template is rendered in the context of a primary model. In the same way that an entry’s template (as determined by a [section](../reference/element-types/entries.md#sections)’s settings) automatically receives an `entry` variable, object templates expose an `object` variable.

This agnostic variable name is important, because the context a template is rendered in may differ between uses! For example, [asset fields](../reference/field-types/assets.md) allow you to customize where files are uploaded… but the path is evaluated using the element that field is attached to. A single field configured with the path `header-images/{slug}` might be attached to an entry, category, _and_ tag, and would otherwise have an unpredictable variable naming convention.

In most cases, you don’t even need to include the primary object’s variable name in the template at all, thanks to the concise attribute access [syntax](#syntax)!

### Other Features

Because this is a fully-fledged Twig environment, you also get access to all the [global variables](../reference/twig/global-variables.md) and Twig language features you’d expect:

```twig
Current Coupons (Last updated {{ now|date('Y-m-d') }})
Current Coupons (Last updated by {{ currentUser.username }})
```

::: tip
Global variables must be referenced using the normal Twig output tags, not the [concise syntax](#syntax).
:::

### Stability

When writing an object template, consider the stability of the resulting value! If you use values that change (like `dateUpdated` or the global `now` variable), the resulting string may change every time you edit an element. Craft only routes to the latest revision of an element, so unstable URI templates will invalidate old URLs.

This is also important to keep in mind for 

## Syntax

Regular [Twig templates](../development/twig.md) evaluate content in pairs of output tags (`{{ ... }}`) and control blocks (`{% ... %}`). Object templates extend this syntax to make referencing attributes of the passed object more concise. For example, outputting an entry’s `slug` attribute would look like this in a normal Twig template:

```twig
{{ entry.slug }}
```

In an object template, you have the option of this compact syntax:

```
{slug}
```

Craft expands this to `{{ object.slug }}`. In the same way, an object template containing `{postDate.format('Y')}` is expanded to `{{ object.postDate.format('Y') }}`. If you prefer to use the full Twig syntax, each of the object’s attributes are unfolded into the template’s context, making any of these functionally equivalent:

- Compact notation: `{slug}`
- Normalized Twig syntax: `{{ object.slug }}`
- Attributes-as-variables: `{{ slug }}`

The attributes that are exposed in this way are dependent on the kind of object you’re working with. _Methods_ of those objects are _not_ expanded into the global space, so they must be referred to via `object`, using the compact syntax or dot notation.

::: tip
Object templates are always limited to a single line. Their output is also generally expected to be a single line, and including line breaks may cause validation errors on any attributes that assume the output from a template is “clean.”
:::

### Conditional Logic

Conditions are slightly more complicated, and are often clearest when using complete Twig syntax:

```twig
{{ object.level == 1 ? 'topics' : object.parent.uri }}/{slug}
```

This template combines a normal Twig output statement with the compact syntax. Craft normalizes this before evaluation, so both statements will work!

### Default Values

This pattern above can be simplified using the special `getParentUri()` method (or `parentUri` getter):

```twig
{parentUri ?? 'topics'}/{slug}
```

The `??` or [null-coalescing](https://twig.symfony.com/doc/3.x/templates.html#other-operators) operator is equivalent to the `|default` filter, in that it will swallow `null` values and errors, falling back to whatever the right-hand value is.

### Whitespace

Be mindful of spaces between your Twig statements! These will be considered part of the resulting string. Spaces _inside_ a Twig expression do _not_ contribute to the resulting string.

## Security

Object templates are most useful when they incorporate user-provided content—take URIs for example:

```
blog/{postDate.format('Y')}/{slug}
```

We know that `postDate.format('Y')` will always produce a four-digit number like `2024`… but `slug` is an attribute of the entry element that can be controlled by user input! Fortunately, this is a pretty safe thing to do, because the slug is heavily validated by the time it’s used in the template. Let’s look at some examples of object templates that _aren’t_ safe.

### Attribute Access

If you are accepting user-submitted content, **do not** construct an object template that would allow access to arbitrary attributes:

::: code
```twig Dangerous
profiles/{{ object[slugSource] }}/{id}
```
```twig Safe
profiles/{{ slugPrefixSource == 'accountType' ? memberType : 'member' }}/{id}
```
:::

While the first template _feels_ more dynamic and provides greater control, it would allow anyone updating the user to access other attributes (and potentially _methods_) by updating the record with a malicious value.

### Nested Templates

Take care when including other templates. Template paths should _always_ come from a trusted source!

In the same spirit, you should never render _nested_ object templates with the [`renderObjectTemplate()` Twig function](../reference/twig/functions.md#renderobjecttemplate), especially when the input comes from an untrusted user.

### Hashing

When using the [`redirectInput()` function](../reference/twig/functions.md#redirectinput), the provided object template will appear verbatim in the rendered HTML, but prepended with a secure hash. This mechanism allows you to lazily evaluate a template based on some input, without having the template itself be dictated by user input.

::: danger
Do not incorporate user input into the string passed to `redirectInput()`! The object template should always come from a trusted source.

For example, this usage is easily attacked by someone sending a link one of your site’s users with a carefully-crafted query string:

```twig
{{ redirectInput(craft.app.request.getQueryParam('maliciousRedirect')) }}
```

The template would be evaluated after the user submits a form, and could contain arbitrary logic that exfiltrates system data.
:::

You may use information about the request to switch behavior, though:

```twig
{{ redirectInput(currentUser.isInGroup('supporters') ? 'account/receipts' : 'tip/thanks') }}
```
</file>

<file path="system/plugins.md">
---
related:
  - label: 'Craft Console'
    uri: 'https://console.craftcms.com'
  - label: 'Working with Organizations in Craft Console'
    uri: 'https://craftcms.com/knowledge-base/craft-console-organizations'
  - label: 'Plugin Store'
    uri: 'https://plugins.craftcms.com'
---

# Plugins

Plugins extend Craft’s core functionality. They can introduce new dashboard widgets, field types, control panel sections, Twig features, workflow actions, third-party integrations, and more.

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/settings/plugins"
  caption="Viewing available and installed plugins via the Craft control panel.">
<img src="../images/control-panel-settings-plugins.png" alt="Plugins settings in the Craft control panel">
</BrowserShot>

### What’s a Plugin?

A plugin is a software package that supplements or alters Craft’s internal functionality. Under the hood, plugins are a superset of [Yii modules](guide:modules), an opinionated collection of models, controllers, services, and other system components. This gives Craft plugins a strong design foundation, in turn providing a reliable and consistent experience for developers and users.

Every plugin is a Composer package, meaning they must be “required” by a project’s `composer.json` file before being [installed](#installing-a-plugin). Only plugins required by a project will appear in the screen above—to find _new_ plugins, visit the [Plugin Store](#the-plugin-store)!

::: tip
If you want to build your own plugin, check out the [Extending Craft](../extend/README.md) section.
:::

## The Plugin Store

Craft’s [control panel](control-panel.md) features a [Plugin Store](https://plugins.craftcms.com) where you can discover hundreds of free and commercial plugins, install them with a single click, and purchase licenses.

::: tip
If Craft is configured to [disallow admin changes](config5:allowAdminChanges) in the current environment, you won’t be able to install plugins. We recommend using a [local development environment](../install.md) to install and test plugins, then [deploy](../deploy.md) them (and any associated [project config](project-config.md) changes) to your live site.
:::

To access the Plugin Store from the control panel, click **Plugin Store** from the global navigation menu. From there, you can discover new plugins via categories and curated lists.

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/plugin-store"
  caption="The Plugin Store, viewed from the Craft control panel.">
<img src="../images/plugin-store.png" alt="Screenshot of the Craft control panel’s built-in Plugin Store">
</BrowserShot>

Choose any plugin to learn more about its features, pricing, documentation, version history, and see screenshots of it in action.

<BrowserShot
  url="https://my-craft-project.ddev.site/admin/plugin-store"
  caption="Viewing the Formie plugin from the Craft control panel’s built-in Plugin Store.">
<img src="../images/plugin-store-plugin.png" alt="Screenshot of the Craft control panel’s built-in Plugin Store, showing a plugin named Formie">
</BrowserShot>

The Plugin Store will only show plugins that are compatible with the version of Craft you are viewing it from. If you would like to view plugins for _any_ Craft version, visit [plugins.craftcms.com](https://plugins.craftcms.com).

## Installing a Plugin

Any compatible plugin can be installed by visiting its page in the [control panel](control-panel.md)’s Plugin Store and clicking one of the **Try** or **Install** buttons in the sidebar.

### Via the Plugin Store

Free plugins can be installed by choosing **Install** from the plugin’s detail page. You’ll be taken to the plugin installer page, which will keep you updated with Craft’s status as it works through the installation.

Plugins that require a paid license can be _trialed_ by choosing **Try** from the plugin’s detail page—this button appears in place of the **Install** button for free plugins.

When you install a paid plugin, you will immediately be issued a license key—but you are not required to pay while evaluating plugins in a development environment.

### Via Composer

You may also install plugins with [Composer](https://getcomposer.org), by copying and pasting the commands from the **Installation Instructions** toolbox on its page in the Plugin Store. The command is actually two steps (but combined into one for convenience):

1. Require the plugin’s package, and allow dependencies to be updated (`-w`):

    ```bash
    composer require craftcms/commerce -w
    ```

2. Use [Craft’s CLI](../reference/cli.md#plugin-install) to install the plugin by its **handle**, and run any migrations:

    ```bash
    php craft plugin/install commerce
    ```

    (A plugin’s **handle** is provided in the installation command, and appears as the last segment in its Plugin Store URL. It may be different than the package name.)

## Uninstalling a Plugin

To uninstall a plugin, follow these steps:

1. Navigate to **Settings** &rarr; **Plugins** in the control panel;
1. Click the actions icon (<Icon kind="ellipses" />) for the plugin you wish to remove;
1. Select **Uninstall** from the dropdown menu;

To completely scrub a plugin from your project, you must also remove the Composer dependency:

```bash
composer remove craftcms/commerce
```

If the plugin required configuration via code, you may also want to remove relevant files from your [`config/` directory](../system/directory-structure.md#config) and clean up variables in your `.env` file.

::: danger
Do not remove a plugin package with Composer _before_ uninstalling it from the control panel or with Craft’s CLI. Many plugins include special migrations that perform essential database cleanup, and that is only possible if the source code remains at the time it is uninstalled.

This may require a multi-step [deployment](../deploy.md) to ensure plugins have an opportunity to properly clean up after themselves:

1. Uninstall the plugin from the control panel or via the CLI;
1. Commit and deploy the resulting project config changes;
1. Remove the underlying package from `composer.json`;
1. Commit and deploy your updated `composer.lock`;

While there is no inherent danger in a plugin’s tables being orphaned, it can complicate re-installing that plugin, down the line.
:::

You can also uninstall a plugin with Craft’s CLI, using its handle:

```bash
php craft plugin/uninstall commerce
```

Keep in mind that using the CLI to uninstall a plugin does not remove the Composer dependency! You must still follow the directions above to fully remove the plugin package.

## Disabling a Plugin

Plugins may be temporarily _disabled_ from the control panel or CLI:

```bash
php craft plugin/disable commerce
```

A disabled plugin is still _installed_ (its configuration, database tables, and source code remain in place), but its code is not loaded, and to the rest of the system it appears as though it is _not_ installed. Disabling a plugin that has a control panel section will cause it to disappear—but it will remain in the **Settings** &rarr; **Plugins** section so it can be re-enabled.

## Plugin Licensing

Plugins are licensed separately from Craft, but track which Craft license they are associated with.

### Buying Plugins

If you’ve tried a commercial plugin and are ready to purchase a license, you have a few options.

::: tip
This is a perfect time to set up an [organization](kb:craft-console-organizations) in Craft Console. Organizations simplify the process of approving license purchases and organizing keys.
:::

#### Reminders

At the bottom of every page in the [control panel](control-panel.md), Craft provides a summary of the installed software, and will alert you if there are any unpaid licenses. This is _not_ an indication that you are in violation of licensing terms, or owe money—it’s just our way of letting you know what currently-active plugins you _will_ need to pay for when your site launches.

![Reminder banner for unpaid licenses](../images/control-panel-license-footer.png)

Click **Purchase licenses** to add the required licenses to your cart on Craft Console. You may also copy the URL and send it to a coworker or client—it contains all the information we need to properly connect the license keys with your installation!

::: tip
If you see a red banner at the _top_ of the control panel, you may be running versions of plugins that a previously-paid license does not cover—say, as a result of Composer updating a package beyond what its license allows.

[This article](kb:how-craft-licenses-and-renewals-work) has more info about how we determine what versions of Craft (or plugins) a license covers.
:::

#### Plugin Store

From the control panel Plugin Store, choose the cart icon <Icon kind="cart" /> in the header area. Your unpaid plugin licenses will be listed in the cart’s **Active Trials** section. Choose **Add to cart** to add the plugin to your cart and proceed with checkout.

Once you’ve completed the checkout process, your plugin installation will automatically become licensed.

::: tip
If you purchase a plugin license separately from a Craft install or need to update a license key, visit **Settings** → **Plugins** in the relevant site’s control panel. From that listing, you can enter a new key or [variable](../configure.md#control-panel-settings) for any commercial plugin.
:::

### Managing Plugin Licenses

You can manage all your plugin licenses from [Craft Console](https://console.craftcms.com/) account, by navigating to **Licenses** → **Plugins** within your personal account, or any [organization](kb:craft-console-organizations) you are a member of.

If you don’t have a Craft Console account yet, create one by visiting [console.craftcms.com/register](https://console.craftcms.com/register).

#### Claiming Licenses

When you register for Craft Console, we will automatically attach licenses purchased prior to the introduction of Craft ID (Craft Console’s predecessor) that match the email address you use.

If you can’t find a plugin license, visit **Licenses** → **Claim License**. You can enter its license key manually, or if you know the email address that was used for purchase, you can enter it in the **Claim licenses by email address** section. After verifying ownership of the email address, any unclaimed licenses associated with that email address will be added to your account.

### Safeguarding Plugin License Keys

By default, your plugin license key will be stored in the database and [project config](project-config.md). If you wish, you may move that license key to a [PHP constant or environment variable](../configure.md#control-panel-settings) and set the key using the `$MY_PLUGIN_KEY` syntax.

Similarly, you can set Craft’s license key via the special `CRAFT_LICENSE_KEY` environment variable.

License keys are not sensitive in and of themselves. As long as a key is associated with a Craft Console account, it cannot be used by another Craft installation or claimed by another Console account. Therefore, it is perfectly acceptable to track Craft (`license.key`) and plugin keys (project config) in version control.

### Transferring Plugin Licenses

To authorize transfer of a plugin license to someone else’s Craft Console account, log into your Craft Console account, choose the license under **Licenses** → **Plugins**, and choose the **Release License** to release it from your account. Another person will then be able to claim the license for themselves from the **Licenses** → **Claim License** page of their Craft Console account.

::: tip
You may also transfer a license directly to an organization you are a member of.
:::

### Commercial Plugin Licensing

The Plugin Store requires that all commercial plugins follow Craft’s licensing model. This ensures licensing is safe and predictable for customers, while supporting a sustainable business model for plugin developers.

- They are free to try in development environments, but require payment to be used in production environments;
- Commercial licenses are a one-time fee per Craft installation, which comes with access to updates for one year after purchase;
- Additional updates can be available with an annual update fee;
- Licenses can be returned for a full refund within 30 days of purchase, no questions asked;

Additionally, all plugins in the Plugin Store must use either the [MIT License](https://opensource.org/licenses/MIT) or the [Craft License](https://craftcms.github.io/license/). Generally, free plugins will use the MIT License, and commercial plugins will use the Craft license.

## Plugin Support

Developer support is a specific service we include with Craft Pro licenses, but we do not require plugin developers to provide the same level of support for their plugins—free _or_ commercial. You will need to check with each developer to learn about their support policies, so you and your clients know what to expect.

::: tip
Sometimes, issues with plugins can be caused by temporary or permanent issues with external services. While we understand that this can be extremely frustrating, a plugin’s developer may have no control over the availability or reliability of those services.
:::

If you feel that a plugin vendor isn’t providing a reasonable level of support for a commercial plugin license, please let us know by emailing <support@craftcms.com> with the name of the plugin, a description of your original issue, and a summary of any attempts to resolve directly with the developer.
</file>

<file path="system/project-config.md">
# Project Config

Craft tracks system settings in a centralized store called _Project Config_. Changes are recorded as YAML files in the `config/project/` folder, which can be version-controlled alongside your templates and other front-end resources.

This workflow provides two main benefits:

1. Your [project’s state](#whats-stored-in-project-config) is tracked over time.
2. Settings are [automatically propagated](#propagating-changes) to other development/staging/production environments.

The overarching principle behind Project Config is to separate the management of content and settings. In doing so, it’s possible to establish a one-way flow for configuration, and to tie settings and schema to the rest of your project’s code.

::: tip
Project Config is a discrete concept from [configuration](../configure.md), but [often complements](#secrets-and-the-environment) it.
:::

## Scope

Broadly speaking, Project Config tracks things that are managed via the **Settings** section of the control panel.

- Asset volumes and named image transforms
- Category groups
- Craft and plugin schema versions
- Craft edition
- Email settings
- Fields, field groups, and all field layouts
- Global sets (settings only, not their content)
- GraphQL schemas, and the access settings for the public schema
- Matrix block types
- Plugin versions, editions, and settings
- Routes defined in **Settings** → **Routes**
- Sections and entry types
- Sites and site groups
- System name, time zone, and status (live/offline)
- Tag groups
- User settings and user groups

::: tip
Plugins and Modules can store their own settings in Project Config, too. See [Supporting Project Config](../extend/project-config.md) to learn how.
:::

## Usage

Project Config is always active, but you may need to adjust your workflow to get the most out of it.

Use of Project Config often involves disabling the <config5:allowAdminChanges> option in all but development environments, which makes the **Settings** section of the control panel inaccessible—even for admin users. This guarantees settings are only changed under circumstances where their effects can be tested alongside any relevant templates or code.

Suppose you are asked to add a new entry type to an existing section. The process is probably pretty familiar: make some updates via the control panel, adjust templates and styles, then push your code. But how does the new entry type definition actually make it to the live site?

- **Without** Project Config, you would eventually need to squash a live database with a development one (risking content loss), or copy settings from one control panel to another (risking misconfiguration).
- **With** Project Config, Craft tracks the schema changes as YAML and can apply them automatically (as part of your deployment process) or at the click of a button.

::: warning
Never directly edit YAML files. Missing changes in other parts of the Project Config that should be made simultaneously can cause inconsistencies and instability.
:::

## Propagating Changes

As you make changes in your development environment, you will notice the contents of your `config/project/` folder are updated to reflect those changes. Commit those files to your Git repository as you would templates, front-end resources, and other project files—then push and [deploy](kb:deployment-best-practices) them together.

On the target machine or environment, _apply_ the pending changes in one of two ways:

1. From the **Project Config** utility in the control panel.
2. By running the `php craft project-config/apply` terminal command.

Craft will compare the `config/project/` folder with its already-loaded Project Config, and apply whatever changes it finds.

::: tip
When [installing Craft](../install.md), any existing configuration in your `config/project/` directory will be applied automatically as long as its Craft and plugin versions match those being installed. This makes it possible to set up your own boilerplate projects!
:::

## Secrets and the Environment

Some settings may require you to input sensitive information:

- An SMTP password for your email transport/adapter
- An API key for a third-party service
- A secret access key in an AWS S3 filesystem

Providing a secret verbatim will cause the value to leak into Project Config YAML files. To avoid this, Craft supports using [environment variables](../configure.md#env) and [aliases](../configure.md#aliases) to stand in for a sensitive or dynamic value. For example, providing `$MYSERVICE_API_KEY` would read the corresponding value (minus the `$`) from your `.env` file, at runtime. Similarly, values that begin with an `@` are resolved as aliases.

![Craft’s autosuggest field, displaying a suitable match](../images/site-base-url-setting.png)

See [Environmental Configuration](../configure.md#control-panel-settings) for more information.

## Working with Others

Project Config simplifies collaboration on big features by letting you share version-controlled settings and schema changes with others just as easily as [deploying](../deploy.md) them. Multiple contributors’ changes can even be cleanly merged together.

:::tip
Merge conflicts _can_ still happen (when two contributors modify the same setting), but resolving them is rarely more difficult than a template or stylesheet—you’ll just have to run `php craft project-config/touch` and then `php craft project-config/apply` to ensure the final result is applied.
:::

Any time you integrate new code into an environment (say, while developing locally, or deploying to a server), run `craft up` to apply pending migrations and project config changes.

## Adopting Project Config

If you had previously opted out or are upgrading from earlier than Craft 3.1, it’s still possible to get on board. Let’s look at how to get your environments in a consistent state:

1. Pick a primary environment that has the most up-to-date settings, and make sure it’s running the latest version of Craft. (If your project is already live, this should be your production environment!)
2. Go to **Utilities** → **Project Config** on that environment, and click the “Rebuild” button (or use the CLI: `php craft project-config/rebuild`) to ensure that its Project Config is up to date with settings stored throughout the database.
3. Back up the database on the primary environment.
4. In your secondary/development environment:
    - Import the database backup created in step #3;
    - Delete the contents of the `config/project/` folder;
    - Make a request to the control panel to trigger a regeneration of the YAML files in `config/project/`;
5. Disable the <config5:allowAdminChanges> config setting on the primary environment (and all non-development environments, for that matter) to avoid [losing changes](#production-changes-reverted), going forward.

It’s now safe to deploy changes in your `config/project/` folder to other environments!

## Troubleshooting + Trivia

There are a few things you should keep in mind when working with Project Config:

### Composer

When Craft tries to apply Project Config changes, it will first verify that the Craft and plugin schema versions declared in YAML are compatible with what’s actually installed. Inconsistencies can usually be resolved by running `composer install`.

::: tip
`composer.lock` should be checked in to version control alongside Project Config files. To stay ahead of these errors, run `composer install` during every deploy and when integrating changes from collaborators!
:::

### Production Changes Reverted

Changes made to Project Config on production will likely be reverted the next time your site is deployed. Craft does not attempt to distinguish between explicit deletions and incidental removal of settings—if the incoming config has an “old” value (or omits the value entirely), Craft applies those changes.

To prevent this, set <config5:allowAdminChanges> to `false` in `config/general.php`, or via an [environment override](../configure.md#environment-overrides):

```env
CRAFT_ALLOW_ADMIN_CHANGES=false
```

This completely removes the UI for administrative settings, and places the entire Project Config service in a read-only state to prevent inadvertent modifications.

::: warning
Craft _will_ warn you in the control panel if the YAML files on disk appear to be “older” than the loaded config (based on the root `dateModified` property), but it is up to you to determine which version is correct.
:::

### Config Data Could Get Out of Sync

The recommended way to keep Project Config in sync is to version control `config/project/` and use the CLI to apply changes:

```bash
php craft project-config/apply
```

If any settings stored in Project Config are modified directly in the database (either manually or via a plugin/module that isn’t using the appropriate APIs), the state will be out of sync and likely result in errors. If that happens, Craft provides a console command that is effectively the reverse of `apply` (instead of taking YAML changes and applying them, it rebuilds YAML files from Craft’s internal state):

```bash
php craft project-config/rebuild
```

If changes are not being picked up during the apply process, you can use the `--force` option:

```bash
php craft project-config/apply --force
```

This will treat all Project Config values as added or updated, resulting in a longer sync process and potentially overriding any expected changes that might have been favored in the database.

### IDs, UUIDs, and Handles

Project Config uses UUIDs rather than IDs to track settings that are synchronized to the database. Unlike volatile IDs (or even `handle`s), UUIDs remain stable for the life of a section, entry type, category group, or other record—even when updating their handles.

You can (and should) still use handles in your templates, because there is no guarantee that referencing a resource by its ID will point to the same record in all environments! If you do find the need to use the ID of a system resource, you should use Craft’s APIs to look it up by its handle rather than hard-coding it:

```twig
{# Load the field definition via the fields API: #}
{% set matrixField = craft.app.fields.getFieldByHandle('myMatrixFieldHandle') %}

{# Use the loaded ID: #}
{% set myMatrixBlockQuery = craft.matrixBlocks()
  .owner(featuredPost)
  .fieldId(matrixField.id)
  .type('text')
  .all() %}
```

## Manual YAML File Generation

If you want control over _when_ the Project Config YAML files are updated (or you want to opt out of saving them altogether) you can configure Craft to stop writing the YAML files automatically as changes are made. To do that, add the following to your `config/app.php` file:

```php
return [
    // ...
    'components' => [
        // ...
        'projectConfig' => function() {
            $config = craft\helpers\App::projectConfigConfig();
            $config['writeYamlAutomatically'] = false;
            return Craft::createObject($config);
        },
    ]
];
```

You can manually trigger YAML file generation from the Project Config utility, or by running the following terminal command:

```bash
php craft project-config/write
```

::: warning
If you already have YAML files generated, run the `project-config/write` command before updating Craft and/or plugins. Otherwise, the out-of-date YAML files could conflict with Project Config changes performed by the update migrations.
:::
</file>

<file path="system/queue.md">
# Queue

The **queue** is Craft’s way of delegating certain long-running tasks to an asynchronous background process.

In most cases, these tasks are either too time-consuming, resource-intensive, or error-prone to handle during a normal HTTP request-response cycle, without significant impacts on responsiveness and user experience in the [control panel](control-panel.md) or front-end.

Here are a few of the things Craft uses the queue for:

- Updating search indexes;
- Resaving elements in bulk;
- Generating image transforms;
- Propagating elements between sites;
- Executing a **Find and Replace** operation across all site content (started via Utilities);

Users with the **Queue Manager** [permission](user-management.md#permissions) can view information about the queue from the [Utilities](control-panel.md#utilities) section of the control panel. The status of any currently-running job (or the last failed job) will also be displayed at the bottom of the main navigation.

## Jobs

Each message in the queue is called a **job**. Jobs have a type (corresponding to the kind of work that will happen when it is executed) and often include additional data that helps define their scope—sometimes to a specific element (like when updating the [search](searching.md) index) or a set of elements (like when resaving entries after a section’s settings have changed).

Jobs will enter and clear the queue naturally, as you use Craft. In the unlikely event a job fails, it will remain visible in the Queue Manager until it is retried or released. You can view more information about a failed job by clicking its description in the table.

<BrowserShot
    url="https://my-craft-project.ddev.site/admin/utilities/queue-manager/884"
    :link="false"
    caption="Viewing a job in the queue manager utility.">
<img src="../images/queue-manager.png" alt="Viewing a job in the queue manager utility" />
</BrowserShot>

::: tip
Plugins can take advantage of the queue by providing custom [job types](../extend/queue-jobs.md)!

[Commerce](/commerce/5.x/README.md), for example, uses the queue to send order emails so that a customer’s checkout experience is not disrupted by esoteric mailer errors.
:::

### Statuses

New jobs enter the queue in a **waiting** state. Once a runner picks up the job, it will be marked as **reserved** and Craft will attempt to execute it. Depending on the type of job, it may be allowed a certain number of “attempts” (temporary failures) or an overall “TTR” (time to reserve). If a job exhausts its attempts or runs out of time, it will be marked as **failed**.

Failed jobs can be retried from the control panel, or with the [CLI](../reference/cli.md#queue-release). While additional _attempts_ are made automatically after a failure, _retries_ must be triggered manually.

In addition to a status, jobs also have **description** and a **progress** value, both of which may be updated throughout its life. Jobs that handle large datasets typically report progress after each item processed (like when resaving elements), or are sliced into smaller batches.

## Queue Runners

By default, the queue is run automatically over [HTTP](#http). For more control, you can use Craft’s CLI via [CRON](#cron)—or even as a [daemonized service](#daemon).

::: tip
Advanced configuration of the queue (including alternate [drivers](repo:yiisoft/yii2-queue/tree/master/docs/guide#queue-drivers) and proxies) is possible via [application config](../reference/config/app.md#queue).
:::

### HTTP

At the end of every site request, Craft checks whether the queue contains waiting jobs. If it does, a JavaScript snippet is injected into the page, triggering a second request from the client that kicks off a non-blocking background process. This is skipped for [Ajax requests](../development/forms.md#ajax), and responses that produced something other than HTML.

::: tip
This behavior is enabled by default, but can be turned off by setting <config5:runQueueAutomatically> to `false`. If you elect to disable the automatic queue runner, you must configure an alternative.
:::

For control panel requests, the JavaScript bundle included on every page performs a similar request—this is also how Craft is able to display the queue’s status in the sidebar!

### CLI

All Craft features will work as expected with the default queue configuration.

::: warning
The following options are configured outside of Craft, and are only recommended for users with some unix systems administration experience. Check with your host to see if they offer native tools for managing services and CRON tasks.
:::

Projects that rely on the queue for time-sensitive or critical features (like sending [order status emails](/commerce/5.x/system/emails.md) in Commerce) can take advantage of Craft’s [CLI](../reference/cli.md#queue) for more flexibility over when and where the queue is run:

```bash
php craft queue/run
```

Let’s look at some examples of how this can be used in different scenarios.

#### CRON

The `queue/run` action is suitable for manual or scheduled invocation. For example, if you wanted to process the queue every five minutes, you might add this to your system’s `crontab`:

```
*/5 * * * * /usr/bin/env php /var/www/craft queue/run
```

::: tip
Note that we’re using an absolute path to the Craft installation. CRON’s “working directory” will likely be different than your user’s home directory or your web root!
:::

If your site frequently generates many “expensive” tasks (like transforming images or resaving entries) or tasks that communicate with other web services, make sure your CRON intervals don’t end up overlapping. Just like web requests, running many concurrent jobs in different processes can cause them all to slow down—but even if intervals _do_ overlap, Craft will never execute reserved jobs in more than one place.

#### Daemon

A “daemonized” queue runner can be registered with most unix-based systems so that the queue operates like other system services—MySQL or Redis, for example. Configuration will depend on the service manager your platform uses (likely `systemd` or `supervisor`), but should follow a similar structure, and will ultimately use the long-running `queue/listen` command:

```bash
php craft queue/listen --verbose
```

Whereas `queue/run` runs only until the queue is empty, `queue/listen` continually polls the database for new jobs, exiting only when terminated.

The `--verbose` flag tells Craft to write some basic information about the queue’s state to `stdout`. Running this from the command line (locally, or via SSH on a remote server) will output a message when the worker successfully initializes, and a message each time a job starts and finishes.

Let’s look at some configuration, in practice. The following examples are adapted from the underlying [Yii queue component](repo:yiisoft/yii2-queue/blob/master/docs/guide/worker.md) documentation:

::: code
``` systemd
# /etc/systemd/system/craft-queue-worker@.service
# Note the @ in the filename above!

[Unit]
Description=Craft CMS Queue %i
After=network.target
After=mysql.service
Requires=mysql.service
# (...or postgresql.service!)

[Service]
# User + Group should agree with HTTP processes:
User=www-data
Group=www-data
ExecStart=/usr/bin/php /var/www/craft queue/listen --verbose=1 --color=0
# Only restart after unexpected failures:
Restart=on-failure
# Extend time between restart attempts after a failure:
RestartSec=120
# Allow more time before issuing a kill signal:
TimeoutStopSec=300

[Install]
WantedBy=multi-user.target
```
``` supervisor
; /etc/supervisor/conf.d/craft-queue-worker.conf

[program:craft-queue-worker]
; Use the process number in its name (required when using `numprocs`):
process_name=%(program_name)s_%(process_num)02d
numprocs=4
command=/usr/bin/php /var/www/craft queue/listen --verbose=1 --color=0
; User + Group should agree with HTTP processes:
user=www-data
group=www-data
# Allow more time before issuing a kill signal:
stopwaitsecs=300
```
:::

The `TimeoutStopSec` and `stopwaitsecs` settings in the examples above should agree with (or exceed) [your queue’s `ttr`](../reference/config/app.md#queue), so that currently-running jobs may complete and the runner may exit gracefully when the process manager sends a `TERM` signal. At the end of that window (if the queue has not voluntarily exited), the process manager sends a `KILL` signal and may interrupt the queue in the middle of a task. This safeguard relies on the [`pcntl` PHP extension](https://www.yiiframework.com/extension/yiisoft/yii2-queue/doc/guide/2.3/en/retryable), which is _not_ a core Craft [requirement](../requirements.md), and may need to be enabled by your host.

::: warning
Long-running processes must be restarted to pick up code and schema changes after a deployment or migration!

To register your newly created (or updated) service, the process manager itself may need to be restarted, or specifically told to look for new configuration.
:::

Your process manager also has commands for interacting with the service:

::: code
```bash systemd
# Install hooks to run a single worker on boot:
sudo systemctl enable craft-queue-worker

# Start a worker:
sudo systemctl start craft-queue-worker

# Get the worker’s status:
sudo systemctl status craft-queue-worker

# Stop a worker:
sudo systemctl stop craft-queue-worker
```
```bash supervisor
# Enter the supervisor command line utility:
sudo supervisorctl

# Tell supervisord there is a new configuration available:
sudo supervisorctl reread

# Apply new configuration changes and restart affected services:
sudo supervisorctl update
```
:::

::: tip
While `supervisor` stores the number of processes spawned for a given service as part of its configuration, `systemd` requires you to declare those instances when using the `systemctl` command:

```bash
# Install four instances of a service:
sudo systemctl enable craft-queue-worker@{1..4}

# Start those instances:
sudo systemctl start craft-queue-worker@{1..4}

# Get the status for any matching instances:
sudo systemctl status "craft-queue-worker@*"

# Restart any matching instances:
sudo systemctl restart "craft-queue-worker@*"
```

This is possible due to the `@` symbol at the end of our service unit file’s name. Note that the bash-specific “range” syntax (`{1..4}`) is _not_ surrounded by quotes, but the “glob” patterns (`*`) _are_. This is critical for the system to be able to expand and map the commands to the appropriate service instances(s).
:::

These setup instructions ensure your service is started whenever the host machine is rebooted, but it’s important to check your work! If your host allows, consider manually rebooting your machine and verifying that the queue is active.

::: warning
When configuring and testing a daemonized queue runner, disable <config5:runQueueAutomatically>. Leaving this on may give the false impression that the queue is working as intended, despite it actually being run over HTTP.
:::

#### Workers

Some <abbr title="Platform-as-a-Service">PaaS</abbr> solutions like Heroku and Digital Ocean support dedicated background services. These workers are typically built from the same base “image,” but rather than running an HTTP server (or being connected to the public internet at all), they execute a provided command—just like the [daemonized](#daemon) runner, above.

This paradigm can be bizarre at first, but it’s similar in many ways to load-balancing—in order to work, shared resources (like the database, cache, and asset storage) must be accessible from each web server and worker. Craft will automatically divide jobs among multiple workers, so applications that make heavy use of the queue (say, to process user-uploaded images) can be scaled appropriately, independent of the front-end.

#### Performance Considerations

Running the queue on the same machine that serves HTTP requests can (in extreme cases) cause bottlenecks. The CLI does not abide by the same [resource](config5:phpMaxMemoryLimit) or [time](https://www.php.net/manual/en/info.configuration.php#ini.max-execution-time) limits as web requests, meaning it can degrade or interrupt service for much longer.

To ensure web requests are prioritized, the unix program `nice` can help the kernel schedule workloads on your server’s CPU(s). Replace the queue command in your [daemon](#daemon) with this:

```bash
/usr/bin/nice -n 10 /usr/bin/php /var/www/craft queue/listen --verbose=1 --color=0
```

Here, `-n 10` just signals that the process should be a _lower_ priority than the default (`0`). Negative values (_increased_ priority) are not allowed, and `19` is the lowest valid priority. `nice` can also be used in a CRON task, by swapping the `queue/listen` action for `queue/run` as in previous examples.

::: danger
Do not run the queue as root!
:::

## Local Development

If you’ve turned off <config5:runQueueAutomatically> for your live infrastructure, the queue will also be disabled in your local environment. You can [override](../configure.md#environment-overrides) the general config setting by declaring `CRAFT_RUN_QUEUE_AUTOMATICALLY=true` in your `.env`, or use the [CLI](#cli) as you would in a [daemon](#daemon):

::: code
```bash DDEV
ddev craft queue/listen --verbose
```
```bash Other
php craft queue/listen --verbose
```
:::

## Custom Queues

::: warning
This section discusses features that are only relevant to projects that use a [custom module](../extend/module-guide.md) or [private plugin](../extend/plugin-guide.md#private-plugins).
:::

You can set up additional queues via [application configuration](../configure.md#application-configuration), but _only jobs in the default `queue` component will be observable from the control panel_.

Each queue must be defined under a separate `id`:

```php
return [
    // ...
    'bootstrap' => [
        'sluggishQueue',
    ],
    'components' => [
        'sluggishQueue' => [
            'class' => craft\queue\Queue::class,
        ],
    ],
];
```

Craft doesn’t know about this queue, so it will never push jobs into it. Secondary queues are only practical when you have implemented a [custom job](../extend/queue-jobs.md) that would otherwise interfere with the processing of your main queue. While [multiple runners](#daemon) can help avoid situations where one long-running (but not necessarily time-sensitive) job blocks many other quick (but vital) jobs, the only way to ensure tasks run in completely separate “channels” is to configure multiple queues, and push your custom job into a non-default queue.

Custom queues can be managed from the CLI using their kebab-cased component `id`:

```bash
php craft sluggish-queue/listen --verbose
```

## Troubleshooting

See the knowledge base article on [Resolving Failed Queue Jobs](kb:resolving-failed-queue-jobs) for a list of common queue problems.

### Logging

Any time a job `echo`s text or calls a logger method, that output is sent to a special `queue` log target in addition to the current request type (`web` or `console`). Messages originating from the queue are also given a special `[queue.LEVEL]` tag to make them easier to filter out when aggregated. Read more about these behaviors in the [logging](logging.md) section.

::: tip
Daemonized workers’ output may also be captured in your system’s logs, which can be viewed using the [`journalctl` command](https://www.freedesktop.org/software/systemd/man/journalctl.html):

```bash
journalctl -u craft-queue-worker.service
```

`supervisor` users also have access to a [dedicated logs viewer](http://supervisord.org/running.html#supervisorctl-actions):

```bash
supervisorctl tail craft-queue-worker
```
:::
</file>

<file path="system/README.md">
# System

Let’s get to know Craft’s core features, starting with your project’s [Directory Structure](directory-structure.md) and the [Control Panel](control-panel.md).

The content in this section is for a variety of audiences, so we expect that you’ll jump around—some of it is geared toward developers (like [Project Config](project-config.md) or [Routing](routing.md)), but other resources will be useful to everyone (like [User Management](user-management.md) and [Relations](relations.md)).
</file>

<file path="system/reference-tags.md">
# Reference Tags

Reference tags can be used to create references to specific [elements](elements.md) in your site from any textual fields, including text cells within a [Table](../reference/field-types/table.md) field. Some field types automatically parse reference tags, and others may need to be [explicitly parsed](#parsing-reference-tags).

A reference tag usually takes this form:

```twig
{<Type>:<Identifier>(@<Site>):<Property>}
```

Curly braces (`{}`) surround three segments, separated by colons (`:`):

1.  `<Type>` – The type of element you’re creating a reference to. This can be a fully-qualified element class name (e.g. `craft\elements\Entry`) or the element type’s “reference handle.”

    Core element types have the following reference handles:

    - Addresses: `address`
    - Assets: `asset`
    - Categories: `category`
    - Entries: `entry`
    - Global Sets: `globalset`
    - Tags: `tag`
    - Users: `user`

2.  `<Identifier>` – Either the element’s ID or a custom identifier supported by the element type:

    - Entries: `my-entry-slug`, or `mySection/my-entry-slug`
    - Categories: `my-category-slug` or `myGroup/my-category-slug`
    - Global sets: `setHandle`

    Identifiers can also include the ID, UUID, or handle of a site that the element should be loaded from, using an `@<Site>` syntax.

3.  `<Property>` _(optional)_ – The element property that the reference tag should return. If omitted, the element’s URL will be returned.

    You can refer to the element types’ class references for a list of available properties:

    - [craft\elements\Address](craft5:craft\elements\Entry#public-properties)
    - [craft\elements\Asset](craft5:craft\elements\Asset#public-properties)
    - [craft\elements\Category](craft5:craft\elements\Category#public-properties)
    - [craft\elements\Entry](craft5:craft\elements\Entry#public-properties)
    - [craft\elements\GlobalSet](craft5:craft\elements\GlobalSet#public-properties)
    - [craft\elements\Tag](craft5:craft\elements\Tag#public-properties)
    - [craft\elements\User](craft5:craft\elements\User#public-properties)

    Custom field handles are also supported, for field types with values that can be represented as strings.

### Examples

The following are all valid reference tag formats:

- `{asset:123:filename}` — returns the filename of an asset with the ID of `123` (via <craft5:craft\elements\Asset::getFilename()>).
- `{entry:blog/whats-on-tap}` — returns the URL of an entry in a `blog` section with the slug `whats-on-tap`.
- `{entry:blog/whats-on-tap@en:intro}` — returns the value of an `intro` custom field on a `blog` section entry with the slug `whats-on-tap`, loaded from the site with the handle `en`.
- `{craft\commerce\Variant:123:price}` — returns the price of a Commerce Variant object with the ID of `123`. Note that no formatting will be applied to the price!
- `{globalset:siteInfo:description}` — returns the value of a `description` field on a global set with the handle `siteInfo`.

## Generating Tags

Some element types ([assets](../reference/element-types/assets.md), for instance) allow you to copy a basic reference tag from element indexes. Select a single row, then use the actions menu <icon kind="gear" /> to **Copy reference tag**. You can edit the copied tag to output a specific property—or let Craft decide the best representation (typically its URL).

## Parsing Reference Tags

You can parse any string for reference tags in your templates using the [parseRefs](reference/twig/filters.md#parserefs) filter:

```twig
{{ entry.body|parseRefs|raw }}
```

The equivalent function is available via <craft5:craft\services\Elements>:

```php
$parsed = Craft::$app->getElements()->parseRefs($text);
```

Both functions take an optional `$siteId` param, which will determine what site the references are assumed to be in, if a tag doesn’t explicitly declare one.

## Safety

Any time you allow dynamic references to other resources, it’s important to acknowledge some risks.

### Recursion

Reference tags are parsed recursively—so supposing you had a field with a reference to itself (or any other multi-element cyclical reference), Craft would go back and forth, parsing them until it ran out of memory!

### Untrusted Input

**Do not** pass untrusted user input through `parseRefs`! Reference tags allow access to arbitrary properties and can lead to [exfiltration](https://csrc.nist.gov/glossary/term/exfiltration) of private data—as an example, an anonymous user could submit `{user:1:email}` to try and get admin user’s email address.

This also applies to the [GraphQL directive](../development/graphql.md#the-parserefs-directive) of the same name.
</file>

<file path="system/relations.md">
---
sidebarDepth: 2
---

# Relations

Craft has a powerful engine for relating elements to one another with five [relational field types](#custom-fields). Just like other field types, relational fields can be added to any [field layout](./fields.md#field-layouts), including those within [nested entries](#relations-via-matrix).

_Unlike_ other field types, relational fields store their data in a dedicated `relations` table. In that table, Craft tracks:

- The element that is the **source** of the relationship;
- Which **field** a relationship uses;
- The **site** a relationship was defined;
- The element that is the **target** of the relationship;
- The **order** in which the related elements are arranged;

This allows you to design fast and powerful [queries](#the-relatedto-parameter) for related content, and to [optimize loading](../development/eager-loading.md) of nested and related resources.

### Terminology

Each relationship consists of two elements we call the *source* and *target*:

- The <dfn>source</dfn> has the relational field where other elements are chosen.
- The <dfn>target</dfn> is the one selected by the source.

## Illustrating Relations

Suppose we have a database of _Recipes_ (represented as a [channel](../reference/element-types/entries.md#channels)) and we want to allow visitors to browse other recipes that share an ingredient. To-date, ingredients have been stored as plain text along with the instructions, and users have relied on search to discover other recipes.

Let’s leverage Craft’s relations system to improve this “schema” and user experience:

1. Create another channel for _Ingredients_.
2. Create a new [Entries field](../reference/field-types/entries.md), with the name “Ingredients.”
3. Limit the **Sources** option to “Ingredients” only.
4. Leave the **Limit** field blank so we can choose however many ingredients each recipe needs.
5. Add this new field to the _Recipes_ channel’s field layout.

Now, we can attach _Ingredients_ to each _Recipe_ entry via the new _Ingredients_ relation field. Each selected ingredient defines a new relationship, with the recipe as the _source_ and the ingredient as the _target_.

<a id="getting-target-elements-via-the-source-element" title="Section “Getting Target Elements via the Source Element” has been renamed."></a>

## Using Relational Data

Relationships are primarily used within [element queries](../development/element-queries.md), either via a relational field on an element you already have a reference to, or the [`relatedTo()` query parameter](#the-relatedto-parameter).

### Custom Fields

_Ingredients_ attached to a _Recipe_ can be accessed using the relational field’s handle. Unlike most fields (which return their stored value), relational fields return an [element query](../development/element-queries.md), ready to fetch the attached elements in the order they were selected.

Craft has five built-in relational fields, each of which establishes links to a different [element type](elements.md#element-types):

- [Assets](../reference/field-types/assets.md)
- [Categories](../reference/field-types/categories.md)
- [Entries](../reference/field-types/entries.md)
- [Tags](../reference/field-types/tags.md)
- [Users](../reference/field-types/users.md)

Additionally, the [link field](../reference/field-types/link.md) uses the relations system to store references to assets, categories, and entries.

Addresses and global sets don’t have relational fields, in the traditional sense—the former are managed as nested elements, and the latter exist as static, singleton elements that can be queried by handle using the value of a dropdown field.

::: tip
[Eager-loading](../development/eager-loading.md) related elements _does_ make them available directly on the source element! Don’t worry about this just yet—let’s get comfortable with the default behavior, first.
:::

To output the list of ingredients for a recipe on the recipe’s page, you could do this (assuming the relational field handle is `ingredients`):

```twig
{# Fetch related elements by calling `.all()` on the relational field: #}
{% set ingredients = entry.ingredients.all() %}

{# Check if anything came back: #}
{% if ingredients|length %}
  <h3>Ingredients</h3>

  <ul>
    {# Loop over the results: #}
    {% for ingredient in ingredients %}
      <li>{{ ingredient.title }}</li>
    {% endfor %}
  </ul>
{% endif %}
```

Because `entry.ingredients` is an element query, you can set additional constraints before executing it:

```twig
{# Narrow the query to only “Vegetables”: %}
{% set veggies = entry.ingredients.foodGroup('vegetable').all() %}

<h3>Vegetables</h3>

{% if veggies|length %}
  <ul>
    {% for veggie in veggies %}
      <li>{{ veggie.title }}</li>
    {% endfor %}
  </ul>
{% else %}
  <p>This recipe has no vegetables!</p>
{% endif %}
```

This query will display ingredients attached to the current recipe that _also_ have their `foodGroup` field (perhaps a [Dropdown](../reference/field-types/dropdown.md)) set to `vegetable`. Here’s another example using the same schema—but a different [query execution method](../development/element-queries.md#executing-element-queries)—that lets us answer a question that some cooks might have:

```twig
{% set hasMeat = entry.ingredients.foodGroup(['meat', 'poultry']).exists() %}

{% if not hasMeat %}
  <span class="badge">Vegetarian</span>
{% endif %}
```

::: tip
Each relational field type will return a different type of element query. _Entries_ fields produce an entry query; _Categories_ fields produce a category query; and so on.
:::

### The `relatedTo` Parameter

The `relatedTo` parameter on every [element query](../development/element-queries.md) allows you to narrow results based on their relationship to an element (or multiple elements).

Any of the following can be used when setting up a relational query:

- A single **element object**: <craft5:craft\elements\Asset>, <craft5:craft\elements\Category>, <craft5:craft\elements\Entry>, <craft5:craft\elements\User>, or <craft5:craft\elements\Tag>
- A single **element ID**
- A [**hash**](../development/twig.md#hashes) with properties describing specific constraints on the relationship:
  - Required: `element`, `sourceElement`, or `targetElement`
  - Optional: `field` and `sourceSite`
- An [**array**](../development/twig.md#arrays) of the above options, with an optional operator in the first position:
  - The string `and`, to return relations matching _all_ conditions rather than _any_;
  - The string `or`, to return relations that match _any_ conditions (default behavior, can be omitted);

See [complex relationships](#complex-relationships), below, for detailed information about the capabilities of hash and array syntaxes.

::: tip
Chaining multiple `relatedTo` parameters on the same element query will overwrite earlier ones. Use [`andRelatedTo`](#the-andrelatedto-parameter) to append relational constraints.
:::

### The `andRelatedTo` Parameter

Use the `andRelatedTo` parameter to join multiple sets of relational criteria together with an `and` operator. It accepts the same arguments as `relatedTo`, and can be supplied any number of times.

::: warning
There is one limitation, here: multiple `relatedTo` criteria using `or` *and* `and` operators cannot be combined.
:::

### The `notRelatedTo` and `andNotRelatedTo` Parameters

Find entries that _aren’t_ related to one or more elements with the `not*` relational query methods. This can be combined with the `relatedTo` parameter.

```twig{3-4}
{% set ketoRecipes = craft.entries()
  .section('recipes')
  .relatedTo(fish)
  .notRelatedTo(gluten)
  .all() %}
```

## Simple Relationships

The most basic relational query involves passing a single element or element ID. Here, we’re looking up other recipes that use the current one’s main protein:

```twig
{# Grab the first protein in the recipe: #}
{% set protein = entry.ingredients.foodGroup('protein').one() %}

{% set similarRecipes = craft.entries()
  .section('recipes')
  .relatedTo(protein)
  .all() %}
{# -> Recipes that share `protein` with the current one. #}
```

Passing an array returns results related to _any_ of the supplied elements. This means we could expand our criteria to search for other recipes with any crossover in proteins:

```twig
{# Note the use of `.all()`, this time: #}
{% set proteins = entry.ingredients.foodGroup('protein').all() %}

{% set moreRecipes = craft.entries()
  .section('recipes')
  .relatedTo(proteins)
  .all() %}
{# -> Recipes that share one or more proteins with the current one. #}
```

Passing `and` at the beginning of an array returns results relating to *all* of the supplied items:

```twig
{% set proteins = entry.ingredients.foodGroup('protein').all() %}

{% set moreRecipes = craft.entries()
  .section('recipes')
  .relatedTo(['and'] | merge(proteins))
  .all() %}
{# -> Recipes that also use all this recipe’s proteins. #}
```

This is equivalent to `.relatedTo(['and', beef, pork])`, if you already had variables for `beef` and `pork`.

## Compound Criteria

Let’s look at how we might combine multiple relational criteria:

```twig
{# A new relational field for recipes, tracking their origins: #}
{% set origin = entry.origin.one() %}
{% set proteins = entry.ingredients.foodGroup('proteins').all() %}

{% set regionalDishes = craft.entries()
  .section('recipes')
  .relatedTo([
    'and',
    origin,
    proteins,
  ])
  .all() %}
{# -> Recipes from the same region that share at least one protein. #}
```

You could achieve the same result as the example above using the `andRelatedTo` parameter:

```twig
{% set regionalDishes = craft.entries()
  .section('recipes')
  .relatedTo(origin)
  .andRelatedTo(proteins)
  .all() %}
```

::: warning
These examples _may_ return the recipe you’re currently viewing. Exclude a specific element from results with the `id` param: `.id(['not', entry.id])`.
:::

## Complex Relationships

All the `relatedTo` examples we’ve looked at assume that the only place we’re defining relationships between recipes and ingredients is the _ingredients_ field. What if there were other fields on recipes that described “substitutions,” or “pairs with” and “clashes with” that might muddy our related recipes? What if an ingredient had a “featured seasonal recipe” field?

Craft lets you be specific about the location and direction of relationships when using relational params in your queries. The following options can be passed to `relatedTo` and `andRelatedTo` as a [hash](../development/twig.md#hashes):

### Sources and Targets

Property
:  One of `element`, `sourceElement`, or `targetElement`

Accepts
:  Element ID, element, [element query](../development/element-queries.md), special `:empty:` or `:notempty:` tokens, or an array thereof

Description
:  - Use `element` to get results on either end of a relational field (source _or_ target);
:  - Use `sourceElement` to return elements selected in a relational field on the provided element(s);
:  - Use `targetElement` to return elements that have the provided element(s) selected in a relational field.

One way of thinking about the difference between `sourceElement` and `targetElement` is that specifying a _source_ is roughly equivalent to using a field handle:

```twig
{% set ingredients = craft.entries()
  .section('ingredients')
  .relatedTo({
    sourceElement: recipe,
  })
  .all() %}
{# -> Equivalent to `recipe.ingredients.all()`, from our very first example! #}
```

The special `:notempty:` and `:empty:` tokens allow you to query for elements that are related (or _not_ related) to _any_ other element. These can be combined with [field](#fields) and [site](#sites) conditions.

### Fields

Property
:  `field` (Optional)

Accepts
:  Field handle, field ID, or an array thereof.

Description
:  Limits relationships to those defined via one of the provided fields.

Suppose we wanted to recommend recipes that use the current one’s alternate proteins—but as main ingredients, not substitutions:

```twig
{% set alternateProteins = recipe.substitutions.foodGroup('protein').all() %}

{% set recipes = craft.entries()
  .section('recipes')
  .relatedTo({
    targetElement: alternateProteins,
    field: 'ingredients',
  })
  .all() %}
```

By being explicit about the field we want the relation to use, we can show the user recipes that don’t rely on substitutions to meet their dietary needs.

::: warning
The `field` param does not honor handles overridden in a field layout. Craft doesn’t know until elements are actually loaded which field layouts are relevant.
:::

### Sites

Property
:  `sourceSite` (Optional, defaults to main query’s site)

Accepts
:  [Site](craft5:craft\models\Site) object, site ID, or site handle.

Description
:  Limits relationships to those defined from the supplied site(s).
:  In most cases, you won’t need to set this explicitly. Craft’s default behavior is to look for relationships only in the site(s) that the query will return elements for.

::: warning
Only use `sourceSite` if you’ve designated your relational field to be translatable.
:::

What if our recipes live on an international grocer’s website and are localized for dietary tradition? We can still provide results that make sense for a variety of cooks:

```twig
{% set proteins = recipe.ingredients.foodGroup('protein').all() %}

{% set recipes = craft.entries()
  .section('recipes')
  .relatedTo([
    'or',
    {
      targetElement: proteins,
      field: 'ingredients',
    },
    {
      targetElement: proteins,
      sourceSite: null,
      field: 'substitutions',
    },
  ])
  .all() %}
{# -> Recipes that share regionally-appropriate proteins, *or* that can be adapted. #}
```

Here, we’re allowing Craft to look up substitutions defined in any site, which might imply a recipe can be adapted.

## Relations via Matrix

Relational fields on nested entries within Matrix fields are used the same way they would be on any other element type.

If you want to find elements related to a source element through a [Matrix](../reference/field-types/matrix.md) field, pass the Matrix field’s handle to the `field` parameter:

```twig{5}
{% set relatedRecipes = craft.entries()
    .section('recipes')
    .relatedTo({
        targetElement: ingredient,
        field: 'ingredients'
    })
    .all() %}
```

In this example, we’ve changed our schema a bit: ingredients are now attached to nested entries in a `steps` Matrix field, so we can tie instructions and quantities or volume to each one. We still have access to all the same relational query capabilities!

We’ve also specified a field handle, to ensure that the relationships are defined through the intended field; if nested entries have multiple relational fields, it’s possible to get “false positive” results!
</file>

<file path="system/routing.md">
# Routing

Routing is the process by which Craft directs incoming requests to specific content or functionality.

Understanding Craft’s high-level approach to routing can help you troubleshoot template loading, plugin action URLs, dynamic routes, and unexpected 404 errors. While this list is an abstraction, it represents the order of Craft’s internal checks:

0. **Should Craft handle this request in the first place?**

    It’s important to keep in mind that Craft doesn’t get involved for *every* request that touches your server—just those that go through your `index.php`.

    The `.htaccess` file that [comes with Craft](https://github.com/craftcms/craft/blob/5.x/web/.htaccess) will silently send all requests that don’t match a directory or file on your web server via `index.php`. If you point your browser directly at a file that *does* exist (such as an image, CSS, or JavaScript file), your web server will serve that file directly, without initializing Craft or PHP.

1. **Is it an action request?**

    [Action requests](../reference/controller-actions.md) either have a path that begins with `/actions/` (or whatever your <config5:actionTrigger> config setting is set to), or an `action` parameter in the POST body or query string. Every request Craft handles is ultimately routed to a controller action, but explicit action requests take precedence and guarantee that essential features are always accessible. If you look at your browser’s _Network_ tab while using the control panel, you’ll see a lot of action requests, like `/index.php?action=users/session-info`.

2. **Is it an element request?**

    If the URI matches an [element](elements.md)’s URI, Craft lets the element decide how to route the request. For example, if an [entry](../reference/element-types/entries.md)’s URI is requested, Craft will render the template specified in its section’s settings, automatically injecting an [`entry` variable](../reference/twig/global-variables.md#other-elements). Only elements that are enabled and [live](drafts-revisions.md#statuses-visibility) are eligible for matching in this way.

    Whenever an element is saved, its URI is rendered and stored in the `elements_sites` database table.

    ::: tip
    Modules and plugins can re-map an element’s route to a custom controller using the [EVENT_SET_ROUTE](craft5:craft\base\Element::EVENT_SET_ROUTE) event to gather and organize additional data, or output it as a different content-type.
    :::

3. **Does the URI match a route or rule?**

    If the URI matches any [dynamic routes](#dynamic-routes) or [URI rules](#advanced-routing-with-url-rules), the template or controller action specified by it will get loaded.

4. **Does the URI match a template?**

    Craft will check if the URI is a valid [template path](../development/templates.md#template-paths). If it is, Craft will render the matched template.

    ::: tip
    If any of the URI segments begin with an underscore (e.g. `blog/_archive/index`), Craft will skip this step. Similarly, [hidden templates](../development/templates.md#hidden-templates) are not matched.
    :::

5. **404**

    If none of the above criteria are met, Craft will throw a [NotFoundHttpException](yii2:yii\web\NotFoundHttpException).

6. **Redirects** <Since ver="5.6.0" feature="Redirection rules" />

    When a 404 exception is thrown, Craft does one final check for a matching [redirect](#redirection) rule. If one is found, the exception is dropped and a 300-level response is sent.

::: warning
If an exception is thrown at any point during a request, Craft will display an error page instead of the expected content.

If [Dev Mode](config5:devMode) is enabled, an error report for the exception will be shown. Otherwise, an error will be returned using either your [custom error template](#error-templates) or Craft’s own default.
:::

## Dynamic Routes

In some cases, you may want a URL to load a template, but its location in your `templates/` folder doesn’t agree with the URI (therefore bypassing step #4), or the URI itself is “dynamic” or parameterized.

A good example of this is a yearly archive page, where you want a year to be one of the segments in the URL (e.g. `blog/archive/2018`). Creating a static route or template for every year would be impractical—instead, you can define a single route with placeholders for dynamic values:

![Creating a New Route](../images/routing-creating-new-route.png)

### Creating Routes

To create a new Route, go to <Journey path="Settings, Routes" /> and choose **New Route**. A modal window will appear where you can define the route settings:

- What should the URI look like?
- Which template should get loaded?

The first setting can contain “tokens”, which represent a range of possible matches, rather than a specific string. (The `year` token, for example, represents four consecutive digits.) When you click on a token, Craft inserts it into the URI setting wherever the cursor is.

If you want to match URIs that look like `blog/archive/2018`, type `blog/archive/` into the URI field and choose the `year` token.

::: tip
Route URIs should _not_ begin with a slash (`/`).
:::

After defining your URI pattern and entering a template path, press **Save**. The modal will close, revealing your new route on the page.

When you point your browser to `https://my-project.tld/blog/archive/2018`, it will match your new route, and Craft will load the specified template with value of the `year` token automatically available in a variable called `year`:

```twig
{# Fetch posts in the specified `year`: #}
{% set posts = craft.entries()
  .section('posts')
  .postDate([
    'and',
    ">= #{year}",
    "< #{year + 1}",
  ])
  .all() %}

{% for post in posts %}
  <article>
    <h2>{{ post.title }}</h2>
    {{ post.description | md }}
    <a href="{{ post.url }}">{{ 'Read More' | t }}</a>
  </article>
{% endfor %}
```

::: tip
Routes automatically support [pagination](../reference/twig/tags.md#paginate), so this one route covers other URIs like `/blog/archive/2018/page/2` (assuming your <config5:pageTrigger> was `page/`). If you wanted to break the archive into smaller logical chunks, you could use additional [tokens](#available-tokens) to collect results by month—or even by day!
:::

### Available Tokens

The following tokens are available to the URI setting:

- `*` – Any string of characters, except for a forward slash (`/`)
- `day` – Day of a month (`1`-`31` or `01`-`31`)
- `month` – Numeric representation of a month (1-12 or 01-12)
- `number` – Any positive integer
- `page` – Any positive integer
- `uid` – A v4 compatible UUID (universally unique ID)
- `slug` – Any string of characters, except for a forward slash (`/`)
- `tag` – Any string of characters, except for a forward slash (`/`)
- `year` – Four consecutive digits

::: tip
If you define a route using a wildcard token (`*`) in the control panel, it will automatically be available as a named parameter called `any`.

![Screenshot of Create a new route control panel form with wildcard token](../images/route-with-wildcard-token.png =400x300)

The template for `my-project.tld/foo/some-slug` could then use `{{ any }}`:

```twig
It seems you’re looking for `{{ any }}`.
{# output: It seems you’re looking for `some-slug`. #}
```
:::

## Advanced Routing with URL Rules

In addition to routes defined via the control panel, you can define [URL rules](guide:runtime-routing#url-rules) in `config/routes.php`.

```php
return [
  // Route blog/archive/YYYY to a controller action
  'blog/archive/<year:\d{4}>' => 'controller/action/path',

  // Route blog/archive/YYYY to a template
  'blog/archive/<year:\d{4}>' => ['template' => 'blog/_archive'],
];
```

If your Craft installation has multiple sites, you can create site-specific URL rules by placing them in a sub-array, and set the key to the site’s handle. Craft will take care of determining the site’s base URL via this handle, so you don’t need to declare it as part of the route pattern itself.

```php
return [
  'siteHandle' => [
    'blog/archive/<year:\d{4}>' => 'controller/action/path',
  ],
];
```

A subset of the [tokens](#available-tokens) above can be used within the regular expression portion of your [named parameters](guide:runtime-routing#named-parameters):

- `{handle}` – matches a field handle, volume handle, etc.
- `{slug}` – matches an entry slug, category slug, etc.
- `{uid}` – matches a v4 UUID.

```php
return [
  // Be aware that URIs matching an existing element route will be picked up by step #2, above!
  'blog/<entrySlug:{slug}>' => 'controller/action/path',
];
```

### Accessing Named Parameters in your Templates

URL rules that route to a template (`['template' => 'my/template/path']`) will pass any named parameters to the template as variables—just like CP-defined routes. For example, this rule…

```php
'blog/archive/<year:\d{4}>' => ['template' => 'blog/_archive'],
```

…will load `blog/_archive.twig` with a `year` variable set to `2022` when requesting `https://my-project.tld/blog/archive/2022`.

```twig
<h1>Blog Entries from {{ year }}</h1>
```

### Accessing Named Parameters in your Controllers

Named route parameters are automatically passed to matching controller action arguments.

For example, this URL rule…

```php
'comment/<postId:\d+>' => 'my-module/blog/comment',
```

…would match the numeric ID in the route to the `$id` argument of this [custom controller](../extend/controllers.md) action:

```php
namespace modules\controllers;

use craft\elements\Entry;
use craft\web\Controller;

class BlogController extends Controller
{
  /**
   * Create a comment for the specified blog post ID.
   * 
   * @param int $postId Blog Post ID defined by route parameters.
   */
  public function actionComment(int $postId)
  {
    $this->requirePostRequest();

    // Use the ID to look up the entry...
    $entry = Entry::find()
      ->section('posts')
      ->id($postId)
      ->one();

    // ...and grab the comment content from the request:
    $comment = Craft::$app->getRequest()->getBodyParam('comment');

    // ...
  }
}
```

This rule only serves as an alias to the controller action, which will always be directly accessible via an [action request](../development/forms.md)—in this case by using the [`actionInput()`](../reference/twig/functions.md#actioninput) function:

```twig
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('my-module/blog/comment') }}
  {{ hiddenInput('postId', entry.id) }}

  <textarea name="comment"></textarea>

  <button>Post Comment</button>
</form>
```

## Error Templates

You can provide your own error templates for Craft to use when returning errors on the front end.

When an error is encountered, Craft looks in your `templates/` directory for a template matching these criteria (in order):

1. …a template matching the error’s status code, like `404.twig`;
2. …(for 503 errors) a template named `offline.twig`;
3. …a generic template named `error.twig`;

::: tip
You can tell Craft to look for the error template in a nested template directory, using the <config5:errorTemplatePrefix> config setting. Using `_errors/` would mean that the above rules check `_errors/404.twig`, `_errors/offline.twig`, and `_errors/error.twig`.
:::

If Craft finds a matching error template, it will render it with the following variables:

- `message` – error message
- `code` – exception code
- `file` – file that threw the exception
- `line` – line in which the exception occurred
- `statusCode` – error’s HTTP status code

::: tip
Custom error templates are only used when [Dev Mode](config5:devMode) is **disabled**. When it’s enabled, an exception view will be rendered instead. Note that `devMode` may also be set via the `CRAFT_DEV_MODE` [environment override](../configure.md#environment-overrides)!

Logged-in control panel users can enable **Show full exception views when Dev Mode is disabled** in their [preferences](user-management.md).
:::

If Craft _can’t_ find an appropriate template, it renders the built-in front-end error template. This view can be customized via CSS using the <config5:systemTemplateCss> config setting. 
Full reference for the CSS variables used on this page are [available in the source](https://github.com/craftcms/cms/blob/5.x/src/web/assets/theme/dist/fe.css). <Since ver="5.6.0" feature="Customizable front-end error templates" />

### Redirection <Since ver="5.6.0" feature="Redirects config file" />

Craft also supports a `redirects.php` config file that can contain any number of rules, structured similarly to the [advanced routing](#advanced-routing-with-url-rules) examples, above. Redirects are only evaluated after Craft decides it can’t serve the request and begins handling the HTTP exception.

Each item in the returned array is a “rule,” and rules are evaluated from top to bottom. The simplest rule is a case-insensitive mapping from one path to another:

```php
return [
    'old/path' => 'new/path',
];
```

This key-value syntax is equivalent to explicitly declaring a `from` and `to` key in the rule:

```php
return [
    [
        'from' => 'old/path',
        'to' => 'new/path',
    ],
];
```

When using an array, you may also include `caseSensitive` and `statusCode` keys for more control over the rule’s behavior:

```php
return [
    [
        'from' => 'old/path',
        'to' => 'new/path',
        'caseSensitive' => true,
        // Defaults to 302 (“Temporary”)
        'statusCode' => 301, // “Permanent”
    ],
];
```

::: tip
To send a user to the homepage, use an empty string (`''`) for the `to` value.
:::

Rules can contain [parameters](#advanced-routing-with-url-rules), as well:

```php
return [
  'posts/<year:\d{4}>/<slug:{slug}>' => 'news/<year>-<slug>',
];
```

Named parameters can be used in the `to` value by wrapping them in angle brackets, like `<year>` and `<slug>` in this example.

If you need complete control over the matching _and_ redirection logic, create a rule with a `match` key, set to a closure:

```php
return [
    [
        'match' => function (\Psr\Http\Message\UriInterface $url): ?string {
            // Match a path:
            if ($url->getPath() !== 'customer_order.aspx') {
                return null;
            }

            // Or test for the presence of a query parameter:
            parse_str($url->getQuery(), $params);

            if (!isset($params['orderId'])) {
                return null;
            }

            return sprintf('account/orders/%s', $params['orderId']);
        },
        'statusCode' => 301,
    ],
];
```

You may return `null` from a match callback to skip the rule and continue processing. Callbacks are only invoked if all previous rules fail to match.

#### Multi-Site Redirection

Unlike routes, redirection rules are processed globally, and matched against full paths. For example, a rule like `old/page` would _not_ catch a request path beginning with a site’s base path, like `/secondary-site/old/page`. You may parameterize rules to match multiple sites’ base paths (i.e: `<site:{slug}>/old/page`), or define individual rules for each relevant site.

However, as part of Craft’s normal routing behavior, every front-end request is handled in the context of a site—typically one with the correct hostname and the longest matching base path, or the “default” site when none match. When a redirect rule is evaluated, its `to` value is treated as site-relative, meaning this rule…

```php
return [
    'corporate/team' => 'about-us',
];
```

…behaves differently depending on whether or not a site exists with the base path `corporate`. _Without_, it would redirect normally (`/corporate/team` to `/about-us`), but _with_, requests to `/corporate/team` would actually end up at `/corporate/about-us`, because Craft tried to route the request in the “Corporate” site context.

To avoid this ambiguity, prefix the destination with a slash (`/`) to make it an “absolute” path:

```php
return [
    'corporate/team' => '/about-us',
];
```
</file>

<file path="system/searching.md">
# Searching

Craft includes a system-wide search index used for finding elements via keywords. Search is supported wherever you see this field in the [control panel](./control-panel.md):

![Search Bar](../images/search-bar.png)

Anything you type into this bar is also a valid query when [searching from code](#development):

::: code
```twig
{% set results = craft.entries()
  .search('foo')
  .all() %}
```
```graphql
{
  entries(search: "foo") {
    title
  }
}
```
```php
$results = \craft\elements\Entry::find()
    ->search('foo')
    ->all();
```
:::

## Supported Syntaxes

Craft supports the following syntax wherever you happen to search from:

Searching for… | will find elements…
-|-
`salty` | with any attribute or field containing “salty”.
`salty dog` | with any *single* attribute or field containing both “salty” and “dog”.
`salty OR dog` | with attributes or fields containing either “salty” or “dog” (or both).
`salty -dog` | with any *single* attribute or field containing “salty” but not “dog”.
`"salty dog"` | with any *single* attribute or field containing the exact phrase “salty dog”.
`body:salty` | where the `body` field contains “salty”.
`body:salty body:dog` | where the `body` field contains both “salty” and “dog”.
`body:salty OR body:dog` | where the `body` field contains either “salty” or “dog”.
`body:salty -body:dog` | where the `body` field contains “salty” but not “dog”.
`body:"salty dog"` | where the `body` field contains the exact phrase “salty dog”.
`body::salty` | where the `body` field is set to “salty” and nothing more.
`body::"salty dog"` | where the `body` field is set to “salty dog” and nothing more.

::: tip
If you are not seeing the expected results, make sure your field is [set up for indexing](#configuring-custom-fields-for-search) and that the index has been [rebuilt](#rebuilding-your-search-indexes) to reflect those changes.
:::

Searches are tokenized into *terms* for matching and [scoring](#scoring-algorithm). Without any special modifiers (quotes, operators, or attributes), a query is assumed to be a single term, meaning all words must be present within the same attribute to match.

For example, the query `salty dog` matches elements with both words in the same attribute or field, but _not_ elements with `salty` in one field and `dog` in another. The order of individual words is not enforced, unless the term appears in quotes.

When a query is tokenized into multiple terms, Craft treats them as through they were joined by an implicit `AND` operator.

### Wildcard Syntax

You can use a wildcard character (`*`) to modify search behavior:

Searching for… | will find elements…
-|-
`*ty` | containing a word that ends with “ty”.
`*alt*` | containing a word that contains “alt”.
`body:*ty` | where the `body` field contains a word that ends with “ty”.
`body:*alt*` | where the `body` field contains a word that contains “alt”.
`body::salty*` | where the `body` field begins with “salty”.
`body::*dog` | where the `body` field ends with “dog”.
`body:*` | where the `body` field contains any value.
`-body:*` | where the `body` field is empty.

::: tip
Use the [`defaultSearchTermOptions`](config5:defaultSearchTermOptions) config setting to adjust default search behavior.
:::

## Searching for Specific Element Attributes

Assets, categories, entries, users, and tags each support their own set of additional attributes to search against:

Element | Additional Search Attributes
-|-
Assets | `filename`<br>`extension`<br>`kind`
Categories | `title`<br>`slug`
Entries | `title`<br>`slug`
Users | `username`<br>`firstname`<br>`lastname`<br>`fullname` (firstname + lastname)<br>`email` 
Tags | `title`

::: warning
Searching is a great way to quickly find content by keywords—but the most reliable way to directly query against attributes and custom fields is via the element type’s [query parameters](../development/element-queries.md#types--parameters).
:::

### Element-Specific Attribute Search Examples

If you wanted to search only for [Assets](../reference/element-types/assets.md) that are *images*, it would look like this in the control panel:

![Searching for image assets in the control panel](../images/search-assets-by-kind.png)

The same search from your code:

::: code
```twig
{% set images = craft.assets()
  .search('kind:image')
  .all() %}
```

```graphql
{
  images: assets(search: "kind:image") {
    title
  }
}
```

```php
$images = \craft\elements\Asset::find()
    ->search('kind:image')
    ->all();
```
:::

::: tip
Querying elements by specific attribute or field values is more efficient when using dedicated methods. The above is equivalent to:

```twig
{% set images = craft.assets()
  .kind('image')
  .all() %}
```

This can still be combined with keyword search, and will often support more explicit and flexible [arguments](../reference/element-types/assets.md#kind).
:::

If you were to search for Users with email addresses ending in `@craftcms.com`, it would look like this in the control panel:

![Searching for users by email in the control panel](../images/search-users-by-email.png)

The same search from your code:

::: code
```twig
{% set users = craft.users()
  .search('email:@craftcms.com')
  .all() %}
```

```graphql
{
  users(search: "email:@craftcms.com") {
    title
  }
}
```

```php
$images = \craft\elements\User::find()
    ->search('email:@craftcms.com')
    ->all();
```
:::

As with the first example, this query could be simplified with the native [`.email()`](../reference/element-types/users.md#email) query param:

```twig
{% set team = craft.users()
  .email('*@craftcms.com')
  .all() %}
```

## Search Filters

Clicking the icon inside the right edge of the search field opens a filter HUD:

![Screenshot of open search filter with an example Post Date rule with a begin and end date](../images/search-with-filter.png)

You can add any number of conditions to further limit search results by those criteria.

## Development

`craft.assets()`, `craft.entries()`, `craft.tags()`, and `craft.users()` support a `search` parameter you can use to filter their elements by a given search query.

Queries don’t have to be static, though—suppose you wanted to let users define keywords:

::: code
```twig
{# Get the user’s search query from the 'q' query string param #}
{% set searchQuery = craft.app.request.getQueryParam('q') %}

{# Fetch entries that match the search query #}
{% set results = craft.entries()
  .search(searchQuery)
  .all() %}
```
```php
// Get the user’s search query from the 'q' query string param
$searchQuery = Craft::$app->getRequest()->getParam('q');

// Fetch entries that match the search query
$results = \craft\elements\Entry::find()
    ->search($searchQuery)
    ->all();
```
:::

::: tip
See our [Search Form](kb:search-form) article for a complete example of listing dynamic search results.
:::

When using the `search` param and [ordering the results by score](#ordering-results-by-score), each returned element will be have its [`searchScore`](#scoring-algorithm) attribute populated with a value representing how well the query matched.

Passing user input to the `search` param is generally safe, but may allow discovery or enumeration of otherwise hidden field values. For instance, a savvy user might supply a query like `myPrivateNotesField:"*"` to test whether a field exists or has a specific value. _Carefully auditing which if your fields are [indexed](#configuring-custom-fields-for-search) will help prevent unwanted disclosure._

### Ordering Results by Score

Pass the special `'score'` value to order results from best-match to worst-match:

::: code
```twig
{% set results = craft.entries()
  .search('foo')
  .orderBy('score')
  .all() %}
```
```graphql
{
  entries(search: "foo", orderBy: "score") {
    title
  }
}
```
```php
$results = \craft\elements\Entry::find()
    ->search('foo')
    ->orderBy('score')
    ->all();
```
:::

Keep in mind that unlike most other columns, the implicit order for `score` is _descending_. If you need to invert the order for any reason, explicitly pass `score ASC`, or use the `inReverse()` method.

#### Scoring Algorithm

Craft uses its own algorithm to score search results, which takes into consideration each “term” from the query and the complete text of a matched attribute.

1. All scores start at zero.
1. Scores for an element are totaled across rows.
1. Rows are scored against individual terms, using a weight of `1`.
    - Explicit “exact attribute” matches (terms using double-colons `::`) do not contribute to scores, as every result is a known match, already;
    - A base score is determined by how many times a term appears in a row’s keywords;
    - Base scores are divided by the number of keywords in a row;
    - Regular matches are given a 50x multiplier;
    - Partial-word matches get a 10x multiplier;
    - Coincidental exact matches are given a 100x multiplier;
    - Matches for the `title` attribute are given an additional 5x multiplier;
1. Rows are scored against term groups (using the `OR` operator), wherein the weight of each term is divided by the number of terms in the group. Otherwise, scores are calculated the same as individual terms.
1. A row’s total score is the sum of its individual term and grouped term scores.

For example, if we had two entries titled “Salty Dog” and “Greyhound” (both of which mention the _Greyhound_ in a custom field), a search for “greyhound” would be scored like this:

Title + Content | Scores | Rounded Total
--- | --- | ---
**Salty Dog** <br> A salty dog is a cocktail of gin, or vodka, and grapefruit juice, served in a highball glass with a salted rim. The salt is the only difference between a salty dog and a <u>greyhound</u>. <br> [Source](https://en.wikipedia.org/wiki/Salty_dog_(cocktail)) | **Body:** 1 match in 35 words, 50x multiplier | **1**
**Greyhound** <br> A <u>greyhound</u> is a cocktail consisting of grapefruit juice and gin mixed and served over ice. If the rim of the glass has been salted, the drink is instead called a salty dog. <br> [Source](https://en.wikipedia.org/wiki/Greyhound_(cocktail)) | **Title:** 1 match in 1 word, 5x title multiplier, 100x exact match multiplier<br>**Body:** 1 match in 33 words, 50x multiplier | **502**

This is an extreme example—but it shows how quickly exact or near-exact matches can rise to the top of searches. As an exercise, try scoring a search for “salt” against the above content!

## Configuring Custom Fields for Search

Each element type makes basic details, called _searchable attributes_, available as search keywords. It’s common to search for entries by title, for example, or for users by their name or email address. (We just looked at these in the [Searching for Specific Element Attributes](#searching-for-specific-element-attributes) table.)

You can configure any [custom field](fields.md) to make its content available for search by enabling **Use this field’s values as search keywords**:

![Searchable Checkbox](../images/searchable-checkbox.png)

Indexes are only updated once an element with the field is saved. If you have a large amount of content and users (admin or otherwise) rely heavily on search, consider [resaving the elements](#rebuilding-your-search-indexes) to populate the index.

::: tip
For Matrix fields, the top-level **Use this field’s values as search keywords** setting determines whether _any_ sub-fields will factor into results for the parent—individual fields must also opt-in to indexing for any keywords to be bubbled up.

For relational fields like [Assets](../reference/field-types/assets.md), [Categories](../reference/field-types/categories.md), and [Entries](../reference/field-types/entries.md), the setting determines whether titles of related elements should factor into search results.
:::

### Multi-Instance Fields

When a field is marked as searchable, keywords for _all_ instances of that field on an element are combined into a single index, and their handles are treated as aliases. For example, a  [plain text](../reference/field-types/plain-text.md) field added to a field layout multiple times (with, say, handles `summary` and `byline`), Craft does not distinguish which field instance the keywords came from—this means that [searching against specific element attributes](#searching-for-specific-element-attributes) may produce unexpected results:

- Searching for `summary:daisy` may return entries that included the name _Daisy_ in the `byline`;
- Searching for `byline:rose` may return entries that mention the flower _rose_ in their `summary`;

::: tip
If your application relies on distinct keywords, create individual fields.
:::

## Indexing Criteria

Any time an indexable attribute or field on an element is updated (as indicated by Craft’s change-tracking feature, which powers drafts and revisions), an “Updating search indexes” job is pushed into the queue. Prior versions generate an indexing job whenever an element with _any_ searchable attributes or fields is saved, regardless of whether or not those specific attributes changed.

The [eligible properties](#searching-for-specific-element-attributes) differ for each element type, the field layout a given element uses, and which of the underlying fields are flagged as searchable.

## Searching Nested Elements

In Craft 5, [entry queries](../reference/element-types/entries.md#querying-entries) return nested elements, by default. To search only for entries that belong to a section (those that are not owned by another entry), use the `.section()` param:

```twig
{% set results = craft.entries()
  .section(['news', 'resources'])
  .search(terms)
  .orderBy('score')
  .all() %}
```

If you want entries in _any_ section, and would prefer to not maintain a list of specific sections (or _excluded_ sections, with `.section(['not', 'home', 'suppliers'])`) in your template, pass an asterisk <Since ver="5.2.0" feature="Querying for non-nested entries with the special “section wildcard”" /> (`*`):

```twig{2}
{% set results = craft.entries()
  .section('*')
  .search(terms)
  .orderBy('score')
  .all() %}
```

## Rebuilding Your Search Indexes

Craft does its best to keep its search indexes as up-to-date as possible, but there are a couple things that might render portions of them inaccurate. If you suspect your search indexes are out of date, you can have Craft rebuild them by bulk-resaving entries with the [`resave/entries`](../reference/cli.md#resave) command and including the `--update-search-index` flag:

```bash
php craft resave/entries --update-search-index
```

You can specify which entries should be resaved with the `--section` and `--type` options, among others. Run `craft help resave/entries` to see all supported options, or `craft help resave` for a list of commands for resaving other element types.

## Extending Search

You can modify both the indexing and scoring of results, programmatically.

### Customizing the Index

Craft generates keywords for element attributes and custom fields based on its understanding of their data types. Each [element](elements.md) and [field](fields.md) type also have an opportunity to customize keywords: Assets index their `filename`, `extension`, and `kind` attributes; [relational fields](relations.md) load the attached elements and concatenate their titles.

Keywords can come in virtually any form, because Craft [normalizes](craft5:craft\helpers\Search::normalizeKeywords()) them before adding them to the index. You can supplant or augment keywords (or index additional attributes—real or virtual) by listening to specific search events.

::: danger
Do not modify records in the `searchindex` table, directly. Rows are cleared and rebuilt every time an element is saved, so changes made outside of the normal indexing process will be lost.
:::

#### Different Keywords

To replace keywords for an existing attribute or field (or prevent something from being indexed, entirely), listen for the <craft5:craft\services\Search::EVENT_BEFORE_INDEX_KEYWORDS> event:

```php
use yii\base\Event;
use craft\services\Search;
use craft\events\IndexKeywordsEvent;
use craft\helpers\StringHelper;

Event::on(
    Search::class,
    Search::EVENT_BEFORE_INDEX_KEYWORDS,
    function(IndexKeywordsEvent $e) {
        // Element being indexed:
        $element = $e->element;

        // Current attribute name:
        $attribute = $e->attribute;

        // Field ID, if indexing a custom field:
        $fieldId = $e->fieldId;

        // Keywords that will be indexed:
        $keywords = $e->keywords;

        // Overwrite the keywords (say, to remove common typos)...
        $e->keywords = StringHelper::replaceAll($e->keywords, ['speling', 'wirds', 'typox'], '', false);

        // ...or outright prevent something from being added to the index:
        if (StringHelper::contains($e->keywords, 'naughty words', false)) {
            $e->isValid = false;
        }
    }
);
```

At this point, `$e->keywords` is a space-separated list of terms, ready to be inserted into the index.

#### Additional Attributes

Adding searchable attributes is done via the <craft5:craft\base\Element::EVENT_REGISTER_SEARCHABLE_ATTRIBUTES> and <craft5:craft\base\Element::EVENT_DEFINE_KEYWORDS> events:

```php
use yii\base\Event;
use craft\elements\Entry;
use craft\events\DefineAttributeKeywordsEvent;
use craft\events\RegisterElementSearchableAttributesEvent;

Event::on(
    Entry::class,
    Entry::EVENT_REGISTER_SEARCHABLE_ATTRIBUTES,
    function(RegisterElementSearchableAttributesEvent $e) {
      // Add a new `author` search attribute:
      $e->attributes[] = 'author';
    }
);

Event::on(
    Entry::class,
    Entry::EVENT_DEFINE_KEYWORDS,
    function (DefineAttributeKeywordsEvent $e) {
        if ($e->attribute === 'author') {
            // Let Craft know that we’ve been able to set custom keywords:
            $e->handled = true;

            // You can set almost anything as keywords, and let Craft figure out how to normalize it...
            $e->keywords = $e->sender->getAuthor();

            // ...or do something more explicit:
            if ($author = $e->sender->getAuthor()) {
                $e->keywords = $author->getFullName();
            }
        }
    }
);
```

Your custom search attributes don’t have to exist on an element to be indexed! As long as you handle the generation of keywords, Craft will treat them the same as any other attribute or custom field.

### Altering Scores

To alter the [search score](#scoring-algorithm) assigned by Craft, listen for the <craft5:craft\services\Search::EVENT_AFTER_SEARCH> event [from a plugin or module](../extend/events.md):

::: code
```php Basics
use yii\base\Event;
use craft\events\SearchEvent;
use craft\helpers\StringHelper;
use craft\services\Search;

Event::on(
    Search::class,
    Search::EVENT_AFTER_SEARCH,
    function(SearchEvent $e) {
        // Original ElementQuery instance:
        $elementQuery = $e->elementQuery;

        // SearchQuery instance, with parsed tokens:
        $query = $e->query;

        // Site(s) the search was performed in:
        $siteId = $e->siteId;

        // Raw index matches (there may be multiple rows per element):
        $results = $e->results;

        // Corresponding element score totals, indexed by element ID:
        $scores = $e->scores;
    }
);
```
```php Example A
use yii\base\Event;
use craft\events\SearchEvent;
use craft\helpers\StringHelper;
use craft\services\Search;

Event::on(
    Search::class,
    Search::EVENT_AFTER_SEARCH,
    function(SearchEvent $e) {
        // Boost a specific element’s score by overwriting its value in $e->scores:
        if (isset($e->scores[12345])) {
          $e->scores[12345] = $e->scores[12345] + 10000;
        }
    }
);
```
```php Example B
use yii\base\Event;
use craft\events\SearchEvent;
use craft\helpers\StringHelper;
use craft\services\Search;

Event::on(
    Search::class,
    Search::EVENT_AFTER_SEARCH,
    function(SearchEvent $e) {
        // Make sure a result is always present (and highest-ranked) when certain keywords are used (anywhere in the query):
        if (StringHelper::contains($e->query->getQuery(), 'salt', false)) {
          // Find the highest score, or use `0` if there were no natural results:
          $highestScore = max($e->scores ?: [0]);
          $e->scores[12345] = $highestScore + 1;
        }
    }
);
```
:::

::: tip
Keep in mind that element IDs may not be stable between environments, so you may need to look it up (with an [Element Query](../development/element-queries.md)) or store it as an environment variable!
:::
</file>

<file path="system/sites.md">
---
keywords: multi multisite multilingual translation localization
---

# Sites & Localization

A single Craft installation can power any number of websites.

Sites let you expand your presence to different domains, use unique [templates](#site-templates), and intelligently [localize content](#propagating-entries).

Craft’s multi-site feature is for sites with the same publishing team. You manage the multi-site content at the entry level, with the ability to enable sections you want included in a site.

::: warning
Craft’s multi-site feature is _not_ meant for managing multiple projects that have no relationship to one another. The Author experience is based on the assumption that some content is shared between them, and that users have some overlap in their capabilities or responsibilities.
:::

## Creating a Site

The first site is created when you install Craft, using the **Site Name** provided via the [setup GUI](kb:first-time-setup) or [CLI](../reference/cli.md#setup). Additional sites are created via <Journey path="Settings, Sites" />.


<BrowserShot
  url="https://my-craft-project.ddev.site/admin/sites/new"
  caption="Creating a new site in the Craft control panel."
  :link="false"
  :max-height="500">
  <img src="../images/site-new.png" alt="Creating a new site in the Craft control panel">
</BrowserShot>

### Site Groups

Site groups allow you to organize your sites together by commonality, like language or site type.

Craft creates the first site group for you (named after the site created during installation) and assigns the default site to that group.

In addition to organization, site groups can be used in conjunction with a section’s [**Propagation Method**](#propagating-entries), or in some fields’ **Translation Method** settings.

You can access the current site’s group information using `currentSite.group`:

```twig
{# @var currentSite craft\models\Site #}
Site ID:          {{ currentSite.id }}
Site Handle:      {{ currentSite.handle }}
Site Name:        {{ currentSite.name }}
Site Language:    {{ currentSite.language }}
Is Primary Site?: {{ currentSite.primary }}
Base URL:         {{ currentSite.baseUrl }}

{# @var siteGroup craft\models\SiteGroup #}
{% set siteGroup = currentSite.group %}
Site Group Name:  {{ siteGroup.name }}
```

### Language

Choosing the language for the site determines how Craft formats dates, times, and numbers, and which [static message translations](#static-message-translations) are used, in the front-end.

In your templates, you can access the current site’s language setting via `craft.app.language`:

```twig{1}
<html lang="{{ craft.app.language }}">
  <head>
    <title>{{ siteName }}</title>
  </head>
  <body>
    {# ... #}
  </body>
</html>
```

::: tip
The current language can be used to conditionally display certain parts of a page—or you can create [site-specific templates](#site-templates) in your `templates/` directory.
:::

### Primary Site

Craft sets the default site (created during installation) as the **Primary** site, meaning Craft will load it by default on the front end, if it is unable to determine which site to load. If you only have one site then you cannot disable it as the Primary site.

You can change the primary site once you’ve created at least one other—Craft internally makes sure that only one site is marked as primary at any given time.

### Site URL

Each site has a **Base URL** that determines how Craft routes and generates links.

Multiple sites can share the same hostname and be distinguished by path (like `https://craftcms.com/` and `https://craftcms.com/de/`), or they can have different hostnames entirely (like `https://craftcms.com/` and `https://de.craftcms.com/`).

If you want to create a site with a different hostname, you must configure your server to handle traffic for it. The hostname can either point to the same web root as your current site, or its own web root (with unique `.htaccess` and/or entry script).

::: tip
If you have multiple sites using different root domains like `https://site-a.com` and `https://site-b.com`, with the way Craft’s [license enforcements works](kb:how-craft-license-enforcement-works), you’ll want to pick one of the domains to access the Craft control panel from for _all_ sites.

The domain you access the control panel from does _not_ affect what sites’ content you can edit!
:::

::: tip
If your primary site’s **Base URL** includes a subdirectory (i.e. `https://foo.dev/bar/`), you should set the [baseCpUrl](config5:baseCpUrl) config setting.
:::

### Site Templates

Whenever Craft loads a template, it looks in a subfolder of your `templates/` directory with the handle of the current site before trying the global space.

For example, if our site was named _Labs_ (with the handle `labs`), we could create a `templates/labs/` directory with any templates we wanted to override in the “global” space. Suppose the primary site and this Labs mini-site shared most of their page structure, but Labs had a simplified header and footer: we could put `{% include '_partials/footer' %}` in a shared layout, and Craft would look in the current site’s template folder (`templates/labs/_partials/footer.twig`), _then_ fall back to the global space (`templates/_partials/footer.twig`).

(In this example, the layout template itself could also be controlled on a per-site basis!)

## Propagating Entries

[Entries](../reference/element-types/entries.md) support advanced rules for propagating content to other sites. Each section has a **Site Settings** table, in which you choose the sites its entries can be published in, as well as what their URIs look like.

_Channel_ and _Structure_ sections also include a **Propagation Method** setting, which determines how content is synchronized across sites, site groups, or languages when created or saved. _Single_ sections only contain one entry (and it’s automatically created when along with the section), so they don’t have propagation settings.

Only save entries to the site they were created in
:   Entries are created in a single site, and are not associated with content from other sites. Useful when creating similar content architectures for multiple otherwise unrelated sites—like a news feed for two unrelated products owned by a single company.

    ::: warning
    Keep in mind that entries created in this way cannot be added to other sites, later.
    :::

Save entries to other sites in the same site group
:   Entries are created only in sites belonging to the same **Site Group**, and are not associated with content from sites in other groups. Useful in scenarios where similar content architectures are important across multiple otherwise unrelated sites that are then available in multiple languages—like program-specific event feeds for a recreation center that are translated in multiple languages.

    Entries propagated in this way aren’t required to target different languages!

Save entries to other sites with the same language
:   Entries are created and managed in all sites that share a _language_. Useful in situations where the core content represented by an entry is only relevant in its original language, but might still be syndicated to other sites—like an archive of literary works or letters that might be a part of multiple digital museum collections.

Save entries to all sites enabled for this section
:   Entries are created and managed in all sites that are enabled in the **Site Settings** table.

Let each entry choose which sites it should be saved to
:   Leave these decisions up to each entry. Use the **Status** section in the sidebar to create the entry in another site:

    ![Creating an entry in secondary sites](../images/entry-propagation-manual.png)

    This option also allows entries to be deleted on a per-site basis (rather than just _disabled_).

When an entry exists in multiple sites, its content can be translated using similar (but even more flexible) rules, [on a field-by-field basis](fields.md#translation-methods).

## Setting Up a New Site

In this section, we’ll walk through the steps of setting up a new site in Craft. This guide assumes you already have Craft [installed](../install.md) and the default site setup and configured.

### Step 1: Create the Site

The first step is to create the new site in the **Settings** screen of your Craft installation.

1. Go to <Journey path="Settings, Sites" /> and press **New Site**.
2. Use the dropdown menu to choose the group your site should belong to. Site groups are used to control how content is translated.
3. Give your site a name. Craft uses the **Site Name** in the control panel, and makes it available in your [templates](../development/templates.md) as `{{ siteName }}`.
4. Based on the **Site Name**, Craft will generate a **Site Handle**. You can use the handle to refer to this site in the templates (i.e. `craft.app.sites.getSiteByHandle('beta')`), but it has no bearing on front-end URLs. It may appear in control panel URLs.
5. Choose the [language](#language) for this site.
6. If this site should be the primary or “default” site, toggle **Is Primary Site?** to enable it. The primary site is loaded whenever Craft can’t match the URL to a known site.
7. Check the box for **This site has its own base URL** and provide a **Base URL**.
8. Save the new site.

### Step 2 (Optional): Create Template Directories

If you’d like to experiment with per-site [template overrides](#site-templates), create a new subdirectory within your `templates/` folder with the handle of your new site.

### Step 3: Update Sections

1. Go into each Section that you want to be available in the new site and enable the site using the Site Settings table.
2. Set the **Entry URI Format**, **Template**, and **Status** for the new site in each Section.
3. Choose a [**Propagation Method**](#propagating-entries) that suits the section.

### Step 4: Define Translation Method of Fields

By default, custom fields are set to store the same value across all sites. If any fields should have unique values across your sites, then you will need to edit their [Translation Method](fields.md#translation-methods) settings.

::: tip
Multi-instance fields share a **Translation Method** across all instances. If you need different rules for each instance, it may be better suited as two separate fields.
:::

### Step 5: Test Your Settings

Using new or existing entries, verify that the section, field, and translation method settings work as you expect. View the entry in the front-end to ensure your URLs and templates are loading correctly, as well!

### Step 6: Check Your Asset Settings

If you have any _Local_ asset filesystems, you will need to make sure they (and the files in each volume that depends on them) are available from each of your sites. Relative paths (like `uploads/images/`) or root-relative paths (like `/uploads/images/`) may only work coincidentally. Filesystems’ **Base URL** setting should use a stable, absolute URL like `https://craftcms.com/` (or a special alias or environment variable).

::: tip
Review your translation method for asset titles and `alt` text to make sure they’re relevant to users and authors!
:::

### Step 7: Configure Your Web Server and DNS

1. Configure your web server so the domain (e.g. `labs.craftcms.com`) points at the `web/` directory. Craft will automatically detect which site is being requested.
2. Update your DNS records so the domain points at the web server.

## Static Message Translations

Most websites and apps will have some UI messages that are hard-coded into the templates or PHP files. These are called “static messages” in Craft, because they aren’t being written by editors in the CMS as content.

If you’re building a multilingual site or app, then these messages are apt to need to be translated, just like your CMS-driven content.

To do that, Craft employs Yii’s [Message Translations](https://www.yiiframework.com/doc/guide/2.0/en/tutorial-i18n#message-translation) feature, and pre-defines special translation categories:

- `site` is used for messages that belong to the project.
- `app` is used for Craft control panel messages.
- Each plugin gets its own category as well, based on the plugin’s handle.

### Prep Your Messages

The first step is to run all of your static messages through the translator. If you’re working on a template, use the [translate](../reference/twig/filters.md#translate-or-t) filter (`|t`). If you’re working in PHP code, use [Craft::t()](yii2:yii\BaseYii::t()).

::: code
```twig
{# old #}
<a href="/contact">Contact us</a>

{# new #}
<a href="/contact">{{ 'Contact us'|t }}</a>
```
```php
// old
echo 'Contact us';

// new
echo Craft::t('site', 'Contact us');
```
:::

### Provide the Translations

Once you’ve prepped a message for translations, you need to supply the actual translation.

To do that, create a new folder in your project’s base directory called `translations/`, and within that, create a new folder named after the target language’s ID. Within that, create a file named after the translation category you want to create messages for (`site.php` for project messages, `app.php` to overwrite Craft’s control panel messages, or `<plugin-handle>.php` to overwrite a plugin’s messages).

For example, if you want to translate your project’s messages into German, this is what your project’s directory structure should look like:

```treeview
my-project/
├── config/
├── ...
└── translations/
    └── de/
        └── site.php
```

Now open `site.php` in a text editor, and have it return an array that maps the _source messages_ to their _translated messages_:

```php
<?php

return [
    'Contact us' => 'Kontaktiere uns',
];
```

When Craft is processing the message translation for a German site, “Contact us” will be replaced with “Kontaktiere uns”.

::: tip
Craft uses `|t('site')` when showing your custom field names in the control panel, so you can use `site.php` translations for control panel users, too!
:::

#### Message Parameters

Static messages can have [placeholder values](https://www.yiiframework.com/doc/guide/2.0/en/tutorial-i18n#message-parameters). For example:

```php
<?php

return [
    'Welcome back, {name}' => 'Willkommen zurück {name}',
];
```

To replace the placeholder values with dynamic values when translating the message, pass the `params` argument when using the [translate](reference/twig/filters.md#translate-or-t) filter or calling [Craft::t()](yii2:yii\BaseYii::t()):

::: code
```twig
<a href="/contact">{{ 'Welcome back, {name}'|t(params = {
  name: currentUser.friendlyName,
}) }}</a>
```
```php
echo Craft::t('site', 'Welcome back, {name}', [
    'name' => Craft::$app->getUser()->getIdentity()->friendlyName,
]);
```
:::

## Limitations

Craft has a soft cap of 100 sites, determined by the `maxSites` property of the [Sites](craft5:craft\services\Sites) service. You can increase this at any time via your [application configuration](../configure.md#application-configuration) (it’s not a technical or license limitation), but we put it in place as a means of reminding users that sites are not _infinitely_ scalable!

To increase the sites ceiling, add this to your `config/app.php` file:

```php
return [
    'components' => [
        'sites' => [
            'maxSites' => 5000,
        ],
    ],
];
```

::: warning
While it’s _possible_ to run 5000 sites on a single Craft installation, we strongly discourage it. We have found that projects with more than a hundred sites are at significantly higher risk of author experience and performance issues, and are more difficult to maintain and troubleshoot.
:::

## Further Reading

- [The Power of t() in Craft 3](https://medium.com/@drifter/the-power-of-t-in-craft-3-b4bc3489edc4)
- [Language switcher for Craft 3 by Jan D’Hollander](https://www.thebasement.be/language-switcher-for-craft-3/)
- [Stack Exchange: Getting full native language name in Craft 3 language switcher](https://craftcms.stackexchange.com/questions/27116/getting-full-native-language-name-in-craft3-language-switcher)
</file>

<file path="system/user-management.md">
---
keywords: permissions users login teams pro registration
description: Tailor front- and back-end experiences to your users’ needs.
related:
  - uri: https://www.craftcms.com/knowledge-base/front-end-user-accounts
    label: "Supporting front-end user accounts"
---

# User Management

[Users](../reference/element-types/users.md) in Craft represent humans that have some relationship with your site or application. They may be control panel users, member accounts, or records that represent people in general. Users implicitly have the ability to create passwords and [log in](#logging-in), but must be granted [permissions](#permissions) or added to [groups](#user-groups) to access the control panel or manage content.

The first user account is created during [installation](../install.md). The number of additional users that can be created (and their capabilities) depends on your Craft [edition](../editions.md):

- **Craft Solo** is limited to a single admin user.
- **Craft Team** <Badge text="New!" vertical="baseline" /> allows up to five users, and one [user group](#user-groups).
- **Craft Pro** has no limitations on the number of registered users or groups, and supports [public registration](#public-registration).

To create a new user, visit the **Users** control panel screen, then click **New user**. If you don’t see this item in the control panel navigation, your current user may not have the required [permission](#permissions) to register other users.

<BrowserShot url="https://my-project.ddev.site/admin/users/123&fresh=1" :link="false" caption="Creating a new user in the Craft control panel.">
<img src="../images/users-new.png" alt="Creating a new user in the Craft control panel" />
</BrowserShot>

Users must be identified with at least an **Email** and a **Username** (or just an email address if the [`useEmailAsUsername` config setting](config5:useEmailAsUsername) is enabled). Select **Create and set permissions** <Since ver="5.3.0" feature="The revised user creation flow" /> to validate the user and move on to group and [permissions](#permissions) assignment.

::: tip
If you need to capture some information about a person but don’t have their email address yet, you can select **Save as draft** from the fly-out menu in the toolbar and come back to the draft later.
:::

The permissions screen will include a **Save and send activation email** button <Since ver="5.3.0" feature="The revised user creation flow" /> if the user is still _Inactive_. Users can also be activated by…

- …selecting **Send activation email** from the action menu <Icon kind="ellipses" /> in the toolbar;
- …selecting **Copy activation URL** from the action menu <Icon kind="ellipses" /> and sending it manually;
- …selecting **Activate account** without setting a password.

If an account is manually activated by another user _without setting a password_, the user can request a password reset via a [front-end form](#public-registration), or the control panel login screen.

## Statuses

Users may exist in the system in a number of states. A user is typically created in a **Pending** state (ready to be activated via an activation link), whether via [public registration](#public-registration) or by another user in the control panel. Changes to a user’s status can happen implicitly (via activation, failed login attempts, etc.) or explicitly (suspension by a moderator), some requiring additional verification by email or an [elevated session](#elevated-sessions).

Active
:   An **Active** user is able perform any task their permissions allow. Users are put in this state following account activation (either via an activation link or action taken by another user). However, an active account does not necessarily have a password—but once one is set (or the current password is reset), they _would_ be able to log in normally.

Pending
:   Public registration creates users in the **Pending** state, unless the **Deactivate users by default** setting is enabled in user settings. The only difference between a **Pending** and **Active** user is that they have never activated their account with an activation link, or had a user with the **Moderate users** permission activate it for them.

Suspended
:   **Suspended** users have been manually locked out of the system by an user with the [_Moderate Users_ permission](#permissions). They will be unable to log in or reset their password.

Inactive
:   New users and users that have been explicitly deactivated are marked as **Inactive**. An inactive user cannot log in, reset their password, or reactivate their account.

#### Special States

Credentialed
:   Craft has a special distinction for users who are able to log in _or could become able to log in_ under their own power. Any user that is either **Active** or **Pending** is considered **Credentialed**.

Locked
:   When a user makes too many unsuccessful login attempts (according to the <config5:maxInvalidLogins> and <config5:invalidLoginWindowDuration> settings), their account will be **Locked**. Another user with the **Moderate users** [permission](#permissions) can manually unlock a user in this state at any time, or the user can wait until the <config5:cooldownDuration> elapses and try again.

    ::: warning
    User locking is an automatic abuse-prevention behavior, not a moderation tool. If you need to prevent someone from accessing the site or control panel, **suspend** or **deactivate** the user.
    :::

Trashed
:   Like other elements, users can be _soft-deleted_. A trashed user cannot log in or restore themselves, and the user may be garbage-collected after remaining trashed for the configured <config5:softDeleteDuration>.

## Settings

The behavior of Craft’s user registration and authentication system is governed by a handful of config settings, and a few options (managed via <Journey path="Settings, Users, Settings" />) stored in [project config](project-config.md).

### Project Config

- **User Photo Location**: Which volume user profile assets are stored in. Files are always uploaded directly to a profile, and cannot be selected from the existing asset library.
- **Require two-step verification**: Choose which user groups (if any) are required to configure a two-step verification method to access the control panel. This has no effect on users who do not have control panel permissions.
- **Verify email addresses**: A user must demonstrate they have access to an email address before they can activate their account, or change the email on an existing account.
- **Allow public registration**: Whether or not users can register from the front-end.
- **Validate custom fields on public registration**: When registering via the front-end, require a complete user profile (including any fields marked as **Required** in the user field layout).
- **Deactivate users by default**: Place users in the **Inactive** state after registering, rather than sending an activation email. Another user with the **Moderate users** [permission](#permissions) must activate the user.
- **Default User Group**: The [group](#user-groups) that publicly-registered users are added to, if any.

In addition, the [users field layout](../reference/element-types/users.md#custom-fields) and [addresses field layout](../reference/element-types/addresses.md#setup) are stored in project config.

### Config Files

A combination of [user-specific](../reference/config/general.md#users), [session](../reference/config/general.md#session), and [security](../reference/config/general.md#security) settings are tracked via the [General](../reference/config/general.md) configuration file.

A summary of these settings (as they relate to front-end development) is available in the [Additional Tools](#additional-tools) section, below.

## Admin Accounts

Admin users are special accounts that can do _everything_ within Craft, including some things that don’t have explicit permissions:

- Modify all [Settings](control-panel.md#settings) (in environments with [admin changes](config5:allowAdminChanges) are enabled);
- Make other users admins (in editions that support multiple users);
- Administrate other admins (in editions that support multiple users);

The user you create when installing Craft is an admin by default. Users in Craft <Badge type="edition" text="Team" vertical="middle" /> can either have permissions from the single [group](#user-groups), or be an admin.

::: warning
Considering how much damage an admin can do, we strongly advise reserving this role for key members of your team or organization who cannot fulfill their responsibilities without it. Whenever possible, design a [permissions](#permissions) scheme that grants only the necessary capabilities.
:::

To make a user an admin, you must be logged in as an existing admin. Find the user in the **Users** screen, then select the **Permissions** tab, and enable **Admin**. The individual permissions checkboxes will be hidden, as admin implicitly have _all_ permissions. While admin can be part of groups, those groups’ permissions have no bearing on their capabilities unless they are stripped of the admin designation later.

You can also audit and create admin users from the [command line](#cli).

## User Groups <Badge type="edition" text="Pro" />

**User Groups** help organize your site’s user accounts, and uniformly set [permissions](#permissions) on them.

To create a new User Group, go to **Settings** → **Users** and press **+ New user group**. Groups have a **Name** and **Handle**, plus any **Permissions** you want every user within the group to have.

After you create your groups, you can assign users to groups by going into their account settings and choosing the **Permissions** tab. Permissions granted by groups are _additive_, so a user in multiple groups receives the combined permissions of those groups (as well has any permissions granted explicitly to that user). Removing a user from a group does not revoke permissions that are granted by another group they are a member of!

Users in Craft <Badge type="edition" text="Team" vertical="middle" /> belong to a single “Team” user group, the permissions for which are managed via <Journey path="Settings, Users, User Permissions" />.

## Permissions <Badge type="edition" text="Team" /> <Badge type="edition" text="Pro" />

Permissions govern what users can do—like access the control panel, edit content within certain sections, create and moderate other users, etc. You can assign these permissions directly to users, or via [user groups](#user-groups). Permissions applied to a user group are inherited by all users belonging to it.

::: warning
Make sure you trust users with access to settings that allow users to provide [Twig](../development/twig.md) code, like the **System Messages** utility. It’s possible to do malicious things via Twig (like permissions escalation), so these permissions are intended primarily for trusted admins and developers.
:::

The permissions Craft comes with are:

| Permission | [Handle](#checking-permissions)
| ---------- | ------
| Access the site when the system is off | `accessSiteWhenSystemIsOff`
| Access the control panel | `accessCp`
| <Indent :level="1" /> Access the control panel when the system is offline | `accessCpWhenSystemIsOff`
| <Indent :level="1" /> Perform Craft CMS and plugin updates | `performUpdates`
| <Indent :level="1" /> Access <CodePlaceholder>Plugin Name</CodePlaceholder> | `accessPlugin-[PluginHandle]`
| View users <InfoHud>Read-only access to user elements. In earlier versions of Craft, user management permissions were not nested within this one.</InfoHud> <Since ver="5.6.0" feature="View users permission" /> | `viewUsers`
| <Indent :level="1" /> Edit users | `editUsers`
| <Indent :level="2" /> Register users | `registerUsers`
| <Indent :level="2" /> Moderate users <InfoHud>Moderation includes editing other users’ names, usernames, custom fields, and addresses.</InfoHud> | `moderateUsers`
| <Indent :level="2" /> Administrate users <InfoHud>User administration includes changing emails, sending activation and password reset emails, setting passwords, and deactivating users. This permission can be used to elevate one’s own permissions by gaining access to other administrators’ accounts!</InfoHud> | `administrateUsers`
| <Indent :level="2" /> Impersonate users <InfoHud>User impersonation allows one user to temporarily access the site as though they were another user with the same (or more restrictive) permissions.</InfoHud> | `impersonateUsers`
| <Indent :level="2" /> Assign user permissions | `assignUserPermissions`
| <Indent :level="2" /> Assign users to this group <InfoHud>This is not an actual permission so much as a convenience feature for automatically granting the ability to add peers to the <em>group</em> you are currently editing, as its handle/UUID may not be known, yet!</InfoHud> | See note.
| <Indent :level="2" /> Assign users to <CodePlaceholder>Group Name</CodePlaceholder> | `assignUserGroup:[UserGroupUID]`
| <Indent :level="1" /> Delete users | `deleteUsers`
| Edit <CodePlaceholder>Site Name</CodePlaceholder> <InfoHud>Site permissions are intersected with other permissions. A user will only be able to edit something if they have access to the site <em>and</em> the element itself.</InfoHud> | `editSite:[SiteUID]`
| View entries <InfoHud>This section is repeated for each configured section.</InfoHud> | `viewEntries:[SectionUID]`
| <Indent :level="1" /> Create entries | `createEntries:[SectionUID]`
| <Indent :level="1" /> Save entries | `saveEntries:[SectionUID]`
| <Indent :level="1" /> Delete entries | `deleteEntries:[SectionUID]`
| <Indent :level="1" /> View other users’ entries | `viewPeerEntries:[SectionUID]`
| <Indent :level="2" /> Save other users’ entries | `savePeerEntries:[SectionUID]`
| <Indent :level="2" /> Delete other users’ entries | `deletePeerEntries:[SectionUID]`
| <Indent :level="1" /> View other users’ drafts | `viewPeerEntryDrafts:[SectionUID]`
| <Indent :level="2" /> Save other users’ drafts | `savePeerEntryDrafts:[SectionUID]`
| <Indent :level="2" /> Delete other users’ drafts | `deletePeerEntryDrafts:[SectionUID]`
| Edit <CodePlaceholder>Global Set Name</CodePlaceholder> | `editGlobalSet:[GlobalSetUID]`
| View categories <InfoHud>This section is repeated for each configured category group.</InfoHud> | `viewCategories:[CategoryGroupUID]`
| <Indent :level="1" /> Save categories | `saveCategories:[CategoryGroupUID]`
| <Indent :level="1" /> Delete categories | `deleteCategories:[CategoryGroupUID]`
| <Indent :level="1" /> View other users’ drafts | `viewPeerCategoryDrafts:[CategoryGroupUID]`
| <Indent :level="2" /> Save other users’ drafts | `savePeerCategoryDrafts:[CategoryGroupUID]`
| <Indent :level="2" /> Delete other users’ drafts | `deletePeerCategoryDrafts:[CategoryGroupUID]`
| View assets | `viewAssets:[VolumeUID]`
| <Indent :level="1" /> Save assets | `saveAssets:[VolumeUID]`
| <Indent :level="1" /> Delete assets | `deleteAssets:[VolumeUID]`
| <Indent :level="1" /> Replace files | `replaceFiles:[VolumeUID]`
| <Indent :level="1" /> Edit images | `editImages:[VolumeUID]`
| <Indent :level="1" /> View assets uploaded by other users | `viewPeerAssets:[VolumeUID]`
| <Indent :level="2" /> Save assets uploaded by other users | `savePeerAssets:[VolumeUID]`
| <Indent :level="2" /> Replace files uploaded by other users | `replacePeerFiles:[VolumeUID]`
| <Indent :level="2" /> Remove files uploaded by other users | `deletePeerAssets:[VolumeUID]`
| <Indent :level="2" /> Edit images uploaded by other users | `editPeerImages:[VolumeUID]`
| <Indent :level="1" /> Create subfolders | `createFolders:[VolumeUID]`
| Utilities |
| <Indent :level="1" /> Updates | `utility:updates`
| <Indent :level="1" /> System Report | `utility:system-report`
| <Indent :level="1" /> PHP Info | `utility:php-info`
| <Indent :level="1" /> System Messages | `utility:system-messages`
| <Indent :level="1" /> Asset Indexes | `utility:asset-indexes`
| <Indent :level="1" /> Queue Manager | `utility:queue-manager`
| <Indent :level="1" /> Caches | `utility:clear-caches`
| <Indent :level="1" /> Deprecation Warnings | `utility:deprecation-errors`
| <Indent :level="1" /> Database Backup | `utility:db-backup`
| <Indent :level="1" /> Find and Replace | `utility:find-replace`
| <Indent :level="1" /> Migrations | `utility:migrations`

You may not see all of these options, initially—only ones that are relevant based on the current content schema will be displayed. For example, everything under _View categories_ will be hidden until you have at least one [category group](../reference/element-types/categories.md#category-groups).

Plugins may register their own permissions, which can appear in a top-level group, under _Access the control panel_, or within _Utilities_.

::: tip
See the _Extending Craft_ [User Permissions](../extend/user-permissions.md) page to learn how to register custom permissions from a module or plugin.
:::

### Checking Permissions

You can check whether the logged-in user has a specific permission using its handle. Replace any bracketed items in the table above with the desired value (So `accessPlugin-[PluginHandle]` would become `accessPlugin-commerce`).

```twig
{% if currentUser.can('accessCp') %}
  <a href="{{ cpUrl() }}">Visit the Control Panel</a>
{% endif %}
```

For UUID-driven permissions, you can either hard-code the value in Twig, or look it up dynamically.

::: code
```twig Verbatim
{# Store the UUID directly in the template: #}
{% if currentUser.can('createEntries:4fcb3c63-9477-4b5f-8021-874d64f819ce') %}
  <a href="{{ siteUrl('account/vendors/add') }}">Add a Vendor</a>
{% endfor %}
```
```twig Dynamic
{# Look up the section by its handle: #}
{% set vendorsSection = craft.app.entries.getSectionByHandle('vendors') %}

{# Build the permission handle: #}
{% if currentUser.can("createEntries:#{vendorsSection.uid}") %}
  <a href="{{ siteUrl('account/vendors/add') }}">Add a Vendor</a>
{% endfor %}
```
:::

This is not strictly necessary, but the `handle` of a given resource is often much easier to understand in the template context.

::: tip
UUIDs and handles are safe to use like this because they’re tracked in [Project Config](project-config.md) and will be [consistent across environments](project-config.md#ids-uuids-and-handles), unlike IDs.
:::

If your site or app doesn’t rely on specific permissions to control access to resources, you can check whether the user belongs to a group, instead:

```twig{3}
{% requireLogin %}

{% if currentUser.isInGroup('members') %}
  <div class="banner">Thanks for your support!</div>
{% endif %}
```

### Requiring Permissions

You can also require the logged-in user to have a specific permission to access an entire template:

```twig
{% requirePermission 'accessCp' %}
```

If the requirements are not met, Craft will send a 403 _Forbidden_ response with the site’s [error template](routing.md#error-templates). Logged-out visitors will be forwarded to the configured [loginPath](config5:loginPath); after signing in, the user will be redirected to the original path—but may still encounter a _Forbidden_ error if their account doesn’t have the correct permissions.

### Forms + Content

When a user is given permissions to edit or create elements that meet certain criteria (say, entries in a specific section), they do _not_ need [control panel](control-panel.md) access to make updates.

When POSTing new data to actions like [`entries/save-entry`](../reference/controller-actions.md#post-entries-save-entry) (or the more generic `elements/save`), Craft checks for the appropriate permissions. This means that you can create secure, streamlined content management tools for users, without ever granting them access to the control panel!

Keep in mind that permissions issues are dealt with differently than [validation errors](../development/forms.md#models-and-validation), so it’s important to check permissions _prior_ to displaying an edit interface to a user. Attempting to POST updates to an element that the current user cannot edit will produce a 400-level HTTP error, and the changes will be lost. If you want to make only certain fields editable to certain users, add [user conditions](fields.md#conditions) to the element’s field layout.

### Querying by Permissions

You can look up users with a given permission using the [`can()` method](../reference/element-types/users.md#can) on a user query. To find users belonging to a specific group, use the [`group()` method](../reference/element-types/users.md#group).

## Preferences

Users have a few settings that govern their experience of the control panel and front-end, including their preferred **Language** and **Formatting Locale**, a number of **Accessibility** features, and (for [administrators](#admin-accounts)) debugging tools.

![User preferences screen in the Craft control panel](../images/users-preferences.png)

## Authentication <Badge text="New!" />

[Credentialed](#special-states) users in Craft can authenticate with one or more methods. By default, Craft uses a password to verify the user’s identity. In addition to passwords, users can set up [two-factor authentication](#time-based-one-time-passwords), or add a [passkey](#passkeys).

![Two-factor authentication setup screen in the Craft control panel](../images/control-panel-2fa.png)

Plugins can also provide authentication methods!

### Time-based, One-Time Passwords

Craft has built-in support for one-time passwords via your favorite authenticator app or password manager. When enabled (via <Journey path="Settings, Users, Security" />), control panel users subject to your policy will be asked to set up an authenticator on their next login.

If a user loses access to their <abbr title="Time-based, one-time password">TOTP</abbr> provider, they can use one of the recovery codes generated at the time it was set up.

### Passkeys

Individual users can elect to log in with a [Passkey](https://fidoalliance.org/passkeys/). To configure a passkey, visit your user’s account screen via the menu in the upper-right corner of the control panel, then choose **Passkeys**.

::: tip
Some browsers and devices share passkeys via their own accounts or cloud services, so you may only need one passkey added to Craft to authenticate on multiple devices.
:::

### Elevated Sessions

The control panel may require users to reauthorize to perform some actions, like removing authentication methods, altering [permissions](#permissions), or modifying [GraphQL](../development/graphql.md) schemas.

An elevated session’s duration is governed by the <config5:elevatedSessionDuration> setting.

### Front-end Multi-factor Authentication <Since ver="5.6.0" feature="Multi-factor auth support outside the control panel" />

When **Require two-step verification** is enabled for user groups that _don’t_ have control panel access, those users may be sent to the Craft-provided [front-end login page](#front-end-pro) to perform additional authentication.

<a name="public-registration"></a>

## Public Registration <badge type="edition" title="Craft Pro only">Pro</badge>

Public user registration is disabled by default, but can be turned on by visiting <Journey path="Settings, Users, Settings" />, and checking **Allow public registration**. With that checked, you will also have the ability to choose a **Default User Group** that publicly-registered users are automatically added to.

Once you set up your site to allow public user registration, the last step is to create a front-end [user registration form](kb:front-end-user-accounts#registration-form). For a full list of params a user can set during registration (or when updating their account, later on), read about the [`users/save-user` controller action](../reference/controller-actions.md#post-users-save-user).

::: tip
By default, Craft puts new users in a [pending state](#statuses) and allows them to activate their own accounts via email. You can instead select **Deactivate users by default** to place a moderation buffer between public registration and eventual access.
:::

### Affiliated Site <Since ver="5.6.0" feature="Affiliated sites for user elements" />

During registration, Craft captures the current [site](sites.md) and stores it as the user’s **Affiliated Site**. This is primarily used to determine what language and template [system emails](mail.md#system-messages) should be use, when sent from site-agnostic contexts (like the control panel or CLI).

### Default Group

Users created via public registration are automatically added to the group designated by the **Default User Group** setting.

::: danger
Select this group’s [permissions](#permissions) carefully, ensuring that new users don’t immediately get access to tools that can negatively affect other users’ experience.
:::

## Logging In

Any [credentialed](#statuses) user can set a password and log in.

### Control Panel

Users with [control panel](control-panel.md) access should use Craft’s native login form, which is shown when visiting `/admin` (or the path corresponding to your <config5:cpTrigger>). Any time an unauthenticated client tries to access a resource in the control panel, they will be redirected to the login page. 

After logging in (and, when configured, completing [two-step verification](#authentication)), they will be returned to the [dashboard](control-panel.md#dashboard), or whichever protected page they originally attempted to access.

::: tip
When a control panel user authenticates and is redirected, their permissions _may_ still prevent them from viewing that resource.
:::

### Front-end <badge type="edition" title="Craft Pro only">Pro</badge>

Sites that support [public registration](#public-registration) or whose administrators create accounts without control panel access are apt to require front-end login forms.

The <config5:loginPath> setting determines where Craft sends users who access pages guarded by the [`{% requireLogin %}`](../reference/twig/tags.md#requirelogin) or [`{% requirePermission %}`](../reference/twig/tags.md#requirepermission) tags, as well as the value of the global [`loginUrl` variable](../reference/twig/global-variables.md#loginurl):

```twig{9}
<header>
  <img src="{{ siteUrl('assets/logo.png') }}" alt="{{ siteName }}">

  {% if currentUser %}
    Welcome, {{ currentUser.fullName ?: currentUser.username }}!
    <a href="{{ siteUrl('my-account') }}">My Account</a>
    <a href="{{ logoutUrl }}">Sign out</a>
  {% else %}
    <a href="{{ loginUrl }}">Sign in</a>
  {% endif %}
</header>
```

By default, this path is `login`, so `{{ loginUrl }}` would print something like `https://my-project.ddev.site/login`.

When this route is requested, Craft looks for the [corresponding template](#custom-template), `templates/login.twig`. If it can’t be found, a bare-bones internal version will be used: <Since ver="5.6.0" feature="Built-in front-end login template" />

<BrowserShot url="https://my-project.ddev.site/login" :link="false" caption="Logging in to the front end of a Craft website, for which a login template does not exist.">
<img src="../images/login.png" alt="The login template included with Craft" />
</BrowserShot>

You can inject additional styles into this page using the <config5:systemTemplateCss> setting:

```php
use craft\config\GeneralConfig;

return GeneralConfig::create()
    // ...
    ->systemTemplateCss('/assets/styles/system.css')
;
```

Full reference for the CSS variables used on this page are [available in the source](https://github.com/craftcms/cms/blob/5.x/src/web/assets/theme/dist/fe.css). <Since ver="5.6.0" feature="System template stylesheet setting" />

::: tip
This template will also be displayed when users are required to set up a new [two-step verification](#authentication) method (or complete authorization, later).
:::

No template is rendered for requests matching the <config5:logoutPath>; the user’s session is terminated, and they are redirected to the <config5:postLogoutRedirect>.

### Custom Template

Create a new Twig file at `templates/login.twig` (or `templates/{loginPath}.twig`, if you have a custom <config5:loginPath>) with the following content:

```twig
<form method="post">
  {{ csrfInput() }}
  {{ actionInput('users/login') }}

  <label for="login-name">Username/Email</label>
  <input type="text" name="loginName" id="login-name">

  <label for="password">Password</label>
  <input type="password" name="password" id="password">

  <button>Sign in</button>
</form>
```

You are free to have this template extend an existing layout, or directly add `<head>` and `<body>` tags.

Visiting your site’s `/login` page in a _private_ browser, you should see the unstyled form. Opening the same page in a browser with an _active_ session may redirect you to the configured <config5:postLoginRedirect> (or the primary site’s homepage, by default).

<See path="../development/forms.md" label="Working with Forms" description="Learn about sending data to Craft with forms." />

::: tip
Additional information about handling login and account creation can be found in our [Front-End User Accounts](kb:front-end-user-accounts) guide.
:::

Any valid username and email combination can be submitted to log in. As mentioned above, if the user needs to set up or authenticate with a two-step verification method, they will be taken to the “system” login view to complete their login.

To help users understand the state of their session (and in some limited circumstances, specific issues with the submitted information), you can output [flashes](../development/forms.md#flashes) from the login action:

```twig
{% set flashes = craft.app.session.getAllFlashes(true) %}

{% if flashes is not empty %}
  <ul>
    {% for flash in flashes %}
      <li>{{ flash }}</li>
    {% endfor %}
  </ul>
{% endif %}
```

### Custom Routes

The `loginUrl` Twig variable is set based on the corresponding config value. How this route is handled is actually up to your project! When the `loginUrl` path is requested by a client, Craft uses its normal [route resolution process](routing.md), including the normal element URI search, `routes.php` rule matching, and looking in your project’s `templates/` directory.

This means that you can decouple the route from the template by adding a [rule](routing.md) to your `routes.php` file:

```php
return [
    // Assuming your `general.php` config sets `loginPath` to `account/sign-in`...
    'account/sign-in' => ['template' => '_accounts/login'],
];
```

Then, you would be free to create `templates/_accounts/login.twig`, alongside other templates in a [hidden](../development/templates.md#hidden-templates) directory.

### Additional Tools

These variables are available in all Twig contexts:

- `loginUrl` — Defined by <config5:loginPath>. Used to build a link to the central login page, and where users will be redirected when requesting a protected resource.
- `logoutUrl` — Defined by <config5:logoutPath>. Used to build a link that immediately logs the user out.
- `setPasswordUrl` — Defined by <config5:setPasswordRequestPath>. Used to build a link to a central page where users can request their password be reset. A link is sent to the user’s email address (based on the <config5:setPasswordPath> setting) with `id` and `code` query parameters.

Other URLs are generated when activating accounts or resetting passwords, and are not available for direct use in templates.

Fine-grained control over registration and sign-in workflows are possible with these settings:

- Logging in and out…
  - <config5:loginPath> — Determines the `loginUrl` variable. (Default: `login`)
  - <config5:logoutPath> — Determines the `logoutUrl` variable, and maps the specified path to the `users/logout` controller action. (Default: `logout`)
- Account activation…
  - <config5:setPasswordRequestPath> — Determines the `setPasswordPath` variable. (Default: `setpassword`) Users will visit this page to _request_ a password reset link.
  - <config5:setPasswordPath> — Where users will be sent to _set_ a password. These secure, temporary URLs are generated by Craft when sending a password reset email, or when another user with the _Administrate users_ permission requests a password reset link via the control panel.
  - <config5:setPasswordSuccessPath> — Where users are redirected after successfully setting a new password.
- Changing and verifying email addresses…
  - <config5:verifyEmailPath> — Used when generating a link sent via email to verify access to an email address.
  - <config5:verifyEmailSuccessPath> — Similar to `setPasswordSuccessPath`, but for redirection after a user verifies their email address (either upon creating an account, or changing its email address).
  - <config5:useEmailAsUsername> — Simplifies record-keeping and authentication by eliminating discrete usernames.
- Security and timing…
  - <config5:autoLoginAfterAccountActivation> — Control whether users are immediately logged in after setting a password. (Default: `false`)
  - <config5:purgePendingUsersDuration> — How long Craft waits before deleting pending, non-activated users. (Default: `0`, or _disabled_)
  - <config5:purgeStaleUserSessionDuration> — How long Craft waits before dropping stale sessions from the `sessions` database table. This may (Default: 90 days)
  - <config5:invalidUserTokenPath> — Where users are redirected if the token or code in an activation or verification link is invalid or has expired.

## CLI

Craft’s [command line](cli.md) provides admin-level user management tools. With access to the underlying server, you can create, delete, and impersonate users, get activation URLs, set passwords, and even log out all users.

<See path="../reference/cli.md" hash="users" label="Users CLI Reference" description="Read more about managing users via the command line." />
</file>

<file path="coc.md">
# Code of Conduct

Like the technical community as a whole, the Craft team and community is made up of a mixture of professionals and volunteers from all over the world, working on every aspect of the mission - including mentorship, teaching, and connecting people.

Diversity is one of our strengths. With that, challenges will arise that can lead to communication issues and unhappiness. To that end, we have a few ground rules that we ask people to adhere to. This code applies equally to founders, mentors and those seeking help and guidance.

This isn’t an exhaustive list of things that you can’t do. Rather, take it in the spirit in which it’s intended - a guide to make it easier to enrich all of us and the technical communities in which we participate.

This code of conduct applies to all spaces used by the Craft community for communication. This includes Craft Discord, Craft CMS Stack Exchange, GitHub, Twitter, Facebook, meetups, conferences, and any other relevant forums. Violations of this code outside of any spaces managed by the Craft team will still affect a person’s ability to participate within them.

If you believe someone is violating the code of conduct, we ask that you report it by contacting us from [craftcms.com/contact](https://craftcms.com/contact). We take all reports seriously, and your identity will remain confidential.

- **Be friendly and patient.**
- **Be welcoming.** We strive to be a community that welcomes and supports people of all backgrounds and identities. This includes, but is not limited to members of any race, ethnicity, culture, national origin, colour, immigration status, social and economic class, educational level, sex, sexual orientation, gender identity and expression, age, size, family status, political belief, religion, and mental and physical ability.
- **Be considerate.** Your work will be used by other people, and you in turn will depend on the work of others. Any decision you take will affect users and colleagues, and you should take those consequences into account when making decisions. Remember that we’re a world-wide community, so you might not be communicating in someone else’s primary language.
- **Be respectful.** Not all of us will agree all the time, but disagreement is no excuse for poor behavior and poor manners. We might all experience some frustration now and then, but we cannot allow that frustration to turn into a personal attack. It’s important to remember that a community where people feel uncomfortable or threatened is not a productive one. Members of the Craft community should be respectful when dealing with other members as well as with people outside the Craft community.
- **Be careful in the words that you choose.** We are a community of professionals, and we conduct ourselves professionally. Be kind to others. Do not insult or put down other participants. Harassment and other exclusionary behavior aren’t acceptable. This includes, but is not limited to:

  - Violent threats or language directed against another person.
  - Discriminatory jokes and language.
  - Exclusionary gendered language (guys, gentlemen, bros, etc).
  - Posting sexually explicit or violent material.
  - Posting (or threatening to post) other people’s personally identifying information ("doxing").
  - Personal insults, especially those using racist or sexist terms.
  - Unwelcome sexual attention.
  - Advocating for, or encouraging, any of the above behavior.
  - Repeated harassment of others. In general, if someone asks you to stop, then stop.

- **When we disagree, try to understand why.** Disagreements, both social and technical, happen all the time and Craft is no exception. It is important that we resolve disagreements and differing views constructively. Remember that we’re different. The strength of Craft comes from its varied community, people from a wide range of backgrounds. Different people have different perspectives on issues. Being unable to understand why someone holds a viewpoint doesn’t mean that they’re wrong. Don’t forget that it is human to err and blaming each other doesn’t get us anywhere. Instead, focus on helping to resolve issues and learning from mistakes.

*Credits for the sources and inspiration of this code of conduct go to the [Django Project](https://www.djangoproject.com/conduct/) and many others.*
</file>

<file path="configure.md">
---
title: Configuration
description: Set up Craft to work with your team and infrastructure.
sidebarDepth: 2
related:
  - uri: https://nystudio107.com/blog/fluent-multi-environment-config-for-craft-cms-4
    label: Fluent multi-environment config for Craft CMS
  - uri: ./system/project-config.md
---

# Configuring Craft

Craft can be configured to work in a way that makes sense for you, your team, and your infrastructure.

<!-- more -->

Broadly, configuration refers to how Craft will behave in a particular environment. Most applications will only require [database connection information](#database) to work, but as you get familiar with more of Craft’s features, install plugins, or start using additional services, you may need to provide additional config.

We’ll start by looking at how Craft builds its config in a context-aware way, then get into some specific options. Keep in mind that—unlike most aspects of a Craft project—this will require some basic PHP knowledge.

::: tip
[Project config](system/project-config.md) is a discrete concept, but was designed to integrate with the core config system. We’ll look at some examples in just a moment.
:::

## Where Configuration Happens

### Config Files

The most common way to customize your Craft project is by editing files in the [`config/` folder](system/directory-structure.md). These files act as a canonical map of what customizations you’ve made to a project, and as a bridge between specific settings and [environment variables](#setting-and-resolving-options).

| Concern | File(s) | Description
| ------- | -------- | -----------
| [General Configuration](#general) | `general.php` | Global options that can affect the front-end, control panel, debugging, etc.
| [Database Settings](#database) | `db.php` | Connection settings for your database.
| [Custom Options](#custom-settings) | `custom.php` | Arbitrary key-value storage for your own options.
| [Routing](#url-rules) | `routes.php` | Custom HTTP routes.
| [Redirection](system/routing.md#redirection) | `redirects.php` | Additional patterns for redirection.
| [Application Configuration](#application-configuration) | `app.php`, `app.web.php`, `app.console.php` | Overrides for the root application and any of its [Components](https://www.yiiframework.com/doc/guide/2.0/en/concept-components).
| Plugin Settings | `{plugin-handle}.php`, or other custom files | Consult the plugin’s documentation for specifics.
| [Advanced](#advanced) | | Specific library options and/or behaviors that may be exposed in a non-standard way.

::: tip
You may find other files in the `config/` folder, like `license.key` or the `project/` folder. Craft (and many plugins) will ask you to place config-adjacent files here, even if they don’t work in a consistent way.
:::

Sensitive credentials like your database’s password should be kept out of tracked files—but instead of ignoring config files outright, let’s take a look at some options.

### `.env`

New [Craft projects](https://github.com/craftcms/craft) use [vlucas/phpdotenv](https://github.com/vlucas/phpdotenv) to load values into the environment from a `.env` file in the root of your project. A basic `.env` file contains pairs of keys and values:

```env
CRAFT_APP_ID=my-project
CRAFT_ENVIRONMENT=dev

# ...and comments!
```

These values can be referenced in your config files by calling [App::env()](craft5:craft\helpers\App::env()), or using them directly in a [control panel setting](#control-panel-settings). Use of PHP’s `getenv()` directly is discouraged, due to [issues with thread-safety](https://github.com/craftcms/cms/issues/3631). The equivalent [`getenv()` Twig function](reference/twig/functions.md#getenv) uses `App::env()`, and is therefore fine to use in templates.

Craft doesn’t require your variables to follow any kind of naming convention, but it will automatically discover [some specific environment variables](#environment-overrides) for general and database settings.

For most installations, the `.env` file is the only place where secrets should be stored. Avoid checking it in to version control!

::: tip
Some platforms (especially those with ephemeral filesystems, like [Craft Cloud](https://craftcms.com/cloud)) provide a GUI for managing environment variables in lieu of using a `.env` file, and will automatically inject them when the server or process starts. `App::env()` is still the recommended method for retrieving environment variables set in this way.
:::

#### Nested Variables

In your `.env` file, one variable can reference another:

```bash
BASE_HOSTNAME="acmelabs.com"
PRIMARY_SITE_URL="https://${BASE_HOSTNAME}"
GLOBAL_SITE_URL="https://global.${BASE_HOSTNAME}"
```

Depending on your infrastructure, this may also be possible at other points in process of loading environment variables. The example above works thanks to `vlucas/phpdotenv`; Docker (and therefore DDEV) share this general syntax, but not all variables are available at each step as the container boots up—so interpolation is best left until this last stage. Earlier layers may allow interpolation to be escaped so that it is only evaluated by a later one:

```bash
# Here, we escape the beginning interpolation token with a backslash (\):
BASE_API_HOSTNAME="api.\${DDEV_HOSTNAME}"
```

Craft does not know or indicate when substitutions have occurred—it only sees the final, fully-resolved values.

::: warning
Variables with substitutions will only be written back into the environment when using one of the [mutable loaders](https://github.com/vlucas/phpdotenv?tab=readme-ov-file#immutability-and-repository-customization).
:::

### Entry Script

Craft will also respond to a handful of [specific environment variables or PHP constants](#bootstrap-config), as long as they are set prior to bootstrapping the application in your entry script. The [starter project](repo:craftcms/craft) shares a `bootstrap.php` file between `web/index.php` and the `craft` executable to consolidate the definition of constants.

### Secrets

You can store sensitive values that won’t leak into the process’s environment in a special “secrets” file. The path to this file is determined by the [`CRAFT_SECRETS_PATH` environment variable or constant](#craft_secrets_path). When defined, Craft will attempt to include a file at that path (presumed to be a PHP script that `return`s an associative array), and checks it prior to resolving any environment variable or constant with <craft5:craft\helpers\App::env()>.

```php
return [
    'SUPER_SECRET_KEY' => '...',
];
```

::: warning
Even though secrets aren’t automatically loaded into the environment on every request, they can still be accessed via application helpers, Twig templates (like system messages), other PHP scripts, or anyone with direct filesystem access.

This is only recommended in situations where environment variable exfiltration is among the last attack surfaces. If your server supports any form of remote access (say, via SSH), this is _not_ a practical security measure!
:::

## Setting and Resolving Options

Each setting accepts specific [types and values](#types-and-values) (like an integer, interval expression string, or boolean), but Craft can resolve them in two ways:

- **Statically:** A value is set explicitly in a config file, and is the same in all environments. Example: Customizing file types that can be uploaded.
- **Dynamically:** Values are only known at runtime, or are set conditionally based on the current environment. Typically, this will involve a call to [App::env()](craft5:craft\helpers\App::env()) using the name of an environment variable that is expected to exist—or whose absence is significant. Example: Dev mode, database connection details, or a storage bucket URL.

### Priority

Craft takes the first discovered value, in this order:

0. **Environment Overrides:** For general and database settings, Craft looks for special [environment variables](#environment-overrides) and [PHP constants](#php-constants).
1. **Config Files:** Craft evaluates and merges [multi-environment](#multi-environment-configs) and [application type](#application-types) PHP config files.
2. **Defaults:** Every option has a default value, even if it’s `null`. You can find these defaults in the documentation for each setting.

### Style

At its simplest, a config file returns a key-value map of settings:

```php
use craft\helpers\App;

return [
    'devMode' => App::env('DEV_MODE') ?? false,
    'userSessionDuration' => 'P1D',
];
```

If you are interested in auto-completion and type hints from your editor, the equivalent “fluent” style declaration would look like this:

```php
use craft\config\GeneralConfig;
use craft\helpers\App;

return GeneralConfig::create()
    ->devMode(App::env('DEV_MODE') ?? false)
    ->userSessionDuration('P1D');
```

Each option becomes a method call, accepting the same [values](#types-and-values) that you would provide in a config map. The configuration object is returned to allow chaining.

::: warning
Fluent config is currently available for _general_ and _database_ settings, but unsupported in plugins, [custom](#custom-settings) config files, and [application config](#application-configuration). When in doubt, use a config map!
:::

Config files can also return a closure that accepts a single `$config` argument and returns a config object. <Since ver="5.3.0" feature="Closures in config files" />

```php
// config/general.php

use craft\config\GeneralConfig;

return function(GeneralConfig $config) {
    return $config
        ->aliases([
            '@webroot' => dirname(__DIR__) . '/web',
        ])
        // ...
    ;
};
```

Craft will always pass an instance of <craft5:craft\config\GeneralConfig> or <craft5:craft\config\DbConfig> to a closure in the primary general or database config files, respectively—but [application type-specific files](#application-types) should accept whatever the _primary_ file returns:

::: code
```php general.php
return [
    'aliases' => [
        '@webroot' => dirname(__DIR__) . '/web',
    ],
];
```
```php general.console.php
return function(array $config) {
    $config['aliases']['@web'] = App::env('CLI_WEB_URL');

    return $config;
};
```
:::

There is no equivalent to `GeneralConfig` and `DbConfig` for [application](#application-configuration). If you return an array from the primary file, there is limited value in using a closure in an application type-specific file.

::: tip
The `GeneralConfig` class has a special `addAlias()` method that allows you to merge additional aliases, when using closures _and_ fluent config.
:::

### Application Types <Since ver="5.3.0" feature="Application type-specific config files" />

Craft has two primary application types—_web_ and _console_. Web requests are typically initiated by an HTTP server via `index.php`; console requests are initiated from the `craft` executable, on the command line.

You can provide configuration that targets a specific application type by creating additional general, database, or application configuration files with the appropriate suffix:

<div class="croker-table">

Category | File | Application Type
--- | --- | ---
[General](#general) | `general.php` | All
&nbsp; | `general.web.php` | Web only
&nbsp; | `general.console.php` | Console only
[Database](#database) | `db.php` | All
&nbsp; | `db.web.php` | Web only
&nbsp; | `db.console.php` | Console only
[Application](#application-configuration) | `app.php` | All
&nbsp; | `app.web.php` | Web only
&nbsp; | `app.console.php` | Console only

</div>

The primary config file is always evaluated, but only one of the `web` or `console` files are merged on top of it, when present.

::: tip
See the previous section for some examples of how to combine application type-specific configuration and config styles.
:::

### Types and Values

Most config settings expect a [scalar](https://www.php.net/manual/en/function.is-scalar.php) value, and will generate exceptions if they are not (and can not be coerced to) a valid type.

Normalization may occur on some values. For instance, any setting that expects a “file size” (like [`maxUploadFileSize`](config5:maxUploadFileSize)) will interpret a numeric value in bytes—but passing a string allows you to use other formats like `256M` or `1G` by virtue of Craft normalizing the value with [ConfigHelper::sizeInBytes()](craft5:craft\helpers\ConfigHelper::sizeInBytes()).

A few settings support complex types, like arrays and closures:

```php
use craft\config\GeneralConfig;

return GeneralConfig::create()
    // Arrays:
    ->extraFileKinds([
        'fonts' => [
            'extensions' => ['otf', 'ttf', 'woff', 'woff2'],
        ],
    ])
    // Functions or "closures":
    ->postLoginRedirect(function($siteHandle) {
        // Perform tests on the signed-in User:
        $user = Craft::$app->getUser()->getIdentity();

        // Send to their account, if their profile is incomplete...
        if (empty($user->someProfileField)) {
            return 'account/profile';
        }

        // ...or the homepage, by default:
        return '/';
    });
```

In this example, the function passed to `postLoginRedirect` will be called by [ConfigHelper::localizedValue()](craft5:craft\helpers\ConfigHelper::localizedValue()) with the current site’s handle, only *at the time the value needed*. This distinction is important, because Craft is not fully initialized when configuration files are *evaluated*, but will be by the time the application is ready to redirect a logged-in user.

Keep in mind that while scalar values are automatically normalized during configuration, the return value of a function *is not*.

::: tip
Refer to a config property’s documentation for a full list of its supported types and values!
:::

### Multi-Environment Configs

Config files using the traditional map style can define configurations for each of your environments all in one place—called a “multi-environment config”. 

To establish that your config file should be treated as a multi-environment config, it must have a `*` key which defines the base config that should be applied to each of your environments, followed by additional keys which will be matched against the [`CRAFT_ENVIRONMENT`](reference/config/bootstrap.md#craft-environment) environment variable or PHP constant.

When determining the exact configuration that should be used for a request, the base config and environment-specific config arrays will be merged together. If any config settings are defined by both arrays, the environment-specific config will take precedence.

For example, given the following multi-environment config:

```php
// -- config/general.php --
return [
    '*' => [
        // Applies to all environments:
        'defaultWeekStartDay' => 1,
        'omitScriptNameInUrls' => true,
        'allowAdminChanges' => false,
    ],

    'dev' => [
        // Only applies to development environments, overriding anything in `*`:
        'allowAdminChanges' => true,
        'devMode' => true,
    ],

    'production' => [
        // Only applies to the production environment, overriding anything in `*`:
        'cpTrigger' => 'secret-word',
    ],
];
```

Environments matching `dev` would end up with the following merged config:

```php
return [
    'defaultWeekStartDay' => 1,
    'omitScriptNameInUrls' => true,
    'allowAdminChanges' => true,
    'devMode' => true,
];
```

::: tip
Make sure your key(s) are sufficiently unique! Craft reads your array of config settings from top to bottom, applying config settings wherever the `CRAFT_ENVIRONMENT` value *contains* the key.

If the environment cannot be determined, your server’s hostname will be used.
:::

::: warning
Do not combine fluent and multi-environment config in the same file. Merging fluent config models causes all previously-set values to be overwritten.
:::

### Aliases

Some settings and functions in Craft support [Yii aliases](guide:concept-aliases), which are most often used as placeholders for file system paths and URLs.

Out of the box, Craft provides these aliases—but you can override them or provide new ones with the <config5:aliases> config setting:

| Alias | Description | Based On
| --- | --- | ---
| `@app` | Path to Craft’s source code. | [CRAFT_VENDOR_PATH](reference/config/bootstrap.md#craft-vendor-path)
| `@config` | Path to your `config/` folder. | [CRAFT_BASE_PATH](reference/config/bootstrap.md#craft-base-path)
| `@contentMigrations` | Path to your `migrations/` folder. | [CRAFT_BASE_PATH](reference/config/bootstrap.md#craft-base-path)
| `@craft` | Path to Craft’s source code. | `@app`
| `@dotenv` | Path to your [.env](system/directory-structure.md#env) file. | [CRAFT_DOTENV_PATH](reference/config/bootstrap.md#craft-dotenv-path)
| `@lib` | Path to extra libraries packaged with Craft. | `@app`
| `@root` | The root project path. | [CRAFT_BASE_PATH](reference/config/bootstrap.md#craft-base-path)
| `@runtime` | Path to your `storage/runtime/` folder. | `@storage`
| `@storage` | Path to your `storage/` folder. | [CRAFT_STORAGE_PATH](reference/config/bootstrap.md#craft-storage-path)
| `@templates` | Path to your `templates/` folder. | [CRAFT_TEMPLATES_PATH](reference/config/bootstrap.md#craft-templates-path)
| `@tests` | Path to your `tests/` folder. | [CRAFT_TESTS_PATH](reference/config/bootstrap.md#craft-tests-path)
| `@translations` | Path to your `translations/` folder. | [CRAFT_TRANSLATIONS_PATH](reference/config/bootstrap.md#craft-translations-path)
| `@vendor` | Path to your `vendor/` folder. | [CRAFT_VENDOR_PATH](reference/config/bootstrap.md#craft-vendor-path)
| `@web` | URL to the folder that contains the `index.php` file that was loaded for the request. | [CRAFT_WEB_URL](reference/config/bootstrap.md#craft-web-url)
| `@webroot` | Path to the folder that contains the `index.php` file that was loaded for the request. | [CRAFT_WEB_ROOT](reference/config/bootstrap.md#craft-web-root)

Aliases can be set to plain strings, or to the content of an environment variable. Keep in mind that **aliases are resolved recursively**, so you can define one based on another (including those whose values came from the environment):

```php
use craft\helpers\App;

return [
    'aliases' => [
        '@primaryUrl' => App::env('PRIMARY_SITE_URL'),
        '@shared' => App::env('SHARED_PATH'),
        '@uploads' => '@shared/web/uploads',
        '@assets' => '@primaryUrl/uploads',
    ],
];
```

Assuming `PRIMARY_SITE_URL` is defined as `https://mydomain.com` and `SHARED_PATH` is `/var/www/releases/123/shared`, these aliases would evaluate to:

- `@primaryUrl`: `https://mydomain.com`
- `@shared`: `/var/www/releases/123/shared`
- `@uploads`: `/var/www/releases/123/shared/web/uploads`
- `@assets`: `https://mydomain.com/uploads`

Recursive aliases are preferred to basic string interpolation, because they are evaluated at the time of _use_ rather than _definition_. Aliases are only resolved at the beginning of a string.

### Environment Overrides

Craft allows some settings to be defined directly from environment variables, PHP constants, or secrets using the special `CRAFT_` prefix.

Add the prefix to any [general config](reference/config/general.md) (`CRAFT_`) or [database connection settings](reference/config/db.md) (`CRAFT_DB_`) in [screaming snake case](https://dev.to/fission/screaming-snake-case-43kj). For example:

- General: <config5:allowUpdates> &rarr; `CRAFT_ALLOW_UPDATES`
- Database: [`port`](db.md#port) &rarr; `CRAFT_DB_PORT`
- General: <config5:testToEmailAddress> &rarr; `CRAFT_TEST_TO_EMAIL_ADDRESS`

::: danger
Any environment variable or constant names that match a known config setting (using the formula above) will have the [highest priority](#priority)! The `CRAFT_` prefix is intended to reduce the likelihood of collisions with other environment variables that a server or platform might inject—it’s actually _inadvisable_ to use this prefix when defining custom variables that aren’t intended to be used as overrides.
:::

Enforcing a structure for database connection details (even with a multi-environment config file) can cause problems when working with others, or across environments. Overrides make it possible to use whatever connection parameters are available in the current environment, without having to maintain a config file just to map variables to config settings.

::: tip
If you are working with others and your `.env` isn’t checked in to version control (it probably shouldn’t be!), make sure you have a way of communicating what options are required to get your application running! A `.env.example` file is a great place to store keys and comments, without exposing secrets—and it lets you simply copy the file when spinning up a new environment.
:::

## Using Configured Values

Most configuration is applied automatically on every request, and requires no additional action.

However, Craft provides a powerful way to use dynamically-resolved config values in other parts of the system.

<!-- Preserve links while craftcms/cms#11886 is in limbo! -->
<a name="environmental-configuration"></a>

### Control Panel Settings

Most values in the **Settings** area of Craft’s control panel are recorded in [Project config](system/project-config.md). While this makes schema changes much easier to move between environments, it presents a challenge when something like a URL needs to change per-environment, or an API key leaks into YAML files.

For this reason, Craft provides a way to bind system settings to dynamic aliases and environment variables.

![Craft’s autosuggest field, displaying a suitable match](./images/site-base-url-setting.png)

Whenever you see this UI, you can provide a valid alias or environment variable name, in addition to plain values. Craft will always store and display the raw, unparsed value, but uses [App::parseEnv()](craft5:craft\helpers\App::parseEnv()) when the value is consumed. Here are some examples of settings for which dynamic values are useful:

- **General Settings:** System Name, Status, and Time Zone;
- **Sites:** Base URLs;
- **Sections:** Preview Target URIs;
- **Asset Filesystems:** Base URL, File System Path (Local only);
- **Email:** System Email Address, Sender Name, Email Template path, SMTP credentials;

Focusing one of these fields will immediately suggest some values. Type `$` followed by an environment variable’s name, or `@` followed by an alias to narrow the suggestions and find your placeholder.

You may combine aliases and environment variables with additional path segments, so `@primaryUrl/uploads` and `$PRIMARY_SITE_URL/de` are both perfectly valid settings. <Since ver="5.5.0" feature="Combining environment variables with other path segments in project config values" /> If a combination of alias and path is used frequently, though, it might make sense to [define a specific alias](#aliases) (like `@uploads`) and use that in the control panel, instead. Prior to Craft 5.5.0, this was only a feature of aliases; environment variables _could not_ be prepended to other values.

::: tip
Plugins can add support for environment variables and aliases in their settings as well. See [Environmental Settings](extend/environmental-settings.md) to learn how.
:::

### Templates and Modules

#### Accessing Config Values

You can check the final resolved value of a setting in your templates or a module via the `Config` service. For example, if you wanted to switch some debugging information on or off, you could do the following:

::: code
```twig
{# Output entry ID for debugging: #}
{% if craft.app.config.general.devMode %}
  ID: <code>{{ entry.id }}</code>
{% endif %}
```
```php
// Add `DevMode` header when active:
if (Craft::$app->config->general->devMode) {
  Craft::$app->request->headers->set('DevMode', 'On');
}
```
:::

#### Aliases and Environment Variables

In the event you need to evaluate an alias or environment variable directly in Twig or PHP, Craft provides some helpers:

::: code
```twig
{# Resolve an alias, recursively: #}
{{ alias('@uploadsBaseUrl') }}

{# Access a specific environment variable: #}
{{ getenv('SOME_ENV_VAR') }}

{# Fully resolve a value, as though it came from a control panel setting: #}
{{ parseEnv(craft.app.config.custom.myDynamicValue) }}
```
```php
// Resolve an alias, recursively:
Craft::getAlias('@uploadsBaseUrl');

// Access a specific environment variable:
craft\helpers\App::env('SOME_ENV_VAR');

// Fully resolve a value, as though it came from a control panel setting:
craft\helpers\App::parseEnv(Craft::$app->config->custom->myDynamicValue);
```
:::

## Config Categories

To make config settings easier to find, they’re organized into a few groups.

### General

[General config settings](reference/config/general.md) are set via the `config/general.php` file, or using special environment variables.

### Database

Your [database connection settings](reference/config/db.md) are set via the `config/db.php` file, or using special environment variables.

### URL Rules

You can define custom [URL rules](guide:runtime-routing#url-rules) in `config/routes.php`, and [redirection rules](system/routing.md#redirection) in `config/redirects.php`. <Since ver="5.6.0" feature="Redirection rules" />

See [Routing](system/routing.md) for more details about Craft’s request handling behavior.

### Application Configuration

Some projects may require customization of Craft [application components](reference/config/app.md) beyond what is exposed through specific config files. This is done directly via the `config/app.php` file.

### Advanced

In rare cases, you may need to customize parts of Craft that don’t follow the normal configuration scheme.

#### Guzzle

Craft uses [Guzzle](http://docs.guzzlephp.org/en/latest/) to make HTTP requests, when…

- …checking for Craft updates;
- …sending a support request from the Craft Support widget;
- …loading RSS feeds from the Feeds widget;
- …working with assets on remote volumes, like Amazon S3;

You can customize the settings passed to Guzzle when initializing these requests by creating a `guzzle.php` file in your `config/` folder. The file does not support Craft’s [multi-environment configuration](#multi-environment-configs) and should only ever return an array with your config overrides at the top level.

```php
return [
    'headers' => ['Foo' => 'Bar'],
    'query' => ['testing' => '123'],
    'auth' => ['username', 'password'],
    'proxy' => 'https://myproxy:1234',
];
```

The options defined here will be passed into new `GuzzleHttp\Client` instances. See [Guzzle’s documentation](http://docs.guzzlephp.org/en/latest/) for a list of available options.

::: tip
To use a proxy for _all_ requests, set an [httpProxy](config5:httpProxy) in general config. This will get merged with the Guzzle configuration, and passed to the front-end for use by JavaScript, in the [control panel](system/control-panel.md). Setting a proxy only in Guzzle’s config will not affect Ajax requests!
:::

### Custom Settings

Settings defined in a `config/custom.php` file don’t map to or affect any built-in Craft features, but can useful to centralize data, flags, or secrets that otherwise don’t have a place to live.

```php
return [
    'serviceBaseUrl' => 'https://api.service.com/v1',
    'servicePublishableKey' => App::env('SERVICE_PUBLISHABLE_KEY'),
    'servicePrivateKey' => App::env('SERVICE_PRIVATE_KEY'),
];
```

Custom config follows the same multi-environment structure as other files, so you can use the resolved values in a predictable way in any context:

::: code
```twig
{% set publishableKey = craft.app.config.custom.servicePublishableKey %}

{% js "https://cdn.service.com/client.js?key=#{publishableKey}" %}
```
```php
$privateKey = Craft::$app->config->custom->servicePrivateKey;

$client = Craft::createGuzzleClient([
    'base_uri' => Craft::$app->config->custom->serviceBaseUrl,
]);

$client->post('/donations', [
    'auth' => ['apiuser', $privateKey],
    'json' => [
        'amount' => 1000,
    ],
]);
```
:::

::: tip
If these settings need to be changed frequently, edited by a control panel user, or don’t depend on the environment, they may be a better fit for a [Global Set](reference/element-types/globals.md).
:::

#### HTML Purifier

JSON files containing valid [HTML Purifier configuration](https://htmlpurifier.org/live/configdoc/plain.html) can be added to `config/htmlpurifier/`.

When creating a [Redactor](plugin:redactor) or [CKEditor](plugin:ckeditor) field, you can select one of your predefined purifier configs—or provide a one-off config object. The [`purify`](reference/twig/filters.md#purify) filter also accepts a reference to an existing config file or a complete config object.

A simple config that scrubs everything but paragraph and anchor tags would look like this:

```json
{
  "HTML.AllowedElements": "p, a",
}
```

For security, any keys _not_ set will use their [defaults](https://github.com/ezyang/htmlpurifier/blob/master/plugins/phorum/config.default.php).

::: tip
Note that HTML Purifier expresses many options with dot notation, like `HTML.AllowedElements`. These are the literal keys, not an indication that keys should be nested!
:::

<a id="php-constants"></a>

## Bootstrap Config

Some customization is handled via special variables (set as PHP constants or environment vars) that Craft will take into account as it boots up. Depending on your installation, you may keep these in `web/index.php` and the `craft` CLI entry points, or consolidate common values into a single `required` file, as the [starter project](repo:craftcms/craft) does in its `bootstrap.php` file—they’ll get picked up as long as they’re set prior to calling `$app->run()`.

By virtue of accessing these via <craft5:craft\helpers\App::env()>, Craft also honors values defined by your environment under the same names or keys. The majority of these settings are tied specifically to the structure of your project directory, though, and generally do not need to change between environments.

::: tip
Constants you set directly in `web/index.php` will only be defined for _web_ requests, while any you set in the `craft` executable will only be defined for _console_ requests. Use `bootstrap.php` to define constants for _all_ requests.
:::

<See path="reference/config/bootstrap" label="Bootstrap Variable Reference" description="View a list of bootstrap variables that Craft uses." />
</file>

<file path="deploy.md">
---
description: Recommendations for hosting and deploying a Craft application.
sidebarDepth: 2
---

# Hosting & Deployment

In more cases than not, our recommendations for hosting and deploying a Craft website also describe effective processes for collaborating with teammates. Let’s start by reviewing some general advice on managing a Craft project.

<!-- more -->

## Workflow

Our goal here is to define processes that reduce the likelihood of mistakes making it onto a live website, and to adopt systems that help recover [if/when they do](#common-pitfalls).

### Source Control

No matter how you work—or who you work with—the single most important thing to do when dealing with code is to frequently check it in to [version control](https://www.atlassian.com/git/tutorials/what-is-version-control). Having regular checkpoints and backups can mitigate all kinds of unexpected losses and regressions.

Pushing your work to a centralized repository (GitHub, GitLab, Bitbucket, or elsewhere) also means that getting new code onto a server during a deployment is dramatically simplified.


### System Updates + Project Config

Craft uses Composer under the hood to install and [update](./update.md) plugins and packages it depends on.

Your [`composer.lock`](system/directory-structure.md#composerlock) file defines the _exact_ set of packages that your project uses, so tracking it in version control is essential. The lockfile is updated any time you run system updates or install a new plugin, making it possible for Composer to reconstruct your entire [`vendor/`](system/directory-structure.md#vendor) directory.

In a similar manner, changes you make to your site’s settings and content model are tracked by [project config](system/project-config.md) and written to YAML files in the `config/project/` directory. These files should also be committed to version control.

To stay on top of changes from your team, run these two commands _every time you pull new code_:

1. `composer install`: Ensures the `vendor/` directory contains the expected packages;
1. `php craft up`: Applies incoming project config changes;

We’ll look at how these systems relate to a [typical deployment](#typical-process) in a moment.

### Content

In most cases, your live site’s content should be treated as authoritative: code and configuration flow up (deployment), and content flows back down (database backups).

::: tip
Craft has a built-in backup tool, accessible from the **Utilities** screen of the control panel (for users with the correct permissions) or as a [console command](reference/cli.md#db-backup). There’s also a command for [restoring](reference/cli.md#db-restore) backups!
:::

It is not advisable to attempt merging database tables or otherwise combining local and live content—including completely squashing a live database with a development one. [Project Config](#system-updates-project-config) is Craft’s solution to diverging schema and content.

If you ever need to prepare content ahead of a deployment (say, if you’ve created a new [single](reference/element-types/entries.md#singles) and can’t risk users seeing a partially blank page), consider using a [content migration](extend/migrations.md).

## Selecting a Host

Craft will work on virtually any hosting platform that meets its [requirements](requirements.md), but choosing one that matches your expectations for performance and reliability—and your appetite for devops—is key.

::: tip
Check out our [introduction to hosting](kb:hosting-craft-101) Knowledge Base article if this is your first time launching a Craft project, or spin up a free seven-day trial of [Craft Cloud](https://craftcms.com/cloud)!
:::

<columns>
<column>

### Recommendations

- Choose a host that offers dedicated resources. This is sometimes referred to as a “virtual private server,” and will often include specific system information when selecting a service plan, like the number of CPU cores, RAM, and disk space allocated to your project.
- For un-managed hosting, consider using a provisioning tool like [Laravel Forge](https://forge.laravel.com/), [ServerPilot](https://serverpilot.io/), or [Ploi](https://ploi.io/) to simplify setup and maintenance.

</column>
<column>

### Red Flags

- “Shared” hosting may be the most affordable option, but often pits you against other tenants for resources on the same machine.
- Lack of SSH access (i.e. FTP-only hosts) means you will be unable to run [console commands](reference/cli.md), and significantly limits your [deployment](#deployment) options.
- While convenient, the presence of cPanel is often a sign that the host is re-selling resources, without control over the actual hardware.

</column>
</columns>

### Advanced Options

Craft plays well with non-traditional infrastructure. Let’s look at some examples of how you might take advantage of a provider’s other services.

#### Remote Databases

Your database does not need to be on the same machine that serves web requests. If your provider offers hosted or “managed” databases, consider how your [database settings](reference/config/db.md) may differ—in most cases, the only difference is what hostname (or [`server`](reference/config/db.md#server)) you tell Craft to connect to.

::: tip
Keep in mind that introducing a network roundtrip for each database call can add up quickly. Profile requests with Yii’s debug toolbar to see how this impacts your load times!
:::

A remote database is one prerequisite for [scaling](#scalability) your server horizontally.

#### Scalability

Craft benefits from both vertical and horizontal scaling. Giving your server more compute power and RAM, tuning the HTTP server, and [offloading the database](#remote-databases) and other services (vertical scaling) can bring immediate performance improvements. [Distributing load](kb:configuring-load-balanced-environments) across multiple web servers (horizontal scaling) is also viable, thanks to Craft’s support for centralized [cache](reference/config/app.md#cache) and [session](reference/config/app.md#session) storage.

If your site demands global distribution (and can’t be cached at the edge), you may be able to take advantage of read/write splitting, replication, and other [advanced database configuration](reference/config/app.md#database) options to improve performance across regions.

Choosing the right asset storage medium or [filesystem](reference/element-types/assets.md#filesystems) is another critical component of hosting—especially when it comes to durability and availability.

#### “Platform as a Service”

Proprietary and open source cloud computing solutions are both options for hosting a Craft application. Services like [Heroku](https://heroku.com/) and the Digital Ocean [App Platform](https://www.digitalocean.com/products/app-platform) are designed to reduce your devops burden by provisioning and scaling resources, as well as integrating build pipelines, workers, release hooks, logs, or alerts.

## Deployment

Broadly, we’re defining _deployment_ as the process of publishing code changes to a live website. For the following examples, we’ll assume your project uses the standard [directory structure](system/directory-structure.md).

::: tip
Be sure and read our [Deployment Best Practices](kb:deployment-best-practices) article for some high-level recommendations. What follows is intended for technical users who are tasked with extending their workflow to a web server.
:::

### Typical Process

Let’s look at how to apply a Craft-centric [workflow](#workflow) to deployments. To provide concrete examples, we’ll split the process into three phases:

1. **[Build](#build):** Compile all the code that makes the project run.
1. **[Release](#release):** Expose your new build to traffic.
1. **[Migrate](#migrate):** Bring the database into agreement with the new code.

Once these definitions are clear, check out some [examples](#examples).

::: tip
These phases aren’t _necessarily_ discrete or sequential, but [isolating each step](#atomic-deployment) can make recovery from a failed deployment much quicker and easier.
:::

#### One-time Setup

Before you deploy a project for the first time, there is apt to be some setup. This might mean uploading an initial batch of assets, creating some config files, setting up SSH keys, importing a database backup, or connecting a service to GitHub. These requirements will emerge as you decide on the specifics of your deploy process—and where each phase of it happens.

#### Build

The build phase can vary widely between sites, tools, and platforms. Our primary goal in this phase is to create a fresh copy of your site’s code in as near-complete a state as possible. This will often involve:

- Cloning the latest code from your repository;
- Installing Composer dependencies;
- Rendering other artifacts like CSS and JavaScript;

Compiling your application may happen any number of places: locally; directly on the live server; or on a separate cloud-based action runner like [Buddy](https://buddy.works) or [GitHub Actions](https://github.com/features/actions).

#### Release

This phase is only concerned with replacing the running website with the new build. In some cases, the _build_ and _release_ phases may partially or completely overlap; in others, a release could involve rerouting traffic to an entirely new container!

::: tip
This is also a great time to [clear caches](reference/cli.md#clear-caches)—cached data and templates may be incompatible with the new build.
:::

#### Migrate

The final step in any successful deployment should be running migrations. Craft can apply database migrations and project config changes in a single command:

```bash
php craft up --interactive=0
```

Before any pending migrations are applied, Craft will capture a database backup.

### Examples

With a generic deployment framework in place, we’re ready to get into a few concrete examples.

#### Simple Git

Let’s assume you’ve cloned your project onto a host, and configured it to serve requests directly out of the `web/` directory.

Within the project’s root directory, a simple Git-based deployment might look like this:

```bash
# Fetch new code:
git pull

# Install dependencies:
composer install --no-interaction

# Run migrations and apply project config:
php craft up --interactive=0

# Build front-end artifacts (less urgent / lower priority):
npm install && npm run build
```

Here, the build and release steps are basically combined: updates are integrated directly into the live codebase. For many sites, this is a totally viable process!

If you ever need to roll back after a broken deploy, just check out an earlier commit, run `composer install` (and the `npm` commands, if necessary), and—if Craft had run migrations—restore the automatic database backup from `storage/backups/`.

::: warning
Take care to not expose your `.git` directory (or other private files) to the web!
:::

#### Atomic Deployment

Let’s look at some ways we might improve upon this simple deployment scheme. Our main goal will be to separate each phase of the deployment, so that the live site spends as little time as possible in an intermediate or partially-updated state.

The combination of `git pull` and `composer install` are the most problematic—but we should also make an effort to pre-build front-end resources. Instead of doing all this work directly in a live directory, let’s move it off to the side.

Suppose your project lives at `/var/www/craft-project/`, and Apache or nginx is configured to use `/var/www/craft-project/web/` as your web root. In `/var/www/`, create two new folders:

```treeview{3,4}
/var/www/
├── craft-project/
├── releases/
└── shared/
```

Within `/var/www/`, a deployment might follow these steps:

```bash
# Get a timestamp to identify this release:
DATE="$(date +'%Y-%m-%d--%H%M%S')" # -> 2023-01-01--123456

# Define paths we’ll be working with:
WORKING="/var/www"                 # Root deploy directory
RELEASE="$WORKING/releases/$DATE"  # New release directory
CURRENT="$WORKING/current"         # Live release “link”

# Shallow-clone a fresh copy of the latest project files into our release directory:
git clone --depth=1 git@github.com/organization/repo $RELEASE

# Move into the release directory:
pushd $RELEASE

# Install Composer packages:
composer install --no-interaction

# Build other artifacts:
npm install
npm run build

# Move back out to the main directory:
popd

# Create a symbolic link to the new release:
ln -sf $RELEASE $CURRENT
```

After a deployment, the working directory will look like this:

```treeview{3,5}
/var/www/
├── craft-project/
├── current -> /var/www/releases/2023-01-01--123456/
├── releases/
│   ├── 2023-01-01--123456/
│   └── ...
└── shared/
```

::: tip
Don’t want to bother with Git, Node, or Composer on your server? The entire “build” step of an atomic deployment can be done elsewhere, then uploaded to the `releases/` directory all at once.
:::

There are a few more pieces to this puzzle, though:

- How do we actually serve our new deployment?
- How we can we persist files between releases?
- What about migrations?

The first is straightforward: your HTTP server’s web root must be updated to`/var/www/current/web/`, taking advantage of the stable [symbolic link](https://en.wikipedia.org/wiki/Symbolic_link) created by the last step in the deployment script. This is a _one-time change_ to the server’s configuration—subsequent deploys will just replace the `current` symlink!

We can also address persistent files with symbolic links. For each file or directory you want to keep between deployments, add a line just before the final `current` link is created. For the sake of clarity, we’ll also define a new variable pointing to the `shared/` directory we created earlier:

```bash
# ...

SHARED="$WORKING/shared"

# Create links to persistent files:
ln -s "$RELEASE/.env" "$SHARED/.env"
ln -s "$RELEASE/web/uploads" "$SHARED/web/uploads"

# Create a symbolic link to the new release:
ln -sf $RELEASE $CURRENT
```

Before this will work, you’ll have to move the “shared” files out of `craft-project/` and into the `shared/` directory. The sub-paths within `shared/` don’t have to be identical, but they should make sense to you and must agree with the script:

```treeview{6,8,13,15}
/var/www/
├── craft-project/
├── current → /var/www/releases/2023-01-01--123456/
├── releases/
│   ├── 2023-01-01--123456/
│   │   ├── .env → /var/www/shared/.env
│   │   ├── web/
│   │   │   ├── uploads/ → /var/www/shared/web/uploads/
│   │   │   └── ...
│   │   └── ...
│   └── ...
└── shared/
    ├── .env
    └── web/
        └── uploads/
            └── ...
```

Lastly, migrations and project config may still take a moment to apply—it’s up to you to determine how much downtime your project can tolerate! The only thing different from the simple deployment is the `craft` executable path:

```bash
# ...

# Run migrations and apply project config:
php $RELEASE/craft up --interactive=0
```

With an atomic deployment, rollbacks are trivial—the symlink can just be replaced with a previous release, because they’re left exactly as-is.

This is just a blueprint for an “atomic” deployment—there are countless ways to improve upon it for a given site or server. Tools like [Deployer](https://deployer.org/) (a PHP package, itself) provide an abstraction for deployment that is more similar to configuration than scripting, and services like [Laravel Envoyer](https://envoyer.io) roll everything into a neat, hosted solution.

#### Fully-Integrated Platform

On PaaS products like Heroku, you are often only responsible for connecting a repository—the platform figures out what steps are required to build the application and the underlying server “image.” In these cases, the presence of `composer.json` is often enough to indicate that the image needs a PHP runtime and that `composer install` must be run to gather dependencies.

This paradigm also turns the “release” phase on its head: instead of deploying a bundle of _code_, the _entire server image_ (or images, if scaled horizontally) is cycled into the pool of resources and new requests are routed to it—effectively eliminating downtime.

Heroku is just an example of this model, pioneered by Kubernetes and other infrastructure orchestration technologies.

::: tip
Adopting all or parts of the [twelve-factor app](https://12factor.net/) paradigm can be a little disorienting. In particular, an [ephemeral filesystem](reference/config/bootstrap.md#craft_ephemeral) means you will need to adjust the way environment variables are set (in lieu of `.env`), how the cache works, and how sessions are stored. Some of these options are discussed in [advanced application configuration](reference/config/app.md).
:::

## Common Pitfalls

Sometimes, bad things do happen—despite all our preparation. Here are some common issues you might encounter when working with a hosted Craft site.

### Backups

Draft a recovery plan and test it regularly. Backups that exist only on the machine that is being backed up aren’t really backups! Make sure backups that are part of your recovery plan are copied to at least one other off-site location.

### Admin Changes

<config5:allowAdminChanges> should be disabled in all but development environments. If administrators are allowed to make project config changes directly on a live website without oversight, their changes may be reverted the next time you deploy.

### Dev Mode

<config5:devMode> is an invaluable debugging tool for local development—but it’s a performance and security liability on a public-facing website. Keep it off by default, and enable it only via you local `.env` file, by adding `CRAFT_DEV_MODE=true`.

::: tip
Even when `devMode` is off, you can still get profiling data from the Yii debug toolbar by enabling it in your user’s preferences.
:::

### Be Aware of Artifacts

Not everything that comprises a Craft site is (or should be) tracked in version control:

- Assets uploaded to a local [filesystem](reference/element-types/assets.md#filesystems) via the [control panel](system/control-panel.md);
- Database backups (stored in [`storage/backups/`](system/directory-structure.md#storage));
- Secrets (usually [relegated to `.env`](configure.md#env));
- Caches and other temporary files;
- Compiled CSS or JavaScript;

::: tip
See the official [starter project](repo:craftcms/craft)’s `.gitignore` file for a more complete list of files we recommend excluding from version control.
:::

When introducing new code onto your server, consider which of the above files should be kept in place and which can be discarded. Fully replacing your web root or project folder is rarely the right move: you shouldn’t need to rebuild configuration or copy files back in after deploying new code, and your client’s uploads should never be deleted or overwritten.

Similarly, if you are using Git directly on a server to pull new code in, how do you reconcile unforeseen changes that happen on-disk?

### Cloud Storage

There are a ton of benefits to using a remote filesystem for your assets, but care must be taken when managing files in a development environment: deleting or moving assets via the control panel can cause problems the live environment to lose track of files in the storage bucket and may lead to broken links.

### Precision + Judgement

Deployments requiring careful timing, quick decision-making, manual intervention, or other non-automated steps should be avoided. Even if the process is well-defined, understood, and practiced, the door remains open to human error.

### The Queue

If you use a [daemonized queue runner](system/queue.md#daemon) (based on `systemd` or `service`, for instance), it will need to be restarted to pick up the latest application code. [CRON-driven queues](system/queue.md#cron) load the application at each interval and do not need any special treatment. If the path to your application’s `craft` executable changes on each deployment, consider setting up a reliable symlink, or make the appropriate changes to service configuration files or your `crontab`!
</file>

<file path="editions.md">
---
related:
  - uri: https://craftcms.com/pricing
    label: Craft Pricing
  - uri: https://craftcms.com/knowledge-base/licensing-editions
    label: Licensing & Editions in the Knowledge Base
  - uri: https://craftcms.com/knowledge-base/how-craft-license-enforcement-works
    label: License Enforcement
  - uri: https://craftcms.com/knowledge-base/how-craft-licenses-and-renewals-work
    label: How Renewals Work
  - uri: https://craftcms.com/knowledge-base/how-to-trial-craft-cms-and-plugin-editions
    label: Trialing Craft and Plugins
---

# Licensing & Editions

Every Craft project starts with a free **Solo** license, which is valid for public and private use, indefinitely.

Additional features like user management are available by [upgrading](#upgrading) to a paid **Team** or **Pro** license. The current Craft edition and version are displayed at the bottom of every control panel screen.

Throughout the documentation, edition-specific features are called out with <Badge type="edition" text="Team" vertical="middle" /> and <Badge type="edition" text="Pro" vertical="middle" /> badges. If you don’t see a badge on a page or section, it describes features available to all Craft editions.

<See url="https://craftcms.com/pricing" label="Features & Pricing" description="Read more about pricing for Craft editions and services." />

## Upgrading

To try out a paid Craft edition, visit the **Plugin Store** in the [control panel](system/control-panel.md#plugin-store), and click **Upgrade Craft CMS** in the sidebar:

<BrowserShot url="https://my-project.ddev.site/admin/plugin-store" :link="false" caption="">
<img src="./images/craft-license-in-app-upgrade.png" alt="Screenshot of Craft’s in-app plugin store opened to the editions screen" />
</BrowserShot>

Selecting an edition will update [project config](system/project-config.md) and replace the **Try** button with a green **Installed as a trial** message.

## Plugins

Some plugins have editions, as well! The [Plugin Store](https://plugins.craftcms.com/) displays editions in the sidebar, each having a **Try** button. Check the **Editions** tab for more information from the developer.

## Trials

You are allowed to test paid Craft and plugin editions on private domains for as long as you need. However, deploying an unlicensed edition of Craft to a [public domain](kb:how-craft-license-enforcement-works#public-domains) will cause the control panel to display licensing issues to all [administrators](system/user-management.md#admin-accounts).

<See url="https://craftcms.com/knowledge-base/how-to-trial-craft-cms-and-plugin-editions" label="Craft CMS & Plugin Trials" description="Learn how to test and license paid Craft and plugin editions." />
</file>

<file path="install.md">
# Installation

The prevalence of modern, mature PHP development tools and infrastructure makes Craft easy to install, run, [upgrade](./upgrade.md), and [deploy](./deploy.md).

<!-- more -->

This [quick-start](#quick-start) guide focuses solely on setting up a local Craft development environment. If you’re ready to launch, jump to the [hosting](#hosting) or [deployment](#deployment) section.

::: tip
If at any point you feel stuck, the [Tutorial](../getting-started-tutorial/README.md) is a comprehensive guide for _anyone_ who wants to get set up with a fast, reliable development environment.
:::

Downloading or installing Craft by any means binds you to its [license](https://craftcms.com/license).

## Quick-Start

Your journey with Craft begins on your local machine, using [DDEV](https://ddev.readthedocs.io/en/stable/). DDEV is a Docker-based PHP development environment that streamlines the creation and management of resources required by a Craft project.

::: tip
While we [strongly recommend](#why-ddev) DDEV for new Craft projects, [alternate installation methods](#alternative-installation-methods) are available for anyone with a preexisting environment or preferred workflow that meets its [requirements](./requirements.md).
:::

[Install or update DDEV](https://ddev.readthedocs.io/en/stable/users/install/), then follow these steps:

1. Create a project directory and move into it:

    ```bash
    mkdir my-craft-project
    cd my-craft-project/
    ```

1. Create DDEV configuration files:

    ```bash
    ddev config --project-type=craftcms --docroot=web
    ```

1. Scaffold the project from the official [starter project](https://github.com/craftcms/craft):

    ```bash
    ddev composer create-project "craftcms/craft"
    ```

    The setup wizard will start automatically! Accept all defaults (in `[square brackets]`), and note your chosen username and password.

    ::: tip
    Our [First-Time Setup](kb:first-time-setup) guide in the Knowledge Base has more information about what to expect during setup.
    :::

Congratulations! You now have a fully-functional Craft application installed and configured. Run `ddev launch` to view the starter project’s welcome screen:

<BrowserShot
    url="https://my-craft-project.ddev.site/"
    :link="false"
    id="welcome-screen"
    :poi="{
        'cp-link': [38, 72],
    }">
<img src="./images/welcome.png" alt="A new Craft installation’s welcome screen" />
</BrowserShot>

## Next Steps

Ready to dive in? Sign in to the [control panel](./system/control-panel.md) by clicking **Go to your control panel** <Poi label="1" target="welcome-screen" id="cp-link" /> from the welcome screen, or running `ddev launch admin`. The username and password you provided during [setup](kb:first-time-setup) were used to create the first admin user.

You’re welcome to explore things at your own pace—but here are some great starting points:

- Get familiar with the [directory structure](./system/directory-structure.md) that was created during installation;
- Review [configuration](configure.md) methods and options;
- Explore Craft’s main content tools: [elements](./system/elements.md) and [custom fields](./system/fields.md);
- Run a [console command](./reference/cli.md) using `ddev craft ...` to explore the CLI;
- Discover [plugins](./system/plugins.md) to add features or integrate with other services;
- Find help and inspiration within our vibrant [community](https://craftcms.com/community)!

Done for the day? [`ddev stop`](https://ddev.readthedocs.io/en/stable/users/basics/commands/#stop) will spin down any containers for the project and free up system resources. [`ddev start`](https://ddev.readthedocs.io/en/stable/users/basics/commands/#start) boots everything back up, right where you left off.

### Workflow + Collaboration

We believe that starting with a local development environment (rather than directly on a remote server) fosters a workflow that will support the reliability and longevity of your project.

<See path="deploy.md#workflow" label="Defining a Workflow" />

::: tip
To get a collaborator set up, commit your working folder to git (including the `.ddev/` directory) and create a [database backup](./reference/cli.md#db-backup). Have them clone the project, download the backup, and run:

```bash
ddev start
ddev import-db < path/to/backup.sql
```
:::

## Further Reading

### Why DDEV?

DDEV is our recommended development environment because it isolates software required to run Craft from your local machine—and from your other projects. Each of your sites can be spun up with its own database and PHP version, without the need to manage or switch between specific software packages.

The environment for each project is [defined as YAML files](https://ddev.readthedocs.io/en/stable/users/configuration/config/), meaning `ddev start` is usually the only thing required to start working on a project on a new machine—or with a collaborator.

The Docker requirement is not taken lightly! We believe that this one-time installation is much more sustainable for new and returning Craft developers than managing a bare-metal development environment—locally or on a remote server.

### Alternative Installation Methods

Depending on your experience and preferred development environment, you may find one of these platform-agnostic installation processes more comfortable:

- For most environments meeting Craft’s requirements, see [Using the Starter Project](kb:using-the-starter-project) to get started with Composer.
- Especially adventurous users may want to read about [Setting up a Craft Project from Scratch](kb:setting-up-a-craft-project-from-scratch).
- If you are unable to start a project locally—or are constrained by a hosting service—you can directly [download](https://craftcms.com/latest.zip) the latest Craft release as a blank starter project.

::: warning
Pre-built starter project ZIPs should only be used for evaluating Craft in limited circumstances.
:::

### Hosting

The fastest way to share your work is with a free seven-day trial of our first-party hosting platform, [Craft Cloud](https://craftcms.com/cloud).

<See path="deploy.md" hash="selecting-a-host" label="Selecting a Host" description="Know your options when looking for a good hosting solution." />

Craft’s own footprint is relatively light, but it’s important to choose a platform that matches your traffic, storage, and redundancy needs. We maintain a [list of Craft-friendly hosting products](kb:hosting-craft-101) for projects of varying scale.

### Deployment

<See path="deploy.md" />

There is no one-size-fits-all deployment strategy for a Craft project, but we’ve collected our most salient advice in the [Deployment Best Practices](kb:deployment-best-practices) Knowledge Base article.

Regardless of your target infrastructure, it’s important to define a workflow for yourself and your collaborators. Starting a project from a local environment sets a precedent for the flow of code and configuration; while it is _possible_ to scaffold a project directly on a remote host, maintaining a single source of truth for the site will become difficult with changes being made in multiple places, by multiple parties, or without a means of testing those changes in isolation.

### Troubleshooting

Having trouble with DDEV? Make sure your [Docker](https://ddev.readthedocs.io/en/stable/users/install/docker-installation/#testing-and-troubleshooting-your-docker-installation) installation is working properly, then head to their [troubleshooting](https://ddev.readthedocs.io/en/stable/users/basics/troubleshooting/) page for specific issues.

See the [Troubleshooting a Failed Craft Installation](kb:troubleshooting-failed-installation) Knowledge Base article for more common installation hang-ups.
</file>

<file path="README.md">
---
title: Craft CMS 5.x
description: Official documentation for Craft CMS 5.x
---

# About Craft CMS

Craft is a flexible, user-friendly CMS for creating custom digital experiences on the web—and beyond.

<!-- more -->

People who use Craft love its…

- …intuitive, user-friendly [control panel](system/control-panel.md) for content creation and administrative tasks;
- …clean-slate approach to content modeling and [front-end development](development/README.md) that doesn’t make any assumptions about your content or how it should be delivered;
- …official Plugin Store with hundreds of free and commercial [plugins](https://plugins.craftcms.com/);
- …robust framework for [plugin development](extend/README.md);
- …active, vibrant [community](https://craftcms.com/community);

You can learn all about it at [craftcms.com](https://craftcms.com).

## Getting Started

Ready to try out the latest version of Craft? Spin up a [new project](install.md) or [upgrade](upgrade.md) an existing one.

<Block label="Documentation Changes">

The documentation has been rearranged a bit for this release, in order to better highlight the breadth of Craft’s features and consolidate technical material:

- High-level concepts are more visible in the [**System**](system/README.md) section;
- [**Reference**](reference/README.md) material has been given a dedicated space, including [element types](system/elements.md), [field types](system/fields.md), [console commands](reference/cli.md), controllers, Twig features, and [configuration](configure.md).
- Some pages geared toward front-end development have been moved into the [**Development**](development/README.md) section, including lots of new information on [eager-loading](development/eager-loading.md) and [collections](development/collections.md);
- Information about using [forms](development/forms.md) has been split into a dedicated page, while specific [controller actions](reference/controller-actions.md) remain in the **Reference** section. 

</Block>

## Tech Specs

Craft is a self-hosted PHP application, built on [Yii 2](https://www.yiiframework.com/). It can connect to MySQL and PostgreSQL [databases](reference/config/db.md) for content storage. Server-side rendering is powered by [Twig](https://twig.symfony.com), and headless applications have access to content via a [GraphQL API](development/graphql.md).

<See path="requirements.md" label="View System Requirements" description="Craft runs best on the latest PHP and MySQL or Postgres versions, but can be configured to work on most modern hosting platforms." />

## Diving In

Here are some great ways to begin your journey with Craft:

<div class="sm:flex sm:flex-wrap">
    <div class="py-1 sm:w-1/2 sm:py-0">
        <IconLink
            title="Tutorial"
            subtitle="New to Craft? This is the place to start."
            link="/getting-started-tutorial"
            icon="/docs/icons/icon-tutorial.svg"
            iconSize="large" />
    </div>
</div>

<div class="sm:flex sm:flex-wrap">
    <div class="py-1 sm:w-1/2 sm:py-0">
        <IconLink
            title="System Tour"
            subtitle="Discover all the tools at your disposal."
            link="system"
            icon="/docs/icons/icon-generic-link.svg"
            iconSize="large" />
    </div>
    <div class="py-1 sm:w-1/2 sm:py-0">
        <IconLink
            title="Content & Elements"
            subtitle="Learn about content modeling in Craft."
            link="system/elements"
            icon="/docs/icons/icon-generic-link.svg"
            iconSize="large" />
    </div>
    <div class="py-1 sm:w-1/2 sm:py-0">
        <IconLink
            title="Front-End Development"
            subtitle="Deliver your content to any screen."
            link="system/elements"
            icon="/docs/icons/icon-generic-link.svg"
            iconSize="large" />
    </div>
    <div class="py-1 sm:w-1/2 sm:py-0">
        <IconLink
            title="Configuration"
            subtitle="Customize Craft to your heart’s content."
            link="configure"
            icon="/docs/icons/icon-generic-link.svg"
            iconSize="large" />
    </div>
</div>

#### Resources

<div class="sm:flex sm:flex-wrap">
    <div class="py-1 sm:w-1/2 sm:py-0">
        <IconLink
            title="Reference"
            subtitle="Find exactly what you’re looking for."
            link="reference"
            icon="/docs/icons/icon-book.svg"
            iconSize="large" />
    </div>
    <div class="py-1 sm:w-1/2 sm:py-0">
        <IconLink
            title="Extending Craft"
            subtitle="Add radical new functionality to your site or app."
            link="extend"
            icon="/docs/icons/icon-flask.svg"
            iconSize="large" />
    </div>
</div>
</file>

<file path="requirements.md">
---
description: Craft requires PHP 8.2 and MySQL 8.0.17 or Postgres 13.
---

# Requirements

Craft is a PHP application that uses a relational database for content storage. It will run on most modern hosting environments, and can be configured to take advantage of all kinds of advanced infrastructure.

<!-- more -->

::: tip
You can use the official [server check](https://github.com/craftcms/server-check) script to quickly find out if your server meets Craft’s requirements.
:::

<columns>
<column>

## Minimum System Specs

- PHP 8.2+
- MySQL 8.0.17+ using InnoDB, MariaDB 10.4.6+, or PostgreSQL 13+
- 256MB+ memory allocated to PHP
- 200MB+ free disk space
- Composer 2.0+

</column>
<column>

## Recommended System Specs

- PHP 8.2+
- MySQL 8.0.36+ using InnoDB, or PostgreSQL 16+
- 512MB+ of memory allocated to PHP

</column>
</columns>

::: warning
Due to its diverging parity with MySQL, we no longer recommend MariaDB for sites with many users or a large volume of content.
:::

## Required PHP Extensions

- [BCMath](https://www.php.net/manual/en/book.bc.php)
- [ctype](https://secure.php.net/manual/en/book.ctype.php)
- [cURL](http://php.net/manual/en/book.curl.php)
- [GD](http://php.net/manual/en/book.image.php) or [ImageMagick](http://php.net/manual/en/book.imagick.php)
- [iconv](http://php.net/manual/en/book.iconv.php)
- [Intl](http://php.net/manual/en/book.intl.php)
- [JSON](http://php.net/manual/en/book.json.php)
- [Multibyte String](http://php.net/manual/en/book.mbstring.php)
- [OpenSSL](http://php.net/manual/en/book.openssl.php)
- [PCRE](http://php.net/manual/en/book.pcre.php)
- [PDO MySQL Driver](http://php.net/manual/en/ref.pdo-mysql.php) or [PDO PostgreSQL Driver](http://php.net/manual/en/ref.pdo-pgsql.php)
- [PDO](http://php.net/manual/en/book.pdo.php)
- [Reflection](http://php.net/manual/en/class.reflectionextension.php)
- [SPL](http://php.net/manual/en/book.spl.php)
- [Zip](http://php.net/manual/en/book.zip.php)
- [DOM](http://php.net/manual/en/book.dom.php)

::: tip
We recommend ImageMagick over GD for expanded [image handling options](development/image-transforms.md).
:::

## Optional PHP Methods and Configurations

Some shared hosting environments disable common PHP methods and configurations that affect Craft features.

- [allow_url_fopen](http://php.net/manual/en/filesystem.configuration.php#ini.allow-url-fopen) — This `ini` setting must be enabled to support updating and installing plugins from the Plugin Store.
- [proc_*](http://php.net/manual/en/ref.exec.php) — These methods are required in order to utilize the Plugin Store, install updates, and send emails.
- [ignore_user_abort](https://www.php.net/manual/en/function.ignore-user-abort.php) — Required when using the default [web-based queue runner](system/queue.md#http) to operate.
- [pcntl_*](https://www.php.net/manual/en/book.pcntl.php) — The _Process Control_ extension allows [daemonized queue runners](system/queue.md#daemon) to gracefully exit between jobs.

## File Permissions

For Craft to run properly, PHP needs to be able to write to the following files and folders at all times:

- `storage/*`
- `config/license.key`
- `web/cpresources/*`

Additionally, during [setup](kb:first-time-setup) or when [updating](update.md) or installing [plugins](system/plugins.md) via the [control panel](system/control-panel.md) or [CLI](system/cli.md), Craft may touch these files:

- `.env`
- `config/project/*`
- `composer.json` and `composer.lock`
- `vendor/*`

The exact permissions depend on the relationship between the system user that PHP runs as and the owner of the folders and files:

- If they’re the same user, use `744` (`rwxr--r--`).
- If they’re in the same group, use `774` (`rwxrwxr--`).
- If neither of the above options describe your setup, something may have been misconfigured. Reach out to your system administrator for support.

Specifics may vary from platform to platform or host to host! Consult your development or hosting environment’s documentation for more information.

::: danger
**Never** set permissions to `777` in a shared environment or on a live site, and **never** run your HTTP server (or PHP) as `root`.
:::

## Required Database User Privileges

The database user you tell Craft to connect with must have the following privileges:

<columns>
<column>

#### MySQL/MariaDB

- `SELECT`
- `INSERT`
- `DELETE`
- `UPDATE`
- `CREATE`
- `ALTER`
- `INDEX`
- `DROP`
- `REFERENCES`
- `LOCK TABLES`

</column>

<column>

#### PostgreSQL

- `SELECT`
- `INSERT`
- `UPDATE`
- `CREATE`
- `DELETE`
- `REFERENCES`
- `CONNECT`

</column>
</columns>

<See path="reference/config/db.md" />

## Control Panel Browser Requirements

Craft’s [control panel](system/control-panel.md) requires a browser that [supports JavaScript modules](https://caniuse.com/#feat=es6-module-dynamic-import).

#### Windows and macOS

- Firefox 67+
- Chrome 63+
- Safari 11.1+
- Edge 79+

#### Mobile

- iOS: Safari 11+
- Android: Chrome 81+ or Firefox 68+

::: tip
Craft’s _control panel_ browser requirements are independent from those of your site’s front-end. Ultimately, Craft is only concerned with delivering [hypermedia](https://en.wikipedia.org/wiki/Hypermedia)—how you choose to enhance that with JavaScript and CSS is entirely up to you!
:::
</file>

<file path="update.md">
# Running Updates

Craft has a smart system based on [Composer](https://getcomposer.org) that helps you keep your site and plugins up-to-date. This page covers routine _updates_ to dependencies, which we consider a distinct process from [major-version _upgrades_](#major-versions).

<!-- more -->

## Using the Control Panel

When an update is available, users with the permission to update Craft will see a badge in the [control panel](system/control-panel.md) next to <Journey path="Utilities" /> in the global navigation:

![Screenshot of control panel cropped to “Utilities” global navigation item, which contains a circular badge with the number “1” in it](./images/update-badge.png)

Click <Journey path="Utilities, Updates" />. You can also get to this view directly from the **Updates** widget that’s installed by default in the control panel [dashboard](system/control-panel.md#dashboard).

This section displays updates for Craft CMS and installed plugins, where each version has its own collapsible panel detailing relevant changes.

![Stylized screenshot of “Updates” page, which displays two plugins with newer versions with collapsible panes detailing their changes](./images/updates.png)

You can update one dependency at a time using its **Update** button, or update everything with the **Update All** at the top of the screen. If you don’t see these options, ensure the <config5:allowUpdates> and <config5:allowAdminChanges> settings are enabled in your current environment. We generally _do not_ recommend applying updates in a non-development environment—see our [workflow](deploy.md) page for details.

::: tip
Craft’s [changelog](repo:craftcms/cms/blob/5.x/CHANGELOG.md) will warn you of any critical changes at the top of the release notes. While there aren’t _usually_ any warnings, it’s always a good idea to check the changelog and [any upgrade guides](#upgrade-guides) before updating.

Urgent messages from changelogs (like security patches) are exposed as a banner in the control panel to all administrators.
:::

After Craft successfully installs the updates, it will run any new migrations.

## Updating from the Terminal

### Craft CLI

The [`update` console command](reference/cli.md#update) can be used to update Craft and plugins.

To see available updates, navigate to a Craft project directory in your terminal and run this command:

::: code
```bash DDEV
ddev craft update
```
```bash Generic
php craft update
```
:::

You should see output like this:

```
Fetching available updates ... done
You’ve got two available updates:

    - craft 5.4.8 => 5.4.9
    - commerce 5.2.1 => 5.2.2

Run craft update all or craft update <handle> to perform an update.
```

To update everything all at once, run this command:

::: code
```bash DDEV
ddev craft update all
```
```bash Generic
php craft update all
```
:::

To apply a specific update, replace `all` with `craft` (to update Craft itself) or a plugin’s handle:

::: code
```bash DDEV
ddev craft update commerce
```
```bash Generic
php craft update commerce
```
:::

```
Fetching available updates ... done
Performing one update:

    - commerce 5.2.1 => 5.2.2

Create database backup? (yes|no) [yes]:
Backing up the database ... done
Performing update with Composer ... done
Applying new migrations ... done
Update complete!
```

You can pass multiple handles in at once:

::: code
```bash DDEV
ddev craft update commerce element-api
```
```bash Generic
php craft update commerce element-api
```
:::

Craft will install the latest available version(s), unless you append `:<version>` to the handle:

::: code
```bash DDEV
ddev craft update element-api:4.1.0
```
```bash Generic
php craft update element-api:4.1.0
```
:::

After an update is performed from the CLI, Craft will apply any relevant migrations.

::: tip
Use the `--minor` or `--patch` flag when running `craft update` to update in finer increments. Pass `--except craft,plugin-name` to update all but the provided package(s).
:::

### Composer

`craft update` is mostly a wrapper around Composer—but you can use Composer directly for more control over the update process.

The main behavioral difference is that `craft update` will always set _specific_ Craft and plugin versions (like `5.4.1` or `1.2.3`), whereas Composer allows you to use [version _constraints_](https://getcomposer.org/doc/articles/versions.md)  (like `^5.3.0` or `^1.0.0`) to define dependencies.

When using version constraints, `composer.lock` will still make sure you get a stable set of packages from `composer install`. To update all your packages to the most recent versions allowed by their constraints, run `composer update`. Update a _single_ package by specifying it in the command: `composer update craftcms/cms`.

::: tip
If you have used the Craft CLI in the past, `composer update` may do nothing!

Open `composer.json`, and look at the packages under the `require` key—if you see exact version numbers, Composer will never update those packages.
:::

Keep in mind that manually altering constraints _can_ lead to an irreconcilable set of packages—Composer will let you know about this before updating the lockfile. Generally speaking, the “major-version” constraints set automatically when using `composer require` should continue to work, while protecting your project from breaking changes in dependencies.

## Workflow

Every time you [deploy](./deploy.md) your project, you should run `composer install` and `craft up` to bring that environment’s dependencies and database into agreement with your packages and their expected schema version.

The same applies when working with teammates! Any time you pull new code into a project, running `composer install` will guarantee you are working with the same set of packages as your collaborators. If you’re one for automation, you can even have Craft apply migrations and [project config](system/project-config.md) at the same time by adding a special hook to the `scripts` key in `composer.json`:

```json{9}
{
    "require": {
        "craftcms/cms": "^5.0.0",
        "vlucas/phpdotenv": "^5.4.0"
        // ...
    },
    // ...
    "scripts": {
        "post-install-cmd": "@php craft install/check && php craft up --interactive=0 || exit 0"
    }
}
```

This tells Composer that _after_ it has successfully installed packages from a lockfile (typically the result of running `composer install`), it should check if Craft is installed (`@php craft install/check`) and if so, run `craft up` non-interactively to apply migrations and project config. `|| exit 0` ensures that the command exits nominally, so as not to disrupt other processes that expect `composer install` to succeed.

## Licensing

When you buy a Craft Pro or plugin license, you are entitled to use that version in perpetuity—or any version that you update to, during the year of included updates. To get the most out of your Craft licenses, run updates frequently!

## Upgrade Guides

Each version of the Craft documentation contains an equivalent of the [Upgrading from Craft 4](upgrade.md) page, which covers the process of upgrading from one [major version](#major-versions) to the next.

Sometimes, there are significant changes to be aware of—even in minor or “point” releases. The most common changes that fit this criteria are deprecations. Deprecation notices will be accompanied by instructions for updating your code to work with the new APIs. Any features that are subsequently removed in a major release will also be noted in the new version’s upgrade guide.

Deprecation warnings will affect plugin developers more frequently than regular users—but it’s still a good idea to keep your eye on the **Deprecation Warnings** utility.

### Major Versions

For the smoothest upgrade experience, projects must be updated to the latest available _minor_ version preceding a _major_ version upgrade. We do not support “skipping” versions, so if your site is running Craft 3, you must first update to the latest 3.x version, then perform the 3.x &rarr; 4.x upgrade, then perform the 4.x &rarr; 5.x upgrade.

You should always upgrade to the latest release in a given major Craft version—for example, you can upgrade directly from 4.12.8 (or whatever the latest 4.x release is) to 5.4.9 (or whatever the latest 5.x release is).
</file>

<file path="upgrade.md">
---
sidebarDepth: 2
description: Take a peek at what’s new in Craft 5.
---

# Upgrading from Craft 4

The smoothest way to upgrade to Craft 5 is to make sure your live site is already running the [latest version of Craft 4](/4.x/updating.md). We recommend approaching the upgrade in three phases: [preparation](#preparing-for-the-upgrade), a [local upgrade](#performing-the-upgrade), and [rollout](#going-live) to live environments.

<!-- more -->

## Preparing for the Upgrade

Let’s take a moment to audit and prepare your project.

- Your **live site** must be running the [latest version](repo:craftcms/cms/releases) of Craft 4 (you cannot upgrade directly from Craft 3 to Craft 5);
- The most recent Craft 4-compatible versions of all plugins are installed, and Craft 5-compatible versions are available;
- Your project is free of deprecation warnings after thorough testing on the latest version of Craft 4;
- All your environments meet Craft 5’s [minimum requirements](requirements.md) (the latest version of Craft 4 will run in any environment that meets Craft 5’s requirements, so it’s safe to update PHP and your database ahead of the 5.x upgrade):
    - PHP 8.2
    - MySQL 8.0.17+ using InnoDB, MariaDB 10.4.6+, or PostgreSQL 13+
- You’ve reviewed the breaking changes in Craft 5 further down this page and understand that additional work and testing may lie ahead, post-upgrade;

Once you’ve completed everything above, you’re ready to start the upgrade process!

::: tip
If your project uses custom plugins or modules, we have an additional [extension upgrade guide](extend/updating-plugins.md).
:::

## Performing the Upgrade

Like [any other update](update.md), it’s essential that you have a safe place to test the upgrade prior to rolling it out to a live website.

These steps assume you have a local development environment that meets Craft 5’s [requirements](requirements.md), and that any changes made [in preparation for the upgrade](#preparing-for-the-upgrade) have been deployed to your live site.

<Block label="Upgrading with DDEV">

[DDEV](https://ddev.com/) users should take this opportunity to [update](https://ddev.readthedocs.io/en/stable/users/install/ddev-upgrade/) so that the `craftcms` project type reflects our latest recommendations.

In an existing DDEV project, you can change the PHP or database version with the `config` command…

```bash
ddev config --php-version=8.2
ddev config --database=mysql:8.0
ddev start
```

…or use `ddev config --update` to reapply project type defaults.

</Block>

1. Capture a fresh database backup from your live environment and import it.
1. Make sure you don’t have any pending or active jobs in your queue.
1. Run `php craft project-config/rebuild` and allow any new background tasks to complete.
1. Run `php craft utils/fix-field-layout-uids`.
1. Deploy any project config changes to your live environment. (Be sure to run `php craft up` or `php craft pc/apply`.)
1. Note your current **Temp Uploads Location** setting in **Settings** &rarr; **Assets** &rarr; **Settings**.
1. MySQL users: Add your database’s _current_ character set and collation to `.env`. If you have always used Craft’s defaults, this will be:

    ```bash
    CRAFT_DB_CHARSET="utf8mb3"
    CRAFT_DB_COLLATION="utf8mb3_general_ci"
    ```

    Read more about this process in the [Database Character Set and Collation](#database-character-set-and-collation) section, below.

1. Edit your project’s `composer.json` to require `"craftcms/cms": "^5.0.0"` and Craft-5-compatible plugins, all at once.

    ::: tip
    You’ll need to manually edit each plugin version in `composer.json`. If any plugins are still in beta, you may need to change your [`minimum-stability`](https://getcomposer.org/doc/04-schema.md#minimum-stability) and [`prefer-stable`](https://getcomposer.org/doc/04-schema.md#prefer-stable) settings.
    :::

    While you’re at it, review your project’s [other dependencies](#entry-scripts)! You may also need to add `"php": "8.2"` to your [platform](https://getcomposer.org/doc/06-config.md#platform) requirements, or remove it altogether.

1. Run `composer update`.
1. Make any required changes to your [configuration](#configuration).
1. Run `php craft up`.
1. MySQL users: Remove your database character set and collation settings from `.env` (and `db.php`—even if you didn’t modify it during the upgrade), then run `php craft db/convert-charset`.

Your site is now running Craft 5! If you began this process with no deprecation warnings, you’re nearly done.

::: warning
Thoroughly review the list of changes on this page, making note of any features you use in templates or modules. Only a fraction of your site’s code is actually evaluated during an upgrade, so it’s your responsibility to check templates and modules for consistency. You may also need to follow any plugin-specific upgrade guides.
:::

## Going Live

The Craft 5 upgrade can be run largely unattended during a routine deployment. Once you’ve performed the upgrade in your local environment and everything is working as expected, commit your updated `composer.json`, `composer.lock`, and `config/project/` directory, as well as any template, configuration, or module files that required updates.

::: warning
MySQL users must add the correct [character set and collation settings](#database-character-set-and-collation) to each remote environment for the duration of the upgrade.
:::

Deploy your changes to each environment, then run `php craft up`.

If you added temporary character set or collation settings for the upgrade, remove them now, then run `php craft db/convert-charset` to apply Craft 5’s new defaults to all tables.

Read more about this part of the upgrade in the [Database Character Set and Collation](#database-character-set-and-collation) section, below.

## Cleanup + Optional Steps

### Field and Entry Type Consolidation <Since ver="5.3.0" feature="Field type and entry type consolidation commands" />

Craft 5.3 introduced three new commands for consolidating fields and entry types, post-upgrade:

- `fields/auto-merge` — Automatically discovers functionally identical fields and merges their uses together.
- `fields/merge` — Manually merge one field into another of the same type and update uses of the merged field.
- `entry-types/merge` — Merge one entry type into another and update uses of the merged entry type.

These tools are particularly useful on projects with many Matrix fields containing similar block types, or multiple sections with similar entry types. While the upgrade doesn’t result in _more_ fields or entry types and block types than existed previously, it can result in some ergonomic problems with the new content architecture!

We recommend you approach consolidation in the following order, _after_ getting your project fully upgraded and deployed.

::: warning
In addition to updating project config, this process generates content migrations. You must commit these files to version control and run `craft up` in all other environments to apply the changes!
:::

#### Auto-merging Fields

Your first step should be to try auto-merging field definitions:

```bash
ddev craft fields/auto-merge
```

Craft will audit your fields, and propose batches of merge candidates. To accept a merge, type `y` and press <kbd>Enter</kbd>, then choose the field you want to merge the duplicates into.

The usage of any merged fields in field layouts and templates will remain the same after merging global field definitions. Any overridden names, handles, instructions, and so on will remain. One exception here is if a name or handle override is present but the same as the merged global field’s name: Craft clears the override so that it can be better kept in sync, moving forward.

::: tip
Don’t like how Craft grouped some of the fields? You can skip any proposed merge and come back to the command later—say, after [manually merging](#manually-merging-fields) a few of the fields.
:::

Merged fields’ search keywords are also combined, which may affect the quality of results when [searching by field handles](system/searching.md#multi-instance-fields).

#### Manually Merging Fields

For any additional fields you wish to merge (or merge candidates you skipped in the previous step), run the `fields/merge` command as many times as necessary to consolidate them:

```bash
ddev craft fields/merge myFirstDropdownField mySecondDropdownField
```

To merge multiple fields together, choose the field you want to persist, and run the command multiple times, passing each redundant field as the first argument, and the target field as the second, i.e:

```bash
ddev craft fields/merge ctaDonate ctaAbout
ddev craft fields/merge ctaStaff ctaAbout
ddev craft fields/merge ctaFoundation ctaAbout
```

#### Merging Entry Types

Once your field definitions have been consolidated, merging entry types is greatly simplified. Here’s how Craft handles fields during a merge:

- Any field instances that map to the same custom field (and have the same handle) will be left alone in the persistent entry type.
- Any single-instance fields that exist in both entry types (but with _different_ handles) will be left alone in the persistent entry type, and the command will note the handle change for fields of the outgoing entry type.
- Any other fields in the outgoing entry type will be added to the persistent entry type under a “Merged Fields” tab. Any handle conflicts will be resolved by incrementing the handle of the merged field, and the handle change will be noted in the command’s output.

There is no “automatic” equivalent for merging entry types—each merge must be run manually:

```bash
ddev craft entry-types/merge quote pullQuote
```

To merge entry types, Craft takes the following actions:

1. The persistent entry type’s field layout is updated with any new fields from the outgoing entry type.
1. Sections and fields that use the outgoing entry type are updated to use the persistent entry type, instead (if it wasn’t already available in that context).
1. The outgoing entry type is removed.
1. A content migration is generated an run, remapping entries of the outgoing entry type to the persistent one, and entries’ JSON content is updated with the correct layout element UUIDs.

::: warning
Merging is concerned only with custom fields. Other field layout elements (like tips, rules, breaks, or templates) are _not_ merged into the persisted entry type.
:::

### Entry Scripts

Older projects may use versions of [`vlucas/phpdotenv`](repo:vlucas/phpdotenv) (the library that loads variables from your `.env` file) that depend on features deprecated in PHP 8.1. If you encounter errors during (or after) installation, change your `vlucas/phpdotenv` dependency in `composer.json` to `^5.6.0`, then run `composer update`.

Along with this update, you’ll need to integrate changes from our [starter project](repo:craftcms/craft)’s `web/index.php` script and `craft` executable. If you have done any low-level customization of Craft via [bootstrap constants](configure.md#bootstrap-config), make sure those values are preserved in the appropriate file(s)—constants shared between the two files can be moved to a common [`bootstrap.php` file](repo:craftcms/craft/blob/5.x/bootstrap.php).

## Breaking Changes and Deprecations

Features deprecated in Craft 4 may have been fully removed or replaced in Craft 5, and new deprecations have been flagged in Craft 5.

::: warning
This list focuses on high-traffic, user-facing features. Review the [complete changelog](repo:craftcms/cms/blob/5.x/CHANGELOG.md) for information about changes to specific APIs, including class deprecations, method signatures, and so on.
:::

### Configuration

The following settings have been changed.

#### Database Character Set and Collation

MySQL 8.0 [deprecated the `utf8mb3` character set](https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-utf8mb3.html), as well as [the use of `utf8` as an alias for `utf8mb3`](https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-utf8.html). MySQL [recommends `utf8mb4`](https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-utf8mb4.html) instead, and it’s expected that `utf8` will become an alias for `utf8mb4` in MySQL 8.1.

To ease that transition, Craft 5 is proactively treating `utf8` as `utf8mb4` for MySQL and MariaDB installs.

<Block label="During the Upgrade">

Explicitly setting the character set and collation ensures compatibility of new tables _during_ the upgrade—afterwards, those settings can be scrubbed and the tables can be converted via Craft’s CLI. Here’s how this will look, in practice.

If you have never customized character set or collation settings for your database connection, set these variables in your `.env` file during the upgrade:

```bash
CRAFT_DB_CHARSET="utf8mb3"
CRAFT_DB_COLLATION="utf8mb3_general_ci"
```

If you _are_ using these settings (either from `.env` or `db.php`), they can be left as-is, for now.

Once the upgrade is complete in an environment, convert your tables to `utf8mb4` by _removing_ the `CRAFT_DB_CHARSET` and `CRAFT_DB_COLLATION` environment variables (and clearing any `charset` and `collation` settings from `db.php`)…

```bash
# …or set them to Craft’s defaults…
CRAFT_DB_CHARSET="utf8mb4"
CRAFT_DB_COLLATION="utf8mb4_0900_ai_ci" # MySQL
CRAFT_DB_COLLATION="utf8mb4_unicode_ci" # MariaDB
```

…then running `php craft db/convert-charset`.

</Block>

#### Template Priority

The <config5:defaultTemplateExtensions> config setting now lists `twig` before `html`, by default. This means that projects with templates that share a name (i.e. `widget.twig` and `widget.html`, _in the same directory_) may behave differently in Craft 5. Audit your `templates/` directory for any overlap to ensure consistent rendering. If all your templates use one extension or another, no action is required!

This setting only affects rendering of templates in the front-end; the control panel will _always_ use `.twig` files before `.html`.

#### Volumes & Filesystems

Multiple [asset volumes](reference/element-types/assets.md) can now share a filesystem! However, they must be carefully arranged such that each volume has a unique and non-overlapping base path.

::: warning
When selecting a filesystem, options that would result in a collision between two volumes are not shown. This means that you may need to adjust multiple volumes’ configuration in order to consolidate them into a single filesystem.
:::

### Templates

#### Variables

With the elimination of Matrix blocks as a discrete element type, we have removed the associated element query factory function from <craft5:craft\web\twig\variables\CraftVariable>.

| Old | New |
| --- | --- |
| `craft.matrixBlocks()` | `craft.entries()` |

::: tip
See the section on [Matrix fields](#matrix-fields) for more information about these changes.
:::

### GraphQL

The reusability of entry types means that some GraphQL queries have changed.

- GraphQL types corresponding to entry types no longer include their section names. In Craft 4, entries a section named “Ingredients” with the entry type “Ingredient” might have been represented in GraphQL as a type named `ingredients_ingredient_Entry`. That type would now be named `ingredient_Entry`.

    Entries can still be queried by section using the corresponding query type (i.e. `ingredientsEntries`) or the `section` argument for the generic `entries` query:

    ::: code
    ```graphql{2} Section Query
    query MyIngredients {
      ingredientsEntries {
        ... on ingredient_Entry {
          title
        }
      }
    }
    ```
    ```graphql{2} Generic Query
    query MyIngredients {
      entries(section: "ingredients") {
        ... on ingredient_Entry {
          title
        }
      }
    }
    ```
    :::

    The corresponding queries for entries nested within a Matrix field would look like this:

    ::: code
    ```graphql{2} Field Query
    query DifficultSteps {
      stepsFieldEntries(difficulty: "hard") {
        ... on step_Entry {
          title
          estimatedTime
        }
      }
    }
    ```
    ```graphql{2} Generic Query
    query DifficultSteps {
      entries(field: "steps", difficulty: "hard") {
        ... on step_Entry {
          title
          estimatedTime
        }
      }
    }
    ```

- The names of mutations targeting entries in a particular section remain unchanged, and still include the section and entry type handles, i.e: `save_ingredients_ingredient_Entry` and `save_ingredients_ingredient_Draft`.
- Mutations directly targeting nested entries in Matrix fields will use a similar structure, but combining the field handle and entry type handle: `save_stepsField_step_Entry`.
- When mutating a Matrix field value via GraphQL, the nested entries must be passed under an `entries` key instead of a `blocks` key:

    ```graphql{2,5}
    mutation AddStep {
      save_recipes_recipe_Entry(
        title: "Yummy Bits and Bytes"
        summary: "Chocolate chip cookies that are out of this world!"
        steps: {
          entries: [
            {
              step: {
                difficulty: "hard",
                instructions: "Preheat oven to 20,000,000°F",
                estimatedTime: 120,
                id: "new:1"
              }
            }
            # ...
          ],
          sortOrder: [
            "new-first"
          ]
        }
      ) {
        title
        id
      }
    }
    ```

### Field Types

#### URL &rarr; Link <Since ver="5.3.0" feature="Link fields" />

URL fields will be converted to [Link](reference/field-types/link.md) fields during the upgrade. Your templates _do not_ require any updates, but projects that use custom field values in PHP may need to update type hints or use a specific member of the new <craft5:craft\fields\data\LinkData> object:

::: code
```php Old
use craft\base\Element;

class MyHelper
{
    public static function getUrl(Element $element, string $fieldHandle): string
    {
        return $element->$fieldHandle;
    }
}
```
```php{6} New (Types)
use craft\base\Element;
use craft\fields\data\LinkData;

class MyHelper
{
    public static function getUrl(Element $element, string $fieldHandle): LinkData
    {
        // The return type is now an object instead of a string!
        return $element->$fieldHandle;
    }
}
```
```php{9} New (Member)
use craft\base\Element;
use craft\fields\data\LinkData;

class MyHelper
{
    public static function getUrl(Element $element, string $fieldHandle): string
    {
        // The signature can stay the same if you return a specific property:
        return $element->$fieldHandle->url;
    }
}
```
:::

The new field type supports linking to elements, in addition to text-based URLs—[check out its options](reference/field-types/link.md#settings) to see if it can help simplify some of your authoring interfaces!

## Elements & Content

Craft 5 has an entirely new content storage architecture that underpins many other features.

### Content Table

The content table has been eliminated! Elements now store their content in the `elements_sites` table, alongside other localized properties.

Content is stored as a JSON blob, and is dynamically indexed by the database in such a way that all your existing element queries will work without modification.

#### Advanced Queries

When using custom fields in [advanced `where()` conditions](development/element-queries.md#advanced-element-queries), you no longer need to manually assemble a database column prefix/suffix. Instead, Craft can generate the appropriate expression to locate values in the JSON content column:

::: code
```twig{12} Twig
{% set entriesFromPhysicalMedia = craft.entries()
  .section('news')
  .andWhere([
    'or like',
    fieldValueSql(entryType('post'), 'sourceMedia'),
    ['print', 'paper', 'press']
  ])
  .all() %}
```
```php{12} PHP
use Craft;
use craft\elements\Entry;

$entryType = Craft::$app->getEntries()->getEntryTypeByHandle('post');
$fieldLayout = $entryType->getFieldLayout();
$sourceField = $fieldLayout->getFieldByHandle('sourceMedia');

$entriesFromPhysicalMedia = Entry::find()
  ->section('news')
  ->andWhere([
    'or like',
    $sourceField->getValueSql(),
    ['print', 'paper', 'press'],
  ])
  ->all();
```
:::

This ensures that you are querying for the correct instance of a [multi-instance field](system/fields.md#multi-instance-fields), each of which will store their content under a different UUID in their respective field layouts.

Craft already knows how to query against the appropriate instance of a field when using its handle as a query method, so this is only necessary for complex or compound conditions that make use of low-level query builder features.

#### Case-Sensitivity

MySQL users should review queries against [textual custom field values](development/element-queries.md#case-sensitivity) for consistency. The following query using a lower-case name will no longer match a capitalized value:

```twig
{% set entries = craft.entries()
  .section('departments')
  .deptHeadNameFirst('oli')
  .all() %}
```

If you don’t have control over the query _value_ (say, it comes from a third-party feed), consider updating the query to use the new `caseInsensitive` option:

```twig
{% set entries = craft.entries()
  .section('departments')
  .deptHeadNameFirst({
    value: 'oli',
    caseInsensitive: true,
  })
  .all() %}
```

You may also want to review any [custom sources](system/elements.md#sources) that use condition rules targeting the [affected field types](development/element-queries.md#case-sensitivity).

### Matrix Fields

During the upgrade, Craft will automatically migrate all your Matrix field content to entries. In doing so, new globally-accessible fields will be created with a unique name:

```
{Matrix Field Name} - {Block Type Name} - {Field Name}
```

These fields are then assigned to new [entry types](./reference/element-types/entries.md#entry-types) that replace your existing Matrix block types.

::: tip
Field labels and handles are retained, within their field layouts—even if they collide with other fields in the [global space](./system/fields.md#multi-instance-fields)!
:::

Queries for nested entries will be largely the same—equivalent methods have been added to <craft5:craft\elements\db\EntryQuery> to enable familiar usage. The `.owner()` method still accepts a list of elements that the results must be owned by, and the `field()` and `fieldId()` methods narrow the results by those belonging to specific fields.

::: warning
Values passed to the `type()` method of [entry queries](./reference/element-types/entries.md#querying-entries) may require updates, as migrated entry types _can_ receive new handles. For example, a Matrix field that contained a block type with the handle `gallery` might conflict with a preexisting entry type belonging to a section; in that event, the new entry type for that block would get the handle `gallery1` (or potentially `gallery2`, `gallery3`, and so on, if multiple similar Matrix fields are being migrated).

Craft will set [local overrides for entry type names and handles](reference/element-types/entries.md#aliases) so that the control panel experience is as consistent as possible, post-upgrade—but this does _not_ change the query behavior. It _does_, however, make most templates that tested Matrix block type handles (i.e. `myBlock.type.handle == 'carousel'`, or within a [`switch` tag](reference/twig/tags.md#switch)) compatible. <Since ver="5.6.0" feature="Local overrides for entry type names and handles" />

Visit <Journey path="Settings, Entry Types" /> to check if any handles appear to have collided in this way, then review and update templates as necessary.

_Matrix block type IDs were not stable in Craft 4, and will change as they are converted to entry types. If you maintain code that loaded Matrix block definitions by hard-coded IDs, it will no longer work in Craft 5._
:::

### Eager-Loading

[Eager-loading](development/eager-loading.md) has been dramatically simplified for most sites. You no longer need to tell Craft which relational fields to load via the `.with()` query method—instead, call `.eagerly()` on any query that _may_ result in an N+1 problem to automatically trigger eager-loading:

::: code
```twig Before
{% set articles = craft
    .entries()
    .section('blog')
    .with([
        ['featureImage'],
    ])
    .all() %}

{% for article in articles %}
  {% set image = article.featureImage|first %}
  {% if image %}
    {{ image.getImg() }}
  {% endif %}
{% endfor %}
```
```twig After
{% set articles = craft
    .entries()
    .section('blog')
    .all() %}

{% for article in articles %}
  {% set image = article.featureImage.eagerly().one() %}

  {# Testing whether there was a result is still a good idea: #}
  {% if image %}
    {{ image.getImg() }}
  {% endif %}
{% endfor %}
```
:::

This feature does have _some_ limitations, though. While it will work for all elements connected via a [relational](system/relations.md) or Matrix field, you will still need to explicitly eager-load native attributes like entries’ `author` (and now `authors`, _plural_) or assets’ `uploader`. Craft can only detect eager-loading opportunities when the original attribute or value is an element query. The two strategies can be safely combined, though:

```twig
{% set articles = craft
    .entries()
    .section('blog')
    .with([
      ['author'],
    ])
    .all() %}

{% for article in articles %}
  {# Lazily-eager-loaded relation: #}
  {% set image = article.featureImage.eagerly().one() %}

  {% if image %}
    {{ image.getImg() }}
  {% endif %}

  {# Explicitly eager-loaded element: #}
  <span>{{ article.author.fullName }}</span>
{% endfor %}
```

<See path="development/eager-loading.md" description="Read more about opportunities to optimize your templates with automatic and manual eager-loading." />

## Assets

### Reusable Filesystems

Filesystems can now be shared by multiple asset volumes, so long as each volume has a unique and non-overlapping base path. The [assets](./reference/element-types/assets.md) page has more information on this new behavior.

### Temporary Filesystem

The new <config5:tempAssetUploadFs> general config setting has replaced the **Temp Uploads Location** setting in the **Settings** &rarr; **Assets** &rarr; **Settings** screen. If you noted a custom asset volume in the upgrade process, you will need to follow these steps to set up a distinct filesystem for temporary uploads. Otherwise, Craft will use the legacy behavior and fall back on an instance of <craft5:craft\fs\Temp>, which puts temporary uploads in a folder in your local [`storage/` directory](system/directory-structure.md).

::: tip
Load-balanced or ephemeral environments that rely on a centralized storage solution should define a temporary upload filesystem using the steps below.
:::

The location of temporary uploads is now defined by way of a _filesystem_ instead of a _volume_:

1. Create a new filesystem by visiting **Settings** &rarr; **Filesystems**, giving it an appropriate **Name** and **Handle** (users will not see this, so something like “Temporary” or “Scratch” is fine).
1. Set the **Base Path** to agree with the old volume, keeping in mind that previously, its subpath and its filesystem’s base path were combined.
1. Add the handle you chose to your [general config](reference/config/general.md#tempassetuploadfs) file or define a `CRAFT_TEMP_ASSET_UPLOAD_FS` [environment override](configure.md#environment-overrides).

A filesystem designated by your `tempAssetUploadFs` setting cannot be reused for volumes or image transforms, so it will not appear in filesystem selection menus. If you elect to define the temporary uploads filesystem handle via an _environment variable_, be sure and add it to your other environments as well!

## Plugins and Modules

Plugin authors (and module maintainers) should refer to our guide on [updating Plugins for Craft 5](extend/updating-plugins.md).
</file>

</files>
